//  ========================================================================
/**
 * @copyright Copyright (C) 1999 Technical Pursuit Inc. (TPI) All Rights
 *     Reserved. Patents Pending, Technical Pursuit Inc. Licensed under the
 *     OSI-approved Reciprocal Public License (RPL) Version 1.5. See the RPL
 *     for your rights and responsibilities. Contact TPI to purchase optional
 *     privacy waivers if you must keep your TIBET-based source code private.
 */

self.addEventListener("install",function(a){a.waitUntil(self.skipWaiting())});self.addEventListener("activate",function(a){a.waitUntil(self.clients.claim())});self.addEventListener("message",function(a){self.receiveMessageFromPage(a.data);a.ports[0].postMessage({error:null,msg:"ok"})});self.addEventListener("fetch",function(a){var b,c,d,e,f;b=a.request.url;c=b.slice(b.lastIndexOf("/")+1);if(/\.\w+$/.test(c)===false||/\?.+=.+/.test(c)===true){return}if(c.startsWith("TP_")){d=caches.open("TIBET_PSEUDO_MODULE_CACHE").then(function(a){return a.match(c)}).then(function(a){if(a){return a.text()}return self.clients.matchAll().then(function(a){return self.sendMessageToPage(a[0],{command:"createModule",payload:c})}).then(function(a){return a.payload})}).then(function(a){var b;b=new Response(a,{headers:new Headers({"Content-Type":"text/javascript"})});return b});a.respondWith(d)}else{if(self.cfg&&self.cfg["boot.use_sw_cache"]===false){return}if(self.cfg&&self.cfg["debug.cache"]===true){f=true}if(!self.libResourcePath){self.libResourcePath=self.location.origin+"/TIBET-INF/tibet/";self.appResourcePath=self.location.origin+"/"}e=/tibet.*\.min.js$/.test(b);if(b.startsWith(self.libResourcePath)||e){d=caches.open("TIBET_LIB_CACHE").then(function(b){return b.match(a.request)}).then(function(c){if(!c){if(f){console.warn("CACHE MISS ON LIB RESOURCE: "+b)}return fetch(a.request).then(function(a){return a})}else{return c}});a.respondWith(d)}else if(b.startsWith(self.appResourcePath)){d=caches.open("TIBET_APP_CACHE").then(function(b){return b.match(a.request)}).then(function(c){if(!c){if(f){console.warn("CACHE MISS ON APP RESOURCE: "+b)}return fetch(a.request).then(function(a){return a})}else{return c}});a.respondWith(d)}else{console.log("LOADING RESOURCE FROM SERVER: "+b)}}});self.receiveMessageFromPage=function(a){var b,c;switch(a.command){case"setcfg":self.cfg=JSON.parse(a.payload);self.libResourcePath=self.cfg["boot.lib_resource_path"];self.appResourcePath=self.cfg["boot.app_resource_path"];break;case"setcfgprop":b=JSON.parse(a.payload);c=Object.keys(b)[0];self.cfg[c]=b[c];break;default:break;}};self.sendMessageToPage=function(a,b){var c;c=new Promise(function(c,d){var e;e=new MessageChannel;e.port1.onmessage=function(a){if(a.data.error){d(a.data.error)}else{c(a.data)}};a.postMessage(b,[e.port2])});return c};
