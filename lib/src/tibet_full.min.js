TP.boot.$srcPath = '~lib_src/tibet/kernel/copyright.js';
//  ========================================================================
/**
 * @copyright Copyright (C) 1999 Technical Pursuit Inc. (TPI) All Rights
 *     Reserved. Patents Pending, Technical Pursuit Inc. Licensed under the
 *     OSI-approved Reciprocal Public License (RPL) Version 1.5. See the RPL
 *     for your rights and responsibilities. Contact TPI to purchase optional
 *     privacy waivers if you must keep your TIBET-based source code private.
 */

TP.boot.$srcPath = '~lib_src/tibet/kernel/tibet_pack.js';
TP.boot.$keywords=['break','case','catch','continue','default','delete','do','else','false','finally','for','function','if','in','instanceof','new','null','return','switch','this','throw','true','try','typeof','var','void','while','with'];TP.boot.$keywordString='__'+TP.boot.$keywords.join('__')+'__';TP.boot.$reservedwords=['abstract','boolean','byte','char','class','const','debugger','double','enum','export','extends','final','float','goto','implements','import','int','interface','long','native','package','private','protected','public','short','static','super','synchronized','throws','transient','volatile'];TP.boot.$reservedString='__'+TP.boot.$reservedwords.join('__')+'__';TP.boot.$operators=[';',',','=','?',':','||','&&','|','^','&','==','!=','===','!==','<','<=','>=','>','<<','>>','>>>','+','-','*','/','%','+=','-=','*=','/=','%=','<<=','>>=','>>>=','&=','|=','^=','!','~','++','--','.','[',']','{','}','(',')'];TP.boot.$operatorString='__'+TP.boot.$operators.join('__')+'__';TP.boot.$tshOpRegex=/^\.[|&<>\(\{\[;][|&<>!\*\?\(\{\[]*/;TP.boot.$uriSchemes={'tibet':'tibet','urn':'urn','http':'http','https':'https','file':'file','xmpp':'xmpp','about':'about','mailto':'mailto','tel':'tel','news':'news','nntp':'nntp','ftp':'ftp','ws':'ws','wss':'wss','aaa':'aaa','aaas':'aaas','acap':'acap','cap':'cap','cid':'cid','crid':'crid','data':'data','dav':'dav','dict':'dict','dns':'dns','fax':'fax','go':'go','gopher':'gopher','h323':'h323','icap':'icap','im':'im','imap':'imap','info':'info','ipp':'ipp','iris':'iris','iris.beep':'iris.beep','iris.xpc':'iris.xpc','iris.xpcs':'iris.xpcs','iris.lws':'iris.lws','ldap':'ldap','lsid':'lsid','mid':'mid','modem':'modem','msrp':'msrp','msrps':'msrps','mtqp':'mtqp','mupdate':'mupdate','nfs':'nfs','opaquelocktoken':'opaquelocktoken','pop':'pop','pres':'pres','prospero':'prospero','rtsp':'rtsp','service':'service','shttp':'shttp','sip':'sip','sips':'sips','snmp':'snmp','soap.beep':'soap.beep','soap.beeps':'soap.beeps','tag':'tag','telnet':'telnet','tftp':'tftp','thismessage':'thismessage','tip':'tip','tv':'tv','vemmi':'vemmi','wais':'wais','xmlrpc.beep':'xmlrpc.beep','z39.50r':'z39.50r','z39.50s':'z39.50s'};TP.$is_identifier=function(a){return a==='identifier'||a==='keyword'||a==='reserved';};TP.$is_ioend=function(a){return a==='.;'||a==='.||'||a==='.&&';};TP.$is_scheme=function(b){var a;if(!b){return false;}a=b;return TP.boot.$uriSchemes[a]===a;};TP.$is_terminator=function(a){return a===';'||TP.boot.$tshOpRegex.test(a);};TP.$is_whitespace=function(a){return a==='space'||a==='tab'||a==='newline';};TP.$tokenize=function(d,H,j,L,F,D){var l,C,K,s,z,E,x,A,e,B,f,J,b,a,m,t,G,c,v,n,y,g,k,h,o,u,r,i,w,q,I,p;l=/[0-9]/;C=/[0-9a-fA-F]/;K=/[0-7]/;s=D===true?/[@$_a-zA-Z{]/:/[@$_a-zA-Z]/;z=D===true?/[{$_a-zA-Z0-9}]/:/[$_a-zA-Z0-9]/;E=TP.boot.$keywordString;B=TP.boot.$reservedString;x=TP.boot.$operatorString;if(H){x+=H.join('__')+'__';}A=function(a){if(E.indexOf('__'+a+'__')>0){return'keyword';}else if(B.indexOf('__'+a+'__')>0){return'reserved';}return'identifier';};e=function(a,c){o={'name':a,'value':c,'line':t,'from':G,'to':b};return o;};f=[];if(!d){return f;}J=d.length;b=0;t=1;q=0;p=0;a=d.charAt(b);while(a){G=b;if(a<=' '||a.charCodeAt(0)===160){if(a===' '||a.charCodeAt(0)===160){f.push(e('space',a));}else if(a==='\t'){f.push(e('tab',a));}else if(a==='\n'){u=e('newline','\n');f.push(u);t++;}else if(a==='\r'){if(d.charAt(b+1)!=='\n'){u=e('newline','\n');f.push(u);t++;}}b+=1;a=d.charAt(b);}else if(s.test(a)||j&&(a==='~'||a==='#'||a==='.'&&d.charAt(b+1)==='/'||a==='.'&&d.charAt(b+1)==='.'&&d.charAt(b+2)==='/')){c=a;b+=1;I=c==='{'&&d.charAt(b)==='{';if(j&&I){i=false;c+=a;b+=1;p=2;for(;;){a=d.charAt(b);if(a==='{'&&d.charAt(b-1)!=='\\'){p++;}if(a==='}'&&d.charAt(b-1)!=='\\'){p--;}c+=a;b+=1;if(a===''&&p!==0){i=true;TP.boot.$stderr('Unbalanced parens in template: '+TP.boot.$dump(e('substitution',c),', '));break;}if(p===0){if(!i){f.push(e('substitution',c));}break;}}}else{i=false;a=d.charAt(b);w=c==='#'&&!l.test(a)||c==='~'||c==='.'&&a==='/'||c==='.'&&a==='.'&&d.charAt(b+1)==='/';if(z.test(a)===true||j&&w){c+=a;b+=1;for(;;){a=d.charAt(b);if(z.test(a)!==true){break;}c+=a;b+=1;}if(j&&(a===':'&&TP.$is_scheme(c)||w)){if(a==='('){q++;}c+=a;b+=1;for(;;){a=d.charAt(b);if(a==='('){q++;}if(!F&&(a==='"'||a==='\'')&&d.charAt(b-1)==='='){y='';b+=1;n=a;for(;;){a=d.charAt(b);if(a===n&&d.charAt(b-1)!=='\\'){c+=encodeURIComponent(y);b+=1;a=d.charAt(b);break;}if(a==='\\'&&d.charAt(b+1)===n){}else{y+=a;}b+=1;}}if(a===')'){q--;}if(q===0){if(a==='\n'||a==='\r'||a===''||a<=' '||a.charCodeAt(0)===160){break;}if(a==='.'&&'|&<>({['.indexOf(d.charAt(b+1))>=0){break;}if(F&&a==='$'&&'{'.indexOf(d.charAt(b+1))>=0){break;}}if(a===''&&q!==0){i=true;TP.boot.$stderr('Unbalanced parens in URI: '+TP.boot.$dump(e('uri',c),', '));break;}c+=a;b+=1;}if(!i){f.push(e('uri',c));}}else{f.push(e(A(c),c));}}else{if(s.test(c)){f.push(e(A(c),c));}else{f.push(e('operator',c));}}}}else if(l.test(a)){i=false;c=a;b+=1;a=d.charAt(b);if(a==='x'||a==='X'){c+=a;b+=1;for(;;){a=d.charAt(b);if(!C.test(a)){break;}c+=a;b+=1;}}else{if(l.test(a)){c+=a;b+=1;for(;;){a=d.charAt(b);if(!l.test(a)){break;}c+=a;b+=1;}}if(a==='.'){if(l.test(d.charAt(b+1))){c+=a;b+=1;for(;;){a=d.charAt(b);if(!l.test(a)){break;}c+=a;b+=1;}}}if(a==='e'||a==='E'){c+=a;b+=1;a=d.charAt(b);if(l.test(a)!==true&&a!=='-'&&a!=='+'){i=true;TP.boot.$stderr('Bad exponent: '+TP.boot.$dump(e('number',c+a),', '));v=0+c.slice(0,c.length-1);if(isFinite(v)){f.push(e('number',c));}else{i=true;TP.boot.$stderr('Bad number: '+TP.boot.$dump(e('number',c),', '));}continue;}else{do{c+=a;b+=1;a=d.charAt(b);}while(l.test(a));if(s.test(a)){c+=a;b+=1;i=true;TP.boot.$stderr('Bad number: '+TP.boot.$dump(e('number',c),', '));}}}else{if(s.test(a)){c+=a;b+=1;i=true;TP.boot.$stderr('Bad number: '+TP.boot.$dump(e('number',c),', '));}}}if(!i){v=+c;if(isFinite(v)){f.push(e('number',c));}else{TP.boot.$stderr('Bad number: '+TP.boot.$dump(e('number',c),', '));}}}else if(a==='\''||a==='"'||j&&a==='`'){c=a;n=a;b+=1;for(;;){a=d.charAt(b);if(a==='\n'||a==='\r'||a===''){if(a!==''){c+=a;}if(!j){TP.boot.$stderr('Unterminated string: '+TP.boot.$dump(e('string',c),', '));f.push(e('string',c));break;}f.push(e('quote',n));b=b-c.length;if(a!==''){b+=1;}break;}m=d.charCodeAt(b);c+=String.fromCharCode(m);if(a===n){g=b-1;h=0;while(d.charAt(g)==='\\'){h++;g--;}if(h%2===0){if(n==='`'){f.push(e('substitution',c));}else{f.push(e('string',c));}break;}}b+=1;}b+=1;a=d.charAt(b);}else if(a==='/'){switch(d.charAt(b+1)){case'/':c='//';b+=2;for(;;){a=d.charAt(b);if(a==='\n'||a==='\r'||a===''){break;}m=d.charCodeAt(b);c+=String.fromCharCode(m);b+=1;}f.push(e('comment',c));break;case'*':c='/*';b+=2;for(;;){a=d.charAt(b);if(a===''){TP.boot.$stderr('Unterminated comment: '+TP.boot.$dump(e('comment',c),', '));break;}else if(a==='*'){if(d.charAt(b+1)==='/'){c+='*/';b+=2;a=d.charAt(b);break;}}if(a==='\n'){t++;}m=d.charCodeAt(b);c+=String.fromCharCode(m);b+=1;}f.push(e('comment',c));break;default:if(j&&d.charAt(b+1)==='>'){f.push(e('operator','/>'));b+=2;a=d.charAt(b);break;}if(L&&o&&o.value!=='='&&o.value!=='('&&o.value!==','){f.push(e('operator','/'));b+=1;a=d.charAt(b);break;}g=b+1;c=a;r=0;for(;;){a=d.charAt(g);if(a==='\n'||a==='\r'||a===''){c=d.charAt(b+1)==='='?'/=':'/';f.push(e('operator',c));b+=c.length;a=d.charAt(b);break;}if(a==='['&&r<1){k=g-1;h=0;while(d.charAt(k)==='\\'){h++;k--;}if(h%2===0){r++;}}if(a===']'&&r>0){k=g-1;h=0;while(d.charAt(k)==='\\'){h++;k--;}if(h%2===0){r--;}}if(a==='/'&&r===0){k=g-1;h=0;while(d.charAt(k)==='\\'){h++;k--;}if(h%2===0){c+=a;g+=1;for(;;){a=d.charAt(g);if(/[gimy]/.test(a)!==true){break;}c+=a;g+=1;}f.push(e('regexp',c));b=g;break;}else{c+=a;g+=1;}}else{m=d.charCodeAt(g);c+=String.fromCharCode(m);g+=1;}}break;}}else if(j&&a==='<'&&d.charAt(b+1)==='/'){f.push(e('operator','</'));b+=2;a=d.charAt(b);}else{c=d.slice(b,b+4);for(g=3;g>0;g--){if(x.indexOf('__'+c+'__')>0){break;}c=c.slice(0,g);}f.push(e('operator',c));b+=c.length;a=d.charAt(b);}}if(j&&TP.sys.cfg('log.tsh_tokenize')){TP.boot.$stdout(TP.json(f));}return f;};TP.$condenseJS=function(l,h,i,m,e,k,n){var g,j,f,a,d,b,c;g=TP.$tokenize(l,m,n,false,false,true);j=g.length;d=[];for(f=0;f<j;f++){a=g[f];switch(a.name){case'comment':if(a.value.indexOf('/***')===0){d.push(e?a:a.value);b=a;}break;case'newline':if(h==null||h===false){if(!b||b.name==='newline'){continue;}d.push(e?a:a.value);b=a;}else{if(b&&b.name==='operator'&&b.value==='}'){if(c=g[f+1]){if(c.value==='else'||c.value==='catch'||c.value==='finally'||c.value==='}'||c.value===')'){continue;}}d.push(e?a:a.value);b=a;}}break;case'tab':case'space':if(i!=null&&i===false){d.push(e?a:a.value);b=a;break;}if(!b||b&&TP.$is_whitespace(b.name)){break;}c=g[f+1];if(b&&b.name==='operator'||c&&c.name==='operator'){if(b&&TP.boot.$tshOpRegex.test(b.value)||c&&TP.boot.$tshOpRegex.test(c.value)){d.push(e?a:a.value);b=a;}if(b&&c&&(/[-+]$/.test(b.value)&&/^[-+]/.test(c.value))){d.push(e?a:a.value);b=a;}break;}d.push(e?a:a.value);b=a;break;default:d.push(e?a:a.value);b=a;break;}}if(k){return d;}return d.join('')+(b&&b.name!=='newline'?'\n':'');};
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETGlobals.js';
TP.FunctionProto=Function.prototype;TP.ObjectProto=Object.prototype;TP.ArrayProto=Array.prototype;TP.BooleanProto=Boolean.prototype;TP.DateProto=Date.prototype;TP.NumberProto=Number.prototype;TP.RegExpProto=RegExp.prototype;TP.StringProto=String.prototype;TP.DISPLAY='displayName';TP.NAME='$$name';TP.ID='$$id';TP.OWNER='$$owner';TP.TRACK='$$track';TP.GLOBAL_TRACK='Global';TP.PRIMITIVE_TRACK='Primitive';TP.META_INST_TRACK='MetaInst';TP.META_TYPE_TRACK='MetaType';TP.INST_TRACK='Inst';TP.LOCAL_TRACK='Local';TP.TYPE_TRACK='Type';TP.TYPE_LOCAL_TRACK='TypeLocal';TP.constructOrphanObject=function(){var a;a=null;if(Object.create){a=Object.create(null);}return a;};TP.constructOrphanObject[TP.NAME]='constructOrphanObject';TP.constructOrphanObject[TP.OWNER]=TP;TP.constructOrphanObject[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.constructOrphanObject[TP.DISPLAY]='TP.constructOrphanObject';TP.constructOrphanObject[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.oc=TP.constructOrphanObject;TP.PROPERTY_DEFAULTS=TP.constructOrphanObject();TP.PROPERTY_DEFAULTS.writable=true;TP.PROPERTY_DEFAULTS.enumerable=false;TP.PROPERTY_READONLY=TP.constructOrphanObject();TP.PROPERTY_READONLY.writable=false;TP.PROPERTY_READONLY.enumerable=false;TP.defineNamespace=function(g,e){var c,a,f,d,b;c=g.split('.');a=self[e];if(!a){TP.boot.$stderr('Invalid namespace root.',TP.FATAL);return;}f=e+'.';for(b=0;b<c.length;b++){if(!a[c[b]]){a[c[b]]={};a[c[b]].$$isNamespace=true;d=f+c.slice(0,b+1).join('.');a[c[b]][TP.NAME]=d;a[c[b]][TP.ID]=d;a[c[b]].getTypeNames=function(){var b,c,e,a,d;b=TP.keys(this);c=TP.ac();e=b.getSize();for(a=0;a<e;a++){d=this[TP.NAME]+'.'+b.at(a);if(TP.isType(d.asType())){c.push(d);}}return c;};}a=a[c[b]];}return a;};TP.defineNamespace[TP.NAME]='defineNamespace';TP.defineNamespace[TP.OWNER]=TP;TP.defineNamespace[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.defineNamespace[TP.DISPLAY]='TP.defineNamespace';TP.defineNamespace[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.isNamespace=function(a){if(!a){return false;}return typeof a.$$isNamespace!=='undefined';};TP.isNamespace[TP.NAME]='isNamespace';TP.isNamespace[TP.OWNER]=TP;TP.isNamespace[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.isNamespace[TP.DISPLAY]='TP.isNamespace';TP.isNamespace[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.sys.$globals=TP.sys.$globals||[];TP.sys.getGlobals=function(b,a){if(typeof TP.sys.$getContextGlobals==='function'){return TP.sys.$getContextGlobals(a);}else{return TP.isArray(TP.sys.$globals)?TP.sys.$globals:TP.keys(TP.sys.$globals);}};TP.sys.getGlobals[TP.NAME]='getGlobals';TP.sys.getGlobals[TP.OWNER]=TP.sys;TP.sys.getGlobals[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.sys.getGlobals[TP.DISPLAY]='TP.getGlobals';TP.sys.getGlobals[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.sys.release=function(a){if(TP.sys.$version){return;}TP.sys.$version=a;};TP.sys.release[TP.NAME]='release';TP.sys.release[TP.OWNER]=TP.sys;TP.sys.release[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.sys.release[TP.DISPLAY]='TP.release';TP.sys.release[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.sys.$keywords=['break','case','catch','continue','default','delete','do','else','false','finally','for','function','if','in','instanceof','new','null','return','switch','this','throw','true','try','typeof','var','void','while','with'];TP.sys.$reservedwords=['abstract','boolean','byte','char','class','const','debugger','double','enum','export','extends','final','float','goto','implements','import','int','interface','long','native','package','private','protected','public','short','static','super','synchronized','throws','transient','volatile'];TP.sys.$globalexcludes=[];TP.sys.$noDNUs=['toJSON'];TP.sys.$ecmaglobals=['decodeURI','decodeURIComponent','encodeURI','encodeURIComponent','escape','eval','NaN','Infinity','parseInt','parseFloat','isNaN','isFinite','unescape'];TP.sys.$systemglobals=['applicationCache','clearInterval','clearTimeout','console','localStorage','performance','postMessage','setTimeout','setInterval'];TP.sys.$windowglobals=['alert','addEventListener','back','blur','close','closed','confirm','content','document','find','focus','forward','frameElement','frames','fullScreen','getComputedStyle','getDefaultComputedStyle','getSelection','history','home','innerHeight','innerWidth','length','location','matchMedia','moveBy','moveTo','name','navigator','onabort','onbeforeunload','onblur','onchange','onclick','oncontextmenu','ondevicelight','ondevicemotion','ondeviceorientation','ondeviceproximity','onerror','onfocus','onhashchange','onkeydown','onkeypress','onkeyup','onload','onmousedown','onmouseenter','onmouseleave','onmousemove','onmouseout','onmouseover','onmouseup','onpopstate','onreset','onresize','onscroll','onselect','onsubmit','onunload','onuserproximity','open','openDialog','opener','outerHeight','outerWidth','pageXOffset','pageYOffset','parent','print','prompt','removeEventListener','resizeBy','resizeTo','screen','scroll','scrollBy','scrollTo','scrollX','scrollY','self','sessionStorage','showModalDialog','sizeToContent','status','stop','top','window'];TP.sys.defineGlobal('$error',null);TP.sys.defineGlobal('$error_stack',null);TP.sys.defineGlobal('$focus',null);TP.sys.defineGlobal('$focus_stack',null);TP.sys.defineGlobal('$halo',null);TP.sys.defineGlobal('$halo_stack',null);TP.sys.defineGlobal('$selection',null);TP.sys.defineGlobal('$selection_stack',null);TP.sys.defineGlobal('$signal',null);TP.sys.defineGlobal('$signal_stack',null);TP.sys.defineGlobal('$handled',true);TP.sys.defineGlobal('$STATUS',0);TP.sys.defineGlobal('TP',TP);TP.sys.defineGlobal('APP',APP);TP.sys.$$contentExpiration=0;TP.sys.$$windowCount=0;window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame;window.cancelAnimFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame;TP.NULL_OID='$0000000000000000';TP.OID_PREFIX='$';TP.ANONYMOUS_FUNCTION_NAME='anonymous_function';TP.BREAK=Number.NEGATIVE_INFINITY;TP.CONTINUE=Number.POSITIVE_INFINITY;TP.DESCEND=1;TP.REPEAT=2;TP.META='$$meta';TP.TYPE='$$type';TP.SUPER='$$supertype';TP.SNAME='$$supername';TP.TNAME='$$typename';TP.RNAME='$$realname';TP.TYPEC='$$Type';TP.INSTC='$$Inst';TP.LOAD_NODE='$loadNode';TP.LOAD_PATH='$loadPath';TP.SRC_PATH='$srcPath';TP.NO_LOAD_PATH='<no_load_node>';TP.BUILTIN_LOAD_NODE={};TP.BUILTIN_LOAD_NODE.src='<built_in>';TP.LOAD_PACKAGE='load_package';TP.LOAD_CONFIG='load_config';TP.ANCESTOR_NAMES='$$anames';TP.ANCESTORS='$$ancestors';TP.TRAITS='$$traits';TP.INSTANCES='$$instances';TP.SUBTYPE_NAMES='$$snames';TP.SUBTYPE_NAMES_DEEP='$$snames_deep';TP.SUBTYPES='$$subtypes';TP.SUBTYPES_DEEP='$$subtypes_deep';TP.SUBTYPE='Subtype';TP.METHOD='Method';TP.PRIMITIVE='Primitive';TP.ATTRIBUTE='Attribute';TP.CONSTANT='Constant';TP.INSTANCE='Instance';TP.PROTOTYPE='Prototype';TP.NEEDS_CALLEE=/\.(callNextMethod)(\(|\.apply|\.call)/;TP.ANCESTOR='ans';TP.ANCESTOR_OR_SELF='ansorself';TP.ATTR='attr';TP.CHILD='chld';TP.DESCENDANT='desc';TP.DESCENDANT_OR_SELF='descorself';TP.FOLLOWING='foll';TP.FOLLOWING_SIBLING='follsib';TP.NAMESPACE='ns';TP.PARENT='par';TP.PRECEDING='prec';TP.PRECEDING_SIBLING='precsib';TP.SELF='self';TP.INTRODUCED='introduced';TP.INHERITED='inherited';TP.OVERRIDDEN='overridden';TP.LOCAL='local';TP.GLOBAL='global';TP.DNU='dnu';TP.NONE='none';TP.UNIQUE='unique';TP.INTERNAL='internal';TP.HIDDEN='hidden';TP.BEFORE='before';TP.AFTER='after';TP.REQUIRED=function(){return;};TP.WRAPPER='wrapper';TP.META_TYPE_OWNER={};TP.META_TYPE_OWNER[TP.ID]='MetaType';TP.META_TYPE_OWNER[TP.NAME]='MetaType';TP.META_TYPE_OWNER.getID=function(){return'MetaType';};TP.META_TYPE_OWNER.getName=function(){return'MetaType';};TP.META_TYPE_OWNER.meta_methods={};TP.META_TYPE_TARGETS=[Array,Boolean,Date,Function,Number,Object,RegExp,String];TP.META_INST_OWNER={};TP.META_INST_OWNER[TP.ID]='MetaInst';TP.META_INST_OWNER[TP.NAME]='MetaInst';TP.META_INST_OWNER.getID=function(){return'MetaInst';};TP.META_INST_OWNER.getName=function(){return'MetaInst';};TP.META_INST_OWNER.meta_methods={};TP.META_INST_OWNER.common_methods={};TP.META_INST_TARGETS=[TP.ArrayProto,TP.BooleanProto,TP.DateProto,TP.FunctionProto,TP.NumberProto,TP.RegExpProto,TP.StringProto];TP.PUBLIC='';TP.PRIVATE='$';TP.PROTECTED='_';TP.INTERNAL='$$';TP.STDIN='tsh_stdin';TP.STDOUT='tsh_stdout';TP.STDERR='tsh_stderr';TP.STDIO='tsh_stdio';TP.EQUALITY='==';TP.IDENTITY='===';TP.ENTER=Number.POSITIVE_INFINITY;TP.EXIT=Number.NEGATIVE_INFINITY;TP.TRANSITION=0;TP.INPUT=1;TP.BAD_INDEX=-1;TP.NOT_FOUND=-1;TP.NO_SIZE=-1;TP.NO_RESULT=Number.NEGATIVE_INFINITY;TP.DELETED='$$DELETED$$';TP.NULL='$$NULL$$';TP.UNDEF='$$UNDEFINED$$';TP.ALL='ALL';TP.JOIN='__JOIN__';TP.CURRENT='CURRENT';TP.FIRST='FIRST';TP.LAST='LAST';TP.NEXT='NEXT';TP.PREVIOUS='PREVIOUS';TP.SEEK='SEEK';TP.PRECEDING='PRECEDING';TP.FOLLOWING='FOLLOWING';TP.FIRST_IN_GROUP='FIRST_IN_GROUP';TP.LAST_IN_GROUP='LAST_IN_GROUP';TP.FIRST_IN_NEXT_GROUP='FIRST_IN_NEXT_GROUP';TP.FIRST_IN_PREVIOUS_GROUP='FIRST_IN_PREVIOUS_GROUP';TP.AFTER_END='AfterEnd';TP.BEFORE_BEGIN='BeforeBegin';TP.AFTER_BEGIN='AfterBegin';TP.BEFORE_END='BeforeEnd';TP.FORWARD='FWD';TP.BACKWARD='BWD';TP.UP='UP';TP.DOWN='DOWN';TP.KEYDOWN=253;TP.KEYPRESS=254;TP.KEYUP=255;TP.VERTICAL='VERT';TP.HORIZONTAL='HORIZ';TP.TOP='TOP';TP.RIGHT='RIGHT';TP.BOTTOM='BOTTOM';TP.LEFT='LEFT';TP.TOP_LEFT='TOP_LEFT';TP.TOP_CENTER='TOP_CENTER';TP.TOP_RIGHT='TOP_RIGHT';TP.MIDDLE_LEFT='MIDDLE_LEFT';TP.MIDDLE_RIGHT='MIDDLE_RIGHT';TP.BOTTOM_LEFT='BOTTOM_LEFT';TP.BOTTOM_CENTER='BOTTOM_CENTER';TP.BOTTOM_RIGHT='BOTTOM_RIGHT';TP.MIDDLE='MIDDLE';TP.CENTER='CENTER';TP.NORTH=1;TP.NORTH_BY_EAST=2;TP.NORTH_NORTHEAST=3;TP.NORTHEAST_BY_NORTH=4;TP.NORTHEAST=5;TP.NORTHEAST_BY_EAST=6;TP.EAST_NORTHEAST=7;TP.EAST_BY_NORTH=8;TP.EAST=9;TP.EAST_BY_SOUTH=10;TP.EAST_SOUTHEAST=11;TP.SOUTHEAST_BY_EAST=12;TP.SOUTHEAST=13;TP.SOUTHEAST_BY_SOUTH=14;TP.SOUTH_SOUTHEAST=15;TP.SOUTH_BY_EAST=16;TP.SOUTH=17;TP.SOUTH_BY_WEST=18;TP.SOUTH_SOUTHWEST=19;TP.SOUTHWEST_BY_SOUTH=20;TP.SOUTHWEST=21;TP.SOUTHWEST_BY_WEST=22;TP.WEST_SOUTHWEST=23;TP.WEST_BY_SOUTH=24;TP.WEST=25;TP.WEST_BY_NORTH=26;TP.WEST_NORTHWEST=27;TP.NORTHWEST_BY_WEST=28;TP.NORTHWEST=29;TP.NORTHWEST_BY_NORTH=30;TP.NORTH_NORTHWEST=31;TP.NORTH_BY_WEST=32;TP.SELECTION_NONE=0;TP.SELECTION_TEXT=1;TP.SELECTION_ELEMENT=2;TP.ANCHOR='anchor';TP.HEAD='head';TP.DEFAULT_STRPAD=' ';TP.DEFAULT_NUMPAD='0';TP.DEFAULT_STRLEN=50;TP.DEFAULT_INSTANCE='DEFAULT_INSTANCE';TP.DEFAULT='__DEFAULT__';TP.VISIBLE='visible';TP.HIDDEN='hidden';TP.PRERENDER='prerender';TP.NO_SOURCE_REP='<<No Source Rep>>';TP.ROTATE='ROTATE';TP.SKEW='SKEW';TP.SCALE='SCALE';TP.TRANSLATE='TRANSLATE';TP.ASYNC='ASYNC';TP.SYNC='SYNC';TP.PARALLEL='PAR';TP.SEQUENTIAL='SEQ';TP.PENDING=null;TP.SUCCESS=0;TP.FAILURE=-1;TP.READY=0;TP.ACTIVE=-1;TP.PAUSING=-2;TP.ERRORING=-3;TP.FAILING=-4;TP.CANCELLING=-5;TP.SUCCEEDING=-6;TP.COMPLETING=-7;TP.PAUSED=2;TP.ERRORED=3;TP.FAILED=4;TP.CANCELLED=5;TP.SUCCEEDED=6;TP.COMPLETED=7;TP.SKIPPED=8;TP.TIMED_OUT=9;TP.IGNORED=10;TP.AND='and';TP.OR='or';TP.TRACE=0;TP.INFO=1;TP.WARN=2;TP.ERROR=3;TP.SEVERE=4;TP.FATAL=5;TP.SYSTEM=6;TP.LOG='Activity';TP.BOOT_LOG='Boot';TP.CHANGE_LOG='Change';TP.PATCH_LOG='Patch';TP.TEST_LOG='Test';TP.CSS_LOG='CSS';TP.INFERENCE_LOG='Inference';TP.IO_LOG='IO';TP.JOB_LOG='Job';TP.KEY_LOG='Key';TP.LINK_LOG='Link';TP.QUERY_LOG='Query';TP.SECURITY_LOG='Security';TP.SIGNAL_LOG='Signal';TP.TRANSFORM_LOG='Transform';TP.LOG_ENTRY_DATE=0;TP.LOG_ENTRY_NAME=1;TP.LOG_ENTRY_LEVEL=2;TP.LOG_ENTRY_PAYLOAD=3;TP.LOG_ENTRY_STACK_NAMES=4;TP.LOG_ENTRY_STACK_ARGS=5;TP.ANY='ANY';TP.DEFAULT_FIRING='DEFAULT_FIRING';TP.DOM_FIRING='DOM_FIRING';TP.RESPONDER_FIRING='RESPONDER_FIRING';TP.EXCEPTION_FIRING='EXCEPTION_FIRING';TP.FIRE_ONE='FIRE_ONE';TP.INHERITANCE_FIRING='INHERITANCE_FIRING';TP.AT_TARGET='AT_TARGET';TP.CAPTURING_PHASE='CAPTURING_PHASE';TP.BUBBLING_PHASE='BUBBLING_PHASE';TP.ADD='add';TP.GET='get';TP.SET='set';TP.FILTER='filter';TP.TRANSFORM='transform';TP.TSH_ADD_PIPES=['.>>','.>>!','.&>>','.&>>!','.>>&','.>>&!'];TP.TSH_GET_PIPES=['.<','.<!','.<<'];TP.TSH_SET_PIPES=['.>','.>!','.&>','.&>!','.>&','.>&!'];TP.TSH_FILTER_PIPES=['.|?','.|?*','.&?','.&?*','.|&?','.|&?*'];TP.TSH_TRANSFORM_PIPES=['.|','.|*','.&','.&*','.|&','.|&*'];TP.CREATE='create';TP.DELETE='delete';TP.INSERT='insert';TP.UPDATE='update';TP.SORTED='sorted';TP.OLDVAL='oldval';TP.NEWVAL='newval';TP.DOM=1;TP.TEXT=2;TP.NATIVE=3;TP.WRAP=4;TP.BEST=5;TP.SEND='SEND';TP.RECV='RECV';TP.FILES='files';TP.SUBDIRS='subdirs';TP.APPEND='a';TP.WRITE='w';TP.READ='r';TP.IE_READ=1;TP.IE_WRITE=2;TP.IE_APPEND=8;TP.MOZ_READ=1;TP.MOZ_WRITE=8;TP.MOZ_APPEND=16;TP.MOZ_FILE_RDONLY=1;TP.MOZ_FILE_WRONLY=2;TP.MOZ_FILE_RDWR=4;TP.MOZ_FILE_CREATE=8;TP.MOZ_FILE_APPEND=16;TP.MOZ_FILE_TRUNCATE=32;TP.MOZ_FILE_SYNC=64;TP.MOZ_FILE_EXCL=128;TP.HTTP_DELETE='DELETE';TP.HTTP_GET='GET';TP.HTTP_HEAD='HEAD';TP.HTTP_OPTIONS='OPTIONS';TP.HTTP_POST='POST';TP.HTTP_PUT='PUT';TP.HTTP_TRACE='TRACE';TP.HTTP_BASIC='BASIC';TP.HTTP_DIGEST='DIGEST';TP.WEBDAV_CHECKIN='CHECKIN';TP.WEBDAV_CHECKOUT='CHECKOUT';TP.WEBDAV_COPY='COPY';TP.WEBDAV_LOCK='LOCK';TP.WEBDAV_MKCOL='MKCOL';TP.WEBDAV_MOVE='MOVE';TP.WEBDAV_PROPFIND='PROPFIND';TP.WEBDAV_PROPPATCH='PROPPATCH';TP.WEBDAV_REPORT='REPORT';TP.WEBDAV_UNLOCK='UNLOCK';TP.WEBDAV_VERSIONCONTROL='VERSIONCONTROL';TP.WEBDAV_LOCKTYPE_WRITE='write';TP.WEBDAV_LOCKSCOPE_EXCLUSIVE='exclusive';TP.WEBDAV_LOCKSCOPE_SHARED='shared';TP.WEBDAV_LOCKTIMEOUT_DEFAULT='Second-86400';TP.WEBDAV_LOCKTIMEOUT_INFINITE='Infinite';TP.UTF8='UTF-8';TP.ISO8859='ISO-8859-1';TP.URL_ENCODED='application/x-www-form-urlencoded';TP.XML_ENCODED='application/xml';TP.JSON_ENCODED='application/json';TP.XHTML_ENCODED='application/xhtml+xml';TP.XSLT_ENCODED='application/xslt+xml';TP.ATOM_ENCODED='application/atom+xml';TP.XMLRPC_ENCODED='application/xml+rpc';TP.SOAP_ENCODED='application/soap+xml';TP.OCTET_ENCODED='application/octet-stream';TP.FIELD_ENCODED='application/vnd.tpi.hidden-fields';TP.MP_FORMDATA_ENCODED='multipart/form-data';TP.MP_RELATED_ENCODED='multipart/related';TP.PLAIN_TEXT_ENCODED='text/plain';TP.CSS_TEXT_ENCODED='text/css';TP.HTML_TEXT_ENCODED='text/html';TP.XML_TEXT_ENCODED='text/xml';TP.JSON_TEXT_ENCODED='text/json';TP.JS_TEXT_ENCODED='text/javascript';TP.HTML_401_TAGS={'a':true,'abbr':true,'acronym':true,'address':true,'applet':true,'area':true,'b':true,'base':true,'basefont':true,'bdo':true,'big':true,'blockquote':true,'body':true,'br':true,'button':true,'caption':true,'center':true,'cite':true,'code':true,'col':true,'colgroup':true,'dd':true,'del':true,'dfn':true,'dir':true,'div':true,'dl':true,'dt':true,'em':true,'embed':true,'fieldset':true,'font':true,'form':true,'frame':true,'frameset':true,'h1':true,'h2':true,'h3':true,'h4':true,'h5':true,'h6':true,'head':true,'hr':true,'html':true,'i':true,'iframe':true,'img':true,'input':true,'isindex':true,'kbd':true,'label':true,'legend':true,'li':true,'link':true,'map':true,'menu':true,'meta':true,'noframes':true,'noscript':true,'object':true,'ol':true,'optgroup':true,'option':true,'p':true,'param':true,'pre':true,'q':true,'s':true,'samp':true,'script':true,'select':true,'small':true,'span':true,'strike':true,'strong':true,'style':true,'sub':true,'sup':true,'table':true,'tbody':true,'td':true,'textarea':true,'tfoot':true,'th':true,'thead':true,'title':true,'tr':true,'tt':true,'u':true,'ul':true,'val':true};TP.CONTENT_BOX=1;TP.PADDING_BOX=2;TP.BORDER_BOX=3;TP.MARGIN_BOX=4;TP.BUSY_HEIGHT=28;TP.FONT_HEIGHTS=null;TP.SCROLLER_WIDTH=null;TP.CURTAIN_TIER=50;TP.ALERT_TIER=100;TP.SLIDER_TIER=500;TP.MENU_TIER=1000;TP.POPUP_TIER=5000;TP.HALO_TIER=10000;TP.CONSOLE_TIER=15000;TP.CONNECTOR_TIER=20000;TP.DRAG_DROP_TIER=30000;TP.NODESET=1;TP.FIRST_NODE=2;TP.SAME_NODE=0;TP.PRECEDING_NODE=2;TP.FOLLOWING_NODE=4;TP.CONTAINS_NODE=8;TP.CONTAINED_BY_NODE=16;TP.NEVER_PREFIXED_ATTRS=['id'];TP.ACL_REAL='acl:real';TP.ACL_EFFECTIVE='acl:effective';TP.HASH_MD5=0;TP.HASH_SHA1=1;TP.HASH_HEX=2;TP.HASH_B64=3;TP.HASH_LATIN1=4;TP.PBKDF2_KEYSIZE=128/8;TP.PBKDF2_ITERATION_COUNT=2000;TP.CREDENTIALS_DB_NAME='TIBET_USER_CREDENTIALS';TP.LOCALSTORAGE_DB_NAME='TIBET_LOCAL_DB';TP.BASE_AWARE_PREFIX='BASE_AWARE_PREFIX';TP.XML_EXTENSIONS=['xml','xhtml','tsh','xsl','xsd'];TP.GLOBAL_ID_ATTR='tibet:globalID';TP.GLOBAL_DOCID_ATTR='tibet:globalDocID';TP.XML_10_HEADER='<?xml version="1.0"?>';TP.XML_10_UTF8_HEADER='<?xml version="1.0" encoding="UTF-8"?>';TP.XML_10_STANDALONE_HEADER='<?xml version="1.0" standalone="yes"?>';TP.IE_XMLHTTP_VERSIONS=['Msxml2.XMLHTTP.6.0','Msxml2.XMLHTTP.3.0','Msxml2.XMLHTTP','Microsoft.XMLHTTP'];TP.IE_DOM_DOCUMENT_VERSIONS=['Msxml2.DOMDocument.6.0','Msxml2.DOMDocument.3.0','Msxml2.DOMDocument'];TP.IE_THREADED_DOM_VERSIONS=['Msxml2.FreeThreadedDOMDocument.6.0','Msxml2.FreeThreadedDOMDocument.3.0','Msxml2.FreeThreadedDOMDocument'];TP.IE_XSL_TEMPLATE_VERSIONS=['Msxml2.XSLTemplate.6.0','Msxml2.XSLTemplate.3.0','Msxml2.XSLTemplate'];TP.SHOW_ABOUT='SHOW_ABOUT';TP.READ_HISTORY='READ_HISTORY';TP.READ_PREFERENCE='READ_PREFERENCE';TP.WRITE_PREFERENCE='WRITE_PREFERENCE';TP.MANIPULATE_WINDOW='MANIPULATE_WINDOW';TP.READ_EXECUTION_STACK='READ_EXECUTION_STACK';TP.ACCESS_XDOMAIN_XMLHTTP='ACCESS_XDOMAIN_XMLHTTP';TP.ACCESS_XDOMAIN_FRAME='ACCESS_XDOMAIN_FRAME';TP.ACCESS_DOM_INSPECT='ACCESS_DOM_INSPECT';TP.HOST_FILE_DELETE='HOST_FILE_DELETE';TP.HOST_FILE_ACCESS='HOST_FILE_ACCESS';TP.HOST_FILE_SAVE='HOST_FILE_SAVE';TP.HOST_CMD_EXEC='HOST_CMD_EXEC';TP.XSLT_EXEC='XSLT_EXEC';TP.PRIVILEGE_FLAGS={};TP.PRIVILEGE_DESCRIPTIONS={'SHOW_ABOUT':'Show a special "about:" panel','READ_HISTORY':'Read the browing history','READ_PREFERENCE':'Read a preference','WRITE_PREFERENCE':'Store a preference','MANIPULATE_WINDOW':'Manipulate a window','READ_EXECUTION_STACK':'Read the JavaScript execution stack','ACCESS_XDOMAIN_FRAME':'Access a window from another domain','ACCESS_DOM_INSPECT':'Inspect a DOM element','ACCESS_XDOMAIN_XMLHTTP':'Access data from another domain','HOST_XSLT_EXEC':'Execute an XSLT stylesheet','HOST_FILE_ACCESS':'General file system access','HOST_FILE_DELETE':'Delete a file','HOST_FILE_SAVE':'Save a file','HOST_CMD_EXEC':'Execute a shell command'};TP.SLOT_FILTERS={public:{'methods':true,'scope':TP.ALL},hidden:{'methods':true,'hidden':true,'scope':TP.ALL},known:{'methods':true,'hidden':true,'scope':TP.ALL,'public':true},unique:{'methods':true},local:{'methods':true,'scope':TP.LOCAL},introduced:{'methods':true,'scope':TP.INTRODUCED},inherited:{'methods':true,'scope':TP.INHERITED},overridden:{'methods':true,'scope':TP.OVERRIDDEN},attributes:{'scope':TP.ALL},hidden_attributes:{'hidden':true,'scope':TP.ALL},known_attributes:{'hidden':true,'scope':TP.ALL,'public':true},unique_attributes:{},local_attributes:{'scope':TP.LOCAL},introduced_attributes:{'scope':TP.INTRODUCED},inherited_attributes:{'scope':TP.INHERITED},overridden_attributes:{'scope':TP.OVERRIDDEN},hidden_unique_attributes:{'hidden':true},hidden_local_attributes:{'hidden':true,'scope':TP.LOCAL},hidden_introduced_attributes:{'hidden':true,'scope':TP.INTRODUCED},hidden_inherited_attributes:{'hidden':true,'scope':TP.INHERITED},hidden_overridden_attributes:{'hidden':true,'scope':TP.OVERRIDDEN},known_unique_attributes:{'hidden':true,'public':true},known_local_attributes:{'hidden':true,'scope':TP.LOCAL,'public':true},known_introduced_attributes:{'hidden':true,'scope':TP.INTRODUCED,'public':true},known_inherited_attributes:{'hidden':true,'scope':TP.INHERITED,'public':true},known_overridden_attributes:{'hidden':true,'scope':TP.OVERRIDDEN,'public':true},methods:{'attributes':false,'methods':true,'scope':TP.ALL},hidden_methods:{'attributes':false,'methods':true,'hidden':true,'scope':TP.ALL},known_methods:{'attributes':false,'methods':true,'hidden':true,'scope':TP.ALL,'public':true},unique_methods:{'attributes':false,'methods':true},local_methods:{'attributes':false,'methods':true,'scope':TP.LOCAL},introduced_methods:{'attributes':false,'methods':true,'scope':TP.INTRODUCED},inherited_methods:{'attributes':false,'methods':true,'scope':TP.INHERITED},overridden_methods:{'attributes':false,'methods':true,'scope':TP.OVERRIDDEN},hidden_unique_methods:{'attributes':false,'methods':true,'hidden':true},hidden_local_methods:{'attributes':false,'methods':true,'hidden':true,'scope':TP.LOCAL},hidden_introduced_methods:{'attributes':false,'methods':true,'hidden':true,'scope':TP.INTRODUCED},hidden_inherited_methods:{'attributes':false,'methods':true,'hidden':true,'scope':TP.INHERITED},hidden_overridden_methods:{'attributes':false,'methods':true,'hidden':true,'scope':TP.OVERRIDDEN},known_unique_methods:{'attributes':false,'methods':true,'hidden':true,'public':true},known_local_methods:{'attributes':false,'methods':true,'hidden':true,'scope':TP.LOCAL,'public':true},known_introduced_methods:{'attributes':false,'methods':true,'hidden':true,'scope':TP.INTRODUCED,'public':true},known_inherited_methods:{'attributes':false,'methods':true,'hidden':true,'scope':TP.INHERITED,'public':true},known_overridden_methods:{'attributes':false,'methods':true,'hidden':true,'scope':TP.OVERRIDDEN,'public':true},hidden_unique:{'methods':true,'hidden':true},hidden_local:{'methods':true,'hidden':true,'scope':TP.LOCAL},hidden_introduced:{'methods':true,'hidden':true,'scope':TP.INTRODUCED},hidden_inherited:{'methods':true,'hidden':true,'scope':TP.INHERITED},hidden_overridden:{'methods':true,'hidden':true,'scope':TP.OVERRIDDEN},known_unique:{'methods':true,'hidden':true,'public':true},known_local:{'methods':true,'hidden':true,'scope':TP.LOCAL,'public':true},known_introduced:{'methods':true,'hidden':true,'scope':TP.INTRODUCED,'public':true},known_inherited:{'methods':true,'hidden':true,'scope':TP.INHERITED,'public':true},known_overridden:{'methods':true,'hidden':true,'scope':TP.OVERRIDDEN,'public':true}};TP.LOG_ARGS=function(){var a;a=TP.args(arguments);TP.ifTrace()?TP.trace(a,TP.LOG,arguments):0;};TP.NOTIFY_ARGS=function(){var a;a=TP.args(arguments);TP.boot.$notify(a,'ARGS');};TP.TEST_HANDLER=function(a){TP.debug('break.signal_handler');TP.log('TP.TEST_HANDLER fired for: '+a.getSignalName()+' @ '+a.getSignalOrigin(),TP.SIGNAL_LOG,arguments,TP.SYSTEM);};TP.TEST_SETUP_NAME='Test_SetUp';TP.TEST_TEARDOWN_NAME='Test_TearDown';TP.TEST_NAME_PREFIX='test ';TP.PERFORM='Perform';TP.SKIP='Skip';TP.TODO='Todo';TP.PRODUCED='Produced';TP.EXPECTED='Expected';TP.RETURN_NULL=function(){return;};TP.RETURN_THIS=function(){return this;};TP.RETURN_TRUE=function(){return true;};TP.RETURN_FALSE=function(){return false;};TP.RETURN_ARG0=function(){return arguments[0];};TP.RETURN_ARGS=function(){return arguments;};TP.RETURN_FIRST=function(){return arguments[0].first();};TP.RETURN_LAST=function(){return arguments[0].last();};TP.RETURN_EMPTY=function(){return'';};TP.RETURN_SPACE=function(){return' ';};TP.RETURN_ORIG=function(b,a,c){return a;};TP.RETURN_NEW=function(b,c,a){return a;};TP.RETURN_TOSTRING=function(){return this.toString();};TP.CASE_INSENSITIVE_SORT=function(c,d){var a,b;a=c.toLowerCase();b=d.toLowerCase();if(a<b){return-1;}else if(a>b){return 1;}return 0;};TP.NATURAL_ORDER_SORT=function(j,h){var i,c,l,d,e,f,g,a,b,k;i=function(b){var a;a=b.charCodeAt(0);if(a<=32){return true;}else{return false;}};c=function(b){var a;a=b.charCodeAt(0);if(a>=48&&a<=57){return true;}else{return false;}};l=function(g,h){var a,e,f,b,d;a=0;e=0;f=0;for(;;e++,f++){b=g.charAt(e);d=h.charAt(f);if(!c(b)&&!c(d)){return a;}else if(!c(b)){return-1;}else if(!c(d)){return+1;}else if(b<d){if(a===0){a=-1;}}else if(b>d){if(a===0){a=+1;}}else if(b===0&&d===0){return a;}}};d=0;e=0;f=0;g=0;while(true){f=g=0;a=j.charAt(d);b=h.charAt(e);while(i(a)||a==='0'){if(a==='0'){f++;}else{f=0;}a=j.charAt(++d);}while(i(b)||b==='0'){if(b==='0'){g++;}else{g=0;}b=h.charAt(++e);}if(c(a)&&c(b)){if((k=l(j.substring(d),h.substring(e)))!==0){return k;}}if(a===0&&b===0){return f-g;}if(a<b){return-1;}else if(a>b){return+1;}++d;++e;}};TP.COMPARE_SORT=function(a,b){return a.compareTo(b);};TP.DELETION_SORT=function(a,b){if(a!==TP.DELETED&&b===TP.DELETED){return-1;}else if(a===TP.DELETED&&b!==TP.DELETED){return 1;}return 0;};TP.DOCUMENT_ORDER_SORT=function(a,b){if(a.sourceIndex){return a.sourceIndex-b.sourceIndex;}else if(a.compareDocumentPosition){return 3-(a.compareDocumentPosition(b)&6);}else{return 0;}};TP.TABINDEX_ORDER_SORT=function(c,d){var a,b;a=parseInt(c.getAttribute('tabindex'),10);b=parseInt(d.getAttribute('tabindex'),10);if(isNaN(a)&&isNaN(b)){return 0;}else if(isNaN(a)&&!isNaN(b)){if(b<=0){return 0;}return 1;}else if(!isNaN(a)&&isNaN(b)){if(a<=0){return 0;}return-1;}else if(a<=0&&b<=0){return 0;}else if(a<=0&&b>0){return 1;}else if(a>0&&b<=0){return-1;}return a-b;};TP.EQUALITY_SORT=function(a,b){var c,d;if(TP.notValid(a)){c=TP.str(a);}else if(TP.canInvoke(a,'$getEqualityValue')){c=TP.str(a.$getEqualityValue());}else{c=TP.str(a);}if(TP.notValid(b)){d=TP.str(b);}else if(TP.canInvoke(b,'$getEqualityValue')){d=TP.str(b.$getEqualityValue());}else{d=TP.str(b);}if(c<d){return-1;}else if(c>d){return 1;}return 0;};TP.FIRST_ITEM_SORT=function(a,b){if(!a&&b){return 1;}else if(a&&!b){return-1;}else if(a.at(0)<b.at(0)){return-1;}else if(a.at(0)>b.at(0)){return 1;}return 0;};TP.IDENTITY_SORT=function(a,b){var c,d;if(TP.notValid(a)){c=TP.str(a);}else if(TP.canInvoke(a,'$getIdentityValue')){c=TP.str(a.$getIdentityValue());}else{c=TP.str(a);}if(TP.notValid(b)){d=b;}else if(TP.canInvoke(b,'$getIdentityValue')){d=b.$getIdentityValue();}else{d=b;}if(c<d){return-1;}else if(c>d){return 1;}return 0;};TP.NUMERIC_SORT=function(a,b){if(a<b){return-1;}else if(a>b){return 1;}return 0;};TP.SECOND_ITEM_SORT=function(a,b){if(!a&&b){return 1;}else if(a&&!b){return-1;}else if(a.at(1)<b.at(1)){return-1;}else if(a.at(1)>b.at(1)){return 1;}return 0;};TP.SUBTYPE_SORT=function(c,d){var a,b;a=c.getSupertypeNames().getSize();b=d.getSupertypeNames().getSize();if(a<b){return-1;}else if(a>b){return 1;}return 0;};TP.UNICODE_SORT=function(c,d){var a,b;a=TP.str(c).unicodeEscaped();b=TP.str(d).unicodeEscaped();if(a<b){return-1;}else if(a>b){return 1;}return 0;};TP.ELEMENT_SORT=function(c,d){var a,b;a=c.tagName.toLowerCase();b=d.tagName.toLowerCase();if(a<b){return-1;}else if(a>b){return 1;}return 0;};TP.KEYMAP_ELEMENT_SORT=function(g,h){var c,d,e,f,a,b;d=g.hasAttribute('browser');c=g.hasAttribute('platform');f=h.hasAttribute('browser');e=h.hasAttribute('platform');if(d&&c){a=10;}else if(d&&!c){a=5;}else{a=1;}if(f&&e){b=10;}else if(f&&!e){b=5;}else{b=1;}return a-b;};TP.defineNamespace('regex','TP');TP.regex.JOIN=new RegExp(TP.JOIN,'g');TP.regex.BASE_AWARE=new RegExp(TP.BASE_AWARE_PREFIX);TP.regex.ARRAY_CONSTRUCTOR=/function Array\(\)/;TP.regex.BOOLEAN_CONSTRUCTOR=/function Boolean\(\)/;TP.regex.DATE_CONSTRUCTOR=/function Date\(\)/;TP.regex.FUNCTION_CONSTRUCTOR=/function Function\(\)/;TP.regex.OBJECT_CONSTRUCTOR=/function Object\(\)/;TP.regex.NUMBER_CONSTRUCTOR=/function Number\(\)/;TP.regex.REGEXP_CONSTRUCTOR=/function RegExp\(\)/;TP.regex.STRING_CONSTRUCTOR=/function String\(\)/;TP.regex.ATTRIBUTE_NAME=/^[_$][a-zA-Z0-9_$]*$|^[A-Z]/;TP.regex.PUBLIC_SLOT=/^_/;TP.regex.PRIVATE_SLOT=/^\$[^$]/;TP.regex.INTERNAL_SLOT=/^\$\$|\$\$[Inst|Type]|^__(.*)__$/;TP.regex.PRIVATE_OR_INTERNAL_SLOT=/^\$|\$\$[Inst|Type]|^__(.*)__$/;TP.regex.ANY_TYPE_SLOT=/^_|^\$|\$\$[Inst|Type]|^__(.*)__$/;TP.regex.NATIVE_CODE=/\[native code\]/;TP.regex.NATIVE_TYPENAME=/^[A-Z]+[A-Za-z0-9]+/;TP.regex.NATIVE_TYPENAME_MATCH=/^\[object/;TP.regex.NATIVE_TYPENAME_EXTRACT=/ (.*)\]/;TP.regex.VALID_TYPENAME=/^[a-zA-Z]([-a-zA-Z0-9_.:]){2,}$/;TP.regex.VALID_WINDOWNAME=/^[a-zA-Z]([-a-zA-Z0-9_](\.)*){1,}$/;TP.regex.APP_TYPENAME=/^APP\./;TP.regex.TP_TYPENAME=/^TP\./;TP.regex.META_TYPENAME=/\.meta\./;TP.regex.INTERNAL_TYPENAME=/^(Inst|Type|Local)$/i;TP.regex.INSTANCE_OID=/^([a-zA-Z_$]{1}[a-zA-Z0-9_$]*?)\$([a-zA-Z0-9]+)$/;TP.regex.LOCAL_TRACK=/Local/;TP.regex.ROOT_OBJECTS=/Object|TP.lang.RootObject|TP.lang.Object/;TP.regex.JS_FIRST_CHAR=/^[a-zA-Z_$]/;TP.regex.JS_IDENT_REPLACE=/[^a-zA-Z0-9_$]/g;TP.regex.JS_IDENTIFIER=/^[a-zA-Z_$]{1}[a-zA-Z0-9_$]*$/;TP.regex.JS_ASSIGNMENT=/(^|;|\s+)([a-zA-Z_$]{1}[a-zA-Z0-9_$]*)(\s*=[^=])/g;TP.regex.HAS_AT=/@/;TP.regex.HAS_BACKSLASH=/\\/;TP.regex.HAS_COLON=/:/;TP.regex.HAS_HASH=/#/;TP.regex.HAS_HYPHEN=/\-/;TP.regex.HAS_PAREN=/\(|\)/;TP.regex.HAS_PERIOD=/\./;TP.regex.HAS_PIPE=/[^\\]?\|/;TP.regex.HAS_PIPE_SPLAT=/[^\\]?\|\*/;TP.regex.HAS_SCHEME=/^([A-Za-z][-.+A-Za-z0-9]*):/;TP.regex.HAS_SLASH=/\//;TP.regex.HAS_TIMEZONE=/[Z\+\-]/;TP.regex.CSS_CLIP_RECT=/rect\s*\((\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s*\)/;TP.regex.CSS_IMPORT_RULE=/@import\s*(url\()?['"]?(.*?)['"]?(\))?;/g;TP.regex.PIXELS=/px/;TP.regex.QUANTIFIERS=/[\$\.\?\+\(\)]/g;TP.regex.ATTRIBUTE_STRING=/([-\w]+)\s*=\s*(['"])(.+?)\2\s*/g;TP.regex.STYLE_STRING=/([-\w]+)\s*:\s*([^/]+?)\s*($|;)/g;TP.EMPTY_ARRAY=[];TP.regex.BOUND_ELEMENT=/bind:/;TP.regex.BOUND_INSTANCE=/instance\((.*)\)(.*)/;TP.regex.DYNAMIC_BINDPATH=/\[/;TP.regex.REPEATING_ATTRIBUTE=/repeat-/;TP.regex.DYNALOADED=null;TP.DYNALOADED='inlined/evaluated source code';TP.MISSING_CODE='missing/unavailable source code';TP.BACK_SPACE_KEY=8;TP.TAB_KEY=9;TP.ENTER_KEY=10;TP.RETURN_KEY=13;TP.SHIFT_KEY=16;TP.CONTROL_KEY=17;TP.ALT_KEY=18;TP.ESCAPE_KEY=27;TP.DELETE_KEY=46;TP.regex.CTRL=/Ctrl_.+/;TP.regex.ALT=/Alt_.+/;TP.regex.META=/Meta_.+/;TP.regex.SHIFT=/Shift_.+/;TP.regex.PRESS_END=/[Pp]ress$/;TP.regex.DOWN_END=/[Dd]own$/;TP.regex.UP_END=/[Uu]p$/;TP.regex.KEY_EVENT=/^key|DOMKey|_(?:Up|Down|Press)$/;TP.regex.MOUSE_EVENT=/^mouse|DOMMouse/;TP.regex.HANDLER_NAME=/^handle([-_a-zA-Z0-9]+)$/;TP.regex.ON_HANDLER_NAME=/^on([A-Z0-9][a-zA-Z0-9_]*?)(Of([A-Z][a-zA-Z0-9_]*?))*?(When([A-Z][a-zA-Z0-9_]*?))*?$/;TP.regex.HAS_PATH_OFFSET=/\/\.\./;TP.regex.HAS_PATH_NOOP=/\/\./;TP.regex.REMOVE_PATH_OFFSET=/(^|\/)[^\/]*\/\.\./;TP.regex.REMOVE_PATH_NOOP=/\/\./;TP.regex.FILE_PATH=/\.([^\/]*)$/;TP.regex.ROOT_PATH=/^\/(\w)*/;TP.regex.UNC_PATH=/^\\\\\w/;TP.regex.WINDOWS_PATH=/^(")*\w:\\(.*)/;TP.regex.SUBSTITUTION_STRING=/[#%@]\{|`.+`/;TP.regex.STARTS_ACP=/^\{\{/;TP.regex.HAS_ACP=/\{\{.*\}\}/;TP.regex.ACP_NUMERIC=/\{\{(\d+)\}\}/g;TP.regex.ACP_FORMAT=/([^\\]*)\s*%\s*(.+)/;TP.regex.TSH_VARSUB=/\$\{?([a-zA-Z_$]{1}[a-zA-Z0-9_$]*)\}?/;TP.regex.TSH_VARSUB_EXTRACT=/\$\{?([a-zA-Z_$]{1}[a-zA-Z0-9_$]*)\}?/g;TP.regex.TSH_VARSUB_EXTENDED=/\$\{([a-zA-Z_$]{1}[a-zA-Z0-9_$]*)\}/g;TP.regex.TRANSFORMABLE=/[$#%@]\{|`.+`/;TP.regex.CALL_STACK_FORMAT=/(.*) \((.*)\)/;TP.regex.CALL_STACK_ID=/Function\$[0-9a-z]*($|([\s]))/g;TP.regex.CALL_STACK_ENTRY_SPLITTER=/(.+)@(.+):(\d+):(\d+)/;TP.regex.CAMEL_CASE=/([-\s_]([a-z]))/g;TP.regex.TITLE_CASE=/([-\s_]([a-z]))/g;TP.regex.WORD_BOUNDARIES=/[-\s_]/g;TP.regex.WHITESPACE=/\s+/;TP.regex.ONLY_WORD=/^\w+$/;TP.regex.PUNCTUATION=/[\]\[\/ .,;:@!#%&*_'"?<>{}+=|)(^~`$-]+/;TP.regex.ANY_NUMBER=/^-?\d+$/i;TP.regex.PERCENTAGE=/^-?\d+%$/i;TP.regex.NON_UTF8_CHARS=/[\xC2-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF4][\x80-\xBF]{3}/g;TP.regex.TEST_FUNCTION=/test[a-zA-Z0-9$_'"]+/;TP.XML_NCNAME='[A-Za-z_]|[^\\x00-\\x7F]';TP.XML_NCNAMECHAR='[A-Za-z0-9_.-]|[^\\x00-\\x7F]';TP.XML_IDREF=new RegExp(TP.XML_NCNAME+'('+TP.XML_NCNAMECHAR+')*');TP.XML_NAMESTART='[A-Za-z_:]|[^\\x00-\\x7F]';TP.XML_NAMECHAR='[A-Za-z0-9_:.-]|[^\\x00-\\x7F]';TP.XML_ATTRVAL='"[^<"]'+'*'+'"'+'|\'[^<\']*\'';TP.XML_NAME='('+TP.XML_NAMESTART+')'+'('+TP.XML_NAMECHAR+')*';TP.regex.IS_ELEM_MARKUP=new RegExp('^(\\s)*<'+TP.XML_NAME+'>(\\s)*'+'([\\s\\S]*)'+'>(\\s)*$');TP.CONTAINS_ELEM_MARKUP_DEF='<('+TP.XML_NAMESTART+')([^<>"\']+|'+TP.XML_ATTRVAL+')*>';TP.regex.CONTAINS_ELEM_MARKUP=new RegExp(TP.CONTAINS_ELEM_MARKUP_DEF);TP.regex.HAS_ELEMENT=/<\/|\/>/;TP.regex.HAS_PI=/<\?|\?>/;TP.regex.HAS_ENTITY=/&#/;TP.regex.INVALID_ID_CHARS=/[ !"#$%&'()*+,/:;<=>?@[\]^`{|}~]+/g;TP.regex.EMPTY_TAG_END=/\/>/;TP.regex.OPENING_TAG=new RegExp('<('+TP.XML_NAME+')([^<>"\']+|'+TP.XML_ATTRVAL+')*>');TP.regex.CLOSING_TAG=/(<\/([^>]*?)>)$/;TP.regex.OPENING_TAG_NAME=new RegExp('<(('+TP.XML_NAMECHAR+')+)');TP.regex.ALL_ELEM_MARKUP=new RegExp('<('+TP.XML_NAME+')([^<>"\']+|'+TP.XML_ATTRVAL+')*>'+'([\\s\\S]*)$');TP.regex.XHTML_10_EMPTY_ELEMENTS=/^(area|base|basefont|bgsound|br|col|embed|hr|img|input|isindex|link|meta|param|wbr)$/;TP.regex.XHTML_10_EMPTY_ELEMENTS_STRIP=/<\/(area|base|basefont|bgsound|br|col|embed|hr|img|input|isindex|link|meta|param|wbr)>/g;TP.XML_COMMENT_DEF='<!--(([^-]*)-([^-][^-]*-)*->?)?';TP.regex.XML_COMMENT=new RegExp(TP.XML_COMMENT_DEF,'g');TP.regex.XML_COMMENT_WHOLE=new RegExp('^<!--(.+?)-->$');TP.XML_CDATA_DEF='<!\\[CDATA\\[([^]]*]([^]]+])*]+([^]>][^]]*]([^]]+])*]+)*>)?';TP.regex.XML_CDATA=new RegExp(TP.XML_CDATA_DEF,'g');TP.regex.XML_CDATA_WHOLE=new RegExp('^<!\\[CDATA\\[(.+?)\\]\\]>$');TP.XML_PI_DEF='<\\?(([A-Za-z_:]|[^\\x00-\\x7F])([A-Za-z0-9_:.-]|[^\\x00-\\x7F])*(\\?>|[\\n\\r\\t ][^?]*\\?+([^>?][^?]*\\?+)*>)?)?';TP.regex.XML_PI=new RegExp(TP.XML_PI_DEF,'g');TP.regex.XML_PI_WHOLE=new RegExp('^<\\?(.+?)\\?>$');TP.regex.XML_ALL_MARKUP=new RegExp('('+TP.CONTAINS_ELEM_MARKUP_DEF+'|'+TP.XML_COMMENT_DEF+'|'+TP.XML_CDATA_DEF+'|'+TP.XML_PI_DEF+')');TP.regex.XML_DECL=/<\?xml\s+.+\?>/;TP.regex.XML_EMPTY_TAG=/<([^\s<]*)([^<]*?)\/>/g;TP.regex.ML_ENTITY=/&([a-zA-Z#0-9]+);/;TP.regex.XML_ATTR=/^\s*([\w:]+)=['"](\w*)['"]/;TP.regex.XML_ATTR_NULL=/\s*([\w:]+)=['"]null['"]/g;TP.regex.XML_ATTR_CONTAINING_NULL=/(\s*[\w:]+=)['"]([^'"]*?)null([^'"]*?)['"]/g;TP.regex.HTML_HTML_ELEM=/<html((.*)?([^\/>]*)?)(\/|>([^<]*)?<\/html)>/gi;TP.regex.HTML_HEAD_ELEM=/<head((.*)?([^\/>]*)?)(\/|>([^<]*)?<\/head)>/gi;TP.regex.HTML_BODY_ELEM=/<body((.*)?([^\/>]*)?)(\/|>([^<]*)?<\/body)>/gi;TP.regex.HTML_SCRIPT_ELEM=/<script((.*)?([^\/>]*)?)(\/|>([^<]*)?<\/script)>/gi;TP.regex.HTML_CSS_LINK_ELEM=/<link((.*)?( rel="stylesheet"| type="text\/css")+([^\/>]*)?)(\/|>([^<]*)?<\/link)>/gi;TP.regex.HTML_CSS_STYLE_ELEM=/<style((.*)?( type="text\/css")+([^\/>]*)?)(\/|>([^<]*)?<\/style)>/gi;TP.regex.HTML_IMG_ELEM=/<img((.*)?([^\/>]*)?)(\/|>([^<]*)?<\/img)>/gi;TP.regex.NON_PREFIXED_NS_ATTR=/\s+xmlns=(['"])([\x00-\x7F]*?)\1/g;TP.regex.PREFIXED_NS_ATTR=/\s+xmlns:\w+=(['"])([\x00-\x7F]*?)\1/g;TP.regex.QUOTED_CONTENT=/^(['"])(.*)\1$/;TP.regex.ESCAPED_QUOTED_CONTENT=/^\\(['"])(.*)\\\1$/;TP.regex.MIME_TYPE=/(\w+)\/(\w+)/gi;TP.regex.ANONYMOUS_NAME=/^\$\d/;TP.regex.IS_NAMEXP=/\*| /;TP.MAX_DOUBLE=9007199254740991;TP.MAX_TIMEOUT=2147483647;TP.regex.GETTER=/^get([A-Z])/;TP.regex.SETTER=/^set([A-Z])/;TP.regex.PERFORM_INSTRUMENT=/at[End|Start]/;TP.regex.CACHE_FILE=/_CACHE_/;TP.regex.MULTI_VALUED=/ /;TP.regex.REGEX_ESCAPE=/([-[\]{}()*+?.\\^$|,#\s]{1})/g;TP.regex.REGEX_LITERAL_STRING=/^\/(.+)\/[gimy]*$/;TP.regex.TIBET_URI=/^[tibet:|~]/;TP.regex.TIBET_URI_SPLITTER=/tibet:([^\/]*?)\/([^\/]*?)\/([^\/#]*)\/?(([^#]*)(.*))/;TP.regex.TIBET_URN=/urn:tibet:/;TP.TIBET_URN_PREFIX='urn:tibet:';TP.regex.TPOINTER=/([^\(]*)\(([^\)]*)\)/;TP.regex.TIBET_VIRTUAL_URI_PREFIX=/^~|^tibet:\/\/\/~/;TP.regex.VIRTUAL_URI_PREFIX=/^~/;TP.TSH_OPERATOR_CHARS='`#~!@%^&*=\\;:,./?';TP.regex.TSH_TEMPLATE=/\$\{/;TP.regex.TSH_SUBSHELL=/\.\(\((.*)?\.\)\)/;TP.regex.TSH_SUBGROUP=/\.\{\{(.*)?\.\}\}/;TP.regex.TSH_HEREDOC=/\.<</;TP.regex.TSH_DEREF_SUGAR=/^@\$?\{?[a-zA-Z_$]{1}[a-zA-Z0-9_$]*\}?$/;TP.regex.SCHEME=/^([A-Za-z][-.+A-Za-z0-9]*):(.*)/;TP.regex.CHROMEEXT_SCHEME=/^chrome-extension:\/\//;TP.regex.FILE_SCHEME=/^file:\/\//;TP.regex.HTTP_SCHEME=/^http[s]?:\/\//;TP.regex.JS_SCHEME=/^javascript:/;TP.regex.MAIL_SCHEME=/^mailto:\/\//;TP.regex.TIBET_SCHEME=/^tibet:/;TP.regex.URI_LIKELY=/^~|^\/|^\.\/|^\.\.\/|^urn:|^tibet:|^javascript:|^(?:\w+):(?:.*)\//;TP.regex.URI_FRAGMENT=/#/;TP.regex.URI_STRICT=/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/;TP.regex.URI_LOOSE=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;TP.regex.URI_QUERY=/[&;]?([^&;=]*)=?([^&;]*)/g;TP.regex.BAD_WINDOW_ID=/[:\/]/;TP.regex.WINDOW_PREFIX=/^window_[0-9]/;TP.regex.SCREEN_PREFIX=/^screen_[0-9]/;TP.regex.URI_REWRITE=/rewriteURI/;TP.regex.URI_DELEGATE=/delegateURI/;TP.regex.URI_NEXTCAT=/nextCatalog/;TP.regex.XML_PREFIX=/<\?xml (.*)\?>/;TP.regex.MOZ_XPATH_ERROR=/regard to namespaces/;TP.regex.NS_EXTRACTION=/.*?xmlns([:\w]*?)=\"(.*?)\"/g;TP.regex.NS_PREFIXES=/<(\w+)*:/g;TP.regex.NS_QUALIFIED=/(.*):(.*)/;TP.regex.XML_XMLNS_STRIP=/xmlns:xml=(['"])http:\/\/www.w3.org\/XML\/1998\/namespace(\1)/g;TP.regex.XMLNS_STRIP=/\s+xmlns([:\w]*?)=['"](.*?)['"]/g;TP.regex.XMLNS_ATTR=/xmlns[:=]/;TP.TIBET_PATH_TYPE=0;TP.CSS_PATH_TYPE=1;TP.XPATH_PATH_TYPE=2;TP.XPOINTER_PATH_TYPE=3;TP.XTENSION_POINTER_PATH_TYPE=4;TP.BARENAME_PATH_TYPE=5;TP.CHANGE_PATHS='paths';TP.regex.ANY_POINTER=/\w+\((.+)\)/;TP.regex.PATH_EXPR=/(^|\s+)(.+?)($|\s+)/g;TP.regex.NON_SIMPLE_PATH=/[|@#:\/&=><\\.\\[\\(]/;TP.regex.TIBET_POINTER=/tibet\((.+)\)/;TP.regex.TIBET_PATH=/^(\$|_)?\w+[\.]{1}\w+|\[\w+(,\w+)+\]|\[-?\d*:-?\d*(:-?\d*)?\]/;TP.regex.TIBET_PATH_CHAR=/[\.:,]+/;TP.regex.TIBET_PATH_TEMPLATE=/(^|\s+)(\w[\w\.:,]*)(\s+|$)/g;TP.regex.XTENSION_POINTER=/css\((.+)\)/;TP.regex.CSS_POINTER=/css\((.+)\)/;TP.regex.ATTRIBUTE=/^@\w+$/;TP.regex.ATTRIBUTE_ALL=/^@\*/;TP.regex.BARENAME=/^#[^(]+$/;TP.regex.DOCUMENT_ID=/#document$/;TP.regex.ELEMENT_ID=/(.*)#(.*)/;TP.regex.BOOLEAN_ID=/^true$|^false$/;TP.regex.ID_FUNCTION=/id\((.+)\)/;TP.regex.ID_HAS_NS=/:/g;TP.regex.IDREFS=/(.*) (.*)/;TP.regex.ID_POINTER=/(xpointer|xpath1)\(id\(["'](.+)["']\)\)/;TP.regex.XPOINTER=/(xpointer|xpath1|element)\((.+)\)/;TP.regex.ELEMENT_PATH=/[#@\/\\.\\[\\(]/;TP.regex.ELEMENT_POINTER=/element\((.+)\)/;TP.regex.XPATH_HAS_ID=/id\((.+)\)/;TP.regex.XPATH_PATH=/^(\/|@|\.[\/\.]|[^\\.]\((.*)\))|(ancestor|ancestor-or-self|attribute|child|descendant|descendant-or-self|following|following-sibling|namespace|parent|preceding|preceding-sibling|self)::/;TP.regex.XPATH_POINTER=/(xpointer|xpath1)\((.+)\)/;TP.regex.XPATH_DEFAULTNS=new RegExp('\\$def:(('+TP.XML_NAMECHAR+')+)','g');TP[TP.TNAME]='Object';TP.sys[TP.TNAME]='Object';TP.sys.$$realBrowser=null;TP.sys.$LICENSE=TP.NULL_OID;window.$$TIBET=true;
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETVersion.js';
(function(){var a=TP.sys.release;a({'describe':'3.0.0-116-g52240583fc-dirty','major':'5','minor':'0','patch':'0','suffix':'dev','ptag':'3.0.0','commits':'116','phash':'52240583fc','time':'1405184580500','semver':'v5.0.0-dev.116+g52240583fc.1405184580500'});}());
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETPrimitivesPre.js';
Array[TP.ID]='Array';Boolean[TP.ID]='Boolean';Date[TP.ID]='Date';Function[TP.ID]='Function';Number[TP.ID]='Number';Object[TP.ID]='Object';RegExp[TP.ID]='RegExp';String[TP.ID]='String';Window[TP.ID]='Window';TP.ArrayProto[TP.ID]='ArrayProto';TP.BooleanProto[TP.ID]='BooleanProto';TP.DateProto[TP.ID]='DateProto';TP.FunctionProto[TP.ID]='FunctionProto';TP.NumberProto[TP.ID]='NumberProto';TP.RegExpProto[TP.ID]='RegExpProto';TP.StringProto[TP.ID]='StringProto';Window.prototype[TP.ID]='WindowProto';TP[TP.ID]='TP';TP.sys[TP.ID]='TP.sys';TP.boot[TP.ID]='TP.boot';TP.global[TP.ID]='Self';APP[TP.ID]='APP';TP.ArrayProto[TP.NAME]='ArrayProto';TP.BooleanProto[TP.NAME]='BooleanProto';TP.DateProto[TP.NAME]='DateProto';TP.FunctionProto[TP.NAME]='FunctionProto';TP.NumberProto[TP.NAME]='NumberProto';TP.RegExpProto[TP.NAME]='RegExpProto';TP.StringProto[TP.NAME]='StringProto';Window.prototype[TP.NAME]='WindowProto';TP[TP.NAME]='TP';TP.sys[TP.NAME]='TP.sys';TP.boot[TP.NAME]='TP.boot';TP.global[TP.NAME]='Self';APP[TP.NAME]='APP';TP.getID=function(){return TP[TP.ID];};TP.sys.getID=function(){return TP.sys[TP.ID];};TP.boot.getID=function(){return TP.boot[TP.ID];};APP.getID=function(){return APP[TP.ID];};TP.getName=function(){return TP[TP.NAME];};TP.sys.getName=function(){return TP.sys[TP.NAME];};TP.boot.getName=function(){return TP.boot[TP.NAME];};APP.getName=function(){return APP[TP.NAME];};TP.isCallable=function(a){return a&&a.apply&&a.$$dnu!==true;};TP.isCallable[TP.NAME]='isCallable';TP.isCallable[TP.OWNER]=TP;TP.isCallable[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.isCallable[TP.DISPLAY]='TP.isCallable';TP.isCallable[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.canInvoke=function(c,b){var a,d,e;if(c===undefined||c===null||b===undefined||b===null){return false;}if(b.charAt!==undefined){a=c[b];return a!==undefined&&a.apply&&a.$$dnu!==true;}else if(TP.isArray(b)){e=b.length;for(d=0;d<e;d++){a=c[b[d]];if(!a||!a.apply||a.$$dnu===true){return false;}}return true;}return false;};TP.canInvoke[TP.NAME]='canInvoke';TP.canInvoke[TP.OWNER]=TP;TP.canInvoke[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.canInvoke[TP.DISPLAY]='TP.canInvoke';TP.canInvoke[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.isValid=function(a){return a!==undefined&&a!==null;};TP.isValid[TP.NAME]='isValid';TP.isValid[TP.OWNER]=TP;TP.isValid[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.isValid[TP.DISPLAY]='TP.isValid';TP.isValid[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.notValid=function(a){return a===undefined||a===null;};TP.notValid[TP.NAME]='notValid';TP.notValid[TP.OWNER]=TP;TP.notValid[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.notValid[TP.DISPLAY]='TP.notValid';TP.notValid[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.ifInvalid=function(a,b){return TP.notValid(a)?b:a;};TP.ifInvalid[TP.NAME]='ifInvalid';TP.ifInvalid[TP.OWNER]=TP;TP.ifInvalid[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.ifInvalid[TP.DISPLAY]='TP.ifInvalid';TP.ifInvalid[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.isDNU=function(a){return TP.isFunction(a)&&a.$$dnu===true;};TP.isDNU[TP.NAME]='isDNU';TP.isDNU[TP.OWNER]=TP;TP.isDNU[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.isDNU[TP.DISPLAY]='TP.isDNU';TP.isDNU[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.$$isDNU=TP.isDNU;TP.isFunction=function(a){return TP.ObjectProto.toString.call(a)==='[object Function]';};TP.isFunction[TP.NAME]='isFunction';TP.isFunction[TP.OWNER]=TP;TP.isFunction[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.isFunction[TP.DISPLAY]='TP.isFunction';TP.isFunction[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.isString=function(a){return TP.ObjectProto.toString.call(a)==='[object String]';};TP.isString[TP.NAME]='isString';TP.isString[TP.OWNER]=TP;TP.isString[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.isString[TP.DISPLAY]='TP.isString';TP.isString[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.owns=function(a,b){if(a===null||a===undefined){return false;}if(TP.canInvoke(a,'hasOwnProperty')){try{return a.hasOwnProperty(b)&&!TP.isDNU(a[b]);}catch(a){}}else{try{return TP.FunctionProto.hasOwnProperty.call(a,b);}catch(a){}}try{return a[b]!==a.constructor.prototype[b];}catch(a){return false;}};TP.owns[TP.NAME]='owns';TP.owns[TP.OWNER]=TP;TP.owns[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.owns[TP.DISPLAY]='TP.owns';TP.owns[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.objectGetLoadNode=function(a){var b;if(TP.notValid(a)){return;}try{b=a[TP.LOAD_NODE];}catch(a){return;}return b;};TP.objectGetLoadNode[TP.NAME]='objectGetLoadNode';TP.objectGetLoadNode[TP.OWNER]=TP;TP.objectGetLoadNode[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.objectGetLoadNode[TP.DISPLAY]='TP.objectGetLoadNode';TP.objectGetLoadNode[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.objectSetLoadNode=function(a,b){a[TP.LOAD_NODE]=b;return a;};TP.objectSetLoadNode[TP.NAME]='objectSetLoadNode';TP.objectSetLoadNode[TP.OWNER]=TP;TP.objectSetLoadNode[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.objectSetLoadNode[TP.DISPLAY]='TP.objectSetLoadNode';TP.objectSetLoadNode[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.FunctionProto.asMethod=function(a,b,c,e){var d;if(!e){if(c.indexOf(TP.LOCAL_TRACK)===TP.NOT_FOUND){try{d=a.getID()+'.'+c+'.'+b;}catch(d){console.log('Can\'t compute owner ID for: '+TP.str(a)+' for method named: '+b+' on track: '+c+' stack: '+d.stack);}}else{d=a.getID()+'.'+b;}}else{d=e;}this[TP.NAME]=b;this[TP.OWNER]=a;this[TP.TRACK]=c;this[TP.DISPLAY]=d;TP.objectSetLoadNode(this,TP.boot[TP.LOAD_NODE]);return this;};TP.FunctionProto.asMethod[TP.NAME]='asMethod';TP.FunctionProto.asMethod[TP.OWNER]=Function;TP.FunctionProto.asMethod[TP.TRACK]=TP.INST_TRACK;TP.FunctionProto.asMethod[TP.DISPLAY]='Function.Inst.asMethod';TP.FunctionProto.asMethod[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.StringProto.strip=function(a){return this.replace(a,'');};TP.StringProto.strip[TP.NAME]='strip';TP.StringProto.strip[TP.OWNER]=String;TP.StringProto.strip[TP.TRACK]=TP.INST_TRACK;TP.StringProto.strip[TP.DISPLAY]='String.Inst.strip';TP.StringProto.strip[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];if(!TP.sys.constructOID){TP.sys.constructOID=function(a){return(!!a?a+TP.OID_PREFIX:TP.OID_PREFIX)+Math.random().toString(32).replace('0.',Date.now().toString(32));};}TP.sys.constructOID[TP.NAME]='constructOID';TP.sys.constructOID[TP.OWNER]=TP.sys;TP.sys.constructOID[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.sys.constructOID[TP.DISPLAY]='TP.sys.constructOID';TP.sys.constructOID[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.genID=TP.sys.constructOID;Function.$$getNameRegex=/function\s*(.*?)\(/;TP.getFunctionName=function(b){var a;a=Function.$$getNameRegex.exec(b.toString());if(TP.notValid(a)||a[1]===''){return TP.ANONYMOUS_FUNCTION_NAME;}else{return a[1].strip(/\s/g);}};TP.getFunctionName[TP.NAME]='getFunctionName';TP.getFunctionName[TP.OWNER]=TP;TP.getFunctionName[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.getFunctionName[TP.DISPLAY]='TP.getFunctionName';TP.getFunctionName[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.FunctionProto.$getName=function(){var a;if(TP.owns(this,TP.NAME)){return this[TP.NAME];}a=TP.getFunctionName(this.toString());if(a===TP.ANONYMOUS_FUNCTION_NAME){a=this.getID('Function');}this[TP.NAME]=a;return a;};TP.FunctionProto.$getName[TP.NAME]='$getName';TP.FunctionProto.$getName[TP.OWNER]=Function;TP.FunctionProto.$getName[TP.TRACK]=TP.INST_TRACK;TP.FunctionProto.$getName[TP.DISPLAY]='Function.Inst.$getName';TP.FunctionProto.$getName[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.FunctionProto.getName=TP.FunctionProto.$getName;TP.StringProto.getName=TP.FunctionProto.$getName;TP.ArrayProto.at=function(a,b){return this[a];};TP.ArrayProto.atPut=function(a,b,c){this[a]=b;return this;};TP.PHash=function(){var a,b,c;this.$$hash=new Object();this[TP.ID]=TP.sys.constructOID();this.$suspended=true;if(arguments.length===1){b=arguments[0];for(a in b){if(TP.regex.INTERNAL_SLOT.test(a)&&TP.owns(b,a)){this.$$hash[a]=b[a];}}}else{c=arguments.length;for(a=0;a<c;a=a+2){this.$$hash[arguments[a]]=arguments[a+1];}}this.$$isCollection=function(){return true;};this.$$isCollection[TP.NAME]='$$isCollection';this.$$isCollection[TP.OWNER]=TP.PHash;this.$$isCollection[TP.TRACK]=TP.INST_TRACK;this.$$isCollection[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.$$isCollection';this.$$isMemberOf=function(a){return a==='TP.lang.Hash'||a===TP.lang.Hash;};this.$$isMemberOf[TP.NAME]='$$isMemberOf';this.$$isMemberOf[TP.OWNER]=TP.PHash;this.$$isMemberOf[TP.TRACK]=TP.INST_TRACK;this.$$isMemberOf[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.$$isMemberOf';this.as=function(a){if(a==='TP.lang.Hash'||a===TP.lang.Hash){return this.asTP_lang_Hash();}return this.asTP_lang_Hash().as(a);};this.as[TP.NAME]='as';this.as[TP.OWNER]=TP.PHash;this.as[TP.TRACK]=TP.INST_TRACK;this.as[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.as';this.asString=function(){var c,d,a,b;b=TP.ac();b.push('TP.hc(');c=Object.keys(this.$$hash);d=c.length;for(a=0;a<d;a++){b.push(TP.src(c[a]),', ',TP.src(this.$$hash[c[a]]));if(a+1<d){b.push(', ');}}b.push(')');return b.join('');};this.asString[TP.NAME]='asString';this.asString[TP.OWNER]=TP.PHash;this.asString[TP.TRACK]=TP.INST_TRACK;this.asString[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.asString';this.asJSONSource=function(){return this.asTP_lang_Hash().asJSONSource();};this.asJSONSource[TP.NAME]='asJSONSource';this.asJSONSource[TP.OWNER]=TP.PHash;this.asJSONSource[TP.TRACK]=TP.INST_TRACK;this.asJSONSource[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.asJSONSource';this.asSource=function(){return this.asTP_lang_Hash().asSource();};this.asSource[TP.NAME]='asSource';this.asSource[TP.OWNER]=TP.PHash;this.asSource[TP.TRACK]=TP.INST_TRACK;this.asSource[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.asSource';this.asTP_lang_Hash=function(){var a;a=TP.lang.Hash.construct();a.$set('$$hash',this.$$hash);return a;};this.asTP_lang_Hash[TP.NAME]='asTP_lang_Hash';this.asTP_lang_Hash[TP.OWNER]=TP.PHash;this.asTP_lang_Hash[TP.TRACK]=TP.INST_TRACK;this.asTP_lang_Hash[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.asTP_lang_Hash';this.at=function(a){if(TP.owns(this.$$hash,a)){return this.$$hash[a];}return;};this.at[TP.NAME]='at';this.at[TP.OWNER]=TP.PHash;this.at[TP.TRACK]=TP.INST_TRACK;this.at[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.at';this.atPut=function(a,b){this.$$hash[a]=b;return this;};this.atPut[TP.NAME]='atPut';this.atPut[TP.OWNER]=TP.PHash;this.atPut[TP.TRACK]=TP.INST_TRACK;this.atPut[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.atPut';this.$get=function(a){return this[a];};this.$get[TP.NAME]='$get';this.$get[TP.OWNER]=TP.PHash;this.$get[TP.TRACK]=TP.INST_TRACK;this.$get[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.$get';this.get=function(c){var a,d,b;d='get'+c.asStartUpper();if(TP.canInvoke(this,d)){return this[d]();}a=c;if(TP.regex.HAS_PERIOD.test(a)){a=a.slice(0,a.indexOf('.'));if(TP.notValid(b=this.get(a))){return b;}if(TP.canInvoke(b,'get')){a=a.slice(a.indexOf('.')+1);return b.get(a);}return;}if(TP.isDefined(b=this.at(c))){return b;}return this.$get(c);};this.get[TP.NAME]='get';this.get[TP.OWNER]=TP.PHash;this.get[TP.TRACK]=TP.INST_TRACK;this.get[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.get';this.getName=function(){return this[TP.NAME];};this.getName[TP.NAME]='getName';this.getName[TP.OWNER]=TP.PHash;this.getName[TP.TRACK]=TP.INST_TRACK;this.getName[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.getName';this.getItems=function(){var c,b,d,a;c=TP.ac();b=Object.keys(this.$$hash);d=b.length;for(a=0;a<d;a++){c.push(b[a],this.$$hash[b[a]]);}return c;};this.getItems[TP.NAME]='getItems';this.getItems[TP.OWNER]=TP.PHash;this.getItems[TP.TRACK]=TP.INST_TRACK;this.getItems[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.getItems';this.getKeys=function(){return Object.keys(this.$$hash);};this.getKeys[TP.NAME]='getKeys';this.getKeys[TP.OWNER]=TP.PHash;this.getKeys[TP.TRACK]=TP.INST_TRACK;this.getKeys[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.getKeys';this.getParameters=function(){return this;};this.getParameters[TP.NAME]='getParameters';this.getParameters[TP.OWNER]=TP.PHash;this.getParameters[TP.TRACK]=TP.INST_TRACK;this.getParameters[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.getParameters';this.getSize=function(){return Object.keys(this.$$hash).length;};this.getSize[TP.NAME]='getSize';this.getSize[TP.OWNER]=TP.PHash;this.getSize[TP.TRACK]=TP.INST_TRACK;this.getSize[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.getSize';this.getTypeName=function(){return'TP.PHash';};this.getTypeName[TP.NAME]='getTypeName';this.getTypeName[TP.OWNER]=TP.PHash;this.getTypeName[TP.TRACK]=TP.INST_TRACK;this.getTypeName[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.getTypeName';this.getValues=function(){var b,c,d,a;b=TP.ac();c=Object.keys(this.$$hash);d=c.length;for(a=0;a<d;a++){b.push(this.$$hash[c[a]]);}return b;};this.getValues[TP.NAME]='getValues';this.getValues[TP.OWNER]=TP.PHash;this.getValues[TP.TRACK]=TP.INST_TRACK;this.getValues[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.getValues';this.hasKey=function(a){return TP.owns(Object.keys(this.$$hash),a);};this.hasKey[TP.NAME]='hasKey';this.hasKey[TP.OWNER]=TP.PHash;this.hasKey[TP.TRACK]=TP.INST_TRACK;this.hasKey[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.hasKey';this.perform=function(d){var a,b,e,c;c=TP.ac();b=Object.keys(this.$$hash);e=b.length;for(a=0;a<e;a++){d.$first=a===0?true:false;d.$last=a===e-1?true:false;c[0]=b[a];c[1]=this.$$hash[b[a]];if(d(c,a)===TP.BREAK){break;}}return this;};this.perform[TP.NAME]='perform';this.perform[TP.OWNER]=TP.PHash;this.perform[TP.TRACK]=TP.INST_TRACK;this.perform[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.perform';this.removeKey=function(a){if(this.$$hash[a]===undefined){return;}if(!TP.owns(this.$$hash,a)){return;}delete this.$$hash[a];return this;};this.removeKey[TP.NAME]='removeKey';this.removeKey[TP.OWNER]=TP.PHash;this.removeKey[TP.TRACK]=TP.INST_TRACK;this.removeKey[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.removeKey';this.$set=function(a,b){var d,c;if(TP.isDefined(d=this[a])){c=a;}else{TP.ifWarn()?TP.warn(TP.join(TP.sc('Setting undeclared attribute: '),TP.name(this),'.',a,' (',TP.tname(this),')',TP.tname(this)==='Window'?TP.sc(' -- Possible unbound function'):''),TP.LOG,arguments):0;}try{this[c]=b;}catch(c){return this.raise('TP.sig.InvalidOperation',arguments,TP.ec(c,TP.join('Unable to set ',b,' for key: ',a)));}return this;};this.$set[TP.NAME]='$set';this.$set[TP.OWNER]=TP.PHash;this.$set[TP.TRACK]=TP.INST_TRACK;this.$set[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.$set';this.set=function(a,b){return this.$set(a,b);};this.set[TP.NAME]='set';this.set[TP.OWNER]=TP.PHash;this.set[TP.TRACK]=TP.INST_TRACK;this.set[TP.DISPLAY]='TP.PHash.'+TP.INST_TRACK+'.set';return this;};TP.PHash.prototype.$$prototype=TP.PHash.prototype;TP.hc=function(){var b,c,a;b=new TP.PHash();c=arguments.length;for(a=0;a<c;a=a+2){if(TP.notValid(arguments[a])){return this.raise('TP.sig.InvalidKey',arguments);}b.atPut(arguments[a],arguments[a+1]);}return b;};TP.phc=TP.hc;TP.CONSTANT_DESCRIPTOR={'writable':false,'configurable':false};TP.DEFAULT_DESCRIPTOR={};TP.HIDDEN_DESCRIPTOR={'enumerable':false,'configurable':false};TP.HIDDEN_CONSTANT_DESCRIPTOR={'enumerable':false,'writable':false,'configurable':false};(function(){TP.sys.$$meta_types=TP.hc();TP.sys.$$meta_attributes=TP.hc();TP.sys.$$meta_methods=TP.hc();TP.sys.$$meta_owners=TP.hc();TP.sys.$$metadata=TP.hc('types',TP.sys.$$meta_types,'attributes',TP.sys.$$meta_attributes,'methods',TP.sys.$$meta_methods,'owners',TP.sys.$$meta_owners);}());TP.objectGetMetadataName=function(a){if(TP.notValid(a)){return;}if(TP.isType(a)){return a.getName();}if(TP.isMethod(a)){return a[TP.OWNER].getName()+'_'+a[TP.TRACK]+'_'+a.getName();}return;};TP.objectGetMetadataName[TP.NAME]='objectGetMetadataName';TP.objectGetMetadataName[TP.OWNER]=TP.sys;TP.objectGetMetadataName[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.objectGetMetadataName[TP.DISPLAY]='TP.objectGetMetadataName';TP.objectGetMetadataName[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.sys.addMetadata=function(i,a,l,j){var c,f,b,e,g,d,k,h;if(a.getName&&!TP.isString(c=a.getName())){return;}if(TP.notValid(c=a[TP.NAME])){return;}if(f=TP.boot[TP.LOAD_NODE]){b=f.src||f.source||'';b=TP.boot.$uriInTIBETFormat(b);}else{b=TP.NO_LOAD_PATH;}e=TP.boot[TP.SRC_PATH]||b;switch(l){case TP.SUBTYPE:a[TP.LOAD_NODE]=f;a[TP.LOAD_PATH]=b;a[TP.SRC_PATH]=e;if(TP.notValid(TP.sys.$$meta_types.at(c))){k=a.getSupertypeName();TP.sys.$$meta_types.atPut(c,{'typeObj':a,'sname':k,'lpath':b,'spath':e});}break;case TP.METHOD:a[TP.LOAD_NODE]=f;a[TP.LOAD_PATH]=b;a[TP.SRC_PATH]=e;g=i.getName();d=g+'_'+j+'_'+c;if(TP.notValid(TP.sys.$$meta_methods.at(d))){TP.sys.$$meta_methods.atPut(d,{'methodObj':a,'lpath':b,'spath':e});h=TP.sys.$$meta_owners.at(c);if(!Array.isArray(h)){h=[];TP.sys.$$meta_owners.atPut(c,h);}h.push(g);}break;case TP.ATTRIBUTE:g=i.getName();d=g+'_'+j+'_'+c;if(TP.notValid(TP.sys.$$meta_attributes.at(d))){TP.sys.$$meta_attributes.atPut(d,{'descriptorObj':a,'lpath':b,'spath':e});}break;default:break;}return;};TP.sys.addMetadata[TP.NAME]='addMetadata';TP.sys.addMetadata[TP.OWNER]=TP.sys;TP.sys.addMetadata[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.sys.addMetadata[TP.DISPLAY]='TP.sys.addMetadata';TP.sys.addMetadata[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.defineSlot=function(a,b,c,h,i,d){var e,f,g;if(TP.isValid(d)){e=d.writable===false;f=d.enumerable===false;g=d.configurable===false;if(e&&c!==undefined){Object.defineProperty(a,b,{writable:!e,enumerable:!f,configurable:!g,value:c});}else{Object.defineProperty(a,b,{writable:!e,enumerable:!f,configurable:!g});if(c!==undefined){a[b]=c;}else if(a[b]===undefined){a[b]=null;}}}else{if(c!==undefined){a[b]=c;}else if(a[b]===undefined){a[b]=null;}}return a[b];};TP.defineSlot[TP.NAME]='defineSlot';TP.defineSlot[TP.OWNER]=TP;TP.defineSlot[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.defineSlot[TP.DISPLAY]='TP.defineSlot';TP.defineSlot[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.defineMethod=function(h,d,b,k,g,f,j){var e,c,a,i;if(!TP.isCallable(b)||!TP.isCallable(b.asMethod)){TP.ifError()?TP.error('Invalid method body for '+'TP.defineMethod: '+d,TP.LOG,arguments):0;return;}e=TP.ifInvalid(j,h);c=TP.ifInvalid(k,TP.LOCAL_TRACK);b.asMethod(e,d,c,f);if(TP.NEEDS_CALLEE.test(b.toString())&&!b.noCalleePatch||b.wantsCalleePatch===true){a=function(){var a,c,d;a=TP.$$currentCallee$$;c=TP.$$currentArgs$$;TP.$$currentCallee$$=b;TP.$$currentArgs$$=arguments;d=b.apply(this,arguments);TP.$$currentCallee$$=a;TP.$$currentArgs$$=c;return d;};a.$realFunc=b;a.asMethod(e,d+'$$calleePatch',c,f);if(TP.notEmpty(f)){i=a[TP.DISPLAY];a[TP.DISPLAY]=i+'$$calleePatch';}TP.defineSlot(h,d+'$$calleePatch',a,TP.METHOD,c,TP.HIDDEN_DESCRIPTOR);}else{a=b;}TP.defineSlot(h,d,a,TP.METHOD,c,g&&g.$$isPDC?g:TP.DEFAULT_DESCRIPTOR);if(a[TP.OWNER]===self){if(TP.notValid(TP.objectGetLoadNode(a))){TP.objectSetLoadNode(a,TP.boot[TP.LOAD_NODE]);}return a;}TP.sys.addMetadata(e,b,TP.METHOD,c);return a;};TP.defineMethod[TP.NAME]='defineMethod';TP.defineMethod[TP.OWNER]=TP;TP.defineMethod[TP.TRACK]=TP.PRIMITIVE_TRACK;TP.defineMethod[TP.DISPLAY]='TP.defineMethod';TP.defineMethod[TP.LOAD_NODE]=TP.boot[TP.LOAD_NODE];TP.sys.addMetadata(TP,TP.constructOrphanObject,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP,TP.defineNamespace,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP,TP.isNamespace,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP.sys,TP.sys.getGlobals,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP.sys,TP.sys.release,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP,TP.isCallable,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP,TP.canInvoke,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP,TP.isValid,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP,TP.notValid,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP,TP.ifInvalid,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP,TP.isDNU,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP,TP.isFunction,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP,TP.isString,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP,TP.owns,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP,TP.objectGetLoadNode,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP,TP.objectSetLoadNode,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(Function,TP.FunctionProto.asMethod,TP.METHOD,TP.INST_TRACK);TP.sys.addMetadata(String,TP.StringProto.strip,TP.METHOD,TP.INST_TRACK);TP.sys.addMetadata(TP.sys,TP.sys.constructOID,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP,TP.getFunctionName,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(Function,TP.FunctionProto.$getName,TP.METHOD,TP.INST_TRACK);TP.sys.addMetadata(TP,TP.objectGetMetadataName,TP.METHOD,TP.PRIMITIVE_TRACK);TP.sys.addMetadata(TP.sys,TP.sys.addMetadata,TP.METHOD,TP.PRIMITIVE_TRACK);TP.defineMethod(TP,'definePrimitive',function(e,b,f,g,h){var a,d,c;if(!b){TP.ifError()?TP.error('Invalid method body or conditionals for '+'TP.definePrimitive: '+e,TP.LOG,arguments):0;return;}if(!TP.isCallable(b)){a=b.at('test');if(TP.isCallable(a)){d=''+a();}else{if(typeof a==='string'&&TP.sys.hasFeatureTest(a)){d=TP.sys.hasFeature(a);}else{d=(''+a).toLowerCase();}}c=b.at(d);if(typeof c==='undefined'){c=b.at(TP.DEFAULT);}}else{c=b;}return TP.defineMethod(TP,e,c,TP.PRIMITIVE_TRACK,f,g,h);},TP.PRIMITIVE_TRACK,null,'TP.definePrimitive');TP.definePrimitive('isDefined',function(a){return a!==undefined;},false,'TP.isDefined');TP.definePrimitive('isNaN',function(a){try{if(TP.isValid(a)&&isNaN(a)&&a.constructor===Number){return true;}}catch(a){}return false;},false,'TP.isNaN');TP.definePrimitive('isNull',function(a){return a===null;},false,'TP.isNull');TP.definePrimitive('notDefined',function(a){return a===undefined;},false,'TP.notDefined');TP.definePrimitive('notNaN',function(a){return!TP.isNaN(a);},false,'TP.notNaN');TP.definePrimitive('notNull',function(a){return a!==null;},false,'TP.notNull');TP.defineMethod(TP.sys,'getLogLevel',function(){return parseInt(TP.sys.cfg('log.level'),10);},TP.PRIMITIVE_TRACK,null,'TP.sys.getLogLevel');TP.definePrimitive('ifNull',function(a,b){return a===null?b:a;},false,'TP.ifNull');TP.definePrimitive('ifUndefined',function(a,b){return a===undefined?b:a;},false,'TP.ifUndefined');TP.definePrimitive('ifLogLevel',function(b,c){var a=TP.ifInvalid(c,TP.ERROR);if(b===undefined){return TP.sys.getLogLevel()<=a;}return b&&TP.sys.getLogLevel()<=a;},false,'TP.ifLogLevel');TP.definePrimitive('ifError',function(a){return TP.ifLogLevel(a,TP.ERROR);},false,'TP.ifError');TP.definePrimitive('ifFatal',function(a){return TP.ifLogLevel(a,TP.FATAL);},false,'TP.ifFatal');TP.definePrimitive('ifInfo',function(a){return TP.ifLogLevel(a,TP.INFO);},false,'TP.ifInfo');TP.definePrimitive('ifSevere',function(a){return TP.ifLogLevel(a,TP.SEVERE);},false,'TP.ifSevere');TP.definePrimitive('ifSystem',function(a){return TP.ifLogLevel(a,TP.SYSTEM);},false,'TP.ifSystem');TP.definePrimitive('ifTrace',function(a){return TP.ifLogLevel(a,TP.TRACE);},false,'TP.ifTrace');TP.definePrimitive('ifWarn',function(a){return TP.ifLogLevel(a,TP.WARN);},false,'TP.ifWarn');TP.definePrimitive('isNode',function(a){return TP.isValid(a)&&typeof a.nodeType==='number';},false,'TP.ifNode');TP.definePrimitive('isNonFunctionConstructor',function(a){return TP.isValid(TP.getNonFunctionConstructorName(a));},false,'TP.isNonFunctionConstructor');TP.definePrimitive('getNonFunctionConstructorName',function(a){var b;if(TP.notValid(a)){return null;}if(b=a.$$nonFunctionConstructorObjectName){return b;}if(TP.boot.getBrowser()==='firefox'){if(a===self.Blob){return'Blob';}else if(a===self.CameraCapabilities){return'CameraCapabilities';}else if(a===self.CSSConditionRule){return'CSSConditionRule';}else if(a===self.CSSGroupingRule){return'CSSGroupingRule';}else if(a===self.CSSMediaRule){return'CSSMediaRule';}else if(a===self.CSSPageRule){return'CSSPageRule';}else if(a===self.CSSRule){return'CSSRule';}else if(a===self.CSSRuleList){return'CSSRuleList';}else if(a===self.CSSStyleRule){return'CSSStyleRule';}else if(a===self.CSSSupportsRule){return'CSSSupportsRule';}else if(a===self.DataTransfer){return'DataTransfer';}else if(a===self.DeviceAcceleration){return'DeviceAcceleration';}else if(a===self.DeviceRotationRate){return'DeviceRotationRate';}else if(a===self.DOMStringList){return'DOMStringList';}else if(a===self.File){return'File';}else if(a===self.Location){return'Location';}else if(a===self.MozMmsMessage){return'MozMmsMessage';}else if(a===self.MozMobileMessageManager){return'MozMobileMessageManager';}else if(a===self.MozMobileMessageThread){return'MozMobileMessageThread';}else if(a===self.MozSmsFilter){return'MozSmsFilter';}else if(a===self.MozSmsMessage){return'MozSmsMessage';}else if(a===self.MozSmsSegmentInfo){return'MozSmsSegmentInfo';}else if(a===self.StyleSheetList){return'StyleSheetList';}else if(a===self.SVGLength){return'SVGLength';}else if(a===self.SVGNumber){return'SVGNumber';}else if(a===self.Window){return'DOMWindow';}}if(TP.boot.getBrowser()==='chrome'){if(a===self.CSS){return'CSS';}else if(a===self.Intl){return'Intl';}else if(a===self.JSON){return'JSON';}else if(a===self.Math){return'Math';}}if(TP.boot.getBrowser()==='safari'){if(a===self.CSS){return'CSS';}else if(a===self.Intl){return'Intl';}else if(a===self.JSON){return'JSON';}else if(a===self.Math){return'Math';}else if(a===self.Window){return'DOMWindow';}}return null;},false,'TP.getNonFunctionConstructorName');TP.definePrimitive('isType',function(a){var b,c;if(TP.notValid(a)||TP.notValid(c=a[TP.TNAME])||c===''){return TP.isNonFunctionConstructor(a);}if(a===Function||TP.isValid(a[TP.TYPE])&&a[TP.TYPE]!==TP.FunctionProto[TP.TYPE]){return true;}if(c==='Function'){if(a[TP.OWNER]===TP.NONE||a[TP.TRACK]===TP.NONE){return false;}if(a[TP.OWNER]&&a[TP.TRACK]){return false;}b=a.$getName();return b.indexOf('Function'+TP.OID_PREFIX)!==0&&TP.regex.NATIVE_TYPENAME.test(b);}return false;},false,'TP.isType');TP.definePrimitive('isNativeType',function(a){if(TP.isNaN(a)){return false;}return(TP.isFunction(a)||TP.isNonFunctionConstructor(a))&&TP.isType(a)||a===Function;},false,'TP.isNativeType');TP.definePrimitive('isWindow',function(a){return TP.isValid(a)&&a.moveBy!==undefined;},false,'TP.isWindow');TP.ArrayProto.$$prototype=TP.ArrayProto;TP.BooleanProto.$$prototype=TP.BooleanProto;TP.DateProto.$$prototype=TP.DateProto;TP.FunctionProto.$$prototype=TP.FunctionProto;TP.NumberProto.$$prototype=TP.NumberProto;TP.RegExpProto.$$prototype=TP.RegExpProto;TP.StringProto.$$prototype=TP.StringProto;TP.definePrimitive('isPrototype',function(a){if(TP.isValid(a)&&TP.owns(a,'$$prototype')&&a.$$prototype===a){return true;}return a===TP.ObjectProto;},false,'TP.isPrototype');TP.definePrimitive('isMutable',function(a){if(TP.notValid(a)){return false;}if(typeof a.charAt==='function'&&a!==TP.StringProto||typeof a.toPrecision==='function'&&a!==TP.NumberProto||a===true||a===false){return false;}if(TP.isCallable(a.$$isMutable)){return a.$$isMutable();}return true;},false,'TP.isMutable');TP.definePrimitive('isReferenceType',function(a){var b;if(TP.notValid(a)){return false;}if(TP.isArray(a)){return true;}if(TP.isType(a)&&TP.isCallable(a.$$isReferenceType)){return a.$$isReferenceType();}if(TP.isType(b=TP.type(a))&&TP.isCallable(b.$$isReferenceType)){return b.$$isReferenceType();}return a.constructor===Object;},false,'TP.isReferenceType');TP.definePrimitive('genUUID',function(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var a=Math.random()*16|0,b=c==='x'?a:a&3|8;return b.toString(16);});},false,'TP.genUUID');if(TP.notValid(TP.sys.$statistics)){TP.sys.$statistics=new Object();}TP.definePrimitive('isMethod',function(a){if(TP.notValid(a)||TP.notValid(a[TP.OWNER])||TP.notValid(a[TP.TRACK])){return false;}if(a[TP.OWNER]===TP.NONE||a[TP.TRACK]===TP.NONE){return false;}return TP.isCallable(a)&&!TP.isType(a);},false,'TP.isMethod');TP.defineMethod(TP.sys,'shouldLogCodeChanges',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.code_changes',a,b);}return TP.sys.cfg('log.code_changes');},TP.PRIMITIVE_TRACK,null,'TP.sys.shouldLogCodeChanges');TP.defineMethod(TP.sys,'$$shouldConstructDNUs',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('tibet.$$construct_dnus',a,b);}return TP.sys.cfg('tibet.$$construct_dnus');},TP.PRIMITIVE_TRACK,null,'TP.sys.$$shouldConstructDNUs');TP.sys.$changes=TP.ifInvalid(TP.sys.$changes,new TP.boot.Log());TP.defineMethod(TP.sys,'getChangeLog',function(){return TP.sys.$changes;},TP.PRIMITIVE_TRACK,null,'TP.sys.getChangeLog');TP.defineMethod(TP.sys,'logCodeChange',function(a,c,b){if(!TP.sys.shouldLogCodeChanges()){return false;}TP.sys.$changes.log(a,TP.CHANGE_LOG,TP.SYSTEM,b||arguments);TP.sys.log(a,TP.CHANGE_LOG,c,b||arguments);TP.sys.$logChanged(TP.CHANGE_LOG);return true;},TP.PRIMITIVE_TRACK,null,'TP.sys.logCodeChange');TP.defineMethod(TP.sys,'$logAttributeChange',function(b,e,f,g,c,h){var a,d;if(!TP.sys.shouldLogCodeChanges()){return false;}a=TP.ac();if(TP.isType(b)){a.push(b.getTypeName());}else{if(TP.canInvoke(b,'getID')){d=b.getID();if(TP.global[d]===b){a.push(d);}else{if(TP.byOID(d)===b){a.push('TP.byOID(\'',d,'\')');}else{TP.ifWarn()?TP.warn('Unregistered object '+d+' can\'t log attribute changes.',TP.CHANGE_LOG,e||arguments):0;return false;}}}}if(f==='Type'){a.push('.Type.defineAttribute(\'',g,'\'');}else if(f==='Inst'){a.push('.Inst.defineAttribute(\'',g,'\'');}else if(f!=='Global'){a.push('.defineAttribute(\'',g,'\'');}else{if(TP.canInvoke(b,'getID')){d=b.getID();}else{d=TP.str(b);}TP.ifWarn()?TP.warn(d+' can\'t log global track attribute changes.',TP.CHANGE_LOG,e||arguments):0;return false;}if(TP.isValid(c)){a.push(', ');if(TP.canInvoke(c,'asSource')){a.push(c.asSource());}else if(TP.canInvoke(c,'asString')){a.push(c.asString());}else if(TP.canInvoke(c,'toString')){a.push(c.toString());}else if(TP.isString(c.nodeValue)){a.push(c.nodeValue);}else{a.push('');}}a.push(');');a=a.join('');TP.sys.$changes.log(a,TP.CHANGE_LOG,TP.TRACE,e||arguments);TP.sys.$logChanged('Change');return true;},TP.PRIMITIVE_TRACK,null,'TP.sys.$logAttributeChange');var NativeTypeStub=new Function();NativeTypeStub.prototype={};NativeTypeStub.prototype.get=function(a){return this.$$target.get(a);};NativeTypeStub.prototype.defineAttribute=function(a,b){return TP.defineAttribute(this.$$target,a,b,TP.TYPE_TRACK,this[TP.OWNER]);};NativeTypeStub.prototype.defineConstant=function(a,b){return TP.defineConstant(this.$$target,a,b,TP.TYPE_TRACK,this[TP.OWNER]);};NativeTypeStub.prototype.defineMethod=function(a,b,c){return TP.defineMethod(this.$$target,a,b,TP.TYPE_TRACK,c,null,this[TP.OWNER]);};NativeTypeStub.prototype.set=function(a,b,c){return this.$$target.set(a,b,c);};NativeTypeStub.prototype.getMethod=function(a,b){return TP.method(this.$$target,a,TP.ifEmpty(b,TP.TYPE_TRACK));};NativeTypeStub.prototype.getMethods=function(a){return TP.methods(this.$$target,TP.ifEmpty(a,TP.TYPE_TRACK));};NativeTypeStub.prototype.getMethodInfoFor=function(b){var a;if(!TP.isMethod(a=this.getMethod(b))){return null;}return TP.hc('owner',a[TP.OWNER],'name',b,'track',a[TP.TRACK],'display',a[TP.DISPLAY]);};NativeTypeStub.prototype.describe=function(a,b){return TP.test.Suite.addSuite(this.$$target,a,b);};NativeTypeStub.prototype.getTestFixture=function(a){return this.$$target;};NativeTypeStub.prototype.getTestSuites=function(a){return TP.test.Suite.getTargetSuites(this.$$target,a);};NativeTypeStub.prototype.runTestSuites=function(a){return TP.test.Suite.runTargetSuites(this.$$target,a);};Array.Type=new NativeTypeStub();Array.Type.$$target=Array;Array.Type[TP.OWNER]=Array;Boolean.Type=new NativeTypeStub();Boolean.Type.$$target=Boolean;Boolean.Type[TP.OWNER]=Boolean;Date.Type=new NativeTypeStub();Date.Type.$$target=Date;Date.Type[TP.OWNER]=Date;Function.Type=new NativeTypeStub();Function.Type.$$target=Function;Function.Type[TP.OWNER]=Function;Number.Type=new NativeTypeStub();Number.Type.$$target=Number;Number.Type[TP.OWNER]=Number;Object.Type=new NativeTypeStub();Object.Type.$$target=Object;Object.Type[TP.OWNER]=Object;RegExp.Type=new NativeTypeStub();RegExp.Type.$$target=RegExp;RegExp.Type[TP.OWNER]=RegExp;String.Type=new NativeTypeStub();String.Type.$$target=String;String.Type[TP.OWNER]=String;Window.Type=new NativeTypeStub();Window.Type.$$target=Window;Window.Type[TP.OWNER]=Window;var NativeInstStub=new Function();NativeInstStub.prototype={};NativeInstStub.prototype.get=function(a){return this.$$target.get(a);};NativeInstStub.prototype.defineAttribute=function(a,b){return TP.defineAttribute(this.$$target,a,b,TP.INST_TRACK,this[TP.OWNER]);};NativeInstStub.prototype.defineConstant=function(a,b){return TP.defineConstant(this.$$target,a,b,TP.INST_TRACK,this[TP.OWNER]);};NativeInstStub.prototype.defineMethod=function(a,b,c){return TP.defineMethod(this.$$target,a,b,TP.INST_TRACK,c,null,this[TP.OWNER]);};NativeInstStub.prototype.set=function(a,b,c){return this.$$target.set(a,b,c);};NativeInstStub.prototype.getMethod=function(a,b){return TP.method(this.$$target,a,TP.ifEmpty(b,TP.INST_TRACK));};NativeInstStub.prototype.getMethods=function(a){return TP.methods(this.$$target,TP.ifEmpty(a,TP.INST_TRACK));};NativeInstStub.prototype.getMethodInfoFor=function(b){var a;if(!TP.isMethod(a=this.getMethod(b))){return null;}return TP.hc('owner',a[TP.OWNER],'name',b,'track',a[TP.TRACK],'display',a[TP.DISPLAY]);};NativeInstStub.prototype.describe=function(a,b){return TP.test.Suite.addSuite(this.$$target,a,b);};NativeInstStub.prototype.getTestFixture=function(a){return this.$$target;};NativeInstStub.prototype.getTestSuites=function(a){return TP.test.Suite.getTargetSuites(this.$$target,a);};NativeInstStub.prototype.runTestSuites=function(a){return TP.test.Suite.runTargetSuites(this.$$target,a);};Array.Inst=new NativeInstStub();Array.Inst.$$target=TP.ArrayProto;Array.Inst[TP.OWNER]=Array;Boolean.Inst=new NativeInstStub();Boolean.Inst.$$target=TP.BooleanProto;Boolean.Inst[TP.OWNER]=Boolean;Date.Inst=new NativeInstStub();Date.Inst.$$target=TP.DateProto;Date.Inst[TP.OWNER]=Date;Function.Inst=new NativeInstStub();Function.Inst.$$target=TP.FunctionProto;Function.Inst[TP.OWNER]=Function;Number.Inst=new NativeInstStub();Number.Inst.$$target=TP.NumberProto;Number.Inst[TP.OWNER]=Number;RegExp.Inst=new NativeInstStub();RegExp.Inst.$$target=TP.RegExpProto;RegExp.Inst[TP.OWNER]=RegExp;String.Inst=new NativeInstStub();String.Inst.$$target=TP.StringProto;String.Inst[TP.OWNER]=String;Window.Inst=new NativeInstStub();Window.Inst.$$target=Window.prototype;Window.Inst[TP.OWNER]=Window;TP.defineMethod(TP.FunctionProto,'$constructPrototype',function(){var b,a;b=this.$getName();a=new this();a[TP.ID]=b.strip(/\$\$/)+TP.PROTOTYPE;a.$$prototype=a;return a;},TP.INST_TRACK,null,'Function.Inst.$constructPrototype',Function);TP.defineNamespace('lang','TP');TP.defineNamespace('meta','TP');TP.lang.RootObject$$Type=new Function();TP.lang.RootObject$$Inst=new Function();TP.lang.RootObject$$Type.prototype=Object.$constructPrototype();TP.lang.RootObject$$Inst.prototype=Object.$constructPrototype();TP.lang.RootObject$$Type[TP.NAME]='TP.lang.RootObject$$Type';TP.lang.RootObject$$Inst[TP.NAME]='TP.lang.RootObject$$Inst';TP.lang.RootObject=new TP.lang.RootObject$$Type();TP.lang.RootObject$$Type[TP.OWNER]=TP.lang.RootObject;TP.lang.RootObject$$Inst[TP.OWNER]=TP.lang.RootObject;TP.lang.RootObject$$Type.prototype[TP.ID]='TypePrototype';TP.lang.RootObject$$Inst.prototype[TP.ID]='InstPrototype';TP.lang.RootObject$$Inst.prototype[TP.TYPE]=TP.lang.RootObject;TP.lang.RootObject[TP.TYPE]=TP.lang.RootObject;TP.lang.RootObject[TP.TYPEC]=TP.lang.RootObject$$Type;TP.lang.RootObject[TP.INSTC]=TP.lang.RootObject$$Inst;TP.lang.RootObject[TP.TNAME]='TP.lang.RootObject';TP.lang.RootObject[TP.RNAME]='TP.lang.RootObject';TP.lang.RootObject[TP.SUPER]=Object;TP.lang.RootObject[TP.SNAME]='Object';TP.lang.RootObject[TP.NAME]='TP.lang.RootObject';TP.lang.RootObject[TP.ID]='TP.lang.RootObject';TP.lang.RootObject[TP.ANCESTOR_NAMES]=['Object'];TP.lang.RootObject[TP.ANCESTORS]=[Object];TP.lang.RootObject.nsRoot='TP';TP.lang.RootObject.nsPrefix='lang';TP.lang.RootObject.localName='RootObject';TP.lang.RootObject.Type=TP.lang.RootObject[TP.TYPEC].prototype;TP.lang.RootObject.Type[TP.OWNER]=TP.lang.RootObject;TP.lang.RootObject.Inst=TP.lang.RootObject[TP.INSTC].prototype;TP.lang.RootObject.Inst[TP.OWNER]=TP.lang.RootObject;TP.defineNamespace('extern','TP');TP.definePrimitive('defineGlobalMethod',function(a,c){var b;b=TP.defineMethod(TP.global,a,c,TP.GLOBAL_TRACK,null,'TP.global.'+a);TP.sys.defineGlobal(a,b,true);return b;},false,'TP.defineGlobalMethod');TP.definePrimitive('defineMetaTypeMethod',function(a,d){var b,c,e;TP.META_TYPE_OWNER.meta_methods[a]=d;for(b=0;b<TP.META_TYPE_TARGETS.length;b++){c=TP.META_TYPE_TARGETS[b];if(TP.isMethod(e=c[a])&&e[TP.OWNER]!==TP.META_TYPE_OWNER){continue;}TP.defineMethod(c,a,d,TP.META_TYPE_TRACK,null,c[TP.ID]+'.'+TP.META_TYPE_TRACK+'.'+a,TP.META_TYPE_OWNER);}return null;},false,'TP.defineMetaTypeMethod');TP.definePrimitive('defineMetaInstMethod',function(b,d){var e,a,c;TP.META_INST_OWNER.meta_methods[b]=d;for(e=0;e<TP.META_INST_TARGETS.length;e++){a=TP.META_INST_TARGETS[e];if(TP.isMethod(c=a[b])&&c[TP.OWNER]!==TP.META_INST_OWNER){continue;}TP.defineMethod(a,b,d,TP.META_INST_TRACK,null,a[TP.ID]+'.'+TP.META_INST_TRACK+'.'+b,TP.META_INST_OWNER);}if(TP.isNamespace(TP.lang)&&TP.isType(TP.lang.RootObject)){a=TP.lang.RootObject$$Type.prototype;if(TP.isMethod(c=a[b])&&c[TP.OWNER]!==TP.META_INST_OWNER){}else{TP.defineMethod(a,b,d,TP.META_INST_TRACK,null,a[TP.ID]+'.'+TP.META_INST_TRACK+'.'+b,TP.META_INST_OWNER);}a=TP.lang.RootObject$$Inst.prototype;if(TP.isMethod(c=a[b])&&c[TP.OWNER]!==TP.META_INST_OWNER){}else{TP.defineMethod(a,b,d,TP.META_INST_TRACK,null,a[TP.ID]+'.'+TP.META_INST_TRACK+'.'+b,TP.META_INST_OWNER);}}return null;},false,'TP.defineMetaInstMethod');TP.definePrimitive('defineCommonMethod',function(b,e){var c,a,d;TP.META_INST_OWNER.common_methods[b]=e;for(c=0;c<TP.META_INST_TARGETS.length;c++){a=TP.META_INST_TARGETS[c];if(TP.isMethod(d=a[b])&&d[TP.OWNER]!==TP.META_INST_OWNER){continue;}TP.defineMethod(a,b,e,TP.INST_TRACK,null,a[TP.ID]+'.'+TP.INST_TRACK+'.'+b,TP.META_INST_OWNER);}a=TP.lang.RootObject$$Inst.prototype;if(TP.isMethod(d=a[b])&&d[TP.OWNER]!==TP.META_INST_OWNER){}else{TP.defineMethod(a,b,e,TP.INST_TRACK,null,a[TP.ID]+'.'+TP.INST_TRACK+'.'+b,TP.META_INST_OWNER);}return null;},false,'TP.defineCommonMethod');TP.definePrimitive('defineAttribute',function(d,b,c,i,j){var g,f,h,a,e;if(d&&TP.owns(d,b)){TP.sys.shouldLogCodeChanges()&&TP.ifWarn()?TP.warn('Ignoring duplicate attribute definition: '+b,TP.LOG,arguments):0;TP.debug('break.duplicate_attribute');return d[b];}g=TP.ifInvalid(j,d);f=TP.ifInvalid(i,TP.LOCAL_TRACK);if(TP.notValid(c)){a=TP.DEFAULT_DESCRIPTOR;e=undefined;}else if(!c.hasOwnProperty('value')){a={'value':c};e=c;}else{a=c;e=a.value;}h=TP.defineSlot(d,b,e,TP.ATTRIBUTE,f,a);a[TP.NAME]=b;TP.sys.addMetadata(g,a,TP.ATTRIBUTE,f);return h;},false,'TP.defineAttribute');TP.definePrimitive('defineConstant',function(d,b,c,i,j){var g,f,h,a,e;if(d&&TP.owns(d,b)){TP.sys.shouldLogCodeChanges()&&TP.ifWarn()?TP.warn('Ignoring duplicate constant definition: '+b,TP.LOG,arguments):0;TP.debug('break.duplicate_constant');return d[b];}g=TP.ifInvalid(j,d);f=TP.ifInvalid(i,TP.LOCAL_TRACK);if(TP.notValid(c)){a=TP.DEFAULT_DESCRIPTOR;e=undefined;}else if(!c.hasOwnProperty('value')){a={'value':c};e=c;}else{a=c;e=a.value;}h=TP.defineSlot(d,b,e,TP.CONSTANT,f,a);a[TP.NAME]=b;TP.sys.addMetadata(g,a,TP.ATTRIBUTE,f);return h;},false,'TP.defineConstant');TP.definePrimitive('runConditionalFunction',function(a){var b,d,c;if(TP.$$DEBUG&&!a){TP.ifError()?TP.error('Invalid function body or object for '+'TP.runConditionalFunction: '+a,TP.LOG,arguments):0;return;}if(!TP.isCallable(a)){b=a.at('test');if(TP.isCallable(b)){d=''+b();}else{if(typeof b==='string'&&TP.sys.hasFeatureTest(b)){d=TP.sys.hasFeature(b);}else{d=(''+b).toLowerCase();}}c=a.at(d);if(typeof c==='undefined'){c=a.at(TP.DEFAULT);if(!c){return;}}}else{c=a;}if(!TP.isCallable(c)){TP.ifError()?TP.error('Invalid function body or object for '+'TP.runConditionalFunction: '+a,TP.LOG,arguments):0;return;}return c();},false,'TP.runConditionalFunction');TP.definePrimitive('defineMethodAlias',function(a,b,c){a[b]=c;return a[b];},false,'TP.defineMethodAlias');TP.defineMetaInstMethod('getConstructor',function(){return this.constructor;});TP.defineMetaInstMethod('getPrototype',function(){return Object.getPrototypeOf(this);});TP.defineMetaInstMethod('getInstPrototype',function(){if(TP.isFunction(this)){return this.prototype;}return this.getPrototype();});TP.defineMetaInstMethod('getType',function(){if(TP.isFunction(this)){return Function;}return this.constructor;});TP.defineMetaInstMethod('getTypeName',function(){var a,c,b;if(TP.isWindow(this)){return'Window';}if(TP.isType(b=this.getType())){if(TP.canInvoke(b,'getName')){return b.getName();}if(TP.canInvoke(b,'toString')){a=b.toString();return a.strip(/[\[\]]/g);}}if(TP.isFunction(this)){return'Function';}if((a=TP.ObjectProto.toString.call(this))&&TP.regex.NATIVE_TYPENAME_MATCH.test(a)){if(c=a.match(TP.regex.NATIVE_TYPENAME_EXTRACT)){return c[1];}}return TP.isWindow(this)?'Window':'Object';});TP.defineMetaInstMethod('$getName',function(){if(TP.owns(this,TP.NAME)){return this[TP.NAME];}return this.getID();});TP.defineMetaInstMethod('getName',function(){if(TP.owns(this,TP.NAME)){return this[TP.NAME];}return this.getID();});TP.defineMetaInstMethod('$getOID',function(c){var a,b;if(TP.isValid(this.$$oid)){return this.$$oid;}if(this===TP.ObjectProto){return'ObjectProto';}else if(this===TP.FunctionProto){return'FunctionProto';}if(!TP.isMutable(this)){if(TP.isString(this)){return''+this;}return this;}if(!c){a=TP.isType(this)?this:TP.type(this);if(TP.isNativeType(a)){if(TP.isNonFunctionConstructor(a)){b=TP.getNonFunctionConstructorName(a);}else if(TP.isFunction(a)){if(TP.canInvoke(a,'getName')){b=a.getName();}else if(TP.isFunction(a)){b=TP.getFunctionName(a);}}}else{b=a[TP.TNAME];}}else{b=c;}if(this.$$oid===undefined&&!TP.isNode(this)){try{this.$$oid=TP.sys.constructOID(b);}catch(a){}}else if(this.$$oid===this.getPrototype().$$oid&&!TP.isNode(this)){if(this!==this.getPrototype()){this.$$oid=TP.sys.constructOID(b);}}return this.$$oid;});TP.defineMetaInstMethod('getID',function(a){if(this===TP.ObjectProto){return'ObjectProto';}if(this[TP.ID]===undefined){return this.$getOID(a);}else if(this[TP.ID]===this.getPrototype()[TP.ID]){if(this!==this.getPrototype()){return this.$getOID(a);}}return this[TP.ID];});TP.defineMetaInstMethod('setID',function(b){var a,c;if(TP.isValid(a=this[TP.ID])&&a!==b){if(TP.isValid(TP.sys.hasRegistered)){c=TP.sys.hasRegistered(this,a);TP.sys.unregisterObject(this,a);}}a=TP.notValid(b)?this.$getOID():b;this[TP.ID]=a;if(c){TP.sys.registerObject(this,a);}return this[TP.ID];});TP.defineMethod(TP.sys,'defineAttribute',function(a,b){return TP.defineAttribute(TP.sys,a,b,TP.LOCAL_TRACK);});TP.defineMethod(TP.sys,'defineMethod',function(a,b,c,d){return TP.defineMethod(TP.sys,a,b,TP.LOCAL_TRACK,c,d);});TP.defineMethod(TP.boot,'defineAttribute',function(a,b){return TP.defineAttribute(TP.boot,a,b,TP.LOCAL_TRACK);});TP.defineMethod(TP.boot,'defineMethod',function(a,b,c,d){return TP.defineMethod(TP.boot,a,b,TP.LOCAL_TRACK,c,d);});TP.defineMetaTypeMethod('ownsMethod',function(a){try{if(TP.sys.hasInitialized()&&TP.isMethod(this[a])){return this[a][TP.OWNER]===this;}}catch(a){}return false;});TP.defineMetaInstMethod('defineAttribute',function(a,b){return TP.defineAttribute(this,a,b,TP.LOCAL_TRACK,this);});TP.defineMetaInstMethod('defineConstant',function(a,b){return TP.defineConstant(this,a,b,TP.LOCAL_TRACK,this);});TP.defineMetaInstMethod('defineMethod',function(a,b,c){return TP.defineMethod(this,a,b,TP.LOCAL_TRACK,c,null,this);});TP.defineMethod(TP.FunctionProto,'defineAttribute',function(d,e){var a,b,c;if(this===TP.FunctionProto){a=TP.FunctionProto;b=Function;c=TP.INST_TRACK;}else if(TP.isType(this)){a=this;b=this;c=TP.TYPE_LOCAL_TRACK;}else{a=this;b=this;c=TP.LOCAL_TRACK;}return TP.defineAttribute(a,d,e,c,b);},TP.TYPE_TRACK,null,'TP.FunctionProto.Type.defineAttribute');TP.defineMethod(TP.FunctionProto,'defineConstant',function(d,e){var a,b,c;if(this===TP.FunctionProto){a=TP.FunctionProto;b=Function;c=TP.INST_TRACK;}else if(TP.isType(this)){a=this;b=this;c=TP.TYPE_LOCAL_TRACK;}else{a=this;b=this;c=TP.LOCAL_TRACK;}return TP.defineConstant(a,d,e,c,b);},TP.TYPE_TRACK,null,'TP.FunctionProto.Type.defineConstant');TP.defineMethod(TP.FunctionProto,'defineMethod',function(d,e,f){var a,b,c;if(this===TP.FunctionProto){a=TP.FunctionProto;b=Function;c=TP.INST_TRACK;}else if(TP.isType(this)){a=this;b=this;c=TP.TYPE_LOCAL_TRACK;}else{a=this;b=this;c=TP.LOCAL_TRACK;}return TP.defineMethod(a,d,e,c,f,null,b);},TP.TYPE_TRACK,null,'TP.FunctionProto.Type.defineMethod');TP.defineMethod(TP.lang.RootObject.Type,'defineAttribute',function(c,d){var a,b;if(TP.isPrototype(this)){a=TP.TYPE_TRACK;b=this[TP.OWNER];}else{a=TP.TYPE_LOCAL_TRACK;b=this;}return TP.defineAttribute(this,c,d,a,b);},TP.TYPE_TRACK,null,'TP.lang.RootObject.Type.defineAttribute');TP.defineMethod(TP.lang.RootObject.Type,'defineConstant',function(c,d){var a,b;if(TP.isPrototype(this)){a=TP.TYPE_TRACK;b=this[TP.OWNER];}else{a=TP.TYPE_LOCAL_TRACK;b=this;}return TP.defineConstant(this,c,d,a,b);},TP.TYPE_TRACK,null,'TP.lang.RootObject.Type.defineConstant');TP.defineMethod(TP.lang.RootObject.Type,'defineMethod',function(c,d,e){var b,a;if(TP.isPrototype(this)){b=TP.TYPE_TRACK;a=this[TP.OWNER];if(TP.isMethod(a.hasTraits)&&a.hasTraits()){this.resolveTrait(c,a);}}else{b=TP.TYPE_LOCAL_TRACK;a=this;}return TP.defineMethod(this,c,d,b,e,null,a);},TP.TYPE_TRACK,null,'TP.lang.RootObject.Type.defineMethod');TP.defineMethod(TP.lang.RootObject.Inst,'defineAttribute',function(c,d){var a,b;if(TP.isPrototype(this)){a=TP.INST_TRACK;b=this[TP.OWNER];}else{a=TP.LOCAL_TRACK;b=this;}return TP.defineAttribute(this,c,d,a,b);},TP.TYPE_TRACK,null,'TP.lang.RootObject.Inst.defineAttribute');TP.defineMethod(TP.lang.RootObject.Inst,'defineConstant',function(c,d){var a,b;if(TP.isPrototype(this)){a=TP.INST_TRACK;b=this[TP.OWNER];}else{a=TP.LOCAL_TRACK;b=this;}return TP.defineConstant(this,c,d,a,b);},TP.TYPE_TRACK,null,'TP.lang.RootObject.Inst.defineConstant');TP.defineMethod(TP.lang.RootObject.Inst,'defineMethod',function(c,d,e){var b,a;if(TP.isPrototype(this)){b=TP.INST_TRACK;a=this[TP.OWNER];if(TP.isMethod(a.hasTraits)&&a.hasTraits()){this.resolveTrait(c,a);}}else{b=TP.LOCAL_TRACK;a=this;}return TP.defineMethod(this,c,d,b,e,null,a);},TP.TYPE_TRACK,null,'TP.lang.RootObject.Inst.defineMethod');Window.getName=function(){return'Window';};Window.Type.defineMethod=function(a,c,d){var b='Window.Type.'+a;return TP.defineMethod(Window,a,c,TP.TYPE_TRACK,d,b);};Window.Type.defineMethod('getName',Window.getName);if(!TP.isFunction(Window.getID)){Window.getID=TP.FunctionProto.getID;Window.$getOID=TP.FunctionProto.$getOID;Window.getPrototype=TP.FunctionProto.getPrototype;}Window.Inst.defineMethod('$getName',function(){return'Self';});Window.Inst.defineMethod('getName',function(){return'Self';});Window.Inst.defineMethod('$getOID',function(b){var a;if(TP.notValid(a=this.$$oid)&&!TP.isNode(this)){a=TP.sys.constructOID(TP.ifInvalid(b,'window'));this.$$oid=a;}return a;});Window.Inst.defineMethod('getID',function(a){if(TP.notValid(this[TP.ID])){return this.$getOID(a);}return this[TP.ID];});Window.Inst.defineMethod('setID',function(b){var a,c;if(TP.isValid(a=this[TP.ID])){if(TP.isValid(TP.sys.hasRegistered)){c=TP.sys.hasRegistered(this,a);TP.sys.unregisterObject(this,a);}}a=TP.notValid(b)?this.$getOID():b;this[TP.ID]=a;if(c){TP.sys.registerObject(this,a);}return this[TP.ID];});TP.defineMetaInstMethod('getLocalName',function(){return this.getTypeName();});TP.defineMetaInstMethod('getNamespacePrefix',function(){return'';});TP.definePrimitive('sc',function(){var a;a=TP.ac(arguments);return a.join('');});TP.definePrimitive('alert',function(a,b){return alert(TP.sc(a));});TP.definePrimitive('confirm',function(a,b){return confirm(TP.sc(a));});TP.definePrimitive('prompt',function(a,b,c){return prompt(TP.sc(a),TP.sc(b)||'');});TP.definePrimitive('status',function(e,a){var b,c,d;b=e;if(TP.notValid(a)){top.status=b;return;}if(TP.isString(a)){c=TP.sys.getWindowById(a);if(TP.isWindow(c)){c.top.status=b;}}else if(TP.isNumber(a)){d=TP.byId('status'+a,TP.uidoc(true));if(TP.isElement(d)){TP.htmlElementSetContent(d,b,null,false);}}else if(TP.isWindow(a)){a.top.status=b;}return;});TP.definePrimitive('debug',function(a){if(!TP.sys.cfg('debug.use_debugger')){return;}if(a!==undefined){if(TP.isString(a)){if(TP.sys.cfg(a)!==true){return;}}else if(a!==true){return;}}try{debugger;}catch(a){}return;});TP.definePrimitive('log',function(c,e,f,g){var a,b,d;a=TP.ifInvalid(g,TP.INFO);b=TP.ifInvalid(f||arguments);if(TP.sys.hasStarted()){d=TP.ifInvalid(e,TP.LOG);return TP.sys.log(c,d,a,b);}else if(a>=TP.ERROR&&a<TP.SYSTEM){return TP.boot.$stderr(c,b,a);}else{return TP.boot.$stdout(c,b,a);}});TP.definePrimitive('error',function(a,b,c){return TP.log(a,b||TP.LOG,c||arguments,TP.ERROR);});TP.definePrimitive('fatal',function(a,b,c){return TP.log(a,b||TP.LOG,c||arguments,TP.FATAL);});TP.definePrimitive('info',function(a,b,c){return TP.log(a,b||TP.LOG,c||arguments,TP.INFO);});TP.definePrimitive('severe',function(a,b,c){return TP.log(a,b||TP.LOG,c||arguments,TP.SEVERE);});TP.definePrimitive('system',function(a,b,c){return TP.log(a,b||TP.LOG,c||arguments,TP.SYSTEM);});TP.definePrimitive('trace',function(a,b,c){return TP.log(a,b||TP.LOG,c||arguments,TP.TRACE);});TP.definePrimitive('warn',function(a,b,c){return TP.log(a,b||TP.LOG,c||arguments,TP.WARN);});TP.definePrimitive('ac',function(b){var a;a=new Array();if(arguments.length===0){return a;}else{return a.slice.call(arguments,0);}});TP.definePrimitive('args',function(a,b,e){var c,d,f;c=arguments.length;if(c===0){return this.raise('TP.sig.InvalidParameter',arguments,'No arguments object provided.');}else if(c===1){return TP.ArrayProto.slice.call(a,0);}else if(c===2){d=TP.notValid(b)?0:b;return TP.ArrayProto.slice.call(a,d);}else{d=TP.notValid(b)?0:b;f=TP.notValid(e)?a.length:Math.max(a.length,e);return TP.ArrayProto.slice.call(a,d,f);}});TP.definePrimitive('join',function(d){var b,c,a;b='';c=arguments.length;for(a=0;a<c;a++){b+=arguments[a];}return b;});Array.Inst.defineMethod('add',function(d){var a,b,c;c=this.length;b=arguments.length;for(a=0;a<b;a++){this[c+a]=arguments[a];}return this;});Array.Inst.defineMethod('getSize',function(){return this.length;});Array.Inst.defineMethod('item',function(a){return this.at(a);});TP.definePrimitive('stdin',TP.STDIN_PROMPT);TP.definePrimitive('stdout',TP.STDOUT_LOG);TP.definePrimitive('stderr',TP.STDERR_LOG);TP.boot.$$setupMetadata();TP.FunctionProto[TP.TNAME]='Function';TP.definePrimitive('objectGetLoadPackage',function(b){var a;if(TP.notValid(a=this.objectGetLoadNode(b))){return;}return a.getAttribute(TP.LOAD_PACKAGE);});TP.definePrimitive('objectGetLoadCollectionPath',function(b){var a;if(TP.notValid(a=TP.objectGetLoadPath(b))){return;}return a.slice(0,a.lastIndexOf('/'));});TP.definePrimitive('objectGetLoadPath',function(a){if(TP.notValid(a)){return;}return a[TP.LOAD_PATH];});TP.definePrimitive('objectGetLoadConfig',function(b){var a;if(TP.notValid(a=this.objectGetLoadNode(b))){return;}return a.getAttribute(TP.LOAD_CONFIG);});TP.definePrimitive('objectGetMetadata',function(b){var a;a=TP.objectGetMetadataName(b);if(TP.isEmpty(a)){return;}if(TP.isType(b)){return TP.sys.getMetadata('types').at(a);}else if(TP.isMethod(b)){return TP.sys.getMetadata('methods').at(a);}return;});TP.definePrimitive('objectGetSourcePath',function(a){if(TP.notValid(a)){return;}return a[TP.SRC_PATH];});TP.definePrimitive('uriGetLoadPackage',function(b){var a;if(TP.notValid(a=this.uriGetLoadNode(b))){return;}return a.getAttribute(TP.LOAD_PACKAGE);});TP.definePrimitive('uriGetLoadNode',function(f){var c,e,a,b,d;c=document.getElementsByTagName('script');e=c.length;for(a=0;a<e;a++){b=c[a];d=b.getAttribute('src')||b.getAttribute('source');if(TP.isString(d)){if(d.indexOf(f)!==TP.NOT_FOUND){return b;}}}return null;});TP.definePrimitive('uriGetLoadConfig',function(b){var a;if(TP.notValid(a=this.uriGetLoadNode(b))){return;}return a.getAttribute(TP.LOAD_CONFIG);});TP.sys.defineMethod('getUICanvas',function(b){var a;if(TP.isTrue(b)){a=TP.sys.getWindowById(TP.sys.getUICanvasName());if(TP.isWindow(a)){return a;}return;}return TP.core.Window.construct(TP.sys.getUICanvasName());});TP.sys.uiwin=TP.sys.getUICanvas;TP.sys.defineMethod('uidoc',function(b){var a;if(TP.isTrue(b)){a=TP.sys.getUICanvas(true);if(TP.isWindow(a)){return a.document;}return;}return TP.sys.getUICanvas().getDocument();});TP.sys.defineMethod('getUICanvasName',function(){var a;a=TP.ifInvalid(TP.sys.$uiCanvas,TP.sys.cfg('tibet.uicanvas'));a=TP.ifInvalid(a,TP.sys.cfg('boot.canvas'));TP.sys.$uiCanvas=a;return a;});TP.sys.defineMethod('getUICanvasPath',function(){return'tibet://'+TP.sys.getUICanvasName()+'/';});TP.sys.defineMethod('getUIRoot',function(a){if(TP.isTrue(a)){return TP.sys.getWindowById(TP.sys.getUIRootName());}return TP.byOID(TP.sys.getUIRootName());});TP.sys.defineMethod('getUIRootName',function(){var a;a=TP.ifInvalid(TP.sys.$uiRoot,TP.sys.cfg('tibet.uiroot'));a=TP.ifInvalid(a,TP.sys.getUICanvasName());TP.sys.$uiRoot=a;return a;});TP.sys.defineMethod('setUICanvas',function(b){var a;if(TP.isString(b)){a=b;TP.sys.$uiCanvas=a;TP.sys.setcfg('tibet.uicanvas',a);return TP.byOID(a);}else if(TP.canInvoke(b,'getNativeWindow')){a=TP.gid(b.getNativeWindow());TP.sys.$uiCanvas=a;TP.sys.setcfg('tibet.uicanvas',a);return b;}else{a=TP.gid(b);TP.sys.$uiCanvas=a;TP.sys.setcfg('tibet.uicanvas',a);return b;}return null;});TP.sys.defineMethod('setUIRoot',function(b){var a;if(TP.isString(b)){a=b;TP.sys.$uiRoot=a;TP.sys.setcfg('tibet.uiroot',a);return TP.byOID(a);}else{a=TP.gid(b);TP.sys.$uiRoot=a;TP.sys.setcfg('tibet.uiroot',a);return b;}return null;});TP.definePrimitive('signal',function(b,c,d,e,f,g){var a;if(TP.sys.cfg('log.signals')){a=TP.join('origin: ',b,' signaled: ',c,' from : ',d,' with: ',e);if(TP.isCallable(TP.stdout)){TP.stdout(a);}else if(TP.isCallable(TP.boot.$stdout)){TP.boot.$stdout(a,TP.TRACE);}}return;});TP.definePrimitive('raise',function(a,b,c,d){return TP.signal(a,b,c,d);});TP.defineMetaInstMethod('raise',function(a,b,c){return TP.raise(this,a,b,c);});TP.sys.defineMethod('raise',function(a,b,c){return TP.raise(this,a,b,c);});TP.definePrimitive('ifKeyInvalid',function(d,c,a){var b;if(TP.notValid(d)){return TP.isCallable(a)?a(c):a;}if(TP.canInvoke(d,'atIfInvalid')){return d.atIfInvalid(c,a);}if(TP.canInvoke(d,'at')){b=d.at(c);if(TP.notValid(b)){b=TP.isCallable(a)?a(c):a;}return b;}try{b=d[c];if(TP.notValid(b)){b=TP.isCallable(a)?a(c):a;}return b;}catch(a){}return TP.isCallable(a)?a(c):a;});TP.definePrimitive('ifKeyNull',function(d,c,a){var b;if(TP.notValid(d)){return TP.isCallable(a)?a(c):a;}if(TP.canInvoke(d,'atIfNull')){return d.atIfNull(c,a);}if(TP.canInvoke(d,'at')){b=d.at(c);if(TP.isNull(b)){b=TP.isCallable(a)?a(c):a;}return b;}try{b=d[c];if(TP.isNull(b)){b=TP.isCallable(a)?a(c):a;}return b;}catch(a){}return TP.isCallable(a)?a(c):a;});TP.definePrimitive('ifKeyUndefined',function(d,c,a){var b;if(TP.notValid(d)){return TP.isCallable(a)?a(c):a;}if(TP.canInvoke(d,'atIfUndefined')){return d.atIfUndefined(c,a);}if(TP.canInvoke(d,'at')){b=d.at(c);if(TP.notDefined(b)){b=TP.isCallable(a)?a(c):a;}return b;}try{b=d[c];if(TP.notDefined(b)){b=TP.isCallable(a)?a(c):a;}return b;}catch(a){}return TP.isCallable(a)?a(c):a;});TP.definePrimitive('isFalse',function(a){if(a===false){return true;}if(a===true){return false;}return TP.isBoolean(a)&&a.valueOf()===false;});TP.definePrimitive('isFalsey',function(a){if(a===false||a===''||a===0||a===undefined||a===null||TP.isNaN(a)){return true;}return false;});TP.definePrimitive('isTrue',function(a){if(a===true){return true;}if(a===false){return false;}return TP.isBoolean(a)&&a.valueOf()===true;});TP.definePrimitive('isTruthy',function(a){return!TP.isFalsey(a);});TP.definePrimitive('notFalse',function(a){if(a===true){return true;}if(a===false){return false;}return!TP.isFalse(a);});TP.definePrimitive('notTrue',function(a){if(a===false){return true;}if(a===true){return false;}return!TP.isTrue(a);});TP.definePrimitive('isArgArray',function(a){return TP.isValid(a)&&TP.ObjectProto.toString.call(a)==='[object Arguments]';});TP.definePrimitive('isArray',function(a){return Array.isArray(a);});TP.definePrimitive('isBoolean',function(a){if(a===true||a===false){return true;}if(typeof a==='boolean'){return true;}return TP.isValid(a)&&(a.constructor===Boolean||TP.regex.BOOLEAN_CONSTRUCTOR.test(''+a.constructor));});TP.definePrimitive('isDate',function(a){if(TP.notValid(a)||typeof a!=='object'){return false;}if(a.toString()==='Invalid Date'||a.toString()==='NaN'){return false;}if(typeof TP.isKindOf==='function'){return TP.isKindOf(a,'Date');}return a.constructor===Date||TP.regex.DATE_CONSTRUCTOR.test(''+a.constructor);});TP.definePrimitive('isNumber',function(a){if(TP.isNaN(a)){return false;}if(typeof a==='number'){return true;}return TP.ObjectProto.toString.call(a)==='[object Number]';});TP.definePrimitive('isRegExp',function(a){if(typeof a==='string'){return false;}return TP.isValid(a)&&(a.constructor===RegExp||TP.regex.REGEXP_CONSTRUCTOR.test(''+a.constructor));});TP.definePrimitive('isCollection',function(a){if(TP.isNodeList(a)||TP.isNamedNodeMap(a)){return true;}if(TP.canInvoke(a,'$$isCollection')){return a.$$isCollection();}return false;});TP.definePrimitive('isEnhanced',function(a){return TP.canInvoke(a,'getTypeName');});TP.definePrimitive('isGlobal',function(a,b){switch(typeof a){case'boolean':case'number':return true;case'object':return TP.isType(a);case'string':if(TP.notDefined(TP.global[a])){return false;}if(TP.isTrue(b)){return TP.sys.$nativeglobals.contains(a)||TP.sys.$ecmaglobals.contains(a)||TP.sys.$systemglobals.contains(a)||TP.sys.$globals.contains(a)||TP.sys.$globalexcludes.contains(a);}else{return TP.sys.$ecmaglobals.contains(a)||TP.sys.$systemglobals.contains(a)||TP.sys.$globals.contains(a)||TP.sys.$globalexcludes.contains(a);}break;case'function':if(TP.isTrue(b)){return a[TP.TRACK]==='Global'||TP.sys.$windowglobals.contains(TP.name(a));}else{return a[TP.TRACK]==='Global';}break;default:return false;}});TP.definePrimitive('isPair',function(a){if(TP.canInvoke(a,'$$isPair')){return a.$$isPair();}return false;});TP.definePrimitive('$$isTypeProxy',function(a){return TP.isValid(a)&&TP.isCallable(a.$$fault);});TP.definePrimitive('isProperty',function(a,b){if(a[b]===undefined){return false;}if(a[b]===null){return true;}return!TP.$$isDNU(a[b]);});TP.definePrimitive('isOwnProperty',function(a,b){return TP.isProperty(a,b)&&TP.owns(a,b);});TP.definePrimitive('isTypeName',function(a){if(!TP.isString(a)){return false;}if(a.isJSIdentifier()){if(TP.regex.INSTANCE_OID.test(a)){return false;}return a!==TP.ANY;}return TP.regex.VALID_TYPENAME.test(a);});TP.definePrimitive('isAttributeNode',function(a){return TP.isValid(a)&&a.nodeType===Node.ATTRIBUTE_NODE;});TP.definePrimitive('isCDATASectionNode',function(a){return TP.isValid(a)&&a.nodeType===Node.CDATA_SECTION_NODE;});TP.definePrimitive('isCollectionNode',function(a){return TP.isValid(a)&&(a.nodeType===Node.ELEMENT_NODE||a.nodeType===Node.DOCUMENT_NODE||a.nodeType===Node.DOCUMENT_FRAGMENT_NODE);});TP.definePrimitive('isCommentNode',function(a){return TP.isValid(a)&&a.nodeType===Node.COMMENT_NODE;});TP.definePrimitive('isDocument',function(a){return TP.isValid(a)&&a.nodeType===Node.DOCUMENT_NODE;});TP.definePrimitive('isElement',function(a){return TP.isValid(a)&&a.nodeType===Node.ELEMENT_NODE;});TP.definePrimitive('isEvent',function(a){return TP.isValid(a)&&typeof a.stopPropagation==='function'&&TP.isValid(a.timeStamp);});TP.definePrimitive('isFragment',function(a){return TP.isValid(a)&&a.nodeType===Node.DOCUMENT_FRAGMENT_NODE;});TP.definePrimitive('isHTMLDocument',function(a){var b;if(TP.notValid(a)||a.nodeType!==Node.DOCUMENT_NODE){return false;}if(TP.isDefined(a.isXHTML)){return!a.isXHTML;}if(a.contentType===TP.HTML_TEXT_ENCODED){a.isXHTML=false;return true;}else if(a.contentType===TP.XHTML_ENCODED){a.isXHTML=true;return false;}if(TP.notValid(a.defaultView)){return false;}if(!TP.isElement(a.documentElement)){a.isXHTML=false;return false;}if(a.documentElement.tagName.toLowerCase()!=='html'){a.isXHTML=false;return false;}b=a.createElement('span');if(TP.isElement(a.body)){a.body.appendChild(b);}else{a.documentElement.appendChild(b);}try{b.innerHTML='<p>This has no closing tag';a.isXHTML=false;}catch(b){a.isXHTML=true;}finally{b.parentNode.removeChild(b);}return!a.isXHTML;});TP.definePrimitive('isHTMLNode',function(a){var b;if(TP.notValid(a)||typeof a.nodeType!=='number'){return false;}if(a.nodeType===Node.DOCUMENT_NODE){return TP.isHTMLDocument(a);}if(TP.notValid(b=a.ownerDocument)){if(TP.isValid(a.tagName)){return TP.isValid(TP.HTML_401_TAGS[a.tagName.toLowerCase()]);}return false;}return TP.isHTMLDocument(b);});TP.definePrimitive('isIFrameWindow',function(b){var a;if(TP.notValid(b)){return false;}try{a=b.frameElement;if(TP.isElement(a)&&(TP.elementGetLocalName(a).toLowerCase()==='iframe'||TP.elementGetLocalName(a).toLowerCase()==='object')){return true;}}catch(a){return false;}return false;});TP.definePrimitive('isMediaQueryList',function(a){if(TP.notValid(a)){return false;}return a.matches!==undefined&&a.media!==undefined;});TP.definePrimitive('isPINode',function(a){return TP.isValid(a)&&a.nodeType===Node.PROCESSING_INSTRUCTION_NODE;});TP.definePrimitive('isStyleDeclaration',function(a){if(TP.notValid(a)){return false;}return a.length!==undefined&&a.cssText!==undefined;});TP.definePrimitive('isStyleRule',function(a){if(TP.notValid(a)){return false;}return a.parentStyleSheet!==undefined&&a.cssText!==undefined;});TP.definePrimitive('isStyleSheet',function(a){if(TP.notValid(a)){return false;}return a.parentStyleSheet!==undefined&&a.ownerNode!==undefined;});TP.definePrimitive('isSVGNode',function(a){var b;if(!TP.isXMLNode(a)){return false;}if(a.namespaceURI==='http://www.w3.org/2000/svg'){return true;}if(TP.isDocument(b=TP.nodeGetDocument(a))){return TP.isElement(b.documentElement)&&b.documentElement.namespaceURI==='http://www.w3.org/2000/svg';}return false;});TP.definePrimitive('isTextNode',function(a){return TP.isValid(a)&&a.nodeType===Node.TEXT_NODE;});TP.definePrimitive('isXHTMLDocument',function(a){var b;if(TP.notValid(a)||a.nodeType!==Node.DOCUMENT_NODE){return false;}if(TP.isDefined(a.isXHTML)){return a.isXHTML;}if(a.contentType===TP.XHTML_ENCODED){a.isXHTML=true;return true;}else if(a.contentType===TP.HTML_TEXT_ENCODED){a.isXHTML=false;return false;}if(!TP.isElement(a.documentElement)){a.isXHTML=false;return false;}if(TP.notValid(a.defaultView)){return a.documentElement.tagName==='html';}if(a.documentElement.tagName!=='html'){a.isXHTML=false;return false;}b=a.createElement('span');if(TP.isElement(a.body)){a.body.appendChild(b);}else{a.documentElement.appendChild(b);}try{b.innerHTML='<p>This has no closing tag';a.isXHTML=false;}catch(b){a.isXHTML=true;}finally{b.parentNode.removeChild(b);}return a.isXHTML;});TP.definePrimitive('isXHTMLNode',function(a){var b;if(TP.notValid(a)||typeof a.nodeType!=='number'){return false;}if(a.nodeType===Node.DOCUMENT_NODE){return TP.isXHTMLDocument(a);}if(TP.notValid(b=a.ownerDocument)){if(TP.isValid(a.tagName)){return TP.isValid(TP.HTML_401_TAGS[a.tagName.toLowerCase()]);}return false;}return TP.isXHTMLDocument(b);});TP.definePrimitive('isXMLDocument',function(a){if(TP.notValid(a)||a.nodeType!==Node.DOCUMENT_NODE){return false;}return!TP.isHTMLDocument(a);});TP.definePrimitive('isEmpty',function(a){var b,c;if(TP.notValid(a)){return true;}c=typeof a;if(c==='string'){return a==='';}if(c==='boolean'||c==='number'){return false;}if(TP.isArgArray(a)){return a.length===0;}if(TP.isNumber(b=a.length)){return b===0;}if(TP.isRegExp(a)){return false;}if(TP.isAttributeNode(a)){return TP.notValid(a.value)||a.value==='';}if(TP.isNode(a)){return a.childNodes.length===0;}if(TP.canInvoke(a,'getSize')){try{return a.getSize()===0;}catch(a){}}if(TP.canInvoke(a,'get')){if(TP.isBoolean(b=a.get('empty'))){return b;}}if(TP.canInvoke(a,'getAttribute')){if(TP.isBoolean(b=a.getAttribute('empty'))){return b;}}return false;});TP.definePrimitive('ifEmpty',function(a,b){return TP.isEmpty(a)?b:a;});TP.definePrimitive('notEmpty',function(a){return!TP.isEmpty(a);});TP.definePrimitive('ifNaN',function(a,b){return TP.isNaN(a)===true?b:a;});TP.definePrimitive('ifBlank',function(a,b){return TP.isBlank(a)?b:a;});TP.definePrimitive('isBlank',function(a){if(a===null||a===undefined){return true;}if(TP.isTextNode(a)){return TP.isEmpty(TP.trim(a.value));}return TP.isEmpty(TP.trim(a));});TP.definePrimitive('notBlank',function(a){return!TP.isBlank(a);});TP.definePrimitive('isClosed',function(a){var b;if(TP.isWindow(a)){return a.closed;}else if(TP.isNode(a)){if(TP.canInvoke(TP,'nodeGetWindow')){b=TP.nodeGetWindow(a);}}else if(TP.canInvoke(a,'getNativeWindow')){b=a.getNativeWindow();}if(TP.isWindow(b)){return b.closed;}return window.closed;});TP.sys.$arraykeys=TP.ac('length');TP.sys.$documentkeys=TP.ac('localName','namespaceURI','nodeName','nodeType','nodeValue','prefix');TP.sys.$htmldockeys=TP.ac('cookie','domain','lastModified','referrer','title','URL');TP.sys.$elementkeys=TP.ac('localName','namespaceURI','nodeName','nodeType','nodeValue','prefix','tagName');TP.sys.$htmlelemkeys=TP.ac('localName','namespaceURI','nodeName','nodeType','nodeValue','prefix','tagName','baseName','className','dir','id','lang','offsetHeight','offsetWidth','offsetLeft','offsetTop','scrollHeight','scrollWidth','scrollLeft','scrollTop','title');TP.sys.$errorkeys=TP.ac('message');TP.sys.$eventkeys=TP.ac('bubbles','cancelable','eventPhase','timeStamp','type','altKey','button','cancelBubble','clientX','clientY','ctrlKey','keyCode','offsetX','offsetY','returnValue','screenX','screenY','shiftKey','x','y');TP.sys.$namednodemapkeys=TP.ac('length');TP.sys.$nodekeys=TP.ac('localName','namespaceURI','nodeName','nodeType','nodeValue','prefix');TP.sys.$nodelistkeys=TP.ac('length');TP.sys.$stringkeys=TP.ac('length');TP.sys.$windowkeys=TP.ac('closed','document','innerHeight','innerWidth','length','name','outerHeight','outerWidth','pageXOffset','pageYOffset','screenX','screenY','scrollMaxX','scrollMaxY','scrollX','scrollY');TP.sys.$xhrkeys=TP.ac('status','responseXML','responseText');TP.definePrimitive('$getOwnKeys',function(b){var d,e,f,a,c;if(TP.notValid(b)){return this.raise('InvalidParameter',arguments);}e=TP.ac();if(TP.isCallable(Object.keys)){d=Object.keys(b);f=d.getSize();if(b===TP.ObjectProto){for(a=0;a<f;a++){if(TP.$$isDNU(b[d.at(a)])||TP.regex.INTERNAL_SLOT.test(d.at(a))){continue;}else{e.push(d.at(a));}}}else{for(a=0;a<f;a++){if(TP.regex.INTERNAL_SLOT.test(d.at(a))){continue;}else{e.push(d.at(a));}}}return e;}if(b===TP.ObjectProto){for(c in b){if(!TP.owns(b,c)||TP.regex.INTERNAL_SLOT.test(c)){continue;}e.push(c);}}else{for(c in b){if(!TP.owns(b,c)||TP.regex.INTERNAL_SLOT.test(c)){continue;}e.push(c);}}return e;});TP.keys=TP.$getOwnKeys;TP.str=TP.RETURN_TOSTRING;TP.defineMetaInstMethod('asString',function(g){var c,d,b,f,a,e;c=TP.ifInvalid(g,true);if(TP.isWindow(this)){if(c){return TP.windowAsString(this);}else{return TP.gid(this);}}if(!c){return TP.objectToString(this);}if(this.$$format_asString){return TP.recursion(this);}try{this.$$format_asString=true;}catch(a){}d=new Array();try{b=TP.keys(this);f=b.length;for(a=0;a<f;a++){d.push(b[a]+': '+TP.str(this[b[a]],false));}e=d.join(', ');}catch(a){e=this.toString();}try{delete this.$$format_asString;}catch(a){}return e;});TP.ArrayProto.asString=TP.RETURN_TOSTRING;TP.BooleanProto.asString=TP.RETURN_TOSTRING;TP.DateProto.asString=TP.RETURN_TOSTRING;TP.FunctionProto.asString=TP.RETURN_TOSTRING;TP.NumberProto.asString=TP.RETURN_TOSTRING;TP.RegExpProto.asString=TP.RETURN_TOSTRING;TP.StringProto.asString=TP.RETURN_TOSTRING;String.Inst.defineMethod('pad',function(g,h,i){var a,d,e,b,f,c;a=TP.ifInvalid(g,0);a=Math.max(0,a);if(this.length>=a){return this.toString();}d=TP.ifInvalid(h,TP.DEFAULT_STRPAD);e=TP.ifInvalid(i,TP.LEFT);c=TP.ac();f=a-this.length;for(b=0;b<f;b++){c[b]=d;}return e===TP.LEFT?c.join('')+this.toString():this.toString()+c.join('');});String.Inst.defineMethod('startsWith',function(a){return this.indexOf(a)===0;});String.Inst.defineMethod('asCamelCase',function(){var a;a=this.toString();TP.regex.CAMEL_CASE.lastIndex=0;TP.regex.WORD_BOUNDARIES.lastIndex=0;if(!TP.regex.CAMEL_CASE.test(a)){return a;}return a.replace(TP.regex.CAMEL_CASE,function(b,a){return a.toUpperCase();}).strip(TP.regex.WORD_BOUNDARIES);});String.Inst.defineMethod('asHyphenated',function(){return this.replace(/([A-Z])/g,'-$1').toLowerCase();});String.Inst.defineMethod('asStartLower',function(){return this[0].toLowerCase()+this.substring(1);});String.Inst.defineMethod('asStartUpper',function(){return this[0].toUpperCase()+this.substring(1);});String.Inst.defineMethod('asTitleCase',function(){var a;a=this.toString();TP.regex.TITLE_CASE.lastIndex=0;if(!TP.regex.TITLE_CASE.test(a)){return a.asStartUpper();}return a.replace(TP.regex.TITLE_CASE,function(b,a){return a.toUpperCase();}).asStartUpper();});String.Inst.defineMethod('asUnderscored',function(){return this.replace(/([A-Z])/g,function(b,a){return'_'+a.toLowerCase();});});TP.definePrimitive('trim',function(a){if(TP.isString(a)&&TP.regex.WHITESPACE.test(a)){return a.trim();}return a;});Date.Inst.defineMethod('asTimestamp',function(c,d,g){var b,a,e,f;a=TP.DEFAULT_NUMPAD;e=TP.isBoolean(c)?c:true;f=TP.isBoolean(d)?d:true;b=e?this.getFullYear().toString().pad(4,a)+(this.getMonth()+1).toString().pad(2,a)+this.getDate().toString().pad(2,a)+'T':'';b=b+this.getHours().toString().pad(2,a)+':'+this.getMinutes().toString().pad(2,a)+':'+this.getSeconds().toString().pad(2,a);if(f){b=b+'.'+this.getMilliseconds().toString().pad(3,a);}if(TP.isFalse(g)){return b.strip(/[^0-9]/g);}else{return b;}});TP.defineMetaInstMethod('changed',function(){return this;});var func=function(a){if(TP.isBoolean(a)){this.$$shouldSignal=a;}if(this.$suspended===true){return false;}return this.$$shouldSignal;};TP.defineMetaInstMethod('shouldSignalChange',func);TP.shouldSignalChange=func;TP.sys.shouldSignalChange=func;TP.sys.defineMethod('expireContentCaches',function(a){if(TP.isTrue(a)){this.$$contentExpiration=0;}return this.$$contentExpiration;});var func=function(a){return this[a];};TP.defineMetaInstMethod('$get',func);TP.$get=func;TP.sys.$get=func;var func=function(a,b){this[a]=b;return this;};TP.defineMetaInstMethod('$set',func);TP.$set=func;TP.sys.$set=func;TP.sys.defineMethod('shouldAllowDuplicateInterests',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('signal.duplicate_interests',a,b);}return TP.sys.cfg('signal.duplicate_interests');});TP.sys.defineMethod('$$shouldCacheDeepSubtypes',function(a){if(TP.isBoolean(a)){TP.sys.setcfg('tibet.$$cache_deep_subtypes',a,false);}return TP.sys.cfg('tibet.$$cache_deep_subtypes');});TP.sys.defineMethod('shouldCaptureErrors',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('debug.capture_errors',a,b);}return TP.sys.cfg('debug.capture_errors');});TP.sys.defineMethod('shouldEmbedProgress',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('progress.embed',a,b);}return TP.sys.cfg('progress.embed');});TP.sys.defineMethod('shouldIgnoreViaFlag',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('signal.ignore_via_flag',a,b);}return TP.sys.cfg('signal.ignore_via_flag');});TP.sys.defineMethod('$$shouldInvokeInferences',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('tibet.$$invoke_inferences',a,b);}return TP.sys.cfg('tibet.$$invoke_inferences');});TP.sys.defineMethod('shouldLogActivities',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.activities',a,b||false);}return TP.sys.cfg('log.activities');});TP.sys.defineMethod('shouldLogConsoleSignals',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.console_signals',a,b);}return TP.sys.cfg('log.console_signals');});TP.sys.defineMethod('shouldLogCSS',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.css_processing',a,b);}return TP.sys.cfg('log.css_processing');});TP.sys.defineMethod('shouldLogDOMFocusSignals',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.dom_focus_signals',a,b);}return TP.sys.cfg('log.dom_focus_signals');});TP.sys.defineMethod('shouldLogDOMLoadedSignals',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.dom_loaded_signals',a,b);}return TP.sys.cfg('log.dom_loaded_signals');});TP.sys.defineMethod('shouldLogErrors',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.errors',a,b||false);}return TP.sys.cfg('log.errors');});TP.sys.defineMethod('shouldLogInferences',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.inferences',a,b||false);}return TP.sys.cfg('log.inferences');});TP.sys.defineMethod('shouldLogIO',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.io',a,b||false);}return TP.sys.cfg('log.io');});TP.sys.defineMethod('shouldLogJobs',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.jobs',a,b||false);}return TP.sys.cfg('log.jobs');});TP.sys.defineMethod('shouldLogKeys',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.keys',a,b);}return TP.sys.cfg('log.keys');});TP.sys.defineMethod('shouldLogLinks',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.links',a,b);}return TP.sys.cfg('log.links');});TP.sys.defineMethod('shouldLogLoadSignals',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.load_signals',a,b);}return TP.sys.cfg('log.load_signals');});TP.sys.defineMethod('shouldLogNullNamespaces',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.null_namespaces',a,b);}return TP.sys.cfg('log.null_namespaces');});TP.sys.defineMethod('shouldLogRaise',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.raise',a,b||false);}return TP.sys.cfg('log.raise');});TP.sys.defineMethod('shouldLogRequestSignals',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.request_signals',a,b);}return TP.sys.cfg('log.request_signals');});TP.sys.defineMethod('shouldLogSecurity',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.security',a,b);}return TP.sys.cfg('log.security');});TP.sys.defineMethod('shouldLogSignals',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.signals',a,b||false);}return TP.sys.cfg('log.signals');});TP.sys.defineMethod('shouldLogSignalStack',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.signal_stack',a,b||false);}return TP.sys.cfg('log.signal_stack');});TP.sys.defineMethod('shouldLogStack',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.stack',a,b||false);}return TP.sys.cfg('log.stack');});TP.sys.defineMethod('shouldLogStackArguments',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.stack_arguments',a,b);}return TP.sys.cfg('log.stack_arguments');});TP.sys.defineMethod('shouldLogStackFileInfo',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.stack_file_info',a,b);}return TP.sys.cfg('log.stack_file_info');});TP.sys.defineMethod('shouldLogTransforms',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.content_transform',a,b);}return TP.sys.cfg('log.content_transform');});TP.sys.defineMethod('shouldLogTSHSignals',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.tsh_signals',a,b||false);}return TP.sys.cfg('log.tsh_signals');});TP.sys.defineMethod('shouldLogUserIOSignals',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.user_io_signals',a,b||false);}return TP.sys.cfg('log.user_io_signals');});TP.sys.defineMethod('shouldLogXPaths',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('log.xpaths',a,b);}return TP.sys.cfg('log.xpaths');});TP.sys.defineMethod('shouldQueueLoadSignals',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('signal.queue_load_signals',a,b);}return TP.sys.cfg('signal.queue_load_signals');});TP.sys.defineMethod('shouldProcessCSS',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('css.process_styles',a,b);}return TP.sys.cfg('css.process_styles');});TP.sys.defineMethod('shouldRegisterLoggers',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('debug.register_loggers',a,b);}return TP.sys.cfg('debug.register_loggers');});TP.sys.defineMethod('shouldReportParseErrors',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('debug.report_parse_errors',a,b);}return TP.sys.cfg('debug.report_parse_errors');});TP.sys.defineMethod('shouldRequestPrivileges',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('security.request_privileges',a,b);}return TP.sys.cfg('security.request_privileges');});TP.sys.defineMethod('shouldSignalDOMLoaded',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('signal.dom_loaded',a,b);}return TP.sys.cfg('signal.dom_loaded');});TP.sys.defineMethod('shouldSignalDOMFocusSignals',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('signal.dom_focus_signals',a,b);}return TP.sys.cfg('signal.dom_focus_signals');});TP.sys.defineMethod('shouldSignalLogChange',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('signal.log_change',a,b);}return TP.sys.cfg('signal.log_change');});TP.sys.defineMethod('shouldThrowEvaluations',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('debug.throw_evaluations',a,b);}return TP.sys.cfg('debug.throw_evaluations');});TP.sys.defineMethod('shouldThrowExceptions',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('debug.throw_exceptions',a,b);}return TP.sys.cfg('debug.throw_exceptions');});TP.sys.defineMethod('shouldThrowHandlers',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('debug.throw_handlers',a,b);}return TP.sys.cfg('debug.throw_handlers');});TP.sys.defineMethod('shouldTrackJobStats',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('job.track_stats',a,b);}return TP.sys.cfg('job.track_stats');});TP.sys.defineMethod('shouldTrackSignalStats',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('signal.track_stats',a,b);}return TP.sys.cfg('signal.track_stats');});TP.sys.defineMethod('shouldTrapRecursion',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('debug.trap_recursion',a,b);}return TP.sys.cfg('debug.trap_recursion');});TP.sys.defineMethod('shouldUniqueTypes',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('tibet.unique_types',a,b);}return TP.sys.cfg('tibet.unique_types');});TP.sys.defineMethod('$$shouldUseBackstop',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('tibet.$$use_backstop',a,b);}return TP.sys.cfg('tibet.$$use_backstop');});TP.sys.defineMethod('shouldUseContentCheckpoints',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('content.use_checkpoints',a,b);}return TP.sys.cfg('content.use_checkpoints');});TP.sys.defineMethod('shouldUseContentCaches',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('content.use_caches',a,b);}return TP.sys.cfg('content.use_caches');});TP.sys.defineMethod('shouldUseDebugger',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('debug.use_debugger',a,b);}return TP.sys.cfg('debug.use_debugger');});TP.sys.defineMethod('$$shouldUseInferencing',function(a,b){if(TP.isBoolean(a)){TP.sys.setcfg('tibet.$$use_inferencing',a,b);}return TP.sys.cfg('tibet.$$use_inferencing');});TP.sys.defineMethod('checkLibVersion',function(){var a,b,c;a=TP.uriExpandPath('~lib_version_file');b=TP.sys.getLibVersion();TP.ifTrace()?TP.trace('Checking for updates to '+TP.sys.getLibVersion(),TP.LOG,arguments):0;c=function(c){var d;if(TP.notEmpty(c)){d=TP.sys.getLibVersion(c);if(d===b){TP.ifTrace()?TP.trace(b+' is the latest.',TP.LOG,arguments):0;return;}TP.ifTrace()?TP.trace('Latest version is version '+d+'.',TP.LOG,arguments):0;TP.signal(TP.sys,'TP.sig.UpdateAvailable',arguments,c);}else{TP.ifWarn()?TP.warn('Unable to access '+a+' for version data.',TP.LOG,arguments):0;TP.ifTrace()?TP.trace('Assuming version '+b+' is current.',TP.LOG,arguments):0;}};try{TP.jsonpCall(a,c,'release',null,null,false);}catch(b){TP.ifError()?TP.error(TP.ec(b,'Unable to access '+a),TP.LOG,arguments):0;TP.ifTrace()?TP.trace('Assuming version '+TP.sys.getLibVersion()+' is current.',TP.LOG,arguments):0;}});TP.sys.defineMethod('getLibVersion',function(c,e){var a;var b;var d;if(TP.isEmpty(c)){if(TP.notEmpty(TP.sys.$versionString)){return TP.sys.$versionString;}}b=TP.hc(TP.ifInvalid(c,TP.sys.$version));a='v';a+=TP.ifEmpty(b.at('major'),'0');a+='.';a+=TP.ifEmpty(b.at('minor'),'0');a+='.';a+=TP.ifEmpty(b.at('patch'),'0');if(TP.notEmpty(b.at('suffix'))){a+='-';a+=b.at('suffix');a+='.';a+=b.at('commits');}if(TP.isTrue(e)){d=b.at('semver');if(TP.notEmpty(b.at('phash'))){a+='+g';a+=b.at('phash');}if(TP.notEmpty(b.at('time'))){if(TP.notEmpty(b.at('phash'))){a+='.';}else{a+='+';}a+=b.at('time');}}else{d=b.at('semver').split('+')[0];}if(a!==d){TP.error('Version string mismatch. source -> '+b.at('semver')+' !== '+a+' <- computed.');}if(TP.isEmpty(c)){TP.sys.$versionString=a;}return a;});TP.sys.defineMethod('getRuntimeInfo',function(){var a;a=TP.hc();a.atPut('CURRENT_LTIME',new Date().toString());a.atPut('TIBET_VERSION',TP.sys.$VERSION);a.atPut('TIBET_LICENSE',TP.sys.$LICENSE);a.atPut('BROWSER_AGENT',TP.$agent);return a;});TP.sys.defineMethod('getSTATUS',function(){return $STATUS;});TP.sys.defineMethod('setLogLevel',function(b,d){var a,c;if(TP.notValid(b)){return;}if(TP.isNumber(b)){a=b;}else if(TP.canInvoke(b,'get')){a=b.get('level');}else{if(TP.notValid(a=TP['$'+b.toUpperCase()])){a=TP[b.toUpperCase()];if(!TP.isNumber(a)){a=null;}}}if(TP.notValid(a)){return;}c=TP.sys.cfg('log.level');if(c!==a){TP.sys.setcfg('log.level',a,false,d);TP.sys.changed('LogLevel',TP.UPDATE,TP.hc(TP.OLDVAL,c,TP.NEWVAL,a));}return TP.sys.cfg('log.level');});TP.sys.defineMethod('setSTATUS',function(a){var b;b=$STATUS;if(b!==a){$STATUS=a;TP.sys.changed('STATUS',TP.UPDATE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,a));}return $STATUS;});TP.sys.$httpBased=window.location.protocol.indexOf('file')!==0;TP.sys.$scheme=window.location.protocol.slice(0,-1);TP.sys.$pathname=decodeURI(window.location.pathname);if(TP.sys.$httpBased){TP.sys.$host=window.location.hostname;TP.sys.$port=TP.isEmpty(window.location.port)||TP.notValid(window.location.port)?80:window.location.port;}else{TP.sys.$host='';TP.sys.$port='';}TP.sys.defineMethod('isHTTPBased',function(){return TP.sys.$httpBased;});TP.sys.defineMethod('getLaunchRoot',function(){var a,b;if(TP.sys.isHTTPBased()){a=TP.sys.getScheme()+'://'+TP.sys.getHost();if(TP.isValid(b=TP.sys.getPort())&&b.toString()!=='80'){a+=':'+b;}}else if(TP.boot.isWin()){return decodeURI(window.location.toString()).slice(0,decodeURI(window.location.toString()).lastIndexOf(':')+1);}else{return'file://';}return a;});TP.sys.defineMethod('getHost',function(){return TP.sys.$host;});TP.sys.defineMethod('getPathname',function(){return TP.sys.$pathname;});TP.sys.defineMethod('getPort',function(){return TP.sys.$port;});TP.sys.defineMethod('getScheme',function(){return TP.sys.$scheme;});TP.sys.defineMethod('getSourceLanguage',function(){return TP.sys.cfg('tibet.sourcelang',TP.sys.env('tibet.xmllang','en-us'));});TP.sys.defineMethod('getTargetLanguage',function(){if(TP.isType(TP.sys.require('TP.core.Locale'))){return TP.ifInvalid(TP.sys.getLocale().getISOKey(),'en-us');}return TP.sys.cfg('tibet.sourcelang',TP.sys.env('tibet.xmllang','en-us'));});TP.sys.defineMethod('setSourceLanguage',function(a){return TP.sys.setcfg('tibet.sourcelang',TP.ifInvalid(a,TP.sys.env('tibet.xmllang','en-us')));});TP.sys.defineMethod('getProfile',function(){return TP.sys.cfg('boot.profile');});TP.sys.defineMethod('getState',function(){return TP.sys.cfg('tibet.state');});TP.sys.defineMethod('isExiting',function(a){var b;if(TP.isBoolean(a)){b=TP.sys.cfg('tibet.exiting');if(b!==a){TP.sys.setcfg('tibet.exiting',a);TP.sys.changed('tibet.exiting',TP.UPDATE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,a));}}return TP.sys.cfg('tibet.exiting',false);});TP.sys.defineMethod('isOffline',function(a){var b;if(TP.isBoolean(a)){b=TP.sys.cfg('tibet.offline');if(TP.sys.cfg('tibet.offline')!==a){TP.sys.setcfg('tibet.offline',a);TP.sys.setcfg('tibet.uriprofile',null);TP.sys.changed('tibet.offline',TP.UPDATE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,a));}}return TP.sys.cfg('tibet.offline');});TP.sys.defineMethod('getEffectiveUser',function(){var a;if(TP.isType(a=TP.sys.require('TP.core.User'))){return a.getEffectiveUser();}return;});TP.sys.defineMethod('getRealUser',function(){var a;if(TP.isType(a=TP.sys.require('TP.core.User'))){return a.getRealUser();}return;});TP.ACROBAT_PLUGIN='acrobat';TP.QUICKTIME_PLUGIN='quicktime';TP.DIVX_PLUGIN='divx';TP.DIRECTOR_PLUGIN='director';TP.FLASH_PLUGIN='flash';TP.VLC_PLUGIN='vlc';TP.WINDOWS_MEDIA_PLUGIN='windows_media';TP.JAVA_PLUGIN='java';TP.REALPLAYER_PLUGIN='realplayer';TP.SILVERLIGHT_PLUGIN='silverlight';TP.PLUGIN_INFO=TP.hc();TP.PLUGIN_INFO.atPut(TP.ACROBAT_PLUGIN,TP.hc('classID','CA8A9780-280D-11CF-A24D-444553540000','description','Adobe Acrobat Plugin','installPage','http://www.adobe.com/products/acrobat/readstep2.html','mimeTypes',TP.hc('application/pdf','pdf','application/vnd.fdf','fdf','application/vnd.adobe.xfdf','xfdf','application/vnd.adobe.xdp+xml','xdp','application/vnd.adobe.xfd+xml','xfd'),'name','Acrobat','progIDs',TP.ac('PDF.PdfCtrl.7','PDF.PdfCtrl.6','PDF.PdfCtrl.5','PDF.PdfCtrl.4','PDF.PdfCtrl.3','AcroPDF.PDF.1')));TP.PLUGIN_INFO.atPut(TP.QUICKTIME_PLUGIN,TP.hc('classID','02BF25D5-8C17-4B23-BC80-D3488ABDDC6B','codeBase','http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0','description','Apple Quicktime Plugin','installPage','http://www.apple.com/quicktime/download/','mimeType','video/quicktime','mimeTypes',TP.hc('image/tiff','tif,tiff','image/x-tiff','tif,tiff','video/x-m4v','m4v','image/x-macpaint','pntg,pnt,mac','image/pict','pict,pic,pct','image/x-pict','pict,pic,pct','image/x-quicktime','qtif,qti','image/x-sgi','sgi,rgb','image/x-targa','targa,tga','audio/3gpp','3gp,3gpp','video/3gpp2','3g2,3gp2','audio/3gpp2','3g2,3gp2','video/sd-video','sdv','application/x-mpeg','amc','video/mp4','mp4','audio/mp4','mp4','audio/x-m4a','m4a','audio/x-m4p','m4p','audio/x-m4b','m4b','video/mpeg','mpeg,mpg,m1s,m1v,m1a,m75,m15,mp2,mpm,mpv,mpa','audio/mpeg','mpeg,mpg,m1s,m1a,mp2,mpm,mpa,m2a','audio/x-mpeg','mpeg,mpg,m1s,m1a,mp2,mpm,mpa,m2a','video/3gpp','3gp,3gpp','audio/x-gsm','gsm','audio/AMR','AMR','audio/aac','aac,adts','audio/x-aac','aac,adts','audio/x-caf','caf','video/x-mpeg','mpeg,mpg,m1s,m1v,m1a,m75,m15,mp2,mpm,mpv,mpa','audio/aiff','aiff,aif,aifc,cdda','audio/x-aiff','aiff,aif,aifc,cdda','audio/basic','au,snd,ulw','audio/mid','mid,midi,smf,kar','audio/x-midi','mid,midi,smf,kar','audio/midi','mid,midi,smf,kar','audio/vnd.qcelp','qcp','application/sdp','sdp','application/x-sdp','sdp','application/x-rtsp','rtsp,rts','video/quicktime','mov,qt,mqv','video/flc','flc,fli,cel','audio/x-wav','wav,bwf','audio/wav','wav,bwf'),'name','QuickTime','progIDs',TP.ac('QuickTime.QuickTime','QuickTimeCheckObject.QuickTimeCheck.1')));TP.PLUGIN_INFO.atPut(TP.DIVX_PLUGIN,TP.hc('classID','67DABFBF-D0AB-41fa-9C46-CC0F21721616','codeBase','http://go.divx.com/plugin/DivXBrowserPlugin.cab','description','DivX Browser Plugin','installPage','http://go.divx.com/plugin/download/','mimeType','video/divx','mimeTypes',TP.hc('video/divx','dvx,divx'),'name','DivX','progIDs',TP.ac('npdivx.DivXBrowserPlugin.1','npdivx.DivXBrowserPlugin')));TP.PLUGIN_INFO.atPut(TP.DIRECTOR_PLUGIN,TP.hc('classID','166B1BCA-3F9C-11CF-8075-444553540000','codeBase','http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version=8,5,1,0','description','Macromedia Director','installPage','http://go.divx.com/plugin/download/','mimeType','application/x-director','name','Director','progIDs',TP.ac('SWCtl.SWCtl.11','SWCtl.SWCtl.10','SWCtl.SWCtl.9','SWCtl.SWCtl.8','SWCtl.SWCtl.7','SWCtl.SWCtl.6','SWCtl.SWCtl.5','SWCtl.SWCtl.4')));TP.PLUGIN_INFO.atPut(TP.FLASH_PLUGIN,TP.hc('classID','D27CDB6E-AE6D-11CF-96B8-444553540000','codeBase','http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0','description','Macromedia Shockwave Flash','installPage','http://www.macromedia.com/go/getflashplayer','mimeType','application/x-shockwave-flash','mimeTypes',TP.hc('application/x-shockwave-flash','swf','application/futuresplash','spl'),'name','Flash','progIDs',TP.ac('ShockwaveFlash.ShockwaveFlash.9','ShockwaveFlash.ShockwaveFlash.8.5','ShockwaveFlash.ShockwaveFlash.8','ShockwaveFlash.ShockwaveFlash.7','ShockwaveFlash.ShockwaveFlash.6','ShockwaveFlash.ShockwaveFlash.5','ShockwaveFlash.ShockwaveFlash.4')));TP.PLUGIN_INFO.atPut(TP.VLC_PLUGIN,TP.hc('description','VLC multimedia plugin','installPage','http://www.videolan.org/doc/play-howto/en/ch02.html#id287569','mimeType','application/x-vlc-plugin','mimeTypes',TP.hc('audio/mpeg','mp2,mp3,mpga,mpega','audio/x-mpeg','mp2,mp3,mpga,mpega','video/mpeg','mpg,mpeg,mpe','video/x-mpeg','mpg,mpeg,mpe','video/mpeg-system','mpg,mpeg,vob','video/x-mpeg-system','mpg,mpeg,vob','video/mpeg4','mp4,mpg4','audio/mpeg4','mp4,mpg4','application/mpeg4-iod','mp4,mpg4','application/mpeg4-muxcodetable','mp4,mpg4','video/x-msvideo','avi','video/quicktime','mov,qt','application/x-ogg','ogg','application/x-vlc-plugin','*','video/x-ms-asf-plugin','asf,asx,*','video/x-ms-asf','asf,asx,*','application/x-mplayer2','dvx,divx,ivx,xvid,ivf,*','video/x-ms-wmv','wmv,*','application/x-google-vlc-plugin','*'),'name','VLC'));TP.PLUGIN_INFO.atPut(TP.WINDOWS_MEDIA_PLUGIN,TP.hc('classID','22D6f312-B0F6-11D0-94AB-0080C74C7E95','codeBase','http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=6,0,02,902','description','Windows Media Player Plug-in Dynamic Link Library','installPage','http://www.microsoft.com/windows/windowsmedia/','mimeType','application/x-mplayer2','mimeTypes',TP.hc('application/asx','*','video/x-msvideo','avi','video/x-ms-asf-plugin','*','application/x-mplayer2','dvx,divx,ivx,xvid,ivf,*','video/x-ms-asf','asf,asx,*','video/x-ms-wm','wm,*','audio/x-ms-wma','wma,*','audio/x-ms-wax','wax,*','video/x-ms-wmv','wmv,*','video/x-ms-wvx','wvx,*'),'name','Windows Media','progIDs',TP.ac('WMPlayer.OCX','MediaPlayer.MediaPlayer.1')));TP.PLUGIN_INFO.atPut(TP.JAVA_PLUGIN,TP.hc('classID','08B0E5C0-4FCB-11CF-AAA5-00401C608500','description','Java Virtual Machine','installPage','http://www.java.com/de/download/manual.jsp','mimeTypes',TP.hc('application/x-java-applet','','application/x-java-bean','','application/x-java-vm',''),'name','Java'));TP.PLUGIN_INFO.atPut(TP.REALPLAYER_PLUGIN,TP.hc('classID','CFCDAA03-8BE4-11cf-B84B-0020AFBBCCFA','description','Realplayer Version Plugin','installPage','http://www.real.com/freeplayer/?rppr=rnwk','mimeType','audio/x-pn-realaudio-plugin','mimeTypes',TP.hc('audio/x-pn-realaudio-plugin','rpm','application/vnd.rn-realplayer-javascript','rpj'),'name','Realplayer Plugin','progIDs',TP.ac('rmocx.RealPlayer G2 Control','rmocx.RealPlayer G2 Control.1','RealPlayer.RealPlayer(tm) ActiveX Control (32-bit)','RealVideo.RealVideo(tm) ActiveX Control (32-bit)','RealPlayer')));TP.PLUGIN_INFO.atPut(TP.SILVERLIGHT_PLUGIN,TP.hc('classID','32C73088-76AE-40F7-AC40-81F62CB2C1DA','description','Silverlight Plugin','installPage','','mimeType','application/x-silverlight','mimeTypes',TP.hc('application/manifest','manifest','application/xaml+xml','xaml','application/x-msdownload','dll','application/x-ms-xbap','xbap','application/octet-stream','deploy','application/vnd.ms-xpsdocument','xps'),'name','Silverlight','progIDs',TP.ac('AgControl.AgControl')));
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETPrimitivesBase.js';
TP.PLUGIN_INFO.at(TP.FLASH_PLUGIN).atPut('versionMatcher',/(^| )(\d+)\.?(\d*)\s*r([\d\.]*)/);TP.$$pluginVersionMatcher=/(^| )(\d+)\.?(\d*)\.?([\d\.]*)/;TP.$$pluginVersionFunction=function(d,b){var c,a;if(TP.notValid(c=b.at('versionMatcher'))){c=TP.$$pluginVersionMatcher;}a=c.exec(d.name);if(TP.notValid(a)){a=c.exec(d.description);}if(TP.isValid(a)){b.atPut('revMajor',a[2]);b.atPut('revMinor',a[3]);b.atPut('revPatch',a[4]);}return;};TP.definePrimitive('getPluginInfo',function(h){var a,c,d,g,f,b,e;if(TP.notValid(a=TP.PLUGIN_INFO.at(h))){return null;}if(TP.notValid(a.at('isInstalled'))){d=null;if(TP.notValid(g=a.at('isInstalledFunction'))){c=navigator.plugins;for(b=0;b<c.length;b++){if(c[b].name.indexOf(a.at('name'))!==-1){d=c[b];break;}}e=TP.isValid(d);}else{e=g();}a.atPut('isInstalled',e);if(e){if(TP.notValid(f=a.at('getVersionFunction'))){f=TP.$$pluginVersionFunction;}f(d,a);}}return a;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETPrimitivesPlatform.js';
TP.definePrimitive('isError',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a){return TP.isValid(a)&&a.message!==undefined&&(a.stack!==undefined||a.QueryInterface!==undefined);},TP.DEFAULT,function(a){if(TP.notValid(a)){return false;}if(a instanceof Error){return true;}return TP.isValid(a)&&a.message!==undefined&&a.stack!==undefined;}));TP.definePrimitive('isNamedNodeMap',TP.hc('test',TP.boot.getBrowserUI,'trident',function(a){if(TP.notValid(a)){return false;}if(typeof a.getNamedItem==='unknown'&&typeof a.setNamedItem==='unknown'){return true;}if(TP.isValid(a.getNamedItem)&&TP.isValid(a.setNamedItem)){return true;}return false;},TP.DEFAULT,function(a){return TP.isValid(a)&&TP.isValid(a.getNamedItem)&&TP.isValid(a.setNamedItem);}));TP.definePrimitive('isNodeList',TP.hc('test',TP.boot.getBrowserUI,'trident',function(a){if(TP.notValid(a)){return false;}if(TP.isNamedNodeMap(a)){return false;}if(typeof a.length==='number'&&typeof a.item==='unknown'){return true;}if(TP.isArray(a)){if(a.length===0||TP.isNode(a[0])){return true;}return false;}if(TP.isDefined(a.length)&&TP.isDefined(a.item)&&TP.notDefined(a.frames)){return true;}return false;},TP.DEFAULT,function(a){if(TP.notValid(a)||TP.isWindow(a)){return false;}if(TP.isNamedNodeMap(a)){return false;}if(TP.isArray(a)){if(a.join===undefined){return true;}return false;}return typeof a!=='string'&&a.length!==undefined&&a.item!==undefined&&a.cssText===undefined;}));TP.definePrimitive('isXMLNode',TP.hc('test',TP.boot.getBrowserUI,'trident',function(a){return TP.isValid(a)&&typeof a.nodeType==='number'&&(a.scopeName!=='HTML'||!TP.isHTMLDocument(TP.nodeGetDocument(a)));},TP.DEFAULT,function(a){var b;if(TP.notValid(a)||typeof a.nodeType!=='number'){return false;}if(a.nodeType===Node.DOCUMENT_NODE){return TP.isXMLDocument(a);}if(TP.notValid(b=a.ownerDocument)){if(TP.isValid(a.tagName)){return!TP.isValid(TP.HTML_401_TAGS[a.tagName.toLowerCase()]);}return false;}return TP.isXMLDocument(b);}));TP.definePrimitive('isXHR',TP.hc('test',TP.boot.getBrowserUI,'trident',function(a){try{return TP.isValid(a)&&TP.isProperty(a,'responseText')&&TP.isProperty(a,'responseXML');}catch(a){}return false;},TP.DEFAULT,function(a){try{return TP.isValid(a)&&TP.isProperty(a,'responseText')&&typeof a.send==='function';}catch(a){}return false;}));TP.definePrimitive('executePrivileged',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a,f,l,i,e){var h,g,b,j,k,d,c;h=250;if(TP.isTrue(i)||TP.sys.isExiting()){try{e();return true;}catch(a){if(TP.sys.isExiting()){return false;}}}if(!TP.sys.shouldRequestPrivileges()){TP.ifTrace()?TP.sys.logSecurity('TIBET not configured to request privileged code execution',TP.TRACE,arguments):0;return false;}g=false;b=false;if(TP.notValid(TP.PRIVILEGE_FLAGS.at(a))){TP.alert(TP.sc('This application would like to request the following privileges:','\n\n',TP.PRIVILEGE_DESCRIPTIONS.at(a),'\n\n','because:','\n\n',f,'\n\n','Therefore, you may see a dialog asking for permission to activate these privileges.\n\nNote that if you deny this permission and click the \'Remember this decision\' checkbox, you may have to manually edit your browser\'s configuration in the future to allow this application to be fully functional.'));}else{switch(TP.PRIVILEGE_FLAGS.at(a)){case'ENABLE':break;case'DISABLE':TP.raise(this,'TP.sig.PrivilegeViolation',arguments,TP.sc('Unable to obtain privileges for: '),a);return false;case'PROMPT':TP.alert(TP.sc('This application would like to request the following privileges:','\n\n',TP.PRIVILEGE_DESCRIPTIONS.at(a),'\n\n','because:','\n\n',f,'\n\n','Therefore, you may see a dialog asking for permission to activate these privileges.'));break;}}d=new Date();try{if(TP.sys.cfg('log.privilege_requests')){TP.ifTrace()?TP.sys.logSecurity('Privilege request at '+'executePrivileged',TP.TRACE,arguments):0;}netscape.security.PrivilegeManager.enablePrivilege('UniversalBrowserRead UniversalBrowserWrite UniversalXPConnect');c=new Date();if(c-d>h){b=true;}g=true;if(TP.PRIVILEGE_FLAGS.at(a)==='ENABLE'){}else{if(!b){TP.$setPrivilegeFlag(a,'ENABLE');}else{j=TP.confirm(TP.sc('You have approved enhanced permissions.','\n\n','You may have also checked the \'Remember this decision\' checkbox. Would you like your TIBET-based application to also remember this decision?','\n\n','If you did not check the \'Remember this decision\' checkbox, you may still want your TIBET-based application to remember this decision so that you will only see browser dialogs from now on.','\n\n','Click \'OK\' for your TIBET-based application to remember this decision or \'Cancel\' to not have it remember this decision.'));if(j){TP.$setPrivilegeFlag(a,'ENABLE');}else{TP.$setPrivilegeFlag(a,'PROMPT');}}}}catch(g){c=new Date();if(c-d>h){b=true;}if(TP.PRIVILEGE_FLAGS.at(a)!=='DISABLE'){if(!b){TP.alert(TP.sc('Permission was denied to this application to perform the operation.\n\nThis means that EITHER:\n\n1. You were not given the opportunity to give it permission to perform this operation.\n\nOR\n\n2.  You previously denied this application to perform this operation and clicked \'Remember this decision\'.\n\nContact your system administrator to rectify this situation.\n\nThis panel will NOT be shown again during this application session.'));}else{k=TP.confirm(TP.sc('Because you denied this application the following privileges:\n\n',TP.PRIVILEGE_DESCRIPTIONS.at(a),'\n\n','the consequences are that:','\n\n',l,'\n\n','You may attempt to perform this operation again, but you must grant this application permission to complete the operation by clicking \'Allow\' in the browser\'s permission request panel when that panel presents itself.','\n\n','If you checked \'Remember this decision\' you will not be given a chance to grant permission again. Contact your system administrator to rectify this situation. Otherwise, you can click \'OK\' below to try again or \'Cancel\' to not try again. If you choose \'Cancel\', this panel will NOT be shown again during this application session.'));if(k){TP.$setPrivilegeFlag(a,'PROMPT');return TP.executePrivileged(a,f,l,i,e);}}TP.$setPrivilegeFlag(a,'DISABLE');}TP.raise(this,'TP.sig.PrivilegeViolation',arguments,TP.ec(g,TP.join('Unable to obtain privileges for: ',a)));}if(g){e();return true;}return false;},'trident',function(a,g,j,i,h){var f,d,c,e,b;f=250;if(TP.isTrue(i)){try{h();return true;}catch(a){}}if(!TP.sys.shouldRequestPrivileges()){TP.ifError()?TP.error('TIBET not configured to request privileged code'+' execution',TP.SECURITY_LOG,arguments):0;return false;}d=false;c=false;if(TP.notValid(TP.PRIVILEGE_FLAGS.at(a))){TP.alert(TP.sc('This application would like to request the following privileges:','\n\n',TP.PRIVILEGE_DESCRIPTIONS.at(a),'\n\n','because:','\n\n',g,'\n\n','Therefore, you may see a dialog asking for permission to activate these privileges.'));}else{switch(TP.PRIVILEGE_FLAGS.at(a)){case'ENABLE':break;case'DISABLE':TP.raise(this,'TP.sig.PrivilegeViolation',arguments,TP.sc('Unable to obtain privileges for: '),a);return false;case'PROMPT':TP.alert(TP.sc('This application would like to request the following privileges:','\n\n',TP.PRIVILEGE_DESCRIPTIONS.at(a),'\n\n','because:','\n\n',g,'\n\n','Therefore, you may see a dialog asking for permission to activate these privileges.'));break;}}e=new Date();try{if(TP.sys.cfg('log.privilege_requests')){TP.ifTrace()?TP.sys.logSecurity('Privilege request at '+'executePrivileged',TP.TRACE,arguments):0;}h();b=new Date();if(b-e>f){c=true;}d=true;TP.$setPrivilegeFlag(a,'ENABLE');}catch(d){if(!/Automation server/.test(TP.str(d))&&!/Access denied/.test(TP.str(d))){throw d;}b=new Date();if(b-e>f){c=true;}if(TP.PRIVILEGE_FLAGS.at(a)!=='DISABLE'){if(!c){TP.alert(TP.sc('Permission was denied to this application to perform the operation.\n\nThis means that the permission to do so has been set to \'Disable\' in the Security Preferences panel.\n\nContact your system administrator to rectify this situation.\n\nThis panel will NOT be shown again during this application session.'));}else{TP.alert(TP.sc('Because you denied this application the following privileges:\n\n',TP.PRIVILEGE_DESCRIPTIONS.at(a),'\n\n','the consequences are that:','\n\n',j,'\n\n','You cannot attempt to perform this operation again.  You must quit this application, restart it and try again.','\n\n'));}TP.$setPrivilegeFlag(a,'DISABLE');}TP.raise(this,'TP.sig.PrivilegeViolation',arguments,TP.ec(d,TP.join('Unable to obtain privileges for: ',a)));}return d;},'webkit',function(a,b,c,d,e){return false;}));TP.definePrimitive('errorAsString',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a){var b,c;if(TP.notEmpty(b=a.message)){if(TP.notEmpty(a.fileName)){c=true;b+=' &#171; '+a.fileName;}else if(TP.notEmpty(a.filename)){b+=' &#171; '+a.filename;}if(TP.notEmpty(a.lineNumber)){b+='#line('+a.lineNumber+')';}if(c){b+=' &#187;';}}else{return'[object '+(a.name||'Error')+']';}return b;},'trident',function(a){var b;if(TP.notEmpty(b=a.message)){if(TP.notEmpty(a.number)){b+=' :: number: '+a.number;}}else{return'[object '+(a.name||'Error')+']';}return b;},'webkit',function(a){var b,c,d;if(TP.notEmpty(b=a.message)){if(TP.notEmpty(a.sourceURL)){c=true;b+=' &#171; '+a.sourceURL;}if(TP.notEmpty(a.line)){b+='#line('+a.line+')';}if(TP.notEmpty(a.expressionBeginOffset)){d=true;b+='['+a.expressionBeginOffset+':';}if(TP.notEmpty(a.expressionEndOffset)){b+=a.expressionEndOffset;}if(d){b+=']';}if(c){b+=' &#187;';}}else{return'[object '+(a.name||'Error')+']';}return b;}));TP.definePrimitive('getStackInfo',TP.hc('test',TP.boot.getBrowser,'firefox',function(e){var a,d,c,b;a=null;if(TP.notEmpty(d=e.stack)){a=d.replace(/(?:\n@:0)?\s+$/m,'').replace(/^(?:\((\S*)\))?@/gm,'{anonymous}($1)@').split('\n');}if(TP.notEmpty(a)){c=TP.ac();for(b=0;b<a.getSize();b++){c.push(TP.regex.CALL_STACK_ENTRY_SPLITTER.exec(a.at(b)).slice(1));}}return c;},'ie',function(e){var a,d,c,b;a=null;if(TP.notEmpty(d=e.stack)){a=d.replace(/^\s*at\s+(.*)$/gm,'$1').replace(/^Anonymous function\s+/gm,'{anonymous}() ').replace(/^(.+)\s+\((.+)\)$/gm,'$1@$2').split('\n').slice(1);}if(TP.notEmpty(a)){c=TP.ac();for(b=0;b<a.getSize();b++){c.push(TP.regex.CALL_STACK_ENTRY_SPLITTER.exec(a.at(b)).slice(1));}}return c;},'safari',function(e){var a,d,c,b;a=null;if(TP.notEmpty(d=e.stack)){a=d.replace(/\[native code\]\n/m,'').replace(/^(?=\w+Error\:).*$\n/m,'').replace(/^@/gm,'{anonymous}()@').split('\n');}if(TP.notEmpty(a)){c=TP.ac();for(b=0;b<a.getSize();b++){c.push(TP.regex.CALL_STACK_ENTRY_SPLITTER.exec(a.at(b)).slice(1));}}return c;},'chrome',function(f){var b,e,d,c,a;b=null;if(TP.notEmpty(e=f.stack)){b=(e+'\n').replace(/^[\s\S]+?\s+at\s+/,' at ').replace(/^\s+(at eval )?at\s+/gm,'').replace(/^([^\(]+?)([\n$])/gm,'{anonymous}() ($1)$2').replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,'{anonymous}() ($1)').replace(/^(.+) \((.+)\)$/gm,'$1@$2').split('\n').slice(0,-1);}if(TP.notEmpty(b)){d=TP.ac();for(c=0;c<b.getSize();c++){if(TP.notValid(a=TP.regex.CALL_STACK_ENTRY_SPLITTER.exec(b.at(c)))){d.push(TP.ac(b.at(c)));continue;}a=a.slice(1);if(TP.notEmpty(a.at(3))){a.atPut(3,a.at(3).strip(/:/));}d.push(a);}}return d;}));TP.definePrimitive('$setPrivilegeFlag',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a){TP.PRIVILEGE_FLAGS.atPut(TP.SHOW_ABOUT,a);TP.PRIVILEGE_FLAGS.atPut(TP.READ_HISTORY,a);TP.PRIVILEGE_FLAGS.atPut(TP.MANIPULATE_WINDOW,a);TP.PRIVILEGE_FLAGS.atPut(TP.READ_EXECUTION_STACK,a);TP.PRIVILEGE_FLAGS.atPut(TP.ACCESS_XDOMAIN_FRAME,a);TP.PRIVILEGE_FLAGS.atPut(TP.ACCESS_DOM_INSPECT,a);TP.PRIVILEGE_FLAGS.atPut(TP.ACCESS_XDOMAIN_XMLHTTP,a);TP.PRIVILEGE_FLAGS.atPut(TP.HOST_XSLT_EXEC,a);TP.PRIVILEGE_FLAGS.atPut(TP.HOST_FILE_DELETE,a);TP.PRIVILEGE_FLAGS.atPut(TP.HOST_FILE_SAVE,a);TP.PRIVILEGE_FLAGS.atPut(TP.HOST_FILE_ACCESS,a);TP.PRIVILEGE_FLAGS.atPut(TP.HOST_CMD_EXEC,a);return;},'trident',function(a){TP.PRIVILEGE_FLAGS.atPut(TP.HOST_FILE_DELETE,a);TP.PRIVILEGE_FLAGS.atPut(TP.HOST_FILE_SAVE,a);TP.PRIVILEGE_FLAGS.atPut(TP.HOST_FILE_ACCESS,a);TP.PRIVILEGE_FLAGS.atPut(TP.HOST_CMD_EXEC,a);},'webkit',function(a){return;}));TP.definePrimitive('$nodeToString',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a){},'trident',function(b){var a,c;if(!TP.isNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isHTMLDocument(b)){return'[object HTMLDocument]';}a='[object ';switch(b.nodeType){case Node.ELEMENT_NODE:if(TP.isString(c=TP.HTML_DOM_NAMES.at(TP.elementGetLocalName(b).toLowerCase()))){a+=c;}else{a+='Element';}break;case Node.ATTRIBUTE_NODE:a+='Attr';break;case Node.DOCUMENT_NODE:a+='XMLDocument';break;case Node.TEXT_NODE:a+='Text';break;case Node.CDATA_SECTION_NODE:a+='CDATASection';break;case Node.ENTITY_REFERENCE_NODE:a+='EntityReference';break;case Node.ENTITY_NODE:a+='Entity';break;case Node.PROCESSING_INSTRUCTION_NODE:a+='ProcessingInstruction';break;case Node.COMMENT_NODE:a+='Comment';break;case Node.DOCUMENT_TYPE_NODE:a+='DocumentType';break;case Node.DOCUMENT_FRAGMENT_NODE:a+='DocumentFragment';break;case Node.NOTATION_NODE:a+='Notation';break;default:a+='Node';break;}a+=']';return a;},'webkit',function(b){var a,c;if(!TP.isNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isHTMLDocument(b)){return'[object HTMLDocument]';}a='[object ';switch(b.nodeType){case Node.ELEMENT_NODE:if(TP.isString(c=TP.HTML_DOM_NAMES.at(TP.elementGetLocalName(b).toLowerCase()))){a+=c;}else{a+='Element';}break;case Node.ATTRIBUTE_NODE:a+='Attr';break;case Node.DOCUMENT_NODE:a+='XMLDocument';break;case Node.TEXT_NODE:a+='Text';break;case Node.CDATA_SECTION_NODE:a+='CDATASection';break;case Node.ENTITY_REFERENCE_NODE:a+='EntityReference';break;case Node.ENTITY_NODE:a+='Entity';break;case Node.PROCESSING_INSTRUCTION_NODE:a+='ProcessingInstruction';break;case Node.COMMENT_NODE:a+='Comment';break;case Node.DOCUMENT_TYPE_NODE:a+='DocumentType';break;case Node.DOCUMENT_FRAGMENT_NODE:a+='DocumentFragment';break;case Node.NOTATION_NODE:a+='Notation';break;default:a+='Node';break;}a+=']';return a;}));TP.definePrimitive('objectToString',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a){var b,c;if(TP.notDefined(a)){return'undefined';}if(TP.isNull(a)){return'null';}if(TP.isXHR(a)){return'[object XMLHttpRequest]';}if(TP.isError(a)){return'[object '+(a.name||'Error')+']';}if(TP.isElement(a)&&a.tagName.toUpperCase()==='A'){return'[object HTMLAnchorElement]';}if(TP.isWindow(a)){return'[object DOMWindow]';}if(TP.isNodeList(a)){return'[object NodeList]';}if(TP.isNamedNodeMap(a)){return'[object NamedNodeMap]';}if(TP.isStyleDeclaration(a)){return'[object CSSStyleDeclaration]';}if(TP.canInvoke(a,'toString')){b=a.toString();if(TP.regex.INSTANCE_OID.test(b)){b='[object '+TP.tname(a)+']';}else if(TP.regex.NATIVE_CODE.test(b)){if(c=b.match(/function (\w+)/)){b=c[1];}}return b;}try{if(isNaN(a)){return'NaN';}}catch(a){}return'[object Object]';},'trident',function(a){var b,c;if(TP.isNull(a)){return'null';}if(TP.notDefined(a)){return'undefined';}if(TP.isXHR(a)){return'[object XMLHttpRequest]';}if(TP.isHTMLDocument(a)){return'[object HTMLDocument]';}if(TP.isXMLDocument(a)){return'[object XMLDocument]';}if(TP.isNode(a)){return TP.$nodeToString(a);}if(TP.isError(a)){return'[object '+(a.name||'Error')+']';}if(TP.isElement(a)&&a.tagName.toUpperCase()==='A'){return'[object HTMLAnchorElement]';}if(TP.isWindow(a)){return'[object DOMWindow]';}if(TP.isNodeList(a)){return'[object NodeList]';}if(TP.isNamedNodeMap(a)){return'[object NamedNodeMap]';}if(TP.isStyleDeclaration(a)){return'[object CSSStyleDeclaration]';}if(TP.canInvoke(a,'toString')){b=a.toString();if(TP.regex.INSTANCE_OID.test(b)){b='[object '+TP.tname(a)+']';}else if(TP.regex.NATIVE_CODE.test(b)){if(c=b.match(/function (\w+)/)){b=c[1];}}return b;}try{if(isNaN(a)){return'NaN';}}catch(a){}return'[object Object]';},'webkit',function(a){var b,c;if(TP.isNull(a)){return'null';}if(TP.notDefined(a)){return'undefined';}if(TP.isXHR(a)){return'[object XMLHttpRequest]';}if(TP.isHTMLDocument(a)){return'[object HTMLDocument]';}if(TP.isXMLDocument(a)){return'[object XMLDocument]';}if(TP.isNode(a)){return TP.$nodeToString(a);}if(TP.isError(a)){return'[object '+(a.name||'Error')+']';}if(TP.isElement(a)&&a.tagName.toUpperCase()==='A'){return'[object HTMLAnchorElement]';}if(TP.isWindow(a)){return'[object DOMWindow]';}if(TP.isNodeList(a)){return'[object NodeList]';}if(TP.isNamedNodeMap(a)){return'[object NamedNodeMap]';}if(TP.isStyleDeclaration(a)){return'[object CSSStyleDeclaration]';}if(TP.canInvoke(a,'toString')){b=a.toString();if(TP.regex.INSTANCE_OID.test(b)){b='[object '+TP.tname(a)+']';}else if(TP.regex.NATIVE_CODE.test(b)){if(c=b.match(/function (\w+)/)){b=c[1];}}return b;}try{if(isNaN(a)){return'NaN';}}catch(a){}return'[object Object]';}));TP.definePrimitive('tostr',TP.objectToString);
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETPrimitivesPost.js';
TP.HTML_ENTITIES_TO_LITERALS=TP.hc('#160','\xA0','#161','\xA1','#162','\xA2','#163','\xA3','#165','\xA5','#167','\xA7','#169','\xA9','#171','\xAB','#174','\xAE','#177','\xB1','#180','\xB4','#181','\xB5','#182','\xB6','#183','\xB7','#187','\xBB','#191','\xBF','#192','\xC0','#193','\xC1','#194','\xC2','#195','\xC3','#196','\xC4','#197','\xC5','#198','\xC6','#199','\xC7','#200','\xC8','#201','\xC9','#202','\xCA','#203','\xCB','#204','\xCC','#205','\xCD','#206','\xCE','#207','\xCF','#209','\xD1','#210','\xD2','#211','\xD3','#212','\xD4','#213','\xD5','#214','\xD6','#216','\xD8','#217','\xD9','#218','\xDA','#219','\xDB','#220','\xDC','#223','\xDF','#224','\xE0','#225','\xE1','#226','\xE2','#227','\xE3','#228','\xE4','#229','\xE5','#230','\xE6','#231','\xE7','#232','\xE8','#233','\xE9','#234','\xEA','#235','\xEB','#236','\xEC','#237','\xED','#238','\xEE','#239','\xEF','#241','\xF1','#242','\xF2','#243','\xF3','#244','\xF4','#245','\xF5','#246','\xF6','#247','\xF7','#248','\xF8','#249','\xF9','#250','\xFA','#251','\xFB','#252','\xFC','#255','\xFF','#34','"','#38','&','#39','\'','#60','<','#62','>','#8211','\u2013','#8212','\u2014','#8364','\u20AC','#96','`','aacute','\xC1','aacute','\xE1','acirc','\xC2','acirc','\xE2','aelig','\xC6','aelig','\xE6','agrave','\xC0','agrave','\xE0','amp','&','apos','\'','aring','\xC5','aring','\xE5','atilde','\xC3','atilde','\xE3','auml','\xC4','auml','\xE4','ccedil','\xC7','ccedil','\xE7','cent','\xA2','copy','\xA9','divide','\xF7','eacute','\xC9','eacute','\xE9','ecirc','\xCA','ecirc','\xEA','egrave','\xC8','egrave','\xE8','euml','\xCB','euml','\xEB','euro','\u20AC','gt','>','iacute','\xCD','iacute','\xED','icirc','\xCE','icirc','\xEE','iexcl','\xA1','igrave','\xCC','igrave','\xEC','iquest','\xBF','iuml','\xCF','iuml','\xEF','laquo','\xAB','lt','<','mdash','\u2014','micro','\xB5','middot','\xB7','nbsp','\xA0','ndash','\u2013','ntilde','\xD1','ntilde','\xF1','oacute','\xD3','oacute','\xF3','ocirc','\xD4','ocirc','\xF4','ograve','\xD2','ograve','\xF2','oslash','\xD8','oslash','\xF8','otilde','\xD5','otilde','\xF5','ouml','\xD6','ouml','\xF6','para','\xB6','plusmn','\xB1','pound','\xA3','quot','"','raquo','\xBB','reg','\xAE','sect','\xA7','szlig','\xDF','uacute','\xDA','uacute','\xFA','ucirc','\xDB','ucirc','\xFB','ugrave','\xD9','ugrave','\xF9','uuml','\xDC','uuml','\xFC','yen','\xA5','yuml','\xFF');TP.HTML_LITERALS_TO_ENTITIES=TP.hc('\xA0','&#160;','\xA1','&#161;','\xA2','&#162;','\xA3','&#163;','\xA5','&#165;','\xA7','&#167;','\xA9','&#169;','\xAB','&#171;','\xAE','&#174;','\xB1','&#177;','\xB4','&#180;','\xB5','&#181;','\xB6','&#182;','\xB7','&#183;','\xBB','&#187;','\xBF','&#191;','\xC0','&#192;','\xC1','&#193;','\xC2','&#194;','\xC3','&#195;','\xC4','&#196;','\xC5','&#197;','\xC6','&#198;','\xC7','&#199;','\xC8','&#200;','\xC9','&#201;','\xCA','&#202;','\xCB','&#203;','\xCC','&#204;','\xCD','&#205;','\xCE','&#206;','\xCF','&#207;','\xD1','&#209;','\xD2','&#210;','\xD3','&#211;','\xD4','&#212;','\xD5','&#213;','\xD6','&#214;','\xD8','&#216;','\xD9','&#217;','\xDA','&#218;','\xDB','&#219;','\xDC','&#220;','\xDF','&#223;','\xE0','&#224;','\xE1','&#225;','\xE2','&#226;','\xE3','&#227;','\xE4','&#228;','\xE5','&#229;','\xE6','&#230;','\xE7','&#231;','\xE8','&#232;','\xE9','&#233;','\xEA','&#234;','\xEB','&#235;','\xEC','&#236;','\xED','&#237;','\xEE','&#238;','\xEF','&#239;','\xF1','&#241;','\xF2','&#242;','\xF3','&#243;','\xF4','&#244;','\xF5','&#245;','\xF6','&#246;','\xF7','&#247;','\xF8','&#248;','\xF9','&#249;','\xFA','&#250;','\xFB','&#251;','\xFC','&#252;','\xFF','&#255;','"','&#34;','&','&#38;','\'','&#39;','<','&#60;','>','&#62;','\u2013','&#8211;','\u2014','&#8212;','\u20AC','&#8364;','`','&#96;','\xC1','&aacute;','\xE1','&aacute;','\xC2','&acirc;','\xE2','&acirc;','\xC6','&aelig;','\xE6','&aelig;','\xC0','&agrave;','\xE0','&agrave;','&','&amp;','\'','&apos;','\xC5','&aring;','\xE5','&aring;','\xC3','&atilde;','\xE3','&atilde;','\xC4','&auml;','\xE4','&auml;','\xC7','&ccedil;','\xE7','&ccedil;','\xA2','&cent;','\xA9','&copy;','\xF7','&divide;','\xC9','&eacute;','\xE9','&eacute;','\xCA','&ecirc;','\xEA','&ecirc;','\xC8','&egrave;','\xE8','&egrave;','\xCB','&euml;','\xEB','&euml;','\u20AC','&euro;','>','&gt;','\xCD','&iacute;','\xED','&iacute;','\xCE','&icirc;','\xEE','&icirc;','\xA1','&iexcl;','\xCC','&igrave;','\xEC','&igrave;','\xBF','&iquest;','\xCF','&iuml;','\xEF','&iuml;','\xAB','&laquo;','<','&lt;','\u2014','&mdash;','\xB5','&micro;','\xB7','&middot;','\xA0','&nbsp;','\u2013','&ndash;','\xD1','&ntilde;','\xF1','&ntilde;','\xD3','&oacute;','\xF3','&oacute;','\xD4','&ocirc;','\xF4','&ocirc;','\xD2','&ograve;','\xF2','&ograve;','\xD8','&oslash;','\xF8','&oslash;','\xD5','&otilde;','\xF5','&otilde;','\xD6','&ouml;','\xF6','&ouml;','\xB6','&para;','\xB1','&plusmn;','\xA3','&pound;','"','&quot;','\xBB','&raquo;','\xAE','&reg;','\xA7','&sect;','\xDF','&szlig;','\xDA','&uacute;','\xFA','&uacute;','\xDB','&ucirc;','\xFB','&ucirc;','\xD9','&ugrave;','\xF9','&ugrave;','\xDC','&uuml;','\xFC','&uuml;','\xA5','&yen;','\xFF','&yuml;');TP.HTML_ENTITIES_TO_XML_ENTITIES=TP.hc('aacute','&#193;','acirc','&#194;','aelig','&#198;','agrave','&#192;','amp','&#38;','aring','&#197;','atilde','&#195;','auml','&#196;','ccedil','&#199;','cent','&#162;','copy','&#169;','divide','&#247;','eacute','&#201;','ecirc','&#202;','egrave','&#200;','euml','&#203;','euro','&#8364;','iacute','&#205;','icirc','&#206;','iexcl','&#161;','igrave','&#204;','iquest','&#191;','iuml','&#207;','laquo','&#171;','mdash','&#8212;','micro','&#181;','middot','&#183;','nbsp','&#160;','ndash','&#8211;','ntilde','&#209;','oacute','&#211;','ocirc','&#212;','ograve','&#210;','oslash','&#216;','otilde','&#213;','ouml','&#214;','para','&#182;','plusmn','&#177;','pound','&#163;','raquo','&#187;','reg','&#174;','sect','&#167;','szlig','&#223;','uacute','&#218;','ucirc','&#219;','ugrave','&#217;','uuml','&#220;','yen','&#165;','yuml','&#255;');TP.XML_ENTITIES_TO_LITERALS=TP.hc('#160','\xA0','#161','\xA1','#162','\xA2','#163','\xA3','#165','\xA5','#167','\xA7','#169','\xA9','#171','\xAB','#174','\xAE','#177','\xB1','#180','\xB4','#181','\xB5','#182','\xB6','#183','\xB7','#187','\xBB','#191','\xBF','#192','\xC0','#193','\xC1','#194','\xC2','#195','\xC3','#196','\xC4','#197','\xC5','#198','\xC6','#199','\xC7','#200','\xC8','#201','\xC9','#202','\xCA','#203','\xCB','#204','\xCC','#205','\xCD','#206','\xCE','#207','\xCF','#209','\xD1','#210','\xD2','#211','\xD3','#212','\xD4','#213','\xD5','#214','\xD6','#216','\xD8','#217','\xD9','#218','\xDA','#219','\xDB','#220','\xDC','#223','\xDF','#224','\xE0','#225','\xE1','#226','\xE2','#227','\xE3','#228','\xE4','#229','\xE5','#230','\xE6','#231','\xE7','#232','\xE8','#233','\xE9','#234','\xEA','#235','\xEB','#236','\xEC','#237','\xED','#238','\xEE','#239','\xEF','#241','\xF1','#242','\xF2','#243','\xF3','#244','\xF4','#245','\xF5','#246','\xF6','#247','\xF7','#248','\xF8','#249','\xF9','#250','\xFA','#251','\xFB','#252','\xFC','#255','\xFF','#34','"','#38','&','#39','\'','#60','<','#62','>','#8211','\u2013','#8212','\u2014','#8364','\u20AC','#96','`','#193','\xC1','#225','\xE1','#194','\xC2','#226','\xE2','#198','\xC6','#230','\xE6','#192','\xC0','#224','\xE0','amp','&','apos','\'','#199','\xC5','#229','\xE5','#195','\xC3','#227','\xE3','#196','\xC4','#228','\xE4','#199','\xC7','#231','\xE7','#162','\xA2','#169','\xA9','#247','\xF7','#201','\xC9','#233','\xE9','#202','\xCA','#234','\xEA','#200','\xC8','#232','\xE8','#203','\xCB','#235','\xEB','#8364','\u20AC','gt','>','#205','\xCD','#237','\xED','#206','\xCE','#238','\xEE','#161','\xA1','#204','\xCC','#236','\xEC','#191','\xBF','#207','\xCF','#239','\xEF','#171','\xAB','lt','<','#8212','\u2014','#181','\xB5','#183','\xB7','nbsp','\xA0','#8211','\u2013','#209','\xD1','#241','\xF1','#211','\xD3','#243','\xF3','#212','\xD4','#244','\xF4','#210','\xD2','#242','\xF2','#216','\xD8','#248','\xF8','#213','\xD5','#245','\xF5','#214','\xD6','#246','\xF6','#182','\xB6','#177','\xB1','#163','\xA3','quot','"','#187','\xBB','#174','\xAE','#167','\xA7','#223','\xDF','#218','\xDA','#250','\xFA','#219','\xDB','#251','\xFB','#217','\xD9','#249','\xF9','#220','\xDC','#252','\xFC','#165','\xA5','#255','\xFF');TP.XML_LITERALS_TO_ENTITIES=TP.hc('\xA0','&#160;','\xA1','&#161;','\xA2','&#162;','\xA3','&#163;','\xA5','&#165;','\xA7','&#167;','\xA9','&#169;','\xAB','&#171;','\xAE','&#174;','\xB1','&#177;','\xB4','&#180;','\xB5','&#181;','\xB6','&#182;','\xB7','&#183;','\xBB','&#187;','\xBF','&#191;','\xC0','&#192;','\xC1','&#193;','\xC2','&#194;','\xC3','&#195;','\xC4','&#196;','\xC5','&#197;','\xC6','&#198;','\xC7','&#199;','\xC8','&#200;','\xC9','&#201;','\xCA','&#202;','\xCB','&#203;','\xCC','&#204;','\xCD','&#205;','\xCE','&#206;','\xCF','&#207;','\xD1','&#209;','\xD2','&#210;','\xD3','&#211;','\xD4','&#212;','\xD5','&#213;','\xD6','&#214;','\xD8','&#216;','\xD9','&#217;','\xDA','&#218;','\xDB','&#219;','\xDC','&#220;','\xDF','&#223;','\xE0','&#224;','\xE1','&#225;','\xE2','&#226;','\xE3','&#227;','\xE4','&#228;','\xE5','&#229;','\xE6','&#230;','\xE7','&#231;','\xE8','&#232;','\xE9','&#233;','\xEA','&#234;','\xEB','&#235;','\xEC','&#236;','\xED','&#237;','\xEE','&#238;','\xEF','&#239;','\xF1','&#241;','\xF2','&#242;','\xF3','&#243;','\xF4','&#244;','\xF5','&#245;','\xF6','&#246;','\xF7','&#247;','\xF8','&#248;','\xF9','&#249;','\xFA','&#250;','\xFB','&#251;','\xFC','&#252;','\xFF','&#255;','"','&#34;','&','&#38;','\'','&#39;','<','&#60;','>','&#62;','\u2013','&#8211;','\u2014','&#8212;','\u20AC','&#8364;','`','&#96;','\xC1','&#193;','\xE1','&#225;','\xC2','&#194;','\xE2','&#226;','\xC6','&#198;','\xE6','&#230;','\xC0','&#192;','\xE0','&#224;','&','&amp;','\'','&apos;','\xC5','&#199;','\xE5','&#229;','\xC3','&#195;','\xE3','&#227;','\xC4','&#196;','\xE4','&#228;','\xC7','&#199;','\xE7','&#231;','\xA2','&#162;','\xA9','&#169;','\xF7','&#247;','\xC9','&#201;','\xE9','&#233;','\xCA','&#202;','\xEA','&#234;','\xC8','&#200;','\xE8','&#232;','\xCB','&#203;','\xEB','&#235;','\u20AC','&#8364;','>','&gt;','\xCD','&#205;','\xED','&#237;','\xCE','&#206;','\xEE','&#238;','\xA1','&#161;','\xCC','&#204;','\xEC','&#236;','\xBF','&#191;','\xCF','&#207;','\xEF','&#239;','\xAB','&#171;','<','&lt;','\u2014','&#8212;','\xB5','&#181;','\xB7','&#183;','\xA0','&nbsp;','\u2013','&#8211;','\xD1','&#209;','\xF1','&#241;','\xD3','&#211;','\xF3','&#243;','\xD4','&#212;','\xF4','&#244;','\xD2','&#210;','\xF2','&#242;','\xD8','&#216;','\xF8','&#248;','\xD5','&#213;','\xF5','&#245;','\xD6','&#214;','\xF6','&#246;','\xB6','&#182;','\xB1','&#177;','\xA3','&#163;','"','&quot;','\xBB','&#187;','\xAE','&#174;','\xA7','&#167;','\xDF','&#223;','\xDA','&#218;','\xFA','&#250;','\xDB','&#219;','\xFB','&#251;','\xD9','&#217;','\xF9','&#249;','\xDC','&#220;','\xFC','&#252;','\xA5','&#165;','\xFF','&#255;');TP.XML_ENTITIES_TO_HTML_ENTITIES=TP.hc('#193','&aacute;','#194','&acirc;','#198','&aelig;','#192','&agrave;','#38','&amp;','#197','&aring;','#195','&atilde;','#196','&auml;','#199','&ccedil;','#162','&cent;','#169','&copy;','#247','&divide;','#201','&eacute;','#202','&ecirc;','#200','&egrave;','#203','&euml;','#8364','&euro;','#205','&iacute;','#206','&icirc;','#161','&iexcl;','#204','&igrave;','#191','&iquest;','#207','&iuml;','#171','&laquo;','#8212','&mdash;','#181','&micro;','#183','&middot;','#160','&nbsp;','#8211','&ndash;','#209','&ntilde;','#211','&oacute;','#212','&ocirc;','#210','&ograve;','#216','&oslash;','#213','&otilde;','#214','&ouml;','#182','&para;','#177','&plusmn;','#163','&pound;','#187','&raquo;','#174','&reg;','#167','&sect;','#223','&szlig;','#218','&uacute;','#219','&ucirc;','#217','&ugrave;','#220','&uuml;','#165','&yen;','#255','&yuml;');TP.HTML_DOM_NAMES=TP.hc('a','HTMLAnchorElement','applet','HTMLAppletElement','area','HTMLAreaElement','br','HTMLBrElement','base','HTMLBaseElement','basefont','HTMLBaseFontElement','body','HTMLBodyElement','button','HTMLButtonElement','dl','HTMLDListElement','dir','HTMLDirectoryElement','div','HTMLDivElement','embed','HTMLEmbedElement','fieldset','HTMLFieldsetElement','font','HTMLFontElement','form','HTMLFormElement','frame','HTMLFrameElement','frameset','HTMLFramesetElement','hr','HTMLHrElement','head','HTMLHeadElement','h1','HTMLHeadingElement','h2','HTMLHeadingElement','h3','HTMLHeadingElement','h4','HTMLHeadingElement','h5','HTMLHeadingElement','h6','HTMLHeadingElement','html','HTMLHtmlElement','iframe','HTMLIframeElement','img','HTMLImageElement','input','HTMLInputElement','isindex','HTMLIsIndexElement','li','HTMLLIElement','label','HTMLLabelElement','legend','HTMLLegendElement','link','HTMLLinkElement','map','HTMLMapElement','menu','HTMLMenuElement','meta','HTMLMetaElement','mod','HTMLModElement','ol','HTMLOListElement','object','HTMLObjectElement','option','HTMLOptionElement','optgroup','HTMLOptGroupElement','p','HTMLParagraphElement','param','HTMLParamElement','pre','HTMLPreElement','q','HTMLQuoteElement','script','HTMLScriptElement','select','HTMLSelectElement','span','HTMLSpanElement','style','HTMLStyleElement','caption','HTMLTableCaptionElement','td','HTMLTableCellElement','col','HTMLTableColElement','table','HTMLTableElement','tr','HTMLTableRowElement','tbody','HTMLTableSectionElement','textarea','HTMLTextAreaElement','title','HTMLTitleElement','ul','HTMLUListElement');TP.sys.defineMethod('getNativeTypes',function(){var a;if(TP.isValid(TP.sys.$nativeTypes)){return TP.sys.$nativeTypes;}a=TP.sys.$extraglobals.getKeys().select(function(a){return TP.isNativeType(TP.global[a]);});TP.sys.$nativeTypes=TP.hc();a.perform(function(a){TP.sys.$nativeTypes.atPut(a,TP.global[a]);});return TP.sys.$nativeTypes;});TP.definePrimitive('htmlEntitiesToLiterals',function(a){if(!TP.regex.ML_ENTITY.test(a)){return a;}return a.replace(/&([a-zA-Z#0-9]+);/g,function(b,c){var a;a=TP.HTML_ENTITIES_TO_LITERALS.at(c);return TP.ifInvalid(a,b);});});TP.definePrimitive('htmlLiteralsToEntities',function(c,d){var b,a;if(TP.regex.NON_UTF8_CHARS.test(c)){if(TP.notValid(b=TP.regex.$$HTML_LITERALS_TO_ENTITIES)){b=TP.rc(TP.keys(TP.HTML_LITERALS_TO_ENTITIES).join('|'),'g');TP.regex.$$HTML_LITERALS_TO_ENTITIES=b;}a=c.replace(b,function(a){return TP.HTML_LITERALS_TO_ENTITIES.at(a);});}else{a=c.replace(/[<>'"]/g,function(a){switch(a){case'<':return'&lt;';case'>':return'&gt;';case'\'':return'&apos;';case'"':return'&quot;';default:break;}});a=a.replace(/&(?!([a-zA-Z]+|#[0-9]+);)/g,'&amp;');}a=d?a.replace(/ /g,'&nbsp;'):a;return a;});TP.definePrimitive('xmlEntitiesToLiterals',function(a){if(!TP.regex.ML_ENTITY.test(a)){return a;}return a.replace(/&([a-zA-Z#0-9]+);/g,function(b,c){var a;a=TP.XML_ENTITIES_TO_LITERALS.at(c);return TP.ifInvalid(a,b);});});TP.definePrimitive('xmlLiteralsToEntities',function(c,d){var b,a;if(TP.regex.NON_UTF8_CHARS.test(c)){if(TP.notValid(b=TP.regex.$$XML_LITERALS_TO_ENTITIES)){b=TP.rc(TP.keys(TP.XML_LITERALS_TO_ENTITIES).join('|'),'g');TP.regex.$$XML_LITERALS_TO_ENTITIES=b;}a=c.replace(b,function(a){return TP.XML_LITERALS_TO_ENTITIES.at(a);});}else{a=c.replace(/[<>'"]/g,function(a){switch(a){case'<':return'&lt;';case'>':return'&gt;';case'\'':return'&apos;';case'"':return'&quot;';default:break;}});a=a.replace(/&(?!([a-zA-Z]+|#[0-9]+);)/g,'&amp;');}a=d?a.replace(/ /g,'&#160;'):a;return a;});TP.definePrimitive('htmlEntitiesToXmlEntities',function(a){if(!TP.regex.ML_ENTITY.test(a)){return a;}return a.replace(/&([a-zA-Z#0-9]+);/g,function(b,c){var a;a=TP.HTML_ENTITIES_TO_XML_ENTITIES.at(c);return TP.ifInvalid(a,b);});});TP.definePrimitive('xmlEntitiesToHtmlEntities',function(a){if(!TP.regex.ML_ENTITY.test(a)){return a;}return a.replace(/&([a-zA-Z#0-9]+);/g,function(b,c){var a;a=TP.XML_ENTITIES_TO_HTML_ENTITIES.at(c);return TP.ifInvalid(a,b);});});TP.definePrimitive('regExpEscape',function(a){TP.regex.REGEX_ESCAPE.lastIndex=0;return a.replace(TP.regex.REGEX_ESCAPE,'\\$1');});TP.definePrimitive('regExpConstruct',function(c,d,e){var a,b;a=TP.ifInvalid(d,'');b=TP.ifInvalid(e,'');return new RegExp(a+'('+c.join('|')+')'+b);});TP.definePrimitive('getNextWindowName',function(){TP.sys.$$windowCount++;return'window_'+TP.sys.$$windowCount;});TP.definePrimitive('escapeTypeName',function(a){if(!TP.isString(a)){return;}return a.replace(/\./g,'_');});TP.definePrimitive('escapeMethodName',function(a){if(!TP.isString(a)){return;}return a.replace(/\ /g,'_');});TP.definePrimitive('unescapeMethodName',function(a){if(!TP.isString(a)){return;}return a.replace(/\_/g,' ');});TP.definePrimitive('unescapeTypeName',function(a){if(!TP.isString(a)){return;}return a.replace(/\_/g,'.');});TP.definePrimitive('expandSignalName',function(a){var c,b,d;if(TP.isEmpty(a)){return'';}if(/__/.test(a)){d=TP.ac();c=a.split('__');for(b=0;b<c.length;b++){d.push(TP.expandSignalName(c.at(b)));}return d.join('__');}if(/^TP\.(.+)/.test(a)){return a;}else if(/\.(.+)/.test(a)){return'TP.'+a;}return'TP.sig.'+a;});TP.definePrimitive('contractSignalName',function(a){var c,b,d;if(TP.isEmpty(a)){return'';}if(/__/.test(a)){d=TP.ac();c=a.split('__');for(b=0;b<c.length;b++){d.push(TP.contractSignalName(c.at(b)));}return d.join('__');}if(/\.(.+)/.test(a)){return a.slice(a.lastIndexOf('.')+1);}return a;});TP.definePrimitive('eventAsHTMLString',function(d){var a,c,e,b;a=TP.ac();c=TP.keys(d);e=c.length;a.push('<span',' class="Event ',TP.escapeTypeName(TP.tname(d)),'">');for(b=0;b<e;b++){try{a.push('<span data-name="',c[b],'">',TP.htmlstr(d[c[b]]),'</span>');}catch(d){a.push('<span data-name="',c[b],'">',TP.htmlstr(undefined),'</span>');}}a.push('</span>');return a.join('').toString();});TP.definePrimitive('eventAsJSONSource',function(d){var a,c,e,b;a=TP.ac();c=TP.keys(d);e=c.length;a.push('{"type":"',TP.tname(d),'","data":{');for(b=0;b<e;b++){try{a.push(c[b].quoted('"'),':',TP.json(d[c[b]]));}catch(d){a.push(c[b].quoted('"'),':"undefined"');}finally{a.push(',');}}a.pop();a.push('}}');return a.join('').toString();});TP.definePrimitive('eventAsPrettyString',function(d){var a,c,e,b;a=TP.ac();c=TP.keys(d);e=c.length;a.push('<dl class="pretty ',TP.escapeTypeName(TP.tname(d)),'">','<dt>Type name</dt>','<dd class="pretty typename">',TP.tname(d),'</dd>');for(b=0;b<e;b++){try{a.push('<dt class="pretty key">',c[b],'</dt>','<dd>',TP.pretty(d[c[b]]),'</dd>');}catch(d){a.push('<dt class="pretty key">',c[b],'</dt>','<dd>',TP.pretty(undefined),'</dd>');}}a.push('</dl>');return a.join('').toString();});TP.definePrimitive('eventAsSource',function(d){var a,e,c,f,b;a=TP.ac();if(TP.isNode(e=d.target)){a.push('TP.documentCreateEvent(',TP.gid(TP.nodeGetWindow(e)),'.document,');}else{a.push('TP.documentCreateEvent(top.document, ');}c=TP.keys(d);f=c.length;a.push('TP.hc(');for(b=0;b<f;b++){try{a.push(c[b],', ',TP.src(d[c[b]]),', ');}catch(d){a.push(c[b],', ','undefined',', ');}}a.pop();a.push(')');return a.join('').toString();});TP.definePrimitive('eventAsString',function(d){var a,c,e,b;a=TP.ac();c=TP.keys(d);e=c.length;a.push(TP.eventGetType(d),' : ','(');for(b=0;b<e;b++){try{a.push(c[b],' => ',TP.str(d[c[b]]),', ');}catch(d){a.push(c[b],' => undefined',', ');}}a.pop();a.push(')');return a.join('').toString();});TP.definePrimitive('eventAsXMLString',function(d){var a,c,e,b;a=TP.ac();c=TP.keys(d);e=c.length;a.push('<event',' typename="',TP.tname(d),'"');for(b=0;b<e;b++){try{a.push(' ',c[b],'="',TP.xmlstr(d[c[b]]),'"');}catch(d){a.push(' ',c[b],'="undefined"');}}a.push('/>');return a.join('').toString();});TP.definePrimitive('objectGlobalID',function(f,n){var i,a,m,e,d,g,c,b,h,j,k,l;if(f===null){return'null';}else if(f===undefined){return'undefined';}if(!TP.isMutable(f)){return TP.str(f);}i=TP.ifInvalid(n,false);if(TP.isKindOf(f,TP.core.Node)){a=TP.unwrap(f);}else{a=f;}if(TP.isElement(a)){b=TP.elementGetAttribute(a,TP.GLOBAL_ID_ATTR,true);if(TP.notEmpty(b)){return encodeURI(b);}c=TP.lid(a,i);if(TP.isEmpty(c)){return;}m=TP.nodeGetDocument(a);if(TP.isDocument(m)){g=TP.objectGlobalID(m,i);if(TP.notEmpty(g)){return g.replace(/#.+/,'#'+c);}}return;}if(TP.isDocument(a)){e=TP.nodeGetWindow(a);if(TP.isWindow(e)){if(TP.isEmpty(b=e.$$globalID)){h=TP.windowGetParentNames(e);c=TP.lid(e,i);if(TP.isEmpty(c)){c=TP.lid(e,true);}h.push(c);b=h.join('.');e.$$globalID=b;}g='tibet://'+b+'/';}else{g='tibet:///';}d=TP.documentGetLocation(a)||'';if(TP.isEmpty(d)){k=a.documentElement;if(TP.isElement(k)){if(TP.notEmpty(j=TP.elementGetAttribute(k,TP.GLOBAL_DOCID_ATTR,true))){d='#'+j;}else if(TP.isTrue(n)){TP.regex.INVALID_ID_CHARS.lastIndex=0;j=TP.genID().replace('$','document_').replace(TP.regex.INVALID_ID_CHARS,'_');TP.elementSetAttribute(k,TP.GLOBAL_DOCID_ATTR,j,true);d='#'+j;}else{d='';}}else{d='';}}if(TP.regex.URI_FRAGMENT.test(d)){return encodeURI(g+d);}else{return encodeURI(g+d+'#document');}}if(TP.isNode(a)){if(TP.isAttributeNode(a)){b='xpath1(./@'+TP.attributeGetLocalName(a)+')';if(TP.isElement(l=TP.attributeGetOwnerElement(a))){b=TP.lid(l)+b;}return b;}else if(TP.isTextNode(a)){b='xpath1(./text()[contains(.,\''+TP.nodeGetTextContent(a)+'\')])';}else if(TP.isCDATASectionNode(a)){b='xpath1(./text()[contains(.,\''+TP.nodeGetTextContent(a)+'\')])';}else if(TP.isPINode(a)){b='xpath1(./processing-instruction(\''+TP.name(a)+'\'))';}else if(TP.isCommentNode(a)){b='xpath1(./comment()[1])';}else if(TP.isFragment(a)){b='#document-fragment';}if(TP.isElement(l=a.parentNode)){b=TP.gid(l)+b;}return b;}if(TP.isWindow(a)||TP.isKindOf(a,TP.core.Window)){a=TP.unwrap(a);h=TP.windowGetParentNames(a);c=TP.lid(a,i);if(TP.isEmpty(c)){c=TP.lid(a,true);}h.push(c);b=h.join('.');return b;}if(TP.canInvoke(a,'getID')){return a.getID();}return TP.name(a);});TP.definePrimitive('gid',TP.objectGlobalID);TP.definePrimitive('objectLocalID',function(c,j){var f,a,b,g,i,e,d,h;if(c===null){return'null';}else if(c===undefined){return'undefined';}if(!TP.isMutable(c)){return TP.str(c);}f=TP.ifInvalid(j,false);if(TP.isKindOf(c,TP.core.Node)){a=TP.unwrap(c);}else{a=c;}if(TP.isElement(a)){if(TP.isEmpty(b=TP.elementGetAttribute(a,'id'))){if(f){if(TP.notEmpty(i=TP.elementGetAttribute(a,'tibet:pelem',true))){e=TP.nodeGetControlId(a,f);if(TP.notEmpty(e)){b=e+'_'+i;}}if(TP.isEmpty(b)){b=TP.elemGenID(a);}TP.elementSetAttribute(a,'id',b);}else{if(TP.isEmpty(b)){d=TP.nodeGetFirstElementAncestorByAttribute(a,'id');if(TP.notValid(d)){d=TP.nodeGetDocument(a).documentElement;if(TP.notValid(d)){this.raise('TP.sig.DetachedNodeException',arguments,a);return;}}e=TP.elementGetAttribute(d,'id');if(TP.isEmpty(e)){b='element('+TP.elementGetDocumentIndex(a)+')';}else{b=TP.join('element(',e,'/',TP.elementGetDocumentIndex(a).replace(TP.elementGetDocumentIndex(d)+'/',''),')');}}}}return b;}if(TP.isDocument(a)){return'document';}if(TP.isNode(a)){if(TP.isAttributeNode(a)){b='xpath1(./@'+TP.attributeGetLocalName(a)+')';if(TP.isElement(h=TP.attributeGetOwnerElement(a))){b=TP.lid(h)+b;}return b;}else if(TP.isTextNode(a)){b='xpath1(./text()[contains(.,\''+TP.nodeGetTextContent(a)+'\')])';}else if(TP.isCDATASectionNode(a)){b='xpath1(./text()[contains(.,\''+TP.nodeGetTextContent(a)+'\')])';}else if(TP.isPINode(a)){b='xpath1(./processing-instruction(\''+TP.name(a)+'\'))';}else if(TP.isCommentNode(a)){b='xpath1(./comment()[1])';}else if(TP.isFragment(a)){b='#document-fragment';}if(TP.isElement(h=a.parentNode)){b=TP.lid(h)+b;}return b;}if(TP.isWindow(a)||TP.isKindOf(a,TP.core.Window)){a=TP.unwrap(a);try{g=a.frameElement;}catch(a){g=null;}if(TP.isElement(g)){b=TP.elementGetAttribute(g,'id');if(TP.isEmpty(b)){if(f){TP.regex.INVALID_ID_CHARS.lastIndex=0;b=TP.genID().replace('$','ID_').replace(TP.regex.INVALID_ID_CHARS,'_');TP.elementSetAttribute(g,'id',b);}}return b;}b=a.name;if(TP.isEmpty(b)){if(f){if(a===window.top){b='top';}else{b=TP.getNextWindowName();}try{a.name=b;}catch(a){return null;}}return;}return b;}if(TP.canInvoke(a,'getID')){return a.getID();}return TP.name(a);});TP.definePrimitive('lid',TP.objectLocalID);TP.definePrimitive('objectID',function(a,b){if(TP.notDefined(a)){return'undefined';}if(TP.isNull(a)){return'null';}if(!TP.isMutable(a)){return TP.str(a);}return TP.gid(a,b);});TP.definePrimitive('id',TP.objectID);TP.definePrimitive('objectName',function(a){if(TP.notDefined(a)){return'undefined';}if(TP.isNull(a)){return'null';}if(TP.isNonFunctionConstructor(a)){return TP.getNonFunctionConstructorName(a);}if(!TP.isMutable(a)){return TP.str(a);}if(TP.isNode(a)){if(TP.isElement(a)){return TP.elementGetCanonicalName(a);}else if(TP.isTextNode(a)){return'#text';}else if(TP.isDocument(a)){return'#document';}else if(TP.isAttributeNode(a)){return TP.attributeGetCanonicalName(a);}else if(TP.isFragment(a)){return'#document-fragment';}else if(TP.isCommentNode(a)){return'#comment';}else if(TP.isCDATASectionNode(a)){return'#cdata-section';}else if(TP.isPINode(a)){return a.nodeName;}}if(TP.isWindow(a)){return a.name;}if(TP.canInvoke(a,'getName')){return a.getName();}else if(TP.isFunction(a)){return TP.getFunctionName(a);}try{return TP.FunctionProto.$getOID.call(a);}catch(a){}return;});TP.definePrimitive('name',TP.objectName);TP.definePrimitive('elemGenID',function(c,e){var b,d,a;b=TP.unwrap(c);d=TP.ifInvalid(e,false);if(TP.isEmpty(a=TP.elementGetAttribute(b,'id',true))){TP.regex.INVALID_ID_CHARS.lastIndex=0;a=TP.genID(TP.elementGetFullName(c)).replace(TP.regex.INVALID_ID_CHARS,'_');if(d){TP.elementSetAttribute(b,'id',a,true);}}return a;});TP.definePrimitive('nsuri',function(b){var a;a=TP.unwrap(b);if(!TP.isNode(a)){return;}return TP.nodeGetNSURI(a);});TP.definePrimitive('objectCopy',function(a,b){var c;if(TP.notValid(a)||TP.isWindow(a)){return;}else if(TP.isNode(a)){return TP.nodeCloneNode(a,TP.isTrue(b)?false:true);}else if(TP.canInvoke(a,'copy')){return a.copy(b);}else if(TP.isEvent(a)){if(TP.isDocument(c=TP.eventGetTarget(a).document)){return TP.documentCreateEvent(c,a);}}return;});TP.definePrimitive('copy',TP.objectCopy);TP.definePrimitive('format',function(a,b,c){var d;if(TP.isEmpty(b)){return a;}if(TP.notValid(a)){if(TP.canInvoke(b,'transform')){return b.transform(a,c);}return;}TP.debug('break.format');if(TP.isValid(c)&&TP.notFalse(c.at('shouldWrap'))){d=TP.wrap(a);}else{d=a;}if(TP.canInvoke(d,'as')){return d.as(b,c);}if(TP.canInvoke(b,'transform')){return b.transform(a,c);}return;});TP.definePrimitive('objectHTMLNode',function(a,c){var b;if(TP.notValid(a)){return;}b=TP.isHTMLDocument(c)?c:TP.sys.getUICanvas().getNativeDocument();if(TP.isNode(a)){return TP.nodeAsHTMLNode(a,b);}if(TP.canInvoke(a,'asHTMLNode')){return a.asHTMLNode(b);}return b.createTextNode(TP.str(a));});TP.definePrimitive('htmlnode',TP.objectHTMLNode);TP.definePrimitive('objectHTMLString',function(a){var c,d,b,e;if(a===null){return'null';}else if(a===undefined){return'undefined';}if(TP.isXHR(a)){return'<span class="XHR">'+'<span data-name="status">'+a.status+'</span>'+'<span data-name="responseText">'+TP.htmlstr(a.responseText)+'</span>'+'</span>';}if(TP.isNode(a)){return TP.nodeAsHTMLString(a);}if(TP.isError(a)){return'<span class="Error" data-name="message">'+TP.str(a.message)+'</span>';}if(TP.isString(a)){return a;}if(TP.isNumber(a)){return TP.str(a);}if(!TP.isMutable(a)){return TP.str(a);}if(TP.isWindow(a)){return TP.windowAsHTMLString(a);}if(TP.isEvent(a)){return TP.eventAsHTMLString(a);}if(TP.isNodeList(a)){c=TP.ac();d=a.length;c.push('<span class="NodeList">');for(b=0;b<d;b++){c.push('<span data-name="',b,'">',TP.htmlstr(a[b]),'</span>');}c.push('</span>');return c.join('');}if(TP.isNamedNodeMap(a)){c=TP.ac();d=a.length;c.push('<span class="NamedNodeMap">');for(b=0;b<d;b++){c.push('<span data-name="key">',TP.name(a.item(b)),'</span>','<span data-name="value">',TP.val(a.item(b)),'</span>');}c.push('</span>');return c.join('');}if(TP.isStyleSheet(a)){e=TP.styleSheetGetStyleRules(a,false);c=TP.ac();d=e.length;for(b=0;b<d;b++){c.push(TP.htmlstr(e[b]));}return'<span class="CSSStyleSheet">'+c.join(' ')+'</span>';}if(TP.isStyleRule(a)){return'<span class="CSSStyleRule">'+a.cssText+'</span>';}if(TP.isStyleDeclaration(a)){return'<span class="CSSStyleDeclaration">'+a.cssText+'</span>';}if(TP.canInvoke(a,'asHTMLString')){return a.asHTMLString();}return TP.str(a);});TP.definePrimitive('htmlstr',TP.objectHTMLString);TP.definePrimitive('objectJSONString',function(a){var b,d,c,e;if(a===null){return'null';}else if(a===undefined){return'"undefined"';}if(TP.isXHR(a)){return'{"type":"XHR",'+'"data":{'+'"status":'+a.status.quoted('"')+','+'"content":'+TP.json(a.responseText)+'}}';}if(TP.isNode(a)){return'{"type":"'+TP.tname(a)+'",'+'"data":'+TP.xml2json(a)+'}';}if(TP.isError(a)){return'{"type":"'+TP.tname(a)+'",'+'"data":'+a.message.quoted('"')+'}';}if(TP.isString(a)){return a.quoted('"');}if(TP.isNumber(a)||TP.isBoolean(a)){return TP.objectToString(a);}if(!TP.isMutable(a)){return TP.objectToString(a).quoted('"');}if(TP.isWindow(a)){return TP.windowAsJSONSource(a);}if(TP.isEvent(a)){return TP.eventAsJSONSource(a);}if(TP.isNodeList(a)){b=TP.ac();b.push('{"type":"NodeList","data":[');d=a.length;for(c=0;c<d;c++){b.push(TP.json(a[c]),',');}b.pop();b.push(']}');return b.join('');}if(TP.isNamedNodeMap(a)){b=TP.ac();b.push('{"type":"NamedNodeMap","data":{');d=a.length;for(c=0;c<d;c++){b.push('"',TP.name(a.item(c)),'":"',TP.val(a.item(c)),'"',',');}b.pop();b.push('}}');return b.join('');}if(TP.isStyleSheet(a)){e=TP.styleSheetGetStyleRules(a,false);b=TP.ac();d=e.length;for(c=0;c<d;c++){b.push(TP.json(e[c]));}return'{"type":"Stylesheet","data":['+b.join(',')+']}';}if(TP.isStyleRule(a)){return'{"type":"Rule","data":"'+a.cssText+'"}';}if(TP.isStyleDeclaration(a)){return'{"type":"Declaration","data":"'+a.cssText+'"}';}if(TP.canInvoke(a,'asJSONSource')){return a.asJSONSource();}return TP.js2json(a);});TP.definePrimitive('json',TP.objectJSONString);TP.definePrimitive('objectKeys',function(a){if(TP.notValid(a)){return;}if(TP.canInvoke(a,'getKeys')){return a.getKeys();}if(TP.isNode(a)){if(TP.isXMLDocument(a)){return TP.sys.$documentkeys;}else if(TP.isXMLNode(a)&&TP.isElement(a)){return TP.sys.$elementkeys;}else{return TP.sys.$nodekeys;}}else if(TP.isWindow(a)){return TP.sys.$windowkeys;}else if(TP.isEvent(a)){return TP.eventGetPropertyKeys(a);}return TP.$getOwnKeys(a);});TP.definePrimitive('keys',TP.objectKeys);TP.definePrimitive('objectLocation',function(a){var b;if(TP.notValid(a)){return;}if(TP.isString(a)){b=a;}else if(TP.canInvoke(a,'getLocation')){b=a.getLocation();}else{b=TP.objectGetSourcePath(a);}return TP.uriExpandPath(b);});TP.definePrimitive('loc',TP.objectLocation);TP.definePrimitive('parse',function(d,b,c){var a;if(!TP.isType(a=TP.sys.require(d))){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(!TP.canInvoke(a,'parse')){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(!TP.isString(b)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(a===Date){return new Date(a.parse(b,c));}else{return a.parse(b,c);}});TP.definePrimitive('process',function(a,c){var b;if(TP.notValid(a)||a===''){return a;}b=TP.wrap(a);if(TP.canInvoke(b,'process')){return b.process(c);}b=TP.canInvoke(a,'process')?a:TP.val(a);if(TP.canInvoke(b,'process')){return b.process(c);}return a;});TP.definePrimitive('processAndExecuteWith',function(a,c,d){var b;if(TP.notValid(a)||a===''){return a;}b=TP.wrap(a);if(TP.canInvoke(b,'processAndExecuteWith')){return b.processAndExecuteWith(c,d);}b=TP.canInvoke(a,'processAndExecuteWith')?a:TP.val(a);if(TP.canInvoke(b,'processAndExecuteWith')){return b.processAndExecuteWith(c,d);}return a;});TP.definePrimitive('objectSize',function(a){if(TP.notValid(a)){return TP.NO_SIZE;}if(TP.canInvoke(a,'getSize')){return a.getSize();}if(TP.owns(a,'length')){return a.length;}return TP.NO_SIZE;});TP.definePrimitive('size',TP.objectSize);TP.definePrimitive('objectSourceValue',function(a){if(a===null){return'null';}else if(a===undefined){return'undefined';}if(TP.isXHR(a)){return TP.NO_SOURCE_REP;}if(TP.isNode(a)){if(TP.isDocument(a)){return'TP.doc('+TP.nodeAsString(a).quoted()+')';}else if(TP.isElement(a)){return'TP.elem('+TP.nodeAsString(a).quoted()+')';}else if(TP.isFragment(a)){return'TP.frag('+TP.nodeAsString(a).quoted()+')';}else{return'TP.node('+TP.nodeAsString(a).quoted()+')';}}if(TP.isError(a)){return'new Error('+a.message.quoted()+')';}if(TP.isString(a)){return a.quoted();}if(!TP.isMutable(a)){return TP.str(a);}if(TP.isWindow(a)){return'TP.open("'+a.document.location+'", "'+a.name+'")';}if(TP.isEvent(a)){return TP.eventAsSource(a);}if(TP.isNodeList(a)){return TP.NO_SOURCE_REP;}if(TP.isNamedNodeMap(a)){return TP.NO_SOURCE_REP;}if(TP.isStyleSheet(a)){return TP.NO_SOURCE_REP;}if(TP.isStyleRule(a)){return TP.NO_SOURCE_REP;}if(TP.isStyleDeclaration(a)){return TP.NO_SOURCE_REP;}if(TP.canInvoke(a,'asSource')){return a.asSource();}if(TP.canInvoke(a,'toString')){return TP.js2json(a);}return TP.NO_SOURCE_REP;});TP.definePrimitive('src',TP.objectSourceValue);TP.definePrimitive('objectStringValue',function(a,h){var f,c,d,e,b,g;if(a===null){return'null';}else if(a===undefined){return'undefined';}c=TP.ifInvalid(h,true);if(TP.isXHR(a)){if(c){return TP.tname(a)+' :: '+a.status+' : '+a.responseText;}else{return TP.objectToString(a);}}if(TP.isNode(a)){if(c){return TP.nodeAsString(a);}else{return TP.objectToString(a);}}if(TP.isError(a)){if(c){return TP.tname(a)+' :: '+TP.errorAsString(a);}else{return TP.objectToString(a);}}if(TP.isString(a)){return a;}if(!TP.isMutable(a)){return TP.objectToString(a);}if(TP.isWindow(a)){if(c){return TP.windowAsString(a);}else{return TP.gid(a);}}if(TP.isEvent(a)){if(c){return TP.tname(a)+' :: '+TP.eventAsString(a);}else{return TP.objectToString(a);}}if(TP.isNodeList(a)){if(c){d=TP.ac();e=a.length;for(b=0;b<e;b++){d.push(TP.str(a[b]));}return TP.tname(a)+' :: '+'['+d.join(', ')+']';}else{return TP.objectToString(a);}}if(TP.isNamedNodeMap(a)){if(c){d=TP.ac();e=a.length;for(b=0;b<e;b++){d.push(TP.name(a.item(b))+': '+TP.val(a.item(b)));}return TP.tname(a)+' :: '+'{'+d.join(', ')+'}';}else{return TP.objectToString(a);}}if(TP.isStyleSheet(a)){if(c){g=TP.styleSheetGetStyleRules(a,false);d=TP.ac();e=g.length;for(b=0;b<e;b++){d.push(g[b].cssText);}return TP.tname(a)+' :: '+d.join(' ');}else{return TP.objectToString(a);}}if(TP.isStyleRule(a)){if(c){return TP.tname(a)+' :: '+a.cssText;}else{return TP.objectToString(a);}}if(TP.isStyleDeclaration(a)){if(c){return TP.tname(a)+' :: '+a.cssText;}else{return TP.objectToString(a);}}if(TP.canInvoke(a,'asString')){f=a.asString(c);if(TP.regex.NATIVE_CODE.test(f)){f=TP.tname(a);}return f;}return TP.META_INST_OWNER.meta_methods.asString.call(a);});TP.definePrimitive('str',TP.objectStringValue);TP.definePrimitive('objectValue',function(a,d,e){var c,b;if(a===null){return null;}else if(a===undefined){return undefined;}if(TP.isType(a)){return a;}if(TP.isNaN(a)){return NaN;}if(TP.isCallable(d)){return d(a);}if(TP.isEmpty(d)){if(TP.isString(a)){return''+a;}if(!TP.isMutable(a)){return a;}c='value';}else if(TP.regex.NON_SIMPLE_PATH.test(d)){c=TP.apc(d);}else{c=d;}b=null;if(TP.isNode(a)){b=TP.tpnode(a).get(c);}if(TP.isWindow(a)){if(c==='value'){return a;}b=TP.tpwin(a).get(c);}if(TP.notValid(b)&&TP.canInvoke(a,'get')){b=a.get(c);}if(TP.notValid(b)){try{b=a[c];}catch(a){}}if(TP.isValid(b)){return TP.isArray(b)&&b.getSize()===1&&TP.isTrue(e)?b.at(0):b;}if(c==='value'){return a;}return null;});TP.definePrimitive('val',TP.objectValue);TP.definePrimitive('objectXHTMLNode',function(a,c){var b;if(TP.notValid(a)){return;}if(TP.isString(a)){return TP.node(a,TP.w3.Xmlns.XHTML);}if(TP.isXMLNode(a)){return a;}b=TP.isXMLDocument(c)?c:TP.XML_FACTORY_DOCUMENT;if(TP.isHTMLNode(a)){return TP.htmlNodeAsXHTMLNode(a,b);}if(TP.canInvoke(a,'asXHTMLNode')){return a.asXHTMLNode(b);}return b.createTextNode(TP.str(a));});TP.definePrimitive('xhtmlnode',TP.objectXHTMLNode);TP.definePrimitive('objectXHTMLString',function(a){if(TP.notValid(a)){return;}if(TP.isXMLNode(a)){return TP.nodeAsString(a);}if(TP.isHTMLNode(a)){return TP.htmlNodeAsXHTMLString(a);}if(TP.canInvoke(a,'asXHTMLString')){return a.asXHTMLString();}return TP.str(a);});TP.definePrimitive('xhtmlstr',TP.objectXHTMLString);TP.definePrimitive('objectXMLNode',function(a,c){var b;if(TP.notValid(a)){return;}if(TP.isString(a)){return TP.node(a);}b=TP.isXMLDocument(c)?c:TP.XML_FACTORY_DOCUMENT;if(TP.isNode(a)){return TP.nodeAsXMLNode(a,b);}if(TP.canInvoke(a,'asXMLNode')){return a.asXMLNode(b);}return b.createTextNode(TP.str(a));});TP.definePrimitive('xmlnode',TP.objectXMLNode);TP.definePrimitive('objectXMLString',function(a){var c,d,b,e;if(a===null){return'null';}else if(a===undefined){return'undefined';}if(TP.isXHR(a)){return'<xhr>'+'<status>'+a.status+'</status>'+'<content>'+TP.xmlstr(a.responseText)+'</content>'+'</xhr>';}if(TP.isNode(a)){return TP.nodeAsXMLString(a);}if(TP.isError(a)){return'<error>'+'<type>'+TP.tname(a)+'</type>'+'<message>'+TP.str(a.message)+'</message>'+'</error>';}if(TP.isString(a)){return a;}if(TP.isNumber(a)){return a.asXMLString();}if(!TP.isMutable(a)){return TP.objectToString(a);}if(TP.isWindow(a)){return TP.windowAsXMLString(a);}if(TP.isEvent(a)){return TP.eventAsXMLString(a);}if(TP.isNodeList(a)){c=TP.ac();d=a.length;for(b=0;b<d;b++){c.push('<node index="',b,'">',TP.xmlstr(a[b]),'</node>');}return c.join('');}if(TP.isNamedNodeMap(a)){c=TP.ac();d=a.length;for(b=0;b<d;b++){c.push('<',TP.name(a.item(b)),'>',TP.val(a.item(b)),'</',TP.name(a.item(b)),'>');}return c.join('');}if(TP.isStyleSheet(a)){e=TP.styleSheetGetStyleRules(a,false);c=TP.ac();d=e.length;for(b=0;b<d;b++){c.push(TP.xmlstr(e[b]));}return'<sheet>'+c.join(' ')+'</sheet>';}if(TP.isStyleRule(a)){return'<rule>'+a.cssText+'</rule>';}if(TP.isStyleDeclaration(a)){return'<declaration>'+a.cssText+'</declaration>';}if(TP.canInvoke(a,'asXMLString')){return a.asXMLString();}return TP.xmlLiteralsToEntities(TP.htmlEntitiesToXmlEntities(TP.str(a)));});TP.definePrimitive('xmlstr',TP.objectXMLString);TP.definePrimitive('windowAsHTMLString',function(d){var a,c,e,b;a=TP.ac();c=TP.sys.$windowkeys;e=c.length;a.push('<span class="DOMWindow" gid="',TP.gid(d),'">');for(b=0;b<e;b++){try{a.push('<span data-name="',c[b],'">',TP.htmlstr(d[c[b]]),'</span>');}catch(d){a.push('<span data-name="',c[b],'">',TP.htmlstr(undefined),'</span>');}}a.push('</span>');return a.join('').toString();});TP.definePrimitive('windowAsJSONSource',function(d){var a,c,e,b;a=TP.ac();c=TP.sys.$windowkeys;e=c.length;a.push('{"type":"DOMWindow","data":{');a.push('"gid":',TP.gid(d).quoted('"'));a.push(',');for(b=0;b<e;b++){try{a.push(c[b].quoted('"'),':',TP.json(d[c[b]]));}catch(d){a.push(c[b].quoted('"'),':"undefined"');}finally{a.push(',');}}a.pop();a.push('}}');return a.join('').toString();});TP.definePrimitive('windowAsPrettyString',function(d){var a,c,e,b;a=TP.ac();c=TP.sys.$windowkeys;e=c.length;a.push('<dl class="pretty ',TP.escapeTypeName(TP.tname(d)),'">','<dt>Type name</dt>','<dd class="pretty typename">',TP.tname(d),'</dd>');a.push('<dt class="pretty key">Global ID</dt>','<dd>',TP.gid(d),'</dd>');for(b=0;b<e;b++){try{a.push('<dt class="pretty key">',c[b],'</dt>','<dd>',TP.pretty(d[c[b]]),'</dd>');}catch(d){a.push('<dt class="pretty key">',c[b],'</dt>','<dd>',TP.pretty(undefined),'</dd>');}}a.push('</dl>');return a.join('').toString();});TP.definePrimitive('windowAsString',function(d){var b,c,e,a;b=TP.ac();c=TP.sys.$windowkeys;e=c.length;b.push(TP.gid(d));for(a=0;a<e;a++){try{b.push(c[a]+': '+TP.str(d[c[a]]));}catch(d){b.push(c[a]+': undefined');}}return b.join(', ').toString();});TP.definePrimitive('windowAsXMLString',function(d){var a,c,e,b;a=TP.ac();c=TP.sys.$windowkeys;e=c.length;a.push('<window');a.push(' gid="',TP.gid(d),'"');for(b=0;b<e;b++){try{a.push(' ',c[b],'="',TP.xmlstr(d[c[b]]),'"');}catch(d){a.push(' ',c[b],'="undefined"');}}a.push('/>');return a.join('').toString();});TP.definePrimitive('objectType',function(a){var b,c;if(TP.notValid(a)){return;}if(TP.canInvoke(a,'getType')){return a.getType();}if(TP.notEmpty(b=TP.objectTypeName(a))){if(TP.isValid(c=TP.global[b])){return c;}}return a.constructor;});TP.definePrimitive('type',TP.objectType);TP.definePrimitive('objectSuperType',function(a){var b;if(TP.notValid(a)){return;}if(TP.canInvoke(a,'getSuperType')){return a.getSuperType();}if(TP.isValid(b=a[TP.SUPER])){return b;}return null;});TP.definePrimitive('stype',TP.objectSuperType);TP.definePrimitive('objectTypeName',function(a){var b,c,d;if(TP.notDefined(a)){return'Undefined';}if(TP.isNull(a)){return'Null';}if(TP.isNativeType(a)){return'Function';}if(TP.canInvoke(a,'getTypeName')){return a.getTypeName();}b=a.constructor;if(TP.canInvoke(b,'getName')){return b.getName();}if(TP.notEmpty(c=TP.objectToString(a))&&TP.regex.NATIVE_TYPENAME_MATCH.test(c)){if(TP.notEmpty(d=c.match(TP.regex.NATIVE_TYPENAME_EXTRACT))){return d[1];}}return typeof b;});TP.definePrimitive('tname',TP.objectTypeName);TP.definePrimitive('objectSupertypes',function(b){var c,d,a;if(TP.notDefined(b)||TP.isNull(b)){return TP.ac();}if(TP.isNonFunctionConstructor(b)){return TP.ac(Object);}if(TP.isNativeType(b)){if(b===Function){return TP.ac(Object);}if(TP.isValid(a=b[TP.ANCESTORS])){return a;}d=b;a=TP.ac();while(TP.isValid(d=Object.getPrototypeOf(d))){if(d===TP.FunctionProto){continue;}if(d===TP.ObjectProto){a.push(Object);}else{a.push(d);}}return a;}if(TP.isType(b)){return b.getSupertypes();}c=TP.type(b);if(TP.isNonFunctionConstructor(c)){return TP.ac(Object);}if(TP.isNativeType(c)){if(TP.isValid(a=c[TP.ANCESTORS])){return a;}a=TP.stypes(c);a=a.slice(0,a.getSize()-2);if(c!==Object){a.push(Object);}return a;}if(TP.canInvoke(b,'getSupertypes')){return b.getSupertypes();}return TP.ac();});TP.definePrimitive('stypes',TP.objectSupertypes);TP.definePrimitive('objectSupertypeNames',function(b){var a;a=TP.stypes(b);return a.collect(function(a){return TP.name(a);});});TP.definePrimitive('stnames',TP.objectSupertypeNames);TP.definePrimitive('objectSetValue',function(d,e,c){var a,b,f;if(TP.notValid(d)){return;}if(TP.isType(d)){return;}if(TP.isNaN(d)){return;}if(!TP.isMutable(d)){return;}if(TP.isEmpty(e)){b='value';}else if(TP.regex.NON_SIMPLE_PATH.test(e)){b=TP.apc(e);}else{b=e;}a=TP.wrap(d);if(TP.canInvoke(a,'set')){return a.set(b,c);}if(TP.canInvoke(a,'atPut')){return a.atPut(b,c);}try{f=a[b];if(f===c){return a;}a[b]=c;if(a[b]===c){TP.signal(a,b+'Change');}}catch(d){if(a[b]===c){TP.signal(a,b+'Change');}}return a;});TP.definePrimitive('setval',TP.objectSetValue);TP.definePrimitive('validate',function(a,b){var c;if(TP.notValid(b)){return true;}if(TP.canInvoke(a,'isa')){return a.isa(b);}if(TP.isType(c=TP.sys.require(b))){if(TP.canInvoke(c,'validate')){return c.validate(a);}}return false;});TP.definePrimitive('objectUnwrap',function(a){var c,d,b,e;if(TP.notDefined(a)){return undefined;}if(TP.isNull(a)){return null;}if(TP.isType(a)){return a;}if(TP.isNodeList(a)||TP.isNamedNodeMap(a)){return a;}if(TP.canInvoke(a,'getNativeObject')){return a.getNativeObject();}if(TP.isArray(a)){c=TP.ac();d=a.length;for(b=0;b<d;b++){c.push(TP.unwrap(a.at(b)));}return c;}if(TP.isKindOf(a,TP.lang.Hash)){e=TP.keys(a);c=TP.hc();d=e.length;for(b=0;b<d;b++){c.atPut(e.at(b),TP.unwrap(a.at(e.at(b))));}return c;}return a;});TP.definePrimitive('unwrap',TP.objectUnwrap);TP.definePrimitive('objectWrap',function(a){var c,d,b,e,f,g;if(TP.notDefined(a)){return undefined;}if(TP.isNull(a)){return null;}if(TP.isType(a)){return a;}if(TP.isElement(a)){return TP.core.ElementNode.construct(a);}else if(TP.isDocument(a)){return TP.core.DocumentNode.construct(a);}else if(TP.isNode(a)){return TP.core.Node.construct(a);}if(TP.isArray(a)||TP.isNodeList(a)){c=TP.ac();d=a.length;for(b=0;b<d;b++){c.push(TP.wrap(a[b]));}return c;}if(TP.isKindOf(a,TP.lang.Hash)){e=TP.keys(a);c=TP.hc();d=e.length;for(b=0;b<d;b++){c.atPut(e.at(b),TP.wrap(a.at(e.at(b))));}return c;}if(TP.isNamedNodeMap(a)){c=TP.hc();d=a.length;for(b=0;b<d;b++){c.atPut(a.item(b).name,TP.wrap(a.item(b)));}return c;}if(TP.isWindow(a)){return TP.tpwin(a);}if(TP.isEvent(a)){if(TP.notEmpty(f=TP.DOM_SIGNAL_TYPE_MAP.at(TP.eventGetType(a)))){if(TP.isType(g=f.asType())){return g.construct(a);}}}return a;});TP.definePrimitive('wrap',TP.objectWrap);TP.definePrimitive('collapse',function(a){if(TP.notValid(a)){return;}if(TP.isNodeList(a)){return a[0];}if(TP.canInvoke(a,'collapse')){return a.collapse();}return a;});TP.definePrimitive('getPathType',function(b){var a;if(TP.isEmpty(a=b)){return TP.raise(this,'TP.sig.InvalidPath',arguments,'Unable to get type of empty path.');}if(TP.regex.HAS_ACP.test(a)){TP.regex.ACP_NUMERIC.lastIndex=0;a=a.replace(TP.regex.ACP_NUMERIC,TP.DEFAULT);if(TP.regex.HAS_ACP.test(a)){return this.raise('TP.sig.InvalidPath',arguments);}TP.regex.ACP_NUMERIC.lastIndex=0;a=b.replace(TP.regex.ACP_NUMERIC,'0');}if(TP.regex.TIBET_PATH.test(a)){return TP.TIBET_PATH_TYPE;}if(TP.regex.BARENAME.test(a)){return TP.BARENAME_PATH_TYPE;}if(TP.regex.XPOINTER.test(a)){return TP.XPOINTER_PATH_TYPE;}if(TP.regex.XTENSION_POINTER.test(a)){return TP.XTENSION_POINTER_PATH_TYPE;}a=a.charAt(0)==='#'?a.slice(1):a;if(TP.regex.ATTRIBUTE.test(a)||TP.regex.XPATH_PATH.test(a)||TP.regex.HAS_SLASH.test(a)){return TP.XPATH_PATH_TYPE;}return TP.CSS_PATH_TYPE;});TP.definePrimitive('prefixAssignmentStatements',function(a,b){TP.regex.JS_ASSIGNMENT.lastIndex=0;return b.replace(TP.regex.JS_ASSIGNMENT,'$1'+a+'$2$3');});TP.boot.$configurePluginEnvironment=function(){var b,d,a,c;b=TP.keys(TP.PLUGIN_INFO);d=b.getSize();for(a=0;a<d;a++){c=TP.getPluginInfo(b.at(a));TP.boot.$$setenv(TP.join('plugin.',b.at(a),'.','installed'),c.at('isInstalled'));TP.boot.$$setenv(TP.join('plugin.',b.at(a),'.','revMajor'),c.at('revMajor'));TP.boot.$$setenv(TP.join('plugin.',b.at(a),'.','revMinor'),c.at('revMinor'));TP.boot.$$setenv(TP.join('plugin.',b.at(a),'.','revPatch'),c.at('revPatch'));}return;};
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETDOMPrimitivesPre.js';
TP.definePrimitive('getQNameRegex',function(c){var a,b;if(TP.isEmpty(c)){a=TP.rc('.*');}else{b=c.split(' ');b.convert(function(a){if(/\*:\*/.test(a)){return'.*';}else if(/\*:/.test(a)){return a.replace('*:','\\\\*:');}else if(/:\*/.test(a)){return a.replace(':*',':\\\\*');}else{return a;}});a=TP.rc(b.join('|'));}return a;});TP.definePrimitive('documentCreateFragment',function(a){if(!TP.isDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}return a.createDocumentFragment();});TP.definePrimitive('documentGetDoctypeInfo',function(c){var a,b;if(!TP.isXMLDocument(c)){return TP.raise(this,'TP.sig.InvalidXMLDocument',arguments);}a=c.doctype;if(TP.isValid(a)){b=TP.hc('docTypeName','','publicID','','systemID','');if(TP.isString(a.name)){b.atPut('docTypeName',a.name);}if(TP.isString(a.publicId)){b.atPut('publicID',a.publicId);}if(TP.isString(a.systemId)){b.atPut('systemID',a.systemId);}return b;}return null;});TP.definePrimitive('documentGetMIMEType',function(c){var b,a,d,e;if(!TP.isDocument(c)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}b=c.getElementsByTagName('meta');for(a=0;a<b.length;a++){d=TP.getAttr(b[a],'http-equiv');if(TP.notEmpty(d)&&d==='Content-Type'){e=TP.getAttr(b[a],'content');TP.regex.MIME_TYPE.lastIndex=0;return TP.regex.MIME_TYPE.exec(e)[0];}}if(TP.isHTMLDocument(c)){return TP.core.Browser.DEFAULT_MIME_TYPE;}else{return null;}});TP.definePrimitive('nodeAddDefaultXMLNS',function(a,d){var c,b;if(!TP.isDocument(a)&&!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isEmpty(d)){return TP.raise(this,'TP.sig.InvalidString',arguments);}c=TP.isDocument(a)?a.documentElement:a;b=TP.str(c);if(!TP.regex.CONTAINS_ELEM_MARKUP.test(b)){return TP.raise(this,'TP.sig.InvalidMarkup',arguments);}if(TP.notEmpty(TP.elementGetAttribute(c,'xmlns'))){return a;}b=b.replace(TP.regex.OPENING_TAG_NAME,'<$1 xmlns="'+d+'"');if(TP.isDocument(a)){return TP.doc(b);}else{return TP.elem(b);}});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETDOMPrimitivesBase.js';
TP.definePrimitive('elementComputeXMLBaseFrom',function(f,g){var b,e,c,a,d;if(!TP.isElement(f)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}b=f;e=TP.ifInvalid(g,true);c=TP.ifEmpty(TP.elementGetAttribute(b,'xml:base',true),'');a=TP.uriExpandPath(c);if(c!==a&&e){TP.elementSetAttributeInNS(b,'xml:base',a,TP.w3.Xmlns.XML);}if(TP.notEmpty(a)&&TP.uriIsAbsolute(a)){return a;}d=a;while(TP.isElement(b=b.parentNode)){if(TP.notEmpty(c=TP.elementGetAttribute(b,'xml:base',true))){a=TP.uriExpandPath(c);if(c!==a&&e){TP.elementSetAttributeInNS(b,'xml:base',a,TP.w3.Xmlns.XML);}d=TP.uriJoinPaths(a,d);if(TP.uriIsAbsolute(d)){return d;}}}return d;});TP.definePrimitive('elementGetURIController',function(c){var a,b,d,e,f;if(!TP.isElement(c)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isDocument(a=TP.nodeGetDocument(c))){if(TP.isElement(b=a.documentElement)){if(TP.notEmpty(d=TP.elementGetAttribute(b,'tibet:src',true))){e=TP.elementGetAttribute(b,'tibet:uricontroller',true);f=TP.uc(d).get('controller',e);f.set('currentWindow',TP.nodeGetWindow(a));}}}return null;});TP.definePrimitive('elementResolveXMLBase',function(d,c,i,j){var f,k,b,g,h,a,e;if(!TP.isElement(d)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}f=null;k=c.getSize();for(b=0;b<k;b++){if(TP.isEmpty(a=TP.elementGetAttribute(d,c.at(b),true))){continue;}if(a==='#'&&c.at(b)==='href'){return;}g='';h='';if(a.startsWith(i)){a=a.slice(i.getSize());g=i;}if(a.endsWith(j)){a=a.slice(0,j.getSize()*-1);h=j;}a=TP.uriResolveVirtualPath(a);if(!TP.uriIsAbsolute(a)){if(TP.notValid(f)){f=TP.elementComputeXMLBaseFrom(d);}e=TP.uriResolvePaths(f,a,false);}else{e=a;}if(TP.notValid(e)){TP.elementSetAttribute(d,c.at(b),'Couldn\'t compute base for: '+g+a+h);}else{TP.elementSetAttribute(d,c.at(b),g+e+h);}}return;});TP.definePrimitive('nodeComparePosition',function(a,b,d){var c;c=a.compareDocumentPosition?a.compareDocumentPosition(b):a.contains?(a!==b&&a.contains(b)&&16)+(a!==b&&b.contains(a)&&8)+(a.sourceIndex>=0&&b.sourceIndex>=0?(a.sourceIndex<b.sourceIndex&&4)+(a.sourceIndex>b.sourceIndex&&2):1)+0:0;return!!(c&d);});TP.definePrimitive('nodeGetBestNode',function(b){var c,a;if(!TP.isNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(!TP.nodeIsDetached(b)){c=TP.nodeGetDocument(b);if(TP.notValid(c)){a=b;}else{a=c.documentElement;}}else{if(TP.isFragment(b)){a=b.firstChild;}else{a=b;}}if(TP.isElement(a)){if(TP.elementGetLocalName(a)==='wrap'){a=a.firstChild;}}return a;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETDOMPrimitivesPlatform.js';
TP.definePrimitive('$documentSetupNamespaces',TP.hc('test','trident','true',function(b){var e,c,f,g,d,h,a;if(!TP.isXMLDocument(b)){return TP.raise(this,'TP.sig.InvalidXMLDocument',arguments);}try{e=b.documentElement.selectNodes('//namespace::*');}catch(a){TP.raise(this,'TP.sig.DOMException',arguments,TP.ec(a));return b;}c=e.length-1;a='';if(c>=0){f=new Array(c);g=TP.ac();for(d=0;d<=c;d++){h=e.item(d);a=h.xml;if(a.substr(0,9)!=='xmlns:xml'&&a.substr(0,6)!=='xmlns='&&TP.notTrue(f[a])){f[a]=true;g.push(a);}}}b.setProperty('SelectionNamespaces',g.join(' '));return;},TP.DEFAULT,function(a){return;}));TP.definePrimitive('$$xpathResolverFunction',TP.hc('test','trident','true',function(a){return;},TP.DEFAULT,function(a){var b;if(TP.notEmpty(a)&&TP.isString(b=TP.w3.Xmlns.getPrefixURI(a))){return b;}return null;}));TP.definePrimitive('attributeGetLocalName',TP.hc('test','trident','true',function(b){var a,c;if(!TP.isAttributeNode(b)){return TP.raise(this,'TP.sig.InvalidAttributeNode',arguments);}if(TP.isXMLDocument(TP.nodeGetDocument(b))){return b.baseName;}a=b.name;if((c=a.indexOf(':'))!==-1){a=a.slice(c+1);}return a;},TP.DEFAULT,function(b){var a,c;if(!TP.isAttributeNode(b)){return TP.raise(this,'TP.sig.InvalidAttributeNode',arguments);}a=b.localName;if((c=a.indexOf(':'))!==-1){a=a.slice(c+1);}return a;}));TP.definePrimitive('attributeGetOwnerElement',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a){if(!TP.isAttributeNode(a)){return TP.raise(this,'TP.sig.InvalidAttributeNode',arguments);}return a.ownerElement;},'trident',function(a){if(!TP.isAttributeNode(a)){return TP.raise(this,'TP.sig.InvalidAttributeNode',arguments);}if(!TP.isXMLDocument(TP.nodeGetDocument(a))){return TP.raise(this,'TP.sig.InvalidXMLDocument',arguments);}return a.selectSingleNode('..');},'webkit',function(a){var b;if(!TP.isAttributeNode(a)){return TP.raise(this,'TP.sig.InvalidAttributeNode',arguments);}if(!TP.isElement(b=a.ownerElement)){b=TP.nodeEvaluateXPath(a,'..');}return b;}));TP.definePrimitive('createDocument',TP.hc('test','trident','true',function(j,i,f){var d,b,g,h,e,a,c;d=j;b=TP.notValid(i)?'':i;if(TP.isNumber(f)){switch(f){case 2:a=new ActiveXObject('Msxml2.DOMDocument');break;case 3:a=new ActiveXObject('Msxml2.DOMDocument.3.0');break;case 6:a=new ActiveXObject('Msxml2.DOMDocument.6.0');break;default:return TP.raise(null,'TP.sig.InvalidParameter',arguments,'Msxml version: '+f+' not valid.');}}else{h=TP.IE_DOM_DOCUMENT_VERSIONS;for(e=0;e<h.length;e++){try{a=new ActiveXObject(h[e]);break;}catch(a){}}if(TP.notValid(a)){return TP.raise(null,'TP.sig.InvalidParameter',arguments,'Unable to create a DOM Document.');}}a.resolveExternals=false;a.validateOnParse=false;a.async=false;a.setProperty('SelectionLanguage','XPath');a.setProperty('ProhibitDTD',false);c=TP.ac(TP.XML_10_HEADER,'\n');if(TP.notEmpty(d)&&TP.notEmpty(b)){g=b.split(':');if(g.length>1){c.push('<',b,' xmlns:',g[0],'="',d,'"></',b,'>');}else{c.push('<',b,' xmlns="',d,'"></',b,'>');}a.loadXML(c.join(''));}else if(TP.isEmpty(d)&&TP.notEmpty(b)){c.push('<',b,' xmlns=""></',b,'>');a.loadXML(c.join(''));}else if(TP.notEmpty(b)){c.push('<',b,'></',b,'>');a.loadXML(c.join(''));}return a;},TP.DEFAULT,function(e,f){var c,a,d,b;c=e;a=TP.ifInvalid(f,'');if(TP.notEmpty(c)&&TP.notEmpty(a)){d=a.split(':');if(d.getSize()>1){b=TP.join('<',a,' xmlns:',d.at(0),'="',c,'">','</',a,'>');}else{b=TP.join('<',a,' xmlns="',c,'"></',a,'>');}return TP.documentFromString(b);}else if(TP.isEmpty(c)&&TP.notEmpty(a)){b=TP.join('<',a,' xmlns="">','</',a,'>');return TP.documentFromString(b);}else if(TP.notEmpty(a)){b=TP.join('<',a,'></',a,'>');return TP.documentFromString(b);}return document.implementation.createDocument('','',null);}));TP.definePrimitive('documentCreateElement',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a,b,d){var e,c;if(!TP.isDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidElementType',arguments);}e=TP.ifInvalid(d,'');try{if(TP.isXMLDocument(a)||d===TP.w3.Xmlns.SVG){c=a.createElementNS(e,b);}else{c=a.createElement(b);}}catch(a){return TP.raise(this,'TP.sig.DOMCreateException',arguments,TP.ec(a));}return c;},'trident',function(a,b,f){var c,d,e;if(!TP.isDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidElementType',arguments);}c=TP.ifInvalid(f,'');try{if(TP.isXMLDocument(a)){d=a.createNode(Node.ELEMENT_NODE,b,c);}else if(TP.notEmpty(c)){if(c!==TP.w3.Xmlns.XHTML&&TP.notEmpty(e=TP.w3.Xmlns.get('info').at(c).at('prefix'))&&!TP.regex.HAS_COLON.test(b)){d=a.createElement(e+':'+b);}else{d=a.createElement(b);}TP.elementSetAttribute(d,'xmlns',c);}else{d=a.createElement(b);}}catch(a){return TP.raise(this,'TP.sig.DOMCreateException',arguments,TP.ec(a));}return d;},'webkit',function(a,b,d){var e,c;if(!TP.isDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidElementType',arguments);}e=TP.ifInvalid(d,'');try{if(TP.isXMLDocument(a)||d===TP.w3.Xmlns.SVG){c=a.createElementNS(e,b);}else{c=a.createElement(b);}}catch(a){return TP.raise(this,'TP.sig.DOMCreateException',arguments,TP.ec(a));}return c;}));TP.definePrimitive('documentFromString',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(d,h,k){var c,i,a,b,f,g,e,j;c=TP.ifInvalid(k,false);c=TP.ifInvalid(c,TP.sys.shouldReportParseErrors());if(d===''||!/^[\s\w]*</.test(d)||d.length<'<a/>'.length){return;}try{i=new DOMParser();if(TP.isString(h)){a='<root xmlns="'+h+'"';}else{a='<root';}if(TP.isType(TP.sys.getTypeByName('TP.w3.Xmlns'))){a=d.replace(TP.regex.ALL_ELEM_MARKUP,a+' '+TP.w3.Xmlns.get('XMLNSDefs')+'>$&</root>');}else{a=d.replace(TP.regex.ALL_ELEM_MARKUP,a+'>$&</root>');}b=i.parseFromString(a,TP.XML_ENCODED);if(b.documentElement.nodeName==='parsererror'){f=b.documentElement;if(TP.notFalse(c)){if(TP.isNode(f.firstChild)){g=TP.regex.GECKO_XML_PARSE.exec(f.firstChild.nodeValue);e=TP.hc('reason',g.at(1),'line',g.at(2),'linepos',g.at(3));j=TP.nodeGetElementsByTagName(f,'sourcetext');e.atPut('srcText',j.at(0).firstChild.nodeValue);}else{e=TP.hc('reason','Unknown','line','Unknown','linepos','Unknown','srcText','Unknown');}TP.raise(this,'TP.sig.DOMParseException',arguments,e);}return null;}}catch(a){if(TP.notFalse(c)){TP.raise(this,'TP.sig.DOMParseException',arguments,TP.ec(a));}return null;}b.replaceChild(b.documentElement.firstChild,b.documentElement);return b;},'trident',function(b,l,k,j){var f,e,a,i,d,g,c,h;f=TP.ifInvalid(j,false);e=TP.ifInvalid(k,false);e=TP.ifInvalid(e,TP.sys.shouldReportParseErrors());if(b===''||!/^[\s\w]*</.test(b)||b.length<'<a/>'.length){return;}a=TP.createDocument();TP.regex.XML_XMLNS_STRIP.lastIndex=0;i=b.strip(TP.regex.XML_XMLNS_STRIP);a.setProperty('ProhibitDTD',f);if(TP.isType(TP.sys.getTypeByName('TP.w3.Xmlns'))){d=b.replace(TP.regex.ALL_ELEM_MARKUP,d+' '+TP.w3.Xmlns.get('XMLNSDefs')+'>$&</root>');}else{d=b.replace(TP.regex.ALL_ELEM_MARKUP,d+'>$&</root>');}g=a.loadXML(d);if(!g){if(TP.notFalse(e)){c=a.parseError;h=TP.hc('reason',c.reason,'srcText',c.srcText,'line',c.line,'linepos',c.linePos);TP.raise(this,'TP.sig.DOMParseException',arguments,h);}return null;}if(a.childNodes.length>0&&a.childNodes[0].nodeName==='xml'&&a.childNodes[0].nodeType===Node.PROCESSING_INSTRUCTION_NODE){TP.nodeDetach(a.childNodes[0]);}TP.$documentSetupNamespaces(a);a.replaceChild(a.documentElement.firstChild,a.documentElement);return a;},'webkit',function(d,i,j){var c,h,a,b,g,e,f;c=TP.ifInvalid(j,false);c=TP.ifInvalid(c,TP.sys.shouldReportParseErrors());if(d===''||!/^[\s\w]*</.test(d)||d.length<'<a/>'.length){return;}try{h=new DOMParser();if(TP.isString(i)){a='<root xmlns="'+i+'"';}else{a='<root';}if(TP.isType(TP.sys.getTypeByName('TP.w3.Xmlns'))){a=d.replace(TP.regex.ALL_ELEM_MARKUP,a+' '+TP.w3.Xmlns.get('XMLNSDefs')+'>$&</root>');}else{a=d.replace(TP.regex.ALL_ELEM_MARKUP,a+'>$&</root>');}b=h.parseFromString(a,TP.XML_ENCODED);if(TP.isElement(g=b.getElementsByTagName('parsererror')[0])){if(TP.notFalse(c)){if(TP.isNode(g.firstChild)){e=TP.regex.WEBKIT_XML_PARSE.exec(TP.nodeAsString(g));f=TP.hc('reason',e.at(3),'line',e.at(1),'linepos',e.at(2));}else{f=TP.hc('reason','Unknown','line','Unknown','linepos','Unknown');}TP.raise(this,'TP.sig.DOMParseException',arguments,f);}return null;}}catch(a){if(TP.notFalse(c)){TP.raise(this,'TP.sig.DOMParseException',arguments,TP.ec(a));}return null;}b.replaceChild(b.documentElement.firstChild,b.documentElement);return b;}));TP.definePrimitive('elementAddNamespace',TP.hc('test','trident','true',function(a,b,e){var c,f,d,g;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isXMLDocument(TP.nodeGetDocument(a))){return TP.raise(this,'TP.sig.InvalidXMLDocument',arguments);}if(TP.isEmpty(b)||TP.notValid(e)){return TP.raise(this,'TP.sig.InvalidString',arguments,'Invalid or empty prefix or URI');}if(e===TP.w3.Xmlns.XML){return;}if(/xmlns:/g.test(b)){c=b;}else{c='xmlns:'+b;}f=a.attributes;for(d=0;d<f.length;d++){if(f[d].name===c){return;}}TP.elementSetAttributeInNS(a,c,e,TP.w3.Xmlns.XMLNS);if(TP.isDocument(a.ownerDocument)){g=a.ownerDocument;}else{g=a;}TP.$documentSetupNamespaces(g);return;},TP.DEFAULT,function(a,b,f){var c,e,d;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isXMLDocument(TP.nodeGetDocument(a))){return TP.raise(this,'TP.sig.InvalidXMLDocument',arguments);}if(TP.isEmpty(b)||TP.isEmpty(f)){return TP.raise(this,'TP.sig.InvalidString',arguments,'Invalid or empty prefix or URI');}if(/xmlns:/g.test(b)){c=b;}else{c='xmlns:'+b;}e=a.attributes;for(d=0;d<e.length;d++){if(e[d].name===c){return;}}TP.elementSetAttributeInNS(a,c,f,TP.w3.Xmlns.XMLNS);return;}));TP.definePrimitive('elementGetLocalName',TP.hc('test','trident','true',function(a){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}return TP.ifInvalid(a.baseName,a.tagName);},TP.DEFAULT,function(a){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}return a.localName;}));TP.definePrimitive('elementHasAttribute',TP.hc('test','trident','true',function(b,a,h){var d,e,c,f,g;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(a)){return TP.raise(this,'TP.sig.InvalidName',arguments);}if(TP.isXMLDocument(TP.nodeGetDocument(b))){d=TP.regex.HAS_COLON.test(a);if(!d){return TP.isAttributeNode(b.getAttributeNode(a));}else{e=TP.$elementGetPrefixedAttributeNode(b,a,h);if(TP.isAttributeNode(e)){return true;}return false;}}if(TP.regex.PCLASS_CHANGE.test(a)){c='pclass:'+a;}else{c=a;}if(TP.isAttributeNode(f=b.getAttributeNode(c))){if(TP.isTrue(f.expando)){return true;}g=TP.rc('^[^>]+ '+c+'=');return g.test(b.outerHTML);}return false;},TP.DEFAULT,function(b,a,f){var d,e,c;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(a)){return TP.raise(this,'TP.sig.InvalidName',arguments);}if(TP.isXMLDocument(TP.nodeGetDocument(b))){d=TP.regex.HAS_COLON.test(a);if(!d){return b.hasAttribute(a);}else{e=TP.$elementGetPrefixedAttributeNode(b,a,f);if(TP.isAttributeNode(e)){return true;}return false;}}if(TP.regex.PCLASS_CHANGE.test(a)){c='pclass:'+a;}else{c=a;}return b.hasAttribute(c);}));TP.definePrimitive('$$elementPreserveIFrameContent',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(h){var a,d,b,e,f,c,g;a=TP.ac(h.getElementsByTagName('iframe'));if(TP.notEmpty(a)){d=TP.hc();for(b=0;b<a.getSize();b++){if(TP.notValid(e=TP.elementGetIFrameDocument(a.at(b)))){continue;}f=TP.lid(a[b],true);c=e.documentElement;if(TP.isElement(c)){g=e.createElement('replacement');c.parentNode.replaceChild(g,c);d.atPut(f,c);}}}return d;},'trident',function(a){return null;},'webkit',function(h){var a,d,b,e,f,c,g;a=TP.ac(h.getElementsByTagName('iframe'));if(TP.notEmpty(a)){d=TP.hc();for(b=0;b<a.getSize();b++){if(TP.notValid(e=TP.elementGetIFrameDocument(a.at(b)))){continue;}f=TP.lid(a[b],true);c=e.documentElement;if(TP.isElement(c)){g=e.createElement('replacement');c.parentNode.replaceChild(g,c);d.atPut(f,c);}}}return d;}));TP.definePrimitive('elementRemoveAttribute',TP.hc('test','trident','true',function(a,c,f){var e,d,b,g;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(c)){return TP.raise(this,'TP.sig.InvalidName',arguments);}if(TP.isXMLDocument(TP.nodeGetDocument(a))){e=TP.regex.HAS_COLON.test(c);if(!e){return a.removeAttribute(c);}else{d=TP.$elementGetPrefixedAttributeNode(a,c,f);if(TP.isAttributeNode(d)){a.removeAttributeNode(d);}return;}}if(TP.regex.PCLASS_CHANGE.test(c)){b='pclass:'+c;a.removeAttributeNode(a.getAttributeNode(b));a[b]=null;a.removeAttribute(b);}else{b=c;}if(TP.isWindow(g=TP.nodeGetWindow(a))){TP.$elementProcessCSSAttributeChange(a,b,null,function(){try{a.removeAttributeNode(a.getAttributeNode(b));if(!TP.elementHasAttribute(a,b)){return;}a[b]=null;a.removeAttribute(b);}catch(a){}});}TP.$elementCSSFlush(a);return;},TP.DEFAULT,function(a,b,f){var e,d,c,g;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidName',arguments);}if(TP.isXMLDocument(TP.nodeGetDocument(a))){e=TP.regex.HAS_COLON.test(b);if(!e){return a.removeAttribute(b);}else{d=TP.$elementGetPrefixedAttributeNode(a,b,f);if(TP.isAttributeNode(d)){a.removeAttributeNode(d);}return;}}if(TP.regex.PCLASS_CHANGE.test(b)){c='pclass:'+b;a.removeAttribute(c);}else{c=b;}if(TP.isWindow(g=TP.nodeGetWindow(a))){TP.$elementProcessCSSAttributeChange(a,c,null,function(){a.removeAttribute(c);});}else{a.removeAttribute(c);}TP.$elementCSSFlush(a);return;}));TP.definePrimitive('$$elementRestoreIFrameContent',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(h,e){var d,b,f,a,c,g;d=TP.keys(e);for(b=0;b<d.getSize();b++){f=TP.nodeGetDocument(h).getElementById(d.at(b));if(TP.notValid(a=TP.elementGetIFrameDocument(f))){continue;}c=a.documentElement;if(TP.isElement(c)){g=a.adoptNode(e.at(d.at(b)),true);a.open();a.write('<html><head></head><body></body></html>');a.close();c=a.documentElement;c.parentNode.replaceChild(g,c);}}return;},'trident',function(a,b){return;},'webkit',function(h,e){var d,b,f,a,c,g;d=TP.keys(e);for(b=0;b<d.getSize();b++){f=TP.nodeGetDocument(h).getElementById(d.at(b));if(TP.notValid(a=TP.elementGetIFrameDocument(f))){continue;}c=a.documentElement;if(TP.isElement(c)){g=a.adoptNode(e.at(d.at(b)),true);a.open();a.write('<html><head></head><body></body></html>');a.close();c=a.documentElement;c.parentNode.replaceChild(g,c);}}return;}));TP.definePrimitive('elementSetAttributeInNS',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a,b,c,d){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidString',arguments);}if(TP.notValid(c)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.notEmpty(d)&&TP.isXMLDocument(TP.nodeGetDocument(a))){a.setAttributeNS(d,b,c);}else{a.setAttribute(b,c);}return;},'trident',function(a,b,c,f){var d,e;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidString',arguments);}if(TP.notValid(c)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}d=TP.nodeGetDocument(a);if(TP.notEmpty(f)&&TP.isXMLDocument(d)){e=d.createNode(Node.ATTRIBUTE_NODE,b,f);e.value=c;a.attributes.setNamedItem(e);}else{a.setAttribute(b,c);}return;},'webkit',function(a,b,f,c){var i,d,g,e,h;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidString',arguments);}if(TP.notValid(f)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.notEmpty(c)&&TP.isXMLDocument(TP.nodeGetDocument(a))){if(c!==TP.w3.Xmlns.XMLNS){if(TP.notEmpty(i=b.split(':'))){d=i.first();}else{d=TP.w3.Xmlns.getCanonicalPrefix();}if(TP.notEmpty(d)){h='xmlns:'+d;g=a.attributes;for(e=0;e<g.length;e++){if(g[e].name===h){break;}}a.setAttributeNS(TP.w3.Xmlns.XMLNS,h,c);}}a.setAttributeNS(c,b,f);}else{a.setAttribute(b,f);}return;}));TP.definePrimitive('nodeAsString',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(c,d,e){var a,b;if(!TP.isNode(c)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}a=e?TP.nodeCloneNode(c,false):c;switch(a.nodeType){case Node.ATTRIBUTE_NODE:return a.name+'="'+a.value+'"';case Node.TEXT_NODE:return a.data;case Node.CDATA_SECTION_NODE:return'<![CDATA['+a.data+']]>';case Node.DOCUMENT_FRAGMENT_NODE:try{b=new XMLSerializer().serializeToString(a);}catch(a){TP.raise(this,'TP.sig.SerializationException',arguments,TP.ec(a));b='Serialization failed.';}if(TP.isHTMLNode(a)){return TP.stringAsHTMLString(b);}else{return b;}break;case Node.PROCESSING_INSTRUCTION_NODE:return'<?'+a.target+' '+a.data+'?>';case Node.COMMENT_NODE:return'<!--'+a.data+'-->';case Node.ENTITY_REFERENCE_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.ENTITY_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.DOCUMENT_TYPE_NODE:return'<!DOCTYPE '+a.name+' PUBLIC '+a.publicId+' '+a.systemId+'>';case Node.NOTATION_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.DOCUMENT_NODE:if(TP.notValid(a.documentElement)){return'';}case Node.ELEMENT_NODE:default:try{b=new XMLSerializer().serializeToString(a);if(d&&(TP.isXMLDocument(a)||TP.isXMLDocument(a.parentNode))){if(!b.startsWith('<?xml ')){b=TP.XML_10_HEADER+'\n'+b;}}else{if(b.startsWith('<?xml ')){b=b.slice(b.indexOf('?>')+2);}}}catch(c){if(/restricted URI/.test(TP.str(c))){if(TP.isElement(a)){b=TP.elementGetOuterContent(a);}else if(TP.isDocument(a)){b=TP.elementGetOuterContent(a.documentElement);}else{b=a.innerHTML;}}else{TP.raise(this,'TP.sig.SerializationException',arguments,TP.ec(c));b='Serialization failed.';}}if(TP.isHTMLNode(a)){return TP.stringAsHTMLString(b);}else{return b;}break;}return null;},'trident',function(d,f,g){var b,a,e,c;if(!TP.isNode(d)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}a=g?TP.nodeCloneNode(d,false):d;switch(a.nodeType){case Node.ATTRIBUTE_NODE:return a.name+'="'+a.value+'"';case Node.TEXT_NODE:return a.data;case Node.CDATA_SECTION_NODE:return'<![CDATA['+a.data+']]>';case Node.DOCUMENT_FRAGMENT_NODE:if(TP.isXMLDocument(TP.nodeGetDocument(a))){return a.xml;}else{e=TP.ac();for(c=0;c<a.childNodes.length;c++){e.push(TP.nodeAsString(a.childNodes[c]));}return e.join('');}break;case Node.PROCESSING_INSTRUCTION_NODE:return'<?'+a.target+' '+a.data+'?>';case Node.COMMENT_NODE:return'<!--'+a.data+'-->';case Node.ENTITY_REFERENCE_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.ENTITY_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.DOCUMENT_TYPE_NODE:return'<!DOCTYPE '+a.name+' PUBLIC '+a.publicId+' '+a.systemId+'>';case Node.NOTATION_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.DOCUMENT_NODE:if(TP.notValid(a.documentElement)){return'';}case Node.ELEMENT_NODE:default:if(TP.isString(b=a.xml)){if(f&&(TP.isXMLDocument(a)||TP.isXMLDocument(a.parentNode))){if(!b.startsWith('<?xml ')){b=TP.XML_10_HEADER+'\n'+b;}}else{if(b.startsWith('<?xml ')){b=b.slice(b.indexOf('?>')+2);}}return b;}else if(TP.isString(b=a.outerHTML)){return b;}else if(TP.isHTMLDocument(a)||TP.isXHTMLDocument(a)){return a.documentElement.outerHTML;}TP.raise(this,'TP.sig.SerializationException',arguments);return'Serialization failed.';}},'webkit',function(c,d,e){var a,b;if(!TP.isNode(c)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}a=e?TP.nodeCloneNode(c,false):c;switch(a.nodeType){case Node.ATTRIBUTE_NODE:return a.name+'="'+a.value+'"';case Node.TEXT_NODE:return a.data;case Node.CDATA_SECTION_NODE:return'<![CDATA['+a.data+']]>';case Node.DOCUMENT_FRAGMENT_NODE:try{b=new XMLSerializer().serializeToString(a);}catch(a){TP.raise(this,'TP.sig.SerializationException',arguments,TP.ec(a));b='Serialization failed.';}if(TP.isHTMLNode(a)){return TP.stringAsHTMLString(b);}else{return b;}break;case Node.PROCESSING_INSTRUCTION_NODE:return'<?'+a.target+' '+a.data+'?>';case Node.COMMENT_NODE:return'<!--'+a.data+'-->';case Node.ENTITY_REFERENCE_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.ENTITY_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.DOCUMENT_TYPE_NODE:return'<!DOCTYPE '+a.name+' PUBLIC '+a.publicId+' '+a.systemId+'>';case Node.NOTATION_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.DOCUMENT_NODE:if(TP.notValid(a.documentElement)){return'';}case Node.ELEMENT_NODE:default:try{b=new XMLSerializer().serializeToString(a);if(d&&(TP.isXMLDocument(a)||TP.isXMLDocument(a.parentNode))){if(!b.startsWith('<?xml ')){b=TP.XML_10_HEADER+'\n'+b;}}else{if(b.startsWith('<?xml ')){b=b.slice(b.indexOf('?>')+2);}}}catch(c){if(/restricted URI/.test(TP.str(c))){if(TP.isElement(a)){b=TP.elementGetOuterContent(a);}else if(TP.isDocument(a)){b=TP.elementGetOuterContent(a.documentElement);}else{b=a.innerHTML;}}else{TP.raise(this,'TP.sig.SerializationException',arguments,TP.ec(c));b='Serialization failed.';}}if(TP.isHTMLNode(a)){return TP.stringAsHTMLString(b);}else{return b;}break;}return null;}));TP.definePrimitive('nodeCloneNode',TP.hc('test','webkit','true',function(a,f,g){var c,d,b,e;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isHTMLDocument(a)){return null;}c=TP.ifInvalid(f,true);if(TP.isXMLDocument(a)){b=TP.createDocument(null,'nonsense');e=b.importNode(a.documentElement,c);b.replaceChild(e,b.documentElement);return b;}d=TP.ifInvalid(g,false);if(c&&d){if(TP.isXMLDocument(a)){return TP.documentFromString(TP.nodeAsString(a));}else{return TP.nodeFromString(TP.nodeAsString(a));}}return a.cloneNode(c);},TP.DEFAULT,function(a,d,c){var b,e;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isHTMLDocument(a)){return null;}b=TP.ifInvalid(d,true);e=TP.ifInvalid(c,false);if(b&&c){if(TP.isXMLDocument(a)){return TP.documentFromString(TP.nodeAsString(a));}else{return TP.nodeFromString(TP.nodeAsString(a));}}return a.cloneNode(b);}));TP.definePrimitive('nodeContainsNode',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a,b){var c;if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(!TP.isNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isDocument(a)&&TP.isElement(b)){if(TP.nodeGetDocument(b)!==a||TP.notValid(a.documentElement)){return false;}c=a.documentElement;if(c===b){return true;}}c=TP.ifInvalid(c,a);return!!(c.compareDocumentPosition(b)&16);},'trident',function(b,c){var a,d;if(!TP.isCollectionNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(!TP.isNode(c)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isDocument(b)&&TP.isElement(c)){if(TP.nodeGetDocument(c)!==b||TP.notValid(b.documentElement)){return false;}a=b.documentElement;if(a===c){return true;}}a=TP.ifInvalid(a,b);if(TP.isCallable(a.contains)){return a.contains(c);}d=c;while(d&&(d=d.parentNode)&&a!==d){continue;}return!!d;},'webkit',function(a,c){var d,b;if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(!TP.isNode(c)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isDocument(a)&&TP.isElement(c)){if(TP.nodeGetDocument(c)!==a||TP.notValid(a.documentElement)){return false;}d=a.documentElement;if(d===c){return true;}}d=TP.ifInvalid(d,a);b=c;while(b&&(b=b.parentNode)&&d!==b){continue;}return!!b;}));TP.definePrimitive('nodeEqualsNode',TP.hc('test','trident','true',function(a,b){if(!TP.isNode(a)||!TP.isNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}return TP.todo();},TP.DEFAULT,function(a,b){if(!TP.isNode(a)||!TP.isNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}return a.isEqualNode(b);}));TP.definePrimitive('nodeEvaluateXPath',TP.hc('test','trident','true',function(b,h,l,n){var k,f,j,a,d,g,e,c,i,m;if(!TP.isNode(b)||TP.isFragment(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isEmpty(h)){return TP.raise(this,'TP.sig.InvalidString',arguments);}TP.ifTrace(TP.sys.hasLoaded()&&TP.sys.shouldLogXPaths())?TP.trace('Querying via XPath '+h,TP.QUERY_LOG,arguments):0;k=TP.ifInvalid(n,true);if(TP.isDocument(b.ownerDocument)){j=b.ownerDocument;}else{j=b;}if(!TP.isXMLDocument(j)){return TP.raise(this,'TP.sig.InvalidXMLDocument',arguments);}TP.regex.XPATH_DEFAULTNS.lastIndex=0;f=h.replace(TP.regex.XPATH_DEFAULTNS,'*[name()="$1"]');try{if(l===TP.NODESET){a=b.selectNodes(f);if(TP.isValid(a)){if(a.length>0){g=TP.ac();for(d=0;d<a.length;d++){g.push(a[d]);}return g;}}return TP.ac();}else if(l===TP.FIRST_NODE){e=b.selectSingleNode(f);return e;}else{a=b.selectNodes(f);if(TP.isValid(a)){if(a.length===1){return a[0];}if(a.length>0){g=TP.ac();for(d=0;d<a.length;d++){g.push(a[d]);}return g;}}return TP.ac();}}catch(a){$$pathValueOfNode.setAttribute('select',f);$$scalarExtractionDoc.setProperty('SelectionNamespaces',TP.nodeGetDocument(b).getProperty('SelectionNamespaces'));TP.elementCopyXMLNSAttributes(TP.nodeGetDocument(b).documentElement,$$scalarExtractionDoc.documentElement);try{e=TP.documentTransformNode($$scalarExtractionDoc,b);if(TP.isXMLDocument(e)){c=e.documentElement.firstChild.nodeValue;}else{c=e.firstChild.nodeValue;}if(c==='NaN'){return NaN;}$$numericFuncRegExp.lastIndex=0;if($$numericFuncRegExp.test(f)){i=TP.nc(c);if(TP.isNaN(i)){return c;}return i;}if(c==='true'||c==='false'){return TP.bc(c);}return c;}catch(a){if(k){m=TP.join('Error evaluating XPath ',h);TP.ifError()?TP.error(TP.ec(a,m),TP.QUERY_LOG,arguments):0;}}}return null;},TP.DEFAULT,function(e,d,f,j){var i,h,a,b,c,g;TP.debug('break.xpath');if(!TP.isNode(e)||TP.isFragment(e)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isEmpty(d)){return TP.raise(this,'TP.sig.InvalidString',arguments);}TP.ifTrace(TP.sys.hasLoaded()&&TP.sys.shouldLogXPaths())?TP.trace('Querying via XPath '+d,TP.QUERY_LOG,arguments):0;i=TP.ifInvalid(j,true);TP.regex.XPATH_DEFAULTNS.lastIndex=0;h=d.replace(TP.regex.XPATH_DEFAULTNS,'*[name()="$1"]');try{a=TP.nodeGetDocument(e).evaluate(h,e,TP.$$xpathResolverFunction,XPathResult.ANY_TYPE,null);if(TP.isValid(a)){switch(a.resultType){case XPathResult.NUMBER_TYPE:return a.numberValue;case XPathResult.BOOLEAN_TYPE:return a.booleanValue;case XPathResult.STRING_TYPE:return a.stringValue;default:if(f===TP.NODESET){b=TP.ac();while(TP.isNode(c=a.iterateNext())){b.push(c);}return b;}else if(f===TP.FIRST_NODE){if(TP.isNode(c=a.iterateNext())){return c;}}else{b=TP.ac();while(TP.isNode(c=a.iterateNext())){b.push(c);}if(b.getSize()===1){return b.first();}return b;}}}}catch(a){if(i||!TP.sys.hasLoaded()){g=TP.join('Error evaluating XPath ',d);TP.ifError()?TP.error(TP.ec(a,g),TP.QUERY_LOG,arguments):0;}}if(f===TP.NODESET){return TP.ac();}else{return null;}}));TP.definePrimitive('nodeGetDescendantElements',TP.hc('test','trident','true',function(b,e){var c,d,a;if(!TP.isCollectionNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.notTrue(e)&&!TP.isFragment(b)){c=b.getElementsByTagName('*');d=TP.ac();for(a=0;a<c.length;a++){if(TP.isElement(c[a])){d.push(c[a]);}}return d;}return TP.nodeGetDescendantsByType(b,Node.ELEMENT_NODE,e);},TP.DEFAULT,function(a,b){if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.notTrue(b)&&!TP.isFragment(a)){return TP.ac(a.getElementsByTagName('*'));}return TP.nodeGetDescendantsByType(a,Node.ELEMENT_NODE,b);}));TP.definePrimitive('nodeGetDocument',TP.hc('test','trident','true',function(a){var b;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(a.nodeType===Node.DOCUMENT_NODE){return a;}if(TP.isDocument(b=a.ownerDocument)){return b;}return a.document;},TP.DEFAULT,function(b){var c,a;if(!TP.isNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(b.nodeType===Node.DOCUMENT_NODE){return b;}if(TP.isDocument(c=b.ownerDocument)){return c;}a=b.parentNode;while(TP.isElement(a)&&a.nodeType!==Node.DOCUMENT_NODE){a=a.parentNode;}if(TP.isElement(a)){return a.ownerDocument;}return null;}));TP.definePrimitive('nodeGetElementById',TP.hc('test','trident','true',function(a,e){var b,f,c,d;if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.isEmpty(e)){return TP.raise(this,'TP.sig.InvalidID',arguments);}if(TP.notValid(b=TP.nodeGetDocument(a))){return null;}if(e==='#document'){return b.documentElement;}if(TP.notValid(b.documentElement)){return;}f=e.strip(TP.regex.BARENAME);if(TP.isHTMLDocument(b)){return b.getElementById(f);}TP.regex.ID_HAS_NS.lastIndex=0;c=f.replace(TP.regex.ID_HAS_NS,'_');TP.regex.INVALID_ID_CHARS.lastIndex=0;if(TP.regex.INVALID_ID_CHARS.test(c)){return null;}if(TP.boot.isMSXML(4,TP.UP)){try{d=a.nodeFromID(c);}catch(b){d=TP.nodeEvaluateXPath(a,'descendant-or-self::*[@id = "'+c+'"]',TP.FIRST_NODE);}}else{d=TP.nodeEvaluateXPath(a,'descendant-or-self::*[@id = "'+c+'"]',TP.FIRST_NODE);}return d;},TP.DEFAULT,function(d,e,g){var a,f,b,c;if(!TP.isCollectionNode(d)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.isEmpty(e)){return TP.raise(this,'TP.sig.InvalidID',arguments);}if(TP.notValid(a=TP.nodeGetDocument(d))){return null;}if(e==='#document'){return a.documentElement;}if(TP.notValid(a.documentElement)){return;}f=e.strip(TP.regex.BARENAME);if(TP.isHTMLDocument(a)){return a.getElementById(f);}TP.regex.ID_HAS_NS.lastIndex=0;b=f.replace(TP.regex.ID_HAS_NS,'_');TP.regex.INVALID_ID_CHARS.lastIndex=0;if(TP.regex.INVALID_ID_CHARS.test(b)){return null;}if(TP.canInvoke(a,'getElementById')){if(c=a.getElementById(b)){return c;}}if(TP.notFalse(g)){c=TP.nodeEvaluateXPath(d,'descendant-or-self::*[@id'+' = "'+b+'"]',TP.FIRST_NODE);}return c;}));TP.definePrimitive('nodeImportNode',TP.hc('test','trident','true',function(b,a){var d,c,g,f,h,e;if(!TP.isNode(b)||!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}d=TP.nodeGetDocument(b);if(d!==TP.nodeGetDocument(a)){if(TP.isHTMLNode(b)&&TP.isHTMLNode(a)){return a;}if(TP.isHTMLNode(b)&&TP.isXMLNode(a)){return TP.nodeAsHTMLNode(a,TP.nodeGetDocument(b));}else if(TP.isXMLNode(b)&&TP.isHTMLNode(a)){return TP.nodeAsXMLNode(a,TP.nodeGetDocument(b));}else if(TP.isXMLNode(b)&&TP.isXMLNode(a)){if(TP.$msxml>=6){d=TP.nodeGetDocument(b);if(d!==TP.nodeGetDocument(a)){c=d.importNode(a,true);}else{c=a;}}else{c=a;}}}else{c=a;}if(TP.isElement(c)){if(b.namespaceURI===c.namespaceURI){if(TP.notEmpty(g=c.prefix)){}else{}}}else if(TP.isFragment(c)){f=c.childNodes;h=f.length;for(e=0;e<h;e++){if(b.namespaceURI===f[e].namespaceURI){if(TP.notEmpty(g=f[e].prefix)){}else{}}}}return c;},TP.DEFAULT,function(d,e){var g,a,f,c,h,b;if(!TP.isNode(d)||!TP.isNode(e)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}g=TP.nodeGetDocument(d);if(g!==TP.nodeGetDocument(e)){a=g.importNode(e,true);}else{a=e;}if(TP.isXMLNode(d)){if(TP.isElement(a)){if(d.namespaceURI===a.namespaceURI){if(TP.notEmpty(f=a.prefix)){a.removeAttributeNS(TP.w3.Xmlns.XMLNS,'xmlns:'+f);}else{a.removeAttributeNS(TP.w3.Xmlns.XMLNS,'xmlns');}}}else if(TP.isFragment(a)){c=TP.nodeGetChildElements(a);h=c.length;for(b=0;b<h;b++){if(d.namespaceURI===c[b].namespaceURI){if(TP.notEmpty(f=c[b].prefix)){c[b].removeAttributeNS(TP.w3.Xmlns.XMLNS,'xmlns:'+f);}else{c[b].removeAttributeNS(TP.w3.Xmlns.XMLNS,'xmlns');}}}}}return a;}));TP.definePrimitive('nodeSwapNode',TP.hc('test','trident','true',function(a,b){var c,d;if(!TP.isNode(a)||!TP.isNode(b)||TP.nodeGetDocument(a)!==TP.nodeGetDocument(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(!TP.isXMLDocument(TP.nodeGetDocument(a))){a.swapNode(b);return;}c=a.nextSibling;if(c===b){c=a;}d=a.parentNode;TP.nodeReplaceChild(b.parentNode,a,b,false);TP.nodeInsertBefore(d,b,c,false);return;},TP.DEFAULT,function(a,b){var c,d;if(!TP.isNode(a)||!TP.isNode(b)||TP.nodeGetDocument(a)!==TP.nodeGetDocument(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}c=a.nextSibling;if(c===b){c=a;}d=a.parentNode;TP.nodeReplaceChild(b.parentNode,a,b,false);TP.nodeInsertBefore(d,b,c,false);return;}));TP.runConditionalFunction(TP.hc('test',TP.boot.getBrowserUI,'gecko',function(){TP.regex.GECKO_XML_PARSE=/XML Parsing Error: ([^\n]+)\nLocation: [^\n]+\nLine Number (\d+), Column (\d+)/;return;},'trident',function(){TP.sys.defineGlobal('$$scalarExtractionDoc',TP.documentFromString('<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:tibet="http://www.technicalpursuit.com/1999/tibet"><xsl:output omit-xml-declaration="yes"/><xsl:template match="*"><resultText><xsl:value-of select=""/></resultText></xsl:template></xsl:stylesheet>'));TP.sys.defineGlobal('$$pathValueOfNode',$$scalarExtractionDoc.selectSingleNode('//xsl:value-of'));TP.sys.defineGlobal('$$numericFuncRegExp',/ceiling|count|floor|last|number|position|round|string-length|sum/g);return;},'webkit',function(){TP.regex.WEBKIT_XML_PARSE=/error on line (\d+) at column (\d+): ([^<]+)/;return;}));
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETDOMPrimitivesPost.js';
TP.XML_FACTORY_DOCUMENT=TP.createDocument();TP.definePrimitive('documentFromNode',function(a){var b,c;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isXMLDocument(a)){return a;}if(!TP.isXMLDocument(TP.nodeGetDocument(a))){b=TP.doc(TP.xmlnode(a));if(!TP.isXMLNode(b)){return TP.raise(this,'TP.sig.InvalidXMLDocument',arguments,a);}}else{b=a;}c=TP.createDocument();TP.nodeAppendChild(c,TP.nodeCloneNode(a,true),false);return c;});TP.definePrimitive('documentAddContent',function(a,c,d,e){var b;if(!TP.isDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments,'Must provide a target Document.');}if(TP.notValid(c)){TP.nodeEmptyContent(a);}b=TP.canInvoke(c,'getResource')?c.getResource():c;b=TP.unwrap(b);if(TP.isHTMLNode(a)){return TP.htmlDocumentAddContent(a,b,d,e);}else{return TP.xmlDocumentAddContent(a,b,d,e);}return;});TP.definePrimitive('documentInsertContent',function(b,c,g,e,f){var d,a;if(!TP.isDocument(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments,'Must provide a target Document.');}if(TP.notValid(c)){return;}d=TP.ifEmpty(g,TP.BEFORE_END);a=TP.canInvoke(c,'getResource')?c.getResource():c;a=TP.unwrap(a);if(TP.isHTMLNode(b)){return TP.htmlDocumentInsertContent(b,a,d,e,f);}else{return TP.xmlDocumentInsertContent(b,a,d,e,f);}return;});TP.definePrimitive('documentPathContainsNode',function(c,d,e,g){var b,f,a;if(TP.notValid(c)){TP.raise(this,'TP.sig.InvalidDocument',arguments);return;}if(TP.notValid(d)){TP.raise(this,'TP.sig.InvalidNode',arguments);return;}if(TP.isEmpty(e)){return TP.raise(this,'TP.sig.InvalidPath',arguments);}b=TP.nodeEvaluatePath(c,e,g,false);f=b.getSize();for(a=0;a<f;a++){if(b.at(a)===d){return true;}}return false;});TP.definePrimitive('documentSetContent',function(a,c,d,e){var b,f;if(!TP.isDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments,'Must provide a target Document.');}if(TP.notValid(c)){TP.nodeEmptyContent(a);}b=TP.canInvoke(c,'getResource')?c.getResource():c;b=TP.unwrap(b);if(TP.isHTMLNode(a)){if(TP.isElement(c)){f=TP.elementGetLocalName(c).toLowerCase();if(f==='html'){return TP.htmlDocumentSetContent(a,b,d,e);}else if(f==='body'){return TP.htmlElementSetContent(a.documentElement,b,d,e);}else{return TP.htmlElementSetContent(TP.documentGetBody(a),b,d,e);}}else{return TP.htmlDocumentSetContent(a,b,d,e);}}else{return TP.xmlDocumentSetContent(a,b,d,e);}return;});TP.definePrimitive('xmlDocumentAddContent',function(a,b,c,d){if(!TP.isXMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}return TP.xmlElementAddContent(a.documentElement,b,c,d);});TP.definePrimitive('xmlDocumentInsertContent',function(a,b,c,d,e){if(!TP.isXMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}return TP.xmlElementInsertContent(a.documentElement,b,c,d,e);});TP.definePrimitive('xmlDocumentSetContent',function(a,c,o,q){var h,n,e,d,k,g,l,p,f,b,i,j,m;if(!TP.isXMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}h=TP.nodeHasWindow(a);n=TP.ifInvalid(q,h);if(TP.isXMLNode(c)){if(TP.isDocument(c)){e=c.documentElement;}else{e=c;}}else if(TP.isString(c)){if(TP.notValid(e=TP.nodeFromString(c,null,true))){e=TP.nodeGetDocument(e).createTextNode(c);}}else{TP.raise(this,'TP.sig.UnsupportedOperation',arguments);return null;}TP.core.Window.$$isDocumentWriting=true;if(h){d=a.createEvent('HTMLEvents');d.initEvent('unload',true,true);a.defaultView.dispatchEvent(d);}TP.nodeEmptyContent(a);TP.nodeAppendChild(a,e,n);k=function(){if(TP.sys.shouldSignalDOMLoaded()){if(h){d=a.createEvent('HTMLEvents');d.initEvent('DOMContentLoaded',true,true);a.dispatchEvent(d);}else{try{TP.signal(TP.gid(a),'TP.sig.DOMContentLoaded',arguments,a.documentElement);}catch(a){TP.ifError()?TP.error(TP.ec(a,'TP.sig.DOMContentLoaded handler'+' generated error.'),TP.LOG,arguments):0;}}if(TP.isCallable(o)){o(a);}}TP.core.Window.$$isDocumentWriting=false;};g=null;l=TP.ac();if(TP.isElement(p=a.getElementsByTagName('head')[0])){f=a.getElementsByTagNameNS(TP.w3.Xmlns.XHTML,'script');for(b=0;b<f.length;b++){i=f[b];if(i.hasAttribute('src')){j=TP.documentCreateScriptElement(a,i.getAttribute('src'));g=j;}else{j=TP.documentCreateScriptElement(a,null,TP.nodeGetTextContent(i));}l.push(j);}if(TP.isElement(g)){g.onload=k;}for(b=0;b<f.length;b++){TP.nodeReplaceChild(f[b].parentNode,l.at(b),f[b],false);}}TP.elementAddNamespace(a.documentElement,'pclass',TP.w3.Xmlns.PCLASS);if(TP.notEmpty(m=a.getElementsByTagName('*'))){for(b=0;b<m.length;b++){TP.elementBubbleXMLNSAttributes(m[b]);}}if(!TP.isElement(g)){k();}return a.documentElement;});TP.definePrimitive('attributeStringAsHash',function(a){if(TP.isEmpty(a)){return TP.hc();}return TP.lang.Hash.fromString(a);});TP.definePrimitive('attributeStringFromHash',function(d){var a,c,e,b;if(TP.isEmpty(d)){return'';}a=TP.ac();c=TP.keys(d);e=c.getSize();for(b=0;b<e;b++){a.push(TP.str(c.at(b)),'="',TP.str(d.at(c.at(b))),'" ');}a=a.join('');return a.slice(0,a.getSize()-1);});TP.definePrimitive('attributeGetCanonicalName',function(a){var d,c,b,e;if(!TP.isAttributeNode(a)){return TP.raise(this,'TP.sig.InvalidAttributeNode',arguments);}e=TP.nodeGetDocument(a);if(TP.isHTMLDocument(e)){b=a.name;if(b.indexOf(':')!==TP.NOT_FOUND){return b;}else{if(TP.isHTMLNode(TP.attributeGetOwnerElement(a))){return'html:'+b;}}}d=TP.nodeGetNSURI(a);if(TP.notEmpty(d)){c=TP.w3.Xmlns.getCanonicalPrefix(d);}if(TP.isEmpty(c)){c=a.prefix;}b=TP.attributeGetLocalName(a);if(TP.isEmpty(c)){return b;}else{return c+':'+b;}});TP.definePrimitive('attributeGetFullName',function(a){var b;if(!TP.isAttributeNode(a)){return TP.raise(this,'TP.sig.InvalidAttributeNode',arguments);}if(TP.isXMLDocument(TP.nodeGetDocument(a))){return a.name;}b=a.name;if(b.indexOf(':')!==TP.NOT_FOUND){return b;}return'html:'+b;});TP.definePrimitive('elementAddAttributeValue',function(b,c,e,d){var a;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(c)){return TP.raise(this,'TP.sig.InvalidName',arguments);}if(!TP.elementHasAttribute(b,c,d)){a=e;}else{a=TP.elementGetAttribute(b,c,d);a=a.split(' ').add(e).unique().join(' ');}TP.elementSetAttribute(b,c,a,d);});TP.definePrimitive('elementAddContent',function(b,c,d,e){var a;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments,'Must provide a target Element node.');}a=TP.canInvoke(c,'getResource')?c.getResource():c;a=TP.unwrap(a);if(TP.isHTMLNode(b)){return TP.htmlElementAddContent(b,a,d,e);}else{return TP.xmlElementAddContent(b,a,d,e);}return;});TP.definePrimitive('elementBecome',function(a,h,f,w,v){var t,b,r,p,c,l,q,d,j,k,n,o,s,m,e,i,g,u;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(h)){return TP.raise(this,'TP.sig.InvalidName',arguments);}t=TP.isValid(f)?f.asAttributeString():'';if(TP.isEmpty(c=w)){if(TP.regex.HAS_COLON.test(h)){b=h.split(':').first();if(TP.isEmpty(c=TP.elementGetAttribute(a,'xmlns:'+b))){if(!TP.isElement(r=TP.nodeGetFirstElementAncestorByAttribute(a,'xmlns:'+b))){c=TP.w3.Xmlns.getPrefixURI(b);}else{c=TP.elementGetAttribute(r,'xmlns:'+b);}}if(TP.isEmpty(c)){c='urn:'+b;TP.w3.Xmlns.registerNSInfo(c,TP.hc('uri',c,'prefix',b));}}else{if(TP.isEmpty(c)){c=TP.w3.Xmlns.XHTML;}}}if(TP.notValid(f)||TP.notValid(f.at('tibet:sourcetag'))){if(TP.isEmpty(a.prefix)){l=' tibet:sourcetag="'+TP.canonical(a)+'"';}else{l=' tibet:sourcetag="'+TP.qname(a)+'"';}}else{l='';}b=TP.notEmpty(b)?':'+b:'';q=TP.join('<',h,' xmlns'+b+'="',c,'"',(b===':tibet'?'':' xmlns:tibet="'+TP.w3.Xmlns.TIBET+'" ')+l,' ',t,'>','</',h,'>');d=TP.elem(q);if(TP.notValid(d)){return;}if(TP.notEmpty(a)){TP.nodeMoveChildNodesTo(a,d,null,false);}if(TP.notFalse(v)){p=true;if(TP.notEmpty(j=TP.nodeGetNSURI(a))){if(TP.isEmpty(k=a.prefix)){k=TP.w3.Xmlns.getURIPrefix(j,a);}}if(TP.notEmpty(o=TP.nodeGetNSURI(d))){if(TP.isEmpty(n=d.prefix)){n=TP.w3.Xmlns.getURIPrefix(o,a);}}if(j===o&&k===n){p=false;}}s=a.attributes.length;for(m=0;m<s;m++){e=a.attributes[m];if((i=e.value)===c){continue;}if((g=TP.attributeGetLocalName(e))==='xmlns'){continue;}if(TP.isValid(f)&&TP.isValid(u=f.at(TP.attributeGetFullName(e)))){e.value=u;continue;}if(TP.notEmpty(e.namespaceURI)){if(TP.notEmpty(b=e.prefix)){TP.elementSetAttributeInNS(d,b+':'+g,i,e.namespaceURI);}else{TP.elementSetAttributeInNS(d,g,i,e.namespaceURI);}}else if(p&&TP.isString(j)&&TP.notEmpty(k)&&!TP.NEVER_PREFIXED_ATTRS.contains(g)){TP.elementSetAttributeInNS(d,k+':'+g,i,j);}else{TP.elementSetAttribute(d,g,i);}}d=TP.nodeReplaceChild(a.parentNode,d,a);return d;});TP.definePrimitive('elementBubbleXMLNSAttributes',function(a){var c,d,e,b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}c=TP.nodeGetDocument(a).documentElement;d=TP.elementGetXMLNSAttributes(c,true);e=TP.elementGetXMLNSAttributes(a,true);b=TP.nodeGetAncestors(a);e.perform(function(k){var e,f,j,g,h,i;e=k.first();f=k.last();j=d.at(e);if(TP.isValid(j)&&j===f){TP.elementRemoveNamespace(a,e);return;}for(g=0;g<b.getSize();g++){h=b.at(g);i=TP.elementGetAttribute(h,e,true);if(TP.isEmpty(i)){if(h!==c){continue;}else{TP.elementAddNamespace(h,e,f);TP.elementRemoveNamespace(a,e);return;}}if(i===f){TP.elementRemoveNamespace(a,e);return;}if(i!==f&&g>0){TP.elementAddNamespace(b.at(g-1),e,f);TP.elementRemoveNamespace(a,e);return;}}});return;});TP.definePrimitive('elementCopyXMLNSAttributes',function(c,d){var e,b,a;if(!TP.isElement(c)||!TP.isElement(d)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}e=c.attributes.length;for(b=0;b<e;b++){a=c.attributes[b];if(a.namespaceURI===TP.w3.Xmlns.XMLNS||a.prefix==='xmlns'){if(/xmlns:/g.test(a.name)){TP.elementAddNamespace(d,a.name,a.value);}}}return;});TP.definePrimitive('elementFlagChange',function(f,d,g,j){var c,a,e,i,b,h;c=TP.elementGetAttribute(f,'tibet:crud',true);a=c.split('|');e=false;i=a.getSize();for(b=0;b<i;b++){h=a.at(b).split(':');if(h.first()===d){if(TP.notFalse(j)){a.atPut(b,d+':'+g);}e=true;break;}}if(!e){a.push(d+':'+g);}c=a.join('|');TP.elementSetAttributeInNS(f,'tibet:crud',c,TP.w3.Xmlns.TIBET);return;});TP.definePrimitive('elementGetChangeAction',function(f,g){var d,b,e,a,c;if(TP.isEmpty(d=TP.elementGetAttribute(f,'tibet:crud',true))){return null;}b=d.split('|');e=b.getSize();for(a=0;a<e;a++){c=b.at(a).split(':');if(c.first()===g){return c.last();}}return null;});TP.definePrimitive('elementGetXMLNSAttributes',function(d,f){var b,e,c,a;b=TP.hc();e=d.attributes.length;for(c=0;c<e;c++){a=d.attributes[c];if(a.namespaceURI===TP.w3.Xmlns.XMLNS||a.prefix==='xmlns'){if(a.name==='xmlns'){if(TP.isTrue(f)){b.atPut('xmlns',a.value);}}else{b.atPut(a.name,a.value);}}}return b;});TP.definePrimitive('elementFromString',function(b,c,d){var a;a=TP.nodeFromString(b,c,d);if(TP.isElement(a)){return a;}if(TP.isFragment(a)){TP.ifWarn()?TP.warn('Multiple nodes created. Creating first element.',TP.LOG,arguments):0;return TP.nodeGetFirstChildElement(a);}return;});TP.definePrimitive('$elementGetAttribute',function(a,c,h){var f,d,g,b,i,e;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(c)){return TP.raise(this,'TP.sig.InvalidName',arguments);}if(TP.isHTMLNode(a)){f='elementGet'+c.asTitleCase();if(TP.canInvoke(TP,f)){return TP[f](a);}if(TP.isAttributeNode(b=a.getAttributeNode(c))){return TP.ifInvalid(b.value,'');}d=TP.w3.Xmlns.XHTML;g='html';}else{d=a.namespaceURI;g=a.prefix;}i=TP.regex.HAS_COLON.test(c);if(i){b=TP.$elementGetPrefixedAttributeNode(a,c,h);}else{if(TP.isAttributeNode(b=a.getAttributeNode(c))){return TP.ifInvalid(b.value,'');}if(TP.isEmpty(e=g)){if(TP.isString(d)){e=TP.w3.Xmlns.getURIPrefix(d);}}if(TP.isEmpty(e)){return'';}b=TP.$elementGetPrefixedAttributeNode(a,e+':'+c,h);}if(TP.isAttributeNode(b)){return TP.ifInvalid(b.value,'');}return'';});TP.definePrimitive('elementGetAttribute',function(a,b,c){return TP.$elementGetAttribute(a,b,c);});TP.definePrimitive('elementGetAttributes',function(e,g,j){var f,d,b,h,c,a,i;if(!TP.isElement(e)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}f=e.prefix;d=TP.hc();if(TP.isString(g)){b=TP.elementGetAttributeNodes(e,g);}else{b=e.attributes;}h=b.length;for(c=0;c<h;c++){a=b[c].name;if(j){a=a.slice(a.indexOf(':')+1);d.atPut(a,b[c].value);}else if((i=a.indexOf(':'))!==-1){d.atPut(a,b[c].value);}else{if(TP.notEmpty(f)){d.atPut(f+':'+a,b[c].value);}d.atPut(a,b[c].value);}}return d;});TP.definePrimitive('elementGetAttributeNames',function(d,i){var e,b,f,g,c,a,h;if(!TP.isElement(d)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}e=d.prefix;b=TP.ac();f=d.attributes;g=f.length;for(c=0;c<g;c++){a=f[c].name;if(i){a=a.slice(a.indexOf(':')+1);b.push(a);}else if((h=a.indexOf(':'))!==-1){b.push(a);a=a.slice(h+1);b.push(a);}else{if(TP.notEmpty(e)){b.push(e+':'+a);}b.push(a);}}return b;});TP.definePrimitive('elementGetAttributesAsNumbers',function(e,g,j){var f,d,b,h,c,a,i;if(!TP.isElement(e)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}f=e.prefix;d=TP.hc();if(TP.isString(g)){b=TP.elementGetAttributeNodes(e,g);}else{b=e.attributes;}h=b.length;for(c=0;c<h;c++){a=b[c].name;if(j){a=a.slice(a.indexOf(':')+1);d.atPut(a,parseFloat(b[c].value));}else if((i=a.indexOf(':'))!==-1){d.atPut(a,parseFloat(b[c].value));a=a.slice(i+1);d.atPut(a,parseFloat(b[c].value));}else{if(TP.notEmpty(f)){d.atPut(f+':'+a,parseFloat(b[c].value));}d.atPut(a,parseFloat(b[c].value));}}return d;});TP.definePrimitive('elementGetAttributeNodes',function(d,a){var e,f,g,h,b,c;if(!TP.isElement(d)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(a)){return TP.ac(d.attributes);}if(TP.isRegExp(a)){e=a;}else{e=TP.getQNameRegex(a);}f=TP.ac();g=d.attributes;h=g.length;for(b=0;b<h;b++){c=g[b];if(e.test(c.name)&&c.specified){f.push(c);}}return f;});TP.definePrimitive('elementGetAttributeNodesInNS',function(c,e,f){var d,a,g,b;if(!TP.isElement(c)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(f)){return TP.raise(this,'TP.sig.InvalidName',arguments);}d=TP.ac();if(TP.isString(e)){a=TP.elementGetAttributeNodes(c,e);}else{a=c.attributes;}g=a.length;for(b=0;b<g;b++){if(f===a[b].namespaceURI){d.push(a[b]);}}return d;});TP.definePrimitive('elementGetCanonicalName',function(b,e){var c,d,a;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!e&&TP.notEmpty(c=b.getAttribute('tibet:sourcetag'))){return c;}d=TP.nodeGetNSURI(b);if(TP.notEmpty(d)){a=TP.w3.Xmlns.getCanonicalPrefix(d);}if(TP.isEmpty(a)){if(TP.isHTMLNode(b)){a='html';}else{a=b.prefix;if(TP.isEmpty(a)&&TP.isXHTMLNode(b)){a='html';}}}c=TP.elementGetLocalName(b);if(TP.isEmpty(a)){return c;}else if(a==='html'){return a+':'+c.toLowerCase();}else{return a+':'+c;}});TP.definePrimitive('elementGetDocumentIndex',function(c,d){var a,e,b;if(!TP.isElement(c)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isDocument(c)){return TP.NOT_FOUND;}a=c;b=TP.ac();while(TP.isElement(a)&&(e=TP.nodeGetIndexInParent(a,true))!==TP.NOT_FOUND){b.push(e+1);a=a.parentNode;}if(TP.isEmpty(b)){return TP.NOT_FOUND;}return(d||'/')+b.reverse().join(d||'/');});TP.definePrimitive('elementGetFullName',function(b,d){var a,c;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!d&&TP.notEmpty(a=b.getAttribute('tibet:sourcetag'))){return a;}a=TP.elementGetLocalName(b);if(TP.regex.HAS_COLON.test(a)){return a;}if(TP.isEmpty(c=b.prefix)){if(TP.isHTMLNode(b)||TP.isXHTMLNode(b)){c='html';}}if(TP.isEmpty(c)){return a;}else if(c==='html'){return c+':'+a.toLowerCase();}else{return c+':'+a;}});TP.definePrimitive('$elementGetPrefixedAttributeNode',function(b,e,n){var c,f,g,d,a,l,i,j,m,h,k;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(e)){return TP.raise(this,'TP.sig.InvalidName',arguments);}if(TP.isTrue(n)){c=e.match(TP.regex.NS_QUALIFIED);if(TP.notValid(c)){return null;}f=c.at(1);g=c.at(2);d=TP.w3.Xmlns.getPrefixURI(f);if(TP.notEmpty(d)){if(TP.isAttributeNode(a=b.getAttributeNode(e))){if(TP.nodeGetNSURI(a)===d){return a;}}if(TP.nodeGetNSURI(b)===d){if(TP.isAttributeNode(a=b.getAttributeNode(g))){return a;}}if(TP.isElement(l=TP.elem(TP.nodeGetDocument(b)))){i=TP.nodeGetNSPrefixes(l,d,false);}if(TP.notEmpty(i)&&i.getSize()===1&&i.at(0)===f){return null;}j=b.attributes;m=j.length;for(h=0;h<m;h++){a=j[h];if(TP.attributeGetLocalName(a)===g&&TP.nodeGetNSURI(a)===d){return a;}}return null;}else{}}if(TP.isAttributeNode(a=b.getAttributeNode(e))){return a;}else{c=e.match(TP.regex.NS_QUALIFIED);if(TP.notValid(c)){return null;}f=c.at(1);g=c.at(2);if(TP.isEmpty(k=b.prefix)){if(TP.isString(b.namespaceURI)){k=TP.w3.Xmlns.getURIPrefix(b.namespaceURI);}}if(k===f){if(TP.isAttributeNode(a=b.getAttributeNode(g))){return a;}}}return null;});TP.definePrimitive('elementHasAttributeValue',function(a,b,c,e){var f,d;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidName',arguments);}if(!TP.elementHasAttribute(a,b,e)){return false;}f=TP.elementGetAttribute(a,b,e);if(TP.isRegExp(c)){d=c;}else{d=TP.rc('(^|\\s)'+c+'(\\s|$)');}return d.test(f);});TP.definePrimitive('elementInsertContent',function(b,c,g,e,f){var d,a;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments,'Must provide a target Element node.');}if(TP.notValid(c)){return;}d=TP.ifEmpty(g,TP.BEFORE_END);a=TP.canInvoke(c,'getResource')?c.getResource():c;a=TP.unwrap(a);if(TP.isHTMLNode(b)){return TP.htmlElementInsertContent(b,a,d,e,f);}else{return TP.xmlElementInsertContent(b,a,d,e,f);}return;});TP.definePrimitive('elementMergeAttributes',function(c,b,s,m,r){var q,l,i,f,e,j,k,n,o,h,a,g,d,p;if(!TP.isElement(c)||!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}q=TP.ifInvalid(s,false);l=TP.isRegExp(m)?true:false;n=b.namespaceURI;if(TP.isTrue(r)){i=true;if(TP.notEmpty(e=TP.nodeGetNSURI(c))){if(TP.isEmpty(f=c.prefix)){f=TP.w3.Xmlns.getURIPrefix(e,c);}}if(TP.notEmpty(k=TP.nodeGetNSURI(b))){if(TP.isEmpty(j=b.prefix)){j=TP.w3.Xmlns.getURIPrefix(k,c);}}if(e===k&&f===j){i=false;}}o=c.attributes.length;for(h=0;h<o;h++){a=c.attributes[h];if(l&&!m.test(a.name)){continue;}if((g=a.value)===n){continue;}if((d=TP.attributeGetLocalName(a))==='xmlns'){continue;}if(!q&&TP.elementHasAttribute(b,a.name)){continue;}if(TP.notEmpty(a.namespaceURI)){if(TP.notEmpty(p=a.prefix)){TP.elementSetAttributeInNS(b,p+':'+d,g,a.namespaceURI);}else{TP.elementSetAttributeInNS(b,d,g,a.namespaceURI);}}else if(i&&TP.isString(e)&&TP.notEmpty(f)&&!TP.NEVER_PREFIXED_ATTRS.contains(d)){TP.elementSetAttributeInNS(b,f+':'+d,g,e);}else{TP.elementSetAttribute(b,d,a.value);}}return;});TP.definePrimitive('elementReplaceWith',function(b,c,d,e){var a;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments,'Must provide a target Element node.');}a=TP.canInvoke(c,'getResource')?c.getResource():c;a=TP.unwrap(a);if(TP.isHTMLNode(b)){return TP.htmlElementReplaceWith(b,a,d,e);}else{return TP.xmlElementReplaceWith(b,a,d,e);}return;});TP.definePrimitive('elementReplaceAttributeValue',function(a,b,f,g,d){var c,e;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidName',arguments);}if(!TP.elementHasAttribute(a,b,d)){return;}c=TP.elementGetAttribute(a,b,d);e=TP.rc('(^|\\s)'+f+'(\\s|$)');c=c.replace(e,'$1'+g+'$2');TP.elementSetAttribute(a,b,c,d);return;});TP.definePrimitive('elementRemoveNamespace',function(b,a){var c;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isXMLDocument(TP.nodeGetDocument(b))){return TP.raise(this,'TP.sig.InvalidXMLDocument',arguments);}if(TP.isEmpty(a)){return TP.raise(this,'TP.sig.InvalidString',arguments,'Invalid or empty prefix or URI');}if(a==='xmlns'){return;}if(/xmlns:/g.test(a)){c=a.slice(6);}else{c=a;}b.removeAttributeNS(TP.w3.Xmlns.XMLNS,c);return;});TP.definePrimitive('$elementSetAttribute',function(a,b,c,h){var d,e,i,f,g;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidName',arguments);}if(TP.isTrue(h)&&TP.regex.NS_QUALIFIED.test(b)){d=b.match(TP.regex.NS_QUALIFIED);e=d.at(1);i=d.at(2);if(a.tagName.indexOf(e+':')===0){return TP.elementSetAttributeInNS(a,b,c,a.namespaceURI);}f=TP.w3.Xmlns.getPrefixURI(e);if(TP.notEmpty(f)){return TP.elementSetAttributeInNS(a,b,c,f);}}g='elementSet'+b.asTitleCase();if(TP.canInvoke(TP,g)){TP[g](a,c);return;}try{return a.setAttribute(b,c);}catch(d){if(/Member not found/.test(TP.str(d))&&TP.isValid(a[b].value)){a[b].value=c;}}return;});TP.definePrimitive('elementSetAttribute',function(a,b,c,d){return TP.$elementSetAttribute(a,b,c,d);});TP.definePrimitive('elementSetAttributes',function(a,b,c){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.notValid(b)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}b.perform(function(b){TP.elementSetAttribute(a,b.first(),b.last(),c);});return;});TP.definePrimitive('elementSetContent',function(a,c,d,e){var b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments,'Must provide a target Element node.');}if(TP.notValid(c)){TP.nodeEmptyContent(a);}b=TP.canInvoke(c,'getResource')?c.getResource():c;b=TP.unwrap(b);if(TP.isHTMLNode(a)){return TP.htmlElementSetContent(a,b,d,e);}else{return TP.xmlElementSetContent(a,b,d,e);}return;});TP.definePrimitive('elementStripChangeFlags',function(a){var b;TP.elementRemoveAttribute(a,'tibet:crud',true);b=TP.nodeGetDescendantElementsByAttribute(a,'tibet:crud');b.perform(function(a){TP.elementRemoveAttribute(a,'tibet:crud',true);});return;});TP.definePrimitive('xmlElementAddContent',function(a,b,c,d){return TP.xmlElementInsertContent(a,b,TP.BEFORE_END,c,d);});TP.definePrimitive('xmlElementInsertContent',function(a,c,i,h,j){var e,f,b,d,g;if(!TP.isXMLNode(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}e=TP.ifInvalid(j,TP.nodeHasWindow(a));f=TP.ifEmpty(i,TP.BEFORE_END);if(TP.isXMLNode(c)){if(TP.isDocument(c)){b=c.documentElement;}else{b=c;}}else if(TP.isString(c)){if(TP.notValid(b=TP.nodeFromString(c,null,true))){b=TP.nodeGetDocument(a).createTextNode(c);}}else{TP.raise(this,'TP.sig.UnsupportedOperation',arguments);return null;}switch(f){case TP.AFTER_END:d=TP.nodeInsertBefore(a.parentNode,b,a.nextSibling,e);break;case TP.BEFORE_BEGIN:d=TP.nodeInsertBefore(a.parentNode,b,a,e);break;case TP.AFTER_BEGIN:d=TP.nodeInsertBefore(a,b,a.firstChild,e);break;case TP.BEFORE_END:d=TP.nodeAppendChild(a,b,e);break;default:if(TP.isNode(g=TP.nodeEvaluatePath(a,f,null,true))){TP.nodeInsertBefore(a,b,g,e);}}if(TP.isElement(d)){TP.elementBubbleXMLNSAttributes(d);}if(TP.isCallable(h)){h(a.parentNode);}try{if(TP.sys.shouldSignalDOMLoaded()){TP.signal(TP.gid(a.parentNode),'TP.sig.DOMContentLoaded',arguments,b);}}catch(a){TP.ifError()?TP.error(TP.ec(a,'TP.sig.DOMContentLoaded handler generated error.'),TP.LOG,arguments):0;}return d;});TP.definePrimitive('xmlElementReplaceWith',function(a,b,e,h){var f,c,g,d;if(!TP.isXMLNode(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}f=TP.ifInvalid(h,TP.nodeHasWindow(a));if(TP.isXMLNode(b)){if(TP.isDocument(b)){c=b.documentElement;}else{c=b;}}else if(TP.isString(b)){if(TP.notValid(c=TP.nodeFromString(b,null,true))){c=TP.nodeGetDocument(a).createTextNode(b);}}else{TP.raise(this,'TP.sig.UnsupportedOperation',arguments);return null;}g=TP.gid(a);d=TP.nodeReplaceChild(a.parentNode,c,a,f);if(TP.isElement(d)){TP.elementBubbleXMLNSAttributes(d);}if(TP.isCallable(e)){e(a);}try{if(TP.sys.shouldSignalDOMLoaded()){TP.signal(g,'TP.sig.DOMContentLoaded',arguments,d);}}catch(a){TP.ifError()?TP.error(TP.ec(a,'TP.sig.DOMContentLoaded handler generated error.'),TP.LOG,arguments):0;}return d;});TP.definePrimitive('xmlElementSetContent',function(b,a,e,g){var f,c,d;if(!TP.isXMLNode(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}f=TP.ifInvalid(g,TP.nodeHasWindow(b));if(TP.isXMLNode(a)){if(TP.isDocument(a)){c=a.documentElement;}else{c=a;}}else if(TP.isString(a)){if(TP.notValid(c=TP.nodeFromString(a,null,true))){c=TP.nodeGetDocument(b).createTextNode(a);}}else{TP.raise(this,'TP.sig.UnsupportedOperation',arguments);return null;}TP.nodeEmptyContent(b);d=TP.nodeAppendChild(b,c,f);if(TP.isElement(d)){TP.elementBubbleXMLNSAttributes(d);}if(TP.isCallable(e)){e(b);}try{if(TP.sys.shouldSignalDOMLoaded()){TP.signal(TP.gid(b),'TP.sig.DOMContentLoaded',arguments,a);}}catch(a){TP.ifError()?TP.error(TP.ec(a,'TP.sig.DOMContentLoaded handler generated error.'),TP.LOG,arguments):0;}return d;});TP.definePrimitive('elementIsNested',function(a){var b,c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}b=TP.canonical(a);c=TP.nodeDetectAncestor(a,function(a){return TP.canonical(a)===b;});return TP.isElement(c);});TP.definePrimitive('fragmentFromString',function(c,d,e){var a,b;a=TP.nodeFromString(c,d,e);if(TP.isFragment(a)){return a;}else if(TP.isNode(a)){b=TP.documentCreateFragment(TP.nodeGetDocument(a));TP.nodeAppendChild(b,a,false);return b;}return;});TP.definePrimitive('nodeListAsDocument',function(b,e,f){var d,c,a;if(!TP.isNodeList(b)){return TP.raise(this,'TP.sig.InvalidNodeList',arguments);}d=TP.ifEmpty(e,'instanceData');if(TP.notValid(c=TP.createDocument(f,d))){return;}if(TP.notValid(c.documentElement)){return TP.raise(this,'TP.sig.InvalidDocument',arguments,'No documentElement found.');}for(a=0;a<b.length;a++){if(!TP.isXMLNode(b[a])){return TP.raise(this,'TP.sig.InvalidNode',arguments,'All nodes must be XML nodes.');}TP.nodeAppendChild(c.documentElement,TP.nodeCloneNode(b[a],true),false);}return c;});TP.definePrimitive('nodeListAsFragment',function(b,g,j){var a,d,c,h,f,e,i;if(!TP.isNodeList(b)){return TP.raise(this,'TP.sig.InvalidNodeList',arguments);}if(b.length<1){a=TP.ifInvalid(g,TP.XML_FACTORY_DOCUMENT);return TP.documentCreateFragment(a);}i=b.item(0);a=TP.ifInvalid(g,TP.nodeGetDocument(i));if(TP.notValid(d=TP.documentCreateFragment(a))){return;}e=TP.ac(b);h=e.getSize();for(c=0;c<h;c++){f=e.at(c);TP.nodeAppendChild(d,j?TP.copy(f):f,false);}return d;});TP.definePrimitive('nodeAddContent',function(a,b,c,d){return TP.nodeInsertContent(a,b,TP.BEFORE_END,c,d);});TP.definePrimitive('nodeAppendChild',function(e,a,j){var b,h,c,g,d,i,f;if(!TP.isCollectionNode(e)){return TP.raise(this,'TP.sig.InvalidNode',arguments,e);}if(TP.isString(a)){b=TP.nodeFromString(a);if(!TP.isNode(a)){return;}}else if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,a);}else{b=a;}if(TP.isDocument(e)){if(TP.isElement(e.documentElement)){TP.raise(this,'TP.sig.InvalidOperation',arguments,'Cannot append to #document node with an'+' existing root.');return;}else if(TP.isFragment(b)){h=TP.nodeGetFirstChildElement(b);if(TP.notValid(h)){TP.raise(this,'TP.sig.InvalidOperation',arguments,'Must supply element for #document root.');return;}else if(b.childNodes.length>1){TP.debug('break.node_discarded');TP.ifWarn(TP.sys.cfg('log.node_discarded'))?TP.warn('Discarding nodes from fragment: '+TP.str(b),TP.LOG,arguments):0;}b=h;}}c=e;if(TP.isElement(a)){g=TP.$$elementPreserveIFrameContent(a);}d=TP.nodeImportNode(c,b);i=TP.ifInvalid(j,TP.isHTMLNode(d)?true:false);f=c.childNodes.length;try{c.appendChild(d);}catch(a){TP.ifError()?TP.error(TP.ec(a,'appendChild generated error.'),TP.LOG,arguments):0;return;}if(TP.isFragment(a)){TP.nodeEmptyContent(a);}if(TP.isElement(c)&&TP.notEmpty(g)){TP.$$elementRestoreIFrameContent(c,g);}if(i){TP.nodeAwakenChildNodesFromTo(c,f,TP.LAST);}if(TP.isFragment(d)){return c.childNodes[f];}return d;});TP.definePrimitive('nodeDetach',function(a){if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}return TP.nodeRemoveChild(a.parentNode,a);});TP.definePrimitive('nodeGetAncestorPositions',function(c,g,h,i){var a,b,d,e,f;if(!TP.isNode(c)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}f=TP.ifInvalid(h,'');b=TP.ac();if(TP.isAttributeNode(c)){a=TP.attributeGetOwnerElement(c);d=TP.nodeGetIndexInParent(a);b.push(d+'@'+TP.attributeGetLocalName(c));a=a.parentNode;}else if(TP.isElement(c)){a=c;}else{a=c.parentNode;}while(TP.isElement(a)&&(d=TP.nodeGetIndexInParent(a))!==TP.NOT_FOUND){b.push(d);a=a.parentNode;}if(d===TP.NOT_FOUND){return TP.NOT_FOUND;}b.reverse();if(TP.notTrue(g)){b.length=b.length-1;}e=TP.ac();while(b.length>0){e.push(f+b.join(i||'.'));b.length=b.length-1;}return e;});TP.definePrimitive('nodeGetControlElement',function(a){if(TP.isElement(a)&&(TP.elementHasAttribute(a,'tibet:sourcetag',true)||TP.elementHasAttribute(a,'tibet:nodetype',true))){return a;}return TP.nodeGetFirstElementAncestorByAttribute(a,'tibet:sourcetag tibet:nodetype');});TP.definePrimitive('nodeGetControlId',function(c,d){var a,b;a=TP.nodeGetControlElement(c);if(TP.isElement(a)){b=TP.elementGetAttribute(a,'id');if(TP.isEmpty(b)&&TP.isTrue(d)){b=TP.lid(a,true);}}return b;});TP.definePrimitive('nodeGetDocumentPosition',function(b,e){var a,c,d;if(!TP.isNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}d=TP.ac();if(TP.isAttributeNode(b)){a=TP.attributeGetOwnerElement(b);c=TP.nodeGetIndexInParent(a);d.push(c+'@'+TP.attributeGetLocalName(b));a=a.parentNode;}else if(TP.isElement(b)){a=b;}else{a=b.parentNode;}while(TP.isElement(a)&&(c=TP.nodeGetIndexInParent(a))!==TP.NOT_FOUND){d.push(c);a=a.parentNode;}if(c===TP.NOT_FOUND){return TP.NOT_FOUND;}return d.reverse().join(e||'.');});TP.definePrimitive('nodeGetIndexInParent',function(c,f){var d,b,e,a;if(!TP.isNode(c)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.notValid(d=c.parentNode)){return TP.NOT_FOUND;}if(TP.isTrue(f)){b=TP.nodeGetChildElements(d);}else{b=TP.nodeGetChildNodes(d);}e=b.length;for(a=0;a<e;a++){if(b[a]===c){return a;}}return TP.NOT_FOUND;});TP.definePrimitive('nodeInsertBefore',function(d,b,f,i){var c,g,a,h,e,j,k,l;if(!TP.isCollectionNode(d)){return TP.raise(this,'TP.sig.InvalidNode',arguments,d);}if(TP.isString(b)){c=TP.nodeFromString(b);if(!TP.isNode(b)){return;}}else if(!TP.isNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,b);}else{c=b;}if(TP.isDocument(d)){if(TP.isElement(d.documentElement)){TP.raise(this,'TP.sig.InvalidOperation',arguments,'Cannot insertBefore #document node with an existing root.');return;}else if(TP.isNode(f)){TP.raise(this,'TP.sig.InvalidOperation',arguments,'Cannot insertBefore empty #document using insertion point.');return;}else if(TP.isFragment(c)){g=TP.nodeGetFirstChildElement(c);if(TP.notValid(g)){TP.raise(this,'TP.sig.InvalidOperation',arguments,'Must supply element for #document root.');return;}else if(c.childNodes.length>1){TP.debug('break.node_discarded');TP.ifWarn(TP.sys.cfg('log.node_discarded'))?TP.warn('Discarding nodes from fragment: '+TP.str(c),TP.LOG,arguments):0;}return TP.nodeAppendChild(d,g,i);}}a=d;if(!a.hasChildNodes()||TP.notValid(f)){return TP.nodeAppendChild(a,c,i);}if(TP.isElement(b)){h=TP.$$elementPreserveIFrameContent(b);}e=TP.nodeImportNode(a,c);j=TP.ifInvalid(i,TP.isHTMLNode(e)?true:false);if(j||TP.isFragment(e)){k=TP.nodeGetChildIndex(a,f);}try{a.insertBefore(e,f);}catch(a){TP.ifError()?TP.error(TP.ec(a,'insertBefore generated error.'),TP.LOG,arguments):0;return;}if(TP.isFragment(b)){TP.nodeEmptyContent(b);}if(TP.isElement(a)&&TP.notEmpty(h)){TP.$$elementRestoreIFrameContent(a,h);}if(j){l=TP.nodeGetChildIndex(a,f)-1;TP.nodeAwakenChildNodesFromTo(a,k,l);}if(TP.isFragment(e)){return a.childNodes[k];}return e;});TP.definePrimitive('nodeInsertContent',function(a,g,h,d,e){var c,b,f;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Must provide a valid target Node.');}c=TP.ifEmpty(h,TP.BEFORE_END);b=TP.canInvoke(g,'getResource')?g.getResource():g;b=TP.unwrap(b);switch(a.nodeType){case Node.ELEMENT_NODE:if(TP.isHTMLNode(a)){return TP.htmlElementInsertContent(a,b,c,d,e);}else{return TP.xmlElementInsertContent(a,b,c,d,e);}break;case Node.TEXT_NODE:case Node.CDATA_SECTION_NODE:case Node.PROCESSING_INSTRUCTION_NODE:case Node.COMMENT_NODE:switch(c){case TP.BEFORE_BEGIN:if(TP.notValid(f=TP.node(b))){this.raise('TP.sig.InvalidContent',arguments);return;}TP.nodeInsertBefore(a.parentNode,f,a,false);break;case TP.AFTER_BEGIN:a.data=TP.str(b)+(a.data||'');break;case TP.BEFORE_END:a.data=(a.data||'')+TP.str(b);break;case TP.AFTER_END:if(TP.notValid(f=TP.node(b))){this.raise('TP.sig.InvalidContent',arguments);return;}if(TP.notValid(a.nextSibling)){TP.nodeAppendChild(a.parentNode,f,false);}else{TP.nodeInsertBefore(a.parentNode,f,a.nextSibling,false);}break;default:TP.raise(this,'TP.sig.InvalidPosition',arguments);break;}break;case Node.DOCUMENT_NODE:if(TP.isHTMLNode(a)){return TP.htmlDocumentInsertContent(a,b,c,d,e);}else{return TP.xmlDocumentInsertContent(a,b,c,d);}break;case Node.ATTRIBUTE_NODE:switch(c){case TP.BEFORE_BEGIN:TP.raise(this,'TP.sig.InvalidPosition',arguments);break;case TP.AFTER_BEGIN:a.value=TP.str(b)+(a.value||'');break;case TP.BEFORE_END:a.value=(a.value||'')+TP.str(b);break;case TP.AFTER_END:TP.raise(this,'TP.sig.InvalidPosition',arguments);break;default:TP.raise(this,'TP.sig.InvalidPosition',arguments);break;}break;case Node.DOCUMENT_FRAGMENT_NODE:if(TP.isHTMLNode(a)){return TP.htmlElementInsertContent(a,b,c,d,e);}else{return TP.xmlElementInsertContent(a,b,c,d,e);}break;case Node.ENTITY_REFERENCE_NODE:case Node.ENTITY_NODE:case Node.DOCUMENT_TYPE_NODE:case Node.NOTATION_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;default:break;}return a;});TP.definePrimitive('nodeIsDetached',function(a,b){var c;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(a===b){return false;}if(TP.isDocument(b)){if(TP.isDocument(a)){return a!==b;}else if(TP.nodeGetDocument(a)!==b){return true;}}if(TP.isNode(b)){return!TP.nodeContainsNode(b,a);}if(TP.isDocument(a)){return false;}c=a;while(c&&(c=c.parentNode)){if(TP.isDocument(c)){return false;}}return true;});TP.definePrimitive('nodeNormalize',function(a){if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}a.normalize();return a;});TP.definePrimitive('nodeReplaceChild',function(e,b,g,l){var a,k,c,h,f,j,d,i;if(!TP.isNode(e)||!TP.isNode(g)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isString(b)){a=TP.nodeFromString(b);if(!TP.isNode(b)){return;}}else if(!TP.isNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,b);}else{a=b;}if(TP.isDocument(e)){if(TP.notValid(e.documentElement)){TP.raise(this,'TP.sig.InvalidOperation',arguments,'Cannot replaceChild with empty #document node.');return;}else if(g!==e.documentElement){TP.raise(this,'TP.sig.InvalidOperation',arguments,'Cannot replaceChild other than #document node'+' root.');return;}else if(TP.isFragment(a)){k=TP.nodeGetFirstChildElement(a);if(TP.notValid(k)){TP.raise(this,'TP.sig.InvalidOperation',arguments,'Must supply element for #document root.');return;}else if(a.childNodes.length>1){TP.debug('break.node_discarded');TP.ifWarn(TP.sys.cfg('log.node_discarded'))?TP.warn('Discarding nodes from fragment: '+TP.str(a),TP.LOG,arguments):0;}a=k;}}c=e;if(TP.isElement(b)){h=TP.$$elementPreserveIFrameContent(b);}f=TP.nodeImportNode(c,a);j=TP.ifInvalid(l,TP.isHTMLNode(f)?true:false);if(j||TP.isFragment(a)){d=TP.nodeGetChildIndex(c,g);}try{c.replaceChild(f,g);}catch(a){TP.ifError()?TP.error(TP.ec(a,'replaceChild generated error.'),TP.LOG,arguments):0;return;}if(TP.isFragment(b)){TP.nodeEmptyContent(b);}if(TP.isElement(c)&&TP.notEmpty(h)){TP.$$elementRestoreIFrameContent(c,h);}if(j){if(TP.isValid(a.childNodes)){i=d+(a.childNodes.length-1);}else{i=d+1;}TP.nodeAwakenChildNodesFromTo(c,d,i);}if(TP.isFragment(f)){return c.childNodes[d];}return f;});TP.definePrimitive('nodeRemoveChild',function(a,b){if(!TP.isNode(a)||!TP.isNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}return a.removeChild(b);});TP.definePrimitive('nodeFromString',function(a,j,i){var f,b,c,g,h,e,d;if(TP.regex.XML_ATTR.test(a)){f=TP.regex.XML_ATTR.match(a);b=TP.XML_FACTORY_DOCUMENT.createAttribute(f.at(1));b.value=f.at(2);return b;}if(TP.regex.XML_COMMENT_WHOLE.test(a)){c=TP.regex.XML_COMMENT_WHOLE.exec(a)[1];b=TP.XML_FACTORY_DOCUMENT.createComment(c);return b;}if(TP.regex.XML_CDATA_WHOLE.test(a)){c=TP.regex.XML_CDATA_WHOLE.exec(a)[1];b=TP.XML_FACTORY_DOCUMENT.createCDATASection(c);return b;}if(TP.regex.XML_PI_WHOLE.test(a)){c=TP.regex.XML_PI_WHOLE.exec(a)[1];g=c.slice(0,c.indexOf(' '));h=c.slice(c.indexOf(' ')+1);b=TP.XML_FACTORY_DOCUMENT.createProcessingInstruction(g,h);return b;}if(TP.isEmpty(a)||!a.trim().startsWith('<')||a.length<'<a/>'.length){return TP.XML_FACTORY_DOCUMENT.createTextNode(a||'');}d=a.trim();d=d.strip(TP.regex.XML_PREFIX);d=d.trim();d=d.replace(TP.regex.ALL_ELEM_MARKUP,'<wrap>$&</wrap>');e=TP.documentFromString(d,j,i);if(TP.isDocument(e)){if(e.documentElement.childNodes.length>1){return TP.nodeListAsFragment(e.documentElement.childNodes);}else{return e.documentElement.firstChild;}}return;});TP.definePrimitive('nodeEvaluateBarename',function(d,h,g,i){var b,e,f,c,a;if(!TP.regex.BARENAME.test(h)){return TP.raise(this,'TP.sig.InvalidPath',arguments);}if(!TP.isCollectionNode(d)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.isEmpty(b=h.slice(1))){return null;}a=null;if(/@\*/.test(b)){e=b.slice(0,b.indexOf('@'));if(TP.isElement(c=TP.nodeGetElementById(d,e))){a=TP.elementGetAttributeNodes(c);}}else if(/@/.test(b)){e=b.slice(0,b.indexOf('@'));f=b.slice(b.indexOf('@')+1);if(TP.isElement(c=TP.nodeGetElementById(d,e))){a=c.getAttributeNode(f);if(!TP.isAttributeNode(a)&&TP.isTrue(i)){TP.elementSetAttribute(c,f,'',true);a=c.getAttributeNode(f);}}}else{a=TP.nodeGetElementById(d,b);}if(TP.notValid(a)&&TP.notTrue(g)){return TP.ac();}if(TP.isArray(a)&&TP.isTrue(g)){if(a.getSize()===1){return a.first();}else if(TP.isEmpty(a)){return null;}}if(!TP.isArray(a)&&TP.notTrue(g)){a=TP.ac(a);}return a;});TP.definePrimitive('nodeEvaluateElementScheme',function(i,d){var c,b,e,j,a,h,l,k,f,g;if(TP.regex.ELEMENT_POINTER.test(d)){c=TP.regex.ELEMENT_POINTER.match(d).at(1);}else if(/^\/1/.test(d)){c=d;}else{return TP.raise(this,'TP.sig.InvalidPath',arguments);}if(!TP.isCollectionNode(i)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(c.startsWith('/')){b=c.split('/');b.shift();}else{b=c.split('/');}e=b.at(0);if(TP.isNumber(parseInt(e,10))){if(parseInt(e,10)!==1){return TP.raise(this,'TP.sig.InvalidPath',arguments,'element() scheme root must have index of 1');}a=TP.nodeGetDocument(i);j=0;if(!TP.isNode(a)){return null;}}else{h=TP.nodeGetDocument(i);if(!TP.isDocument(h)){return TP.raise(this,'TP.sig.DetachedNodeException',arguments);}a=TP.nodeGetElementById(h,e);j=1;if(!TP.isNode(a)){return null;}}k=b.getSize();for(f=j;f<k;f++){g=parseInt(b.at(f),10);if(!TP.isNumber(g)){return TP.raise(this,'TP.sig.InvalidPath',arguments,'element() scheme segments must be integers.');}l=TP.nodeGetChildElements(a);a=l.at(g-1);if(!TP.isNode(a)){return null;}}return a;});TP.definePrimitive('nodeEvaluatePath',function(e,b,h,d,i){var c,f,a,g;if(TP.notValid(e)||!TP.isElement(c=TP.elem(e))){TP.raise(this,'TP.sig.InvalidNode',arguments,'Node does not have path interface.');return;}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidPath',arguments);}if(TP.regex.ATTRIBUTE.test(b)&&!TP.regex.ATTRIBUTE_ALL.test(b)){f=b.slice(1);a=TP.elementGetAttribute(c,f);return TP.isEmpty(a)?null:a;}g=TP.ifInvalid(h,TP.getPathType(b));switch(g){case TP.XPATH_PATH_TYPE:a=TP.nodeEvaluateXPath(c,b,TP.NODESET);if(TP.isTrue(d)){if(a.getSize()===1){return a.at(0);}else if(TP.isEmpty(a)){return null;}}return a;case TP.XPOINTER_PATH_TYPE:return TP.nodeEvaluateXPointer(c,b,d);case TP.XTENSION_POINTER_PATH_TYPE:return TP.nodeEvaluateXTension(c,b,d);case TP.CSS_PATH_TYPE:a=TP.nodeEvaluateCSS(c,b,d);if(TP.notTrue(i)){return a;}if(TP.notValid(a)||TP.isArray(a)&&TP.isEmpty(a)){return TP.nodeEvaluateCSS(TP.nodeGetDocument(c),b,d);}return a;case TP.BARENAME_PATH_TYPE:return TP.nodeEvaluateBarename(TP.nodeGetDocument(c),b,d);default:return null;}return null;});TP.definePrimitive('nodeEvaluateXPointer',function(c,b,d){var e,a;if(TP.regex.ELEMENT_POINTER.test(b)){if(TP.isTrue(d)){return TP.nodeEvaluateElementScheme(c,b);}else{if(TP.notValid(a=TP.nodeEvaluateElementScheme(c,b))){return TP.ac();}return TP.ac(a);}}else if(TP.regex.XPATH_POINTER.test(b)){e=TP.regex.XPATH_POINTER.match(b).at(2);if(TP.isTrue(d)){a=TP.nodeEvaluateXPath(c,e,TP.NODESET);if(a.getSize()===1){return a.first();}else if(TP.isEmpty(a)){return null;}return a;}else{return TP.nodeEvaluateXPath(c,e,TP.NODESET);}}else{if(TP.isTrue(d)){return TP.nodeGetElementById(c,b);}else{if(TP.notValid(a=TP.nodeGetElementById(c,b))){return TP.ac();}return TP.ac(a);}}});TP.definePrimitive('nodeEvaluateXTension',function(c,a,d){var b;if(TP.regex.CSS_POINTER.test(a)){b=a.match(TP.regex.CSS_POINTER).at(1);return TP.nodeEvaluateCSS(c,b,d);}else{TP.ifWarn()?TP.warn('Unsupported query path syntax: '+a,TP.QUERY_LOG,arguments):0;return;}});TP.definePrimitive('nodeGetAncestors',function(c){var a,b;if(!TP.isNode(c)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}b=TP.ac();a=c.parentNode;while(TP.isElement(a)&&a.nodeType!==Node.DOCUMENT_NODE){b.push(a);a=a.parentNode;}return b;});TP.definePrimitive('nodeGetChildNodes',function(a){if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.isElement(a)){TP.nodeNormalize(a);}return TP.ac(a.childNodes);});TP.definePrimitive('nodeGetChildElementAt',function(e,b){var f,g,c,a,h,d;if(!TP.isCollectionNode(e)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.notValid(b)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}f=e.children||e.childNodes;g=f.length;c=0;for(a=0;a<g;a++){h=b===TP.LAST?g-a-1:a;d=f[h];try{if(TP.isElement(d)){switch(b){case 0:case TP.FIRST:case TP.LAST:if(c===0){return d;}break;default:if(c===b){return d;}break;}c++;}}catch(a){}}return;});TP.definePrimitive('nodeGetChildElements',function(a){var c,d,f,b,e;if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.isValid(a.children)){return TP.ac(a.children);}c=TP.ac();d=a.childNodes;f=d.length;for(b=0;b<f;b++){e=d[b];try{if(TP.isElement(e)){c.push(e);}}catch(a){}}return c;});TP.definePrimitive('nodeGetDescendants',function(b,d){var c,a;if(!TP.isCollectionNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}c=TP.ac();a=function(a){c.push(a);};if(TP.isTrue(d)){TP.nodeBreadthTraversal(b,a,null,a,false);}else{TP.nodeDepthTraversal(b,a,null,a,false);}return c;});TP.definePrimitive('nodeGetDescendantsByType',function(b,d,e){var c,a;if(!TP.isCollectionNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.notValid(d)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}c=TP.ac();a=function(a){if(a.nodeType===d){c.push(a);}};if(TP.isTrue(e)){TP.nodeBreadthTraversal(b,a,null,a,false);}else{TP.nodeDepthTraversal(b,a,null,a,false);}return c;});TP.definePrimitive('nodeGetDescendantElementsByAttribute',function(c,a,b,d){if(!TP.isCollectionNode(c)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.isEmpty(a)){return TP.raise(this,'TP.sig.InvalidName',arguments);}return TP.nodeSelectDescendantElements(c,function(e){var f,d,g,c;try{if(TP.regex.IS_NAMEXP.test(a)){f=TP.getQNameRegex(a);d=e.attributes;g=d.length;for(c=0;c<g;c++){if(f.test(d[c].name)){if(TP.isValid(b)){if(!TP.match(b,d[c].value)){continue;}}return true;}}}else{if(TP.notValid(b)){if(TP.elementHasAttribute(e,a)){return true;}}else if(TP.match(b,TP.elementGetAttribute(e,a))){return true;}}}catch(a){}return false;},null,d);});TP.definePrimitive('nodeGetDescendantElementsByAttributePrefix',function(b,a,c,d){var e;if(!TP.isCollectionNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.isEmpty(a)){return TP.raise(this,'TP.sig.InvalidName',arguments);}e=a.endsWith(':')?a:a+':';return TP.nodeSelectDescendantElements(b,function(f){var d,e,b;try{d=f.attributes;e=d.length;for(b=0;b<e;b++){if(d[b].name.indexOf(a)!==TP.NOT_FOUND){if(TP.isValid(c)){if(!TP.match(c,d[b].value)){continue;}}return true;}}}catch(a){}return false;},null,d);});TP.definePrimitive('nodeGetDescendantElementsByIdOrName',function(a,c){var d,b;if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.isElement(d=TP.nodeGetElementById(a,c))){b=TP.ac();b.push(d);return b;}return TP.nodeGetDescendantElementsByName(a,c);});TP.definePrimitive('nodeGetDescendantElementsByName',function(a,b){if(TP.isHTMLDocument(a)){if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidName',arguments);}return a.getElementsByName(b);}return TP.nodeGetDescendantElementsByAttribute(a,'name',b);});TP.definePrimitive('nodeGetElementsByTagName',function(b,a,c){var d,e,f;if(!TP.isCollectionNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.isEmpty(a)){return TP.raise(this,'TP.sig.InvalidName',arguments,'Invalid or empty tag name');}if(!TP.isXMLDocument(TP.nodeGetDocument(b))){if(a==='*'||a==='*:*'){return TP.nodeGetDescendantElements(b,false);}if(TP.isString(a)&&!TP.regex.IS_NAMEXP.test(a)&&!TP.isFragment(b)){return TP.ac(b.getElementsByTagName(a));}f=TP.getQNameRegex(a);e=function(a){if(f.test(TP.qname(a))){return true;}};return TP.nodeSelectDescendantElements(b,e);}if(a==='*'||a==='*:*'){if(TP.notEmpty(c)){return TP.nodeEvaluateXPath(b,'descendant-or-self::*[namespace-uri() = "'+c+'"]',TP.NODESET);}return TP.nodeGetDescendantElements(b,false);}if(TP.isArray(a)||TP.regex.IS_NAMEXP.test(a)){f=TP.getQNameRegex(a);e=function(a){if(f.test(TP.qname(a))){if(TP.isString(c)){if(TP.nodeGetNSURI(a)!==c){return false;}}return true;}};return TP.nodeSelectDescendantElements(b,e);}TP.regex.ID_HAS_NS.lastIndex=0;if(TP.regex.ID_HAS_NS.test(a)){d='descendant-or-self::*[name() = "'+a+'"';}else{d='descendant-or-self::*[local-name() = "'+a+'"';}if(TP.notEmpty(c)){d+=' and namespace-uri() = "'+c+'"';}d+=']';return TP.nodeEvaluateXPath(b,d,TP.NODESET);});TP.definePrimitive('nodeGetFirstElementAncestorByAttribute',function(c,a,b){if(TP.isEmpty(a)){return TP.raise(this,'TP.sig.InvalidName',arguments);}return TP.nodeDetectAncestor(c,function(e){var f,d,g,c;try{if(TP.regex.IS_NAMEXP.test(a)){f=TP.getQNameRegex(a);d=e.attributes;g=d.length;for(c=0;c<g;c++){if(f.test(d[c].name)){if(TP.isValid(b)){if(!TP.match(b,d[c].value)){continue;}}return true;}}}else{if(TP.notValid(b)){if(TP.elementHasAttribute(e,a)){return true;}}else if(TP.match(b,TP.elementGetAttribute(e,a))){return true;}}}catch(a){}return false;});});TP.definePrimitive('nodeGetFirstElementAncestorByTagName',function(c,a,d){var b,e;if(TP.isEmpty(a)){return TP.raise(this,'TP.sig.InvalidName',arguments);}if(TP.isHTMLNode(c)){b=a.toLowerCase();}else{b=a;}e=TP.getQNameRegex(b);return TP.nodeDetectAncestor(c,function(a){if(TP.isString(d)){if(TP.nodeGetNSURI(a)!==d){return false;}}return e.test(TP.qname(a));});});TP.definePrimitive('nodeGetFirstElementChildByAttribute',function(c,a,b){if(!TP.isCollectionNode(c)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.isEmpty(a)){return TP.raise(this,'TP.sig.InvalidString',arguments);}return TP.nodeDetectChildElement(c,function(e){var f,d,g,c;try{if(TP.regex.IS_NAMEXP.test(a)){f=TP.getQNameRegex(a);d=e.attributes;g=d.length;for(c=0;c<g;c++){if(f.test(d[c].name)){if(TP.isValid(b)){if(!TP.match(b,d[c].value)){continue;}}return true;}}}else{if(TP.notValid(b)){if(TP.elementHasAttribute(e,a)){return true;}}else if(TP.match(b,TP.elementGetAttribute(e,a))){return true;}}}catch(a){}return false;});});TP.definePrimitive('nodeGetFirstElementChildByTagName',function(a,b,d){var c,e;if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidName',arguments);}if(TP.isHTMLNode(a)){c=b.toLowerCase();}else{c=b;}e=TP.getQNameRegex(c);return TP.nodeDetectChildElement(a,function(a){if(TP.isString(d)){if(TP.nodeGetNSURI(a)!==d){return false;}}return e.test(TP.qname(a));});});TP.definePrimitive('nodeGetFirstChildByType',function(a,b){if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.notValid(b)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}return TP.nodeDetectChildNode(a,function(a){return a.nodeType===b;});});TP.definePrimitive('nodeGetFirstChildContentNode',function(d){var b,e,a,c;if(!TP.isCollectionNode(d)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}b=d.childNodes;e=b.length;for(a=0;a<e;a++){c=b[a].nodeType;if(c===Node.TEXT_NODE||c===Node.CDATA_SECTION_NODE){return b[a];}}return null;});TP.definePrimitive('nodeGetFirstChildElement',function(b){var a;if(!TP.isCollectionNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.isValid(b.children)){return b.children[0];}a=b.firstChild;while(a){if(TP.isElement(a)){return a;}a=a.nextSibling;}return null;});TP.definePrimitive('nodeGetFirstDescendantByType',function(a,b){if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.notValid(b)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}return TP.nodeDetectDescendant(a,function(a){return a.nodeType===b;});});TP.definePrimitive('nodeGetFirstElementByAttribute',function(c,a,b){if(!TP.isCollectionNode(c)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.isEmpty(a)){return TP.raise(this,'TP.sig.InvalidName',arguments);}return TP.nodeDetectDescendantElement(c,function(e){var f,d,g,c;try{if(TP.regex.IS_NAMEXP.test(a)){f=TP.getQNameRegex(a);d=e.attributes;g=d.length;for(c=0;c<g;c++){if(f.test(d[c].name)){if(TP.isValid(b)){if(!TP.match(b,d[c].value)){continue;}}return true;}}}else{if(TP.notValid(b)){if(TP.elementHasAttribute(e,a)){return true;}}else if(TP.match(b,TP.elementGetAttribute(e,a))){return true;}}}catch(a){}return false;});});TP.definePrimitive('nodeGetFirstElementByTagName',function(a,b,d){var c,e;if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidName',arguments);}if(TP.isHTMLNode(a)){c=b.toLowerCase();}else{c=b;}e=TP.getQNameRegex(c);return TP.nodeDetectDescendantElement(a,function(a){if(TP.isString(d)){if(TP.nodeGetNSURI(a)!==d){return false;}}return e.test(TP.qname(a));});});TP.definePrimitive('nodeGetFirstSiblingElement',function(c,e){var d,b,a;if(!TP.isNode(c)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}d=TP.ifInvalid(e,TP.NEXT);b=d===TP.NEXT?'nextSibling':'previousSibling';a=c[b];while(TP.isValid(a)&&!TP.isElement(a)){a=a[b];}return a;});TP.definePrimitive('nodeGetNextNonChild',function(d,c){var a,b;if(!TP.isNode(d)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}a=d.nextSibling;while(a){if(TP.notValid(c)||a.nodeType===c){return a;}a=a.nextSibling;}b=d.parentNode;while(b&&TP.isElement(b)){a=b.nextSibling;while(a){if(TP.notValid(c)||a.nodeType===c){return a;}a=a.nextSibling;}b=b.parentNode;}return;});TP.definePrimitive('nodeGetSiblings',function(b,h){var c,a,e,f,g,d;if(!TP.isNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}c=TP.ac();switch(h){case TP.PREVIOUS:a=b.previousSibling;while(a){c.push(a);a=a.previousSibling;}break;case TP.NEXT:a=b.nextSibling;while(a){c.push(a);a=a.nextSibling;}break;default:e=b.parentNode;if(TP.isElement(e)){f=e.childNodes;g=f.length;for(d=0;d<g;d++){a=f[d];if(a===b){continue;}c.push(a);}}break;}return c;});TP.definePrimitive('nodeGetTopAncestor',function(b){var a;if(!TP.isNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}a=b.parentNode;if(TP.notValid(a)){return b;}while(TP.isElement(a)){if(TP.notValid(a.parentNode)){return a;}a=a.parentNode;}return;});TP.definePrimitive('nodeBreadthTraversal',function(g,o,h,q,u){var p,d,j,f,b,c,i,r,a,e,l,m,n,s,k,t;TP.debug('break.breadth_traversal');if(!TP.isCollectionNode(g)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}p=TP.ifInvalid(u,true);if(p){d=TP.ac();d.push(TP.ac(g));}else{d=TP.ac();d.push(g.childNodes);}n=0;s=TP.sys.cfg('content.traversal_max');t=TP.sys.cfg('content.replace_max');i=g;r=TP.nodeGetTopAncestor(i);while(j=d.shift()){a:for(f=0;f<j.length;f++){b=j[f];if(TP.isElement(b)){n+=1;if(n>s){TP.ifWarn()?TP.warn('Traversal terminated at'+' content.traversal_max elements.',TP.LOG,arguments):0;break;}if(o){k=0;while(k<t&&(TP.isNode(a=o(b))||TP.isArray(a))){if(TP.isArray(a)){c=a.at(0);a=a.at(1);}else{c=a;}if(!TP.isNode(c)||c===b){break;}if(b===i){i=c;}b=c;if(a===TP.BREAK||a===TP.CONTINUE||a===TP.DESCEND){break;}k+=1;}if(a!==TP.BREAK&&a!==TP.CONTINUE&&a!==TP.DESCEND&&TP.nodeIsDetached(b,r)){TP.debug('break.node_detachment');TP.ifWarn(TP.sys.cfg('log.node_detachment'))?TP.warn('Traversal node detached: '+TP.str(b,false),TP.LOG,arguments):0;return;}if(a===TP.BREAK){break;}else if(a===TP.CONTINUE){if(h){a=h(b);if(a===TP.BREAK){break;}}continue;}}if(q){l=b.childNodes;for(e=0;e<l.length;e++){m=l[e];if(!TP.isElement(m)){a=q(m);if(a===TP.BREAK){break a;}else if(a===TP.CONTINUE){break;}}}}if(h){a=h(b);if(a===TP.BREAK){break;}else if(a===TP.CONTINUE){continue;}}d.push(b.childNodes);}}}return;});TP.definePrimitive('nodeDepthTraversal',function(g,o,d,m,q){var k,c,h,b,a,f,e,l,j,n,i,p;TP.debug('break.depth_traversal');if(!TP.isCollectionNode(g)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}k=TP.ifInvalid(q,true);if(k&&TP.isElement(g)){c=g;}else if(TP.isDocument(g)){TP.nodeNormalize(g.documentElement);c=g.firstChild;}else{c=g.firstChild;}if(TP.notValid(c)){return;}e=g;l=TP.nodeGetTopAncestor(e);j=0;n=TP.sys.cfg('content.traversal_max');p=TP.sys.cfg('content.replace_max');do{if(TP.isElement(c)){j+=1;if(j>n){TP.ifWarn()?TP.warn('Traversal terminated at'+' content.traversal_max elements.',TP.LOG,arguments):0;break;}if(o){i=0;while(i<p&&(TP.isNode(a=o(c))||TP.isArray(a))){if(TP.isArray(a)){h=a.at(0);a=a.at(1);}else{h=a;}if(!TP.isNode(h)||h===c){break;}if(c===e){e=h;}c=h;if(a===TP.BREAK||a===TP.CONTINUE||a===TP.REPEAT||a===TP.DESCEND){break;}i+=1;}if(a!==TP.BREAK&&a!==TP.CONTINUE&&a!==TP.REPEAT&&a!==TP.DESCEND&&TP.nodeIsDetached(c,l)){TP.debug('break.node_detachment');TP.ifWarn(TP.sys.cfg('log.node_detachment'))?TP.warn('Traversal node detached: '+TP.str(c,false),TP.LOG,arguments):0;return;}if(a===TP.BREAK){return;}else if(a===TP.REPEAT){continue;}else if(a===TP.CONTINUE){if(d){a=d(c);if(a===TP.BREAK){return;}}if(c===e){return;}if(TP.notValid(f=c.nextSibling)){b=c.parentNode;while(TP.isElement(b)){if(d){a=d(b);if(a===TP.BREAK){return;}}if(b===e){return;}if(TP.isNode(f=b.nextSibling)){break;}b=b.parentNode;}if(TP.notValid(b)){return;}}c=f;continue;}else if(a===TP.DESCEND){}else if(TP.isValid(a)){TP.ifWarn()?TP.warn('Unrecognized traversal return value: '+a,TP.LOG,arguments):0;}}if(c.childNodes.length===0){if(d){a=d(c);if(a===TP.BREAK){return;}}if(c===e){return;}if(TP.notValid(f=c.nextSibling)){b=c.parentNode;while(TP.isElement(b)){if(d){a=d(b);if(a===TP.BREAK){return;}}if(b===e){return;}if(TP.isNode(f=b.nextSibling)){break;}b=b.parentNode;}if(TP.notValid(b)){return;}}c=f;continue;}else{c=c.firstChild;}}else{if(m){a=m(c);if(a===TP.BREAK){return;}else if(a===TP.CONTINUE){b=c.parentNode;if(TP.isElement(b)){while(TP.isElement(b)){if(d){a=d(b);if(a===TP.BREAK){return;}}if(b===e){return;}if(TP.isNode(f=b.nextSibling)){break;}b=b.parentNode;}if(TP.notValid(b)){return;}c=f;continue;}}else if(TP.isNode(a)){c=a;continue;}}if(TP.notValid(f=c.nextSibling)){b=c.parentNode;while(TP.isElement(b)){if(d){a=d(b);if(a===TP.BREAK){return;}}if(b===e){return;}if(TP.isNode(f=b.nextSibling)){break;}b=b.parentNode;}if(TP.notValid(b)){return;}}c=f;}}while(TP.isNode(c)&&c!==e);return;});TP.definePrimitive('nodeGetChildIndex',function(c,d){var b,e,a;if(!TP.isCollectionNode(c)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(!TP.isNode(d)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}b=c.childNodes;e=b.length;for(a=0;a<e;a++){if(b[a]===d){return a;}}return TP.NOT_FOUND;});TP.definePrimitive('nodeAncestorsPerform',function(c,b,g){var f,d,e,a;if(!TP.isNode(c)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(!TP.isCallable(b)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}f=TP.ifInvalid(g,false);if(f){return TP.nodeGetAncestors(c).perform(b,true);}d=true;d=TP.regex.PERFORM_INSTRUMENT.test(b.toString());e=0;a=c.parentNode;while(TP.isElement(a)&&a.nodeType!==Node.DOCUMENT_NODE){if(d){b.atStart(e===0?true:false);if(TP.isElement(a.parentNode)&&!TP.isDocument(a.parentNode)){b.atEnd(false);}else{b.atEnd(true);}}if(b(a,e++)===TP.BREAK){break;}a=a.parentNode;}return;});TP.definePrimitive('nodeChildElementsPerform',function(c,b,j){var h,e,d,a,g,i,f;if(!TP.isCollectionNode(c)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(!TP.isCallable(b)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}f=TP.ifInvalid(j,false);if(f){return TP.nodeGetChildElements(c).perform(b,true);}if(TP.isElement(c)){TP.nodeNormalize(c);}e=c.childNodes;d=e.length;h=true;if(d>TP.sys.cfg('perform.instrument_max')){h=TP.regex.PERFORM_INSTRUMENT.test(b.toString());}i=0;for(a=0;a<d;a++){g=f?d-a-1:a;if(h){b.atStart(a===0?true:false);b.atEnd(a===d-1?true:false);}if(!TP.isElement(e[g])){continue;}if(b(e[g],i++)===TP.BREAK){break;}}return;});TP.definePrimitive('nodeChildNodesPerform',function(d,b,i){var e,f,c,a,g,h;if(!TP.isCollectionNode(d)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(!TP.isCallable(b)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}h=TP.ifInvalid(i,false);if(TP.isElement(d)){TP.nodeNormalize(d);}f=d.childNodes;c=f.length;e=true;if(c>TP.sys.cfg('perform.instrument_max')){e=TP.regex.PERFORM_INSTRUMENT.test(b.toString());}for(a=0;a<c;a++){g=h?c-a-1:a;if(e){b.atStart(a===0?true:false);b.atEnd(a===c-1?true:false);}if(b(f[g],g)===TP.BREAK){break;}}return;});TP.definePrimitive('nodeDescendantsPerform',function(b,a,c){if(!TP.isCollectionNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(!TP.isCallable(a)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}if(TP.isTrue(c)){return TP.nodeBreadthTraversal(b,a,null,a,false);}else{return TP.nodeDepthTraversal(b,a,null,a,false);}});TP.definePrimitive('nodeDescendantElementsPerform',function(a,b,c){if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(!TP.isCallable(b)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}if(TP.isTrue(c)){return TP.nodeBreadthTraversal(a,b,null,null,false);}else{return TP.nodeDepthTraversal(a,b,null,null,false);}return;});TP.definePrimitive('nodeSiblingsPerform',function(f,b,k,m){var e,c,a,g,j,h,l,d,i;if(!TP.isNode(f)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(!TP.isCallable(b)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}i=TP.ifInvalid(m,false);e=true;e=TP.regex.PERFORM_INSTRUMENT.test(b.toString());c=0;if(i){switch(k){case TP.NEXT:g=TP.PREVIOUS;break;case TP.PREVIOUS:g=TP.NEXT;break;default:g=k;break;}}else{g=k;}switch(g){case TP.PREVIOUS:a=f.previousSibling;while(a){if(e){b.atStart(c===0?true:false);b.atEnd(!a.previousSibling);}if(b(a,c++)===TP.BREAK){break;}a=a.previousSibling;}break;case TP.NEXT:a=f.nextSibling;while(a){if(e){b.atStart(c===0?true:false);b.atEnd(!a.nextSibling);}if(b(a,c++)===TP.BREAK){break;}a=a.nextSibling;}break;default:j=f.parentNode.childNodes;h=j.length;for(d=0;d<h;d++){l=i?h-d-1:d;a=j[l];if(a===f){continue;}if(e){b.atStart(c===0?true:false);b.atEnd(d+1===h?true:false);}if(b(a,c++)===TP.BREAK){break;}}break;}return;});TP.definePrimitive('nodeDetectAncestor',function(a,b,e){var c,d;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(!TP.isCallable(b)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}d=TP.ifInvalid(e,false);if(d){return TP.nodeGetAncestors(a).detect(b);}TP.nodeAncestorsPerform(a,function(a,d){if(b(a,d)){c=a;return TP.BREAK;}});return c;});TP.definePrimitive('nodeDetectChildElement',function(a,b,e){var c,d;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(!TP.isCallable(b)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}d=TP.ifInvalid(e,false);if(d){return TP.nodeGetChildElements(a).detect(b);}TP.nodeChildElementsPerform(a,function(a,d){if(b(a,d)){c=a;return TP.BREAK;}});return c;});TP.definePrimitive('nodeDetectChildNode',function(a,b,d){var c;if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(!TP.isCallable(b)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}TP.nodeChildNodesPerform(a,function(a,d){if(b(a,d)){c=a;return TP.BREAK;}},null,d);return c;});TP.definePrimitive('nodeDetectDescendant',function(a,b,d){var c;if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(!TP.isCallable(b)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}TP.nodeDescendantsPerform(a,function(a,d){if(b(a,d)){c=a;return TP.BREAK;}},null,d);return c;});TP.definePrimitive('nodeDetectDescendantElement',function(a,b,d){var c;if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(!TP.isCallable(b)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}TP.nodeDescendantElementsPerform(a,function(a,d){if(b(a,d)){c=a;return TP.BREAK;}},null,d);return c;});TP.definePrimitive('nodeDetectSibling',function(a,b,d,e){var c;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(!TP.isCallable(b)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}TP.nodeSiblingsPerform(a,function(a,d){if(b(a,d)){c=a;return TP.BREAK;}},d,e);return c;});TP.definePrimitive('nodeSelectAncestors',function(a,b,e){var c,d;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(!TP.isCallable(b)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}d=TP.ifInvalid(e,false);if(d){return TP.nodeGetAncestors(a).select(b);}c=TP.ac();TP.nodeAncestorsPerform(a,function(a,d){if(b(a,d)){c.push(a);}});return c;});TP.definePrimitive('nodeSelectChain',function(c,d){var a,b;if(!TP.isNode(c)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isEmpty(d)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}b=TP.ac();a=c;while(TP.isValid(a=a[d])){b.push(a);}return b;});TP.definePrimitive('nodeSelectChildElements',function(a,b,e){var c,d;if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(!TP.isCallable(b)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}d=TP.ifInvalid(e,false);if(d){return TP.nodeGetChildElements(a).select(b);}c=TP.ac();TP.nodeChildElementsPerform(a,function(a,d){if(b(a,d)){c.push(a);}});return c;});TP.definePrimitive('nodeSelectChildNodes',function(b,c,d){var a;if(!TP.isCollectionNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(!TP.isCallable(c)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}a=TP.ac();TP.nodeChildNodesPerform(b,function(b,d){if(c(b,d)){a.push(b);}},null,d);return a;});TP.definePrimitive('nodeSelectDescendants',function(b,c,d){var a;if(!TP.isCollectionNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(!TP.isCallable(c)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}a=TP.ac();TP.nodeDescendantsPerform(b,function(b,d){if(c(b,d)){a.push(b);}},null,d);return a;});TP.definePrimitive('nodeSelectDescendantElements',function(b,c,d){var a;if(!TP.isCollectionNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(!TP.isCallable(c)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}a=TP.ac();TP.nodeDescendantElementsPerform(b,function(b,d){if(c(b,d)){a.push(b);}},null,d);return a;});TP.definePrimitive('nodeSelectSiblings',function(b,c,d,e){var a;if(!TP.isNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(!TP.isCallable(c)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}a=TP.ac();TP.nodeSiblingsPerform(b,function(b,d){if(c(b,d)){a.push(b);}},d,e);return a;});TP.definePrimitive('nodeGetNSPrefixes',function(a,e,f){var b,j,k,m,i,g,h,l,d,c;if(!TP.isDocument(a)&&!TP.isElement(a)){TP.raise(this,'TP.sig.InvalidParameter',arguments,'Node not an element or document.');return;}b=TP.ac();if(TP.isEmpty(e)){j=TP.nodeGetNSURIs(a,f);k=j.collect(function(b){return TP.nodeGetNSPrefixes(a,b,f);});return k.flatten().unique();}if(TP.isTrue(f)){m=TP.nodeAsString(a);i=TP.rc('xmlns:([^=]*)?="'+TP.regExpEscape(e)+'"','g');m.replace(i,function(c,a,d){if(TP.notEmpty(a)){b.push(a);}return c;});b.unique();}else{if(TP.isDocument(a)){g=a.documentElement;}else if(TP.isElement(a)){g=a;}else{return TP.raise(this,'TP.sig.InvalidElement',arguments);}h=g.attributes;l=h.length;for(d=0;d<l;d++){c=h[d];if(c.value===e){if(/xmlns\:/.test(c.name)){b.push(c.name.slice(6));}}}}return b;});TP.definePrimitive('nodeGetNSURI',function(a){var e,d,c,f,b;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.notEmpty(e=a.namespaceURI)){return e;}d=TP.isDocument(a)?a.documentElement:a;if(TP.isElement(d)){c=d.attributes;f=c.length;for(b=0;b<f;b++){if(c[b].name==='xmlns'){return c[b].value;}}}return'';});TP.definePrimitive('nodeGetNSURIs',function(e,h){var b,a,f,d,g,c;if(!TP.isNode(e)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}b=e;switch(b.nodeType){case Node.ATTRIBUTE_NODE:a=TP.ac(e.namespaceURI);break;case Node.DOCUMENT_NODE:b=b.documentElement;case Node.ELEMENT_NODE:a=TP.ac();if(TP.isTrue(h)){f=TP.nodeAsString(b);a=TP.ac();TP.regex.NS_EXTRACTION.lastIndex=0;f.replace(TP.regex.NS_EXTRACTION,function(c,d,b){if(TP.notEmpty(b)){a.push(b);}return c;});return a.unique();}d=b.attributes;g=d.length;for(c=0;c<g;c++){if(/xmlns[:]?/.test(d[c].name)){a.push(d[c].value);}}break;default:a=TP.ac();break;}return a;});TP.definePrimitive('nodeGetTextContent',function(a){if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Must provide a valid target Node.');}switch(a.nodeType){case Node.ELEMENT_NODE:case Node.DOCUMENT_FRAGMENT_NODE:return a.textContent;case Node.ATTRIBUTE_NODE:return a.value;case Node.TEXT_NODE:case Node.CDATA_SECTION_NODE:case Node.PROCESSING_INSTRUCTION_NODE:case Node.COMMENT_NODE:return a.data;case Node.DOCUMENT_NODE:return TP.nodeGetTextContent(a.documentElement);case Node.ENTITY_REFERENCE_NODE:case Node.ENTITY_NODE:case Node.DOCUMENT_TYPE_NODE:case Node.NOTATION_NODE:return'';default:break;}return;});TP.definePrimitive('nodeGetChildTextContent',function(b,c,d){var a;if(!TP.isCollectionNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}a=TP.nodeGetFirstElementChildByTagName(b,c,d);if(TP.isElement(a)){return TP.nodeGetTextContent(a);}return;});TP.definePrimitive('nodeGetStartPhase',function(b,e,f){var a,c,d;if(!TP.isCollectionNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}a=b;if(!TP.isElement(b)){a=TP.isDocument(b)?b.documentElement:b.parentNode;if(TP.isFragment(a)){return null;}}c=TP.ifInvalid(e,TP.core.TSH.NOCACHE_PHASES);while(TP.isElement(a)){if(TP.elementHasAttribute(a,'tibet:phase',true)){break;}if(a===f){break;}a=a.parentNode;}if(TP.isElement(a)){d=TP.elementGetAttribute(a,'tibet:phase',true);if(c.contains(d)){return d;}else{return c.first();}}return c.first();});TP.definePrimitive('nodeGetTargetPhase',function(b,e,f){var a,c,d;if(!TP.isCollectionNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}a=b;if(!TP.isElement(b)){a=TP.isDocument(b)?b.documentElement:b.parentNode;if(TP.isFragment(a)){return null;}}c=TP.ifInvalid(e,TP.core.TSH.NOCACHE_PHASES);while(TP.isElement(a)){if(TP.elementHasAttribute(a,'tibet:phase',true)){break;}if(a===f){break;}a=a.parentNode;}if(TP.isElement(a)){d=TP.elementGetAttribute(a,'tibet:phase',true);if(c.contains(d)||d==='Execute'){return d;}else{return c.last();}}return c.last();});TP.definePrimitive('nodeHasReachedPhase',function(b,d,f,g){var a,c,e;if(!TP.isCollectionNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}a=b;if(!TP.isElement(b)){a=TP.isDocument(b)?b.documentElement:b.parentNode;if(TP.isFragment(a)){return null;}}c=TP.elementGetAttribute(a,'tibet:phase',true);if(TP.isEmpty(c)){if(TP.elementHasAttribute(a,'tibet:sourcetag',true)){TP.elementSetAttribute(a,'tibet:phase','Compile',true);}}if(!TP.isElement(a)){a=TP.isDocument(a)?a.documentElement:a.parentNode;}if(TP.isEmpty(d)){return TP.elementHasAttribute(a,'tibet:sourcetag',true);}c=TP.elementGetAttribute(a,'tibet:phase',true);if(TP.isEmpty(c)){return;}e=TP.ifInvalid(f,TP.core.TSH.NOCACHE_PHASES);if(d==='Execute'){return c==='Execute';}else if(e.contains(d)){return e.indexOf(c)>=e.indexOf(d);}else{return this.raise('TP.sig.InvalidPhase',arguments,'Target phase not in phase list');}});TP.definePrimitive('nodeNormalizePhase',function(a){return a;});TP.definePrimitive('nodeCopyChildNodesTo',function(c,a,i,g){var e,f,d,h,b;if(!TP.isCollectionNode(c)||!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}e=TP.isDocument(a)&&TP.isElement(a.documentElement)?a.documentElement:a;f=TP.ifInvalid(i,null);d=null;h=c.childNodes.length;for(b=0;b<h;b++){if(TP.notValid(d)){d=TP.nodeInsertBefore(e,TP.nodeCloneNode(c.childNodes[b],true),f,g);}else{TP.nodeInsertBefore(e,TP.nodeCloneNode(c.childNodes[b],true),f,g);}}return d;});TP.definePrimitive('nodeMoveChildNodesTo',function(f,a,j,h){var c,g,b,i,d,e;if(!TP.isCollectionNode(f)||!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}c=TP.isDocument(a)&&TP.isElement(a.documentElement)?a.documentElement:a;g=TP.ifInvalid(j,null);b=null;i=f.childNodes.length;for(d=0;d<i;d++){e=TP.nodeDetach(f.childNodes[0]);if(TP.notValid(b)){b=TP.nodeInsertBefore(c,e,g,h);}else{TP.nodeInsertBefore(c,e,g,h);}}return b;});TP.definePrimitive('nodeSetContent',function(a,e,c,d){var b;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.notValid(e)){TP.nodeEmptyContent(a);}b=TP.canInvoke(e,'getResource')?e.getResource():e;b=TP.unwrap(b);switch(a.nodeType){case Node.ELEMENT_NODE:if(TP.isHTMLNode(a)){return TP.htmlElementSetContent(a,b,c,d);}else{return TP.xmlElementSetContent(a,b,c,d);}break;case Node.TEXT_NODE:case Node.CDATA_SECTION_NODE:case Node.PROCESSING_INSTRUCTION_NODE:case Node.COMMENT_NODE:a.data=TP.str(b);break;case Node.DOCUMENT_NODE:if(TP.isHTMLNode(a)){return TP.htmlDocumentSetContent(a,b,c,d);}else{return TP.xmlDocumentSetContent(a,b,c);}break;case Node.ATTRIBUTE_NODE:a.value=TP.str(b);break;case Node.DOCUMENT_FRAGMENT_NODE:if(TP.isHTMLNode(a)){return TP.htmlElementSetContent(a,b,c,d);}else{return TP.xmlElementSetContent(a,b,c,d);}break;case Node.ENTITY_REFERENCE_NODE:case Node.ENTITY_NODE:case Node.DOCUMENT_TYPE_NODE:case Node.NOTATION_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;default:break;}return a;});TP.definePrimitive('nodeSetTextContent',function(a,c){var b;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.canInvoke(c,'getResourceText')){b=c.getResourceText(TP.hc('async',false));}else{b=TP.str(c);}switch(a.nodeType){case Node.ELEMENT_NODE:case Node.DOCUMENT_FRAGMENT_NODE:a.textContent=b;break;case Node.TEXT_NODE:case Node.CDATA_SECTION_NODE:case Node.PROCESSING_INSTRUCTION_NODE:case Node.COMMENT_NODE:a.data=b;break;case Node.DOCUMENT_NODE:TP.nodeSetTextContent(a.documentElement,b);break;case Node.ATTRIBUTE_NODE:a.value=b;break;case Node.ENTITY_REFERENCE_NODE:case Node.ENTITY_NODE:case Node.DOCUMENT_TYPE_NODE:case Node.NOTATION_NODE:return a;default:break;}return a;});TP.definePrimitive('nodeSetChildTextContent',function(c,d,a,g){var e,b,f;e=TP.nodeGetFirstElementChildByTagName(c,a,g);if(TP.isElement(e)){return TP.nodeSetTextContent(d);}else{b=TP.nodeFromString(TP.join('<',a,'>',d,'</',a,'>'));if(TP.isNode(b)){f=TP.elem(c);TP.nodeAppendChild(f,b,false);}}return;});TP.definePrimitive('canonical',function(a){if(TP.notValid(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.isElement(a)){return TP.elementGetCanonicalName(a);}else if(TP.isAttributeNode(a)){return TP.attributeGetCanonicalName(a);}return TP.name(a);});TP.definePrimitive('doc',function(a,c,d){var b;if(TP.notValid(a)){return TP.createDocument();}if(TP.isXHR(a)){try{b=a.responseXML;if(b.childNodes.length===0){return TP.doc(a.responseText,c,d);}else{return TP.doc(b);}}catch(b){return TP.doc(a.responseText,c,d);}}if(TP.isNode(a)){b=TP.nodeGetDocument(a);if(TP.notValid(b)){b=TP.documentFromNode(a);}}else if(TP.isWindow(a)){b=a.document;}else if(TP.isString(a)){b=TP.documentFromString(a,c,d);}else if(TP.canInvoke(a,'getNativeDocument')){b=a.getNativeDocument();}else if(TP.canInvoke(a,'getResponseXML')){return a.getResponseXML();}return b;});TP.definePrimitive('elem',function(a,d,e){var b,f,c;if(TP.notValid(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.isXHR(a)){try{b=a.responseXML;if(b.childNodes.length===0){return TP.elem(a.responseText,d,e);}else{return TP.elem(b);}}catch(b){return TP.elem(a.responseText,d,e);}}if(TP.isElement(a)){b=a;}else if(TP.isDocument(a)){b=a.documentElement;}else if(TP.isFragment(a)){b=TP.nodeGetFirstChildElement(a);}else if(TP.isAttributeNode(a)){b=TP.attributeGetOwnerElement(a);}else if(TP.isNode(a)){b=a.parentNode;if(!TP.isElement(b)){b=null;}}else if(TP.isWindow(a)){f=a.document;if(TP.isDocument(f)){b=f.documentElement;}}else{c=TP.node(a,d,e);if(!TP.isNode(c)){return;}if(c!==a){return TP.elem(c);}}return b;});TP.definePrimitive('frag',function(a,d,e){var f,b,c;if(TP.notValid(a)){return TP.documentCreateFragment(TP.XML_FACTORY_DOCUMENT);}if(TP.isXHR(a)){try{f=a.responseXML;if(f.childNodes.length===0){return TP.frag(a.responseText,d,e);}else{return TP.frag(f);}}catch(b){return TP.frag(a.responseText,d,e);}}if(TP.isFragment(a)){c=a;}else if(TP.isNode(a)){if(TP.isDocument(b=a)){b=a.documentElement;}c=TP.documentCreateFragment(TP.nodeGetDocument(b));TP.nodeAppendChild(c,b,false);}else if(TP.isKindOf(a,'TP.core.Node')){c=TP.documentCreateFragment(a.getNativeDocument());TP.nodeAppendChild(c,a.getNativeNode(),false);}else if(TP.isString(a)){c=TP.fragmentFromString(a,d,e);}else if(TP.isWindow(a)){b=TP.nodeCloneNode(a.document.documentElement);c=TP.documentCreateFragment(TP.nodeGetDocument(b));TP.nodeAppendChild(c,b,false);}else if(TP.canInvoke(a,'getNativeNode')){c=TP.documentCreateFragment(a.getNativeDocument());if(TP.isDocument(b=a.getNativeNode())){b=TP.nodeCloneNode(b.documentElement);}TP.nodeAppendChild(c,b,false);}else if(TP.canInvoke(a,'getResponseXML')){return TP.frag(a.getResponseXML());}return c;});TP.definePrimitive('lname',function(a){if(TP.isElement(a)){return TP.elementGetLocalName(a);}else if(TP.isAttributeNode(a)){return TP.attributeGetLocalName(a);}return TP.name(a);});TP.definePrimitive('node',function(a,b,c){var d;if(TP.notValid(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.isXHR(a)){try{d=a.responseXML;if(d.childNodes.length===0){return TP.node(a.responseText,b,c);}else{return TP.node(d);}}catch(d){return TP.node(a.responseText,b,c);}}if(TP.isNode(a)){return a;}else if(TP.isKindOf(a,'TP.core.Node')){return a.getNativeNode();}else if(TP.isWindow(a)){return a.document;}else if(TP.isString(a)){return TP.nodeFromString(a,b,c);}else if(TP.canInvoke(a,'getNativeNode')){return a.getNativeNode();}else if(TP.canInvoke(a,'getResponseXML')){return a.getResponseXML();}return;});TP.definePrimitive('prefix',function(b){var c,a;if(TP.notValid(b)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}c=TP.qname(b);a=c.match(TP.regex.SCHEME);if(TP.isArray(a)){return a.at(1);}return;});TP.definePrimitive('qname',function(a){if(TP.notValid(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.isElement(a)){return TP.elementGetFullName(a);}else if(TP.isAttributeNode(a)){return TP.attributeGetFullName(a);}return TP.name(a);});TP.definePrimitive('tpdoc',function(a,c,d){var b;if(TP.notValid(a)){return TP.core.DocumentNode.construct(TP.createDocument());}if(TP.isKindOf(a,'TP.core.DocumentNode')){return a;}if(TP.isXHR(a)){try{b=a.responseXML;if(b.childNodes.length===0){b=TP.documentFromString(a.responseText,c,d);if(TP.isDocument(b)){return TP.core.DocumentNode.construct(b);}}else{return TP.core.DocumentNode.construct(b);}}catch(e){b=TP.documentFromString(a.responseText,c,d);if(TP.isDocument(b)){return TP.core.DocumentNode.construct(b);}}}if(TP.isDocument(a)){return TP.core.DocumentNode.construct(a);}else if(TP.isNode(a)){b=TP.nodeGetDocument(a);if(TP.isDocument(b)){return TP.core.DocumentNode.construct(a);}}else if(TP.isKindOf(a,'TP.core.Node')){return a.getDocument();}else if(TP.isWindow(a)){return TP.core.DocumentNode.construct(a.document);}else if(TP.isString(a)){b=TP.documentFromString(a,c,d);if(TP.isDocument(b)){return TP.core.DocumentNode.construct(b);}}else if(TP.canInvoke(a,'getDocument')){return a.getDocument();}else if(TP.canInvoke(a,'getResponseXML')){return TP.core.DocumentNode.construct(a.getResponseXML());}return;});TP.definePrimitive('tpelem',function(a,c,d){var b;if(TP.notValid(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.isKindOf(a,'TP.core.ElementNode')){return a;}b=TP.elem(a,c,d);if(TP.isElement(b)){return TP.core.ElementNode.construct(b);}return;});TP.definePrimitive('tpfrag',function(a,c,d){var b;if(TP.notValid(a)){return TP.core.DocumentFragmentNode.construct(TP.documentCreateFragment(TP.XML_FACTORY_DOCUMENT));}if(TP.isKindOf(a,'TP.core.DocumentFragmentNode')){return a;}b=TP.frag(a,c,d);if(TP.isFragment(b)){return TP.core.DocumentFragmentNode.construct(b);}return;});TP.definePrimitive('tpnode',function(a,c,d){var b,e;if(TP.notValid(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.isKindOf(a,'TP.core.Node')){return a;}if(TP.isXHR(a)){try{b=a.responseXML;if(b.childNodes.length===0){b=TP.nodeFromString(a.responseText,c,d);if(TP.isNode(b)){return TP.core.Node.construct(b);}}else{return TP.core.Node.construct(b);}}catch(e){b=TP.nodeFromString(a.responseText,c,d);if(TP.isNode(b)){return TP.core.Node.construct(b);}}}if(TP.isNode(a)){return TP.core.Node.construct(a);}else if(TP.isKindOf(a,'TP.core.Node')){return a;}else if(TP.isWindow(a)){return TP.core.DocumentNode.construct(a.document);}else if(TP.isString(a)){b=TP.nodeFromString(a,c,d);if(TP.isNode(b)){return TP.core.Node.construct(b);}}else if(TP.canInvoke(a,'getResourceNode')){e=TP.wrap(a.getResourceNode(TP.hc('async',false)));if(TP.isKindOf(e,'TP.core.Node')){return e;}}else if(TP.canInvoke(a,'getResponseXML')){return TP.core.Node.construct(a.getResponseXML());}return;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETEncapsulation.js';
Function.$$methodTestRegex=/this[\.;]|native code/;Function.$$methodNeedRegex=/this\.([$]*[\w]+)/g;TP.FunctionProto.defineMethod('$getNeeds',function(){var a,b,c;a=Function.$$methodNeedRegex;a.lastIndex=0;b=TP.ac();if(a.test(this.toString())){a.lastIndex=0;c=this.toString().match(a);c.perform(function(a,c){b.push(a.strip('this.'));});b=b.unique();}return b;});TP.FunctionProto.defineMethod('$hasThis',function(){if(!this.hasOwnProperty('$$this')){this.$$this=Function.$$methodTestRegex.test(this.toString());}return TP.isTrue(this.$$this);});TP.ArrayProto.changed=TP.RETURN_THIS;Array.Inst.defineMethod('unique',function(i,j){var h,g,f,d,b,c,e,a;if(this.length<2){return this;}h=TP.ifInvalid(i,TP.gid);g=TP.ifInvalid(j,false);f=TP.hc();d=this.getSize();b=0;for(c=0;c<d;c++){e=this[c];try{a=h(e);}catch(a){}if(g){if(TP.notDefined(a)){a=TP.UNDEF;}else if(TP.isNull(a)){a=TP.NULL;}}else if(TP.notValid(a)){a=TP.NULL;}if(TP.isValid(f.at(a))){continue;}f.atPut(a,true);this[b]=e;b++;}if(b<d){this.length=b;this.changed('length',TP.UPDATE,TP.hc(TP.OLDVAL,d,TP.NEWVAL,this.length));}return this;});TP.definePrimitive('stripPropertyPrefix',function(a){var b;if(!TP.isString(a)){return a;}b=a.charAt(0);if(b==='_'){return a.slice(1);}else if(b==='$'){if(a.charAt(1)==='$'){return a.slice(2);}else{return a.slice(1);}}return a;});TP.ArrayProto.$firstSort=true;TP.ArrayProto.$needsSort=true;TP.ArrayProto.sortFunction=null;Array.Inst.defineMethod('$sortIfNeeded',function(){if(this.$needsSort&&this.sortFunction){if(TP.isCallable(this.sortFunction)){this.sort(this.sortFunction);}else{this.sort();}this.$needsSort=false;if(TP.isFalse(this.$firstSort)){this.changed('order',TP.SORTED);this.$firstSort=false;}}return this;});Array.Inst.defineMethod('$get',function(b){var a;if(TP.isNumber(b)){a=b;if(a<0){a=Math.max(0,this.length+a);}if(a>=this.length){return;}this.$sortIfNeeded();return this[a];}else{return this[b];}});TP.defineMetaInstMethod('$set',function(c,g,h){var a,b,e,d,f;a=TP.ifInvalid(g,null);b=this[c];if(!TP.isProperty(this,c)&&!TP.regex.INTERNAL_SLOT.test(c)){TP.ifWarn()?TP.warn(TP.join(TP.sc('Setting undeclared attribute: '),TP.name(this),'.',c,' (',TP.tname(this),')',TP.tname(this)==='Window'?TP.sc(' -- Possible unbound function'):''),TP.LOG,arguments):0;}e=TP.UPDATE;if(TP.notDefined(b)){if(TP.notDefined(a)){return this;}e=TP.CREATE;}else if(TP.isNull(b)){if(TP.isNull(a)){return this;}}else if(TP.isValid(b)){if(typeof b===typeof a){if(b==a){return this;}}}this[c]=a;if(TP.notValid(d=h)){d=this.shouldSignalChange();}if(d){f=this.shouldSignalChange();this.shouldSignalChange(d);this.changed(TP.stripPropertyPrefix(c),e,TP.hc(TP.OLDVAL,b,TP.NEWVAL,a));this.shouldSignalChange(f);}return this;});Array.prototype.$$set=Array.prototype.$set;Array.Inst.defineMethod('$set',function(d,i,g){var a,b,e,c,f,h;a=TP.ifInvalid(i,null);if(TP.isNumber(d)){b=d;if(b<0){b=Math.max(0,this.length+b);}this.$sortIfNeeded();c=this[b];if(TP.isDefined(c)){if(typeof c===typeof a){if(c==a){return this;}}e=TP.UPDATE;}else{e=TP.CREATE;}this[b]=a;f=TP.ifInvalid(g,this.shouldSignalChange());if(f){h=this.shouldSignalChange();this.shouldSignalChange(f);this.changed(TP.stripPropertyPrefix(d),e,TP.hc(TP.OLDVAL,c,TP.NEWVAL,a));this.shouldSignalChange(h);}}else{return this.$$set(d,a,g);}return this;});TP.defineCommonMethod('normalizeIndex',function(a){var c,b;if(!TP.isNumber(a)){return a;}if(a>=0){return a;}c=this.getSize();if(c===0){return 0;}b=a;b=c+b;return this.normalizeIndex(b);});TP.defineMetaInstMethod('at',function(a){if(TP.canInvoke(this,'get')){return this.get(a);}return this[a];});TP.defineMetaInstMethod('atPut',function(a,c){var b;b=a>0?a:this.normalizeIndex(a);return this.$set(b,c,null,false);});Array.Inst.defineMethod('at',function(c,f){var d,e,a,b;if(!TP.isNumber(c)){return this.get(c);}d=this.normalizeIndex(c);if(TP.notValid(f)){return this[d];}e=arguments.length;switch(e){case 0:return TP.raise(this,'TP.sig.InvalidIndex',arguments);default:a=this[d];for(b=1;b<e;b++){if(TP.isValid(a)){a=a[this.normalizeIndex(arguments[b])];}else{break;}}return a;}return;});Array.Inst.defineMethod('atPut',function(g,d,h){var e,c,i,a,b,f;if(!TP.isNumber(g)){return this.set(g,d||h,null,false);}e=this.normalizeIndex(g);if(h===undefined){c=this[e];this[e]=d;if(c!=d){i=c===undefined?TP.CREATE:TP.UPDATE;this.changed(e,i,TP.hc(TP.OLDVAL,c,TP.NEWVAL,d));}return this;}a=arguments.length;switch(a){case 0:return TP.raise(this,'TP.sig.InvalidIndex',arguments);default:b=this;for(f=0;f<a-2;f++){if(TP.isValid(b)){b=b[this.normalizeIndex(arguments[f])];}else{return TP.raise(this,'TP.sig.InvalidIndex',arguments);}}if(TP.canInvoke(b,'atPut')){c=b.at(arguments[a-2]);b.atPut(arguments[a-2],arguments[a-1]);}else{try{c=arguments[a-2];b[arguments[a-2]]=arguments[a-1];}catch(a){return TP.raise(this,'TP.sig.ArrayException',arguments,TP.ec(a));}}}if(c!=h){this.changed('length',TP.UPDATE);}return this;});String.Inst.defineMethod('at',function(a){if(TP.isNumber(a)){return this.charAt(this.normalizeIndex(a));}else{return this.get(a);}});String.Inst.defineMethod('atPut',function(a,c){var b;b=a>0?a:this.normalizeIndex(a);return this.slice(0,b)+c+this.slice(b+c.length);});TP.sys.defineMethod('getCustomTypeNames',function(){return TP.keys(TP.sys.getMetadata('types'));});TP.sys.defineMethod('getMethodIds',function(){return TP.keys(TP.sys.getMetadata('methods'));});TP.sys.defineMethod('getMethodNames',function(){var b,c,d,e,a;b=TP.sys.getMetadata('methods');c=b.getKeys();d=TP.ac();e=c.getSize();for(a=0;a<e;a++){d.push(b.at(c.at(a)).methodObj[TP.NAME]);}return d;});TP.sys.defineMethod('getMethodOwners',function(c,f){var d,a,e,b;if(TP.notValid(c)){return;}d=c.getName();a=TP.sys.getMetadata('owners').at(d);if(TP.isEmpty(a)){return TP.ac();}if(TP.isTrue(f)){return a;}e=a.getSize();for(b=0;b<e;b++){a[b]=TP.sys.getTypeByName(a[b],false);}a.compact();return a;});TP.sys.defineMethod('getMetadata',function(a){switch(a){case'types':return TP.sys.$$meta_types;case'attributes':return TP.sys.$$meta_attributes;case'methods':return TP.sys.$$meta_methods;case'owners':return TP.sys.$$meta_owners;default:return TP.sys.$$metadata;}});TP.sys.defineMethod('$buildArgString',function(f,g,h){var c,d,e,b,a;c=TP.ifInvalid(f,0);d=TP.ifInvalid(g,0);e=TP.ifInvalid(h,'arguments');b=TP.ac();for(a=c;a<=d;a++){b.push(TP.join(e,'[',a,']'));}return b.join(', ');});Array.Type.defineMethod('construct',function(){var a,b;switch(arguments.length){case 0:return[];case 1:a=arguments[0];if(TP.isArgArray(a)||TP.isNodeList(a)){return TP.ArrayProto.slice.call(a,0);}b=[];b.push(a);return b;default:return TP.ArrayProto.slice.call(arguments,0);}});TP.defineMethodAlias(TP,'ac',Array.construct);Boolean.Type.defineMethod('construct',function(a){var c,b;b=Boolean.construct;if(a===true||a===false){return a;}if(TP.isString(a)&&TP.sys.hasKernel()){if(TP.notTrue(b.$$onStack)){b.$$onStack=true;c=Boolean.fromString(a);b.$$onStack=false;return c;}else{b.$$onStack=false;}}return new Boolean(a);});TP.defineMethodAlias(TP,'bc',Boolean.construct);Date.Type.defineMethod('construct',function(){var $$newinst,kallee;kallee=Date.construct;switch(arguments.length){case 0:$$newinst=new Date();break;case 1:$$newinst=new Date(arguments[0]);break;case 2:$$newinst=new Date(arguments[0],arguments[1]);break;case 3:$$newinst=new Date(arguments[0],arguments[1],arguments[2]);break;case 4:$$newinst=new Date(arguments[0],arguments[1],arguments[2],arguments[3]);break;case 5:$$newinst=new Date(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4]);break;case 6:$$newinst=new Date(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5]);break;case 7:$$newinst=new Date(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6]);break;default:eval('$$newinst = new Date('+TP.sys.$buildArgString(0,arguments.length)+');');break;}if(TP.notValid($$newinst)||$$newinst.toString()==='Invalid Date'||$$newinst.toString()==='NaN'){if(TP.notTrue(kallee.$$onStack)){kallee.$$onStack=true;$$newinst=Date.fromString(arguments[0]);kallee.$$onStack=false;return $$newinst;}else{kallee.$$onStack=false;}}return $$newinst;});TP.defineMethodAlias(TP,'dc',Date.construct);Function.Type.defineMethod('construct',function(){var $$newinst,msg;try{switch(arguments.length){case 0:$$newinst=new Function();break;case 1:$$newinst=new Function(arguments[0]);break;case 2:$$newinst=new Function(arguments[0],arguments[1]);break;case 3:$$newinst=new Function(arguments[0],arguments[1],arguments[2]);break;case 4:$$newinst=new Function(arguments[0],arguments[1],arguments[2],arguments[3]);break;case 5:$$newinst=new Function(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4]);break;case 6:$$newinst=new Function(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5]);break;case 7:$$newinst=new Function(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6]);break;case 8:$$newinst=new Function(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7]);break;case 9:$$newinst=new Function(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7],arguments[8]);break;default:eval('$$newinst = new Function('+TP.sys.$buildArgString(0,arguments.length)+');');break;}}catch(a){msg=TP.join('Error creating function: ',TP.args(arguments).join(' :: '));TP.ifError()?TP.error(TP.ec(a,msg),TP.LOG,arguments):0;return null;}return $$newinst;});TP.defineMethodAlias(TP,'fc',Function.construct);Number.Type.defineMethod('construct',function(c){var b,a;a=Number.construct;if(TP.isString(arguments[0])&&TP.sys.hasKernel()){if(TP.notTrue(a.$$onStack)){a.$$onStack=true;b=Number.fromString(arguments[0]);a.$$onStack=false;return b;}else{a.$$onStack=false;}}return new Number(arguments[0]);});TP.defineMethodAlias(TP,'nc',Number.construct);Object.Type.defineMethod('construct',function(){var a,b;b=new Object();for(a=0;a<arguments.length;a=a+2){if(!TP.isProperty(b,arguments[a])){b[arguments[a]]=TP.notDefined(arguments[a+1])?null:arguments[a+1];}else{}}return b;});RegExp.Type.defineMethod('construct',function(a,f){var b,c,d,e,g;if(TP.isRegExp(a)){return a;}b=TP.ifInvalid(a,'');c=TP.ifInvalid(f,'');g=null;try{d=new RegExp(b,c);}catch(a){e=TP.join('Error creating regex: ',b);TP.ifError()?TP.error(TP.ec(a,e),TP.LOG,arguments):0;return null;}return d;});TP.defineMethodAlias(TP,'rc',RegExp.construct);String.Type.defineMethod('construct',function(){var c,a,d,b;if(TP.sys.hasKernel()){c=TP.sys.getLocale();a=[];d=arguments.length;for(b=0;b<d;b++){a.push(c.localize(arguments[b]));}return a.join('');}a=TP.ac(arguments);return a.join('');});TP.defineMethodAlias(TP,'sc',String.construct);Array.Inst.defineMethod('$$isMemberOf',function(a){if(a===Array||a==='Array'){return true;}});Boolean.Inst.defineMethod('$$isMemberOf',function(a){if(a===Boolean||a==='Boolean'){return true;}});Date.Inst.defineMethod('$$isMemberOf',function(a){if(a===Date||a==='Date'){return true;}});Function.Inst.defineMethod('$$isMemberOf',function(a){if(a===Function||a==='Function'){return true;}});Number.Inst.defineMethod('$$isMemberOf',function(a){if(a===Number||a==='Number'){return true;}});TP.defineMetaInstMethod('$$isMemberOf',function(a){if(TP.isString(a)){return this.getTypeName()===TP.name(a);}return this.getType()===a;});RegExp.Inst.defineMethod('$$isMemberOf',function(a){if(a===RegExp||a==='RegExp'){return true;}});String.Inst.defineMethod('$$isMemberOf',function(a){if(a===String||a==='String'){return true;}});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETRegistration.js';
TP.sys.defineMethod('getObjectById',function(n,o,k){var f,p,g,c,a,h,l,b,m,i,d,e,j;TP.debug('break.gobi');if(TP.isEmpty(n)){return;}b=TP.str(n);if(TP.isType(a=TP.sys.getTypeByName(b))){return a;}if(TP.regex.TIBET_URN.test(b)){if(TP.isValid(a=TP.uc(b).getResource())){return a;}}if(TP.regex.TIBET_URN.test(TP.TIBET_URN_PREFIX+b)){if(TP.isValid(a=TP.uc(TP.TIBET_URN_PREFIX+b).getResource())){return a;}}j=TP.notValid(o)?false:o;if(TP.regex.VALID_TYPENAME.test(b)){if(TP.isValid(a=TP.sys.getTypeByName(b,!j))){return a;}}if(TP.regex.VALID_WINDOWNAME.test(b)){if(a=TP.sys.getWindowById(b)){return TP.tpwin(a);}}if(j){return;}if(b.indexOf('~')===0||TP.regex.HAS_SCHEME.test(b)||TP.regex.JS_SCHEME.test(b)){if(TP.isURI(l=TP.uc(b))){a=l.getResource(TP.hc('async',false,'resultType',TP.WRAP));if(TP.isNode(a)){if(TP.isType(e=TP.core.Node.getConcreteType(a))){return e.construct(a);}}else if(TP.isWindow(a)){return TP.core.Window.construct(a);}else{return a;}}else{TP.ifWarn()?TP.warn('Unable to construct URI for object reference: '+b,TP.LOG,arguments):0;return;}}if(TP.regex.ELEMENT_ID.test(b)){h=TP.regex.ELEMENT_ID.match(b);a=TP.sys.getWindowById(h.at(1));if(TP.isWindow(a)){if(h.at(2)==='document'){return TP.tpdoc(a.document);}else{a=TP.nodeGetElementById(a.document,h[2]);if(TP.isNode(a)){return TP.tpnode(a);}}}}if(TP.regex.HAS_PERIOD.test(b)){if(b.indexOf('#')===0){b=b.slice(1);}if(TP.isWindow(c=TP.core.Window.getWindowInfo(b,'tpWindow'))){return c;}if(TP.isWindow(c=TP.sys.getWindowById(b))){return TP.core.Window.construct(c);}g=b.lastIndexOf('#');if(g>-1){m=b.slice(0,g);if(TP.notValid(c=TP.sys.getWindowById(m))){f=b.split('.');d=0;a=TP.byOID(f.at(d));while(TP.isValid(a)&&d<f.getSize()){d++;i=f.at(d);if(TP.canInvoke(a,'get')){a=a.get(i);}else{a=a[i];}}if(TP.isValid(a)){return a;}}else{b=b.slice(g+1);}}}if(b.indexOf('#')===0){b=b.slice(1);}if(!TP.isWindow(c)){c=TP.unwrap(k);if(!TP.isWindow(c)){if(TP.isNode(k)){c=TP.nodeGetWindow(k);}else{c=TP.ifInvalid(TP.sys.getWindowById(TP.sys.getUICanvasName()),window);}}}if(b==='document'){return TP.core.Document.construct(c.document);}if(TP.isElement(a=TP.nodeGetElementById(c.document,b))){if(TP.isType(e=TP.core.Node.getConcreteType(a))){return e.construct(a);}}else{try{if(TP.isValid(a=c[p])){if(TP.isWindow(a)){return TP.core.Window.construct(a);}else if(TP.isDocument(a)){return TP.core.Document.construct(a);}return a;}}catch(a){TP.ifError()?TP.error(TP.ec(a,'Error accessing window slot at: '+b+'. '),TP.LOG,arguments):0;}}return;});TP.sys.defineMethod('hasRegistered',function(b,a){if(TP.isEmpty(a)){return false;}if(TP.regex.TIBET_URN.test(a)){if(TP.isValid(TP.uc(a).getResource())){return true;}}if(TP.regex.TIBET_URN.test(TP.TIBET_URN_PREFIX+a)){if(TP.isValid(TP.uc(TP.TIBET_URN_PREFIX+a).getResource())){return true;}}return false;});TP.sys.defineMethod('registerObject',function(a,d,e){var b,f,c;if(TP.notValid(a)){return false;}if(TP.isType(a)){return false;}if(TP.isKindOf(a,TP.core.URI)){return false;}if(TP.notTrue(e)){if(TP.canInvoke(a,'getType')&&TP.isType(c=a.getType())&&TP.canInvoke(c,'shouldRegisterInstances')){if(!c.shouldRegisterInstances()){return false;}}}if(!TP.canInvoke(a,'getID')){b=TP.ifInvalid(d,a);}else{b=TP.ifInvalid(d,a.getID());}if(TP.isURI(b)){return false;}if(TP.regex.TIBET_URN.test(b)){TP.ifError()?TP.error('Trying to register object whose ID is already a URN: '+b,TP.LOG,arguments):0;return false;}TP.uc(TP.TIBET_URN_PREFIX+b).setResource(a);if(TP.isValid(f)){b.signal('TP.sig.IdentityChange');}return true;});TP.definePrimitive('register',TP.sys.registerObject);TP.sys.defineMethod('unregisterObject',function(c,d){var a,b;if(TP.isString(d)){a=d;}else if(TP.isValid(c)){a=c.getID();}if(!TP.isURI(b=TP.uc(TP.uc(TP.TIBET_URN_PREFIX+a)))){return false;}b.clearCaches();TP.core.URI.removeInstance(b);return true;});TP.definePrimitive('unregister',TP.sys.unregisterObject);
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETFoundation.js';
TP.sys.defineMethod('$getContextGlobals',function(c,k){var d,b,f,e,h,i,j,g,a;d=TP.ac();b=k||TP.global;if(TP.isValid(c)){f=c.atIfInvalid('internal',false);e=c.atIfInvalid('hidden',false);h=c.atIfInvalid('public',true);i=c.atIfInvalid('types',false);j=c.atIfInvalid('functions',true);g=c.atIfInvalid('variables',true);}else{f=false;e=false;h=true;i=false;j=true;g=true;}for(a in b){try{if(TP.sys.$globalexcludes.contains(a)||TP.sys.$windowglobals.contains(a)){continue;}if(TP.$$isDNU(b[a])){continue;}if(TP.isWindow(b[a])){continue;}if(!f&&TP.regex.INTERNAL_SLOT.test(a)){continue;}if(!e&&TP.regex.PRIVATE_SLOT.test(a)){continue;}if(!h&&/^\$/.test(a)){continue;}if(!i&&(TP.isType(b[a])||TP.$$isTypeProxy(b[a]))){continue;}if(!j&&TP.isFunction(b[a])){continue;}if(!g&&(!TP.isFunction(b[a])&&!TP.isType(b[a])&&!TP.$$isTypeProxy(b[a]))){continue;}d.push(a);}catch(a){}}return d;});TP.sys.$missingTypes=TP.ifInvalid(TP.sys.$missingTypes,TP.hc());TP.sys.$missingTypes.$isHash=TP.ifInvalid(TP.sys.$missingTypes.$isHash,false);TP.sys.defineMethod('addCustomType',function(b,a){TP.sys.getMetadata('types').atPut(b,{'typeObj':a,'sname':a.getSupertypeName(),'lpath':TP.objectGetLoadPath(a),'spath':TP.objectGetSourcePath(a)});});TP.sys.defineMethod('getCustomTypes',function(){var c,b,d,e,a;c=TP.sys.getMetadata('types');b=c.getKeys();d=TP.hc();e=b.getSize();for(a=0;a<e;a++){d.atPut(b.at(a),c.at(b.at(a)).typeObj);}return d;});TP.sys.defineMethod('getMissingTypes',function(){if(TP.isFalse(this.$missingTypes.$isHash)&&TP.isType(TP.sys.getTypeByName('TP.lang.Hash'))){this.$missingTypes=this.$missingTypes.asTP_lang_Hash();this.$missingTypes.$isHash=true;}return this.$missingTypes;});TP.sys.defineMethod('getTypeByName',function(e,g,h){var f,b,a,c,d;if(!TP.isTypeName(e)){return;}f=TP.ifInvalid(g,true);if(!TP.isType(e)){a=e;if(a.charAt(a.length-1)===':'){a+='XMLNS';}if(TP.regex.HAS_COLON.test(a)){a=a.replace(/:/g,'.');}d=TP.sys.getMetadata('types');if(TP.regex.META_TYPENAME.test(a)){a=a.replace(/\.meta\./,'.');if(TP.isValid(c=d.at(a))){b=c.typeObj;}if(TP.isType(b)){return b.getType();}else{return;}}if(!TP.regex.TP_TYPENAME.test(a)&&!TP.regex.APP_TYPENAME.test(a)){if(TP.isValid(c=d.at('TP.'+a))){b=c.typeObj;}if(!b){if(TP.isValid(c=d.at('APP.'+a))){b=c.typeObj;}}}else{if(TP.isValid(c=d.at(a))){b=c.typeObj;}}if(TP.notValid(b)&&TP.isTrue(h)){b=TP.sys.getNativeTypes().at(a);}}else{b=e;}if(TP.$$isTypeProxy(b)&&b!==TP.lang.Proxy){if(!f){return;}b=b.$$fault();}return b;});TP.sys.defineMethod('getTypes',function(){var a;a=TP.hc();a.addAll(this.getNativeTypes());a.perform(function(b){if(TP.notValid(b.last())){a.removeKey(b.first());}});a.addAll(TP.sys.getCustomTypes());return a;});if(!TP.isFunction(TP.FunctionProto.bind)){TP.FunctionProto.$$bind=function(d){var a,b,c;a=this;b=TP.args(arguments,1);if(b.length>0){c=function(){var c;c=TP.args(arguments);c.unshift(b);return a.apply(d,c);};}else{c=function(){return a.apply(d,arguments);};}return c;};}else{TP.FunctionProto.$$bind=TP.FunctionProto.bind;}Function.Inst.defineMethod('bind',function(b){var a;if(arguments.length>1){a=this.$$bind(b,TP.args(arguments,1));}else{if(TP.notValid(this.$$bind)){a=this.bind(b);}else{a=this.$$bind(b);}}a[TP.NAME]=this[TP.NAME]||'BoundMethod';a[TP.OWNER]=this[TP.OWNER]||TP.NONE;a[TP.TRACK]=this[TP.TRACK]||TP.NONE;a[TP.DISPLAY]=TP.id(a[TP.OWNER])+'.'+a[TP.NAME];a.$realFunc=this;a.$realThis=b;if(TP.notValid(this[TP.OWNER])){this.$binding=a;}return a;});Function.Inst.defineMethod('atEnd',function(c){var a,b;a=TP.unbound(this);if(TP.isBoolean(c)){a.$end=c;return c;}b=a.$end;if(TP.notValid(b)){try{b=a.caller.$end;}catch(a){}}return b;});Function.Inst.defineMethod('atStart',function(c){var a,b;a=TP.unbound(this);if(TP.isBoolean(c)){a.$start=c;return c;}b=a.$start;if(TP.notValid(b)){try{b=a.caller.$start;}catch(a){}}return b;});TP.definePrimitive('unbound',function(b){var a;if(!TP.isFunction(b)){TP.raise(this,'TP.sig.InvalidParameter',arguments);return b;}a=b;while(a.$realFunc){a=a.$realFunc;}return a;});Function.Inst.defineMethod('afterUnwind',function(){var a,c,b,d;a=this;c=TP.args(arguments);b=function(){return a.apply(a,c);};if(window.MutationObserver){if(!TP.isElement(TP.$$unwindElem)){TP.defineAttribute(TP,'$$unwindElem',document.createElement('div'));TP.defineAttribute(TP,'$$unwindQueue',TP.ac());d=function(){var a;for(a=0;a<TP.$$unwindQueue.getSize();a++){TP.$$unwindQueue.at(a)();}TP.$$unwindQueue.empty();};new MutationObserver(d).observe(TP.$$unwindElem,{attributes:true});}TP.$$unwindQueue.push(b);TP.$$unwindElem.setAttribute('x','100');}else{if(arguments.length<1){return setTimeout(this,0);}return setTimeout(b,0);}});Function.Inst.defineMethod('fork',function(b){var a,c,d;if(arguments.length<2){return setTimeout(this,TP.ifInvalid(b,TP.sys.cfg('fork.delay')));}a=this;c=TP.args(arguments,1);d=function(){return a.apply(a,c);};return setTimeout(d,TP.ifInvalid(b,TP.sys.cfg('fork.delay')));});Function.Inst.defineMethod('getArity',function(){return this.length;});Function.Inst.defineMethod('generateMethodSourceHead',function(){var c,a,b,d;c=this[TP.OWNER];a=this[TP.TRACK];b=TP.ac();if(TP.isValid(c)&&TP.isValid(a)){d=c.getName();if(a===TP.GLOBAL_TRACK){b.push('TP.defineGlobalMethod(');}else if(a===TP.PRIMITIVE_TRACK){b.push('TP.definePrimitive(');}else if(a===TP.META_TYPE_TRACK){b.push('TP.defineMetaTypeMethod(');}else if(a===TP.META_INST_TRACK){b.push('TP.defineMetaInstMethod(');}else if(a===TP.TYPE_LOCAL_TRACK||a===TP.LOCAL_TRACK){b.push(d,'.defineMethod(');}else{b.push(d,'.',a,'.defineMethod(');}b.push('\'',this.getName()+'\',\n');}return b.join('');});Function.Inst.defineMethod('getMethodPatch',function(i){var c,d,e,f,a,b,g,h;if(TP.notValid(self.JsDiff)){TP.ifWarn()?TP.warn('Unable to generate method patch. JsDiff not loaded.',TP.LOG,arguments):0;return;}c=TP.objectGetSourcePath(this);if(TP.isEmpty(c)){TP.ifWarn()?TP.warn('Unable to generate method patch. Source path not found.',TP.LOG,arguments):0;return;}d=TP.uc(c);a=d.getContent();if(TP.isEmpty(a)){TP.ifWarn()?TP.warn('Unable to generate method patch. Source text not found.',TP.LOG,arguments):0;return;}e=this.toString().trim();f=TP.rc(RegExp.escapeMetachars(e.replace(/[\u0009\u000A\u0020\u000D]+/g,'SECRET_SAUCE')).replace(/SECRET_SAUCE/g,'\\s*'));b=a.match(f);if(TP.notValid(b)){TP.ifWarn()?TP.warn('Unable to generate method patch. Method index not found.',TP.LOG,arguments):0;return null;}g=a.slice(0,b.index)+i+a.slice(b.index+b.at(0).length);h=TP.extern.JsDiff.createPatch(c,a,g);return h;});Function.Inst.defineMethod('postMethodPatch',function(g,e,f){var b,c,d,a;b=this.getMethodPatch(g);if(TP.isEmpty(b)){return;}c=TP.uc(TP.sys.cfg('tds.patch_uri'));if(TP.notValid(c)){TP.error('Unable to create URL for patch server.');return;}d=this.$srcPath;if(TP.isEmpty(d)){TP.error('Unable to locate source path for function.');return;}a=TP.sig.HTTPRequest.construct(TP.hc('uri',c,'verb',TP.HTTP_POST,'async',false,'body',TP.hc('type','patch','target',d,'content',b),'mimetype',TP.JSON_ENCODED));a.defineMethod('handleRequestSucceeded',function(){if(e){e(a);}});a.defineMethod('handleRequestFailed',function(){if(f){f(a);}});return a.fire();});Function.Inst.defineMethod('getParameterNames',function(){var c,a,b,d;c=this.asString();a=c.match(/function[ ]*\((.*?)\)/).slice(1);if(TP.notEmpty(a)){b=a;}if(TP.isEmpty(b)){a=c.match(/function [$]*\w+[ ]*\((.*?)\)/).slice(1);b=a;}if(TP.notEmpty(b)&&TP.notEmpty(d=b.at(0))){return d.split(/,\s*/);}return TP.ac();});Function.Inst.defineMethod('getSignature',function(){var b,a;b=this.asString();a=b.slice(0,b.indexOf(')')+1);if(/function(\W*)\(/.test(a)){a=a.replace('function','function '+this.getName());}return a;});TP.defineMetaInstMethod('asType',function(){var a;if(TP.isType(this)){return this;}if(TP.isString(this)){if(TP.isType(a=TP.sys.getTypeByName(this))){return a;}return TP.sys.getTypeByName(this.replace('_',':'));}return this.getType();});TP.defineMetaInstMethod('getSubtypes',function(f){var a,d,b,c,e;if(!TP.isType(this)){return this.getType().getSubtypes();}if(TP.notTrue(f)){return this[TP.SUBTYPES]||TP.ac();}if(TP.owns(this,TP.SUBTYPES_DEEP)){if(TP.isArray(a=this[TP.SUBTYPES_DEEP])){return a;}}if(TP.isEmpty(a=this[TP.SUBTYPES])){return TP.ac();}d=TP.ac();a=a.copy();c=a.length;for(b=0;b<c;b++){e=a[b];a.addAll(e.getSubtypes(false)||d);c=a.length;}if(TP.sys.$$shouldCacheDeepSubtypes()){this[TP.SUBTYPES_DEEP]=a;}return a;});TP.defineMetaInstMethod('getSubtypeNames',function(d){var a,c,e,b;if(!TP.isType(this)){return this.getType().getSubtypeNames();}if(TP.notTrue(d)){return this[TP.SUBTYPE_NAMES]||TP.ac();}if(TP.owns(this,TP.SUBTYPES_NAMES_DEEP)){if(TP.isArray(a=this[TP.SUBTYPE_NAMES_DEEP])){return a;}}if(TP.isEmpty(a=this[TP.SUBTYPE_NAMES])){return TP.ac();}if(TP.isEmpty(a=this.getSubtypes(d))){return TP.ac();}c=TP.ac();e=a.getSize();for(b=0;b<e;b++){c.push(a.at(b).getName());}a=c;if(TP.sys.$$shouldCacheDeepSubtypes()){this[TP.SUBTYPE_NAMES_DEEP]=a;}return a;});TP.defineMetaInstMethod('getSupertype',function(){if(this===TP.ObjectProto||this===Object){return;}if(TP.isType(this)){return this[TP.SUPER];}return this.getType().getSupertype();});TP.defineMetaInstMethod('getSupertypeName',function(){if(this===TP.ObjectProto||this===Object){return;}if(TP.isType(this)){return this[TP.SUPER].getName();}return this.getType().getSupertypeName();});TP.defineMetaInstMethod('getSupertypes',function(){var a;if(TP.isType(this)){return this[TP.ANCESTORS]||TP.ac();}if(TP.canInvoke(this,'getType')){a=this.getType();if(a===this){return TP.ac();}if(TP.canInvoke(a,'getSupertypes')){return a.getSupertypes();}}return TP.ac();});TP.defineMetaInstMethod('getSupertypeNames',function(){var a;if(TP.isType(this)){return this[TP.ANCESTOR_NAMES]||TP.ac();}if(TP.canInvoke(this,'getType')){a=this.getType();if(a===this){return TP.ac();}if(TP.canInvoke(a,'getSupertypeNames')){return a.getSupertypeNames()||TP.ac();}}return TP.ac();});TP.defineMetaInstMethod('getSignalName',function(){if(TP.isType(this)){return this.getName();}return this.getTypeName();});Number.Inst.defineMethod('getSignalName',function(){return this.toString();});String.Inst.defineMethod('getSignalName',function(){return this.toString();});TP.definePrimitive('isMemberOf',function(a,b){var c,f,e,d;if(TP.notDefined(a)&&TP.notDefined(b)){return true;}if(TP.isNull(a)&&TP.isNull(b)){return true;}if(TP.notValid(a)||TP.notValid(b)||TP.notValid(a.constructor)){return false;}if(TP.isNonFunctionConstructor(a)){if(c=a.$$nonFunctionConstructorConstructorName){return c;}return b==='Object'||b===Object;}e=TP.isType(b)?TP.name(b):b;if(TP.isType(a)&&!TP.isNativeType(a)){return a.getType()===b||a.getTypeName()===e;}try{if(b!==Object&&(a.constructor===b||TP.isCallable(a.constructor.getName)&&a.constructor.getName()===b)){return true;}}catch(a){}if(TP.canInvoke(a,'$$isMemberOf')&&TP.isNativeType(b)){if(TP.isBoolean(c=a.$$isMemberOf(b))){return c;}}if(TP.notEmpty(f=TP.tname(a))){return f===e;}if(/native code/.test(a.constructor.toString())){if(TP.isString(d=b)){d=TP.global[b];}if(/native code/.test(d.toString())){return a.constructor.toString()===d.toString();}}return false;});TP.definePrimitive('isKindOf',function(b,a){var c,d;if(TP.isMemberOf(b,a)){return true;}if(TP.isNativeType(b)){if(TP.isNonFunctionConstructor(b)){return TP.name(a)==='Object';}return TP.name(a)==='Object'||TP.name(a)==='Function';}c=TP.isType(a)?TP.name(a):a;if(TP.notEmpty(d=TP.stnames(b))){return d.containsString(c);}return false;});TP.definePrimitive('isSubtypeOf',function(b,a){var c;if(!TP.isType(b)||TP.notValid(a)){return false;}if(TP.canInvoke(b,'getSupertypeNames')){c=TP.isType(a)?a.getName():a;return b.getSupertypeNames().containsString(c);}return false;});TP.definePrimitive('isURI',function(a){if(TP.notValid(a)){return false;}if(TP.isString(a)){return TP.regex.URI_LIKELY.test(a)&&!TP.regex.REGEX_LITERAL_STRING.test(a);}return TP.isKindOf(a,'TP.core.URI');});TP.sys.defineMethod('trapRecursion',function(f,g,b){var c,d,e,a;if(!TP.sys.shouldTrapRecursion()){return;}c=TP.ifInvalid(f,true);d=TP.ifInvalid(g,false);e=TP.isNumber(b)?b:TP.sys.cfg('stack.recursion_max');try{throw new Error();}catch(b){a=TP.getStackInfo(b);}if(TP.isArray(a)&&a.length>e){if(c){TP.boot.$sterr('RecursionException',a,TP.ERROR);}if(TP.notFalse(d)){throw new Error('RecursionError');}}return;});TP.sys.defineMethod('onerror',function(c,f,g,h,d){var b,e,a;try{b=TP.boot.$$onerrorFile;e=TP.notValid(b)?f:b;a=c||'Error';a+=' in file: '+e+' line: '+g+' column: '+h;if(TP.sys.shouldLogStack()&&TP.isError(d)){a+='\nSTACK:\n'+TP.getStackInfo(d).join('\n');}if(!TP.sys.hasStarted()){TP.fatal(a,TP.BOOT_LOG,arguments);}else{TP.ifSevere()?TP.severe(a,TP.LOG,arguments):0;}}catch(b){top.console.error('Error logging onerror: '+b.message);top.console.error(a||c);}if(TP.sys.shouldUseDebugger()){TP.sys.$launchDebugger(arguments);}$STATUS=TP.FAILURE;return TP.sys.shouldCaptureErrors();});if(TP.notValid(TP.sys.offerror)){TP.sys.offerror=window.onerror;}window.onerror=TP.sys.onerror;TP.sys.$signalQueue=TP.ifInvalid(TP.sys.$signalQueue,TP.ac());TP.definePrimitive('queue',function(a,b,c,d,e,f){TP.sys.$signalQueue.add(TP.ac(TP.ifInvalid(a,null),TP.ifInvalid(b,null),TP.ifInvalid(c,null),TP.ifInvalid(d,null),TP.ifInvalid(e,null),TP.ifInvalid(f,null)));return;});TP.defineMetaInstMethod('queue',function(a,b,c,d,e){return TP.queue(this,a,b,c,d,e);});TP.definePrimitive('signal',function(a,b,c,d,e,f){var g;if(TP.isValid(a)&&a.$suspended){return;}if(TP.signal.$suspended){return;}if(TP.sys.shouldQueueLoadSignals()){g=TP.ac(a,b,c,d,e,f);TP.sys.$signalQueue.add(g);}TP.ifTrace(TP.sys.shouldLogLoadSignals())?TP.trace('origin: '+a+'\nsignal: '+b+'\ncontext: '+c+'\nsigarg: '+d+'\npolicy: '+e+'\ntype: '+f,TP.SIGNAL_LOG,arguments):0;return b;});TP.defineMetaInstMethod('signal',function(a,b,c,d,e){return TP.signal(this,a,b,c,d,e);});TP.definePrimitive('ignore',function(b,c,d,e){var a;a=TP.sys.getTypeByName('TP.sig.SignalMap');if(TP.isType(a)){return TP.sig.SignalMap.$ignore(b,c,d,e);}return;});TP.defineMetaInstMethod('ignore',function(b,c,d,e){var a;a=TP.ifInvalid(d,this);return TP.ignore(b,c,a,e);});TP.definePrimitive('observe',function(b,c,d,e){var a;a=TP.sys.getTypeByName('TP.sig.SignalMap');if(TP.isType(a)){return TP.sig.SignalMap.$observe(b,c,d,e);}return;});TP.defineMetaInstMethod('observe',function(b,c,d,e){var a;a=TP.ifInvalid(d,this);return TP.observe(b,c,a,e);});TP.definePrimitive('resume',function(b,c){var a;a=TP.sys.getTypeByName('TP.sig.SignalMap');if(TP.isType(a)){return TP.sig.SignalMap.$resume(b,c);}return;});TP.defineMetaInstMethod('resume',function(a){if(TP.notValid(a)){this.$suspended=false;}return TP.resume(this,a);});TP.definePrimitive('suspend',function(b,c){var a;a=TP.sys.getTypeByName('TP.sig.SignalMap');if(TP.isType(a)){return TP.sig.SignalMap.$suspend(b,c);}return;});TP.defineMetaInstMethod('suspend',function(a){if(TP.notValid(a)){this.$suspended=true;}return TP.suspend(this,a);});TP.defineMetaInstMethod('defineHandler',function(d,i,k){var b,c,h,f,g,j,a,e;b=TP.regex.ON_HANDLER_NAME.exec(d);if(TP.notValid(b)){return this.raise('InvalidHandlerName',d);}h=k;f=b[1];g=TP.ifEmpty(b[3],TP.ANY);j=TP.ifEmpty(b[5],TP.ANY);if(j!==TP.ANY){c=function(){if(false){return;}i.apply(this,arguments);}.bind(this);}else{c=i;}if(TP.owns(this,'$$handlers')){a=this.get('$$handlers');}if(TP.notValid(a)){a=TP.hc();this.$set('$$handlers',a,false);}else{e=a.at(d);if(TP.isValid(e)){TP.ignore(g,f,e);}}a.atPut(d,c);TP.observe(g,f,c,h);});TP.defineMetaInstMethod('getHandlers',function(){return this.get('$$handlers');});TP.sys.defineMethod('fireNextSignal',function(){var a;a=TP.sys.$signalQueue.shift();if(TP.notValid(a)){return;}return TP.signal(a.at(0),a.at(1),a.at(2),a.at(3),a.at(4),a.at(5));});Array.Inst.defineMethod('isOriginSet',function(a){if(TP.isDefined(a)){this.$isOriginSet=a;}return this.$isOriginSet;});TP.defineMetaInstMethod('$getInstPropertyScope',function(b){var a,c;a=this.getPrototype();if(this===a){a=TP.ObjectProto;}if(TP.notDefined(a[b])||TP.$$isDNU(a[b])){return TP.LOCAL;}if(TP.owns(this,b)){return TP.LOCAL;}c=a.$getPrototypePropertyScope(b);return c;});TP.defineMetaInstMethod('$getPrototypePropertyScope',function(a){var b,c;if(this===TP.ObjectProto){return TP.INTRODUCED;}if(this===TP.FunctionProto){if(TP.owns(this,a)){if(TP.owns(TP.ObjectProto,a)){return TP.OVERRIDDEN;}else{if(TP.isMethod(c=this[a])){if(c[TP.TRACK]===TP.TYPE_TRACK){return TP.INHERITED;}}return TP.INTRODUCED;}}return TP.INHERITED;}b=this.getPrototype();if(this===b){b=TP.ObjectProto;}if(TP.notDefined(b[a])||TP.$$isDNU(b[a])){return TP.INTRODUCED;}if(TP.owns(this,a)){return TP.OVERRIDDEN;}return TP.INHERITED;});TP.defineMetaTypeMethod('$getTypePropertyScope',function(a){var b;b=TP.FunctionProto;if(TP.owns(this,a)){if(this[a]===b[a]){return TP.INHERITED;}if(TP.isDefined(b[a])){return TP.OVERRIDDEN;}return TP.LOCAL;}return TP.INHERITED;});TP.lang.RootObject.Type.defineMethod('$getTypePropertyScope',function(a){var b,c;b=this.getPrototype();if(TP.notDefined(b[a])||TP.$$isDNU(b[a])){return TP.LOCAL;}if(TP.owns(this,a)){return TP.LOCAL;}c=this.getSupertype();if(b[a]===c[a]){return TP.INHERITED;}else{if(TP.isDefined(c[a])){return TP.OVERRIDDEN;}else{return TP.INTRODUCED;}}});TP.defineMetaInstMethod('getPropertyScope',function(a,c){var b;b=TP.sys.shouldLogStack();TP.sys.shouldLogStack(false);try{if(TP.notTrue(c)){if(TP.notDefined(this[a])){return TP.NONE;}if(TP.$$isDNU(this[a])){return TP.DNU;}}if(TP.isType(this)){return this.$getTypePropertyScope(a);}else if(TP.isPrototype(this)){return this.$getPrototypePropertyScope(a);}else{return this.$getInstPropertyScope(a);}}catch(a){}finally{TP.sys.shouldLogStack(b);}});TP.defineMetaInstMethod('$getInterface',function(n){var b,d,j,g,k,f,l,h,i,a,c,e,m;TP.debug('break.interface');b=TP.ifInvalid(n,'unique_attributes');if(TP.isString(b)){b=b.toLowerCase();if(TP.notValid(d=TP.SLOT_FILTERS[b])){TP.ifWarn()?TP.warn('Invalid reflection filter: '+b,TP.LOG,arguments):0;return TP.ac();}}else{d=b;}j=TP.ifInvalid(d.attributes,true);g=TP.ifInvalid(d.methods,false);k=TP.ifInvalid(d.hidden,false);f=TP.ifInvalid(d.scope,TP.UNIQUE);l=TP.ifInvalid(d.public,false);if(!j&&!g){TP.ifWarn()?TP.warn('Invalid reflection filter: '+b,TP.LOG,arguments):0;return TP.ac();}h=f===TP.UNIQUE;if(!h){TP.ifWarn(TP.sys.cfg('log.scans'))?TP.warn('Scanning '+b+' on '+this,TP.LOG,arguments):0;}if(TP.isType(this)||TP.isPrototype(this)){m=this.getPrototype();}else{m=this.getInstPrototype();}i=TP.ac();for(a in this){if(TP.regex.PRIVATE_SLOT.test(a)){if(!k){continue;}}else{if(k&&!l){continue;}}if(TP.regex.INTERNAL_SLOT.test(a)){continue;}try{if(h&&!this.hasOwnProperty(a)){continue;}c=this[a];}catch(a){if(TP.isNativeType(this)){break;}continue;}if(TP.notDefined(c)){continue;}if(TP.$$isDNU(c)){continue;}try{if(window[a]===c&&TP.ObjectProto[a]!==c){continue;}}catch(a){continue;}if(!g&&TP.isMethod(c)){continue;}if(!j&&!TP.isMethod(c)){continue;}if(f!==TP.ALL){e=this.getPropertyScope(a,true);if(f===TP.UNIQUE){if(e!==TP.INTRODUCED&&e!==TP.LOCAL&&e!==TP.OVERRIDDEN){continue;}}else if(f!==e){continue;}}i.push(a);}return i;});TP.defineMetaInstMethod('getInterface',function(a){var d,f,e,b,c,g;if(TP.isType(this)){d=this.getTypeInterface(a);}else if(TP.isPrototype(this)){return this.getLocalInterface(a);}else{d=this.getInstInterface(a);}f=this.getLocalInterface(a);e=d.addAll(f).unique();if(TP.isNativeType(this)||this===TP.lang.RootObject){if(TP.isString(a)){b=TP.SLOT_FILTERS[a];}else{b=a;}if(TP.isValid(b)&&b.scope===TP.INHERITED){c={};c.hidden=b.hidden;c.methods=b.methods;c.public=b.public;c.scope=TP.OVERRIDDEN;g=this.getLocalInterface(c);e.removeAll(g);}}return e;});TP.defineMetaInstMethod('getInstInterface',function(a){var b;if(TP.isType(this)){return this.getInstPrototype().$getInterface(a);}else if(TP.isPrototype(this)){if(/\$\$Type/.test(TP.name(this))){return TP.ac();}else{return this.$getInterface(a);}}b=this.getType();if(this!==b){return b.getInstInterface(a);}return TP.ac();});TP.defineMetaInstMethod('getLocalInterface',function(a){return this.$getInterface(a);});TP.defineMetaInstMethod('getTypeInterface',function(a){var b;if(TP.isType(this)){return this.getPrototype().$getInterface(a);}else if(TP.isPrototype(this)){if(/\$\$Type/.test(TP.name(this))){return this.$getInterface(a);}else{return TP.ac();}}b=this.getType();if(this!==b){return b.getTypeInterface(a);}return TP.ac();});TP.defineMetaInstMethod('getKeys',function(a){if(TP.isMutable(this)){if(TP.isEmpty(a)){return TP.$getOwnKeys(this);}else{return this.getInterface(a);}}return TP.ac();});Array.Inst.defineMethod('getKeys',function(e,d){var c,b,a;c=TP.ifInvalid(d,false);b=TP.ac();for(a=0;a<this.length;a++){if(!c&&TP.notDefined(this[a])){continue;}b.push(a);}return b.concat(TP.sys.$arraykeys);});String.Inst.defineMethod('getKeys',function(){var a,b;b=TP.ac();for(a=0;a<this.length;a++){b.push(a);}return b.concat(TP.sys.$stringkeys);});TP.defineMetaInstMethod('getSize',function(c){var a,b;a=this.getKeys(c);b=a.getSize();return b;});String.Inst.defineMethod('getSize',function(){return this.length;});TP.defineMetaInstMethod('getValues',function(d){var b,a,c;b=TP.ac();c=this.getKeys(d);for(a=0;a<c.getSize();a++){b.push(this.at(c.at(a)));}return b;});Array.Inst.defineMethod('getValues',function(){return this;});String.Inst.defineMethod('getValues',function(){return this.split('');});TP.defineMetaInstMethod('hasKey',function(a){return this.hasOwnProperty(a);});Array.Inst.defineMethod('hasKey',function(a,c){var b;if(!TP.isNumber(a)){this.raise('TP.sig.InvalidKey',arguments);return false;}if(this.length<a){return false;}b=TP.ifInvalid(c,false);if(b){return true;}return TP.isDefined(this[a]);});TP.defineMetaInstMethod('inherits',function(a){return this.getPropertyScope(a)===TP.INHERITED;});TP.defineMetaInstMethod('inheritsFromIntroducer',function(a){var b,c,d;c=this.getPropertyScope(a);if(c!==TP.INHERITED){return false;}d=this.getPrototypes();b=d.detect(function(b){return b.getPropertyScope(a)===TP.OVERRIDDEN;});return TP.notValid(b);});TP.defineMetaInstMethod('introduces',function(a){return this.getPropertyScope(a)===TP.INTRODUCED;});TP.defineMetaInstMethod('overrides',function(a){return this.getPropertyScope(a)===TP.OVERRIDDEN;});TP.defineMetaInstMethod('$$isPair',function(){return false;});Array.Inst.defineMethod('$$isPair',function(){return this.getSize()===2&&TP.isValid(this.at(0));});TP.defineCommonMethod('first',function(a){if(TP.isNumber(a)&&a>1){return this.getItems().first(a);}return this.detect(TP.RETURN_TRUE);});Array.Inst.defineMethod('first',function(a){this.$sortIfNeeded();if(TP.isNumber(a)&&a>1){return this.slice(0,a);}return this.length>0?this.at(0):null;});String.Inst.defineMethod('first',function(a){if(TP.isNumber(a)&&a>1){return this.slice(0,a);}return this.length>0?this.charAt(0):null;});TP.defineCommonMethod('last',function(a){if(TP.isNumber(a)&&a>1){return this.getItems().last(a);}return this.detect(TP.RETURN_TRUE,null,true);});Array.Inst.defineMethod('last',function(a){this.$sortIfNeeded();if(TP.isNumber(a)&&a>1){return this.slice(this.length-a);}return this.length>0?this.at(this.length-1):null;});String.Inst.defineMethod('last',function(a){if(TP.isNumber(a)&&a>1){return this.slice(this.length-a);}return this.length>0?this.at(this.length-1):null;});TP.defineMetaInstMethod('getPairs',function(a){if(!TP.canInvoke(this,['at','getKeys'])){return this.raise('TP.sig.InvalidPairRequest',arguments);}return this.select(a||TP.RETURN_TRUE);});Array.Inst.defineMethod('getPairs',function(f){var b,c,d,a,e;b=TP.ac();if(TP.isCallable(f)){c=f;}d=this.getSize();if(d>0&&TP.isPair(this.first())){for(a=0;a<d;a++){if(TP.isValid(this.at(a))&&TP.isPair(this.at(a))){if(c&&!c(this.at(a))){continue;}b.push(this.at(a));}}return b;}for(a=0;a+1<d;a+=2){e=TP.ac(this.at(a),this.at(a+1));if(c&&!c(e)){continue;}b.push(e);}if(d.isOdd()){b.push(TP.ac(this.last(),null));}return b;});String.Inst.defineMethod('getPairs',function(a){return this.raise('TP.sig.InvalidPairRequest',arguments);});TP.defineMetaInstMethod('getKVPairs',function(a){if(!TP.canInvoke(this,['at','getKeys'])){return this.raise('TP.sig.InvalidPairRequest',arguments);}return this.select(a||TP.RETURN_TRUE);});Array.Inst.defineMethod('getKVPairs',function(e){var b,c,f,a,d;b=TP.ac();if(TP.isCallable(e)){c=e;}f=this.getSize();for(a=0;a<f;a++){d=TP.ac(a,this.at(a));if(c&&!c(d)){continue;}b.push(d);}return b;});TP.StringProto.getKVPairs=TP.StringProto.getPairs;TP.defineMetaInstMethod('asDumpString',function(){var c,b,e,a,d;if(TP.isWindow(this)){return TP.tname(this)+' :: '+TP.windowAsString(this);}if(this.$$format_asDumpString){return TP.recursion(this);}try{this.$$format_asDumpString=true;}catch(a){}c=new Array();try{b=TP.$getOwnKeys(this);e=b.length;for(a=0;a<e;a++){c.push(b[a]+': '+TP.dump(this[b[a]]));}d='{'+c.join(', ')+'}';}catch(a){d=this.toString();}try{delete this.$$format_asDumpString;}catch(a){}return d;});TP.defineMetaInstMethod('asInspectString',function(){var a,d,b,c;if(!TP.isMutable(this)){return this.getTypeName()+'::'+TP.str(this);}c=TP.ac();a=TP.keys(this);if(TP.isEmpty(a)){return this.getTypeName()+'::'+TP.str(this);}if(TP.isNumber(a[0])){a.sort(TP.NUMERIC_SORT);}else{a.sort();}d=a.getSize();for(b=0;b<d;b++){if(!TP.isCollection(this)&&TP.isMethod(this.at(a.at(b)))){continue;}c.push(TP.str(a.at(b))+' => '+TP.val(this,a.at(b)));}if(TP.isNode(this)&&!TP.isDocument(this)){c.push('tag',' =>',TP.nodeAsString(this,false,true));}return this.getTypeName()+'::'+'\n'+c.join('\n');});TP.defineMetaInstMethod('asPrettyString',function(){var c,b,e,a,d;if(TP.isWindow(this)){return TP.tname(this)+' :: '+TP.windowAsString(this);}if(this.$$format_asPrettyString){return TP.recursion(this);}try{this.$$format_asPrettyString=true;}catch(a){}c=new Array();try{b=TP.$getOwnKeys(this);e=b.length;for(a=0;a<e;a++){c.push(TP.join('<dt class="pretty key">',b[a],'</dt>','<dd class="pretty value">',TP.pretty(this[b[a]]),'</dd>'));}d='<dl class="pretty">'+c.join(', ')+'</dl>';}catch(a){d=this.toString();}try{delete this.$$format_asPrettyString;}catch(a){}return d;});TP.defineMetaInstMethod('asRecursionString',function(){return'Recursion of: '+this.getTypeName()+' :: '+this.getID();});var oldInspectString=TP.FunctionProto.asInspectString;TP.FunctionProto.defineMethod('asInspectString',function(){if(TP.isType(this)){this.asInspectString=oldInspectString;return this.asInspectString();}return this.getTypeName()+'::'+'\n'+this.asString();});var func;TP.defineMetaInstMethod('$changed',func=function(e,f,d){var a,c,b;if(!TP.sys.hasInitialized()){return;}if(!this.shouldSignalChange()){return;}TP.debug('break.change');a='Change';c=TP.ifKeyInvalid(d,'aspect',e)||'value';if(c==='value'){a='TP.sig.ValueChange';}else{a=c.toString().asStartUpper()+a;}if(/^[0-9]+/.test(a)){a='Index'+a;}b=TP.isValid(d)?d:TP.hc();if(!TP.canInvoke(b,'atPutIfAbsent')){this.raise('TP.sig.InvalidParameter',arguments,'Description not a collection.');return;}b.atPutIfAbsent('aspect',c);b.atPutIfAbsent('action',f||TP.UPDATE);b.atPutIfAbsent('target',this);TP.signal(this,a,arguments,b,TP.INHERITANCE_FIRING);return this;});TP.$changed=func;TP.sys.$changed=func;TP.defineMetaInstMethod('changed',func=function(a,b,c){return this.$changed(a,b,c);});TP.changed=func;TP.sys.changed=func;Array.Inst.defineMethod('changed',function(a,b,c){this.$needsSort=true;return this.$changed(a,b,c);});String.Inst.defineMethod('changed',function(f,g,d){var a,e,c,b;if(!TP.sys.hasInitialized()){return;}a=TP.sys.getObjectById(this.toString());if(TP.canInvoke(a,'changed')){return a.changed(f,g,d);}c='Change';e=TP.ifKeyInvalid(d,'aspect',f)||'value';if(e==='value'){c='TP.sig.ValueChange';}else{c=e.toString().asStartUpper()+c;}b=TP.isValid(d)?d:TP.hc();if(!TP.canInvoke(b,'atPutIfAbsent')){this.raise('TP.sig.InvalidParameter',arguments,'Description not a collection.');return;}b.atPutIfAbsent('aspect',e);b.atPutIfAbsent('action',g||TP.UPDATE);b.atPutIfAbsent('target',a||this);TP.signal(this,c,arguments,b,TP.INHERITANCE_FIRING);return TP.isValid(a)?a:this;});Array.Inst.defineMethod('item',function(a){return this.at(a);});TP.defineMetaInstMethod('getItems',function(a){return this.getPairs(a);});Array.Inst.defineMethod('getItems',function(a){if(TP.isCallable(a)){return this.select(a);}return this;});String.Inst.defineMethod('getItems',function(a){if(TP.isCallable(a)){return this.getValues().select(a);}return this.getValues();});TP.defineMetaInstMethod('asDisplayString',function(A,q){var a,g,d,b,c,f,e,x,y,m,n,l,p,i,j,s,t,u,v,w,k,h,z,o,r;a=TP.ifInvalid(A,TP.hc('filter','unique_attributes'));g=TP.notDefined(q)?TP.sys.cfg('stack.descent_max'):Math.max(0,q);if(g===0){return this.toString();}r=function(a,b){return a;};x=TP.ifInvalid(a.at('header'),'');y=TP.ifInvalid(a.at('itemPrefix'),'');m=TP.ifInvalid(a.at('keyPrefix'),'');n=TP.ifInvalid(a.at('keyTransform'),r);l=TP.ifInvalid(a.at('keySuffix'),'');p=TP.ifInvalid(a.at('kvSeparator'),'=');i=TP.ifInvalid(a.at('valuePrefix'),'');j=TP.ifInvalid(a.at('valueSuffix'),'');s=TP.ifInvalid(a.at('itemSuffix'),'');t=TP.ifInvalid(a.at('itemSeparator'),'; ');u=TP.ifInvalid(a.at('emptyFunction'),function(){return'';});v=TP.ifInvalid(a.at('footer'),';');w=TP.ifInvalid(a.at('nullValue'),'null');k=TP.ifInvalid(a.at('filter'),'unique_attributes');if(TP.isArray(this)){h=TP.ifInvalid(a.at('useKeys'),true);}else{h=TP.ifInvalid(a.at('useKeys'),false);}z=function(a,b){if(TP.notDefined(a)){return'null';}if(TP.isNull(a)){return'null';}if(a===this){return'this';}if(a===TP.global){return'self';}if(a===window){return'window';}if(a===document){return'document';}if(TP.isNode(a)){return TP.src(a);}if(TP.canInvoke(a,'asString')){return a.asString().asSource();}return TP.str(a).asSource();};o=TP.ifInvalid(a.at('valueTransform'),z);c=TP.ac();c.push(x);if(h){b=this.getKeys(k,true);}else{b=this.getLocalInterface(k);}if(TP.isDefined(f=a.at('useSort'))){if(TP.isCallable(f)){b.sort(f);}else{if(TP.isValid(b.at(0))){if(b.at(0)===0){b.sort(TP.NUMERIC_SORT);}else{b.sort();}}}}else{if(TP.isValid(b.at(0))){if(b.at(0)===0){b.sort(TP.NUMERIC_SORT);}else{b.sort();}}}for(d=0;d<b.getSize();d++){e=this.at(b.at(d));c.push(y);c.push(m,n(b.at(d),e),l);c.push(p);if(TP.isNull(e)){c.push(i,w,j);}else{c.push(i,o(e,g-1,b.at(d)),j);}c.push(s);if(d<b.getSize()-1){c.push(t);}}if(b.getSize()===0){c.push(u());}c.push(v);return c.join('');});TP.defineMetaInstMethod('asJSONSource',function(){var a;if(this.$$format_asJSONSource){return TP.recursion(this);}try{this.$$format_asJSONSource=true;}catch(a){}a=TP.js2json(this);try{delete this.$$format_asJSONSource;}catch(a){}return a;});TP.defineMetaInstMethod('asSource',function(f){var b,d,c,a,e;if(TP.isType(this)){return this.getTypeName();}if(this.$$format_asSource){return TP.recursion(this);}try{this.$$format_asSource=true;}catch(a){}b=this.getKeys(f);d=b.length;c=TP.ac();for(a=0;a<d;a++){if(TP.isDefined(e=this.at(b[a]))){c.push(TP.join('\'',TP.str(b[a]),'\'',':',TP.src(e)));}}try{delete this.$$format_asSource;}catch(a){}return TP.join('{',c.join(', '),'}');});Array.Inst.defineMethod('asSource',function(){var c,b,a;if(this.$$format_asSource){return TP.recursion(this);}this.$$format_asSource=true;c=this.length;b=TP.ac();for(a=0;a<c;a++){b.push(TP.src(this[a]));}delete this.$$format_asSource;return TP.join('TP.ac(',b.join(', '),')');});Boolean.Inst.defineMethod('asSource',function(){return this?'TP.bc(true)':'TP.bc(false)';});Date.Inst.defineMethod('asSource',function(){return'TP.dc('+this.getTime()+')';});Function.Inst.defineMethod('asSource',function(f,c){var d,b,e,a;if(TP.isNativeType(this)){return TP.NO_SOURCE_REP;}if(TP.isType(this)){return TP.join(this.getSupertype().getName(),'.defineSubtype(\'',this.getNamespacePrefix(),':',this.getLocalName(),'\');');}d=TP.notDefined(c)?TP.sys.cfg('stack.descent_max'):Math.max(0,c);if(d===0){return'function () {}';}b=this.asString();a=TP.ac();if(TP.isMethod(this)){e=this.generateMethodSourceHead();a.push(e,b,')');}else{a.push(b);}a.push(';');return a.join('');});Number.Inst.defineMethod('asSource',function(){return this;});RegExp.Inst.defineMethod('asSource',function(){var a;a='';if(this.ignoreCase){a+='i';}if(this.global){a+='g';}if(this.multiline){a+='m';}return TP.join('TP.rc(',this.source.quoted(),', ',a.quoted(),')');});String.Inst.defineMethod('asSource',function(){return this.toString().quoted();});TP.defineMetaInstMethod('$getEqualityValue',function(){return TP.src(this);});TP.defineMetaInstMethod('$getIdentityValue',function(){return TP.gid(this);});Array.Inst.defineMethod('$getEqualityValue',function(){return this.asString();});Boolean.Inst.defineMethod('$getEqualityValue',function(){return this;});Date.Inst.defineMethod('$getEqualityValue',function(){return this.getTime();});Function.Inst.defineMethod('$getEqualityValue',function(){return this.asString();});Number.Inst.defineMethod('$getEqualityValue',function(){return this;});String.Inst.defineMethod('$getEqualityValue',function(){return this;});RegExp.Inst.defineMethod('$getEqualityValue',function(){return this.asString();});TP.defineMetaInstMethod('equalTo',function(a){var b,c;if(TP.notValid(a)){return false;}b=TP.canInvoke(this,'$getEqualityValue')?this.$getEqualityValue():TP.src(this);c=TP.canInvoke(a,'$getEqualityValue')?a.$getEqualityValue():TP.src(a);return b==c;});Array.Inst.defineMethod('equalTo',function(b){var a;if(!TP.isArray(b)){return false;}if(this.getSize()!==b.length){return false;}for(a=0;a<this.getSize();a++){if(TP.isNull(this.at(a))){if(TP.notNull(b.at(a))){return false;}}else if(TP.notDefined(this.at(a))){if(TP.isDefined(b.at(a))){return false;}}else if(!TP.equal(this.at(a),b.at(a))){return false;}}return true;});Boolean.Inst.defineMethod('equalTo',function(a){if(!TP.isBoolean(a)){return false;}return this.valueOf()===a.valueOf();});Date.Inst.defineMethod('equalTo',function(a){if(!TP.isDate(a)){return false;}return this.getTime()===a.getTime();});Function.Inst.defineMethod('equalTo',function(a){if(!TP.isCallable(a)){return false;}return this.toString()===a.toString();});Number.Inst.defineMethod('equalTo',function(a){if(!TP.isNumber(a)){return false;}return this-0===a-0;});String.Inst.defineMethod('equalTo',function(a){if(!TP.isString(a)){return false;}return''+this===''+a;});TP.defineMetaInstMethod('identicalTo',function(a){var b,c;if(TP.notValid(a)){return false;}b=TP.canInvoke(this,'$getIdentityValue')?this.$getIdentityValue():this;c=TP.canInvoke(a,'$getIdentityValue')?a.$getIdentityValue():a;return b==c;});String.Inst.defineMethod('identicalTo',function(a){if(!TP.isString(a)){return false;}return''+this===''+a;});TP.definePrimitive('equal',function(a,b,c){if(TP.isNull(a)){return TP.isNull(b);}if(TP.notDefined(a)){return TP.notDefined(b);}if(TP.isNode(a)&&TP.isNode(b)){return TP.nodeEqualsNode(a,b);}if(TP.isType(c)){return TP.ac(a,b).equalAs(c);}if(TP.canInvoke(a,'equalTo')){return a.equalTo(b);}else if(TP.canInvoke(b,'equalTo')){return b.equalTo(a);}return TP.js2json(a)===TP.js2json(b);});TP.definePrimitive('identical',function(a,b){if(TP.isNull(a)){return TP.isNull(b);}if(TP.notDefined(a)){return TP.notDefined(b);}if(TP.isNode(a)&&TP.isNode(b)){return a===b;}if(TP.canInvoke(a,'identicalTo')){return a.identicalTo(b);}else if(TP.canInvoke(b,'identicalTo')){return b.identicalTo(a);}return a===b;});TP.defineMetaInstMethod('$getComparisonValue',function(){return this.getSize();});TP.defineMetaInstMethod('compareTo',function(a){var c,b;if(TP.canInvoke(a,'$getComparisonValue')){b=a.$getComparisonValue();}else if(TP.canInvoke(a,'getSize')){b=a.getSize();}else if(TP.isValid(a.length)){b=a.length;}else{return 1;}c=this.$getComparisonValue();if(c>b){return 1;}else if(c<b){return-1;}else{return 0;}});TP.definePrimitive('compare',function(a,b){if(TP.canInvoke(a,'compareTo')){return a.compareTo(b);}else if(TP.canInvoke(b,'compareTo')){return b.compareTo(a);}else{return 0;}});Function.Inst.defineMethod('test',function(b){var a;try{a=this(b);return TP.bc(a);}catch(a){return false;}});String.Inst.defineMethod('test',function(b){var a,c;c=TP.str(b);if(c.indexOf(this.toString())!==TP.NOT_FOUND){return true;}try{a=TP.rc(this.toString());if(TP.isRegExp(a)){return a.test(b);}}catch(a){}return false;});TP.definePrimitive('match',function(a,b){if(TP.canInvoke(a,'test')){return a.test(b);}else if(TP.canInvoke(b,'equalTo')){return b.equalTo(a);}else{return a==b;}});TP.sys.defineMethod('dnu',function(){return;});String.Inst.defineMethod('asCSSName',function(){var a;if(TP.boot.isUA('IE')){a='styleFloat';}else{a='cssFloat';}if(this.toString()===a){return'float';}return this.toString().asHyphenated();});String.Inst.defineMethod('asDOMName',function(){if(this.toString()==='float'){if(TP.boot.isUA('IE')){return'styleFloat';}else{return'cssFloat';}}return this.toString().asCamelCase();});TP.defineCommonMethod('asStartUpper',function(){return this;});TP.defineMetaInstMethod('getProperty',function(b){var a;a=this.$get(b);if(TP.isDefined(a)){return a;}if(TP.sys.$$shouldUseBackstop()){return TP.sys.dnu(this,'get'+b,arguments,arguments);}return;});TP.defineMetaInstMethod('getAccessPathFor',function(b,c){var a;if(TP.isValid(a=this.getFacetValueFor(b,c))&&a.isAccessPath()){return a;}return null;});TP.defineMetaInstMethod('getDescriptorFor',function(a){return null;});TP.defineMetaInstMethod('getFacetValueFor',function(b,c){var a;a=this.getDescriptorFor(b);if(TP.isValid(a)){return a[c];}return null;});TP.defineCommonMethod('isAccessPath',function(){return false;});TP.defineMetaInstMethod('setFacetValueFor',function(b,c,d){var a;a=this.getDescriptorFor(b);if(TP.isValid(a)){a[c]=d;}return this;});TP.defineMetaInstMethod('get',function(a){var b,c,d;if(!TP.isString(a)&&a.isAccessPath()){b=a;}else if(TP.regex.NON_SIMPLE_PATH.test(a)){b=TP.apc(a);}if(TP.notValid(b)){c='get'+a.asStartUpper();if(TP.canInvoke(this,c)){switch(arguments.length){case 1:return this[c]();default:d=TP.args(arguments,1);return this[c].apply(this,d);}}c='is'+a.asStartUpper();if(TP.isMethod(this[c])){return this[c]();}}if(TP.isValid(b)||TP.isValid(b=this.getAccessPathFor(a,'value'))){d=TP.args(arguments);d.atPut(0,this);return b.executeGet.apply(b,d);}return this.getProperty(a);});TP.sys.defineMethod('get',function(){var a;a=this.$get(arguments[0]);if(TP.notDefined(a)){a=TP.sys.getObjectById(arguments[0]);}return a;});Array.Inst.defineMethod('get',function(a){var b,c,e,d;if(!TP.isString(a)&&a.isAccessPath()){b=a;}else if(TP.regex.NON_SIMPLE_PATH.test(a)){b=TP.apc(a);}if(TP.notValid(b)){c='get'+a.asStartUpper();if(TP.canInvoke(this,c)){switch(arguments.length){case 1:return this[c]();default:d=TP.args(arguments,1);return this[c].apply(this,d);}}c='is'+a.asStartUpper();if(TP.isMethod(this[c])){return this[c]();}if(TP.isNumber(e=a.asNumber())){return this.$get(e);}}if(TP.isValid(b)||TP.isValid(b=this.getAccessPathFor(a,'value'))){d=TP.args(arguments);d.atPut(0,this);return b.executeGet.apply(b,d);}return this.getProperty(a);});String.Inst.defineMethod('get',function(a){var b,c,d;if(!TP.isString(a)&&a.isAccessPath()){b=a;}else if(TP.regex.NON_SIMPLE_PATH.test(a)){b=TP.apc(a);}if(TP.notValid(b)){c='get'+a.asStartUpper();if(TP.canInvoke(this,c)){switch(arguments.length){case 1:return this[c]();default:d=TP.args(arguments,1);return this[c].apply(this,d);}}c='is'+a.asStartUpper();if(TP.isMethod(this[c])){return this[c]();}if(TP.isNumber(a)){return this.charAt(a);}}if(TP.isValid(b)||TP.isValid(b=this.getAccessPathFor(a,'value'))){d=TP.args(arguments);d.atPut(0,this);return b.executeGet.apply(b,d);}return this.getProperty(a);});TP.defineCommonMethod('getContent',function(){return this.getValue();});TP.defineCommonMethod('getValue',function(){var a;if(TP.isNode(this)){return TP.tpnode(this).getValue();}a=this.$get('value');if(TP.isDefined(a)){return a;}return this;});Boolean.Inst.defineMethod('getValue',function(){return this;});Number.Inst.defineMethod('getValue',function(){return this+0;});String.Inst.defineMethod('getValue',function(){return this;});TP.defineMetaInstMethod('setProperty',function(a,b,c){return this.$set(a,b,c);});TP.defineMetaInstMethod('set',function(a,e,f){var b,c,d;if(!TP.isMutable(this)){return this.raise('TP.sig.NonMutableInstance',arguments,a);}if(TP.isEmpty(a)){return this.raise('TP.sig.InvalidKey',arguments);}if(!TP.isString(a)&&a.isAccessPath()){b=a;}else if(TP.regex.NON_SIMPLE_PATH.test(a)){b=TP.apc(a);}if(TP.notValid(b)){c='set'+a.asStartUpper();if(TP.canInvoke(this,c)){switch(arguments.length){case 1:return this[c]();default:d=TP.args(arguments,1);return this[c].apply(this,d);}}if(TP.isBoolean(e)){c='is'+a.asStartUpper();if(TP.isMethod(this[c])){return this[c](e);}}}if(TP.isValid(b)||TP.isValid(b=this.getAccessPathFor(a,'value'))){d=TP.args(arguments);d.atPut(0,this);return b.executeSet.apply(b,d);}return this.setProperty(a,e,f);});Array.Inst.defineMethod('set',function(a,e,f){var b,c,g,d;if(TP.isEmpty(a)){return this.raise('TP.sig.InvalidKey',arguments);}if(!TP.isString(a)&&a.isAccessPath()){b=a;}else if(TP.regex.NON_SIMPLE_PATH.test(a)){b=TP.apc(a);}if(TP.notValid(b)){c='set'+a.asStartUpper();if(TP.canInvoke(this,c)){switch(arguments.length){case 1:return this[c]();default:d=TP.args(arguments,1);return this[c].apply(this,d);}}if(TP.isBoolean(e)){c='is'+a.asStartUpper();if(TP.isMethod(this[c])){return this[c](e);}}if(TP.isNumber(g=a.asNumber())){return this.$set(g,e,f);}}if(TP.isValid(b)||TP.isValid(b=this.getAccessPathFor(a,'value'))){d=TP.args(arguments);d.atPut(0,this);return b.executeSet.apply(b,d);}return this.setProperty(a,e,f);});TP.defineCommonMethod('setValue',function(a){return this.$set('value',a);});TP.sys.defineMethod('hasDebugger',function(){return false;});TP.sys.defineMethod('runDebugger',function(a){return;});TP.sys.defineMethod('$launchDebugger',function(a){if(this.hasDebugger()){this.runDebugger(a);}else{try{debugger;}catch(a){}}return;});TP.defineCommonMethod('copy',function(e){var a,b,c,f,g,d;c=this.getType().construct();if(!TP.isArray(b=e)){f=TP.ifInvalid(e,TP.UNIQUE);b=this.getLocalInterface(f);}g=b.getSize();for(a=0;a<g;a++){d=b.at(a);c.$set(d,this.at(d),false);}return c;});Array.Inst.defineMethod('copy',function(f,i){var g,b,a,c,h,d,e;g=TP.ifInvalid(i,true);if(g&&TP.notValid(f)){return this.slice(0,this.length);}else{b=TP.ac();a=TP.ifInvalid(f,TP.UNIQUE);if(TP.isString(a)){c=this.getLocalInterface(a);}else if(TP.isArray(a)){c=a;}else{return b;}h=c.getSize();for(d=0;d<h;d++){e=c.at(d);b.$set(e,this.at(e),false);}}return b;});Boolean.Inst.defineMethod('copy',function(){return TP.bc(this);});Date.Inst.defineMethod('copy',function(){return TP.dc(this.getTime());});Function.Inst.defineMethod('copy',function(){var count,source,$$funcCopy,realFunc;realFunc=this.$realFunc||this;count=realFunc.$$copyCount||0;count++;realFunc.$$copyCount=count;source='$$funcCopy = '+realFunc.toString().replace(/function (.*?)\(/,'function $1_'+count+'(');eval(source);$$funcCopy.$realFunc=realFunc;return $$funcCopy;});Number.Inst.defineMethod('copy',function(){return TP.nc(this);});RegExp.Inst.defineMethod('copy',function(){return TP.rc(this.toString());});String.Inst.defineMethod('copy',function(){return TP.sc(this);});TP.defineCommonMethod('perform',function(d,h){var g,a,b,c,e,f;g=TP.ifInvalid(h,false);b=TP.keys(this);c=b.length;f=true;if(c>TP.sys.cfg('perform.instrument_max')){f=TP.regex.PERFORM_INSTRUMENT.test(d.toString());}for(a=0;a<c;a++){e=g?c-a-1:a;if(f){d.atStart(a===0?true:false);d.atEnd(a===c-1?true:false);}if(d(TP.ac(b[e],this.at(b[e])),b[e])===TP.BREAK){break;}}return this;});Array.Inst.defineMethod('perform',function(c,g){var b,f,d,a,e;f=TP.ifInvalid(g,false);b=this.length;this.$sortIfNeeded();d=true;if(b>TP.sys.cfg('perform.instrument_max')){d=TP.regex.PERFORM_INSTRUMENT.test(c.toString());}for(a=0;a<b;a++){e=f?b-a-1:a;if(d){c.atStart(a===0?true:false);c.atEnd(a===b-1?true:false);}if(c(this[e],e)===TP.BREAK){break;}}return this;});Number.Inst.defineMethod('perform',function(b,f){var a,c,d,e;e=TP.ifInvalid(f,false);d=true;if(this>TP.sys.cfg('perform.instrument_max')){d=TP.regex.PERFORM_INSTRUMENT.test(b.toString());}for(a=0;a<this;a++){c=e?this-a-1:a;if(d){b.atStart(a===0?true:false);b.atEnd(a===this-1?true:false);}if(b(c,c)===TP.BREAK){break;}}return this;});String.Inst.defineMethod('perform',function(b,g){var a,c,d,e,f;f=TP.ifInvalid(g,false);c=this.length;e=true;if(c>TP.sys.cfg('perform.instrument_max')){e=TP.regex.PERFORM_INSTRUMENT.test(b.toString());}for(a=0;a<c;a++){d=f?c-a-1:a;if(e){b.atStart(a===0?true:false);b.atEnd(a===this-1?true:false);}if(b(this.charAt(d),d)===TP.BREAK){break;}}return this;});TP.defineCommonMethod('collect',function(b){var a;a=TP.ac();this.perform(function(c,d){a.push(b(c,d));});return a;});TP.defineCommonMethod('collectGet',function(a){return this.collect(function(b,c){if(TP.canInvoke(b,'get')){return b.get(a);}else{try{return b[a];}catch(a){return null;}}});});TP.defineCommonMethod('collectInvoke',function(a){var b;b=TP.args(arguments,1);return this.collect(function(c,d){if(TP.canInvoke(c,a)){return c[a].apply(c,b);}else{return null;}});});TP.defineCommonMethod('convert',function(b){var a;a=this;this.perform(function(d,c){a.atPut(c,b(d,c));});this.changed('value',TP.UPDATE);return this;});TP.defineCommonMethod('detectInvoke',function(b){var c,a;c=TP.args(arguments,1);this.perform(function(d,e){if(TP.canInvoke(d,b)){a=d[b].apply(d,c);if(TP.isValid(a)){return TP.BREAK;}}});return a;});TP.defineCommonMethod('detectMax',function(c){var b,a;b=TP.ifInvalid(c,TP.RETURN_ARG0);a=undefined;this.perform(function(c,e){var d;d=b(c,e);if(d>=(a||c)){a=c;}});return a;});TP.defineCommonMethod('detectMin',function(c){var b,a;b=TP.ifInvalid(c,TP.RETURN_ARG0);a=undefined;this.perform(function(c,e){var d;d=b(c,e);if(d<=(a||c)){a=c;}});return a;});TP.defineCommonMethod('flatten',function(){return this.getItems().flatten();});TP.defineCommonMethod('grep',function(b,e){var c,d,a;c=TP.ifInvalid(e,TP.RETURN_ARG0);a=TP.ac();d=TP.isRegExp(b)?b:TP.rc(b);this.perform(function(b,e){if(TP.isPair(b)){if(d.test(TP.str(b.last()))){a.push(c(b,e));}}else{if(d.test(TP.str(b))){a.push(c(b,e));}}});return a;});TP.defineCommonMethod('grepKeys',function(a,e){var c,d,b;c=TP.ifInvalid(e,TP.RETURN_ARG0);b=TP.ac();d=TP.isRegExp(a)?a:TP.rc(a);this.perform(function(e,a){if(d.test(TP.str(a))){b.push(c(e,a));}});return b;});TP.defineCommonMethod('groupBy',function(d,a){var b,c;switch(typeof d){case'number':c=TP.ac();this.perform(function(e,f){var b;if(TP.isCallable(a)){if(!a(e)){return;}}if(f%d===0){b=TP.ac();c.push(b);}else{b=c.last();}b.push(e);});return c;case'function':b=TP.hc();this.perform(function(e,g){var f,c;if(TP.isCallable(a)){if(!a(e)){return;}}f=d(e,g);if(TP.notValid(c=b.at(f))){c=TP.ac();b.atPut(f,c);}c.push(e);});return b;default:return this.raise('TP.sig.InvalidParameter',arguments);}});TP.defineCommonMethod('injectInto',function(b,c){var a;a=b;this.perform(function(b,d){a=c(b,a,d);});return a;});TP.defineCommonMethod('orderedBy',function(b){var a;a=this.collect(function(a,c){return TP.ac(a,b(a,c));});return a.sort(TP.SECOND_ITEM_SORT);});TP.defineCommonMethod('partition',function(c){var a,b;a=TP.ac();b=TP.ac();this.perform(function(d,e){if(c(d,e)){a.push(d);}else{b.push(d);}});return TP.ac(a,b);});TP.defineCommonMethod('performInvoke',function(a){var b;b=TP.args(arguments,1);return this.perform(function(c,d){if(TP.canInvoke(c,a)){return c[a].apply(c,b);}else{return null;}});});TP.defineCommonMethod('performOver',function(a,b){var c;if(TP.notValid(b)){return this.perform(a);}c=this;b.perform(function(b,d){a(c.at(b),b,d);});return this;});TP.defineCommonMethod('performSet',function(a,b){this.perform(function(c,d){if(TP.canInvoke(c,'set')){c.set(a,b);}else{try{c[a]=b;return c[a];}catch(a){}}});return this;});TP.defineCommonMethod('performUntil',function(a,b){this.perform(function(c,d){a(c,d);if(b(c,d)){return TP.BREAK;}});return this;});TP.defineCommonMethod('performWhile',function(a,b){this.perform(function(c,d){if(TP.notTrue(b(c,d))){return TP.BREAK;}a(c,d);});return this;});TP.defineCommonMethod('performWith',function(a,b){this.perform(function(d,c){a(d,b.at(c),c);});return this;});TP.defineCommonMethod('reject',function(b){var a;a=TP.ac();this.perform(function(c,d){if(!b(c,d)){a.push(c);}});if(TP.isString(this)){return a.join('');}return a;});TP.defineCommonMethod('select',function(b){var a;a=TP.ac();this.perform(function(c,d){if(b(c,d)){a.push(c);}});if(TP.isString(this)){return a.join('');}return a;});Array.Inst.defineMethod('choose',function(){var a,b;a=TP.args(arguments);this.perform(function(c,d){try{b=c.apply(c,a);return TP.BREAK;}catch(a){return;}});return b;});Array.Inst.defineMethod('compact',function(f){var e,a,b,c,d;e=TP.ifInvalid(f,TP.notValid);a=0;b=this.length;for(c=0;c<b;c++){d=this[c];if(!e(d)){this[a]=d;a++;}}if(a<b){this.length=a;this.changed('length',TP.DELETE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,a));}return this;});Array.Inst.defineMethod('conform',function(b,e){var a,c,d;if(TP.isFalse(e)){return this.select(function(a){return TP.canInvoke(a,b);});}c=this.length;for(a=0;a<c;a++){d=this[a];if(!TP.canInvoke(d,b)){this.atPut(a,null,false);}}return this.compact();});Array.Inst.defineMethod('detect',function(c,d){var a,b;b=TP.ifInvalid(this.normalizeIndex(d),0);this.$sortIfNeeded();a=undefined;this.perform(function(d,e){if(e<b){return;}if(c(d,e)){a=d;return TP.BREAK;}});return a;});Array.Inst.defineMethod('detectInvoke',function(b){var c,a;c=TP.args(arguments,1);this.perform(function(d,e){if(TP.canInvoke(d,b)){a=d[b].apply(d,c);if(TP.isValid(a)){return TP.BREAK;}}});return a;});Array.Inst.defineMethod('invoke',function(c,d,a){var b;this.perform(function(e,f){try{b=e.apply(c,d);}catch(b){if(TP.isCallable(a)){a(e,f,b);}}});return b;});Array.Inst.defineMethod('invokeAsync',function(h,j,g,i){var b,e,d,f,a,c;b=this;e=TP.ac();a=TP.ac();d=this.collect(function(i,f){return function(){try{e.atPut(f,i.apply(h,j));}catch(d){a.atPut(f,d);if(TP.isCallable(g)){g(c,f,d);}else{b.raise('TP.sig.InvokeFailed',arguments,TP.ec(d,'Invocation failed'));}}finally{d.signal('TP.sig.InvokeNext');}};});f=function(){if(i&&a.length>0){b.signal('TP.sig.InvokeComplete',arguments,TP.hc('results',e,'errors',a));}c=d.shift();if(TP.isCallable(c)){setTimeout(c);}else{b.signal('TP.sig.InvokeComplete',arguments,TP.hc('results',e,'errors',a));}};f.observe(d,'TP.sig.InvokeNext');f();return;});Number.Inst.defineMethod('by',function(b,c){var a;a=0;this.perform(function(e,d){if(d%b===0){a++;c(e,d);}});return a;});RegExp.Inst.defineMethod('performWith',function(c,d){var a,b,e;a=TP.str(d);b=this;this.lastIndex=0;e=this.global?NaN:1;return a.replace(this,function(){var d;d=c.apply(this,arguments);switch(d){case TP.BREAK:b.lastIndex=a.length;return arguments[0];case TP.CONTINUE:return arguments[0];default:return d;}});});String.Inst.defineMethod('convert',function(b){var c,a;c=this;a=TP.ac();this.perform(function(c,d){a.push(b(c,d));});return a.join('');});String.Inst.defineMethod('times',function(b){var a,c;if(!TP.isNumber(b)){this.raise('TP.sig.InvalidParameter',arguments);}a=TP.ac();c=this;b.perform(function(){a.push(c);});return a.join('');});TP.defineCommonMethod('containsKey',function(b){var a;a=this.at(b);return TP.isDefined(a)&&!TP.$$isDNU(a);});TP.defineCommonMethod('containsValue',function(a,c){var b;b=this.detect(function(b,d){switch(c){case TP.IDENTITY:return TP.identical(b.last(),a);default:return TP.equal(b.last(),a);}});return TP.isDefined(b);});TP.defineCommonMethod('contains',function(a,d){var c,b;if(!TP.isPair(a)||TP.notValid(c=a.at(0))){return false;}b=this.at(c);switch(d){case TP.IDENTITY:return TP.identical(b,a.last());default:return TP.equal(b,a.last());}return false;});Array.Inst.defineMethod('contains',function(a,c){var b;if(TP.isString(a)){return this.containsString(a);}b=this.detect(function(b,d){switch(c){case TP.IDENTITY:return TP.identical(b,a);default:return TP.equal(b,a);}});return TP.isDefined(b);});Array.Inst.defineMethod('containsString',function(c){var d,e,f,b,a;d=this.length;if(d<TP.sys.cfg('array.contains_loop_max')){for(b=0;b<d;b++){if(this[b]===c){return true;}}return false;}TP.regex.QUANTIFIERS.lastIndex=0;if(TP.regex.QUANTIFIERS.test(c)){a=c.replace(/\$/g,'\\$');a=a.replace(/\./g,'\\.');a=a.replace(/\?/g,'\\?');a=a.replace(/\(/g,'\\(');a=a.replace(/\)/g,'\\)');}else{a=c;}try{f=TP.JOIN+this.join(TP.JOIN)+TP.JOIN;e=TP.rc(TP.JOIN+a+TP.JOIN);return e.test(f);}catch(a){for(b=0;b<this.length;b++){if(this[b]===c){return true;}}}return false;});TP.defineMetaInstMethod('shouldLog',function(a,b){var c,d;if(TP.isString(b)){if(TP.isBoolean(a)){this['$shouldLog'+b]=TP.bc(a);}c=this['$shouldLog'+b];}else{if(TP.isBoolean(a)){this['$shouldLog'+TP.LOG]=TP.bc(a);}c=this['$shouldLog'+TP.LOG];}if(TP.isBoolean(c)){return c;}else if(TP.isMethod(this)){if(TP.isValid(d=this[TP.OWNER])){if(TP.canInvoke(d,'shouldLog')){return d.shouldLog(a,b);}}return true;}else{return true;}});TP.boot.Log.prototype.clearEntries=function(a,b){if(TP.isEmpty(a)){this.messages.length=0;return this;}return this.messages.compact(function(c){if(TP.isEmpty(a)||a===c[TP.LOG_ENTRY_NAME]){if(TP.isEmpty(b)){return true;}else{return b!==c[TP.LOG_ENTRY_LEVEL];}}return false;});};TP.boot.Log.prototype.lastEntry=function(c,d){var a,b;if(TP.isEmpty(a=this.getEntries(c,d))){return null;}b=a.last();return b;};TP.boot.Log.prototype.getEntries=function(a,b){var c;c=this.messages.select(function(c){if(TP.isEmpty(a)||a===c[TP.LOG_ENTRY_NAME]){if(TP.isEmpty(b)){return true;}else{return b===c[TP.LOG_ENTRY_LEVEL];}}return false;});return c;};TP.boot.Log.prototype.hasEntries=function(a,b){return TP.isValid(this.messages.detect(function(c){if(TP.isEmpty(a)||a===c[TP.LOG_ENTRY_NAME]){if(TP.isEmpty(b)){return true;}else{return b===c[TP.LOG_ENTRY_LEVEL];}}return false;}));};TP.sys.defineMethod('$logChanged',function(a){var b;TP.debug('break.change');if(TP.notValid(a)){return;}if(TP.sys.shouldSignalLogChange()){try{b=TP.sys.shouldLogActivities();TP.sys.shouldLogActivities(false);TP.signal(TP.sys,a+'LogChange');}catch(a){}finally{TP.sys.shouldLogActivities(b);}}return;});TP.sys.$activity=TP.ifInvalid(TP.sys.$activity,new TP.boot.Log());TP.sys.defineMethod('getActivityLog',function(){return TP.sys.$activity;});TP.sys.defineMethod('$$log',function(e,q,p,d){var j,b,l,m,n,i,c,k,a,o,f,g,h;TP.sys.trapRecursion();if(!TP.sys.shouldLogActivities()){return false;}j=TP.ifInvalid(q,TP.LOG);b=TP.ifInvalid(p,TP.sys.getLogLevel());l=b>TP.WARN&&b<TP.SYSTEM;try{m=TP.sys.shouldLogActivities();n=TP.sys.shouldLogErrors();TP.sys.shouldLogActivities(false,false);TP.sys.shouldLogErrors(false,false);TP.sys.$activity.log(e,j,b,d);i=TP.sys.$activity.last();if(b!==TP.SYSTEM){if(TP.sys.shouldLogStack()){try{throw new Error();}catch(a){c=TP.getStackInfo(a);}c.shift();c.shift();c.shift();if(TP.sys.shouldLogStackArguments()){if(TP.isArgArray(d)){k=TP.args(d);}}i.push(c);if(TP.isArray(k)){i.push(k);}}}if(TP.sys.$activity.getSize()>TP.sys.cfg('log.size_max')){TP.sys.$activity.shift();}a=TP.hc();a.atPut('messageLevel',b);a.atPut('messageType','log');a.atPut('cmd',TP.boot.Log.getStringForLevel(b).toLowerCase());o=TP.sys.cfg('log.default_format','tsh:pp');f=TP.format(e,o,a);a.atPut('cmdAsIs',true);a.atPut('cmdBox',false);a.atPut('echoRequest',true);if(l){if(!TP.sys.hasStarted()){if(TP.canInvoke(TP.boot,'$stderr')){TP.boot.$stderr(e,d||arguments);}}else{TP.stderr(f,a);}}else{TP.stdout(f,a);}TP.sys.$logChanged(j);}catch(a){try{g=' obj: '+TP.str(e);}catch(a){g='';}h='Error in TP.sys.$$log: '+TP.str(a)+g;top.console.error(h);TP.alert(h);}finally{TP.sys.shouldLogActivities(m,false);TP.sys.shouldLogErrors(n,false);}if(l&&TP.sys.shouldUseDebugger()){TP.sys.$launchDebugger(arguments);}return true;});TP.sys.defineMethod('log',function(c,d,a,e){var b;b=TP.ifInvalid(a,TP.WARN);if(TP.sys.getLogLevel()<=b){return TP.sys.$$log(c,d,a,e);}return false;});TP.sys.$testlog=TP.ifInvalid(TP.sys.$testlog,new TP.boot.Log());TP.sys.defineMethod('getTestLog',function(){return TP.sys.$testlog;});TP.sys.defineMethod('logTest',function(a,c,b){TP.sys.$testlog.log(a,TP.TEST_LOG,TP.SYSTEM,b||arguments);console.log(TP.str(a));TP.sys.log(a,TP.TEST_LOG,c,b||arguments);TP.sys.$logChanged(TP.TEST_LOG);return true;});TP.sys.defineMethod('logCSS',function(a,b,c){if(!TP.sys.shouldLogCSS()){return false;}TP.sys.log(a,TP.CSS_LOG,b,c||arguments);return true;});TP.sys.defineMethod('logInference',function(a,b,c){if(!TP.sys.shouldLogInferences()){return false;}TP.sys.log(a,TP.INFERENCE_LOG,b,c||arguments);return true;});TP.sys.defineMethod('logIO',function(a,b,c){if(!TP.sys.shouldLogIO()){return false;}TP.sys.log(a,TP.IO_LOG,b,c||arguments);return true;});TP.sys.defineMethod('logJob',function(a,b,c){if(!TP.sys.shouldLogJobs()){return false;}TP.sys.log(a,TP.JOB_LOG,b,c||arguments);return true;});TP.sys.defineMethod('logKey',function(a,b,c){if(!TP.sys.shouldLogKeys()){return false;}TP.sys.log(a,TP.KEY_LOG,b,c||arguments);return true;});TP.sys.defineMethod('logLink',function(a,b,c){if(!TP.sys.shouldLogLinks()){return false;}TP.sys.log(a,TP.LINK_LOG,b,c||arguments);return true;});TP.sys.defineMethod('logSecurity',function(a,b,c){if(!TP.sys.shouldLogSecurity()){return false;}TP.sys.log(a,TP.SECURITY_LOG,b,c||arguments);return true;});TP.sys.defineMethod('logSignal',function(b,c,d){var a;if(!TP.sys.shouldLogSignals()){return false;}a=TP.ifInvalid(c,TP.TRACE);if(TP.sys.getLogLevel()<=a){TP.sys.log(b.get('message'),TP.SIGNAL_LOG,a,d||arguments);}return true;});TP.sys.defineMethod('logTransform',function(a,b,c){if(!TP.sys.shouldLogTransforms()){return false;}TP.sys.log(a,TP.TRANSFORM_LOG,b,c||arguments);return true;});TP.defineMetaInstMethod('asInterface',function(){return this.getLocalInterface('methods');});Array.Inst.defineMethod('asInterface',function(){return this;});String.Inst.defineMethod('asInterface',function(){var a;a=TP.ac();a.push(this);return a;});TP.sys.$$NSMString='TP.raise(this, "TP.sig.NoSuchMethod", arguments); return;';TP.FunctionProto.defineMethod('asDNU',function(){var a,b;b=this[TP.NAME];a=function(){var a;a=TP.sys.dnu(this,b,arguments,arguments);return a;};a[TP.NAME]=this[TP.NAME]||'DoesNotUnderstand'+this.getName();a[TP.OWNER]=this[TP.OWNER]||TP.NONE;a[TP.TRACK]=this[TP.TRACK]||TP.NONE;a[TP.DISPLAY]=TP.id(a[TP.OWNER])+'.'+a[TP.NAME];a.$$dnu=true;return a;});Function.Type.defineMethod('constructDNU',function(b){var a;if(TP.isEmpty(b)){this.raise('TP.sig.InvalidParameter',arguments);}a=function(){var a;a=TP.sys.dnu(this,b,arguments,arguments);return a;};a[TP.NAME]=b;a[TP.OWNER]=TP.NONE;a[TP.TRACK]=TP.NONE;a[TP.DISPLAY]=TP.id(a[TP.OWNER])+'.'+a[TP.NAME];a.$$dnu=true;return a;});Function.Type.defineMethod('constructDelegator',function(a){var b,c;if(TP.isEmpty(a)){this.raise('TP.sig.InvalidParameter',arguments);}c=TP.join('var del;','var func;','del = this.getDelegate();','if (TP.notValid(del)) return;','func = del["',a,'"];','if (TP.isCallable(func)) return func.apply(del, arguments);','return;');b=TP.fc(c);if(!TP.isFunction(b)){TP.ifWarn()?TP.warn('Unable to construct delegator for '+a,TP.LOG,arguments):0;}return b;});Function.Type.defineMethod('constructNSM',function(b){var a;if(TP.isEmpty(b)){this.raise('TP.sig.InvalidParameter',arguments);}a=TP.fc(TP.sys.$$NSMString);a[TP.NAME]=b;a[TP.OWNER]=TP.NONE;a[TP.TRACK]=TP.NONE;a[TP.DISPLAY]=TP.id(a[TP.OWNER])+'.'+a[TP.NAME];a.$$dnu=true;a.$$nsm=true;return a;});
TP.boot.$srcPath = '~app/node_modules/tibet/deps/q-tpi.min.js';
!function(a){if("function"==typeof bootstrap)bootstrap("promise",a);else if("object"==typeof exports)module.exports=a();else if("function"==typeof define&&define.amd)define(a);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=a}else Q=a()}(function(){"use strict";function a(a){return function(){return V.apply(a,arguments)}}function b(a){return a===Object(a)}function c(a){return"[object StopIteration]"===bb(a)||a instanceof R}function d(a,b){if(O&&b.stack&&"object"==typeof a&&null!==a&&a.stack&&-1===a.stack.indexOf(cb)){for(var c=[],d=b;d;d=d.source)d.stack&&c.unshift(d.stack);c.unshift(a.stack);var f=c.join("\n"+cb+"\n");a.stack=e(f)}}function e(a){for(var b=a.split("\n"),c=[],d=0;d<b.length;++d){var e=b[d];h(e)||f(e)||!e||c.push(e)}return c.join("\n")}function f(a){return-1!==a.indexOf("(module.js:")||-1!==a.indexOf("(node.js:")}function g(a){var b=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(a);if(b)return[b[1],Number(b[2])];var c=/at ([^ ]+):(\d+):(?:\d+)$/.exec(a);if(c)return[c[1],Number(c[2])];var d=/.*@(.+):(\d+)$/.exec(a);return d?[d[1],Number(d[2])]:void 0}function h(a){var b=g(a);if(!b)return!1;var c=b[0],d=b[1];return c===Q&&d>=S&&gb>=d}function i(){if(O)try{throw new Error}catch(a){var b=a.stack.split("\n"),c=b[0].indexOf("@")>0?b[1]:b[2],d=g(c);if(!d)return;return Q=d[0],d[1]}}function j(a,b,c){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(b+" is deprecated, use "+c+" instead.",new Error("").stack),a.apply(a,arguments)}}function k(a){return r(a)?a:s(a)?B(a):A(a)}function l(){function a(a){b=a,f.source=a,X(c,function(b,c){U(function(){a.promiseDispatch.apply(a,c)})},void 0),c=void 0,d=void 0}var b,c=[],d=[],e=$(l.prototype),f=$(o.prototype);if(f.promiseDispatch=function(a,e,f){var g=W(arguments);c?(c.push(g),"when"===e&&f[1]&&d.push(f[1])):U(function(){b.promiseDispatch.apply(b,g)})},f.valueOf=function(){if(c)return f;var a=q(b);return r(a)&&(b=a),a},f.inspect=function(){return b?b.inspect():{state:"pending"}},k.longStackSupport&&O)try{throw new Error}catch(g){f.stack=g.stack.substring(g.stack.indexOf("\n")+1)}return e.promise=f,e.resolve=function(c){b||a(k(c))},e.fulfill=function(c){b||a(A(c))},e.reject=function(c){b||a(z(c))},e.notify=function(a){b||X(d,function(b,c){U(function(){c(a)})},void 0)},e}function m(a){if("function"!=typeof a)throw new TypeError("resolver must be a function.");var b=l();try{a(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}return b.promise}function n(a){return m(function(b,c){for(var d=0,e=a.length;e>d;d++)k(a[d]).then(b,c)})}function o(a,b,c){void 0===b&&(b=function(a){return z(new Error("Promise does not support operation: "+a))}),void 0===c&&(c=function(){return{state:"unknown"}});var d=$(o.prototype);if(d.promiseDispatch=function(c,e,f){var g;try{g=a[e]?a[e].apply(d,f):b.call(d,e,f)}catch(h){g=z(h)}c&&c(g)},d.inspect=c,c){var e=c();"rejected"===e.state&&(d.exception=e.reason),d.valueOf=function(){var a=c();return"pending"===a.state||"rejected"===a.state?d:a.value}}return d}function p(a,b,c,d){return k(a).then(b,c,d)}function q(a){if(r(a)){var b=a.inspect();if("fulfilled"===b.state)return b.value}return a}function r(a){return b(a)&&"function"==typeof a.promiseDispatch&&"function"==typeof a.inspect}function s(a){return b(a)&&"function"==typeof a.then}function t(a){return r(a)&&"pending"===a.inspect().state}function u(a){return!r(a)||"fulfilled"===a.inspect().state}function v(a){return r(a)&&"rejected"===a.inspect().state}function w(){db.length=0,eb.length=0,fb||(fb=!0)}function x(a,b){fb&&(eb.push(a),db.push(b&&"undefined"!=typeof b.stack?b.stack:"(no stack) "+b))}function y(a){if(fb){var b=Y(eb,a);-1!==b&&(eb.splice(b,1),db.splice(b,1))}}function z(a){var b=o({when:function(b){return b&&y(this),b?b(a):this}},function(){return this},function(){return{state:"rejected",reason:a}});return x(b,a),b}function A(a){return o({when:function(){return a},get:function(b){return a[b]},set:function(b,c){a[b]=c},"delete":function(b){delete a[b]},post:function(b,c){return null===b||void 0===b?a.apply(void 0,c):a[b].apply(a,c)},apply:function(b,c){return a.apply(b,c)},keys:function(){return ab(a)}},void 0,function(){return{state:"fulfilled",value:a}})}function B(a){var b=l();return U(function(){try{a.then(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}}),b.promise}function C(a){return o({isDef:function(){}},function(b,c){return I(a,b,c)},function(){return k(a).inspect()})}function D(a,b,c){return k(a).spread(b,c)}function E(a){return function(){function b(a,b){var g;if("undefined"==typeof StopIteration){try{g=d[a](b)}catch(h){return z(h)}return g.done?k(g.value):p(g.value,e,f)}try{g=d[a](b)}catch(h){return c(h)?k(h.value):z(h)}return p(g,e,f)}var d=a.apply(this,arguments),e=b.bind(b,"next"),f=b.bind(b,"throw");return e()}}function F(a){k.done(k.async(a)())}function G(a){throw new R(a)}function H(a){return function(){return D([this,J(arguments)],function(b,c){return a.apply(b,c)})}}function I(a,b,c){return k(a).dispatch(b,c)}function J(a){return p(a,function(a){var b=0,c=l();return X(a,function(d,e,f){var g;r(e)&&"fulfilled"===(g=e.inspect()).state?a[f]=g.value:(++b,p(e,function(d){a[f]=d,0===--b&&c.resolve(a)},c.reject,function(a){c.notify({index:f,value:a})}))},void 0),0===b&&c.resolve(a),c.promise})}function K(a){return p(a,function(a){return a=Z(a,k),p(J(Z(a,function(a){return p(a,T,T)})),function(){return a})})}function L(a){return k(a).allSettled()}function M(a,b){return k(a).then(void 0,void 0,b)}function N(a,b){return k(a).nodeify(b)}var O=!1;try{throw new Error}catch(P){O=!!P.stack}var Q,R,S=i(),T=function(){},U=function(){function a(){for(;b.next;){b=b.next;var c=b.task;b.task=void 0;var e=b.domain;e&&(b.domain=void 0,e.enter());try{c()}catch(g){if(f)throw e&&e.exit(),setTimeout(a,0),e&&e.enter(),g;setTimeout(function(){throw g},0)}e&&e.exit()}d=!1}var b={task:void 0,next:null},c=b,d=!1,e=void 0,f=!1;if(U=function(a){c=c.next={task:a,domain:f&&process.domain,next:null},d||(d=!0,e())},"undefined"!=typeof process&&process.nextTick)f=!0,e=function(){process.nextTick(a)};else if("function"==typeof setImmediate)e="undefined"!=typeof window?setImmediate.bind(window,a):function(){setImmediate(a)};else if("undefined"!=typeof MessageChannel){var g=new MessageChannel;g.port1.onmessage=function(){e=h,g.port1.onmessage=a,a()};var h=function(){g.port2.postMessage(0)};e=function(){setTimeout(a,0),h()}}else e=function(){setTimeout(a,0)};return U}(),V=Function.call,W=a(Array.prototype.slice),X=a(Array.prototype.reduce||function(a,b){var c=0,d=this.length;if(1===arguments.length)for(;;){if(c in this){b=this[c++];break}if(++c>=d)throw new TypeError}for(;d>c;c++)c in this&&(b=a(b,this[c],c));return b}),Y=a(Array.prototype.indexOf||function(a){for(var b=0;b<this.length;b++)if(this[b]===a)return b;return-1}),Z=a(Array.prototype.map||function(a,b){var c=this,d=[];return X(c,function(e,f,g){d.push(a.call(b,f,g,c))},void 0),d}),$=Object.create||function(a){function b(){}return b.prototype=a,new b},_=a(Object.prototype.hasOwnProperty),ab=Object.keys||function(a){var b=[];for(var c in a)_(a,c)&&b.push(c);return b},bb=a(Object.prototype.toString);R="undefined"!=typeof ReturnValue?ReturnValue:function(a){this.value=a};var cb="From previous event:";k.resolve=k,k.nextTick=U,k.longStackSupport=!1,k.defer=l,l.prototype.makeNodeResolver=function(){var a=this;return function(b,c){b?a.reject(b):a.resolve(arguments.length>2?W(arguments,1):c)}},k.Promise=m,k.promise=m,m.race=n,m.all=J,m.reject=z,m.resolve=k,k.passByCopy=function(a){return a},o.prototype.passByCopy=function(){return this},k.join=function(a,b){return k(a).join(b)},o.prototype.join=function(a){return k([this,a]).spread(function(a,b){if(a===b)return a;throw new Error("Can't join: not the same: "+a+" "+b)})},k.race=n,o.prototype.race=function(){return this.then(k.race)},k.makePromise=o,o.prototype.toString=function(){return"[object Promise]"},o.prototype.then=function(a,b,c){function e(b){try{return"function"==typeof a?a(b):b}catch(c){return z(c)}}function f(a){if("function"==typeof b){d(a,h);try{return b(a)}catch(c){return z(c)}}return z(a)}function g(a){return"function"==typeof c?c(a):a}var h=this,i=l(),j=!1;return U(function(){h.promiseDispatch(function(a){j||(j=!0,i.resolve(e(a)))},"when",[function(a){j||(j=!0,i.resolve(f(a)))}])}),h.promiseDispatch(void 0,"when",[void 0,function(a){var b,c=!1;try{b=g(a)}catch(d){if(c=!0,!k.onerror)throw d;k.onerror(d)}c||i.notify(b)}]),i.promise},k.when=p,o.prototype.thenResolve=function(a){return this.then(function(){return a})},k.thenResolve=function(a,b){return k(a).thenResolve(b)},o.prototype.thenReject=function(a){return this.then(function(){throw a})},k.thenReject=function(a,b){return k(a).thenReject(b)},k.nearer=q,k.isPromise=r,k.isPromiseAlike=s,k.isPending=t,o.prototype.isPending=function(){return"pending"===this.inspect().state},k.isFulfilled=u,o.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},k.isRejected=v,o.prototype.isRejected=function(){return"rejected"===this.inspect().state};var db=[],eb=[],fb=!0;k.resetUnhandledRejections=w,k.getUnhandledReasons=function(){return db.slice()},k.stopUnhandledRejectionTracking=function(){w(),fb=!1},w(),k.reject=z,k.fulfill=A,k.master=C,k.spread=D,o.prototype.spread=function(a,b){return this.all().then(function(b){return a.apply(void 0,b)},b)},k.async=E,k.spawn=F,k["return"]=G,k.promised=H,k.dispatch=I,o.prototype.dispatch=function(a,b){var c=this,d=l();return U(function(){c.promiseDispatch(d.resolve,a,b)}),d.promise},k.get=function(a,b){return k(a).dispatch("get",[b])},o.prototype.get=function(a){return this.dispatch("get",[a])},k.set=function(a,b,c){return k(a).dispatch("set",[b,c])},o.prototype.set=function(a,b){return this.dispatch("set",[a,b])},k.del=k["delete"]=function(a,b){return k(a).dispatch("delete",[b])},o.prototype.del=o.prototype["delete"]=function(a){return this.dispatch("delete",[a])},k.mapply=k.post=function(a,b,c){return k(a).dispatch("post",[b,c])},o.prototype.mapply=o.prototype.post=function(a,b){return this.dispatch("post",[a,b])},k.send=k.mcall=k.invoke=function(a,b){return k(a).dispatch("post",[b,W(arguments,2)])},o.prototype.send=o.prototype.mcall=o.prototype.invoke=function(a){return this.dispatch("post",[a,W(arguments,1)])},k.fapply=function(a,b){return k(a).dispatch("apply",[void 0,b])},o.prototype.fapply=function(a){return this.dispatch("apply",[void 0,a])},k["try"]=k.fcall=function(a){return k(a).dispatch("apply",[void 0,W(arguments,1)])},o.prototype.fcall=function(){return this.dispatch("apply",[void 0,W(arguments)])},k.fbind=function(a){var b=k(a),c=W(arguments,1);return function(){return b.dispatch("apply",[this,c.concat(W(arguments))])}},o.prototype.fbind=function(){var a=this,b=W(arguments);return function(){return a.dispatch("apply",[this,b.concat(W(arguments))])}},k.keys=function(a){return k(a).dispatch("keys",[])},o.prototype.keys=function(){return this.dispatch("keys",[])},k.all=J,o.prototype.all=function(){return J(this)},k.allResolved=j(K,"allResolved","allSettled"),o.prototype.allResolved=function(){return K(this)},k.allSettled=L,o.prototype.allSettled=function(){return this.then(function(a){return J(Z(a,function(a){function b(){return a.inspect()}return a=k(a),a.then(b,b)}))})},k.fail=k["catch"]=function(a,b){return k(a).then(void 0,b)},o.prototype.fail=o.prototype["catch"]=function(a){return this.then(void 0,a)},k.progress=M,o.prototype.progress=function(a){return this.then(void 0,void 0,a)},k.fin=k["finally"]=function(a,b){return k(a)["finally"](b)},o.prototype.fin=o.prototype["finally"]=function(a){return a=k(a),this.then(function(b){return a.fcall().then(function(){return b})},function(b){return a.fcall().then(function(){throw b})})},k.done=function(a,b,c,d){return k(a).done(b,c,d)},o.prototype.done=function(a,b,c){var e=function(a){U(function(){if(d(a,f),!k.onerror)throw a;k.onerror(a)})},f=a||b||c?this.then(a,b,c):this;"object"==typeof process&&process&&process.domain&&(e=process.domain.bind(e)),f.then(void 0,e)},k.timeout=function(a,b,c){return k(a).timeout(b,c)},o.prototype.timeout=function(a,b){var c=l(),d=setTimeout(function(){b&&"string"!=typeof b||(b=new Error(b||"Timed out after "+a+" ms"),b.code="ETIMEDOUT"),c.reject(b)},a);return this.then(function(a){clearTimeout(d),c.resolve(a)},function(a){clearTimeout(d),c.reject(a)},c.notify),c.promise},k.delay=function(a,b){return void 0===b&&(b=a,a=void 0),k(a).delay(b)},o.prototype.delay=function(a){return this.then(function(b){var c=l();return setTimeout(function(){c.resolve(b)},a),c.promise})},k.nfapply=function(a,b){return k(a).nfapply(b)},o.prototype.nfapply=function(a){var b=l(),c=W(a);return c.push(b.makeNodeResolver()),this.fapply(c).fail(b.reject),b.promise},k.nfcall=function(a){var b=W(arguments,1);return k(a).nfapply(b)},o.prototype.nfcall=function(){var a=W(arguments),b=l();return a.push(b.makeNodeResolver()),this.fapply(a).fail(b.reject),b.promise},k.nfbind=k.denodeify=function(a){var b=W(arguments,1);return function(){var c=b.concat(W(arguments)),d=l();return c.push(d.makeNodeResolver()),k(a).fapply(c).fail(d.reject),d.promise}},o.prototype.nfbind=o.prototype.denodeify=function(){var a=W(arguments);return a.unshift(this),k.denodeify.apply(void 0,a)},k.nbind=function(a,b){var c=W(arguments,2);return function(){function d(){return a.apply(b,arguments)}var e=c.concat(W(arguments)),f=l();return e.push(f.makeNodeResolver()),k(d).fapply(e).fail(f.reject),f.promise}},o.prototype.nbind=function(){var a=W(arguments,0);return a.unshift(this),k.nbind.apply(void 0,a)},k.nmapply=k.npost=function(a,b,c){return k(a).npost(b,c)},o.prototype.nmapply=o.prototype.npost=function(a,b){var c=W(b||[]),d=l();return c.push(d.makeNodeResolver()),this.dispatch("post",[a,c]).fail(d.reject),d.promise},k.nsend=k.nmcall=k.ninvoke=function(a,b){var c=W(arguments,2),d=l();return c.push(d.makeNodeResolver()),k(a).dispatch("post",[b,c]).fail(d.reject),d.promise},o.prototype.nsend=o.prototype.nmcall=o.prototype.ninvoke=function(a){var b=W(arguments,1),c=l();return b.push(c.makeNodeResolver()),this.dispatch("post",[a,b]).fail(c.reject),c.promise},k.nodeify=N,o.prototype.nodeify=function(a){return a?void this.then(function(b){U(function(){a(null,b)})},function(b){U(function(){a(b)})}):this};var gb=i();return k});
TP.boot.$srcPath = '~app/node_modules/tibet/deps/forge-tpi.min.js';
(function(){var e,t,n;(function(r){function v(e,t){return h.call(e,t)}function m(e,t){var n,r,i,s,o,u,a,f,c,h,p,v=t&&t.split("/"),m=l.map,g=m&&m["*"]||{};if(e&&e.charAt(0)===".")if(t){v=v.slice(0,v.length-1),e=e.split("/"),o=e.length-1,l.nodeIdCompat&&d.test(e[o])&&(e[o]=e[o].replace(d,"")),e=v.concat(e);for(c=0;c<e.length;c+=1){p=e[c];if(p===".")e.splice(c,1),c-=1;else if(p===".."){if(c===1&&(e[2]===".."||e[0]===".."))break;c>0&&(e.splice(c-1,2),c-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((v||g)&&m){n=e.split("/");for(c=n.length;c>0;c-=1){r=n.slice(0,c).join("/");if(v)for(h=v.length;h>0;h-=1){i=m[v.slice(0,h).join("/")];if(i){i=i[r];if(i){s=i,u=c;break}}}if(s)break;!a&&g&&g[r]&&(a=g[r],f=c)}!s&&a&&(s=a,u=f),s&&(n.splice(0,u,s),e=n.join("/"))}return e}function g(e,t){return function(){return s.apply(r,p.call(arguments,0).concat([e,t]))}}function y(e){return function(t){return m(t,e)}}function b(e){return function(t){a[e]=t}}function w(e){if(v(f,e)){var t=f[e];delete f[e],c[e]=!0,i.apply(r,t)}if(!v(a,e)&&!v(c,e))throw new Error("No "+e);return a[e]}function E(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function S(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=Object.prototype.hasOwnProperty,p=[].slice,d=/\.js$/;o=function(e,t){var n,r=E(e),i=r[0];return e=r[1],i&&(i=m(i,t),n=w(i)),i?n&&n.normalize?e=n.normalize(e,y(t)):e=m(e,t):(e=m(e,t),r=E(e),i=r[0],e=r[1],i&&(n=w(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return g(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:S(e)}}},i=function(e,t,n,i){var s,l,h,p,d,m=[],y=typeof n,E;i=i||e;if(y==="undefined"||y==="function"){t=!t.length&&n.length?["require","exports","module"]:t;for(d=0;d<t.length;d+=1){p=o(t[d],i),l=p.f;if(l==="require")m[d]=u.require(e);else if(l==="exports")m[d]=u.exports(e),E=!0;else if(l==="module")s=m[d]=u.module(e);else if(v(a,l)||v(f,l)||v(c,l))m[d]=w(l);else{if(!p.p)throw new Error(e+" missing "+l);p.p.load(p.n,g(i,!0),b(l),{}),m[d]=a[l]}}h=n?n.apply(a[e],m):undefined;if(e)if(s&&s.exports!==r&&s.exports!==a[e])a[e]=s.exports;else if(h!==r||!E)a[e]=h}else e&&(a[e]=n)},e=t=s=function(e,t,n,a,f){if(typeof e=="string")return u[e]?u[e](t):w(o(e,t).f);if(!e.splice){l=e,l.deps&&s(l.deps,l.callback);if(!t)return;t.splice?(e=t,t=n,n=null):e=r}return t=t||function(){},typeof n=="function"&&(n=a,a=f),a?i(r,e,t,n):setTimeout(function(){i(r,e,t,n)},4),s},s.config=function(e){return s(e)},e._defined=a,n=function(e,t,n){t.splice||(n=t,t=[]),!v(a,e)&&!v(f,e)&&(f[e]=[e,t,n])},n.amd={jQuery:!0}})(),n("node_modules/almond/almond",function(){}),function(){function e(e){var t=e.util=e.util||{};typeof process=="undefined"||!process.nextTick?typeof setImmediate=="function"?(t.setImmediate=setImmediate,t.nextTick=function(e){return setImmediate(e)}):(t.setImmediate=function(e){setTimeout(e,0)},t.nextTick=t.setImmediate):(t.nextTick=process.nextTick,typeof setImmediate=="function"?t.setImmediate=setImmediate:t.setImmediate=t.nextTick),t.isArray=Array.isArray||function(e){return Object.prototype.toString.call(e)==="[object Array]"},t.isArrayBuffer=function(e){return typeof ArrayBuffer!="undefined"&&e instanceof ArrayBuffer};var n=[];typeof Int8Array!="undefined"&&n.push(Int8Array),typeof Uint8Array!="undefined"&&n.push(Uint8Array),typeof Uint8ClampedArray!="undefined"&&n.push(Uint8ClampedArray),typeof Int16Array!="undefined"&&n.push(Int16Array),typeof Uint16Array!="undefined"&&n.push(Uint16Array),typeof Int32Array!="undefined"&&n.push(Int32Array),typeof Uint32Array!="undefined"&&n.push(Uint32Array),typeof Float32Array!="undefined"&&n.push(Float32Array),typeof Float64Array!="undefined"&&n.push(Float64Array),t.isArrayBufferView=function(e){for(var t=0;t<n.length;++t)if(e instanceof n[t])return!0;return!1},t.ByteBuffer=function(e){this.data="",this.read=0;if(typeof e=="string")this.data=e;else if(t.isArrayBuffer(e)||t.isArrayBufferView(e)){var n=new Uint8Array(e);try{this.data=String.fromCharCode.apply(null,n)}catch(r){for(var i=0;i<n.length;++i)this.putByte(n[i])}}else e instanceof t.ByteBuffer&&(this.data=e.data,this.read=e.read)},t.ByteBuffer.prototype.length=function(){return this.data.length-this.read},t.ByteBuffer.prototype.isEmpty=function(){return this.length()<=0},t.ByteBuffer.prototype.putByte=function(e){return this.data+=String.fromCharCode(e),this},t.ByteBuffer.prototype.fillWithByte=function(e,t){e=String.fromCharCode(e);var n=this.data;while(t>0)t&1&&(n+=e),t>>>=1,t>0&&(e+=e);return this.data=n,this},t.ByteBuffer.prototype.putBytes=function(e){return this.data+=e,this},t.ByteBuffer.prototype.putString=function(e){return this.data+=t.encodeUtf8(e),this},t.ByteBuffer.prototype.putInt16=function(e){return this.data+=String.fromCharCode(e>>8&255)+String.fromCharCode(e&255),this},t.ByteBuffer.prototype.putInt24=function(e){return this.data+=String.fromCharCode(e>>16&255)+String.fromCharCode(e>>8&255)+String.fromCharCode(e&255),this},t.ByteBuffer.prototype.putInt32=function(e){return this.data+=String.fromCharCode(e>>24&255)+String.fromCharCode(e>>16&255)+String.fromCharCode(e>>8&255)+String.fromCharCode(e&255),this},t.ByteBuffer.prototype.putInt16Le=function(e){return this.data+=String.fromCharCode(e&255)+String.fromCharCode(e>>8&255),this},t.ByteBuffer.prototype.putInt24Le=function(e){return this.data+=String.fromCharCode(e&255)+String.fromCharCode(e>>8&255)+String.fromCharCode(e>>16&255),this},t.ByteBuffer.prototype.putInt32Le=function(e){return this.data+=String.fromCharCode(e&255)+String.fromCharCode(e>>8&255)+String.fromCharCode(e>>16&255)+String.fromCharCode(e>>24&255),this},t.ByteBuffer.prototype.putInt=function(e,t){do t-=8,this.data+=String.fromCharCode(e>>t&255);while(t>0);return this},t.ByteBuffer.prototype.putSignedInt=function(e,t){return e<0&&(e+=2<<t-1),this.putInt(e,t)},t.ByteBuffer.prototype.putBuffer=function(e){return this.data+=e.getBytes(),this},t.ByteBuffer.prototype.getByte=function(){return this.data.charCodeAt(this.read++)},t.ByteBuffer.prototype.getInt16=function(){var e=this.data.charCodeAt(this.read)<<8^this.data.charCodeAt(this.read+1);return this.read+=2,e},t.ByteBuffer.prototype.getInt24=function(){var e=this.data.charCodeAt(this.read)<<16^this.data.charCodeAt(this.read+1)<<8^this.data.charCodeAt(this.read+2);return this.read+=3,e},t.ByteBuffer.prototype.getInt32=function(){var e=this.data.charCodeAt(this.read)<<24^this.data.charCodeAt(this.read+1)<<16^this.data.charCodeAt(this.read+2)<<8^this.data.charCodeAt(this.read+3);return this.read+=4,e},t.ByteBuffer.prototype.getInt16Le=function(){var e=this.data.charCodeAt(this.read)^this.data.charCodeAt(this.read+1)<<8;return this.read+=2,e},t.ByteBuffer.prototype.getInt24Le=function(){var e=this.data.charCodeAt(this.read)^this.data.charCodeAt(this.read+1)<<8^this.data.charCodeAt(this.read+2)<<16;return this.read+=3,e},t.ByteBuffer.prototype.getInt32Le=function(){var e=this.data.charCodeAt(this.read)^this.data.charCodeAt(this.read+1)<<8^this.data.charCodeAt(this.read+2)<<16^this.data.charCodeAt(this.read+3)<<24;return this.read+=4,e},t.ByteBuffer.prototype.getInt=function(e){var t=0;do t=(t<<8)+this.data.charCodeAt(this.read++),e-=8;while(e>0);return t},t.ByteBuffer.prototype.getSignedInt=function(e){var t=this.getInt(e),n=2<<e-2;return t>=n&&(t-=n<<1),t},t.ByteBuffer.prototype.getBytes=function(e){var t;return e?(e=Math.min(this.length(),e),t=this.data.slice(this.read,this.read+e),this.read+=e):e===0?t="":(t=this.read===0?this.data:this.data.slice(this.read),this.clear()),t},t.ByteBuffer.prototype.bytes=function(e){return typeof e=="undefined"?this.data.slice(this.read):this.data.slice(this.read,this.read+e)},t.ByteBuffer.prototype.at=function(e){return this.data.charCodeAt(this.read+e)},t.ByteBuffer.prototype.setAt=function(e,t){return this.data=this.data.substr(0,this.read+e)+String.fromCharCode(t)+this.data.substr(this.read+e+1),this},t.ByteBuffer.prototype.last=function(){return this.data.charCodeAt(this.data.length-1)},t.ByteBuffer.prototype.copy=function(){var e=t.createBuffer(this.data);return e.read=this.read,e},t.ByteBuffer.prototype.compact=function(){return this.read>0&&(this.data=this.data.slice(this.read),this.read=0),this},t.ByteBuffer.prototype.clear=function(){return this.data="",this.read=0,this},t.ByteBuffer.prototype.truncate=function(e){var t=Math.max(0,this.length()-e);return this.data=this.data.substr(this.read,t),this.read=0,this},t.ByteBuffer.prototype.toHex=function(){var e="";for(var t=this.read;t<this.data.length;++t){var n=this.data.charCodeAt(t);n<16&&(e+="0"),e+=n.toString(16)}return e},t.ByteBuffer.prototype.toString=function(){return t.decodeUtf8(this.bytes())},t.createBuffer=function(e,n){return n=n||"raw",e!==undefined&&n==="utf8"&&(e=t.encodeUtf8(e)),new t.ByteBuffer(e)},t.fillString=function(e,t){var n="";while(t>0)t&1&&(n+=e),t>>>=1,t>0&&(e+=e);return n},t.xorBytes=function(e,t,n){var r="",i="",s="",o=0,u=0;for(;n>0;--n,++o)i=e.charCodeAt(o)^t.charCodeAt(o),u>=10&&(r+=s,s="",u=0),s+=String.fromCharCode(i),++u;return r+=s,r},t.hexToBytes=function(e){var t="",n=0;e.length&!0&&(n=1,t+=String.fromCharCode(parseInt(e[0],16)));for(;n<e.length;n+=2)t+=String.fromCharCode(parseInt(e.substr(n,2),16));return t},t.bytesToHex=function(e){return t.createBuffer(e).toHex()},t.int32ToBytes=function(e){return String.fromCharCode(e>>24&255)+String.fromCharCode(e>>16&255)+String.fromCharCode(e>>8&255)+String.fromCharCode(e&255)};var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i=[62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,64,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51];t.encode64=function(e,t){var n="",i="",s,o,u,a=0;while(a<e.length)s=e.charCodeAt(a++),o=e.charCodeAt(a++),u=e.charCodeAt(a++),n+=r.charAt(s>>2),n+=r.charAt((s&3)<<4|o>>4),isNaN(o)?n+="==":(n+=r.charAt((o&15)<<2|u>>6),n+=isNaN(u)?"=":r.charAt(u&63)),t&&n.length>t&&(i+=n.substr(0,t)+"\r\n",n=n.substr(t));return i+=n,i},t.decode64=function(e){e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");var t="",n,r,s,o,u=0;while(u<e.length)n=i[e.charCodeAt(u++)-43],r=i[e.charCodeAt(u++)-43],s=i[e.charCodeAt(u++)-43],o=i[e.charCodeAt(u++)-43],t+=String.fromCharCode(n<<2|r>>4),s!==64&&(t+=String.fromCharCode((r&15)<<4|s>>2),o!==64&&(t+=String.fromCharCode((s&3)<<6|o)));return t},t.encodeUtf8=function(e){return unescape(encodeURIComponent(e))},t.decodeUtf8=function(e){return decodeURIComponent(escape(e))},t.deflate=function(e,n,r){n=t.decode64(e.deflate(t.encode64(n)).rval);if(r){var i=2,s=n.charCodeAt(1);s&32&&(i=6),n=n.substring(i,n.length-4)}return n},t.inflate=function(e,n,r){var i=e.inflate(t.encode64(n)).rval;return i===null?null:t.decode64(i)};var s=function(e,n,r){if(!e)throw{message:"WebStorage not available."};var i;r===null?i=e.removeItem(n):(r=t.encode64(JSON.stringify(r)),i=e.setItem(n,r));if(typeof i!="undefined"&&i.rval!==!0)throw i.error},o=function(e,n){if(!e)throw{message:"WebStorage not available."};var r=e.getItem(n);if(e.init)if(r.rval===null){if(r.error)throw r.error;r=null}else r=r.rval;return r!==null&&(r=JSON.parse(t.decode64(r))),r},u=function(e,t,n,r){var i=o(e,t);i===null&&(i={}),i[n]=r,s(e,t,i)},a=function(e,t,n){var r=o(e,t);return r!==null&&(r=n in r?r[n]:null),r},f=function(e,t,n){var r=o(e,t);if(r!==null&&n in r){delete r[n];var i=!0;for(var u in r){i=!1;break}i&&(r=null),s(e,t,r)}},l=function(e,t){s(e,t,null)},c=function(e,t,n){var r=null;typeof n=="undefined"&&(n=["web","flash"]);var i,s=!1,o=null;for(var u in n){i=n[u];try{if(i==="flash"||i==="both"){if(t[0]===null)throw{message:"Flash local storage not available."};r=e.apply(this,t),s=i==="flash"}if(i==="web"||i==="both")t[0]=localStorage,r=e.apply(this,t),s=!0}catch(a){o=a}if(s)break}if(!s)throw o;return r};t.setItem=function(e,t,n,r,i){c(u,arguments,i)},t.getItem=function(e,t,n,r){return c(a,arguments,r)},t.removeItem=function(e,t,n,r){c(f,arguments,r)},t.clearItems=function(e,t,n){c(l,arguments,n)},t.parseUrl=function(e){var t=/^(https?):\/\/([^:&^\/]*):?(\d*)(.*)$/g;t.lastIndex=0;var n=t.exec(e),r=n===null?null:{full:e,scheme:n[1],host:n[2],port:n[3],path:n[4]};return r&&(r.fullHost=r.host,r.port?r.port!==80&&r.scheme==="http"?r.fullHost+=":"+r.port:r.port!==443&&r.scheme==="https"&&(r.fullHost+=":"+r.port):r.scheme==="http"?r.port=80:r.scheme==="https"&&(r.port=443),r.full=r.scheme+"://"+r.fullHost),r};var h=null;t.getQueryVariables=function(e){var t=function(e){var t={},n=e.split("&");for(var r=0;r<n.length;r++){var i=n[r].indexOf("="),s,o;i>0?(s=n[r].substring(0,i),o=n[r].substring(i+1)):(s=n[r],o=null),s in t||(t[s]=[]),!(s in Object.prototype)&&o!==null&&t[s].push(unescape(o))}return t},n;return typeof e=="undefined"?(h===null&&(typeof window=="undefined"?h={}:h=t(window.location.search.substring(1))),n=h):n=t(e),n},t.parseFragment=function(e){var n=e,r="",i=e.indexOf("?");i>0&&(n=e.substring(0,i),r=e.substring(i+1));var s=n.split("/");s.length>0&&s[0]===""&&s.shift();var o=r===""?{}:t.getQueryVariables(r);return{pathString:n,queryString:r,path:s,query:o}},t.makeRequest=function(e){var n=t.parseFragment(e),r={path:n.pathString,query:n.queryString,getPath:function(e){return typeof e=="undefined"?n.path:n.path[e]},getQuery:function(e,t){var r;return typeof e=="undefined"?r=n.query:(r=n.query[e],r&&typeof t!="undefined"&&(r=r[t])),r},getQueryLast:function(e,t){var n,i=r.getQuery(e);return i?n=i[i.length-1]:n=t,n}};return r},t.makeLink=function(e,t,n){e=jQuery.isArray(e)?e.join("/"):e;var r=jQuery.param(t||{});return n=n||"",e+(r.length>0?"?"+r:"")+(n.length>0?"#"+n:"")},t.setPath=function(e,t,n){if(typeof e=="object"&&e!==null){var r=0,i=t.length;while(r<i){var s=t[r++];if(r==i)e[s]=n;else{var o=s in e;if(!o||o&&typeof e[s]!="object"||o&&e[s]===null)e[s]={};e=e[s]}}}},t.getPath=function(e,t,n){var r=0,i=t.length,s=!0;while(s&&r<i&&typeof e=="object"&&e!==null){var o=t[r++];s=o in e,s&&(e=e[o])}return s?e:n},t.deletePath=function(e,t){if(typeof e=="object"&&e!==null){var n=0,r=t.length;while(n<r){var i=t[n++];if(n==r)delete e[i];else{if(!(i in e&&typeof e[i]=="object"&&e[i]!==null))break;e=e[i]}}}},t.isEmpty=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},t.format=function(e){var t=/%./g,n,r,i=0,s=[],o=0;while(n=t.exec(e)){r=e.substring(o,t.lastIndex-2),r.length>0&&s.push(r),o=t.lastIndex;var u=n[0][1];switch(u){case"s":case"o":i<arguments.length?s.push(arguments[i++ +1]):s.push("<?>");break;case"%":s.push("%");break;default:s.push("<%"+u+"?>")}}return s.push(e.substring(o)),s.join("")},t.formatNumber=function(e,t,n,r){var i=e,s=isNaN(t=Math.abs(t))?2:t,o=n===undefined?",":n,u=r===undefined?".":r,a=i<0?"-":"",f=parseInt(i=Math.abs(+i||0).toFixed(s),10)+"",l=f.length>3?f.length%3:0;return a+(l?f.substr(0,l)+u:"")+f.substr(l).replace(/(\d{3})(?=\d)/g,"$1"+u)+(s?o+Math.abs(i-f).toFixed(s).slice(2):"")},t.formatSize=function(e){return e>=1073741824?e=t.formatNumber(e/1073741824,2,".","")+" GiB":e>=1048576?e=t.formatNumber(e/1048576,2,".","")+" MiB":e>=1024?e=t.formatNumber(e/1024,0)+" KiB":e=t.formatNumber(e,0)+" bytes",e},t.bytesFromIP=function(e){return e.indexOf(".")!==-1?t.bytesFromIPv4(e):e.indexOf(":")!==-1?t.bytesFromIPv6(e):null},t.bytesFromIPv4=function(e){e=e.split(".");if(e.length!==4)return null;var n=t.createBuffer();for(var r=0;r<e.length;++r){var i=parseInt(e[r],10);if(isNaN(i))return null;n.putByte(i)}return n.getBytes()},t.bytesFromIPv6=function(e){var n=0;e=e.split(":").filter(function(e){return e.length===0&&++n,!0});var r=(8-e.length+n)*2,i=t.createBuffer();for(var s=0;s<8;++s){if(!e[s]||e[s].length===0){i.fillWithByte(0,r),r=0;continue}var o=t.hexToBytes(e[s]);o.length<2&&i.putByte(0),i.putBytes(o)}return i.getBytes()},t.bytesToIP=function(e){return e.length===4?t.bytesToIPv4(e):e.length===16?t.bytesToIPv6(e):null},t.bytesToIPv4=function(e){if(e.length!==4)return null;var t=[];for(var n=0;n<e.length;++n)t.push(e.charCodeAt(n));return t.join(".")},t.bytesToIPv6=function(e){if(e.length!==16)return null;var n=[],r=[],i=0;for(var s=0;s<e.length;s+=2){var o=t.bytesToHex(e[s]+e[s+1]);while(o[0]==="0"&&o!=="0")o=o.substr(1);if(o==="0"){var u=r[r.length-1],a=n.length;!u||a!==u.end+1?r.push({start:a,end:a}):(u.end=a,u.end-u.start>r[i].end-r[i].start&&(i=r.length-1))}n.push(o)}if(r.length>0){var f=r[i];f.end-f.start>0&&(n.splice(f.start,f.end-f.start+1,""),f.start===0&&n.unshift(""),f.end===7&&n.push(""))}return n.join(":")},t.estimateCores=function(e,n){function i(e,u,a){if(u===0){var f=Math.floor(e.reduce(function(e,t){return e+t},0)/e.length);return t.cores=Math.max(1,f),URL.revokeObjectURL(r),n(null,t.cores)}s(a,function(t,n){e.push(o(a,n)),i(e,u-1,a)})}function s(e,t){var n=[],i=[];for(var s=0;s<e;++s){var o=new Worker(r);o.addEventListener("message",function(r){i.push(r.data);if(i.length===e){for(var s=0;s<e;++s)n[s].terminate();t(null,i)}}),n.push(o)}for(var s=0;s<e;++s)n[s].postMessage(s)}function o(e,t){var n=[];for(var r=0;r<e;++r){var i=t[r],s=n[r]=[];for(var o=0;o<e;++o){if(r===o)continue;var u=t[o];(i.st>u.st&&i.st<u.et||u.st>i.st&&u.st<i.et)&&s.push(o)}}return n.reduce(function(e,t){return Math.max(e,t.length)},0)}typeof e=="function"&&(n=e,e={}),e=e||{};if("cores"in t&&!e.update)return n(null,t.cores);if(typeof Worker===undefined)return t.cores=1,n(null,t.cores);if(typeof Blob===undefined)return t.cores=2,n(null,t.cores);var r=URL.createObjectURL(new Blob(["(",function(){self.addEventListener("message",function(e){var t=Date.now(),n=t+4;while(Date.now()<n);self.postMessage({st:t,et:n})})}.toString(),")()"],{type:"application/javascript"}));i([],5,16)}}var r="util";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/util",["require","module"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){var t=!1,n=4,r,i,s,o,u,a=function(){t=!0,s=[0,1,2,4,8,16,32,64,128,27,54];var e=new Array(256);for(var n=0;n<128;++n)e[n]=n<<1,e[n+128]=n+128<<1^283;r=new Array(256),i=new Array(256),o=new Array(4),u=new Array(4);for(var n=0;n<4;++n)o[n]=new Array(256),u[n]=new Array(256);var a=0,f=0,l,c,h,p,d,v,m;for(var n=0;n<256;++n){p=f^f<<1^f<<2^f<<3^f<<4,p=p>>8^p&255^99,r[a]=p,i[p]=a,d=e[p],l=e[a],c=e[l],h=e[c],v=d<<24^p<<16^p<<8^(p^d),m=(l^c^h)<<24^(a^h)<<16^(a^c^h)<<8^(a^l^h);for(var g=0;g<4;++g)o[g][a]=v,u[g][p]=m,v=v<<24|v>>>8,m=m<<24|m>>>8;a===0?a=f=1:(a=l^e[e[e[l^h]]],f^=e[e[f]])}},f=function(e,t){var i=e.slice(0),o,a=1,f=i.length,l=f+6+1,c=n*l;for(var h=f;h<c;++h)o=i[h-1],h%f===0?(o=r[o>>>16&255]<<24^r[o>>>8&255]<<16^r[o&255]<<8^r[o>>>24]^s[a]<<24,a++):f>6&&h%f===4&&(o=r[o>>>24]<<24^r[o>>>16&255]<<16^r[o>>>8&255]<<8^r[o&255]),i[h]=i[h-f]^o;if(t){var p,d=u[0],v=u[1],m=u[2],g=u[3],y=i.slice(0),c=i.length;for(var h=0,b=c-n;h<c;h+=n,b-=n)if(h===0||h===c-n)y[h]=i[b],y[h+1]=i[b+3],y[h+2]=i[b+2],y[h+3]=i[b+1];else for(var w=0;w<n;++w)p=i[b+w],y[h+(3&-w)]=d[r[p>>>24]]^v[r[p>>>16&255]]^m[r[p>>>8&255]]^g[r[p&255]];i=y}return i},l=function(e,t,n,s){var a=e.length/4-1,f,l,c,h,p;s?(f=u[0],l=u[1],c=u[2],h=u[3],p=i):(f=o[0],l=o[1],c=o[2],h=o[3],p=r);var d,v,m,g,y,b,w;d=t[0]^e[0],v=t[s?3:1]^e[1],m=t[2]^e[2],g=t[s?1:3]^e[3];var E=3;for(var S=1;S<a;++S)y=f[d>>>24]^l[v>>>16&255]^c[m>>>8&255]^h[g&255]^e[++E],b=f[v>>>24]^l[m>>>16&255]^c[g>>>8&255]^h[d&255]^e[++E],w=f[m>>>24]^l[g>>>16&255]^c[d>>>8&255]^h[v&255]^e[++E],g=f[g>>>24]^l[d>>>16&255]^c[v>>>8&255]^h[m&255]^e[++E],d=y,v=b,m=w;n[0]=p[d>>>24]<<24^p[v>>>16&255]<<16^p[m>>>8&255]<<8^p[g&255]^e[++E],n[s?3:1]=p[v>>>24]<<24^p[m>>>16&255]<<16^p[g>>>8&255]<<8^p[d&255]^e[++E],n[2]=p[m>>>24]<<24^p[g>>>16&255]<<16^p[d>>>8&255]<<8^p[v&255]^e[++E],n[s?1:3]=p[g>>>24]<<24^p[d>>>16&255]<<16^p[v>>>8&255]<<8^p[m&255]^e[++E]},c=function(r,i,s,o,u){function C(){if(o)for(var e=0;e<n;++e)E[e]=b.getInt32();else for(var e=0;e<n;++e)E[e]=x[e]^b.getInt32();l(g,E,S,o);if(o){for(var e=0;e<n;++e)w.putInt32(x[e]^S[e]);x=E.slice(0)}else{for(var e=0;e<n;++e)w.putInt32(S[e]);x=S}}function k(){l(g,E,S,!1);for(var e=0;e<n;++e)E[e]=b.getInt32();for(var e=0;e<n;++e){var t=E[e]^S[e];o||(E[e]=t),w.putInt32(t)}}function L(){l(g,E,S,!1);for(var e=0;e<n;++e)E[e]=b.getInt32();for(var e=0;e<n;++e)w.putInt32(E[e]^S[e]),E[e]=S[e]}function A(){l(g,E,S,!1);for(var e=n-1;e>=0;--e){if(E[e]!==4294967295){++E[e];break}E[e]=0}for(var e=0;e<n;++e)w.putInt32(b.getInt32()^S[e])}var c=null;t||a(),u=(u||"CBC").toUpperCase();if(typeof r!="string"||r.length!==16&&r.length!==24&&r.length!==32){if(e.util.isArray(r)&&(r.length===16||r.length===24||r.length===32)){var h=r,r=e.util.createBuffer();for(var p=0;p<h.length;++p)r.putByte(h[p])}}else r=e.util.createBuffer(r);if(!e.util.isArray(r)){var h=r;r=[];var d=h.length();if(d===16||d===24||d===32){d>>>=2;for(var p=0;p<d;++p)r.push(h.getInt32())}}if(!e.util.isArray(r)||r.length!==4&&r.length!==6&&r.length!==8)return c;var v=["CFB","OFB","CTR"].indexOf(u)!==-1,m=u==="CBC",g=f(r,o&&!v),y=n<<2,b,w,E,S,x,T,N;c={output:null};if(u==="CBC")N=C;else if(u==="CFB")N=k;else if(u==="OFB")N=L;else{if(u!=="CTR")throw{message:'Unsupported block cipher mode of operation: "'+u+'"'};N=A}return c.update=function(e){T||b.putBuffer(e);while(b.length()>=y||b.length()>0&&T)N()},c.finish=function(e){var t=!0,r=b.length()%y;if(!o)if(e)t=e(y,b,o);else if(m){var i=b.length()===y?y:y-b.length();b.fillWithByte(i,i)}t&&(T=!0,c.update());if(o){m&&(t=r===0);if(t)if(e)t=e(y,w,o);else if(m){var s=w.length(),u=w.at(s-1);u>n<<2?t=!1:w.truncate(u)}}return!m&&!e&&r>0&&w.truncate(y-r),t},c.start=function(t,r){t===null&&(t=x.slice(0));if(typeof t=="string"&&t.length===16)t=e.util.createBuffer(t);else if(e.util.isArray(t)&&t.length===16){var i=t,t=e.util.createBuffer();for(var s=0;s<16;++s)t.putByte(i[s])}if(!e.util.isArray(t)){var i=t;t=new Array(4),t[0]=i.getInt32(),t[1]=i.getInt32(),t[2]=i.getInt32(),t[3]=i.getInt32()}b=e.util.createBuffer(),w=r||e.util.createBuffer(),x=t.slice(0),E=new Array(n),S=new Array(n),T=!1,c.output=w;if(["CFB","OFB","CTR"].indexOf(u)!==-1){for(var s=0;s<n;++s)E[s]=x[s];x=null}},i!==null&&c.start(i,s),c};e.aes=e.aes||{},e.aes.startEncrypting=function(e,t,n,r){return c(e,t,n,!1,r)},e.aes.createEncryptionCipher=function(e,t){return c(e,null,null,!1,t)},e.aes.startDecrypting=function(e,t,n,r){return c(e,t,n,!0,r)},e.aes.createDecryptionCipher=function(e,t){return c(e,null,null,!0,t)},e.aes._expandKey=function(e,n){return t||a(),f(e,n)},e.aes._updateBlock=l}var r="aes";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/aes",["require","module","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){e.pki=e.pki||{};var t=e.pki.oids=e.oids=e.oids||{};t["1.2.840.113549.1.1.1"]="rsaEncryption",t.rsaEncryption="1.2.840.113549.1.1.1",t["1.2.840.113549.1.1.4"]="md5WithRSAEncryption",t.md5WithRSAEncryption="1.2.840.113549.1.1.4",t["1.2.840.113549.1.1.5"]="sha1WithRSAEncryption",t.sha1WithRSAEncryption="1.2.840.113549.1.1.5",t["1.2.840.113549.1.1.7"]="RSAES-OAEP",t["RSAES-OAEP"]="1.2.840.113549.1.1.7",t["1.2.840.113549.1.1.8"]="mgf1",t.mgf1="1.2.840.113549.1.1.8",t["1.2.840.113549.1.1.9"]="pSpecified",t.pSpecified="1.2.840.113549.1.1.9",t["1.2.840.113549.1.1.10"]="RSASSA-PSS",t["RSASSA-PSS"]="1.2.840.113549.1.1.10",t["1.2.840.113549.1.1.11"]="sha256WithRSAEncryption",t.sha256WithRSAEncryption="1.2.840.113549.1.1.11",t["1.2.840.113549.1.1.12"]="sha384WithRSAEncryption",t.sha384WithRSAEncryption="1.2.840.113549.1.1.12",t["1.2.840.113549.1.1.13"]="sha512WithRSAEncryption",t.sha512WithRSAEncryption="1.2.840.113549.1.1.13",t["1.3.14.3.2.7"]="desCBC",t.desCBC="1.3.14.3.2.7",t["1.3.14.3.2.26"]="sha1",t.sha1="1.3.14.3.2.26",t["2.16.840.1.101.3.4.2.1"]="sha256",t.sha256="2.16.840.1.101.3.4.2.1",t["2.16.840.1.101.3.4.2.2"]="sha384",t.sha384="2.16.840.1.101.3.4.2.2",t["2.16.840.1.101.3.4.2.3"]="sha512",t.sha512="2.16.840.1.101.3.4.2.3",t["1.2.840.113549.2.5"]="md5",t.md5="1.2.840.113549.2.5",t["1.2.840.113549.1.7.1"]="data",t.data="1.2.840.113549.1.7.1",t["1.2.840.113549.1.7.2"]="signedData",t.signedData="1.2.840.113549.1.7.2",t["1.2.840.113549.1.7.3"]="envelopedData",t.envelopedData="1.2.840.113549.1.7.3",t["1.2.840.113549.1.7.4"]="signedAndEnvelopedData",t.signedAndEnvelopedData="1.2.840.113549.1.7.4",t["1.2.840.113549.1.7.5"]="digestedData",t.digestedData="1.2.840.113549.1.7.5",t["1.2.840.113549.1.7.6"]="encryptedData",t.encryptedData="1.2.840.113549.1.7.6",t["1.2.840.113549.1.9.1"]="emailAddress",t.emailAddress="1.2.840.113549.1.9.1",t["1.2.840.113549.1.9.2"]="unstructuredName",t.unstructuredName="1.2.840.113549.1.9.2",t["1.2.840.113549.1.9.3"]="contentType",t.contentType="1.2.840.113549.1.9.3",t["1.2.840.113549.1.9.4"]="messageDigest",t.messageDigest="1.2.840.113549.1.9.4",t["1.2.840.113549.1.9.5"]="signingTime",t.signingTime="1.2.840.113549.1.9.5",t["1.2.840.113549.1.9.6"]="counterSignature",t.counterSignature="1.2.840.113549.1.9.6",t["1.2.840.113549.1.9.7"]="challengePassword",t.challengePassword="1.2.840.113549.1.9.7",t["1.2.840.113549.1.9.8"]="unstructuredAddress",t.unstructuredAddress="1.2.840.113549.1.9.8",t["1.2.840.113549.1.9.20"]="friendlyName",t.friendlyName="1.2.840.113549.1.9.20",t["1.2.840.113549.1.9.21"]="localKeyId",t.localKeyId="1.2.840.113549.1.9.21",t["1.2.840.113549.1.9.22.1"]="x509Certificate",t.x509Certificate="1.2.840.113549.1.9.22.1",t["1.2.840.113549.1.12.10.1.1"]="keyBag",t.keyBag="1.2.840.113549.1.12.10.1.1",t["1.2.840.113549.1.12.10.1.2"]="pkcs8ShroudedKeyBag",t.pkcs8ShroudedKeyBag="1.2.840.113549.1.12.10.1.2",t["1.2.840.113549.1.12.10.1.3"]="certBag",t.certBag="1.2.840.113549.1.12.10.1.3",t["1.2.840.113549.1.12.10.1.4"]="crlBag",t.crlBag="1.2.840.113549.1.12.10.1.4",t["1.2.840.113549.1.12.10.1.5"]="secretBag",t.secretBag="1.2.840.113549.1.12.10.1.5",t["1.2.840.113549.1.12.10.1.6"]="safeContentsBag",t.safeContentsBag="1.2.840.113549.1.12.10.1.6",t["1.2.840.113549.1.5.13"]="pkcs5PBES2",t.pkcs5PBES2="1.2.840.113549.1.5.13",t["1.2.840.113549.1.5.12"]="pkcs5PBKDF2",t.pkcs5PBKDF2="1.2.840.113549.1.5.12",t["1.2.840.113549.1.12.1.1"]="pbeWithSHAAnd128BitRC4",t.pbeWithSHAAnd128BitRC4="1.2.840.113549.1.12.1.1",t["1.2.840.113549.1.12.1.2"]="pbeWithSHAAnd40BitRC4",t.pbeWithSHAAnd40BitRC4="1.2.840.113549.1.12.1.2",t["1.2.840.113549.1.12.1.3"]="pbeWithSHAAnd3-KeyTripleDES-CBC",t["pbeWithSHAAnd3-KeyTripleDES-CBC"]="1.2.840.113549.1.12.1.3",t["1.2.840.113549.1.12.1.4"]="pbeWithSHAAnd2-KeyTripleDES-CBC",t["pbeWithSHAAnd2-KeyTripleDES-CBC"]="1.2.840.113549.1.12.1.4",t["1.2.840.113549.1.12.1.5"]="pbeWithSHAAnd128BitRC2-CBC",t["pbeWithSHAAnd128BitRC2-CBC"]="1.2.840.113549.1.12.1.5",t["1.2.840.113549.1.12.1.6"]="pbewithSHAAnd40BitRC2-CBC",t["pbewithSHAAnd40BitRC2-CBC"]="1.2.840.113549.1.12.1.6",t["1.2.840.113549.3.7"]="des-EDE3-CBC",t["des-EDE3-CBC"]="1.2.840.113549.3.7",t["2.16.840.1.101.3.4.1.2"]="aes128-CBC",t["aes128-CBC"]="2.16.840.1.101.3.4.1.2",t["2.16.840.1.101.3.4.1.22"]="aes192-CBC",t["aes192-CBC"]="2.16.840.1.101.3.4.1.22",t["2.16.840.1.101.3.4.1.42"]="aes256-CBC",t["aes256-CBC"]="2.16.840.1.101.3.4.1.42",t["2.5.4.3"]="commonName",t.commonName="2.5.4.3",t["2.5.4.5"]="serialName",t.serialName="2.5.4.5",t["2.5.4.6"]="countryName",t.countryName="2.5.4.6",t["2.5.4.7"]="localityName",t.localityName="2.5.4.7",t["2.5.4.8"]="stateOrProvinceName",t.stateOrProvinceName="2.5.4.8",t["2.5.4.10"]="organizationName",t.organizationName="2.5.4.10",t["2.5.4.11"]="organizationalUnitName",t.organizationalUnitName="2.5.4.11",t["2.16.840.1.113730.1.1"]="nsCertType",t.nsCertType="2.16.840.1.113730.1.1",t["2.5.29.1"]="authorityKeyIdentifier",t["2.5.29.2"]="keyAttributes",t["2.5.29.3"]="certificatePolicies",t["2.5.29.4"]="keyUsageRestriction",t["2.5.29.5"]="policyMapping",t["2.5.29.6"]="subtreesConstraint",t["2.5.29.7"]="subjectAltName",t["2.5.29.8"]="issuerAltName",t["2.5.29.9"]="subjectDirectoryAttributes",t["2.5.29.10"]="basicConstraints",t["2.5.29.11"]="nameConstraints",t["2.5.29.12"]="policyConstraints",t["2.5.29.13"]="basicConstraints",t["2.5.29.14"]="subjectKeyIdentifier",t.subjectKeyIdentifier="2.5.29.14",t["2.5.29.15"]="keyUsage",t.keyUsage="2.5.29.15",t["2.5.29.16"]="privateKeyUsagePeriod",t["2.5.29.17"]="subjectAltName",t.subjectAltName="2.5.29.17",t["2.5.29.18"]="issuerAltName",t.issuerAltName="2.5.29.18",t["2.5.29.19"]="basicConstraints",t.basicConstraints="2.5.29.19",t["2.5.29.20"]="cRLNumber",t["2.5.29.21"]="cRLReason",t["2.5.29.22"]="expirationDate",t["2.5.29.23"]="instructionCode",t["2.5.29.24"]="invalidityDate",t["2.5.29.25"]="cRLDistributionPoints",t["2.5.29.26"]="issuingDistributionPoint",t["2.5.29.27"]="deltaCRLIndicator",t["2.5.29.28"]="issuingDistributionPoint",t["2.5.29.29"]="certificateIssuer",t["2.5.29.30"]="nameConstraints",t["2.5.29.31"]="cRLDistributionPoints",t["2.5.29.32"]="certificatePolicies",t["2.5.29.33"]="policyMappings",t["2.5.29.34"]="policyConstraints",t["2.5.29.35"]="authorityKeyIdentifier",t["2.5.29.36"]="policyConstraints",t["2.5.29.37"]="extKeyUsage",t.extKeyUsage="2.5.29.37",t["2.5.29.46"]="freshestCRL",t["2.5.29.54"]="inhibitAnyPolicy",t["1.3.6.1.5.5.7.3.1"]="serverAuth",t.serverAuth="1.3.6.1.5.5.7.3.1",t["1.3.6.1.5.5.7.3.2"]="clientAuth",t.clientAuth="1.3.6.1.5.5.7.3.2",t["1.3.6.1.5.5.7.3.3"]="codeSigning",t.codeSigning="1.3.6.1.5.5.7.3.3",t["1.3.6.1.5.5.7.3.4"]="emailProtection",t.emailProtection="1.3.6.1.5.5.7.3.4",t["1.3.6.1.5.5.7.3.8"]="timeStamping",t.timeStamping="1.3.6.1.5.5.7.3.8"}var r="oids";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/oids",["require","module"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){var t=e.asn1=e.asn1||{};t.Class={UNIVERSAL:0,APPLICATION:64,CONTEXT_SPECIFIC:128,PRIVATE:192},t.Type={NONE:0,BOOLEAN:1,INTEGER:2,BITSTRING:3,OCTETSTRING:4,NULL:5,OID:6,ODESC:7,EXTERNAL:8,REAL:9,ENUMERATED:10,EMBEDDED:11,UTF8:12,ROID:13,SEQUENCE:16,SET:17,PRINTABLESTRING:19,IA5STRING:22,UTCTIME:23,GENERALIZEDTIME:24,BMPSTRING:30},t.create=function(t,n,r,i){if(e.util.isArray(i)){var s=[];for(var o=0;o<i.length;++o)i[o]!==undefined&&s.push(i[o]);i=s}return{tagClass:t,type:n,constructed:r,composed:r||e.util.isArray(i),value:i}};var n=function(e){var t=e.getByte();if(t===128)return undefined;var n,r=t&128;return r?n=e.getInt((t&127)<<3):n=t,n};t.fromDer=function(r,i){i===undefined&&(i=!0),typeof r=="string"&&(r=e.util.createBuffer(r));if(r.length()<2)throw{message:"Too few bytes to parse DER.",bytes:r.length()};var s=r.getByte(),o=s&192,u=s&31,a=n(r);if(r.length()<a){if(i)throw{message:"Too few bytes to read ASN.1 value.",detail:r.length()+" < "+a};a=r.length()}var f,l=(s&32)===32,c=l;if(!c&&o===t.Class.UNIVERSAL&&u===t.Type.BITSTRING&&a>1){var h=r.read,p=r.getByte();if(p===0){s=r.getByte();var d=s&192;if(d===t.Class.UNIVERSAL||d===t.Class.CONTEXT_SPECIFIC)try{var v=n(r);c=v===a-(r.read-h),c&&(++h,--a)}catch(m){}}r.read=h}if(c){f=[];if(a===undefined)for(;;){if(r.bytes(2)===String.fromCharCode(0,0)){r.getBytes(2);break}f.push(t.fromDer(r,i))}else{var g=r.length();while(a>0)f.push(t.fromDer(r,i)),a-=g-r.length(),g=r.length()}}else{if(a===undefined){if(i)throw{message:"Non-constructed ASN.1 object of indefinite length."};a=r.length()}if(u===t.Type.BMPSTRING){f="";for(var y=0;y<a;y+=2)f+=String.fromCharCode(r.getInt16())}else f=r.getBytes(a)}return t.create(o,u,l,f)},t.toDer=function(n){var r=e.util.createBuffer(),i=n.tagClass|n.type,s=e.util.createBuffer();if(n.composed){n.constructed?i|=32:s.putByte(0);for(var o=0;o<n.value.length;++o)n.value[o]!==undefined&&s.putBuffer(t.toDer(n.value[o]))}else if(n.type===t.Type.BMPSTRING)for(var o=0;o<n.value.length;++o)s.putInt16(n.value.charCodeAt(o));else s.putBytes(n.value);r.putByte(i);if(s.length()<=127)r.putByte(s.length()&127);else{var u=s.length(),a="";do a+=String.fromCharCode(u&255),u>>>=8;while(u>0);r.putByte(a.length|128);for(var o=a.length-1;o>=0;--o)r.putByte(a.charCodeAt(o))}return r.putBuffer(s),r},t.oidToDer=function(t){var n=t.split("."),r=e.util.createBuffer();r.putByte(40*parseInt(n[0],10)+parseInt(n[1],10));var i,s,o,u;for(var a=2;a<n.length;++a){i=!0,s=[],o=parseInt(n[a],10);do u=o&127,o>>>=7,i||(u|=128),s.push(u),i=!1;while(o>0);for(var f=s.length-1;f>=0;--f)r.putByte(s[f])}return r},t.derToOid=function(t){var n;typeof t=="string"&&(t=e.util.createBuffer(t));var r=t.getByte();n=Math.floor(r/40)+"."+r%40;var i=0;while(t.length()>0)r=t.getByte(),i<<=7,r&128?i+=r&127:(n+="."+(i+r),i=0);return n},t.utcTimeToDate=function(e){var t=new Date,n=parseInt(e.substr(0,2),10);n=n>=50?1900+n:2e3+n;var r=parseInt(e.substr(2,2),10)-1,i=parseInt(e.substr(4,2),10),s=parseInt(e.substr(6,2),10),o=parseInt(e.substr(8,2),10),u=0;if(e.length>11){var a=e.charAt(10),f=10;a!=="+"&&a!=="-"&&(u=parseInt(e.substr(10,2),10),f+=2)}t.setUTCFullYear(n,r,i),t.setUTCHours(s,o,u,0);if(f){a=e.charAt(f);if(a==="+"||a==="-"){var l=parseInt(e.substr(f+1,2),10),c=parseInt(e.substr(f+4,2),10),h=l*60+c;h*=6e4,a==="+"?t.setTime(+t-h):t.setTime(+t+h)}}return t},t.generalizedTimeToDate=function(e){var t=new Date,n=parseInt(e.substr(0,4),10),r=parseInt(e.substr(4,2),10)-1,i=parseInt(e.substr(6,2),10),s=parseInt(e.substr(8,2),10),o=parseInt(e.substr(10,2),10),u=parseInt(e.substr(12,2),10),a=0,f=0,l=!1;e.charAt(e.length-1)==="Z"&&(l=!0);var c=e.length-5,h=e.charAt(c);if(h==="+"||h==="-"){var p=parseInt(e.substr(c+1,2),10),d=parseInt(e.substr(c+4,2),10);f=p*60+d,f*=6e4,h==="+"&&(f*=-1),l=!0}return e.charAt(14)==="."&&(a=parseFloat(e.substr(14),10)*1e3),l?(t.setUTCFullYear(n,r,i),t.setUTCHours(s,o,u,a),t.setTime(+t+f)):(t.setFullYear(n,r,i),t.setHours(s,o,u,a)),t},t.dateToUtcTime=function(e){var t="",n=[];n.push((""+e.getUTCFullYear()).substr(2)),n.push(""+(e.getUTCMonth()+1)),n.push(""+e.getUTCDate()),n.push(""+e.getUTCHours()),n.push(""+e.getUTCMinutes()),n.push(""+e.getUTCSeconds());for(var r=0;r<n.length;++r)n[r].length<2&&(t+="0"),t+=n[r];return t+="Z",t},t.integerToDer=function(t){var n=e.util.createBuffer();if(t>=-128&&t<128)return n.putSignedInt(t,8);if(t>=-32768&&t<32768)return n.putSignedInt(t,16);if(t>=-8388608&&t<8388608)return n.putSignedInt(t,24);if(t>=-2147483648&&t<2147483648)return n.putSignedInt(t,32);throw{message:"Integer too large; max is 32-bits.",integer:t}},t.derToInteger=function(t){typeof t=="string"&&(t=e.util.createBuffer(t));var n=t.length()*8;if(n>32)throw{message:"Integer too large; max is 32-bits."};return t.getSignedInt(n)},t.validate=function(n,r,i,s){var o=!1;if(n.tagClass!==r.tagClass&&typeof r.tagClass!="undefined"||n.type!==r.type&&typeof r.type!="undefined")s&&(n.tagClass!==r.tagClass&&s.push("["+r.name+"] "+'Expected tag class "'+r.tagClass+'", got "'+n.tagClass+'"'),n.type!==r.type&&s.push("["+r.name+"] "+'Expected type "'+r.type+'", got "'+n.type+'"'));else if(n.constructed===r.constructed||typeof r.constructed=="undefined"){o=!0;if(r.value&&e.util.isArray(r.value)){var u=0;for(var a=0;o&&a<r.value.length;++a)o=r.value[a].optional||!1,n.value[u]&&(o=t.validate(n.value[u],r.value[a],i,s),o?++u:r.value[a].optional&&(o=!0)),!o&&s&&s.push("["+r.name+"] "+'Tag class "'+r.tagClass+'", type "'+r.type+'" expected value length "'+r.value.length+'", got "'+n.value.length+'"')}o&&i&&(r.capture&&(i[r.capture]=n.value),r.captureAsn1&&(i[r.captureAsn1]=n))}else s&&s.push("["+r.name+"] "+'Expected constructed "'+r.constructed+'", got "'+n.constructed+'"');return o};var r=/[^\\u0000-\\u00ff]/;t.prettyPrint=function(n,i,s){var o="";i=i||0,s=s||2,i>0&&(o+="\n");var u="";for(var a=0;a<i*s;++a)u+=" ";o+=u+"Tag: ";switch(n.tagClass){case t.Class.UNIVERSAL:o+="Universal:";break;case t.Class.APPLICATION:o+="Application:";break;case t.Class.CONTEXT_SPECIFIC:o+="Context-Specific:";break;case t.Class.PRIVATE:o+="Private:"}if(n.tagClass===t.Class.UNIVERSAL){o+=n.type;switch(n.type){case t.Type.NONE:o+=" (None)";break;case t.Type.BOOLEAN:o+=" (Boolean)";break;case t.Type.BITSTRING:o+=" (Bit string)";break;case t.Type.INTEGER:o+=" (Integer)";break;case t.Type.OCTETSTRING:o+=" (Octet string)";break;case t.Type.NULL:o+=" (Null)";break;case t.Type.OID:o+=" (Object Identifier)";break;case t.Type.ODESC:o+=" (Object Descriptor)";break;case t.Type.EXTERNAL:o+=" (External or Instance of)";break;case t.Type.REAL:o+=" (Real)";break;case t.Type.ENUMERATED:o+=" (Enumerated)";break;case t.Type.EMBEDDED:o+=" (Embedded PDV)";break;case t.Type.UTF8:o+=" (UTF8)";break;case t.Type.ROID:o+=" (Relative Object Identifier)";break;case t.Type.SEQUENCE:o+=" (Sequence)";break;case t.Type.SET:o+=" (Set)";break;case t.Type.PRINTABLESTRING:o+=" (Printable String)";break;case t.Type.IA5String:o+=" (IA5String (ASCII))";break;case t.Type.UTCTIME:o+=" (UTC time)";break;case t.Type.GENERALIZEDTIME:o+=" (Generalized time)";break;case t.Type.BMPSTRING:o+=" (BMP String)"}}else o+=n.type;o+="\n",o+=u+"Constructed: "+n.constructed+"\n";if(n.composed){var f=0,l="";for(var a=0;a<n.value.length;++a)n.value[a]!==undefined&&(f+=1,l+=t.prettyPrint(n.value[a],i+1,s),a+1<n.value.length&&(l+=","));o+=u+"Sub values: "+f+l}else{o+=u+"Value: ";if(n.type===t.Type.OID){var c=t.derToOid(n.value);o+=c,e.pki&&e.pki.oids&&c in e.pki.oids&&(o+=" ("+e.pki.oids[c]+")")}if(n.type===t.Type.INTEGER)try{o+=t.derToInteger(n.value)}catch(h){o+="0x"+e.util.bytesToHex(n.value)}else r.test(n.value)?o+="0x"+e.util.createBuffer(n.value,"utf8").toHex():n.value.length===0?o+="[null]":o+=n.value}return o}}var r="asn1";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/asn1",["require","module","./util","./oids"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){var t=e.md5=e.md5||{};e.md=e.md||{},e.md.algorithms=e.md.algorithms||{},e.md.md5=e.md.algorithms.md5=t;var n=null,r=null,i=null,s=null,o=!1,u=function(){n=String.fromCharCode(128),n+=e.util.fillString(String.fromCharCode(0),64),r=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,1,6,11,0,5,10,15,4,9,14,3,8,13,2,7,12,5,8,11,14,1,4,7,10,13,0,3,6,9,12,15,2,0,7,14,5,12,3,10,1,8,15,6,13,4,11,2,9],i=[7,12,17,22,7,12,17,22,7,12,17,22,7,12,17,22,5,9,14,20,5,9,14,20,5,9,14,20,5,9,14,20,4,11,16,23,4,11,16,23,4,11,16,23,4,11,16,23,6,10,15,21,6,10,15,21,6,10,15,21,6,10,15,21],s=new Array(64);for(var t=0;t<64;++t)s[t]=Math.floor(Math.abs(Math.sin(t+1))*4294967296);o=!0},a=function(e,t,n){var o,u,a,f,l,c,h,p,d=n.length();while(d>=64){u=e.h0,a=e.h1,f=e.h2,l=e.h3;for(p=0;p<16;++p)t[p]=n.getInt32Le(),c=l^a&(f^l),o=u+c+s[p]+t[p],h=i[p],u=l,l=f,f=a,a+=o<<h|o>>>32-h;for(;p<32;++p)c=f^l&(a^f),o=u+c+s[p]+t[r[p]],h=i[p],u=l,l=f,f=a,a+=o<<h|o>>>32-h;for(;p<48;++p)c=a^f^l,o=u+c+s[p]+t[r[p]],h=i[p],u=l,l=f,f=a,a+=o<<h|o>>>32-h;for(;p<64;++p)c=f^(a|~l),o=u+c+s[p]+t[r[p]],h=i[p],u=l,l=f,f=a,a+=o<<h|o>>>32-h;e.h0=e.h0+u&4294967295,e.h1=e.h1+a&4294967295,e.h2=e.h2+f&4294967295,e.h3=e.h3+l&4294967295,d-=64}};t.create=function(){o||u();var t=null,r=e.util.createBuffer(),i=new Array(16),s={algorithm:"md5",blockLength:64,digestLength:16,messageLength:0};return s.start=function(){return s.messageLength=0,r=e.util.createBuffer(),t={h0:1732584193,h1:4023233417,h2:2562383102,h3:271733878},s},s.start(),s.update=function(n,o){return o==="utf8"&&(n=e.util.encodeUtf8(n)),s.messageLength+=n.length,r.putBytes(n),a(t,i,r),(r.read>2048||r.length()===0)&&r.compact(),s},s.digest=function(){var o=s.messageLength,u=e.util.createBuffer();u.putBytes(r.bytes()),u.putBytes(n.substr(0,64-(o+8)%64)),u.putInt32Le(o<<3&4294967295),u.putInt32Le(o>>>29&255);var f={h0:t.h0,h1:t.h1,h2:t.h2,h3:t.h3};a(f,i,u);var l=e.util.createBuffer();return l.putInt32Le(f.h0),l.putInt32Le(f.h1),l.putInt32Le(f.h2),l.putInt32Le(f.h3),l},s}}var r="md5";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/md5",["require","module","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){var t=e.sha1=e.sha1||{};e.md=e.md||{},e.md.algorithms=e.md.algorithms||{},e.md.sha1=e.md.algorithms.sha1=t;var n=null,r=!1,i=function(){n=String.fromCharCode(128),n+=e.util.fillString(String.fromCharCode(0),64),r=!0},s=function(e,t,n){var r,i,s,o,u,a,f,l,c=n.length();while(c>=64){i=e.h0,s=e.h1,o=e.h2,u=e.h3,a=e.h4;for(l=0;l<16;++l)r=n.getInt32(),t[l]=r,f=u^s&(o^u),r=(i<<5|i>>>27)+f+a+1518500249+r,a=u,u=o,o=s<<30|s>>>2,s=i,i=r;for(;l<20;++l)r=t[l-3]^t[l-8]^t[l-14]^t[l-16],r=r<<1|r>>>31,t[l]=r,f=u^s&(o^u),r=(i<<5|i>>>27)+f+a+1518500249+r,a=u,u=o,o=s<<30|s>>>2,s=i,i=r;for(;l<32;++l)r=t[l-3]^t[l-8]^t[l-14]^t[l-16],r=r<<1|r>>>31,t[l]=r,f=s^o^u,r=(i<<5|i>>>27)+f+a+1859775393+r,a=u,u=o,o=s<<30|s>>>2,s=i,i=r;for(;l<40;++l)r=t[l-6]^t[l-16]^t[l-28]^t[l-32],r=r<<2|r>>>30,t[l]=r,f=s^o^u,r=(i<<5|i>>>27)+f+a+1859775393+r,a=u,u=o,o=s<<30|s>>>2,s=i,i=r;for(;l<60;++l)r=t[l-6]^t[l-16]^t[l-28]^t[l-32],r=r<<2|r>>>30,t[l]=r,f=s&o|u&(s^o),r=(i<<5|i>>>27)+f+a+2400959708+r,a=u,u=o,o=s<<30|s>>>2,s=i,i=r;for(;l<80;++l)r=t[l-6]^t[l-16]^t[l-28]^t[l-32],r=r<<2|r>>>30,t[l]=r,f=s^o^u,r=(i<<5|i>>>27)+f+a+3395469782+r,a=u,u=o,o=s<<30|s>>>2,s=i,i=r;e.h0+=i,e.h1+=s,e.h2+=o,e.h3+=u,e.h4+=a,c-=64}};t.create=function(){r||i();var t=null,o=e.util.createBuffer(),u=new Array(80),a={algorithm:"sha1",blockLength:64,digestLength:20,messageLength:0};return a.start=function(){return a.messageLength=0,o=e.util.createBuffer(),t={h0:1732584193,h1:4023233417,h2:2562383102,h3:271733878,h4:3285377520},a},a.start(),a.update=function(n,r){return r==="utf8"&&(n=e.util.encodeUtf8(n)),a.messageLength+=n.length,o.putBytes(n),s(t,u,o),(o.read>2048||o.length()===0)&&o.compact(),a},a.digest=function(){var r=a.messageLength,i=e.util.createBuffer();i.putBytes(o.bytes()),i.putBytes(n.substr(0,64-(r+8)%64)),i.putInt32(r>>>29&255),i.putInt32(r<<3&4294967295);var f={h0:t.h0,h1:t.h1,h2:t.h2,h3:t.h3,h4:t.h4};s(f,u,i);var l=e.util.createBuffer();return l.putInt32(f.h0),l.putInt32(f.h1),l.putInt32(f.h2),l.putInt32(f.h3),l.putInt32(f.h4),l},a}}var r="sha1";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/sha1",["require","module","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){var t=e.sha256=e.sha256||{};e.md=e.md||{},e.md.algorithms=e.md.algorithms||{},e.md.sha256=e.md.algorithms.sha256=t;var n=null,r=!1,i=null,s=function(){n=String.fromCharCode(128),n+=e.util.fillString(String.fromCharCode(0),64),i=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],r=!0},o=function(e,t,n){var r,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b=n.length();while(b>=64){for(l=0;l<16;++l)t[l]=n.getInt32();for(;l<64;++l)r=t[l-2],r=(r>>>17|r<<15)^(r>>>19|r<<13)^r>>>10,s=t[l-15],s=(s>>>7|s<<25)^(s>>>18|s<<14)^s>>>3,t[l]=r+t[l-7]+s+t[l-16]&4294967295;c=e.h0,h=e.h1,p=e.h2,d=e.h3,v=e.h4,m=e.h5,g=e.h6,y=e.h7;for(l=0;l<64;++l)u=(v>>>6|v<<26)^(v>>>11|v<<21)^(v>>>25|v<<7),a=g^v&(m^g),o=(c>>>2|c<<30)^(c>>>13|c<<19)^(c>>>22|c<<10),f=c&h|p&(c^h),r=y+u+a+i[l]+t[l],s=o+f,y=g,g=m,m=v,v=d+r&4294967295,d=p,p=h,h=c,c=r+s&4294967295;e.h0=e.h0+c&4294967295,e.h1=e.h1+h&4294967295,e.h2=e.h2+p&4294967295,e.h3=e.h3+d&4294967295,e.h4=e.h4+v&4294967295,e.h5=e.h5+m&4294967295,e.h6=e.h6+g&4294967295,e.h7=e.h7+y&4294967295,b-=64}};t.create=function(){r||s();var t=null,i=e.util.createBuffer(),u=new Array(64),a={algorithm:"sha256",blockLength:64,digestLength:32,messageLength:0};return a.start=function(){return a.messageLength=0,i=e.util.createBuffer(),t={h0:1779033703,h1:3144134277,h2:1013904242,h3:2773480762,h4:1359893119,h5:2600822924,h6:528734635,h7:1541459225},a},a.start(),a.update=function(n,r){return r==="utf8"&&(n=e.util.encodeUtf8(n)),a.messageLength+=n.length,i.putBytes(n),o(t,u,i),(i.read>2048||i.length()===0)&&i.compact(),a},a.digest=function(){var r=a.messageLength,s=e.util.createBuffer();s.putBytes(i.bytes()),s.putBytes(n.substr(0,64-(r+8)%64)),s.putInt32(r>>>29&255),s.putInt32(r<<3&4294967295);var f={h0:t.h0,h1:t.h1,h2:t.h2,h3:t.h3,h4:t.h4,h5:t.h5,h6:t.h6,h7:t.h7};o(f,u,s);var l=e.util.createBuffer();return l.putInt32(f.h0),l.putInt32(f.h1),l.putInt32(f.h2),l.putInt32(f.h3),l.putInt32(f.h4),l.putInt32(f.h5),l.putInt32(f.h6),l.putInt32(f.h7),l},a}}var r="sha256";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/sha256",["require","module","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){e.md=e.md||{},e.md.algorithms={md5:e.md5,sha1:e.sha1,sha256:e.sha256},e.md.md5=e.md5,e.md.sha1=e.sha1,e.md.sha256=e.sha256}var r="md";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/md",["require","module","./md5","./sha1","./sha256"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){var t=e.hmac=e.hmac||{};t.create=function(){var t=null,n=null,r=null,i=null,s={};return s.start=function(s,o){if(s!==null)if(typeof s=="string"){s=s.toLowerCase();if(!(s in e.md.algorithms))throw'Unknown hash algorithm "'+s+'"';n=e.md.algorithms[s].create()}else n=s;if(o===null)o=t;else{if(typeof o=="string")o=e.util.createBuffer(o);else if(e.util.isArray(o)){var u=o;o=e.util.createBuffer();for(var a=0;a<u.length;++a)o.putByte(u[a])}var f=o.length();f>n.blockLength&&(n.start(),n.update(o.bytes()),o=n.digest()),r=e.util.createBuffer(),i=e.util.createBuffer(),f=o.length();for(var a=0;a<f;++a){var u=o.at(a);r.putByte(54^u),i.putByte(92^u)}if(f<n.blockLength){var u=n.blockLength-f;for(var a=0;a<u;++a)r.putByte(54),i.putByte(92)}t=o,r=r.bytes(),i=i.bytes()}n.start(),n.update(r)},s.update=function(e){n.update(e)},s.getMac=function(){var e=n.digest().bytes();return n.start(),n.update(i),n.update(e),n.digest()},s.digest=s.getMac,s}}var r="hmac";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/hmac",["require","module","./md","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){function n(e){var t=e.name+": ",n=[];for(var r=0;r<e.values.length;++r)n.push(e.values[r].replace(/^(\S+\r\n)/,function(e,t){return" "+t}));t+=n.join(",")+"\r\n";var i=0,s=-1;for(var r=0;r<t.length;++r,++i)if(i>65&&s!==-1){var o=t[s];o===","?(++s,t=t.substr(0,s)+"\r\n "+t.substr(s)):t=t.substr(0,s)+"\r\n"+o+t.substr(s+1),i=r-s-1,s=-1,++r}else if(t[r]===" "||t[r]==="	"||t[r]===",")s=r;return t}function r(e){return e.replace(/^\s+/,"")}var t=e.pem=e.pem||{};t.encode=function(t,r){r=r||{};var i="-----BEGIN "+t.type+"-----\r\n",s;t.procType&&(s={name:"Proc-Type",values:[String(t.procType.version),t.procType.type]},i+=n(s)),t.contentDomain&&(s={name:"Content-Domain",values:[t.contentDomain]},i+=n(s)),t.dekInfo&&(s={name:"DEK-Info",values:[t.dekInfo.algorithm]},t.dekInfo.parameters&&s.values.push(t.dekInfo.parameters),i+=n(s));if(t.headers)for(var o=0;o<t.headers.length;++o)i+=n(t.headers[o]);return t.procType&&(i+="\r\n"),i+=e.util.encode64(t.body,r.maxline||64)+"\r\n",i+="-----END "+t.type+"-----\r\n",i},t.decode=function(t){var n=[],i=/\s*-----BEGIN ([A-Z0-9- ]+)-----\r?\n?([\x21-\x7e\s]+?(?:\r?\n\r?\n))?([:A-Za-z0-9+\/=\s]+?)-----END \1-----/g,s=/([\x21-\x7e]+):\s*([\x21-\x7e\s^:]+)/,o=/\r?\n/,u;for(;;){u=i.exec(t);if(!u)break;var a={type:u[1],procType:null,contentDomain:null,dekInfo:null,headers:[],body:e.util.decode64(u[3])};n.push(a);if(!u[2])continue;var f=u[2].split(o),l=0;while(u&&l<f.length){var c=f[l].replace(/\s+$/,"");for(var h=l+1;h<f.length;++h){var p=f[h];if(!/\s/.test(p[0]))break;c+=p,l=h}u=c.match(s);if(u){var d={name:u[1],values:[]},v=u[2].split(",");for(var m=0;m<v.length;++m)d.values.push(r(v[m]));if(!a.procType){if(d.name!=="Proc-Type")throw{message:'Invalid PEM formatted message. The first encapsulated header must be "Proc-Type".'};if(d.values.length!==2)throw{message:'Invalid PEM formatted message. The "Proc-Type" header must have two subfields.'};a.procType={version:v[0],type:v[1]}}else if(!a.contentDomain&&d.name==="Content-Domain")a.contentDomain=v[0]||"";else if(!a.dekInfo&&d.name==="DEK-Info"){if(d.values.length===0)throw{message:'Invalid PEM formatted message. The "DEK-Info" header must have at least one subfield.'};a.dekInfo={algorithm:v[0],parameters:v[1]||null}}else a.headers.push(d)}++l}if(a.procType==="ENCRYPTED"&&!a.dekInfo)throw{message:'Invalid PEM formatted message. The "DEK-Info" header must be present if "Proc-Type" is "ENCRYPTED".'}}if(n.length===0)throw{message:"Invalid PEM formatted message."};return n}}var r="pem";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/pem",["require","module","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){function f(e){var t=[0,4,536870912,536870916,65536,65540,536936448,536936452,512,516,536871424,536871428,66048,66052,536936960,536936964],n=[0,1,1048576,1048577,67108864,67108865,68157440,68157441,256,257,1048832,1048833,67109120,67109121,68157696,68157697],r=[0,8,2048,2056,16777216,16777224,16779264,16779272,0,8,2048,2056,16777216,16777224,16779264,16779272],i=[0,2097152,134217728,136314880,8192,2105344,134225920,136323072,131072,2228224,134348800,136445952,139264,2236416,134356992,136454144],s=[0,262144,16,262160,0,262144,16,262160,4096,266240,4112,266256,4096,266240,4112,266256],o=[0,1024,32,1056,0,1024,32,1056,33554432,33555456,33554464,33555488,33554432,33555456,33554464,33555488],u=[0,268435456,524288,268959744,2,268435458,524290,268959746,0,268435456,524288,268959744,2,268435458,524290,268959746],a=[0,65536,2048,67584,536870912,536936448,536872960,536938496,131072,196608,133120,198656,537001984,537067520,537004032,537069568],f=[0,262144,0,262144,2,262146,2,262146,33554432,33816576,33554432,33816576,33554434,33816578,33554434,33816578],l=[0,268435456,8,268435464,0,268435456,8,268435464,1024,268436480,1032,268436488,1024,268436480,1032,268436488],c=[0,32,0,32,1048576,1048608,1048576,1048608,8192,8224,8192,8224,1056768,1056800,1056768,1056800],h=[0,16777216,512,16777728,2097152,18874368,2097664,18874880,67108864,83886080,67109376,83886592,69206016,85983232,69206528,85983744],p=[0,4096,134217728,134221824,524288,528384,134742016,134746112,16,4112,134217744,134221840,524304,528400,134742032,134746128],d=[0,4,256,260,0,4,256,260,1,5,257,261,1,5,257,261],v=e.length()>8?3:1,m=[],g=[0,0,1,1,1,1,1,1,0,1,1,1,1,1,1,0],y=0,b;for(var w=0;w<v;w++){var E=e.getInt32(),S=e.getInt32();b=(E>>>4^S)&252645135,S^=b,E^=b<<4,b=(S>>>-16^E)&65535,E^=b,S^=b<<-16,b=(E>>>2^S)&858993459,S^=b,E^=b<<2,b=(S>>>-16^E)&65535,E^=b,S^=b<<-16,b=(E>>>1^S)&1431655765,S^=b,E^=b<<1,b=(S>>>8^E)&16711935,E^=b,S^=b<<8,b=(E>>>1^S)&1431655765,S^=b,E^=b<<1,b=E<<8|S>>>20&240,E=S<<24|S<<8&16711680|S>>>8&65280|S>>>24&240,S=b;for(var x=0;x<g.length;x++){g[x]?(E=E<<2|E>>>26,S=S<<2|S>>>26):(E=E<<1|E>>>27,S=S<<1|S>>>27),E&=-15,S&=-15;var T=t[E>>>28]|n[E>>>24&15]|r[E>>>20&15]|i[E>>>16&15]|s[E>>>12&15]|o[E>>>8&15]|u[E>>>4&15],N=a[S>>>28]|f[S>>>24&15]|l[S>>>20&15]|c[S>>>16&15]|h[S>>>12&15]|p[S>>>8&15]|d[S>>>4&15];b=(N>>>16^T)&65535,m[y++]=T^b,m[y++]=N^b<<16}}return m}var t=[16843776,0,65536,16843780,16842756,66564,4,65536,1024,16843776,16843780,1024,16778244,16842756,16777216,4,1028,16778240,16778240,66560,66560,16842752,16842752,16778244,65540,16777220,16777220,65540,0,1028,66564,16777216,65536,16843780,4,16842752,16843776,16777216,16777216,1024,16842756,65536,66560,16777220,1024,4,16778244,66564,16843780,65540,16842752,16778244,16777220,1028,66564,16843776,1028,16778240,16778240,0,65540,66560,0,16842756],n=[-2146402272,-2147450880,32768,1081376,1048576,32,-2146435040,-2147450848,-2147483616,-2146402272,-2146402304,-2147483648,-2147450880,1048576,32,-2146435040,1081344,1048608,-2147450848,0,-2147483648,32768,1081376,-2146435072,1048608,-2147483616,0,1081344,32800,-2146402304,-2146435072,32800,0,1081376,-2146435040,1048576,-2147450848,-2146435072,-2146402304,32768,-2146435072,-2147450880,32,-2146402272,1081376,32,32768,-2147483648,32800,-2146402304,1048576,-2147483616,1048608,-2147450848,-2147483616,1048608,1081344,0,-2147450880,32800,-2147483648,-2146435040,-2146402272,1081344],r=[520,134349312,0,134348808,134218240,0,131592,134218240,131080,134217736,134217736,131072,134349320,131080,134348800,520,134217728,8,134349312,512,131584,134348800,134348808,131592,134218248,131584,131072,134218248,8,134349320,512,134217728,134349312,134217728,131080,520,131072,134349312,134218240,0,512,131080,134349320,134218240,134217736,512,0,134348808,134218248,131072,134217728,134349320,8,131592,131584,134217736,134348800,134218248,520,134348800,131592,8,134348808,131584],i=[8396801,8321,8321,128,8396928,8388737,8388609,8193,0,8396800,8396800,8396929,129,0,8388736,8388609,1,8192,8388608,8396801,128,8388608,8193,8320,8388737,1,8320,8388736,8192,8396928,8396929,129,8388736,8388609,8396800,8396929,129,0,0,8396800,8320,8388736,8388737,1,8396801,8321,8321,128,8396929,129,1,8192,8388609,8193,8396928,8388737,8193,8320,8388608,8396801,128,8388608,8192,8396928],s=[256,34078976,34078720,1107296512,524288,256,1073741824,34078720,1074266368,524288,33554688,1074266368,1107296512,1107820544,524544,1073741824,33554432,1074266112,1074266112,0,1073742080,1107820800,1107820800,33554688,1107820544,1073742080,0,1107296256,34078976,33554432,1107296256,524544,524288,1107296512,256,33554432,1073741824,34078720,1107296512,1074266368,33554688,1073741824,1107820544,34078976,1074266368,256,33554432,1107820544,1107820800,524544,1107296256,1107820800,34078720,0,1074266112,1107296256,524544,33554688,1073742080,524288,0,1074266112,34078976,1073742080],o=[536870928,541065216,16384,541081616,541065216,16,541081616,4194304,536887296,4210704,4194304,536870928,4194320,536887296,536870912,16400,0,4194320,536887312,16384,4210688,536887312,16,541065232,541065232,0,4210704,541081600,16400,4210688,541081600,536870912,536887296,16,541065232,4210688,541081616,4194304,16400,536870928,4194304,536887296,536870912,16400,536870928,541081616,4210688,541065216,4210704,541081600,0,541065232,16,16384,541065216,4210704,16384,4194320,536887312,0,541081600,536870912,4194320,536887312],u=[2097152,69206018,67110914,0,2048,67110914,2099202,69208064,69208066,2097152,0,67108866,2,67108864,69206018,2050,67110912,2099202,2097154,67110912,67108866,69206016,69208064,2097154,69206016,2048,2050,69208066,2099200,2,67108864,2099200,67108864,2099200,2097152,67110914,67110914,69206018,69206018,2,2097154,67108864,67110912,2097152,69208064,2050,2099202,69208064,2050,67108866,69208066,69206016,2099200,0,2,69208066,0,2099202,69206016,2048,67108866,67110912,2048,2097154],a=[268439616,4096,262144,268701760,268435456,268439616,64,268435456,262208,268697600,268701760,266240,268701696,266304,4096,64,268697600,268435520,268439552,4160,266240,262208,268697664,268701696,4160,0,0,268697664,268435520,268439552,266304,262144,266304,262144,268701696,4096,64,268697664,4096,266304,268439552,64,268435520,268697600,268697664,268435456,262144,268439616,0,268701760,262208,268435520,268697600,268439552,268439616,0,268701760,266240,266240,4160,4160,262208,268435456,268701696],l=function(l,c){typeof l=="string"&&(l.length===8||l.length===24)&&(l=e.util.createBuffer(l));var h=f(l),p=1,d=0,v=0,m=0,g=0,y=!1,b=null,w=null,E=h.length===32?3:9,S;E===3?S=c?[0,32,2]:[30,-2,-2]:S=c?[0,32,2,62,30,-2,64,96,2]:[94,62,-2,32,64,2,30,-2,-2];var x=null;return x={start:function(t,n){t?(typeof t=="string"&&t.length===8&&(t=e.util.createBuffer(t)),p=1,d=t.getInt32(),m=t.getInt32()):p=0,y=!1,b=e.util.createBuffer(),w=n||e.util.createBuffer(),x.output=w},update:function(e){y||b.putBuffer(e);while(b.length()>=8){var f,l=b.getInt32(),x=b.getInt32();p===1&&(c?(l^=d,x^=m):(v=d,g=m,d=l,m=x)),f=(l>>>4^x)&252645135,x^=f,l^=f<<4,f=(l>>>16^x)&65535,x^=f,l^=f<<16,f=(x>>>2^l)&858993459,l^=f,x^=f<<2,f=(x>>>8^l)&16711935,l^=f,x^=f<<8,f=(l>>>1^x)&1431655765,x^=f,l^=f<<1,l=l<<1|l>>>31,x=x<<1|x>>>31;for(var T=0;T<E;T+=3){var N=S[T+1],C=S[T+2];for(var k=S[T];k!=N;k+=C){var L=x^h[k],A=(x>>>4|x<<28)^h[k+1];f=l,l=x,x=f^(n[L>>>24&63]|i[L>>>16&63]|o[L>>>8&63]|a[L&63]|t[A>>>24&63]|r[A>>>16&63]|s[A>>>8&63]|u[A&63])}f=l,l=x,x=f}l=l>>>1|l<<31,x=x>>>1|x<<31,f=(l>>>1^x)&1431655765,x^=f,l^=f<<1,f=(x>>>8^l)&16711935,l^=f,x^=f<<8,f=(x>>>2^l)&858993459,l^=f,x^=f<<2,f=(l>>>16^x)&65535,x^=f,l^=f<<16,f=(l>>>4^x)&252645135,x^=f,l^=f<<4,p===1&&(c?(d=l,m=x):(l^=v,x^=g)),w.putInt32(l),w.putInt32(x)}},finish:function(e){var t=!0;if(c)if(e)t=e(8,b,!c);else{var n=b.length()===8?8:8-b.length();b.fillWithByte(n,n)}t&&(y=!0,x.update());if(!c){t=b.length()===0;if(t)if(e)t=e(8,w,!c);else{var r=w.length(),i=w.at(r-1);i>r?t=!1:w.truncate(i)}}return t}},x};e.des=e.des||{},e.des.startEncrypting=function(e,t,n){var r=l(e,!0);return r.start(t,n),r},e.des.createEncryptionCipher=function(e){return l(e,!0)},e.des.startDecrypting=function(e,t,n){var r=l(e,!1);return r.start(t,n),r},e.des.createDecryptionCipher=function(e){return l(e,!1)}}var r="des";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/des",["require","module","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){var t=e.pkcs5=e.pkcs5||{};e.pbkdf2=t.pbkdf2=function(t,n,r,i,s){if(typeof s=="undefined"||s===null)s=e.md.sha1.create();var o=s.digestLength;if(i>4294967295*o)throw{message:"Derived key is too long."};var u=Math.ceil(i/o),a=i-(u-1)*o,f=e.hmac.create();f.start(s,t);var l="",c,h,p;for(var d=1;d<=u;++d){f.start(null,null),f.update(n),f.update(e.util.int32ToBytes(d)),c=p=f.digest().getBytes();for(var v=2;v<=r;++v)f.start(null,null),f.update(p),h=f.digest().getBytes(),c=e.util.xorBytes(c,h,o),p=h;l+=d<u?c:c.substr(0,a)}return l}}var r="pbkdf2";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/pbkdf2",["require","module","./hmac","./md","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){var n=typeof process!="undefined"&&process.versions&&process.versions.node,r=null;!e.disableNativeCode&&n&&(r=t("crypto"));var i=e.prng=e.prng||{};i.create=function(t){function u(e){if(n.pools[0].messageLength>=32)return f(),e();var t=32-n.pools[0].messageLength<<5;n.seedFile(t,function(t,r){if(t)return e(t);n.collect(r),f(),e()})}function a(){if(n.pools[0].messageLength>=32)return f();var e=32-n.pools[0].messageLength<<5;n.collect(n.seedFileSync(e)),f()}function f(){var t=e.md.sha1.create();t.update(n.pools[0].digest().getBytes()),n.pools[0].start();var r=1;for(var i=1;i<32;++i)r=r===31?2147483648:r<<2,r%n.reseeds===0&&(t.update(n.pools[i].digest().getBytes()),n.pools[i].start());var s=t.digest().getBytes();t.start(),t.update(s);var o=t.digest().getBytes();n.key=n.plugin.formatKey(s),n.seed=n.plugin.formatSeed(o),++n.reseeds,n.generated=0,n.time=+(new Date)}function l(t){var n=null;if(typeof window!="undefined"){var r=window.crypto||window.msCrypto;r&&r.getRandomValues&&(n=function(e){return r.getRandomValues(e)})}var i=e.util.createBuffer();if(n)while(i.length()<t){var s=Math.max(1,Math.min(t-i.length(),65536)/4),o=new Uint32Array(Math.floor(s));try{n(o);for(var u=0;u<o.length;++u)i.putInt32(o[u])}catch(a){if(!(typeof QuotaExceededError!="undefined"&&a instanceof QuotaExceededError))throw a}}if(i.length()<t){var f,l,c,h=Math.floor(Math.random()*65536);while(i.length()<t){l=16807*(h&65535),f=16807*(h>>16),l+=(f&32767)<<16,l+=f>>15,l=(l&2147483647)+(l>>31),h=l&4294967295;for(var u=0;u<3;++u)c=h>>>(u<<3),c^=Math.floor(Math.random()*256),i.putByte(String.fromCharCode(c&255))}}return i.getBytes(t)}var n={plugin:t,key:null,seed:null,time:null,reseeds:0,generated:0},i=t.md,s=new Array(32);for(var o=0;o<32;++o)s[o]=i.create();return n.pools=s,n.pool=0,n.generate=function(t,r){function l(c){if(c)return r(c);if(f.length()>=t)return r(null,f.getBytes(t));if(n.generated>=1048576){var h=+(new Date);if(n.time===null||h-n.time>100)n.key=null}if(n.key===null)return u(l);var p=i(n.key,n.seed);n.generated+=p.length,f.putBytes(p),n.key=o(i(n.key,s(n.seed))),n.seed=a(i(n.key,n.seed)),e.util.setImmediate(l)}if(!r)return n.generateSync(t);var i=n.plugin.cipher,s=n.plugin.increment,o=n.plugin.formatKey,a=n.plugin.formatSeed,f=e.util.createBuffer();l()},n.generateSync=function(t){var r=n.plugin.cipher,i=n.plugin.increment,s=n.plugin.formatKey,o=n.plugin.formatSeed,u=e.util.createBuffer();while(u.length()<t){if(n.generated>=1048576){var f=+(new Date);if(n.time===null||f-n.time>100)n.key=null}n.key===null&&a();var l=r(n.key,n.seed);n.generated+=l.length,u.putBytes(l),n.key=s(r(n.key,i(n.seed))),n.seed=o(r(n.key,n.seed))}return u.getBytes(t)},r?(n.seedFile=function(e,t){r.randomBytes(e,function(e,n){if(e)return t(e);t(null,n.toString())})},n.seedFileSync=function(e){return r.randomBytes(e).toString()}):(n.seedFile=function(e,t){try{t(null,l(e))}catch(n){t(n)}},n.seedFileSync=l),n.collect=function(e){var t=e.length;for(var r=0;r<t;++r)n.pools[n.pool].update(e.substr(r,1)),n.pool=n.pool===31?0:n.pool+1},n.collectInt=function(e,t){var r="";for(var i=0;i<t;i+=8)r+=String.fromCharCode(e>>i&255);n.collect(r)},n.registerWorker=function(e){if(e===self)n.seedFile=function(e,t){function n(e){var r=e.data;r.forge&&r.forge.prng&&(self.removeEventListener("message",n),t(r.forge.prng.err,r.forge.prng.bytes))}self.addEventListener("message",n),self.postMessage({forge:{prng:{needed:e}}})};else{function t(t){var r=t.data;r.forge&&r.forge.prng&&n.seedFile(r.forge.prng.needed,function(t,n){e.postMessage({forge:{prng:{err:t,bytes:n}}})})}e.addEventListener("message",t)}},n}}var r="prng";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/prng",["require","module","./md","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){if(e.random&&e.random.getBytes)return;(function(t){var n={},r=new Array(4),i=e.util.createBuffer();n.formatKey=function(t){var n=e.util.createBuffer(t);return t=new Array(4),t[0]=n.getInt32(),t[1]=n.getInt32(),t[2]=n.getInt32(),t[3]=n.getInt32(),e.aes._expandKey(t,!1)},n.formatSeed=function(t){var n=e.util.createBuffer(t);return t=new Array(4),t[0]=n.getInt32(),t[1]=n.getInt32(),t[2]=n.getInt32(),t[3]=n.getInt32(),t},n.cipher=function(t,n){return e.aes._updateBlock(t,n,r,!1),i.putInt32(r[0]),i.putInt32(r[1]),i.putInt32(r[2]),i.putInt32(r[3]),i.getBytes()},n.increment=function(e){return++e[3],e},n.md=e.md.sha1;var s=e.prng.create(n),o=typeof process!="undefined"&&process.versions&&process.versions.node,u=null;if(typeof window!="undefined"){var a=window.crypto||window.msCrypto;a&&a.getRandomValues&&(u=function(e){return a.getRandomValues(e)})}if(e.disableNativeCode||!o&&!u){typeof window=="undefined"||window.document===undefined,s.collectInt(+(new Date),32);if(typeof navigator!="undefined"){var f="";for(var l in navigator)try{typeof navigator[l]=="string"&&(f+=navigator[l])}catch(c){}s.collect(f),f=null}t&&(t().mousemove(function(e){s.collectInt(e.clientX,16),s.collectInt(e.clientY,16)}),t().keypress(function(e){s.collectInt(e.charCode,8)}))}if(!e.random)e.random=s;else for(var l in s)e.random[l]=s[l];e.random.getBytes=function(t,n){return e.random.generate(t,n)},e.random.getBytesSync=function(t){return e.random.generate(t)}})(typeof jQuery!="undefined"?jQuery:null)}var r="random";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/random",["require","module","./aes","./md","./prng","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){var t=[217,120,249,196,25,221,181,237,40,233,253,121,74,160,216,157,198,126,55,131,43,118,83,142,98,76,100,136,68,139,251,162,23,154,89,245,135,179,79,19,97,69,109,141,9,129,125,50,189,143,64,235,134,183,123,11,240,149,33,34,92,107,78,130,84,214,101,147,206,96,178,28,115,86,192,20,167,140,241,220,18,117,202,31,59,190,228,209,66,61,212,48,163,60,182,38,111,191,14,218,70,105,7,87,39,242,29,155,188,148,67,3,248,17,199,246,144,239,62,231,6,195,213,47,200,102,30,215,8,232,234,222,128,82,238,247,132,170,114,172,53,77,106,42,150,26,210,113,90,21,73,116,75,159,208,94,4,24,164,236,194,224,65,110,15,81,203,204,36,145,175,80,161,244,112,57,153,124,58,133,35,184,180,122,252,2,54,91,37,85,151,49,45,93,250,152,227,138,146,174,5,223,41,16,103,108,186,201,211,0,230,207,225,158,168,44,99,22,1,63,88,226,137,169,13,56,52,27,171,51,255,176,187,72,12,95,185,177,205,46,197,243,219,71,229,165,156,119,10,166,32,104,254,127,193,173],n=[1,2,3,5],r=function(e,t){return e<<t&65535|(e&65535)>>16-t},i=function(e,t){return(e&65535)>>t|e<<16-t&65535};e.rc2=e.rc2||{},e.rc2.expandKey=function(n,r){typeof n=="string"&&(n=e.util.createBuffer(n)),r=r||128;var i=n,s=n.length(),o=r,u=Math.ceil(o/8),a=255>>(o&7),f;for(f=s;f<128;f++)i.putByte(t[i.at(f-1)+i.at(f-s)&255]);i.setAt(128-u,t[i.at(128-u)&a]);for(f=127-u;f>=0;f--)i.setAt(f,t[i.at(f+1)^i.at(f+u)]);return i};var s=function(t,s,o){var u=!1,a=null,f=null,l=null,c,h,p,d,v=[];t=e.rc2.expandKey(t,s);for(p=0;p<64;p++)v.push(t.getInt16Le());o?(c=function(e){for(p=0;p<4;p++)e[p]+=v[d]+(e[(p+3)%4]&e[(p+2)%4])+(~e[(p+3)%4]&e[(p+1)%4]),e[p]=r(e[p],n[p]),d++},h=function(e){for(p=0;p<4;p++)e[p]+=v[e[(p+3)%4]&63]}):(c=function(e){for(p=3;p>=0;p--)e[p]=i(e[p],n[p]),e[p]-=v[d]+(e[(p+3)%4]&e[(p+2)%4])+(~e[(p+3)%4]&e[(p+1)%4]),d--},h=function(e){for(p=3;p>=0;p--)e[p]-=v[e[(p+3)%4]&63]});var m=function(e){var t=[];for(p=0;p<4;p++){var n=a.getInt16Le();l!==null&&(o?n^=l.getInt16Le():l.putInt16Le(n)),t.push(n&65535)}d=o?0:63;for(var r=0;r<e.length;r++)for(var i=0;i<e[r][0];i++)e[r][1](t);for(p=0;p<4;p++)l!==null&&(o?l.putInt16Le(t[p]):t[p]^=l.getInt16Le()),f.putInt16Le(t[p])},g=null;return g={start:function(t,n){t&&typeof t=="string"&&(t=e.util.createBuffer(t)),u=!1,a=e.util.createBuffer(),f=n||new e.util.createBuffer,l=t,g.output=f},update:function(e){u||a.putBuffer(e);while(a.length()>=8)m([[5,c],[1,h],[6,c],[1,h],[5,c]])},finish:function(e){var t=!0;if(o)if(e)t=e(8,a,!o);else{var n=a.length()===8?8:8-a.length();a.fillWithByte(n,n)}t&&(u=!0,g.update());if(!o){t=a.length()===0;if(t)if(e)t=e(8,f,!o);else{var r=f.length(),i=f.at(r-1);i>r?t=!1:f.truncate(i)}}return t}},g};e.rc2.startEncrypting=function(t,n,r){var i=e.rc2.createEncryptionCipher(t,128);return i.start(n,r),i},e.rc2.createEncryptionCipher=function(e,t){return s(e,t,!0)},e.rc2.startDecrypting=function(t,n,r){var i=e.rc2.createDecryptionCipher(t,128);return i.start(n,r),i},e.rc2.createDecryptionCipher=function(e,t){return s(e,t,!1)}}var r="rc2";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/rc2",["require","module","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){function i(e,t,n){this.data=[],e!=null&&("number"==typeof e?this.fromNumber(e,t,n):t==null&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,t))}function s(){return new i(null)}function o(e,t,n,r,i,s){while(--s>=0){var o=t*this.data[e++]+n.data[r]+i;i=Math.floor(o/67108864),n.data[r++]=o&67108863}return i}function u(e,t,n,r,i,s){var o=t&32767,u=t>>15;while(--s>=0){var a=this.data[e]&32767,f=this.data[e++]>>15,l=u*a+f*o;a=o*a+((l&32767)<<15)+n.data[r]+(i&1073741823),i=(a>>>30)+(l>>>15)+u*f+(i>>>30),n.data[r++]=a&1073741823}return i}function a(e,t,n,r,i,s){var o=t&16383,u=t>>14;while(--s>=0){var a=this.data[e]&16383,f=this.data[e++]>>14,l=u*a+f*o;a=o*a+((l&16383)<<14)+n.data[r]+i,i=(a>>28)+(l>>14)+u*f,n.data[r++]=a&268435455}return i}function d(e){return l.charAt(e)}function v(e,t){var n=c[e.charCodeAt(t)];return n==null?-1:n}function m(e){for(var t=this.t-1;t>=0;--t)e.data[t]=this.data[t];e.t=this.t,e.s=this.s}function g(e){this.t=1,this.s=e<0?-1:0,e>0?this.data[0]=e:e<-1?this.data[0]=e+this.DV:this.t=0}function y(e){var t=s();return t.fromInt(e),t}function b(e,t){var n;if(t==16)n=4;else if(t==8)n=3;else if(t==256)n=8;else if(t==2)n=1;else if(t==32)n=5;else{if(t!=4){this.fromRadix(e,t);return}n=2}this.t=0,this.s=0;var r=e.length,s=!1,o=0;while(--r>=0){var u=n==8?e[r]&255:v(e,r);if(u<0){e.charAt(r)=="-"&&(s=!0);continue}s=!1,o==0?this.data[this.t++]=u:o+n>this.DB?(this.data[this.t-1]|=(u&(1<<this.DB-o)-1)<<o,this.data[this.t++]=u>>this.DB-o):this.data[this.t-1]|=u<<o,o+=n,o>=this.DB&&(o-=this.DB)}n==8&&(e[0]&128)!=0&&(this.s=-1,o>0&&(this.data[this.t-1]|=(1<<this.DB-o)-1<<o)),this.clamp(),s&&i.ZERO.subTo(this,this)}function w(){var e=this.s&this.DM;while(this.t>0&&this.data[this.t-1]==e)--this.t}function E(e){if(this.s<0)return"-"+this.negate().toString(e);var t;if(e==16)t=4;else if(e==8)t=3;else if(e==2)t=1;else if(e==32)t=5;else{if(e!=4)return this.toRadix(e);t=2}var n=(1<<t)-1,r,i=!1,s="",o=this.t,u=this.DB-o*this.DB%t;if(o-->0){u<this.DB&&(r=this.data[o]>>u)>0&&(i=!0,s=d(r));while(o>=0)u<t?(r=(this.data[o]&(1<<u)-1)<<t-u,r|=this.data[--o]>>(u+=this.DB-t)):(r=this.data[o]>>(u-=t)&n,u<=0&&(u+=this.DB,--o)),r>0&&(i=!0),i&&(s+=d(r))}return i?s:"0"}function S(){var e=s();return i.ZERO.subTo(this,e),e}function x(){return this.s<0?this.negate():this}function T(e){var t=this.s-e.s;if(t!=0)return t;var n=this.t;t=n-e.t;if(t!=0)return this.s<0?-t:t;while(--n>=0)if((t=this.data[n]-e.data[n])!=0)return t;return 0}function N(e){var t=1,n;return(n=e>>>16)!=0&&(e=n,t+=16),(n=e>>8)!=0&&(e=n,t+=8),(n=e>>4)!=0&&(e=n,t+=4),(n=e>>2)!=0&&(e=n,t+=2),(n=e>>1)!=0&&(e=n,t+=1),t}function C(){return this.t<=0?0:this.DB*(this.t-1)+N(this.data[this.t-1]^this.s&this.DM)}function k(e,t){var n;for(n=this.t-1;n>=0;--n)t.data[n+e]=this.data[n];for(n=e-1;n>=0;--n)t.data[n]=0;t.t=this.t+e,t.s=this.s}function L(e,t){for(var n=e;n<this.t;++n)t.data[n-e]=this.data[n];t.t=Math.max(this.t-e,0),t.s=this.s}function A(e,t){var n=e%this.DB,r=this.DB-n,i=(1<<r)-1,s=Math.floor(e/this.DB),o=this.s<<n&this.DM,u;for(u=this.t-1;u>=0;--u)t.data[u+s+1]=this.data[u]>>r|o,o=(this.data[u]&i)<<n;for(u=s-1;u>=0;--u)t.data[u]=0;t.data[s]=o,t.t=this.t+s+1,t.s=this.s,t.clamp()}function O(e,t){t.s=this.s;var n=Math.floor(e/this.DB);if(n>=this.t){t.t=0;return}var r=e%this.DB,i=this.DB-r,s=(1<<r)-1;t.data[0]=this.data[n]>>r;for(var o=n+1;o<this.t;++o)t.data[o-n-1]|=(this.data[o]&s)<<i,t.data[o-n]=this.data[o]>>r;r>0&&(t.data[this.t-n-1]|=(this.s&s)<<i),t.t=this.t-n,t.clamp()}function M(e,t){var n=0,r=0,i=Math.min(e.t,this.t);while(n<i)r+=this.data[n]-e.data[n],t.data[n++]=r&this.DM,r>>=this.DB;if(e.t<this.t){r-=e.s;while(n<this.t)r+=this.data[n],t.data[n++]=r&this.DM,r>>=this.DB;r+=this.s}else{r+=this.s;while(n<e.t)r-=e.data[n],t.data[n++]=r&this.DM,r>>=this.DB;r-=e.s}t.s=r<0?-1:0,r<-1?t.data[n++]=this.DV+r:r>0&&(t.data[n++]=r),t.t=n,t.clamp()}function _(e,t){var n=this.abs(),r=e.abs(),s=n.t;t.t=s+r.t;while(--s>=0)t.data[s]=0;for(s=0;s<r.t;++s)t.data[s+n.t]=n.am(0,r.data[s],t,s,0,n.t);t.s=0,t.clamp(),this.s!=e.s&&i.ZERO.subTo(t,t)}function D(e){var t=this.abs(),n=e.t=2*t.t;while(--n>=0)e.data[n]=0;for(n=0;n<t.t-1;++n){var r=t.am(n,t.data[n],e,2*n,0,1);(e.data[n+t.t]+=t.am(n+1,2*t.data[n],e,2*n+1,r,t.t-n-1))>=t.DV&&(e.data[n+t.t]-=t.DV,e.data[n+t.t+1]=1)}e.t>0&&(e.data[e.t-1]+=t.am(n,t.data[n],e,2*n,0,1)),e.s=0,e.clamp()}function P(e,t,n){var r=e.abs();if(r.t<=0)return;var o=this.abs();if(o.t<r.t){t!=null&&t.fromInt(0),n!=null&&this.copyTo(n);return}n==null&&(n=s());var u=s(),a=this.s,f=e.s,l=this.DB-N(r.data[r.t-1]);l>0?(r.lShiftTo(l,u),o.lShiftTo(l,n)):(r.copyTo(u),o.copyTo(n));var c=u.t,h=u.data[c-1];if(h==0)return;var p=h*(1<<this.F1)+(c>1?u.data[c-2]>>this.F2:0),d=this.FV/p,v=(1<<this.F1)/p,m=1<<this.F2,g=n.t,y=g-c,b=t==null?s():t;u.dlShiftTo(y,b),n.compareTo(b)>=0&&(n.data[n.t++]=1,n.subTo(b,n)),i.ONE.dlShiftTo(c,b),b.subTo(u,u);while(u.t<c)u.data[u.t++]=0;while(--y>=0){var w=n.data[--g]==h?this.DM:Math.floor(n.data[g]*d+(n.data[g-1]+m)*v);if((n.data[g]+=u.am(0,w,n,y,0,c))<w){u.dlShiftTo(y,b),n.subTo(b,n);while(n.data[g]<--w)n.subTo(b,n)}}t!=null&&(n.drShiftTo(c,t),a!=f&&i.ZERO.subTo(t,t)),n.t=c,n.clamp(),l>0&&n.rShiftTo(l,n),a<0&&i.ZERO.subTo(n,n)}function H(e){var t=s();return this.abs().divRemTo(e,null,t),this.s<0&&t.compareTo(i.ZERO)>0&&e.subTo(t,t),t}function B(e){this.m=e}function j(e){return e.s<0||e.compareTo(this.m)>=0?e.mod(this.m):e}function F(e){return e}function I(e){e.divRemTo(this.m,null,e)}function q(e,t,n){e.multiplyTo(t,n),this.reduce(n)}function R(e,t){e.squareTo(t),this.reduce(t)}function U(){if(this.t<1)return 0;var e=this.data[0];if((e&1)==0)return 0;var t=e&3;return t=t*(2-(e&15)*t)&15,t=t*(2-(e&255)*t)&255,t=t*(2-((e&65535)*t&65535))&65535,t=t*(2-e*t%this.DV)%this.DV,t>0?this.DV-t:-t}function z(e){this.m=e,this.mp=e.invDigit(),this.mpl=this.mp&32767,this.mph=this.mp>>15,this.um=(1<<e.DB-15)-1,this.mt2=2*e.t}function W(e){var t=s();return e.abs().dlShiftTo(this.m.t,t),t.divRemTo(this.m,null,t),e.s<0&&t.compareTo(i.ZERO)>0&&this.m.subTo(t,t),t}function X(e){var t=s();return e.copyTo(t),this.reduce(t),t}function V(e){while(e.t<=this.mt2)e.data[e.t++]=0;for(var t=0;t<this.m.t;++t){var n=e.data[t]&32767,r=n*this.mpl+((n*this.mph+(e.data[t]>>15)*this.mpl&this.um)<<15)&e.DM;n=t+this.m.t,e.data[n]+=this.m.am(0,r,e,t,0,this.m.t);while(e.data[n]>=e.DV)e.data[n]-=e.DV,e.data[++n]++}e.clamp(),e.drShiftTo(this.m.t,e),e.compareTo(this.m)>=0&&e.subTo(this.m,e)}function $(e,t){e.squareTo(t),this.reduce(t)}function J(e,t,n){e.multiplyTo(t,n),this.reduce(n)}function K(){return(this.t>0?this.data[0]&1:this.s)==0}function Q(e,t){if(e>4294967295||e<1)return i.ONE;var n=s(),r=s(),o=t.convert(this),u=N(e)-1;o.copyTo(n);while(--u>=0){t.sqrTo(n,r);if((e&1<<u)>0)t.mulTo(r,o,n);else{var a=n;n=r,r=a}}return t.revert(n)}function G(e,t){var n;return e<256||t.isEven()?n=new B(t):n=new z(t),this.exp(e,n)}function Y(){var e=s();return this.copyTo(e),e}function Z(){if(this.s<0){if(this.t==1)return this.data[0]-this.DV;if(this.t==0)return-1}else{if(this.t==1)return this.data[0];if(this.t==0)return 0}return(this.data[1]&(1<<32-this.DB)-1)<<this.DB|this.data[0]}function et(){return this.t==0?this.s:this.data[0]<<24>>24}function tt(){return this.t==0?this.s:this.data[0]<<16>>16}function nt(e){return Math.floor(Math.LN2*this.DB/Math.log(e))}function rt(){return this.s<0?-1:this.t<=0||this.t==1&&this.data[0]<=0?0:1}function it(e){e==null&&(e=10);if(this.signum()==0||e<2||e>36)return"0";var t=this.chunkSize(e),n=Math.pow(e,t),r=y(n),i=s(),o=s(),u="";this.divRemTo(r,i,o);while(i.signum()>0)u=(n+o.intValue()).toString(e).substr(1)+u,i.divRemTo(r,i,o);return o.intValue().toString(e)+u}function st(e,t){this.fromInt(0),t==null&&(t=10);var n=this.chunkSize(t),r=Math.pow(t,n),s=!1,o=0,u=0;for(var a=0;a<e.length;++a){var f=v(e,a);if(f<0){e.charAt(a)=="-"&&this.signum()==0&&(s=!0);continue}u=t*u+f,++o>=n&&(this.dMultiply(r),this.dAddOffset(u,0),o=0,u=0)}o>0&&(this.dMultiply(Math.pow(t,o)),this.dAddOffset(u,0)),s&&i.ZERO.subTo(this,this)}function ot(e,t,n){if("number"==typeof t)if(e<2)this.fromInt(1);else{this.fromNumber(e,n),this.testBit(e-1)||this.bitwiseTo(i.ONE.shiftLeft(e-1),dt,this),this.isEven()&&this.dAddOffset(1,0);while(!this.isProbablePrime(t))this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(i.ONE.shiftLeft(e-1),this)}else{var r=new Array,s=e&7;r.length=(e>>3)+1,t.nextBytes(r),s>0?r[0]&=(1<<s)-1:r[0]=0,this.fromString(r,256)}}function ut(){var e=this.t,t=new Array;t[0]=this.s;var n=this.DB-e*this.DB%8,r,i=0;if(e-->0){n<this.DB&&(r=this.data[e]>>n)!=(this.s&this.DM)>>n&&(t[i++]=r|this.s<<this.DB-n);while(e>=0){n<8?(r=(this.data[e]&(1<<n)-1)<<8-n,r|=this.data[--e]>>(n+=this.DB-8)):(r=this.data[e]>>(n-=8)&255,n<=0&&(n+=this.DB,--e)),(r&128)!=0&&(r|=-256),i==0&&(this.s&128)!=(r&128)&&++i;if(i>0||r!=this.s)t[i++]=r}}return t}function at(e){return this.compareTo(e)==0}function ft(e){return this.compareTo(e)<0?this:e}function lt(e){return this.compareTo(e)>0?this:e}function ct(e,t,n){var r,i,s=Math.min(e.t,this.t);for(r=0;r<s;++r)n.data[r]=t(this.data[r],e.data[r]);if(e.t<this.t){i=e.s&this.DM;for(r=s;r<this.t;++r)n.data[r]=t(this.data[r],i);n.t=this.t}else{i=this.s&this.DM;for(r=s;r<e.t;++r)n.data[r]=t(i,e.data[r]);n.t=e.t}n.s=t(this.s,e.s),n.clamp()}function ht(e,t){return e&t}function pt(e){var t=s();return this.bitwiseTo(e,ht,t),t}function dt(e,t){return e|t}function vt(e){var t=s();return this.bitwiseTo(e,dt,t),t}function mt(e,t){return e^t}function gt(e){var t=s();return this.bitwiseTo(e,mt,t),t}function yt(e,t){return e&~t}function bt(e){var t=s();return this.bitwiseTo(e,yt,t),t}function wt(){var e=s();for(var t=0;t<this.t;++t)e.data[t]=this.DM&~this.data[t];return e.t=this.t,e.s=~this.s,e}function Et(e){var t=s();return e<0?this.rShiftTo(-e,t):this.lShiftTo(e,t),t}function St(e){var t=s();return e<0?this.lShiftTo(-e,t):this.rShiftTo(e,t),t}function xt(e){if(e==0)return-1;var t=0;return(e&65535)==0&&(e>>=16,t+=16),(e&255)==0&&(e>>=8,t+=8),(e&15)==0&&(e>>=4,t+=4),(e&3)==0&&(e>>=2,t+=2),(e&1)==0&&++t,t}function Tt(){for(var e=0;e<this.t;++e)if(this.data[e]!=0)return e*this.DB+xt(this.data[e]);return this.s<0?this.t*this.DB:-1}function Nt(e){var t=0;while(e!=0)e&=e-1,++t;return t}function Ct(){var e=0,t=this.s&this.DM;for(var n=0;n<this.t;++n)e+=Nt(this.data[n]^t);return e}function kt(e){var t=Math.floor(e/this.DB);return t>=this.t?this.s!=0:(this.data[t]&1<<e%this.DB)!=0}function Lt(e,t){var n=i.ONE.shiftLeft(e);return this.bitwiseTo(n,t,n),n}function At(e){return this.changeBit(e,dt)}function Ot(e){return this.changeBit(e,yt)}function Mt(e){return this.changeBit(e,mt)}function _t(e,t){var n=0,r=0,i=Math.min(e.t,this.t);while(n<i)r+=this.data[n]+e.data[n],t.data[n++]=r&this.DM,r>>=this.DB;if(e.t<this.t){r+=e.s;while(n<this.t)r+=this.data[n],t.data[n++]=r&this.DM,r>>=this.DB;r+=this.s}else{r+=this.s;while(n<e.t)r+=e.data[n],t.data[n++]=r&this.DM,r>>=this.DB;r+=e.s}t.s=r<0?-1:0,r>0?t.data[n++]=r:r<-1&&(t.data[n++]=this.DV+r),t.t=n,t.clamp()}function Dt(e){var t=s();return this.addTo(e,t),t}function Pt(e){var t=s();return this.subTo(e,t),t}function Ht(e){var t=s();return this.multiplyTo(e,t),t}function Bt(e){var t=s();return this.divRemTo(e,t,null),t}function jt(e){var t=s();return this.divRemTo(e,null,t),t}function Ft(e){var t=s(),n=s();return this.divRemTo(e,t,n),new Array(t,n)}function It(e){this.data[this.t]=this.am(0,e-1,this,0,0,this.t),++this.t,this.clamp()}function qt(e,t){if(e==0)return;while(this.t<=t)this.data[this.t++]=0;this.data[t]+=e;while(this.data[t]>=this.DV)this.data[t]-=this.DV,++t>=this.t&&(this.data[this.t++]=0),++this.data[t]}function Rt(){}function Ut(e){return e}function zt(e,t,n){e.multiplyTo(t,n)}function Wt(e,t){e.squareTo(t)}function Xt(e){return this.exp(e,new Rt)}function Vt(e,t,n){var r=Math.min(this.t+e.t,t);n.s=0,n.t=r;while(r>0)n.data[--r]=0;var i;for(i=n.t-this.t;r<i;++r)n.data[r+this.t]=this.am(0,e.data[r],n,r,0,this.t);for(i=Math.min(e.t,t);r<i;++r)this.am(0,e.data[r],n,r,0,t-r);n.clamp()}function $t(e,t,n){--t;var r=n.t=this.t+e.t-t;n.s=0;while(--r>=0)n.data[r]=0;for(r=Math.max(t-this.t,0);r<e.t;++r)n.data[this.t+r-t]=this.am(t-r,e.data[r],n,0,0,this.t+r-t);n.clamp(),n.drShiftTo(1,n)}function Jt(e){this.r2=s(),this.q3=s(),i.ONE.dlShiftTo(2*e.t,this.r2),this.mu=this.r2.divide(e),this.m=e}function Kt(e){if(e.s<0||e.t>2*this.m.t)return e.mod(this.m);if(e.compareTo(this.m)<0)return e;var t=s();return e.copyTo(t),this.reduce(t),t}function Qt(e){return e}function Gt(e){e.drShiftTo(this.m.t-1,this.r2),e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);while(e.compareTo(this.r2)<0)e.dAddOffset(1,this.m.t+1);e.subTo(this.r2,e);while(e.compareTo(this.m)>=0)e.subTo(this.m,e)}function Yt(e,t){e.squareTo(t),this.reduce(t)}function Zt(e,t,n){e.multiplyTo(t,n),this.reduce(n)}function en(e,t){var n=e.bitLength(),r,i=y(1),o;if(n<=0)return i;n<18?r=1:n<48?r=3:n<144?r=4:n<768?r=5:r=6,n<8?o=new B(t):t.isEven()?o=new Jt(t):o=new z(t);var u=new Array,a=3,f=r-1,l=(1<<r)-1;u[1]=o.convert(this);if(r>1){var c=s();o.sqrTo(u[1],c);while(a<=l)u[a]=s(),o.mulTo(c,u[a-2],u[a]),a+=2}var h=e.t-1,p,d=!0,v=s(),m;n=N(e.data[h])-1;while(h>=0){n>=f?p=e.data[h]>>n-f&l:(p=(e.data[h]&(1<<n+1)-1)<<f-n,h>0&&(p|=e.data[h-1]>>this.DB+n-f)),a=r;while((p&1)==0)p>>=1,--a;(n-=a)<0&&(n+=this.DB,--h);if(d)u[p].copyTo(i),d=!1;else{while(a>1)o.sqrTo(i,v),o.sqrTo(v,i),a-=2;a>0?o.sqrTo(i,v):(m=i,i=v,v=m),o.mulTo(v,u[p],i)}while(h>=0&&(e.data[h]&1<<n)==0)o.sqrTo(i,v),m=i,i=v,v=m,--n<0&&(n=this.DB-1,--h)}return o.revert(i)}function tn(e){var t=this.s<0?this.negate():this.clone(),n=e.s<0?e.negate():e.clone();if(t.compareTo(n)<0){var r=t;t=n,n=r}var i=t.getLowestSetBit(),s=n.getLowestSetBit();if(s<0)return t;i<s&&(s=i),s>0&&(t.rShiftTo(s,t),n.rShiftTo(s,n));while(t.signum()>0)(i=t.getLowestSetBit())>0&&t.rShiftTo(i,t),(i=n.getLowestSetBit())>0&&n.rShiftTo(i,n),t.compareTo(n)>=0?(t.subTo(n,t),t.rShiftTo(1,t)):(n.subTo(t,n),n.rShiftTo(1,n));return s>0&&n.lShiftTo(s,n),n}function nn(e){if(e<=0)return 0;var t=this.DV%e,n=this.s<0?e-1:0;if(this.t>0)if(t==0)n=this.data[0]%e;else for(var r=this.t-1;r>=0;--r)n=(t*n+this.data[r])%e;return n}function rn(e){var t=e.isEven();if(this.isEven()&&t||e.signum()==0)return i.ZERO;var n=e.clone(),r=this.clone(),s=y(1),o=y(0),u=y(0),a=y(1);while(n.signum()!=0){while(n.isEven()){n.rShiftTo(1,n);if(t){if(!s.isEven()||!o.isEven())s.addTo(this,s),o.subTo(e,o);s.rShiftTo(1,s)}else o.isEven()||o.subTo(e,o);o.rShiftTo(1,o)}while(r.isEven()){r.rShiftTo(1,r);if(t){if(!u.isEven()||!a.isEven())u.addTo(this,u),a.subTo(e,a);u.rShiftTo(1,u)}else a.isEven()||a.subTo(e,a);a.rShiftTo(1,a)}n.compareTo(r)>=0?(n.subTo(r,n),t&&s.subTo(u,s),o.subTo(a,o)):(r.subTo(n,r),t&&u.subTo(s,u),a.subTo(o,a))}return r.compareTo(i.ONE)!=0?i.ZERO:a.compareTo(e)>=0?a.subtract(e):a.signum()<0?(a.addTo(e,a),a.signum()<0?a.add(e):a):a}function un(e){var t,n=this.abs();if(n.t==1&&n.data[0]<=sn[sn.length-1]){for(t=0;t<sn.length;++t)if(n.data[0]==sn[t])return!0;return!1}if(n.isEven())return!1;t=1;while(t<sn.length){var r=sn[t],i=t+1;while(i<sn.length&&r<on)r*=sn[i++];r=n.modInt(r);while(t<i)if(r%sn[t++]==0)return!1}return n.millerRabin(e)}function an(e){var t=this.subtract(i.ONE),n=t.getLowestSetBit();if(n<=0)return!1;var r=t.shiftRight(n),s=fn(),o;for(var u=0;u<e;++u){do o=new i(this.bitLength(),s);while(o.compareTo(i.ONE)<=0||o.compareTo(t)>=0);var a=o.modPow(r,this);if(a.compareTo(i.ONE)!=0&&a.compareTo(t)!=0){var f=1;while(f++<n&&a.compareTo(t)!=0){a=a.modPowInt(2,this);if(a.compareTo(i.ONE)==0)return!1}if(a.compareTo(t)!=0)return!1}}return!0}function fn(){return{nextBytes:function(e){for(var t=0;t<e.length;++t)e[t]=Math.floor(Math.random()*255)}}}var t,n=0xdeadbeefcafe,r=(n&16777215)==15715070;typeof navigator=="undefined"?(i.prototype.am=a,t=28):r&&navigator.appName=="Microsoft Internet Explorer"?(i.prototype.am=u,t=30):r&&navigator.appName!="Netscape"?(i.prototype.am=o,t=26):(i.prototype.am=a,t=28),i.prototype.DB=t,i.prototype.DM=(1<<t)-1,i.prototype.DV=1<<t;var f=52;i.prototype.FV=Math.pow(2,f),i.prototype.F1=f-t,i.prototype.F2=2*t-f;var l="0123456789abcdefghijklmnopqrstuvwxyz",c=new Array,h,p;h="0".charCodeAt(0);for(p=0;p<=9;++p)c[h++]=p;h="a".charCodeAt(0);for(p=10;p<36;++p)c[h++]=p;h="A".charCodeAt(0);for(p=10;p<36;++p)c[h++]=p;B.prototype.convert=j,B.prototype.revert=F,B.prototype.reduce=I,B.prototype.mulTo=q,B.prototype.sqrTo=R,z.prototype.convert=W,z.prototype.revert=X,z.prototype.reduce=V,z.prototype.mulTo=J,z.prototype.sqrTo=$,i.prototype.copyTo=m,i.prototype.fromInt=g,i.prototype.fromString=b,i.prototype.clamp=w,i.prototype.dlShiftTo=k,i.prototype.drShiftTo=L,i.prototype.lShiftTo=A,i.prototype.rShiftTo=O,i.prototype.subTo=M,i.prototype.multiplyTo=_,i.prototype.squareTo=D,i.prototype.divRemTo=P,i.prototype.invDigit=U,i.prototype.isEven=K,i.prototype.exp=Q,i.prototype.toString=E,i.prototype.negate=S,i.prototype.abs=x,i.prototype.compareTo=T,i.prototype.bitLength=C,i.prototype.mod=H,i.prototype.modPowInt=G,i.ZERO=y(0),i.ONE=y(1),Rt.prototype.convert=Ut,Rt.prototype.revert=Ut,Rt.prototype.mulTo=zt,Rt.prototype.sqrTo=Wt,Jt.prototype.convert=Kt,Jt.prototype.revert=Qt,Jt.prototype.reduce=Gt,Jt.prototype.mulTo=Zt,Jt.prototype.sqrTo=Yt;var sn=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509],on=(1<<26)/sn[sn.length-1];i.prototype.chunkSize=nt,i.prototype.toRadix=it,i.prototype.fromRadix=st,i.prototype.fromNumber=ot,i.prototype.bitwiseTo=ct,i.prototype.changeBit=Lt,i.prototype.addTo=_t,i.prototype.dMultiply=It,i.prototype.dAddOffset=qt,i.prototype.multiplyLowerTo=Vt,i.prototype.multiplyUpperTo=$t,i.prototype.modInt=nn,i.prototype.millerRabin=an,i.prototype.clone=Y,i.prototype.intValue=Z,i.prototype.byteValue=et,i.prototype.shortValue=tt,i.prototype.signum=rt,i.prototype.toByteArray=ut,i.prototype.equals=at,i.prototype.min=ft,i.prototype.max=lt,i.prototype.and=pt,i.prototype.or=vt,i.prototype.xor=gt,i.prototype.andNot=bt,i.prototype.not=wt,i.prototype.shiftLeft=Et,i.prototype.shiftRight=St,i.prototype.getLowestSetBit=Tt,i.prototype.bitCount=Ct,i.prototype.testBit=kt,i.prototype.setBit=At,i.prototype.clearBit=Ot,i.prototype.flipBit=Mt,i.prototype.add=Dt,i.prototype.subtract=Pt,i.prototype.multiply=Ht,i.prototype.divide=Bt,i.prototype.remainder=jt,i.prototype.divideAndRemainder=Ft,i.prototype.modPow=en,i.prototype.modInverse=rn,i.prototype.pow=Xt,i.prototype.gcd=tn,i.prototype.isProbablePrime=un,e.jsbn=e.jsbn||{},e.jsbn.BigInteger=i}var r="jsbn";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/jsbn",["require","module"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){function n(t,n,r){r||(r=e.md.sha1.create());var i="",s=Math.ceil(n/r.digestLength);for(var o=0;o<s;++o){var u=String.fromCharCode(o>>24&255,o>>16&255,o>>8&255,o&255);r.start(),r.update(t+u),i+=r.digest().getBytes()}return i.substring(0,n)}var t=e.pkcs1=e.pkcs1||{};t.encode_rsa_oaep=function(t,r,i){var s=undefined,o=undefined,u=undefined,a=undefined;typeof i=="string"?(s=i,o=arguments[3]||undefined,u=arguments[4]||undefined):i&&(s=i.label||undefined,o=i.seed||undefined,u=i.md||undefined,i.mgf1&&i.mgf1.md&&(a=i.mgf1.md)),u?u.start():u=e.md.sha1.create(),a||(a=u);var f=Math.ceil(t.n.bitLength()/8),l=f-2*u.digestLength-2;if(r.length>l)throw{message:"RSAES-OAEP input message length is too long.",length:r.length,maxLength:l};s||(s=""),u.update(s,"raw");var c=u.digest(),h="",p=l-r.length;for(var d=0;d<p;d++)h+="\0";var v=c.getBytes()+h+""+r;if(!o)o=e.random.getBytes(u.digestLength);else if(o.length!==u.digestLength)throw{message:"Invalid RSAES-OAEP seed. The seed length must match the digest length.",seedLength:o.length,digestLength:u.digestLength};var m=n(o,f-u.digestLength-1,a),g=e.util.xorBytes(v,m,v.length),y=n(g,u.digestLength,a),b=e.util.xorBytes(o,y,o.length);return"\0"+b+g},t.decode_rsa_oaep=function(t,r,i){var s=undefined,o=undefined,u=undefined;typeof i=="string"?(s=i,o=arguments[3]||undefined):i&&(s=i.label||undefined,o=i.md||undefined,i.mgf1&&i.mgf1.md&&(u=i.mgf1.md));var a=Math.ceil(t.n.bitLength()/8);if(r.length!==a)throw{message:"RSAES-OAEP encoded message length is invalid.",length:r.length,expectedLength:a};o===undefined?o=e.md.sha1.create():o.start(),u||(u=o);if(a<2*o.digestLength+2)throw{message:"RSAES-OAEP key is too short for the hash function."};s||(s=""),o.update(s,"raw");var f=o.digest().getBytes(),l=r.charAt(0),c=r.substring(1,o.digestLength+1),h=r.substring(1+o.digestLength),p=n(h,o.digestLength,u),d=e.util.xorBytes(c,p,c.length),v=n(d,a-o.digestLength-1,u),m=e.util.xorBytes(h,v,h.length),g=m.substring(0,o.digestLength),y=l!=="\0";for(var b=0;b<o.digestLength;++b)y|=f.charAt(b)!==g.charAt(b);var w=1,E=o.digestLength;for(var S=o.digestLength;S<m.length;S++){var x=m.charCodeAt(S),T=x&1^1,N=w?65534:0;y|=x&N,w&=T,E+=w}if(y||m.charCodeAt(E)!==1)throw{message:"Invalid RSAES-OAEP padding."};return m.substring(E+1)}}var r="pkcs1";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/pkcs1",["require","module","./util","./random","./sha1"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){function c(t,n,r){var i=e.util.createBuffer(),s=Math.ceil(n.n.bitLength()/8);if(t.length>s-11)throw{message:"Message is too long for PKCS#1 v1.5 padding.",length:t.length,max:s-11};i.putByte(0),i.putByte(r);var o=s-3-t.length,u;if(r===0||r===1){u=r===0?0:255;for(var a=0;a<o;++a)i.putByte(u)}else while(o>0){var f=0,l=e.random.getBytes(o);for(var a=0;a<o;++a)u=l.charCodeAt(a),u===0?++f:i.putByte(u);o=f}return i.putByte(0),i.putBytes(t),i}function h(t,n,r,i){var s=Math.ceil(n.n.bitLength()/8),o=e.util.createBuffer(t),u=o.getByte(),a=o.getByte();if(u!==0||r&&a!==0&&a!==1||!r&&a!=2||r&&a===0&&typeof i=="undefined")throw{message:"Encryption block is invalid."};var f=0;if(a===0){f=s-3-i;for(var l=0;l<f;++l)if(o.getByte()!==0)throw{message:"Encryption block is invalid."}}else if(a===1){f=0;while(o.length()>1){if(o.getByte()!==255){--o.read;break}++f}}else if(a===2){f=0;while(o.length()>1){if(o.getByte()===0){--o.read;break}++f}}var c=o.getByte();if(c!==0||f!==s-3-o.length())throw{message:"Encryption block is invalid."};return o.getBytes()}function p(n,i,s){function p(){u=Math.max(1,u),d(n.pBits,function(e,t){if(e)return s(e);n.p=t,d(n.qBits,v)})}function d(e,r){function d(){var r=e-1,i=new t(e,n.rng);return i.testBit(r)||i.bitwiseTo(t.ONE.shiftLeft(r),h,i),i.dAddOffset(31-i.mod(c).byteValue(),0),i}function m(s){if(v)return;--o;var u=s.data;if(u.found){for(var l=0;l<i.length;++l)i[l].terminate();return v=!0,r(null,new t(u.prime,16))}p.bitLength()>e&&(p=d());var c=p.toString(16);s.target.postMessage({e:n.eInt,hex:c,workLoad:a}),p.dAddOffset(f,0)}var i=[];for(var s=0;s<u;++s)i[s]=new Worker(l);var o=u,p=d();for(var s=0;s<u;++s)i[s].addEventListener("message",m);var v=!1}function v(e,i){n.q=i;if(n.p.compareTo(n.q)<0){var o=n.p;n.p=n.q,n.q=o}n.p1=n.p.subtract(t.ONE),n.q1=n.q.subtract(t.ONE),n.phi=n.p1.multiply(n.q1);if(n.phi.gcd(n.e).compareTo(t.ONE)!==0){n.p=n.q=null,p();return}n.n=n.p.multiply(n.q);if(n.n.bitLength()!==n.bits){n.q=null,d(n.qBits,v);return}var u=n.e.modInverse(n.phi);n.keys={privateKey:r.rsa.setPrivateKey(n.n,n.e,u,n.p,n.q,u.mod(n.p1),u.mod(n.q1),n.q.modInverse(n.p)),publicKey:r.rsa.setPublicKey(n.n,n.e)},s(null,n.keys)}typeof i=="function"&&(s=i,i={});if(typeof Worker=="undefined"){function o(){if(r.rsa.stepKeyPairGenerationState(n,10))return s(null,n.keys);e.util.setImmediate(o)}return o()}var u=i.workers||2,a=i.workLoad||100,f=a*30/8,l=i.workerScript||"forge/prime.worker.js",c=new t(null);c.fromInt(30);var h=function(e,t){return e|t};if(u===-1)return e.util.estimateCores(function(e,t){e&&(t=2),u=t-1,p()});p()}function d(t){var n=t.toString(16);return n[0]>="8"&&(n="00"+n),e.util.hexToBytes(n)}function v(e){return e<=100?27:e<=150?18:e<=200?15:e<=250?12:e<=300?9:e<=350?8:e<=400?7:e<=500?6:e<=600?5:e<=800?4:e<=1250?3:2}if(typeof t=="undefined")var t=e.jsbn.BigInteger;var n=e.asn1;e.pki=e.pki||{},e.pki.rsa=e.rsa=e.rsa||{};var r=e.pki,i=[6,4,2,4,2,4,6,2],s={name:"PrivateKeyInfo",tagClass:n.Class.UNIVERSAL,type:n.Type.SEQUENCE,constructed:!0,value:[{name:"PrivateKeyInfo.version",tagClass:n.Class.UNIVERSAL,type:n.Type.INTEGER,constructed:!1,capture:"privateKeyVersion"},{name:"PrivateKeyInfo.privateKeyAlgorithm",tagClass:n.Class.UNIVERSAL,type:n.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:n.Class.UNIVERSAL,type:n.Type.OID,constructed:!1,capture:"privateKeyOid"}]},{name:"PrivateKeyInfo",tagClass:n.Class.UNIVERSAL,type:n.Type.OCTETSTRING,constructed:!1,capture:"privateKey"}]},o={name:"RSAPrivateKey",tagClass:n.Class.UNIVERSAL,type:n.Type.SEQUENCE,constructed:!0,value:[{name:"RSAPrivateKey.version",tagClass:n.Class.UNIVERSAL,type:n.Type.INTEGER,constructed:!1,capture:"privateKeyVersion"},{name:"RSAPrivateKey.modulus",tagClass:n.Class.UNIVERSAL,type:n.Type.INTEGER,constructed:!1,capture:"privateKeyModulus"},{name:"RSAPrivateKey.publicExponent",tagClass:n.Class.UNIVERSAL,type:n.Type.INTEGER,constructed:!1,capture:"privateKeyPublicExponent"},{name:"RSAPrivateKey.privateExponent",tagClass:n.Class.UNIVERSAL,type:n.Type.INTEGER,constructed:!1,capture:"privateKeyPrivateExponent"},{name:"RSAPrivateKey.prime1",tagClass:n.Class.UNIVERSAL,type:n.Type.INTEGER,constructed:!1,capture:"privateKeyPrime1"},{name:"RSAPrivateKey.prime2",tagClass:n.Class.UNIVERSAL,type:n.Type.INTEGER,constructed:!1,capture:"privateKeyPrime2"},{name:"RSAPrivateKey.exponent1",tagClass:n.Class.UNIVERSAL,type:n.Type.INTEGER,constructed:!1,capture:"privateKeyExponent1"},{name:"RSAPrivateKey.exponent2",tagClass:n.Class.UNIVERSAL,type:n.Type.INTEGER,constructed:!1,capture:"privateKeyExponent2"},{name:"RSAPrivateKey.coefficient",tagClass:n.Class.UNIVERSAL,type:n.Type.INTEGER,constructed:!1,capture:"privateKeyCoefficient"}]},u={name:"RSAPublicKey",tagClass:n.Class.UNIVERSAL,type:n.Type.SEQUENCE,constructed:!0,value:[{name:"RSAPublicKey.modulus",tagClass:n.Class.UNIVERSAL,type:n.Type.INTEGER,constructed:!1,capture:"publicKeyModulus"},{name:"RSAPublicKey.exponent",tagClass:n.Class.UNIVERSAL,type:n.Type.INTEGER,constructed:!1,capture:"publicKeyExponent"}]},a=e.pki.rsa.publicKeyValidator={name:"SubjectPublicKeyInfo",tagClass:n.Class.UNIVERSAL,type:n.Type.SEQUENCE,constructed:!0,captureAsn1:"subjectPublicKeyInfo",value:[{name:"SubjectPublicKeyInfo.AlgorithmIdentifier",tagClass:n.Class.UNIVERSAL,type:n.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:n.Class.UNIVERSAL,type:n.Type.OID,constructed:!1,capture:"publicKeyOid"}]},{name:"SubjectPublicKeyInfo.subjectPublicKey",tagClass:n.Class.UNIVERSAL,type:n.Type.BITSTRING,constructed:!1,value:[{name:"SubjectPublicKeyInfo.subjectPublicKey.RSAPublicKey",tagClass:n.Class.UNIVERSAL,type:n.Type.SEQUENCE,constructed:!0,optional:!0,captureAsn1:"rsaPublicKey"}]}]},f=function(e){var t;if(e.algorithm in r.oids){t=r.oids[e.algorithm];var i=n.oidToDer(t).getBytes(),s=n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[]),o=n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[]);o.value.push(n.create(n.Class.UNIVERSAL,n.Type.OID,!1,i)),o.value.push(n.create(n.Class.UNIVERSAL,n.Type.NULL,!1,""));var u=n.create(n.Class.UNIVERSAL,n.Type.OCTETSTRING,!1,e.digest().getBytes());return s.value.push(o),s.value.push(u),n.toDer(s).getBytes()}throw{message:"Unknown message digest algorithm.",algorithm:e.algorithm}},l=function(e,n,r){var i;if(r)i=e.modPow(n.e,n.n);else if(!n.p||!n.q)i=e.modPow(n.d,n.n);else{n.dP||(n.dP=n.d.mod(n.p.subtract(t.ONE))),n.dQ||(n.dQ=n.d.mod(n.q.subtract(t.ONE))),n.qInv||(n.qInv=n.q.modInverse(n.p));var s=e.mod(n.p).modPow(n.dP,n.p),o=e.mod(n.q).modPow(n.dQ,n.q);while(s.compareTo(o)<0)s=s.add(n.p);i=s.subtract(o).multiply(n.qInv).mod(n.p).multiply(n.q).add(o)}return i};r.rsa.encrypt=function(n,r,i){var s=i,o,u=Math.ceil(r.n.bitLength()/8);i!==!1&&i!==!0?(s=i===2,o=c(n,r,i)):(o=e.util.createBuffer(),o.putBytes(n));var a=new t(o.toHex(),16),f=l(a,r,s),h=f.toString(16),p=e.util.createBuffer(),d=u-Math.ceil(h.length/2);while(d>0)p.putByte(0),--d;return p.putBytes(e.util.hexToBytes(h)),p.getBytes()},r.rsa.decrypt=function(n,r,i,s){var o=Math.ceil(r.n.bitLength()/8);if(n.length!==o)throw{message:"Encrypted message length is invalid.",length:n.length,expected:o};var u=new t(e.util.createBuffer(n).toHex(),16);if(u.compareTo(r.n)>=0)throw{message:"Encrypted message is invalid."};var a=l(u,r,i),f=a.toString(16),c=e.util.createBuffer(),p=o-Math.ceil(f.length/2);while(p>0)c.putByte(0),--p;return c.putBytes(e.util.hexToBytes(f)),s!==!1?h(c.getBytes(),r,i):c.getBytes()},r.rsa.createKeyPairGenerationState=function(n,r){typeof n=="string"&&(n=parseInt(n,10)),n=n||2048;var i={nextBytes:function(t){var n=e.random.getBytes(t.length);for(var r=0;r<t.length;++r)t[r]=n.charCodeAt(r)}},s={state:0,bits:n,rng:i,eInt:r||65537,e:new t(null),p:null,q:null,qBits:n>>1,pBits:n-(n>>1),pqState:0,num:null,keys:null};return s.e.fromInt(s.eInt),s},r.rsa.stepKeyPairGenerationState=function(e,n){var s=new t(null);s.fromInt(30);var o=0,u=function(e,t){return e|t},a=+(new Date),f,l=0;while(e.keys===null&&(n<=0||l<n)){if(e.state===0){var c=e.p===null?e.pBits:e.qBits,h=c-1;e.pqState===0?(e.num=new t(c,e.rng),e.num.testBit(h)||e.num.bitwiseTo(t.ONE.shiftLeft(h),u,e.num),e.num.dAddOffset(31-e.num.mod(s).byteValue(),0),o=0,++e.pqState):e.pqState===1?e.num.bitLength()>c?e.pqState=0:e.num.isProbablePrime(v(e.num.bitLength()))?++e.pqState:e.num.dAddOffset(i[o++%8],0):e.pqState===2?e.pqState=e.num.subtract(t.ONE).gcd(e.e).compareTo(t.ONE)===0?3:0:e.pqState===3&&(e.pqState=0,e.p===null?e.p=e.num:e.q=e.num,e.p!==null&&e.q!==null&&++e.state,e.num=null)}else if(e.state===1)e.p.compareTo(e.q)<0&&(e.num=e.p,e.p=e.q,e.q=e.num),++e.state;else if(e.state===2)e.p1=e.p.subtract(t.ONE),e.q1=e.q.subtract(t.ONE),e.phi=e.p1.multiply(e.q1),++e.state;else if(e.state===3)e.phi.gcd(e.e).compareTo(t.ONE)===0?++e.state:(e.p=null,e.q=null,e.state=0);else if(e.state===4)e.n=e.p.multiply(e.q),e.n.bitLength()===e.bits?++e.state:(e.q=null,e.state=0);else if(e.state===5){var p=e.e.modInverse(e.phi);e.keys={privateKey:r.rsa.setPrivateKey(e.n,e.e,p,e.p,e.q,p.mod(e.p1),p.mod(e.q1),e.q.modInverse(e.p)),publicKey:r.rsa.setPublicKey(e.n,e.e)}}f=+(new Date),l+=f-a,a=f}return e.keys!==null},r.rsa.generateKeyPair=function(e,t,n,i){arguments.length===1?typeof e=="object"?(n=e,e=undefined):typeof e=="function"&&(i=e,e=undefined):arguments.length===2?(typeof e=="number"?typeof t=="function"?i=t:n=t:(n=e,i=t,e=undefined),t=undefined):arguments.length===3&&(typeof t=="number"?typeof n=="function"&&(i=n,n=undefined):(i=n,n=t,t=undefined)),n=n||{},e===undefined&&(e=n.bits||2048),t===undefined&&(t=n.e||65537);var s=r.rsa.createKeyPairGenerationState(e,t);if(!i)return r.rsa.stepKeyPairGenerationState(s,0),s.keys;p(s,n,i)},r.setRsaPublicKey=r.rsa.setPublicKey=function(t,i){var s={n:t,e:i};return s.encrypt=function(t,n,i){typeof n=="string"?n=n.toUpperCase():n===undefined&&(n="RSAES-PKCS1-V1_5");if(n==="RSAES-PKCS1-V1_5")n={encode:function(e,t,n){return c(e,t,2).getBytes()}};else if(n==="RSA-OAEP"||n==="RSAES-OAEP")n={encode:function(t,n){return e.pkcs1.encode_rsa_oaep(n,t,i)}};else{if(["RAW","NONE","NULL",null].indexOf(n)===-1)throw{message:'Unsupported encryption scheme: "'+n+'".'};n={encode:function(e){return e}}}var o=n.encode(t,s,!0);return r.rsa.encrypt(o,s,!0)},s.verify=function(e,t,i){typeof i=="string"?i=i.toUpperCase():i===undefined&&(i="RSASSA-PKCS1-V1_5");if(i==="RSASSA-PKCS1-V1_5")i={verify:function(e,t){t=h(t,s,!0);var r=n.fromDer(t);return e===r.value[1].value}};else if(i==="NONE"||i==="NULL"||i===null)i={verify:function(e,t){return t=h(t,s,!0),e===t}};var o=r.rsa.decrypt(t,s,!0,!1);return i.verify(e,o,s.n.bitLength())},s},r.setRsaPrivateKey=r.rsa.setPrivateKey=function(t,n,i,s,o,u,a,l){var c={n:t,e:n,d:i,p:s,q:o,dP:u,dQ:a,qInv:l};return c.decrypt=function(t,n,i){typeof n=="string"?n=n.toUpperCase():n===undefined&&(n="RSAES-PKCS1-V1_5");var s=r.rsa.decrypt(t,c,!1,!1);if(n==="RSAES-PKCS1-V1_5")n={decode:h};else if(n==="RSA-OAEP"||n==="RSAES-OAEP")n={decode:function(t,n){return e.pkcs1.decode_rsa_oaep(n,t,i)}};else{if(["RAW","NONE","NULL",null].indexOf(n)===-1)throw{message:'Unsupported encryption scheme: "'+n+'".'};n={decode:function(e){return e}}}return n.decode(s,c,!1)},c.sign=function(e,t){var n=!1;typeof t=="string"&&(t=t.toUpperCase());if(t===undefined||t==="RSASSA-PKCS1-V1_5")t={encode:f},n=1;else if(t==="NONE"||t==="NULL"||t===null)t={encode:function(){return e}},n=1;var i=t.encode(e,c.n.bitLength());return r.rsa.encrypt(i,c,n)},c},r.wrapRsaPrivateKey=function(e){return n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[n.create(n.Class.UNIVERSAL,n.Type.INTEGER,!1,n.integerToDer(0).getBytes()),n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[n.create(n.Class.UNIVERSAL,n.Type.OID,!1,n.oidToDer(r.oids.rsaEncryption).getBytes()),n.create(n.Class.UNIVERSAL,n.Type.NULL,!1,"")]),n.create(n.Class.UNIVERSAL,n.Type.OCTETSTRING,!1,n.toDer(e).getBytes())])},r.privateKeyFromAsn1=function(i){var u={},a=[];n.validate(i,s,u,a)&&(i=n.fromDer(e.util.createBuffer(u.privateKey))),u={},a=[];if(!n.validate(i,o,u,a))throw{message:"Cannot read private key. ASN.1 object does not contain an RSAPrivateKey.",errors:a};var f,l,c,h,p,d,v,m;return f=e.util.createBuffer(u.privateKeyModulus).toHex(),l=e.util.createBuffer(u.privateKeyPublicExponent).toHex(),c=e.util.createBuffer(u.privateKeyPrivateExponent).toHex(),h=e.util.createBuffer(u.privateKeyPrime1).toHex(),p=e.util.createBuffer(u.privateKeyPrime2).toHex(),d=e.util.createBuffer(u.privateKeyExponent1).toHex(),v=e.util.createBuffer(u.privateKeyExponent2).toHex(),m=e.util.createBuffer(u.privateKeyCoefficient).toHex(),r.setRsaPrivateKey(new t(f,16),new t(l,16),new t(c,16),new t(h,16),new t(p,16),new t(d,16),new t(v,16),new t(m,16))},r.privateKeyToAsn1=r.privateKeyToRSAPrivateKey=function(e){return n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[n.create(n.Class.UNIVERSAL,n.Type.INTEGER,!1,n.integerToDer(0).getBytes()),n.create(n.Class.UNIVERSAL,n.Type.INTEGER,!1,d(e.n)),n.create(n.Class.UNIVERSAL,n.Type.INTEGER,!1,d(e.e)),n.create(n.Class.UNIVERSAL,n.Type.INTEGER,!1,d(e.d)),n.create(n.Class.UNIVERSAL,n.Type.INTEGER,!1,d(e.p)),n.create(n.Class.UNIVERSAL,n.Type.INTEGER,!1,d(e.q)),n.create(n.Class.UNIVERSAL,n.Type.INTEGER,!1,d(e.dP)),n.create(n.Class.UNIVERSAL,n.Type.INTEGER,!1,d(e.dQ)),n.create(n.Class.UNIVERSAL,n.Type.INTEGER,!1,d(e.qInv))])},r.publicKeyFromAsn1=function(i){var s={},o=[];if(n.validate(i,a,s,o)){var f=n.derToOid(s.publicKeyOid);if(f!==r.oids.rsaEncryption)throw{message:"Cannot read public key. Unknown OID.",oid:f};i=s.rsaPublicKey}o=[];if(!n.validate(i,u,s,o))throw{message:"Cannot read public key. ASN.1 object does not contain an RSAPublicKey.",errors:o};var l=e.util.createBuffer(s.publicKeyModulus).toHex(),c=e.util.createBuffer(s.publicKeyExponent).toHex();return r.setRsaPublicKey(new t(l,16),new t(c,16))},r.publicKeyToAsn1=r.publicKeyToSubjectPublicKeyInfo=function(e){return n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[n.create(n.Class.UNIVERSAL,n.Type.OID,!1,n.oidToDer(r.oids.rsaEncryption).getBytes()),n.create(n.Class.UNIVERSAL,n.Type.NULL,!1,"")]),n.create(n.Class.UNIVERSAL,n.Type.BITSTRING,!1,[r.publicKeyToRSAPublicKey(e)])])},r.publicKeyToRSAPublicKey=function(e){return n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[n.create(n.Class.UNIVERSAL,n.Type.INTEGER,!1,d(e.n)),n.create(n.Class.UNIVERSAL,n.Type.INTEGER,!1,d(e.e))])}}var r="rsa";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/rsa",["require","module","./asn1","./oids","./random","./util","./jsbn","./pkcs1"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){function a(e,t,n){var r=[f(e+t)];for(var i=16,s=1;i<n;++s,i+=16)r.push(f(r[s-1]+e+t));return r.join("").substr(0,n)}function f(t){return e.md.md5.create().update(t).digest().getBytes()}if(typeof t=="undefined")var t=e.jsbn.BigInteger;var n=e.asn1,r=e.pki=e.pki||{};r.pbe=e.pbe=e.pbe||{};var i=r.oids,s={name:"EncryptedPrivateKeyInfo",tagClass:n.Class.UNIVERSAL,type:n.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedPrivateKeyInfo.encryptionAlgorithm",tagClass:n.Class.UNIVERSAL,type:n.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:n.Class.UNIVERSAL,type:n.Type.OID,constructed:!1,capture:"encryptionOid"},{name:"AlgorithmIdentifier.parameters",tagClass:n.Class.UNIVERSAL,type:n.Type.SEQUENCE,constructed:!0,captureAsn1:"encryptionParams"}]},{name:"EncryptedPrivateKeyInfo.encryptedData",tagClass:n.Class.UNIVERSAL,type:n.Type.OCTETSTRING,constructed:!1,capture:"encryptedData"}]},o={name:"PBES2Algorithms",tagClass:n.Class.UNIVERSAL,type:n.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.keyDerivationFunc",tagClass:n.Class.UNIVERSAL,type:n.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.keyDerivationFunc.oid",tagClass:n.Class.UNIVERSAL,type:n.Type.OID,constructed:!1,capture:"kdfOid"},{name:"PBES2Algorithms.params",tagClass:n.Class.UNIVERSAL,type:n.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.params.salt",tagClass:n.Class.UNIVERSAL,type:n.Type.OCTETSTRING,constructed:!1,capture:"kdfSalt"},{name:"PBES2Algorithms.params.iterationCount",tagClass:n.Class.UNIVERSAL,type:n.Type.INTEGER,onstructed:!0,capture:"kdfIterationCount"}]}]},{name:"PBES2Algorithms.encryptionScheme",tagClass:n.Class.UNIVERSAL,type:n.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.encryptionScheme.oid",tagClass:n.Class.UNIVERSAL,type:n.Type.OID,constructed:!1,capture:"encOid"},{name:"PBES2Algorithms.encryptionScheme.iv",tagClass:n.Class.UNIVERSAL,type:n.Type.OCTETSTRING,constructed:!1,capture:"encIv"}]}]},u={name:"pkcs-12PbeParams",tagClass:n.Class.UNIVERSAL,type:n.Type.SEQUENCE,constructed:!0,value:[{name:"pkcs-12PbeParams.salt",tagClass:n.Class.UNIVERSAL,type:n.Type.OCTETSTRING,constructed:!1,capture:"salt"},{name:"pkcs-12PbeParams.iterations",tagClass:n.Class.UNIVERSAL,type:n.Type.INTEGER,constructed:!1,capture:"iterations"}]};r.encryptPrivateKeyInfo=function(t,s,o){o=o||{},o.saltSize=o.saltSize||8,o.count=o.count||2048,o.algorithm=o.algorithm||"aes128";var u=e.random.getBytesSync(o.saltSize),a=o.count,f=n.integerToDer(a),l,c,h;if(o.algorithm.indexOf("aes")===0||o.algorithm==="des"){var p,d,v;switch(o.algorithm){case"aes128":l=16,p=16,d=i["aes128-CBC"],v=e.aes.createEncryptionCipher;break;case"aes192":l=24,p=16,d=i["aes192-CBC"],v=e.aes.createEncryptionCipher;break;case"aes256":l=32,p=16,d=i["aes256-CBC"],v=e.aes.createEncryptionCipher;break;case"des":l=8,p=8,d=i.desCBC,v=e.des.createEncryptionCipher;break;default:throw{message:"Cannot encrypt private key. Unknown encryption algorithm.",algorithm:o.algorithm}}var m=e.pkcs5.pbkdf2(s,u,a,l),g=e.random.getBytesSync(p),y=v(m);y.start(g),y.update(n.toDer(t)),y.finish(),h=y.output.getBytes(),c=n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[n.create(n.Class.UNIVERSAL,n.Type.OID,!1,n.oidToDer(i.pkcs5PBES2).getBytes()),n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[n.create(n.Class.UNIVERSAL,n.Type.OID,!1,n.oidToDer(i.pkcs5PBKDF2).getBytes()),n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[n.create(n.Class.UNIVERSAL,n.Type.OCTETSTRING,!1,u),n.create(n.Class.UNIVERSAL,n.Type.INTEGER,!1,f.getBytes())])]),n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[n.create(n.Class.UNIVERSAL,n.Type.OID,!1,n.oidToDer(d).getBytes()),n.create(n.Class.UNIVERSAL,n.Type.OCTETSTRING,!1,g)])])])}else{if(o.algorithm!=="3des")throw{message:"Cannot encrypt private key. Unknown encryption algorithm.",algorithm:o.algorithm};l=24;var b=new e.util.ByteBuffer(u),m=r.pbe.generatePkcs12Key(s,b,1,a,l),g=r.pbe.generatePkcs12Key(s,b,2,a,l),y=e.des.createEncryptionCipher(m);y.start(g),y.update(n.toDer(t)),y.finish(),h=y.output.getBytes(),c=n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[n.create(n.Class.UNIVERSAL,n.Type.OID,!1,n.oidToDer(i["pbeWithSHAAnd3-KeyTripleDES-CBC"]).getBytes()),n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[n.create(n.Class.UNIVERSAL,n.Type.OCTETSTRING,!1,u),n.create(n.Class.UNIVERSAL,n.Type.INTEGER,!1,f.getBytes())])])}var w=n.create(n.Class.UNIVERSAL,n.Type.SEQUENCE,!0,[c,n.create(n.Class.UNIVERSAL,n.Type.OCTETSTRING,!1,h)]);return w},r.decryptPrivateKeyInfo=function(t,i){var o=null,u={},a=[];if(!n.validate(t,s,u,a))throw{message:"Cannot read encrypted private key. ASN.1 object is not a supported EncryptedPrivateKeyInfo.",errors:a};var f=n.derToOid(u.encryptionOid),l=r.pbe.getCipher(f,u.encryptionParams,i),c=e.util.createBuffer(u.encryptedData);return l.update(c),l.finish()&&(o=n.fromDer(l.output)),o},r.encryptedPrivateKeyToPem=function(t,r){var i={type:"ENCRYPTED PRIVATE KEY",body:n.toDer(t).getBytes()};return e.pem.encode(i,{maxline:r})},r.encryptedPrivateKeyFromPem=function(t){var r=e.pem.decode(t)[0];if(r.type!=="ENCRYPTED PRIVATE KEY")throw{message:'Could not convert encrypted private key from PEM; PEM header type is "ENCRYPTED PRIVATE KEY".',headerType:r.type};if(r.procType&&r.procType.type==="ENCRYPTED")throw{message:"Could not convert encrypted private key from PEM; PEM is encrypted."};return n.fromDer(r.body)},r.encryptRsaPrivateKey=function(t,i,s){s=s||{};if(!s.legacy){var o=r.wrapRsaPrivateKey(r.privateKeyToAsn1(t));return o=r.encryptPrivateKeyInfo(o,i,s),r.encryptedPrivateKeyToPem(o)}var u,f,l,c;switch(s.algorithm){case"aes128":u="AES-128-CBC",l=16,f=e.random.getBytesSync(16),c=e.aes.createEncryptionCipher;break;case"aes192":u="AES-192-CBC",l=24,f=e.random.getBytesSync(16),c=e.aes.createEncryptionCipher;break;case"aes256":u="AES-256-CBC",l=32,f=e.random.getBytesSync(16),c=e.aes.createEncryptionCipher;break;case"3des":u="DES-EDE3-CBC",l=24,f=e.random.getBytesSync(8),c=e.des.createEncryptionCipher;break;case"des":u="DES-CBC",l=8,f=e.random.getBytesSync(8),c=e.des.createEncryptionCipher;break;default:throw{message:'Could not encrypt RSA private key; unsupported encryption algorithm "'+s.algorithm+'".',algorithm:s.algorithm}}var h=a(i,f.substr(0,8),l),p=c(h);p.start(f),p.update(n.toDer(r.privateKeyToAsn1(t))),p.finish();var d={type:"RSA PRIVATE KEY",procType:{version:"4",type:"ENCRYPTED"},dekInfo:{algorithm:u,parameters:e.util.bytesToHex(f).toUpperCase()},body:p.output.getBytes()};return e.pem.encode(d)},r.decryptRsaPrivateKey=function(t,i){var s=null,o=e.pem.decode(t)[0];if(o.type!=="ENCRYPTED PRIVATE KEY"&&o.type!=="PRIVATE KEY"&&o.type!=="RSA PRIVATE KEY")throw{message:'Could not convert private key from PEM; PEM header type is not "ENCRYPTED PRIVATE KEY", "PRIVATE KEY", or "RSA PRIVATE KEY".',headerType:o.type};if(o.procType&&o.procType.type==="ENCRYPTED"){var u,f;switch(o.dekInfo.algorithm){case"DES-CBC":u=8,f=e.des.createDecryptionCipher;break;case"DES-EDE3-CBC":u=24,f=e.des.createDecryptionCipher;break;case"AES-128-CBC":u=16,f=e.aes.createDecryptionCipher;break;case"AES-192-CBC":u=24,f=e.aes.createDecryptionCipher;break;case"AES-256-CBC":u=32,f=e.aes.createDecryptionCipher;break;case"RC2-40-CBC":u=5,f=function(t){return e.rc2.createDecryptionCipher(t,40)};break;case"RC2-64-CBC":u=8,f=function(t){return e.rc2.createDecryptionCipher(t,64)};break;case"RC2-128-CBC":u=16,f=function(t){return e.rc2.createDecryptionCipher(t,128)};break;default:throw{message:'Could not decrypt private key; unsupported encryption algorithm "'+o.dekInfo.algorithm+'".',algorithm:o.dekInfo.algorithm}}var l=e.util.hexToBytes(o.dekInfo.parameters),c=a(i,l.substr(0,8),u),h=f(c);h.start(l),h.update(e.util.createBuffer(o.body));if(!h.finish())return s;s=h.output.getBytes()}else s=o.body;return o.type==="ENCRYPTED PRIVATE KEY"?s=r.decryptPrivateKeyInfo(n.fromDer(s),i):s=n.fromDer(s),s!==null&&(s=r.privateKeyFromAsn1(s)),s},r.pbe.generatePkcs12Key=function(t,n,r,i,s,o){var u,a;if(typeof o=="undefined"||o===null)o=e.md.sha1.create();var f=o.digestLength,l=o.blockLength,c=new e.util.ByteBuffer,h=new e.util.ByteBuffer;for(a=0;a<t.length;a++)h.putInt16(t.charCodeAt(a));h.putInt16(0);var p=h.length(),d=n.length(),v=new e.util.ByteBuffer;v.fillWithByte(r,l);var m=l*Math.ceil(d/l),g=new e.util.ByteBuffer;for(a=0;a<m;a++)g.putByte(n.at(a%d));var y=l*Math.ceil(p/l),b=new e.util.ByteBuffer;for(a=0;a<y;a++)b.putByte(h.at(a%p));var w=g;w.putBuffer(b);var E=Math.ceil(s/f);for(var S=1;S<=E;S++){var x=new e.util.ByteBuffer;x.putBytes(v.bytes()),x.putBytes(w.bytes());for(var T=0;T<i;T++)o.start(),o.update(x.getBytes()),x=o.digest();var N=new e.util.ByteBuffer;for(a=0;a<l;a++)N.putByte(x.at(a%f));var C=Math.ceil(d/l)+Math.ceil(p/l),k=new e.util.ByteBuffer;for(u=0;u<C;u++){var L=new e.util.ByteBuffer(w.getBytes(l)),A=511;for(a=N.length()-1;a>=0;a--)A>>=8,A+=N.at(a)+L.at(a),L.setAt(a,A&255);k.putBuffer(L)}w=k,c.putBuffer(x)}return c.truncate(c.length()-s),c},r.pbe.getCipher=function(e,t,n){switch(e){case r.oids.pkcs5PBES2:return r.pbe.getCipherForPBES2(e,t,n);case r.oids["pbeWithSHAAnd3-KeyTripleDES-CBC"]:case r.oids["pbewithSHAAnd40BitRC2-CBC"]:return r.pbe.getCipherForPKCS12PBE(e,t,n);default:throw{message:"Cannot read encrypted PBE data block. Unsupported OID.",oid:e,supportedOids:["pkcs5PBES2","pbeWithSHAAnd3-KeyTripleDES-CBC","pbewithSHAAnd40BitRC2-CBC"]}}},r.pbe.getCipherForPBES2=function(t,i,s){var u={},a=[];if(!n.validate(i,o,u,a))throw{message:"Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.",errors:a};t=n.derToOid(u.kdfOid);if(t!==r.oids.pkcs5PBKDF2)throw{message:"Cannot read encrypted private key. Unsupported key derivation function OID.",oid:t,supportedOids:["pkcs5PBKDF2"]};t=n.derToOid(u.encOid);if(t!==r.oids["aes128-CBC"]&&t!==r.oids["aes192-CBC"]&&t!==r.oids["aes256-CBC"]&&t!==r.oids["des-EDE3-CBC"]&&t!==r.oids.desCBC)throw{message:"Cannot read encrypted private key. Unsupported encryption scheme OID.",oid:t,supportedOids:["aes128-CBC","aes192-CBC","aes256-CBC","des-EDE3-CBC","desCBC"]};var f=u.kdfSalt,l=e.util.createBuffer(u.kdfIterationCount);l=l.getInt(l.length()<<3);var c,h;switch(r.oids[t]){case"aes128-CBC":c=16,h=e.aes.createDecryptionCipher;break;case"aes192-CBC":c=24,h=e.aes.createDecryptionCipher;break;case"aes256-CBC":c=32,h=e.aes.createDecryptionCipher;break;case"des-EDE3-CBC":c=24,h=e.des.createDecryptionCipher;break;case"desCBC":c=8,h=e.des.createDecryptionCipher}var p=e.pkcs5.pbkdf2(s,f,l,c),d=u.encIv,v=h(p);return v.start(d),v},r.pbe.getCipherForPKCS12PBE=function(t,i,s){var o={},a=[];if(!n.validate(i,u,o,a))throw{message:"Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.",errors:a};var f=e.util.createBuffer(o.salt),l=e.util.createBuffer(o.iterations);l=l.getInt(l.length()<<3);var c,h,p;switch(t){case r.oids["pbeWithSHAAnd3-KeyTripleDES-CBC"]:c=24,h=8,p=e.des.startDecrypting;break;case r.oids["pbewithSHAAnd40BitRC2-CBC"]:c=5,h=8,p=function(t,n){var r=e.rc2.createDecryptionCipher(t,40);return r.start(n,null),r};break;default:throw{message:"Cannot read PKCS #12 PBE data block. Unsupported OID.",oid:t}}var d=r.pbe.generatePkcs12Key(s,f,1,l,c),v=r.pbe.generatePkcs12Key(s,f,2,l,h);return p(d,v)}}var r="pbe";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/pbe",["require","module","./aes","./asn1","./des","./md","./oids","./pem","./pbkdf2","./random","./rc2","./rsa","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){var t=e.asn1,n=e.pkcs7asn1=e.pkcs7asn1||{};e.pkcs7=e.pkcs7||{},e.pkcs7.asn1=n;var r={name:"ContentInfo",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"ContentInfo.ContentType",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1,capture:"contentType"},{name:"ContentInfo.content",tagClass:t.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,captureAsn1:"content"}]};n.contentInfoValidator=r;var i={name:"EncryptedContentInfo",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedContentInfo.contentType",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1,capture:"contentType"},{name:"EncryptedContentInfo.contentEncryptionAlgorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedContentInfo.contentEncryptionAlgorithm.algorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1,capture:"encAlgorithm"},{name:"EncryptedContentInfo.contentEncryptionAlgorithm.parameter",tagClass:t.Class.UNIVERSAL,captureAsn1:"encParameter"}]},{name:"EncryptedContentInfo.encryptedContent",tagClass:t.Class.CONTEXT_SPECIFIC,type:0,capture:"encryptedContent"}]};n.envelopedDataValidator={name:"EnvelopedData",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"EnvelopedData.Version",tagClass:t.Class.UNIVERSAL,type:t.Type.INTEGER,constructed:!1,capture:"version"},{name:"EnvelopedData.RecipientInfos",tagClass:t.Class.UNIVERSAL,type:t.Type.SET,constructed:!0,captureAsn1:"recipientInfos"}].concat(i)},n.encryptedDataValidator={name:"EncryptedData",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedData.Version",tagClass:t.Class.UNIVERSAL,type:t.Type.INTEGER,constructed:!1,capture:"version"}].concat(i)};var s={name:"SignerInfo",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"SignerInfo.Version",tagClass:t.Class.UNIVERSAL,type:t.Type.INTEGER,constructed:!1},{name:"SignerInfo.IssuerAndSerialNumber",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0},{name:"SignerInfo.DigestAlgorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0},{name:"SignerInfo.AuthenticatedAttributes",tagClass:t.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,capture:"authenticatedAttributes"},{name:"SignerInfo.DigestEncryptionAlgorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0},{name:"SignerInfo.EncryptedDigest",tagClass:t.Class.UNIVERSAL,type:t.Type.OCTETSTRING,constructed:!1,capture:"signature"},{name:"SignerInfo.UnauthenticatedAttributes",tagClass:t.Class.CONTEXT_SPECIFIC,type:1,constructed:!0,optional:!0}]};n.signedDataValidator={name:"SignedData",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"SignedData.Version",tagClass:t.Class.UNIVERSAL,type:t.Type.INTEGER,constructed:!1,capture:"version"},{name:"SignedData.DigestAlgorithms",tagClass:t.Class.UNIVERSAL,type:t.Type.SET,constructed:!0,captureAsn1:"digestAlgorithms"},r,{name:"SignedData.Certificates",tagClass:t.Class.CONTEXT_SPECIFIC,type:0,optional:!0,captureAsn1:"certificates"},{name:"SignedData.CertificateRevocationLists",tagClass:t.Class.CONTEXT_SPECIFIC,type:1,optional:!0,captureAsn1:"crls"},{name:"SignedData.SignerInfos",tagClass:t.Class.UNIVERSAL,type:t.Type.SET,capture:"signerInfos",optional:!0,value:[s]}]},n.recipientInfoValidator={name:"RecipientInfo",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"RecipientInfo.version",tagClass:t.Class.UNIVERSAL,type:t.Type.INTEGER,constructed:!1,capture:"version"},{name:"RecipientInfo.issuerAndSerial",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"RecipientInfo.issuerAndSerial.issuer",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,captureAsn1:"issuer"},{name:"RecipientInfo.issuerAndSerial.serialNumber",tagClass:t.Class.UNIVERSAL,type:t.Type.INTEGER,constructed:!1,capture:"serial"}]},{name:"RecipientInfo.keyEncryptionAlgorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"RecipientInfo.keyEncryptionAlgorithm.algorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1,capture:"encAlgorithm"},{name:"RecipientInfo.keyEncryptionAlgorithm.parameter",tagClass:t.Class.UNIVERSAL,constructed:!1,captureAsn1:"encParameter"}]},{name:"RecipientInfo.encryptedKey",tagClass:t.Class.UNIVERSAL,type:t.Type.OCTETSTRING,constructed:!1,capture:"encKey"}]}}var r="pkcs7asn1";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/pkcs7asn1",["require","module","./asn1","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){e.mgf=e.mgf||{};var t=e.mgf.mgf1=e.mgf1=e.mgf1||{};t.create=function(t){var n={generate:function(n,r){var i=new e.util.ByteBuffer,s=Math.ceil(r/t.digestLength);for(var o=0;o<s;o++){var u=new e.util.ByteBuffer;u.putInt32(o),t.start(),t.update(n+u.getBytes()),i.putBuffer(t.digest())}return i.truncate(i.length()-r),i.getBytes()}};return n}}var r="mgf1";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/mgf1",["require","module","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){e.mgf=e.mgf||{},e.mgf.mgf1=e.mgf1}var r="mgf";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/mgf",["require","module","./mgf1"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){var t=e.pss=e.pss||{};t.create=function(t,n,r){var i=t.digestLength,s={};return s.verify=function(s,o,u){var a,f=u-1,l=Math.ceil(f/8);o=o.substr(-l);if(l<i+r+2)throw{message:"Inconsistent parameters to PSS signature verification."};if(o.charCodeAt(l-1)!==188)throw{message:"Encoded message does not end in 0xBC."};var c=l-i-1,h=o.substr(0,c),p=o.substr(c,i),d=65280>>8*l-f&255;if((h.charCodeAt(0)&d)!==0)throw{message:"Bits beyond keysize not zero as expected."};var v=n.generate(p,c),m="";for(a=0;a<c;a++)m+=String.fromCharCode(h.charCodeAt(a)^v.charCodeAt(a));m=String.fromCharCode(m.charCodeAt(0)&~d)+m.substr(1);var g=l-i-r-2;for(a=0;a<g;a++)if(m.charCodeAt(a)!==0)throw{message:"Leftmost octets not zero as expected"};if(m.charCodeAt(g)!==1)throw{message:"Inconsistent PSS signature, 0x01 marker not found"};var y=m.substr(-r),b=new e.util.ByteBuffer;b.fillWithByte(0,8),b.putBytes(s),b.putBytes(y),t.start(),t.update(b.getBytes());var w=t.digest().getBytes();return p===w},s.encode=function(s,o){var u,a=o-1,f=Math.ceil(a/8),l=s.digest().getBytes();if(f<i+r+2)throw{message:"Message is too long to encrypt"};var c=e.random.getBytes(r),h=new e.util.ByteBuffer;h.fillWithByte(0,8),h.putBytes(l),h.putBytes(c),t.start(),t.update(h.getBytes());var p=t.digest().getBytes(),d=new e.util.ByteBuffer;d.fillWithByte(0,f-r-i-2),d.putByte(1),d.putBytes(c);var v=d.getBytes(),m=f-i-1,g=n.generate(p,m),y="";for(u=0;u<m;u++)y+=String.fromCharCode(v.charCodeAt(u)^g.charCodeAt(u));var b=65280>>8*f-a&255;return y=String.fromCharCode(y.charCodeAt(0)&~b)+y.substr(1),y+p+String.fromCharCode(188)},s}}var r="pss";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/pss",["require","module","./random","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){function l(e,t){typeof t=="string"&&(t={shortName:t});var n=null,r;for(var i=0;n===null&&i<e.attributes.length;++i)r=e.attributes[i],t.type&&t.type===r.type?n=r:t.name&&t.name===r.name?n=r:t.shortName&&t.shortName===r.shortName&&(n=r);return n}function p(n){var r=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[]),i,s,o=n.attributes;for(var u=0;u<o.length;++u){i=o[u];var a=i.value,f=t.Type.PRINTABLESTRING;"valueTagClass"in i&&(f=i.valueTagClass,f===t.Type.UTF8&&(a=e.util.encodeUtf8(a))),s=t.create(t.Class.UNIVERSAL,t.Type.SET,!0,[t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(i.type).getBytes()),t.create(t.Class.UNIVERSAL,f,!1,a)])]),r.value.push(s)}return r}function d(e){var n=t.create(t.Class.CONTEXT_SPECIFIC,3,!0,[]),r=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[]);n.value.push(r);var i,s;for(var o=0;o<e.length;++o){i=e[o],s=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[]),r.value.push(s),s.value.push(t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(i.id).getBytes())),i.critical&&s.value.push(t.create(t.Class.UNIVERSAL,t.Type.BOOLEAN,!1,String.fromCharCode(255)));var u=i.value;typeof i.value!="string"&&(u=t.toDer(u).getBytes()),s.value.push(t.create(t.Class.UNIVERSAL,t.Type.OCTETSTRING,!1,u))}return n}function v(n){var r={};for(var i=0;i<n.length;++i){var s=n[i];if(s.shortName&&(s.valueTagClass===t.Type.UTF8||s.valueTagClass===t.Type.PRINTABLESTRING||s.valueTagClass===t.Type.IA5STRING)){var o=s.value;s.valueTagClass===t.Type.UTF8&&(o=e.util.encodeUtf8(s.value)),s.shortName in r?e.util.isArray(r[s.shortName])?r[s.shortName].push(o):r[s.shortName]=[r[s.shortName],o]:r[s.shortName]=o}}return r}function m(e){var t;for(var r=0;r<e.length;++r){t=e[r],typeof t.name=="undefined"&&(t.type&&t.type in n.oids?t.name=n.oids[t.type]:t.shortName&&t.shortName in i&&(t.name=n.oids[i[t.shortName]]));if(typeof t.type=="undefined"){if(!(t.name&&t.name in n.oids))throw{message:"Attribute type not specified.",attribute:t};t.type=n.oids[t.name]}typeof t.shortName=="undefined"&&t.name&&t.name in i&&(t.shortName=i[t.name]);if(typeof t.value=="undefined")throw{message:"Attribute value not specified.",attribute:t}}}function g(e,n){switch(e){case r["RSASSA-PSS"]:var i=[];return n.hash.algorithmOid!==undefined&&i.push(t.create(t.Class.CONTEXT_SPECIFIC,0,!0,[t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(n.hash.algorithmOid).getBytes()),t.create(t.Class.UNIVERSAL,t.Type.NULL,!1,"")])])),n.mgf.algorithmOid!==undefined&&i.push(t.create(t.Class.CONTEXT_SPECIFIC,1,!0,[t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(n.mgf.algorithmOid).getBytes()),t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(n.mgf.hash.algorithmOid).getBytes()),t.create(t.Class.UNIVERSAL,t.Type.NULL,!1,"")])])])),n.saltLength!==undefined&&i.push(t.create(t.Class.CONTEXT_SPECIFIC,2,!0,[t.create(t.Class.UNIVERSAL,t.Type.INTEGER,!1,t.integerToDer(n.saltLength).getBytes())])),t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,i);default:return t.create(t.Class.UNIVERSAL,t.Type.NULL,!1,"")}}function y(n){var r=t.create(t.Class.CONTEXT_SPECIFIC,0,!0,[]);if(n.attributes.length===0)return r;var i=n.attributes;for(var s=0;s<i.length;++s){var o=i[s],u=o.value,a=t.Type.UTF8;"valueTagClass"in o&&(a=o.valueTagClass),a===t.Type.UTF8&&(u=e.util.encodeUtf8(u));var f=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(o.type).getBytes()),t.create(t.Class.UNIVERSAL,t.Type.SET,!0,[t.create(t.Class.UNIVERSAL,a,!1,u)])]);r.value.push(f)}return r}var t=e.asn1,n=e.pki=e.pki||{},r=n.oids,i={};i.CN=r.commonName,i.commonName="CN",i.C=r.countryName,i.countryName="C",i.L=r.localityName,i.localityName="L",i.ST=r.stateOrProvinceName,i.stateOrProvinceName="ST",i.O=r.organizationName,i.organizationName="O",i.OU=r.organizationalUnitName,i.organizationalUnitName="OU",i.E=r.emailAddress,i.emailAddress="E";var s=e.pki.rsa.publicKeyValidator,o={name:"Certificate",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.TBSCertificate",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,captureAsn1:"tbsCertificate",value:[{name:"Certificate.TBSCertificate.version",tagClass:t.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,value:[{name:"Certificate.TBSCertificate.version.integer",tagClass:t.Class.UNIVERSAL,type:t.Type.INTEGER,constructed:!1,capture:"certVersion"}]},{name:"Certificate.TBSCertificate.serialNumber",tagClass:t.Class.UNIVERSAL,type:t.Type.INTEGER,constructed:!1,capture:"certSerialNumber"},{name:"Certificate.TBSCertificate.signature",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.TBSCertificate.signature.algorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1,capture:"certinfoSignatureOid"},{name:"Certificate.TBSCertificate.signature.parameters",tagClass:t.Class.UNIVERSAL,optional:!0,captureAsn1:"certinfoSignatureParams"}]},{name:"Certificate.TBSCertificate.issuer",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,captureAsn1:"certIssuer"},{name:"Certificate.TBSCertificate.validity",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.TBSCertificate.validity.notBefore (utc)",tagClass:t.Class.UNIVERSAL,type:t.Type.UTCTIME,constructed:!1,optional:!0,capture:"certValidity1UTCTime"},{name:"Certificate.TBSCertificate.validity.notBefore (generalized)",tagClass:t.Class.UNIVERSAL,type:t.Type.GENERALIZEDTIME,constructed:!1,optional:!0,capture:"certValidity2GeneralizedTime"},{name:"Certificate.TBSCertificate.validity.notAfter (utc)",tagClass:t.Class.UNIVERSAL,type:t.Type.UTCTIME,constructed:!1,optional:!0,capture:"certValidity3UTCTime"},{name:"Certificate.TBSCertificate.validity.notAfter (generalized)",tagClass:t.Class.UNIVERSAL,type:t.Type.GENERALIZEDTIME,constructed:!1,optional:!0,capture:"certValidity4GeneralizedTime"}]},{name:"Certificate.TBSCertificate.subject",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,captureAsn1:"certSubject"},s,{name:"Certificate.TBSCertificate.issuerUniqueID",tagClass:t.Class.CONTEXT_SPECIFIC,type:1,constructed:!0,optional:!0,value:[{name:"Certificate.TBSCertificate.issuerUniqueID.id",tagClass:t.Class.UNIVERSAL,type:t.Type.BITSTRING,constructed:!1,capture:"certIssuerUniqueId"}]},{name:"Certificate.TBSCertificate.subjectUniqueID",tagClass:t.Class.CONTEXT_SPECIFIC,type:2,constructed:!0,optional:!0,value:[{name:"Certificate.TBSCertificate.subjectUniqueID.id",tagClass:t.Class.UNIVERSAL,type:t.Type.BITSTRING,constructed:!1,capture:"certSubjectUniqueId"}]},{name:"Certificate.TBSCertificate.extensions",tagClass:t.Class.CONTEXT_SPECIFIC,type:3,constructed:!0,captureAsn1:"certExtensions",optional:!0}]},{name:"Certificate.signatureAlgorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.signatureAlgorithm.algorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1,capture:"certSignatureOid"},{name:"Certificate.TBSCertificate.signature.parameters",tagClass:t.Class.UNIVERSAL,optional:!0,captureAsn1:"certSignatureParams"}]},{name:"Certificate.signatureValue",tagClass:t.Class.UNIVERSAL,type:t.Type.BITSTRING,constructed:!1,capture:"certSignature"}]},u={name:"rsapss",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"rsapss.hashAlgorithm",tagClass:t.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,value:[{name:"rsapss.hashAlgorithm.AlgorithmIdentifier",tagClass:t.Class.UNIVERSAL,type:t.Class.SEQUENCE,constructed:!0,optional:!0,value:[{name:"rsapss.hashAlgorithm.AlgorithmIdentifier.algorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1,capture:"hashOid"}]}]},{name:"rsapss.maskGenAlgorithm",tagClass:t.Class.CONTEXT_SPECIFIC,type:1,constructed:!0,value:[{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier",tagClass:t.Class.UNIVERSAL,type:t.Class.SEQUENCE,constructed:!0,optional:!0,value:[{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier.algorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1,capture:"maskGenOid"},{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier.params",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier.params.algorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1,capture:"maskGenHashOid"}]}]}]},{name:"rsapss.saltLength",tagClass:t.Class.CONTEXT_SPECIFIC,type:2,optional:!0,value:[{name:"rsapss.saltLength.saltLength",tagClass:t.Class.UNIVERSAL,type:t.Class.INTEGER,constructed:!1,capture:"saltLength"}]},{name:"rsapss.trailerField",tagClass:t.Class.CONTEXT_SPECIFIC,type:3,optional:!0,value:[{name:"rsapss.trailer.trailer",tagClass:t.Class.UNIVERSAL,type:t.Class.INTEGER,constructed:!1,capture:"trailer"}]}]},a={name:"CertificationRequestInfo",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,captureAsn1:"certificationRequestInfo",value:[{name:"CertificationRequestInfo.integer",tagClass:t.Class.UNIVERSAL,type:t.Type.INTEGER,constructed:!1,capture:"certificationRequestInfoVersion"},{name:"CertificationRequestInfo.subject",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,captureAsn1:"certificationRequestInfoSubject"},s,{name:"CertificationRequestInfo.attributes",tagClass:t.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,capture:"certificationRequestInfoAttributes",value:[{name:"CertificationRequestInfo.attributes",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"CertificationRequestInfo.attributes.type",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1},{name:"CertificationRequestInfo.attributes.value",tagClass:t.Class.UNIVERSAL,type:t.Type.SET,constructed:!0}]}]}]},f={name:"CertificationRequest",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,captureAsn1:"csr",value:[a,{name:"CertificationRequest.signatureAlgorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"CertificationRequest.signatureAlgorithm.algorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1,capture:"csrSignatureOid"},{name:"CertificationRequest.signatureAlgorithm.parameters",tagClass:t.Class.UNIVERSAL,optional:!0,captureAsn1:"csrSignatureParams"}]},{name:"CertificationRequest.signature",tagClass:t.Class.UNIVERSAL,type:t.Type.BITSTRING,constructed:!1,capture:"csrSignature"}]};n.RDNAttributesAsArray=function(e,n){var s=[],o,u,a;for(var f=0;f<e.value.length;++f){o=e.value[f];for(var l=0;l<o.value.length;++l)a={},u=o.value[l],a.type=t.derToOid(u.value[0].value),a.value=u.value[1].value,a.valueTagClass=u.value[1].type,a.type in r&&(a.name=r[a.type],a.name in i&&(a.shortName=i[a.name])),n&&(n.update(a.type),n.update(a.value)),s.push(a)}return s},n.CRIAttributesAsArray=function(e){var n=[];for(var s=0;s<e.length;++s){var o=e[s],u=t.derToOid(o.value[0].value),a=o.value[1].value;for(var f=0;f<a.length;++f){var l={};l.type=u,l.value=a[f].value,l.valueTagClass=a[f].type,l.type in r&&(l.name=r[l.type],l.name in i&&(l.shortName=i[l.name])),n.push(l)}}return n};var c=function(n){var i=[],s,o,u;for(var a=0;a<n.value.length;++a){u=n.value[a];for(var f=0;f<u.value.length;++f){o=u.value[f],s={},s.id=t.derToOid(o.value[0].value),s.critical=!1,o.value[1].type===t.Type.BOOLEAN?(s.critical=o.value[1].value.charCodeAt(0)!==0,s.value=o.value[2].value):s.value=o.value[1].value;if(s.id in r){s.name=r[s.id];if(s.name==="keyUsage"){var l=t.fromDer(s.value),c=0,h=0;l.value.length>1&&(c=l.value.charCodeAt(1),h=l.value.length>2?l.value.charCodeAt(2):0),s.digitalSignature=(c&128)===128,s.nonRepudiation=(c&64)===64,s.keyEncipherment=(c&32)===32,s.dataEncipherment=(c&16)===16,s.keyAgreement=(c&8)===8,s.keyCertSign=(c&4)===4,s.cRLSign=(c&2)===2,s.encipherOnly=(c&1)===1,s.decipherOnly=(h&128)===128}else if(s.name==="basicConstraints"){var l=t.fromDer(s.value);l.value.length>0&&l.value[0].type===t.Type.BOOLEAN?s.cA=l.value[0].value.charCodeAt(0)!==0:s.cA=!1;var p=null;l.value.length>0&&l.value[0].type===t.Type.INTEGER?p=l.value[0].value:l.value.length>1&&(p=l.value[1].value),p!==null&&(s.pathLenConstraint=t.derToInteger(p))}else if(s.name==="extKeyUsage"){var l=t.fromDer(s.value);for(var d=0;d<l.value.length;++d){var v=t.derToOid(l.value[d].value);v in r?s[r[v]]=!0:s[v]=!0}}else if(s.name==="nsCertType"){var l=t.fromDer(s.value),c=0;l.value.length>1&&(c=l.value.charCodeAt(1)),s.client=(c&128)===128,s.server=(c&64)===64,s.email=(c&32)===32,s.objsign=(c&16)===16,s.reserved=(c&8)===8,s.sslCA=(c&4)===4,s.emailCA=(c&2)===2,s.objCA=(c&1)===1}else if(s.name==="subjectAltName"||s.name==="issuerAltName"){s.altNames=[];var m,l=t.fromDer(s.value);for(var g=0;g<l.value.length;++g){m=l.value[g];var y={type:m.type,value:m.value};s.altNames.push(y);switch(m.type){case 1:case 2:case 6:break;case 7:y.ip=e.util.bytesToIP(m.value);break;case 8:y.oid=t.derToOid(m.value);break;default:}}}else if(s.name==="subjectKeyIdentifier"){var l=t.fromDer(s.value);s.subjectKeyIdentifier=e.util.bytesToHex(l.value)}}i.push(s)}}return i},h=function(e,n,i){var s={};if(e!==r["RSASSA-PSS"])return s;i&&(s={hash:{algorithmOid:r.sha1},mgf:{algorithmOid:r.mgf1,hash:{algorithmOid:r.sha1}},saltLength:20});var o={},a=[];if(!t.validate(n,u,o,a))throw{message:"Cannot read RSASSA-PSS parameter block.",errors:a};return o.hashOid!==undefined&&(s.hash=s.hash||{},s.hash.algorithmOid=t.derToOid(o.hashOid)),o.maskGenOid!==undefined&&(s.mgf=s.mgf||{},s.mgf.algorithmOid=t.derToOid(o.maskGenOid),s.mgf.hash=s.mgf.hash||{},s.mgf.hash.algorithmOid=t.derToOid(o.maskGenHashOid)),o.saltLength!==undefined&&(s.saltLength=o.saltLength.charCodeAt(0)),s};n.certificateFromPem=function(r,i,s){var o=e.pem.decode(r)[0];if(o.type!=="CERTIFICATE"&&o.type!=="X509 CERTIFICATE"&&o.type!=="TRUSTED CERTIFICATE")throw{message:'Could not convert certificate from PEM; PEM header type is not "CERTIFICATE", "X509 CERTIFICATE", or "TRUSTED CERTIFICATE".',headerType:o.type};if(o.procType&&o.procType.type==="ENCRYPTED")throw{message:"Could not convert certificate from PEM; PEM is encrypted."};var u=t.fromDer(o.body,s);return n.certificateFromAsn1(u,i)},n.certificateToPem=function(r,i){var s={type:"CERTIFICATE",body:t.toDer(n.certificateToAsn1(r)).getBytes()};return e.pem.encode(s,{maxline:i})},n.publicKeyFromPem=function(r){var i=e.pem.decode(r)[0];if(i.type!=="PUBLIC KEY"&&i.type!=="RSA PUBLIC KEY")throw{message:'Could not convert public key from PEM; PEM header type is not "PUBLIC KEY" or "RSA PUBLIC KEY".',headerType:i.type};if(i.procType&&i.procType.type==="ENCRYPTED")throw{message:"Could not convert public key from PEM; PEM is encrypted."};var s=t.fromDer(i.body);return n.publicKeyFromAsn1(s)},n.publicKeyToPem=function(r,i){var s={type:"PUBLIC KEY",body:t.toDer(n.publicKeyToAsn1(r)).getBytes()};return e.pem.encode(s,{maxline:i})},n.publicKeyToRSAPublicKeyPem=function(r,i){var s={type:"RSA PUBLIC KEY",body:t.toDer(n.publicKeyToRSAPublicKey(r)).getBytes()};return e.pem.encode(s,{maxline:i})},n.certificationRequestFromPem=function(r,i,s){var o=e.pem.decode(r)[0];if(o.type!=="CERTIFICATE REQUEST")throw{message:'Could not convert certification request from PEM; PEM header type is not "CERTIFICATE REQUEST".',headerType:o.type};if(o.procType&&o.procType.type==="ENCRYPTED")throw{message:"Could not convert certification request from PEM; PEM is encrypted."};var u=t.fromDer(o.body,s);return n.certificationRequestFromAsn1(u,i)},n.certificationRequestToPem=function(r,i){var s={type:"CERTIFICATE REQUEST",body:t.toDer(n.certificationRequestToAsn1(r)).getBytes()};return e.pem.encode(s,{maxline:i})},n.createCertificate=function(){var i={};return i.version=2,i.serialNumber="00",i.signatureOid=null,i.signature=null,i.siginfo={},i.siginfo.algorithmOid=null,i.validity={},i.validity.notBefore=new Date,i.validity.notAfter=new Date,i.issuer={},i.issuer.getField=function(e){return l(i.issuer,e)},i.issuer.addField=function(e){m([e]),i.issuer.attributes.push(e)},i.issuer.attributes=[],i.issuer.hash=null,i.subject={},i.subject.getField=function(e){return l(i.subject,e)},i.subject.addField=function(e){m([e]),i.subject.attributes.push(e)},i.subject.attributes=[],i.subject.hash=null,i.extensions=[],i.publicKey=null,i.md=null,i.setSubject=function(e,t){m(e),i.subject.attributes=e,delete i.subject.uniqueId,t&&(i.subject.uniqueId=t),i.subject.hash=null},i.setIssuer=function(e,t){m(e),i.issuer.attributes=e,delete i.issuer.uniqueId,t&&(i.issuer.uniqueId=t),i.issuer.hash=null},i.setExtensions=function(s){var o;for(var u=0;u<s.length;++u){o=s[u],typeof o.name=="undefined"&&o.id&&o.id in n.oids&&(o.name=n.oids[o.id]);if(typeof o.id=="undefined"){if(!(o.name&&o.name in n.oids))throw{message:"Extension ID not specified.",extension:o};o.id=n.oids[o.name]}if(typeof o.value=="undefined"){if(o.name==="keyUsage"){var a=0,f=0,l=0;o.digitalSignature&&(f|=128,a=7),o.nonRepudiation&&(f|=64,a=6),o.keyEncipherment&&(f|=32,a=5),o.dataEncipherment&&(f|=16,a=4),o.keyAgreement&&(f|=8,a=3),o.keyCertSign&&(f|=4,a=2),o.cRLSign&&(f|=2,a=1),o.encipherOnly&&(f|=1,a=0),o.decipherOnly&&(l|=128,a=7);var c=String.fromCharCode(a);l!==0?c+=String.fromCharCode(f)+String.fromCharCode(l):f!==0&&(c+=String.fromCharCode(f)),o.value=t.create(t.Class.UNIVERSAL,t.Type.BITSTRING,!1,c)}else if(o.name==="basicConstraints")o.value=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[]),o.cA&&o.value.value.push(t.create(t.Class.UNIVERSAL,t.Type.BOOLEAN,!1,String.fromCharCode(255))),"pathLenConstraint"in o&&o.value.value.push(t.create(t.Class.UNIVERSAL,t.Type.INTEGER,!1,t.integerToDer(o.pathLenConstraint).getBytes()));else if(o.name==="extKeyUsage"){o.value=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[]);var h=o.value.value;for(var p in o){if(o[p]!==!0)continue;p in r?h.push(t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(r[p]).getBytes())):p.indexOf(".")!==-1&&h.push(t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(p).getBytes()))}}else if(o.name==="nsCertType"){var a=0,f=0;o.client&&(f|=128,a=7),o.server&&(f|=64,a=6),o.email&&(f|=32,a=5),o.objsign&&(f|=16,a=4),o.reserved&&(f|=8,a=3),o.sslCA&&(f|=4,a=2),o.emailCA&&(f|=2,a=1),o.objCA&&(f|=1,a=0);var c=String.fromCharCode(a);f!==0&&(c+=String.fromCharCode(f)),o.value=t.create(t.Class.UNIVERSAL,t.Type.BITSTRING,!1,c)}else if(o.name==="subjectAltName"||o.name==="issuerAltName"){o.value=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[]);var d;for(var v=0;v<o.altNames.length;++v){d=o.altNames[v];var c=d.value;if(d.type===7&&d.ip){c=e.util.bytesFromIP(d.ip);if(c===null)throw{message:'Extension "ip" value is not a valid IPv4 or IPv6 address.',extension:o}}else d.type===8&&(d.oid?c=t.oidToDer(t.oidToDer(d.oid)):c=t.oidToDer(c));o.value.value.push(t.create(t.Class.CONTEXT_SPECIFIC,d.type,!1,c))}}else if(o.name==="subjectKeyIdentifier"){var m=i.generateSubjectKeyIdentifier();o.subjectKeyIdentifier=m.toHex(),o.value=t.create(t.Class.UNIVERSAL,t.Type.OCTETSTRING,!1,m.getBytes())}if(typeof o.value=="undefined")throw{message:"Extension value not specified.",extension:o}}}i.extensions=s},i.getExtension=function(e){typeof e=="string"&&(e={name:e});var t=null,n;for(var r=0;t===null&&r<i.extensions.length;++r)n=i.extensions[r],e.id&&n.id===e.id?t=n:e.name&&n.name===e.name&&(t=n);return t},i.sign=function(s,o){i.md=o||e.md.sha1.create();var u=r[i.md.algorithm+"WithRSAEncryption"];if(!u)throw{message:"Could not compute certificate digest. Unknown message digest algorithm OID.",algorithm:i.md.algorithm};i.signatureOid=i.siginfo.algorithmOid=u,i.tbsCertificate=n.getTBSCertificate(i);var a=t.toDer(i.tbsCertificate);i.md.update(a.getBytes()),i.signature=s.sign(i.md)},i.verify=function(s){var o=!1;if(!i.issued(s)){var u=s.issuer,a=i.subject;throw{message:"The parent certificate did not issue the given child certificate; the child certificate's issuer does not match the parent's subject.",expectedIssuer:u.attributes,actualIssuer:a.attributes}}var f=s.md;if(f===null){if(s.signatureOid in r){var l=r[s.signatureOid];switch(l){case"sha1WithRSAEncryption":f=e.md.sha1.create();break;case"md5WithRSAEncryption":f=e.md.md5.create();break;case"sha256WithRSAEncryption":f=e.md.sha256.create();break;case"RSASSA-PSS":f=e.md.sha256.create()}}if(f===null)throw{message:"Could not compute certificate digest. Unknown signature OID.",signatureOid:s.signatureOid};var c=s.tbsCertificate||n.getTBSCertificate(s),h=t.toDer(c);f.update(h.getBytes())}if(f!==null){var p=undefined;switch(s.signatureOid){case r.sha1WithRSAEncryption:p=undefined;break;case r["RSASSA-PSS"]:var d,v;d=r[s.signatureParameters.mgf.hash.algorithmOid];if(d===undefined||e.md[d]===undefined)throw{message:"Unsupported MGF hash function.",oid:s.signatureParameters.mgf.hash.algorithmOid,name:d};v=r[s.signatureParameters.mgf.algorithmOid];if(v===undefined||e.mgf[v]===undefined)throw{message:"Unsupported MGF function.",oid:s.signatureParameters.mgf.algorithmOid,name:v};v=e.mgf[v].create(e.md[d].create()),d=r[s.signatureParameters.hash.algorithmOid];if(d===undefined||e.md[d]===undefined)throw{message:"Unsupported RSASSA-PSS hash function.",oid:s.signatureParameters.hash.algorithmOid,name:d};p=e.pss.create(e.md[d].create(),v,s.signatureParameters.saltLength)}o=i.publicKey.verify(f.digest().getBytes(),s.signature,p)}return o},i.isIssuer=function(e){var t=!1,n=i.issuer,r=e.subject;if(n.hash&&r.hash)t=n.hash===r.hash;else if(n.attributes.length===r.attributes.length){t=!0;var s,o;for(var u=0;t&&u<n.attributes.length;++u){s=n.attributes[u],o=r.attributes[u];if(s.type!==o.type||s.value!==o.value)t=!1}}return t},i.issued=function(e){return e.isIssuer(i)},i.generateSubjectKeyIdentifier=function(){var r=t.toDer(n.publicKeyToRSAPublicKey(i.publicKey)),s=e.md.sha1.create();return s.update(r.getBytes()),s.digest()},i.verifySubjectKeyIdentifier=function(){var t=r.subjectKeyIdentifier;for(var n=0;n<i.extensions.length;++n){var s=i.extensions[n];if(s.id===t){var o=i.generateSubjectKeyIdentifier().getBytes();return e.util.hexToBytes(s.subjectKeyIdentifier)===o}}return!1},i},n.certificateFromAsn1=function(i,s){var u={},a=[];if(!t.validate(i,o,u,a))throw{message:"Cannot read X.509 certificate. ASN.1 object is not an X509v3 Certificate.",errors:a};if(typeof u.certSignature!="string"){var f="\0";for(var p=0;p<u.certSignature.length;++p)f+=t.toDer(u.certSignature[p]).getBytes();u.certSignature=f}var d=t.derToOid(u.publicKeyOid);if(d!==n.oids.rsaEncryption)throw{message:"Cannot read public key. OID is not RSA."};var v=n.createCertificate();v.version=u.certVersion?u.certVersion.charCodeAt(0):0;var g=e.util.createBuffer(u.certSerialNumber);v.serialNumber=g.toHex(),v.signatureOid=e.asn1.derToOid(u.certSignatureOid),v.signatureParameters=h(v.signatureOid,u.certSignatureParams,!0),v.siginfo.algorithmOid=e.asn1.derToOid(u.certinfoSignatureOid),v.siginfo.parameters=h(v.siginfo.algorithmOid,u.certinfoSignatureParams,!1);var y=e.util.createBuffer(u.certSignature);++y.read,v.signature=y.getBytes();var b=[];u.certValidity1UTCTime!==undefined&&b.push(t.utcTimeToDate(u.certValidity1UTCTime)),u.certValidity2GeneralizedTime!==undefined&&b.push(t.generalizedTimeToDate(u.certValidity2GeneralizedTime)),u.certValidity3UTCTime!==undefined&&b.push(t.utcTimeToDate(u.certValidity3UTCTime)),u.certValidity4GeneralizedTime!==undefined&&b.push(t.generalizedTimeToDate(u.certValidity4GeneralizedTime));if(b.length>2)throw{message:"Cannot read notBefore/notAfter validity times; more than two times were provided in the certificate."};if(b.length<2)throw{message:"Cannot read notBefore/notAfter validity times; they were not provided as either UTCTime or GeneralizedTime."};v.validity.notBefore=b[0],v.validity.notAfter=b[1],v.tbsCertificate=u.tbsCertificate;if(s){v.md=null;if(v.signatureOid in r){var d=r[v.signatureOid];switch(d){case"sha1WithRSAEncryption":v.md=e.md.sha1.create();break;case"md5WithRSAEncryption":v.md=e.md.md5.create();break;case"sha256WithRSAEncryption":v.md=e.md.sha256.create();break;case"RSASSA-PSS":v.md=e.md.sha256.create()}}if(v.md===null)throw{message:"Could not compute certificate digest. Unknown signature OID.",signatureOid:v.signatureOid};var w=t.toDer(v.tbsCertificate);v.md.update(w.getBytes())}var E=e.md.sha1.create();v.issuer.getField=function(e){return l(v.issuer,e)},v.issuer.addField=function(e){m([e]),v.issuer.attributes.push(e)},v.issuer.attributes=n.RDNAttributesAsArray(u.certIssuer,E),u.certIssuerUniqueId&&(v.issuer.uniqueId=u.certIssuerUniqueId),v.issuer.hash=E.digest().toHex();var S=e.md.sha1.create();return v.subject.getField=function(e){return l(v.subject,e)},v.subject.addField=function(e){m([e]),v.subject.attributes.push(e)},v.subject.attributes=n.RDNAttributesAsArray(u.certSubject,S),u.certSubjectUniqueId&&(v.subject.uniqueId=u.certSubjectUniqueId),v.subject.hash=S.digest().toHex(),u.certExtensions?v.extensions=c(u.certExtensions):v.extensions=[],v.publicKey=n.publicKeyFromAsn1(u.subjectPublicKeyInfo),v},n.certificationRequestFromAsn1=function(i,s){var o={},u=[];if(!t.validate(i,f,o,u))throw{message:"Cannot read PKCS#10 certificate request. ASN.1 object is not a PKCS#10 CertificationRequest.",errors:u};if(typeof o.csrSignature!="string"){var a="\0";for(var c=0;c<o.csrSignature.length;++c)a+=t.toDer(o.csrSignature[c]).getBytes();o.csrSignature=a}var p=t.derToOid(o.publicKeyOid);if(p!==n.oids.rsaEncryption)throw{message:"Cannot read public key. OID is not RSA."};var d=n.createCertificationRequest();d.version=o.csrVersion?o.csrVersion.charCodeAt(0):0,d.signatureOid=e.asn1.derToOid(o.csrSignatureOid),d.signatureParameters=h(d.signatureOid,o.csrSignatureParams,!0),d.siginfo.algorithmOid=e.asn1.derToOid(o.csrSignatureOid),d.siginfo.parameters=h(d.siginfo.algorithmOid,o.csrSignatureParams,!1);var v=e.util.createBuffer(o.csrSignature);++v.read,d.signature=v.getBytes(),d.certificationRequestInfo=o.certificationRequestInfo;if(s){d.md=null;if(d.signatureOid in r){var p=r[d.signatureOid];switch(p){case"sha1WithRSAEncryption":d.md=e.md.sha1.create();break;case"md5WithRSAEncryption":d.md=e.md.md5.create();break;case"sha256WithRSAEncryption":d.md=e.md.sha256.create();break;case"RSASSA-PSS":d.md=e.md.sha256.create()}}if(d.md===null)throw{message:"Could not compute certification request digest. Unknown signature OID.",signatureOid:d.signatureOid};var g=t.toDer(d.certificationRequestInfo);d.md.update(g.getBytes())}var y=e.md.sha1.create();return d.subject.getField=function(e){return l(d.subject,e)},d.subject.addField=function(e){m([e]),d.subject.attributes.push(e)},d.subject.attributes=n.RDNAttributesAsArray(o.certificationRequestInfoSubject,y),d.subject.hash=y.digest().toHex(),d.publicKey=n.publicKeyFromAsn1(o.subjectPublicKeyInfo),d.getAttribute=function(e){return l(d.attributes,e)},d.addAttribute=function(e){m([e]),d.attributes.push(e)},d.attributes=n.CRIAttributesAsArray(o.certificationRequestInfoAttributes||[]),d},n.createCertificationRequest=function(){var i={};return i.version=0,i.signatureOid=null,i.signature=null,i.siginfo={},i.siginfo.algorithmOid=null,i.subject={},i.subject.getField=function(e){return l(i.subject,e)},i.subject.addField=function(e){m([e]),i.subject.attributes.push(e)},i.subject.attributes=[],i.subject.hash=null,i.publicKey=null,i.attributes=[],i.getAttribute=function(e){return l(i.attributes,e)},i.addAttribute=function(e){m([e]),i.attributes.push(e)},i.md=null,i.setSubject=function(e){m(e),i.subject.attributes=e,i.subject.hash=null},i.setAttributes=function(e){m(e),i.attributes=e},i.sign=function(s,o){i.md=o||e.md.sha1.create();var u=r[i.md.algorithm+"WithRSAEncryption"];if(!u)throw{message:"Could not compute certification request digest. Unknown message digest algorithm OID.",algorithm:i.md.algorithm};i.signatureOid=i.siginfo.algorithmOid=u,i.certificationRequestInfo=n.getCertificationRequestInfo(i);var a=t.toDer(i.certificationRequestInfo);i.md.update(a.getBytes()),i.signature=s.sign(i.md)},i.verify=function(){var s=!1,o=i.md;if(o===null){if(i.signatureOid in r){var u=r[i.signatureOid];switch(u){case"sha1WithRSAEncryption":o=e.md.sha1.create();break;case"md5WithRSAEncryption":o=e.md.md5.create();break;case"sha256WithRSAEncryption":o=e.md.sha256.create();break;case"RSASSA-PSS":o=e.md.sha256.create()}}if(o===null)throw{message:"Could not compute certification request digest. Unknown signature OID.",signatureOid:i.signatureOid};var a=i.certificationRequestInfo||n.getCertificationRequestInfo(i),f=t.toDer(a);o.update(f.getBytes())}if(o!==null){var l;switch(i.signatureOid){case r.sha1WithRSAEncryption:break;case r["RSASSA-PSS"]:var c,h;c=r[i.signatureParameters.mgf.hash.algorithmOid];if(c===undefined||e.md[c]===undefined)throw{message:"Unsupported MGF hash function.",oid:i.signatureParameters.mgf.hash.algorithmOid,name:c};h=r[i.signatureParameters.mgf.algorithmOid];if(h===undefined||e.mgf[h]===undefined)throw{message:"Unsupported MGF function.",oid:i.signatureParameters.mgf.algorithmOid,name:h};h=e.mgf[h].create(e.md[c].create()),c=r[i.signatureParameters.hash.algorithmOid];if(c===undefined||e.md[c]===undefined)throw{message:"Unsupported RSASSA-PSS hash function.",oid:i.signatureParameters.hash.algorithmOid,name:c};l=e.pss.create(e.md[c].create(),h,i.signatureParameters.saltLength)}s=i.publicKey.verify(o.digest().getBytes(),i.signature,l)}return s},i},n.getTBSCertificate=function(r){var i=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.CONTEXT_SPECIFIC,0,!0,[t.create(t.Class.UNIVERSAL,t.Type.INTEGER,!1,t.integerToDer(r.version).getBytes())]),t.create(t.Class.UNIVERSAL,t.Type.INTEGER,!1,e.util.hexToBytes(r.serialNumber)),t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(r.siginfo.algorithmOid).getBytes()),g(r.siginfo.algorithmOid,r.siginfo.parameters)]),p(r.issuer),t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.UTCTIME,!1,t.dateToUtcTime(r.validity.notBefore)),t.create(t.Class.UNIVERSAL,t.Type.UTCTIME,!1,t.dateToUtcTime(r.validity.notAfter))]),p(r.subject),n.publicKeyToAsn1(r.publicKey)]);return r.issuer.uniqueId&&i.value.push(t.create(t.Class.CONTEXT_SPECIFIC,1,!0,[t.create(t.Class.UNIVERSAL,t.Type.BITSTRING,!1,String.fromCharCode(0)+r.issuer.uniqueId)])),r.subject.uniqueId&&i.value.push(t.create(t.Class.CONTEXT_SPECIFIC,2,!0,[t.create(t.Class.UNIVERSAL,t.Type.BITSTRING,!1,String.fromCharCode(0)+r.subject.uniqueId)])),r.extensions.length>0&&i.value.push(d(r.extensions)),i},n.getCertificationRequestInfo=function(e){var r=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.INTEGER,!1,t.integerToDer(e.version).getBytes()),p(e.subject),n.publicKeyToAsn1(e.publicKey),y(e)]);return r},n.distinguishedNameToAsn1=function(e){return p(e)},n.certificateToAsn1=function(e){var r=e.tbsCertificate||n.getTBSCertificate(e);return t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[r,t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(e.signatureOid).getBytes()),g(e.signatureOid,e.signatureParameters)]),t.create(t.Class.UNIVERSAL,t.Type.BITSTRING,!1,String.fromCharCode(0)+e.signature)])},n.certificationRequestToAsn1=function(e){var r=e.certificationRequestInfo||n.getCertificationRequestInfo(e);return t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[r,t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(e.signatureOid).getBytes()),g(e.signatureOid,e.signatureParameters)]),t.create(t.Class.UNIVERSAL,t.Type.BITSTRING,!1,String.fromCharCode(0)+e.signature)])},n.createCaStore=function(t){var r={certs:{}};r.getIssuer=function(t){var i=null;if(!t.issuer.hash){var s=e.md.sha1.create();t.issuer.attributes=n.RDNAttributesAsArray(p(t.issuer),s),t.issuer.hash=s.digest().toHex()}if(t.issuer.hash in r.certs){i=r.certs[t.issuer.hash];if(e.util.isArray(i))throw{message:"Resolving multiple issuer matches not implemented yet."}}return i},r.addCertificate=function(t){typeof t=="string"&&(t=e.pki.certificateFromPem(t));if(!t.subject.hash){var i=e.md.sha1.create();t.subject.attributes=n.RDNAttributesAsArray(p(t.subject),i),t.subject.hash=i.digest().toHex()}if(t.subject.hash in r.certs){var s=r.certs[t.subject.hash];e.util.isArray(s)||(s=[s]),s.push(t)}else r.certs[t.subject.hash]=t};if(t)for(var i=0;i<t.length;++i){var s=t[i];r.addCertificate(s)}return r},n.certificateError={bad_certificate:"forge.pki.BadCertificate",unsupported_certificate:"forge.pki.UnsupportedCertificate",certificate_revoked:"forge.pki.CertificateRevoked",certificate_expired:"forge.pki.CertificateExpired",certificate_unknown:"forge.pki.CertificateUnknown",unknown_ca:"forge.pki.UnknownCertificateAuthority"},n.verifyCertificateChain=function(t,r,i){r=r.slice(0);var s=r.slice(0),o=new Date,u=!0,a=null,f=0,l=null;do{var c=r.shift();if(o<c.validity.notBefore||o>c.validity.notAfter)a={message:"Certificate is not valid yet or has expired.",error:n.certificateError.certificate_expired,notBefore:c.validity.notBefore,notAfter:c.validity.notAfter,now:o};else{var h=!1;if(r.length>0){l=r[0];try{h=l.verify(c)}catch(p){}}else{var d=t.getIssuer(c);if(d===null)a={message:"Certificate is not trusted.",error:n.certificateError.unknown_ca};else{e.util.isArray(d)||(d=[d]);while(!h&&d.length>0){l=d.shift();try{h=l.verify(c)}catch(p){}}}}a===null&&!h&&(a={message:"Certificate signature is invalid.",error:n.certificateError.bad_certificate})}a===null&&!c.isIssuer(l)&&(a={message:"Certificate issuer is invalid.",error:n.certificateError.bad_certificate});if(a===null){var v={keyUsage:!0,basicConstraints:!0};for(var m=0;a===null&&m<c.extensions.length;++m){var g=c.extensions[m];g.critical&&!(g.name in v)&&(a={message:"Certificate has an unsupported critical extension.",error:n.certificateError.unsupported_certificate})}}if(!u||r.length===0&&!l){var y=c.getExtension("basicConstraints"),b=c.getExtension("keyUsage");b!==null&&(!b.keyCertSign||y===null)&&(a={message:"Certificate keyUsage or basicConstraints conflict or indicate that the certificate is not a CA. If the certificate is the only one in the chain or isn't the first then the certificate must be a valid CA.",error:n.certificateError.bad_certificate}),a===null&&y!==null&&!y.cA&&(a={message:"Certificate basicConstraints indicates the certificate is not a CA.",error:n.certificateError.bad_certificate});if(a===null&&b!==null&&"pathLenConstraint"in y){var w=0;for(var m=1;m<r.length-1;++m)r[m].isIssuer(r[m])&&++w;var E=y.pathLenConstraint+1;r.length-w>E&&(a={message:"Certificate basicConstraints pathLenConstraint violated.",error:n.certificateError.bad_certificate})}}var S=a===null?!0:a.error,x=i?i(S,f,s):S;if(x!==!0){S===!0&&(a={message:"The application rejected the certificate.",error:n.certificateError.bad_certificate});if(x||x===0)typeof x=="object"&&!e.util.isArray(x)?(x.message&&(a.message=x.message),x.error&&(a.error=x.error)):typeof x=="string"&&(a.error=x);throw a}a=null,u=!1,++f}while(r.length>0);return!0}}var r="x509";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n.pki}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/x509",["require","module","./aes","./asn1","./des","./md","./mgf","./oids","./pem","./pss","./rsa","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){function f(e,t,n,r){var i=[];for(var s=0;s<e.length;s++)for(var o=0;o<e[s].safeBags.length;o++){var u=e[s].safeBags[o];if(r!==undefined&&u.type!==r)continue;if(t===null){i.push(u);continue}u.attributes[t]!==undefined&&u.attributes[t].indexOf(n)>=0&&i.push(u)}return i}function l(e,r,s,o){r=t.fromDer(r,s);if(r.tagClass!==t.Class.UNIVERSAL||r.type!==t.Type.SEQUENCE||r.constructed!==!0)throw{message:"PKCS#12 AuthenticatedSafe expected to be a SEQUENCE OF ContentInfo"};for(var u=0;u<r.value.length;u++){var a=r.value[u],f={},l=[];if(!t.validate(a,i,f,l))throw{message:"Cannot read ContentInfo.",errors:l};var p={encrypted:!1},d=null,v=f.content.value[0];switch(t.derToOid(f.contentType)){case n.oids.data:if(v.tagClass!==t.Class.UNIVERSAL||v.type!==t.Type.OCTETSTRING)throw{message:"PKCS#12 SafeContents Data is not an OCTET STRING."};d=v.value;break;case n.oids.encryptedData:if(o===undefined)throw{message:"Found PKCS#12 Encrypted SafeContents Data but no password available."};d=c(v,o),p.encrypted=!0;break;default:throw{message:"Unsupported PKCS#12 contentType.",contentType:t.derToOid(f.contentType)}}p.safeBags=h(d,s,o),e.safeContents.push(p)}}function c(r,i){var s={},o=[];if(!t.validate(r,e.pkcs7.asn1.encryptedDataValidator,s,o))throw{message:"Cannot read EncryptedContentInfo. ",errors:o};var u=t.derToOid(s.contentType);if(u!==n.oids.data)throw{message:"PKCS#12 EncryptedContentInfo ContentType is not Data.",oid:u};u=t.derToOid(s.encAlgorithm);var a=n.pbe.getCipher(u,s.encParameter,i),f=e.util.createBuffer(s.encryptedContent);a.update(f);if(!a.finish())throw{message:"Failed to decrypt PKCS#12 SafeContents."};return a.output.getBytes()}function h(e,r,i){e=t.fromDer(e,r);if(e.tagClass!==t.Class.UNIVERSAL||e.type!==t.Type.SEQUENCE||e.constructed!==!0)throw{message:"PKCS#12 SafeContents expected to be a SEQUENCE OF SafeBag"};var s=[];for(var u=0;u<e.value.length;u++){var f=e.value[u],l={},c=[];if(!t.validate(f,o,l,c))throw{message:"Cannot read SafeBag.",errors:c};var h={type:t.derToOid(l.bagId),attributes:p(l.bagAttributes)};s.push(h);var d,v,m=l.bagValue.value[0];switch(h.type){case n.oids.pkcs8ShroudedKeyBag:if(i===undefined)throw{message:"Found PKCS#8 ShroudedKeyBag but no password available."};m=n.decryptPrivateKeyInfo(m,i);if(m===null)throw{message:"Unable to decrypt PKCS#8 ShroudedKeyBag, wrong password?"};case n.oids.keyBag:h.key=n.privateKeyFromAsn1(m);continue;case n.oids.certBag:d=a,v=function(){if(t.derToOid(l.certId)!==n.oids.x509Certificate)throw{message:"Unsupported certificate type, only X.509 supported.",oid:t.derToOid(l.certId)};h.cert=n.certificateFromAsn1(t.fromDer(l.cert,r),!0)};break;default:throw{message:"Unsupported PKCS#12 SafeBag type.",oid:h.type}}if(d!==undefined&&!t.validate(m,d,l,c))throw{message:"Cannot read PKCS#12 "+d.name,errors:c};v()}return s}function p(e){var r={};if(e!==undefined)for(var i=0;i<e.length;++i){var s={},o=[];if(!t.validate(e[i],u,s,o))throw{message:"Cannot read PKCS#12 BagAttribute.",errors:o};var a=t.derToOid(s.oid);if(n.oids[a]===undefined)continue;r[n.oids[a]]=[];for(var f=0;f<s.values.length;++f)r[n.oids[a]].push(s.values[f].value)}return r}var t=e.asn1,n=e.pki,r=e.pkcs12=e.pkcs12||{},i={name:"ContentInfo",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"ContentInfo.contentType",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1,capture:"contentType"},{name:"ContentInfo.content",tagClass:t.Class.CONTEXT_SPECIFIC,constructed:!0,captureAsn1:"content"}]},s={name:"PFX",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"PFX.version",tagClass:t.Class.UNIVERSAL,type:t.Type.INTEGER,constructed:!1,capture:"version"},i,{name:"PFX.macData",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,optional:!0,captureAsn1:"mac",value:[{name:"PFX.macData.mac",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"PFX.macData.mac.digestAlgorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"PFX.macData.mac.digestAlgorithm.algorithm",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1,capture:"macAlgorithm"},{name:"PFX.macData.mac.digestAlgorithm.parameters",tagClass:t.Class.UNIVERSAL,captureAsn1:"macAlgorithmParameters"}]},{name:"PFX.macData.mac.digest",tagClass:t.Class.UNIVERSAL,type:t.Type.OCTETSTRING,constructed:!1,capture:"macDigest"}]},{name:"PFX.macData.macSalt",tagClass:t.Class.UNIVERSAL,type:t.Type.OCTETSTRING,constructed:!1,capture:"macSalt"},{name:"PFX.macData.iterations",tagClass:t.Class.UNIVERSAL,type:t.Type.INTEGER,constructed:!1,optional:!0,capture:"macIterations"}]}]},o={name:"SafeBag",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"SafeBag.bagId",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1,capture:"bagId"},{name:"SafeBag.bagValue",tagClass:t.Class.CONTEXT_SPECIFIC,constructed:!0,captureAsn1:"bagValue"},{name:"SafeBag.bagAttributes",tagClass:t.Class.UNIVERSAL,type:t.Type.SET,constructed:!0,optional:!0,capture:"bagAttributes"}]},u={name:"Attribute",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"Attribute.attrId",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1,capture:"oid"},{name:"Attribute.attrValues",tagClass:t.Class.UNIVERSAL,type:t.Type.SET,constructed:!0,capture:"values"}]},a={name:"CertBag",tagClass:t.Class.UNIVERSAL,type:t.Type.SEQUENCE,constructed:!0,value:[{name:"CertBag.certId",tagClass:t.Class.UNIVERSAL,type:t.Type.OID,constructed:!1,capture:"certId"},{name:"CertBag.certValue",tagClass:t.Class.CONTEXT_SPECIFIC,constructed:!0,value:[{name:"CertBag.certValue[0]",tagClass:t.Class.UNIVERSAL,type:t.Class.OCTETSTRING,constructed:!1,capture:"cert"}]}]};r.pkcs12FromAsn1=function(i,o,u){typeof o=="string"?(u=o,o=!0):o===undefined&&(o=!0);var a={},c=[];if(!t.validate(i,s,a,c))throw{message:"Cannot read PKCS#12 PFX. ASN.1 object is not an PKCS#12 PFX.",errors:c};var h={version:a.version.charCodeAt(0),safeContents:[],getBags:function(t){var n={},r;return"localKeyId"in t?r=t.localKeyId:"localKeyIdHex"in t&&(r=e.util.hexToBytes(t.localKeyIdHex)),r===undefined&&!("friendlyName"in t)&&"bagType"in t&&(n[t.bagType]=f(h.safeContents,null,null,t.bagType)),r!==undefined&&(n.localKeyId=f(h.safeContents,"localKeyId",r,t.bagType)),"friendlyName"in t&&(n.friendlyName=f(h.safeContents,"friendlyName",t.friendlyName,t.bagType)),n},getBagsByFriendlyName:function(e,t){return f(h.safeContents,"friendlyName",e,t)},getBagsByLocalKeyId:function(e,t){return f(h.safeContents,"localKeyId",e,t)}};if(a.version.charCodeAt(0)!==3)throw{message:"PKCS#12 PFX of version other than 3 not supported.",version:a.version.charCodeAt(0)};if(t.derToOid(a.contentType)!==n.oids.data)throw{message:"Only PKCS#12 PFX in password integrity mode supported.",oid:t.derToOid(a.contentType)};var p=a.content.value[0];if(p.tagClass!==t.Class.UNIVERSAL||p.type!==t.Type.OCTETSTRING)throw{message:"PKCS#12 authSafe content data is not an OCTET STRING."};if(a.mac){var d=null,v=0,m=t.derToOid(a.macAlgorithm);switch(m){case n.oids.sha1:d=e.md.sha1.create(),v=20;break;case n.oids.sha256:d=e.md.sha256.create(),v=32;break;case n.oids.sha384:d=e.md.sha384.create(),v=48;break;case n.oids.sha512:d=e.md.sha512.create(),v=64;break;case n.oids.md5:d=e.md.md5.create(),v=16}if(d===null)throw{message:"PKCS#12 uses unsupported MAC algorithm: "+m};var g=new e.util.ByteBuffer(a.macSalt),y="macIterations"in a?parseInt(e.util.bytesToHex(a.macIterations),16):1,b=r.generateKey(u||"",g,3,y,v,d),w=e.hmac.create();w.start(d,b),w.update(p.value);var E=w.getMac();if(E.getBytes()!==a.macDigest)throw{message:"PKCS#12 MAC could not be verified. Invalid password?"}}return l(h,p.value,o,u),h},r.toPkcs12Asn1=function(i,s,o,u){u=u||{},u.saltSize=u.saltSize||8,u.count=u.count||2048,u.algorithm=u.algorithm||u.encAlgorithm||"aes128","useMac"in u||(u.useMac=!0),"localKeyId"in u||(u.localKeyId=null),"generateLocalKeyId"in u||(u.generateLocalKeyId=!0);var a=u.localKeyId,f;if(a!==null)a=e.util.hexToBytes(a);else if(u.generateLocalKeyId)if(s){var l=e.util.isArray(s)?s[0]:s;typeof l=="string"&&(l=n.certificateFromPem(l));var c=e.md.sha1.create();c.update(t.toDer(n.certificateToAsn1(l)).getBytes()),a=c.digest().getBytes()}else a=e.random.getBytes(20);var h=[];a!==null&&h.push(t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(n.oids.localKeyId).getBytes()),t.create(t.Class.UNIVERSAL,t.Type.SET,!0,[t.create(t.Class.UNIVERSAL,t.Type.OCTETSTRING,!1,a)])])),"friendlyName"in u&&h.push(t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(n.oids.friendlyName).getBytes()),t.create(t.Class.UNIVERSAL,t.Type.SET,!0,[t.create(t.Class.UNIVERSAL,t.Type.BMPSTRING,!1,u.friendlyName)])])),h.length>0&&(f=t.create(t.Class.UNIVERSAL,t.Type.SET,!0,h));var p=[],d=[];s!==null&&(e.util.isArray(s)?d=s:d=[s]);var v=[];for(var m=0;m<d.length;++m){s=d[m],typeof s=="string"&&(s=n.certificateFromPem(s));var g=m===0?f:undefined,y=n.certificateToAsn1(s),b=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(n.oids.certBag).getBytes()),t.create(t.Class.CONTEXT_SPECIFIC,0,!0,[t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(n.oids.x509Certificate).getBytes()),t.create(t.Class.CONTEXT_SPECIFIC,0,!0,[t.create(t.Class.UNIVERSAL,t.Type.OCTETSTRING,!1,t.toDer(y).getBytes())])])]),g]);v.push(b)}if(v.length>0){var w=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,v),E=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(n.oids.data).getBytes()),t.create(t.Class.CONTEXT_SPECIFIC,0,!0,[t.create(t.Class.UNIVERSAL,t.Type.OCTETSTRING,!1,t.toDer(w).getBytes())])]);p.push(E)}var S=null;if(i!==null){var x=n.wrapRsaPrivateKey(n.privateKeyToAsn1(i));o===null?S=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(n.oids.keyBag).getBytes()),t.create(t.Class.CONTEXT_SPECIFIC,0,!0,[x]),f]):S=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(n.oids.pkcs8ShroudedKeyBag).getBytes()),t.create(t.Class.CONTEXT_SPECIFIC,0,!0,[n.encryptPrivateKeyInfo(x,o,u)]),f]);var T=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[S]),N=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(n.oids.data).getBytes()),t.create(t.Class.CONTEXT_SPECIFIC,0,!0,[t.create(t.Class.UNIVERSAL,t.Type.OCTETSTRING,!1,t.toDer(T).getBytes())])]);p.push(N)}var C=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,p),k;if(u.useMac){var c=e.md.sha1.create(),L=new e.util.ByteBuffer(e.random.getBytes(u.saltSize)),A=u.count,i=r.generateKey(o||"",L,3,A,20),O=e.hmac.create();O.start(c,i),O.update(t.toDer(C).getBytes());var M=O.getMac();k=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(n.oids.sha1).getBytes()),t.create(t.Class.UNIVERSAL,t.Type.NULL,!1,"")]),t.create(t.Class.UNIVERSAL,t.Type.OCTETSTRING,!1,M.getBytes())]),t.create(t.Class.UNIVERSAL,t.Type.OCTETSTRING,!1,L.getBytes()),t.create(t.Class.UNIVERSAL,t.Type.INTEGER,!1,t.integerToDer(A).getBytes())])}return t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.INTEGER,!1,t.integerToDer(3).getBytes()),t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(n.oids.data).getBytes()),t.create(t.Class.CONTEXT_SPECIFIC,0,!0,[t.create(t.Class.UNIVERSAL,t.Type.OCTETSTRING,!1,t.toDer(C).getBytes())])]),k])},r.generateKey=e.pbe.generatePkcs12Key}var r="pkcs12";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/pkcs12",["require","module","./asn1","./hmac","./oids","./pkcs7asn1","./pbe","./random","./rsa","./sha1","./util","./x509"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){var t=e.asn1,n=e.pki=e.pki||{};n.pemToDer=function(t){var n=e.pem.decode(t)[0];if(n.procType&&n.procType.type==="ENCRYPTED")throw{message:"Could not convert PEM to DER; PEM is encrypted."};return e.util.createBuffer(n.body)},n.privateKeyFromPem=function(r){var i=e.pem.decode(r)[0];if(i.type!=="PRIVATE KEY"&&i.type!=="RSA PRIVATE KEY")throw{message:'Could not convert private key from PEM; PEM header type is not "PRIVATE KEY" or "RSA PRIVATE KEY".',headerType:i.type};if(i.procType&&i.procType.type==="ENCRYPTED")throw{message:"Could not convert private key from PEM; PEM is encrypted."};var s=t.fromDer(i.body);return n.privateKeyFromAsn1(s)},n.privateKeyToPem=function(r,i){var s={type:"RSA PRIVATE KEY",body:t.toDer(n.privateKeyToAsn1(r)).getBytes()};return e.pem.encode(s,{maxline:i})},n.privateKeyInfoToPem=function(n,r){var i={type:"PRIVATE KEY",body:t.toDer(n).getBytes()};return e.pem.encode(i,{maxline:r})}}var r="pki";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/pki",["require","module","./asn1","./oids","./pbe","./pem","./pbkdf2","./pkcs12","./pss","./rsa","./util","./x509"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){var t=function(t,n,r,i){var s=e.util.createBuffer(),o=t.length>>1,u=o+(t.length&1),a=t.substr(0,u),f=t.substr(o,u),l=e.util.createBuffer(),c=e.hmac.create();r=n+r;var h=Math.ceil(i/16),p=Math.ceil(i/20);c.start("MD5",a);var d=e.util.createBuffer();l.putBytes(r);for(var v=0;v<h;++v)c.start(null,null),c.update(l.getBytes()),l.putBuffer(c.digest()),c.start(null,null),c.update(l.bytes()+r),d.putBuffer(c.digest());c.start("SHA1",f);var m=e.util.createBuffer();l.clear(),l.putBytes(r);for(var v=0;v<p;++v)c.start(null,null),c.update(l.getBytes()),l.putBuffer(c.digest()),c.start(null,null),c.update(l.bytes()+r),m.putBuffer(c.digest());return s.putBytes(e.util.xorBytes(d.getBytes(),m.getBytes(),i)),s},n=function(e,t,n,r){},r=function(t,n,r){var i=e.hmac.create();i.start("SHA1",t);var s=e.util.createBuffer();return s.putInt32(n[0]),s.putInt32(n[1]),s.putByte(r.type),s.putByte(r.version.major),s.putByte(r.version.minor),s.putInt16(r.length),s.putBytes(r.fragment.bytes()),i.update(s.getBytes()),i.digest().getBytes()},i=function(t,n,r){var i=!1;try{var s=t.deflate(n.fragment.getBytes());n.fragment=e.util.createBuffer(s),n.length=s.length,i=!0}catch(o){}return i},s=function(t,n,r){var i=!1;try{var s=t.inflate(n.fragment.getBytes());n.fragment=e.util.createBuffer(s),n.length=s.length,i=!0}catch(o){}return i},o=function(t,n){var r=0;switch(n){case 1:r=t.getByte();break;case 2:r=t.getInt16();break;case 3:r=t.getInt24();break;case 4:r=t.getInt32()}return e.util.createBuffer(t.getBytes(r))},u=function(e,t,n){e.putInt(n.length(),t<<3),e.putBuffer(n)},a={};a.Version={major:3,minor:1},a.MaxFragment=15360,a.ConnectionEnd={server:0,client:1},a.PRFAlgorithm={tls_prf_sha256:0},a.BulkCipherAlgorithm={none:null,rc4:0,des3:1,aes:2},a.CipherType={stream:0,block:1,aead:2},a.MACAlgorithm={none:null,hmac_md5:0,hmac_sha1:1,hmac_sha256:2,hmac_sha384:3,hmac_sha512:4},a.CompressionMethod={none:0,deflate:1},a.ContentType={change_cipher_spec:20,alert:21,handshake:22,application_data:23,heartbeat:24},a.HandshakeType={hello_request:0,client_hello:1,server_hello:2,certificate:11,server_key_exchange:12,certificate_request:13,server_hello_done:14,certificate_verify:15,client_key_exchange:16,finished:20},a.Alert={},a.Alert.Level={warning:1,fatal:2},a.Alert.Description={close_notify:0,unexpected_message:10,bad_record_mac:20,decryption_failed:21,record_overflow:22,decompression_failure:30,handshake_failure:40,bad_certificate:42,unsupported_certificate:43,certificate_revoked:44,certificate_expired:45,certificate_unknown:46,illegal_parameter:47,unknown_ca:48,access_denied:49,decode_error:50,decrypt_error:51,export_restriction:60,protocol_version:70,insufficient_security:71,internal_error:80,user_canceled:90,no_renegotiation:100},a.HeartbeatMessageType={heartbeat_request:1,heartbeat_response:2},a.CipherSuites={},a.getCipherSuite=function(e){var t=null;for(var n in a.CipherSuites){var r=a.CipherSuites[n];if(r.id[0]===e.charCodeAt(0)&&r.id[1]===e.charCodeAt(1)){t=r;break}}return t},a.handleUnexpected=function(e,t){var n=!e.open&&e.entity===a.ConnectionEnd.client;n||e.error(e,{message:"Unexpected message. Received TLS record out of order.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.unexpected_message}})},a.handleHelloRequest=function(e,t,n){!e.handshaking&&e.handshakes>0&&(a.queue(e,a.createAlert({level:a.Alert.Level.warning,description:a.Alert.Description.no_renegotiation})),a.flush(e)),e.process()},a.parseHelloMessage=function(t,n,r){var i=null,s=t.entity===a.ConnectionEnd.client;if(r<38)t.error(t,{message:s?"Invalid ServerHello message. Message too short.":"Invalid ClientHello message. Message too short.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.illegal_parameter}});else{var u=n.fragment,f=u.length();i={version:{major:u.getByte(),minor:u.getByte()},random:e.util.createBuffer(u.getBytes(32)),session_id:o(u,1),extensions:[]},s?(i.cipher_suite=u.getBytes(2),i.compression_method=u.getByte()):(i.cipher_suites=o(u,2),i.compression_methods=o(u,1)),f=r-(f-u.length());if(f>0){var l=o(u,2);while(l.length()>0)i.extensions.push({type:[l.getByte(),l.getByte()],data:o(l,2)});if(!s)for(var c=0;c<i.extensions.length;++c){var h=i.extensions[c];if(h.type[0]===0&&h.type[1]===0){var p=o(h.data,2);while(p.length()>0){var d=p.getByte();if(d!==0)break;t.session.serverNameList.push(o(p,2).getBytes())}}}}(i.version.major!==a.Version.major||i.version.minor!==a.Version.minor)&&t.error(t,{message:"Incompatible TLS version.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.protocol_version}});if(s)t.session.cipherSuite=a.getCipherSuite(i.cipher_suite);else{var v=e.util.createBuffer(i.cipher_suites.bytes());while(v.length()>0){t.session.cipherSuite=a.getCipherSuite(v.getBytes(2));if(t.session.cipherSuite!==null)break}}if(t.session.cipherSuite===null)return t.error(t,{message:"No cipher suites in common.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.handshake_failure},cipherSuite:e.util.bytesToHex(i.cipher_suite)});s?t.session.compressionMethod=i.compression_method:t.session.compressionMethod=a.CompressionMethod.none}return i},a.createSecurityParameters=function(e,t){var n=e.entity===a.ConnectionEnd.client,r=t.random.bytes(),i=n?e.session.sp.client_random:r,s=n?r:a.createRandom().getBytes();e.session.sp={entity:e.entity,prf_algorithm:a.PRFAlgorithm.tls_prf_sha256,bulk_cipher_algorithm:null,cipher_type:null,enc_key_length:null,block_length:null,fixed_iv_length:null,record_iv_length:null,mac_algorithm:null,mac_length:null,mac_key_length:null,compression_algorithm:e.session.compressionMethod,pre_master_secret:null,master_secret:null,client_random:i,server_random:s}},a.handleServerHello=function(e,t,n){var r=a.parseHelloMessage(e,t,n);if(!e.fail){var i=r.session_id.bytes();i.length>0&&i===e.session.id?(e.expect=d,e.session.resuming=!0,e.session.sp.server_random=r.random.bytes()):(e.expect=l,e.session.resuming=!1,a.createSecurityParameters(e,r)),e.session.id=i,e.process()}},a.handleClientHello=function(t,n,r){var i=a.parseHelloMessage(t,n,r);if(!t.fail){var s=i.session_id.bytes(),o=null;t.sessionCache&&(o=t.sessionCache.getSession(s),o===null&&(s="")),s.length===0&&(s=e.random.getBytes(32)),t.session.id=s,t.session.clientHelloVersion=i.version,t.session.sp=o?o.sp:{},o!==null?(t.expect=S,t.session.resuming=!0,t.session.sp.client_random=i.random.bytes()):(t.expect=t.verifyClient!==!1?b:w,t.session.resuming=!1,a.createSecurityParameters(t,i)),t.open=!0,a.queue(t,a.createRecord({type:a.ContentType.handshake,data:a.createServerHello(t)})),t.session.resuming?(a.queue(t,a.createRecord({type:a.ContentType.change_cipher_spec,data:a.createChangeCipherSpec()})),t.state.pending=a.createConnectionState(t),t.state.current.write=t.state.pending.write,a.queue(t,a.createRecord({type:a.ContentType.handshake,data:a.createFinished(t)}))):(a.queue(t,a.createRecord({type:a.ContentType.handshake,data:a.createCertificate(t)})),t.fail||(a.queue(t,a.createRecord({type:a.ContentType.handshake,data:a.createServerKeyExchange(t)})),t.verifyClient!==!1&&a.queue(t,a.createRecord({type:a.ContentType.handshake,data:a.createCertificateRequest(t)})),a.queue(t,a.createRecord({type:a.ContentType.handshake,data:a.createServerHelloDone(t)})))),a.flush(t),t.process()}},a.handleCertificate=function(t,n,r){if(r<3)t.error(t,{message:"Invalid Certificate message. Message too short.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.illegal_parameter}});else{var i=n.fragment,s={certificate_list:o(i,3)},u,f,l=[];try{while(s.certificate_list.length()>0)u=o(s.certificate_list,3),f=e.asn1.fromDer(u),u=e.pki.certificateFromAsn1(f,!0),l.push(u)}catch(h){t.error(t,{message:"Could not parse certificate list.",cause:h,send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.bad_certificate}})}if(!t.fail){var p=t.entity===a.ConnectionEnd.client;!p&&t.verifyClient!==!0||l.length!==0?l.length===0?t.expect=p?c:w:(p?t.session.serverCertificate=l[0]:t.session.clientCertificate=l[0],a.verifyCertificateChain(t,l)&&(t.expect=p?c:w)):t.error(t,{message:p?"No server certificate provided.":"No client certificate provided.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.illegal_parameter}}),t.process()}}},a.handleServerKeyExchange=function(e,t,n){n>0?e.error(e,{message:"Invalid key parameters. Only RSA is supported.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.unsupported_certificate}}):(e.expect=h,e.process())},a.handleClientKeyExchange=function(t,n,r){if(r<48)t.error(t,{message:"Invalid key parameters. Only RSA is supported.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.unsupported_certificate}});else{var i=n.fragment,s={enc_pre_master_secret:o(i,2).getBytes()},u=null;if(t.getPrivateKey)try{u=t.getPrivateKey(t,t.session.serverCertificate),u=e.pki.privateKeyFromPem(u)}catch(f){t.error(t,{message:"Could not get private key.",cause:f,send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.internal_error}})}if(u===null)t.error(t,{message:"No private key set.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.internal_error}});else try{var l=t.session.sp;l.pre_master_secret=u.decrypt(s.enc_pre_master_secret);var c=t.session.clientHelloVersion;if(c.major!==l.pre_master_secret.charCodeAt(0)||c.minor!==l.pre_master_secret.charCodeAt(1))throw{message:"TLS version rollback attack detected."}}catch(f){l.pre_master_secret=e.random.getBytes(48)}}t.fail||(t.expect=S,t.session.clientCertificate!==null&&(t.expect=E),t.process())},a.handleCertificateRequest=function(e,t,n){if(n<3)e.error(e,{message:"Invalid CertificateRequest. Message too short.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.illegal_parameter}});else{var r=t.fragment,i={certificate_types:o(r,1),certificate_authorities:o(r,2)};e.session.certificateRequest=i,e.expect=p,e.process()}},a.handleCertificateVerify=function(t,n,r){if(r<2)t.error(t,{message:"Invalid CertificateVerify. Message too short.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.illegal_parameter}});else{var i=n.fragment;i.read-=4;var s=i.bytes();i.read+=4;var u={signature:o(i,2).getBytes()},f=e.util.createBuffer();f.putBuffer(t.session.md5.digest()),f.putBuffer(t.session.sha1.digest()),f=f.getBytes();try{var l=t.session.clientCertificate;if(!l.publicKey.verify(f,u.signature,"NONE"))throw{message:"CertificateVerify signature does not match."};t.session.md5.update(s),t.session.sha1.update(s)}catch(c){t.error(t,{message:"Bad signature in CertificateVerify.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.handshake_failure}})}t.fail||(t.expect=S,t.process())}},a.handleServerHelloDone=function(t,n,r){if(r>0)t.error(t,{message:"Invalid ServerHelloDone message. Invalid length.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.record_overflow}});else if(t.serverCertificate===null){var i={message:"No server certificate provided. Not enough security.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.insufficient_security}},s=t.verify(t,i.alert.description,depth,[]);if(s===!0)i=null;else{if(s||s===0)typeof s=="object"&&!e.util.isArray(s)?(s.message&&(i.message=s.message),s.alert&&(i.alert.description=s.alert)):typeof s=="number"&&(i.alert.description=s);t.error(t,i)}}!t.fail&&t.session.certificateRequest!==null&&(n=a.createRecord({type:a.ContentType.handshake,data:a.createCertificate(t)}),a.queue(t,n));if(!t.fail){n=a.createRecord({type:a.ContentType.handshake,data:a.createClientKeyExchange(t)}),a.queue(t,n),t.expect=g;var o=function(e,t){e.session.certificateRequest!==null&&e.session.clientCertificate!==null&&a.queue(e,a.createRecord({type:a.ContentType.handshake,data:a.createCertificateVerify(e,t)})),a.queue(e,a.createRecord({type:a.ContentType.change_cipher_spec,data:a.createChangeCipherSpec()})),e.state.pending=a.createConnectionState(e),e.state.current.write=e.state.pending.write,a.queue(e,a.createRecord({type:a.ContentType.handshake,data:a.createFinished(e)})),e.expect=d,a.flush(e),e.process()};t.session.certificateRequest===null||t.session.clientCertificate===null?o(t,null):a.getClientSignature(t,o)}},a.handleChangeCipherSpec=function(e,t){if(t.fragment.getByte()!==1)e.error(e,{message:"Invalid ChangeCipherSpec message received.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.illegal_parameter}});else{var n=e.entity===a.ConnectionEnd.client;if(e.session.resuming&&n||!e.session.resuming&&!n)e.state.pending=a.createConnectionState(e);e.state.current.read=e.state.pending.read;if(!e.session.resuming&&n||e.session.resuming&&!n)e.state.pending=null;e.expect=n?v:x,e.process()}},a.handleFinished=function(n,r,i){var s=r.fragment;s.read-=4;var o=s.bytes();s.read+=4;var u=r.fragment.getBytes();s=e.util.createBuffer(),s.putBuffer(n.session.md5.digest()),s.putBuffer(n.session.sha1.digest());var f=n.entity===a.ConnectionEnd.client,l=f?"server finished":"client finished",c=n.session.sp,h=12,p=t;s=p(c.master_secret,l,s.getBytes(),h);if(s.getBytes()!==u)n.error(n,{message:"Invalid verify_data in Finished message.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.decrypt_error}});else{n.session.md5.update(o),n.session.sha1.update(o);if(n.session.resuming&&f||!n.session.resuming&&!f)a.queue(n,a.createRecord({type:a.ContentType.change_cipher_spec,data:a.createChangeCipherSpec()})),n.state.current.write=n.state.pending.write,n.state.pending=null,a.queue(n,a.createRecord({type:a.ContentType.handshake,data:a.createFinished(n)}));n.expect=f?m:T,n.handshaking=!1,++n.handshakes,n.peerCertificate=f?n.session.serverCertificate:n.session.clientCertificate,n.sessionCache?(n.session={id:n.session.id,sp:n.session.sp},n.session.sp.keys=null):n.session=null,a.flush(n),n.isConnected=!0,n.connected(n),n.process()}},a.handleAlert=function(e,t){var n=t.fragment,r={level:n.getByte(),description:n.getByte()},i;switch(r.description){case a.Alert.Description.close_notify:i="Connection closed.";break;case a.Alert.Description.unexpected_message:i="Unexpected message.";break;case a.Alert.Description.bad_record_mac:i="Bad record MAC.";break;case a.Alert.Description.decryption_failed:i="Decryption failed.";break;case a.Alert.Description.record_overflow:i="Record overflow.";break;case a.Alert.Description.decompression_failure:i="Decompression failed.";break;case a.Alert.Description.handshake_failure:i="Handshake failure.";break;case a.Alert.Description.bad_certificate:i="Bad certificate.";break;case a.Alert.Description.unsupported_certificate:i="Unsupported certificate.";break;case a.Alert.Description.certificate_revoked:i="Certificate revoked.";break;case a.Alert.Description.certificate_expired:i="Certificate expired.";break;case a.Alert.Description.certificate_unknown:i="Certificate unknown.";break;case a.Alert.Description.illegal_parameter:i="Illegal parameter.";break;case a.Alert.Description.unknown_ca:i="Unknown certificate authority.";break;case a.Alert.Description.access_denied:i="Access denied.";break;case a.Alert.Description.decode_error:i="Decode error.";break;case a.Alert.Description.decrypt_error:i="Decrypt error.";break;case a.Alert.Description.export_restriction:i="Export restriction.";break;case a.Alert.Description.protocol_version:i="Unsupported protocol version.";break;case a.Alert.Description.insufficient_security:i="Insufficient security.";break;case a.Alert.Description.internal_error:i="Internal error.";break;case a.Alert.Description.user_canceled:i="User canceled.";break;case a.Alert.Description.no_renegotiation:i="Renegotiation not supported.";break;default:i="Unknown error."}r.description===a.Alert.Description.close_notify?e.close():(e.error(e,{message:i,send:!1,origin:e.entity===a.ConnectionEnd.client?"server":"client",alert:r}),e.process())},a.handleHandshake=function(t,n){var r=n.fragment,i=r.getByte(),s=r.getInt24();if(s>r.length())t.fragmented=n,n.fragment=e.util.createBuffer(),r.read-=4,t.process();else{t.fragmented=null,r.read-=4;var o=r.bytes(s+4);r.read+=4,i in q[t.entity][t.expect]?(t.entity===a.ConnectionEnd.server&&!t.open&&!t.fail&&(t.handshaking=!0,t.session={serverNameList:[],cipherSuite:null,compressionMethod:null,serverCertificate:null,clientCertificate:null,md5:e.md.md5.create(),sha1:e.md.sha1.create()}),i!==a.HandshakeType.hello_request&&i!==a.HandshakeType.certificate_verify&&i!==a.HandshakeType.finished&&(t.session.md5.update(o),t.session.sha1.update(o)),q[t.entity][t.expect][i](t,n,s)):a.handleUnexpected(t,n)}},a.handleApplicationData=function(e,t){e.data.putBuffer(t.fragment),e.dataReady(e),e.process()},a.handleHeartbeat=function(t,n){var r=n.fragment,i=r.getByte(),s=r.getInt16(),o=r.getBytes(s);if(i===a.HeartbeatMessageType.heartbeat_request){if(t.handshaking||s>o.length)return t.process();a.queue(t,a.createRecord({type:a.ContentType.heartbeat,data:a.createHeartbeat(a.HeartbeatMessageType.heartbeat_response,o)})),a.flush(t)}else if(i===a.HeartbeatMessageType.heartbeat_response){if(o!==t.expectedHeartbeatPayload)return t.process();t.heartbeatReceived&&t.heartbeatReceived(t,e.util.createBuffer(o))}t.process()};var f=0,l=1,c=2,h=3,p=4,d=5,v=6,m=7,g=8,y=0,b=1,w=2,E=3,S=4,x=5,T=6,N=7,C=a.handleUnexpected,k=a.handleChangeCipherSpec,L=a.handleAlert,A=a.handleHandshake,O=a.handleApplicationData,M=a.handleHeartbeat,_=[];_[a.ConnectionEnd.client]=[[C,L,A,C,M],[C,L,A,C,M],[C,L,A,C,M],[C,L,A,C,M],[C,L,A,C,M],[k,L,C,C,M],[C,L,A,C,M],[C,L,A,O,M],[C,L,A,C,M]],_[a.ConnectionEnd.server]=[[C,L,A,C,M],[C,L,A,C,M],[C,L,A,C,M],[C,L,A,C,M],[k,L,C,C,M],[C,L,A,C,M],[C,L,A,O,M],[C,L,A,C,M]];var D=a.handleHelloRequest,P=a.handleServerHello,H=a.handleCertificate,B=a.handleServerKeyExchange,j=a.handleCertificateRequest,F=a.handleServerHelloDone,I=a.handleFinished,q=[];q[a.ConnectionEnd.client]=[[C,C,P,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C],[D,C,C,C,C,C,C,C,C,C,C,H,B,j,F,C,C,C,C,C,C],[D,C,C,C,C,C,C,C,C,C,C,C,B,j,F,C,C,C,C,C,C],[D,C,C,C,C,C,C,C,C,C,C,C,C,j,F,C,C,C,C,C,C],[D,C,C,C,C,C,C,C,C,C,C,C,C,C,F,C,C,C,C,C,C],[D,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C],[D,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,I],[D,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C],[D,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C]];var R=a.handleClientHello,U=a.handleClientKeyExchange,z=a.handleCertificateVerify;q[a.ConnectionEnd.server]=[[C,R,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C],[C,C,C,C,C,C,C,C,C,C,C,H,C,C,C,C,C,C,C,C,C],[C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,U,C,C,C,C],[C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,z,C,C,C,C,C],[C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C],[C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,I],[C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C],[C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C,C]],a.generateKeys=function(e,n){var r=t,i=n.client_random+n.server_random;e.session.resuming||(n.master_secret=r(n.pre_master_secret,"master secret",i,48).bytes(),n.pre_master_secret=null),i=n.server_random+n.client_random;var s=2*n.mac_key_length+2*n.enc_key_length+2*n.fixed_iv_length,o=r(n.master_secret,"key expansion",i,s);return{client_write_MAC_key:o.getBytes(n.mac_key_length),server_write_MAC_key:o.getBytes(n.mac_key_length),client_write_key:o.getBytes(n.enc_key_length),server_write_key:o.getBytes(n.enc_key_length),client_write_IV:o.getBytes(n.fixed_iv_length),server_write_IV:o.getBytes(n.fixed_iv_length)}},a.createConnectionState=function(e){var t=e.entity===a.ConnectionEnd.client,n=function(){var e={sequenceNumber:[0,0],macKey:null,macLength:0,macFunction:null,cipherState:null,cipherFunction:function(e){return!0},compressionState:null,compressFunction:function(e){return!0},updateSequenceNumber:function(){e.sequenceNumber[1]===4294967295?(e.sequenceNumber[1]=0,++e.sequenceNumber[0]):++e.sequenceNumber[1]}};return e},r={read:n(),write:n()};r.read.update=function(e,t){return r.read.cipherFunction(t,r.read)?r.read.compressFunction(e,t,r.read)||e.error(e,{message:"Could not decompress record.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.decompression_failure}}):e.error(e,{message:"Could not decrypt record or bad MAC.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.bad_record_mac}}),!e.fail},r.write.update=function(e,t){return r.write.compressFunction(e,t,r.write)?r.write.cipherFunction(t,r.write)||e.error(e,{message:"Could not encrypt record.",send:!1,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.internal_error}}):e.error(e,{message:"Could not compress record.",send:!1,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.internal_error}}),!e.fail};if(e.session){var o=e.session.sp;e.session.cipherSuite.initSecurityParameters(o),o.keys=a.generateKeys(e,o),r.read.macKey=t?o.keys.server_write_MAC_key:o.keys.client_write_MAC_key,r.write.macKey=t?o.keys.client_write_MAC_key:o.keys.server_write_MAC_key,e.session.cipherSuite.initConnectionState(r,e,o);switch(o.compression_algorithm){case a.CompressionMethod.none:break;case a.CompressionMethod.deflate:r.read.compressFunction=s,r.write.compressFunction=i;break;default:throw{message:"Unsupported compression algorithm."}}}return r},a.createRandom=function(){var t=new Date,n=+t+t.getTimezoneOffset()*6e4,r=e.util.createBuffer();return r.putInt32(n),r.putBytes(e.random.getBytes(28)),r},a.createRecord=function(e){if(!e.data)return null;var t={type:e.type,version:{major:a.Version.major,minor:a.Version.minor},length:e.data.length(),fragment:e.data};return t},a.createAlert=function(t){var n=e.util.createBuffer();return n.putByte(t.level),n.putByte(t.description),a.createRecord({type:a.ContentType.alert,data:n})},a.createClientHello=function(t){var n=e.util.createBuffer();for(var r=0;r<t.cipherSuites.length;++r){var i=t.cipherSuites[r];n.putByte(i.id[0]),n.putByte(i.id[1])}var s=n.length(),o=e.util.createBuffer();o.putByte(a.CompressionMethod.none);var f=o.length(),l=e.util.createBuffer();if(t.virtualHost){var c=e.util.createBuffer();c.putByte(0),c.putByte(0);var h=e.util.createBuffer();h.putByte(0),u(h,2,e.util.createBuffer(t.virtualHost));var p=e.util.createBuffer();u(p,2,h),u(c,2,p),l.putBuffer(c)}var d=l.length();d>0&&(d+=2);var v=t.session.id,m=v.length+1+2+4+28+2+s+1+f+d,g=e.util.createBuffer();return g.putByte(a.HandshakeType.client_hello),g.putInt24(m),g.putByte(a.Version.major),g.putByte(a.Version.minor),g.putBytes(t.session.sp.client_random),u(g,1,e.util.createBuffer(v)),u(g,2,n),u(g,1,o),d>0&&u(g,2,l),g},a.createServerHello=function(t){var n=t.session.id,r=n.length+1+2+4+28+2+1,i=e.util.createBuffer();return i.putByte(a.HandshakeType.server_hello),i.putInt24(r),i.putByte(a.Version.major),i.putByte(a.Version.minor),i.putBytes(t.session.sp.server_random),u(i,1,e.util.createBuffer(n)),i.putByte(t.session.cipherSuite.id[0]),i.putByte(t.session.cipherSuite.id[1]),i.putByte(t.session.compressionMethod),i},a.createCertificate=function(t){var n=t.entity===a.ConnectionEnd.client,r=null;t.getCertificate&&(r=t.getCertificate(t,n?t.session.certificateRequest:t.session.serverNameList));var i=e.util.createBuffer();if(r!==null)try{e.util.isArray(r)||(r=[r]);var s=null;for(var o=0;o<r.length;++o){var f=e.pem.decode(r[o])[0];if(f.type!=="CERTIFICATE"&&f.type!=="X509 CERTIFICATE"&&f.type!=="TRUSTED CERTIFICATE")throw{message:'Could not convert certificate from PEM; PEM header type is not "CERTIFICATE", "X509 CERTIFICATE", or "TRUSTED CERTIFICATE".',headerType:f.type};if(f.procType&&f.procType.type==="ENCRYPTED")throw{message:"Could not convert certificate from PEM; PEM is encrypted."};var l=e.util.createBuffer(f.body);s===null&&(s=e.asn1.fromDer(l.bytes(),!1));var c=e.util.createBuffer();u(c,3,l),i.putBuffer(c)}r=e.pki.certificateFromAsn1(s),n?t.session.clientCertificate=r:t.session.serverCertificate=r}catch(h){return t.error(t,{message:"Could not send certificate list.",cause:h,send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.bad_certificate}})}var p=3+i.length(),d=e.util.createBuffer();return d.putByte(a.HandshakeType.certificate),d.putInt24(p),u(d,3,i),d},a.createClientKeyExchange=function(t){var n=e.util.createBuffer();n.putByte(a.Version.major),n.putByte(a.Version.minor),n.putBytes(e.random.getBytes(46));var r=t.session.sp;r.pre_master_secret=n.getBytes();var i=t.session.serverCertificate.publicKey;n=i.encrypt(r.pre_master_secret);var s=n.length+2,o=e.util.createBuffer();return o.putByte(a.HandshakeType.client_key_exchange),o.putInt24(s),o.putInt16(n.length),o.putBytes(n),o},a.createServerKeyExchange=function(t){var n=0,r=e.util.createBuffer();return n>0&&(r.putByte(a.HandshakeType.server_key_exchange),r.putInt24(n)),r},a.getClientSignature=function(t,n){var r=e.util.createBuffer();r.putBuffer(t.session.md5.digest()),r.putBuffer(t.session.sha1.digest()),r=r.getBytes(),t.getSignature=t.getSignature||function(t,n,r){var i=null;if(t.getPrivateKey)try{i=t.getPrivateKey(t,t.session.clientCertificate),i=e.pki.privateKeyFromPem(i)}catch(s){t.error(t,{message:"Could not get private key.",cause:s,send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.internal_error}})}i===null?t.error(t,{message:"No private key set.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.internal_error}}):n=i.sign(n,null),r(t,n)},t.getSignature(t,r,n)},a.createCertificateVerify=function(t,n){var r=n.length+2,i=e.util.createBuffer();return i.putByte(a.HandshakeType.certificate_verify),i.putInt24(r),i.putInt16(n.length),i.putBytes(n),i},a.createCertificateRequest=function(t){var n=e.util.createBuffer();n.putByte(1);var r=e.util.createBuffer();for(var i in t.caStore.certs){var s=t.caStore.certs[i],o=e.pki.distinguishedNameToAsn1(s.subject);r.putBuffer(e.asn1.toDer(o))}var f=1+n.length()+2+r.length(),l=e.util.createBuffer();return l.putByte(a.HandshakeType.certificate_request),l.putInt24(f),u(l,1,n),u(l,2,r),l},a.createServerHelloDone=function(t){var n=e.util.createBuffer();return n.putByte(a.HandshakeType.server_hello_done),n.putInt24(0),n},a.createChangeCipherSpec=function(){var t=e.util.createBuffer();return t.putByte(1),t},a.createFinished=function(n){var r=e.util.createBuffer();r.putBuffer(n.session.md5.digest()),r.putBuffer(n.session.sha1.digest());var i=n.entity===a.ConnectionEnd.client,s=n.session.sp,o=12,u=t,f=i?"client finished":"server finished";r=u(s.master_secret,f,r.getBytes(),o);var l=e.util.createBuffer();return l.putByte(a.HandshakeType.finished),l.putInt24(r.length()),l.putBuffer(r),l},a.createHeartbeat=function(t,n,r){typeof r=="undefined"&&(r=n.length);var i=e.util.createBuffer();i.putByte(t),i.putInt16(r),i.putBytes(n);var s=i.length(),o=Math.max(16,s-r-3);return i.putBytes(e.random.getBytes(o)),i},a.queue=function(t,n){if(!n)return;if(n.type===a.ContentType.handshake){var r=n.fragment.bytes();t.session.md5.update(r),t.session.sha1.update(r),r=null}var i;if(n.fragment.length()<=a.MaxFragment)i=[n];else{i=[];var s=n.fragment.bytes();while(s.length>a.MaxFragment)i.push(a.createRecord({type:n.type,data:e.util.createBuffer(s.slice(0,a.MaxFragment))})),s=s.slice(a.MaxFragment);s.length>0&&i.push(a.createRecord({type:n.type,data:e.util.createBuffer(s)}))}for(var o=0;o<i.length&&!t.fail;++o){var u=i[o],f=t.state.current.write;f.update(t,u)&&t.records.push(u)}},a.flush=function(e){for(var t=0;t<e.records.length;++t){var n=e.records[t];e.tlsData.putByte(n.type),e.tlsData.putByte(n.version.major),e.tlsData.putByte(n.version.minor),e.tlsData.putInt16(n.fragment.length()),e.tlsData.putBuffer(e.records[t].fragment)}return e.records=[],e.tlsDataReady(e)};var W=function(t){switch(t){case!0:return!0;case e.pki.certificateError.bad_certificate:return a.Alert.Description.bad_certificate;case e.pki.certificateError.unsupported_certificate:return a.Alert.Description.unsupported_certificate;case e.pki.certificateError.certificate_revoked:return a.Alert.Description.certificate_revoked;case e.pki.certificateError.certificate_expired:return a.Alert.Description.certificate_expired;case e.pki.certificateError.certificate_unknown:return a.Alert.Description.certificate_unknown;case e.pki.certificateError.unknown_ca:return a.Alert.Description.unknown_ca;default:return a.Alert.Description.bad_certificate}},X=function(t){switch(t){case!0:return!0;case a.Alert.Description.bad_certificate:return e.pki.certificateError.bad_certificate;case a.Alert.Description.unsupported_certificate:return e.pki.certificateError.unsupported_certificate;case a.Alert.Description.certificate_revoked:return e.pki.certificateError.certificate_revoked;case a.Alert.Description.certificate_expired:return e.pki.certificateError.certificate_expired;case a.Alert.Description.certificate_unknown:return e.pki.certificateError.certificate_unknown;case a.Alert.Description.unknown_ca:return e.pki.certificateError.unknown_ca;default:return e.pki.certificateError.bad_certificate}};a.verifyCertificateChain=function(t,n){try{e.pki.verifyCertificateChain(t.caStore,n,function(r,i,s){var o=W(r),u=t.verify(t,r,i,s);if(u!==!0){if(typeof u=="object"&&!e.util.isArray(u)){var f={message:"The application rejected the certificate.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.bad_certificate}};throw u.message&&(f.message=u.message),u.alert&&(f.alert.description=u.alert),f}u!==r&&(u=X(u))}return u})}catch(r){if(typeof r!="object"||e.util.isArray(r))r={send:!0,alert:{level:a.Alert.Level.fatal,description:W(r)}};"send"in r||(r.send=!0),"alert"in r||(r.alert={level:a.Alert.Level.fatal,description:W(r.error)}),t.error(t,r)}return!t.fail},a.createSessionCache=function(t,n){var r=null;if(t&&t.getSession&&t.setSession&&t.order)r=t;else{r={},r.cache=t||{},r.capacity=Math.max(n||100,1),r.order=[];for(var i in t)r.order.length<=n?r.order.push(i):delete t[i];r.getSession=function(t){var n=null,i=null;t?i=e.util.bytesToHex(t):r.order.length>0&&(i=r.order[0]);if(i!==null&&i in r.cache){n=r.cache[i],delete r.cache[i];for(var s in r.order)if(r.order[s]===i){r.order.splice(s,1);break}}return n},r.setSession=function(t,n){if(r.order.length===r.capacity){var i=r.order.shift();delete r.cache[i]}var i=e.util.bytesToHex(t);r.order.push(i),r.cache[i]=n}}return r},a.createConnection=function(t){var n=null;t.caStore?e.util.isArray(t.caStore)?n=e.pki.createCaStore(t.caStore):n=t.caStore:n=e.pki.createCaStore();var r=t.cipherSuites||null;if(r===null){r=[];for(var i in a.CipherSuites)r.push(a.CipherSuites[i])}var s=t.server||!1?a.ConnectionEnd.server:a.ConnectionEnd.client,o=t.sessionCache?a.createSessionCache(t.sessionCache):null,u={entity:s,sessionId:t.sessionId,caStore:n,sessionCache:o,cipherSuites:r,connected:t.connected,virtualHost:t.virtualHost||null,verifyClient:t.verifyClient||!1,verify:t.verify||function(e,t,n,r){return t},getCertificate:t.getCertificate||null,getPrivateKey:t.getPrivateKey||null,getSignature:t.getSignature||null,input:e.util.createBuffer(),tlsData:e.util.createBuffer(),data:e.util.createBuffer(),tlsDataReady:t.tlsDataReady,dataReady:t.dataReady,heartbeatReceived:t.heartbeatReceived,closed:t.closed,error:function(e,n){n.origin=n.origin||(e.entity===a.ConnectionEnd.client?"client":"server"),n.send&&(a.queue(e,a.createAlert(n.alert)),a.flush(e));var r=n.fatal!==!1;r&&(e.fail=!0),t.error(e,n),r&&e.close(!1)},deflate:t.deflate||null,inflate:t.inflate||null};u.reset=function(e){u.record=null,u.session=null,u.peerCertificate=null,u.state={pending:null,current:null},u.expect=u.entity===a.ConnectionEnd.client?f:y,u.fragmented=null,u.records=[],u.open=!1,u.handshakes=0,u.handshaking=!1,u.isConnected=!1,u.fail=!e&&typeof e!="undefined",u.input.clear(),u.tlsData.clear(),u.data.clear(),u.state.current=a.createConnectionState(u)},u.reset();var l=function(e,t){var n=t.type-a.ContentType.change_cipher_spec,r=_[e.entity][e.expect];n in r?r[n](e,t):a.handleUnexpected(e,t)},c=function(t){var n=0,r=t.input,i=r.length();return i<5?n=5-i:(t.record={type:r.getByte(),version:{major:r.getByte(),minor:r.getByte()},length:r.getInt16(),fragment:e.util.createBuffer(),ready:!1},(t.record.version.major!==a.Version.major||t.record.version.minor!==a.Version.minor)&&t.error(t,{message:"Incompatible TLS version.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.protocol_version}})),n},h=function(e){var t=0,n=e.input,r=n.length();if(r<e.record.length)t=e.record.length-r;else{e.record.fragment.putBytes(n.getBytes(e.record.length)),n.compact();var i=e.state.current.read;i.update(e,e.record)&&(e.fragmented!==null&&(e.fragmented.type===e.record.type?(e.fragmented.fragment.putBuffer(e.record.fragment),e.record=e.fragmented):e.error(e,{message:"Invalid fragmented record.",send:!0,alert:{level:a.Alert.Level.fatal,description:a.Alert.Description.unexpected_message}})),e.record.ready=!0)}return t};return u.handshake=function(t){if(u.entity!==a.ConnectionEnd.client)u.error(u,{message:"Cannot initiate handshake as a server.",fatal:!1});else if(u.handshaking)u.error(u,{message:"Handshake already in progress.",fatal:!1});else{u.fail&&!u.open&&u.handshakes===0&&(u.fail=!1),u.handshaking=!0,t=t||"";var n=null;t.length>0&&(u.sessionCache&&(n=u.sessionCache.getSession(t)),n===null&&(t="")),t.length===0&&u.sessionCache&&(n=u.sessionCache.getSession(),n!==null&&(t=n.id)),u.session={id:t,cipherSuite:null,compressionMethod:null,serverCertificate:null,certificateRequest:null,clientCertificate:null,sp:n?n.sp:{},md5:e.md.md5.create(),sha1:e.md.sha1.create()},u.session.sp.client_random=a.createRandom().getBytes(),u.open=!0,a.queue(u,a.createRecord({type:a.ContentType.handshake,data:a.createClientHello(u)})),a.flush(u)}},u.process=function(e){var t=0;return e&&u.input.putBytes(e),u.fail||(u.record!==null&&u.record.ready&&u.record.fragment.isEmpty()&&(u.record=null),u.record===null&&(t=c(u)),!u.fail&&u.record!==null&&!u.record.ready&&(t=h(u)),!u.fail&&u.record!==null&&u.record.ready&&l(u,u.record)),t},u.prepare=function(t){return a.queue(u,a.createRecord({type:a.ContentType.application_data,data:e.util.createBuffer(t)})),a.flush(u)},u.prepareHeartbeatRequest=function(t,n){return t instanceof e.util.ByteBuffer&&(t=t.bytes()),typeof n=="undefined"&&(n=t.length),u.expectedHeartbeatPayload=t,a.queue(u,a.createRecord({type:a.ContentType.heartbeat,data:a.createHeartbeat(a.HeartbeatMessageType.heartbeat_request,t,n)})),a.flush(u)},u.close=function(e){!u.fail&&u.sessionCache&&u.session&&u.sessionCache.setSession(u.session.id,u.session);if(u.open){u.open=!1,u.input.clear();if(u.isConnected||u.handshaking)u.isConnected=u.handshaking=!1,a.queue(u,a.createAlert({level:a.Alert.Level.warning,description:a.Alert.Description.close_notify})),a.flush(u);u.closed(u)}u.reset(e)},u},e.tls=e.tls||{};for(var V in a)typeof a[V]!="function"&&(e.tls[V]=a[V]);e.tls.prf_tls1=t,e.tls.hmac_sha1=r,e.tls.createSessionCache=a.createSessionCache,e.tls.createConnection=a.createConnection}var r="tls";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/tls",["require","module","./asn1","./hmac","./md","./pem","./pki","./random","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){function n(n,i,s){var u=i.entity===e.tls.ConnectionEnd.client;n.read.cipherState={init:!1,cipher:e.aes.createDecryptionCipher(u?s.keys.server_write_key:s.keys.client_write_key),iv:u?s.keys.server_write_IV:s.keys.client_write_IV},n.write.cipherState={init:!1,cipher:e.aes.createEncryptionCipher(u?s.keys.client_write_key:s.keys.server_write_key),iv:u?s.keys.client_write_IV:s.keys.server_write_IV},n.read.cipherFunction=o,n.write.cipherFunction=r,n.read.macLength=n.write.macLength=s.mac_length,n.read.macFunction=n.write.macFunction=t.hmac_sha1}function r(t,n){var r=!1,s=n.macFunction(n.macKey,n.sequenceNumber,t);t.fragment.putBytes(s),n.updateSequenceNumber();var o;t.version.minor>1?o=e.random.getBytes(16):o=n.cipherState.init?null:n.cipherState.iv,n.cipherState.init=!0;var u=n.cipherState.cipher;return u.start(o),t.version.minor>1&&u.output.putBytes(o),u.update(t.fragment),u.finish(i)&&(t.fragment=u.output,t.length=t.fragment.length(),r=!0),r}function i(e,t,n){if(!n){var r=e-t.length()%e;t.fillWithByte(r-1,r)}return!0}function s(e,t,n){var r=!0;if(n){var i=t.length(),s=t.last();for(var o=i-1-s;o<i-1;++o)r=r&&t.at(o)==s;r&&t.truncate(s+1)}return r}function o(t,n){var r=!1,i=n.cipherState.init?null:n.cipherState.iv;n.cipherState.init=!0;var o=n.cipherState.cipher;o.start(i),o.update(t.fragment),r=o.finish(s);var u=n.macLength,a="";for(var f=0;f<u;++f)a+=String.fromCharCode(0);var l=o.output.length();l>=u?(t.fragment=o.output.getBytes(l-u),a=o.output.getBytes(u)):t.fragment=o.output.getBytes(),t.fragment=e.util.createBuffer(t.fragment),t.length=t.fragment.length();var c=n.macFunction(n.macKey,n.sequenceNumber,t);return n.updateSequenceNumber(),r=c===a&&r,r}var t=e.tls;t.CipherSuites.TLS_RSA_WITH_AES_128_CBC_SHA={id:[0,47],name:"TLS_RSA_WITH_AES_128_CBC_SHA",initSecurityParameters:function(e){e.bulk_cipher_algorithm=t.BulkCipherAlgorithm.aes,e.cipher_type=t.CipherType.block,e.enc_key_length=16,e.block_length=16,e.fixed_iv_length=16,e.record_iv_length=16,e.mac_algorithm=t.MACAlgorithm.hmac_sha1,e.mac_length=20,e.mac_key_length=20},initConnectionState:n},t.CipherSuites.TLS_RSA_WITH_AES_256_CBC_SHA={id:[0,53],name:"TLS_RSA_WITH_AES_256_CBC_SHA",initSecurityParameters:function(e){e.bulk_cipher_algorithm=t.BulkCipherAlgorithm.aes,e.cipher_type=t.CipherType.block,e.enc_key_length=32,e.block_length=16,e.fixed_iv_length=16,e.record_iv_length=16,e.mac_algorithm=t.MACAlgorithm.hmac_sha1,e.mac_length=20,e.mac_key_length=20},initConnectionState:n}}var r="aesCipherSuites";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/aesCipherSuites",["require","module","./aes","./tls"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){e.debug=e.debug||{},e.debug.storage={},e.debug.get=function(t,n){var r;return typeof t=="undefined"?r=e.debug.storage:t in e.debug.storage&&(typeof n=="undefined"?r=e.debug.storage[t]:r=e.debug.storage[t][n]),r},e.debug.set=function(t,n,r){t in e.debug.storage||(e.debug.storage[t]={}),e.debug.storage[t][n]=r},e.debug.clear=function(t,n){typeof t=="undefined"?e.debug.storage={}:t in e.debug.storage&&(typeof n=="undefined"?delete e.debug.storage[t]:delete e.debug.storage[t][n])}}var r="debug";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/debug",["require","module"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){e.log=e.log||{},e.log.levels=["none","error","warning","info","debug","verbose","max"];var t={},n=[],r=null;e.log.LEVEL_LOCKED=2,e.log.NO_LEVEL_CHECK=4,e.log.INTERPOLATE=8;for(var i=0;i<e.log.levels.length;++i){var s=e.log.levels[i];t[s]={index:i,name:s.toUpperCase()}}e.log.logMessage=function(r){var i=t[r.level].index;for(var s=0;s<n.length;++s){var o=n[s];if(o.flags&e.log.NO_LEVEL_CHECK)o.f(r);else{var u=t[o.level].index;i<=u&&o.f(o,r)}}},e.log.prepareStandard=function(e){"standard"in e||(e.standard=t[e.level].name+" ["+e.category+"] "+e.message)},e.log.prepareFull=function(t){if(!("full"in t)){var n=[t.message];n=n.concat([]||t.arguments),t.full=e.util.format.apply(this,n)}},e.log.prepareStandardFull=function(t){"standardFull"in t||(e.log.prepareStandard(t),t.standardFull=t.standard)};var o=["error","warning","info","debug","verbose"];for(var i=0;i<o.length;++i)(function(t){e.log[t]=function(n,r){var i=Array.prototype.slice.call(arguments).slice(2),s={timestamp:new Date,level:t,category:n,message:r,arguments:i};e.log.logMessage(s)}})(o[i]);e.log.makeLogger=function(t){var n={flags:0,f:t};return e.log.setLevel(n,"none"),n},e.log.setLevel=function(t,n){var r=!1;if(t&&!(t.flags&e.log.LEVEL_LOCKED))for(var i=0;i<e.log.levels.length;++i){var s=e.log.levels[i];if(n==s){t.level=n,r=!0;break}}return r},e.log.lock=function(t,n){typeof n=="undefined"||n?t.flags|=e.log.LEVEL_LOCKED:t.flags&=~e.log.LEVEL_LOCKED},e.log.addLogger=function(e){n.push(e)};if(typeof console!="undefined"&&"log"in console){var u;if(console.error&&console.warn&&console.info&&console.debug){var a={error:console.error,warning:console.warn,info:console.info,debug:console.debug,verbose:console.debug},f=function(t,n){e.log.prepareStandard(n);var r=a[n.level],i=[n.standard];i=i.concat(n.arguments.slice()),r.apply(console,i)};u=e.log.makeLogger(f)}else{var f=function(t,n){e.log.prepareStandardFull(n),console.log(n.standardFull)};u=e.log.makeLogger(f)}e.log.setLevel(u,"debug"),e.log.addLogger(u),r=u}else console={log:function(){}};if(r!==null){var l=e.util.getQueryVariables();"console.level"in l&&e.log.setLevel(r,l["console.level"].slice(-1)[0]);if("console.lock"in l){var c=l["console.lock"].slice(-1)[0];c=="true"&&e.log.lock(r)}}e.log.consoleLogger=r}var r="log";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/log",["require","module","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){var t=e.asn1,n=e.pkcs7=e.pkcs7||{};n.messageFromPem=function(r){var i=e.pem.decode(r)[0];if(i.type!=="PKCS7")throw{message:'Could not convert PKCS#7 message from PEM; PEM header type is not "PKCS#7".',headerType:i.type};if(i.procType&&i.procType.type==="ENCRYPTED")throw{message:"Could not convert PKCS#7 message from PEM; PEM is encrypted."};var s=t.fromDer(i.body);return n.messageFromAsn1(s)},n.messageToPem=function(n,r){var i={type:"PKCS7",body:t.toDer(n.toAsn1()).getBytes()};return e.pem.encode(i,{maxline:r})},n.messageFromAsn1=function(r){var i={},s=[];if(!t.validate(r,n.asn1.contentInfoValidator,i,s))throw{message:"Cannot read PKCS#7 message. ASN.1 object is not an PKCS#7 ContentInfo.",errors:s};var o=t.derToOid(i.contentType),u;switch(o){case e.pki.oids.envelopedData:u=n.createEnvelopedData();break;case e.pki.oids.encryptedData:u=n.createEncryptedData();break;case e.pki.oids.signedData:u=n.createSignedData();break;default:throw{message:"Cannot read PKCS#7 message. ContentType with OID "+o+" is not (yet) supported."}}return u.fromAsn1(i.content.value[0]),u};var r=function(r){var i={},s=[];if(!t.validate(r,n.asn1.recipientInfoValidator,i,s))throw{message:"Cannot read PKCS#7 message. ASN.1 object is not an PKCS#7 EnvelopedData.",errors:s};return{version:i.version.charCodeAt(0),issuer:e.pki.RDNAttributesAsArray(i.issuer),serialNumber:e.util.createBuffer(i.serial).toHex(),encryptedContent:{algorithm:t.derToOid(i.encAlgorithm),parameter:i.encParameter.value,content:i.encKey}}},i=function(n){return t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.INTEGER,!1,t.integerToDer(n.version).getBytes()),t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[e.pki.distinguishedNameToAsn1({attributes:n.issuer}),t.create(t.Class.UNIVERSAL,t.Type.INTEGER,!1,e.util.hexToBytes(n.serialNumber))]),t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(n.encryptedContent.algorithm).getBytes()),t.create(t.Class.UNIVERSAL,t.Type.NULL,!1,"")]),t.create(t.Class.UNIVERSAL,t.Type.OCTETSTRING,!1,n.encryptedContent.content)])},s=function(e){var t=[];for(var n=0;n<e.length;n++)t.push(r(e[n]));return t},o=function(e){var t=[];for(var n=0;n<e.length;n++)t.push(i(e[n]));return t},u=function(n){return[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(e.pki.oids.data).getBytes()),t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(n.algorithm).getBytes()),t.create(t.Class.UNIVERSAL,t.Type.OCTETSTRING,!1,n.parameter.getBytes())]),t.create(t.Class.CONTEXT_SPECIFIC,0,!0,[t.create(t.Class.UNIVERSAL,t.Type.OCTETSTRING,!1,n.content.getBytes())])]},a=function(n,r,i){var s={},o=[];if(!t.validate(r,i,s,o))throw{message:"Cannot read PKCS#7 message. ASN.1 object is not a supported PKCS#7 message.",errors:o};var u=t.derToOid(s.contentType);if(u!==e.pki.oids.data)throw{message:"Unsupported PKCS#7 message. Only wrapped ContentType Data supported."};if(s.encryptedContent){var a="";if(e.util.isArray(s.encryptedContent))for(var f=0;f<s.encryptedContent.length;++f){if(s.encryptedContent[f].type!==t.Type.OCTETSTRING)throw{message:"Malformed PKCS#7 message, expecting encrypted content constructed of only OCTET STRING objects."};a+=s.encryptedContent[f].value}else a=s.encryptedContent;n.encryptedContent={algorithm:t.derToOid(s.encAlgorithm),parameter:e.util.createBuffer(s.encParameter.value),content:e.util.createBuffer(a)}}if(s.content){var a="";if(e.util.isArray(s.content))for(var f=0;f<s.content.length;++f){if(s.content[f].type!==t.Type.OCTETSTRING)throw{message:"Malformed PKCS#7 message, expecting content constructed of only OCTET STRING objects."};a+=s.content[f].value}else a=s.content;n.content=e.util.createBuffer(a)}return n.version=s.version.charCodeAt(0),n.rawCapture=s,s},f=function(t){if(t.encryptedContent.key===undefined)throw{message:"Symmetric key not available."};if(t.content===undefined){var n;switch(t.encryptedContent.algorithm){case e.pki.oids["aes128-CBC"]:case e.pki.oids["aes192-CBC"]:case e.pki.oids["aes256-CBC"]:n=e.aes.createDecryptionCipher(t.encryptedContent.key);break;case e.pki.oids.desCBC:case e.pki.oids["des-EDE3-CBC"]:n=e.des.createDecryptionCipher(t.encryptedContent.key);break;default:throw{message:"Unsupported symmetric cipher, OID "+t.encryptedContent.algorithm}}n.start(t.encryptedContent.parameter),n.update(t.encryptedContent.content);if(!n.finish())throw{message:"Symmetric decryption failed."};t.content=n.output}};n.createSignedData=function(){var r=null;return r={type:e.pki.oids.signedData,version:1,certificates:[],crls:[],digestAlgorithmIdentifiers:[],contentInfo:null,signerInfos:[],fromAsn1:function(t){a(r,t,n.asn1.signedDataValidator),r.certificates=[],r.crls=[],r.digestAlgorithmIdentifiers=[],r.contentInfo=null,r.signerInfos=[];var i=r.rawCapture.certificates.value;for(var s=0;s<i.length;++s)r.certificates.push(e.pki.certificateFromAsn1(i[s]))},toAsn1:function(){if("content"in r)throw"Signing PKCS#7 content not yet implemented.";r.contentInfo||r.sign();var n=[];for(var i=0;i<r.certificates.length;++i)n.push(e.pki.certificateToAsn1(r.certificates[0]));var s=[];return t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(r.type).getBytes()),t.create(t.Class.CONTEXT_SPECIFIC,0,!0,[t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.INTEGER,!1,t.integerToDer(r.version).getBytes()),t.create(t.Class.UNIVERSAL,t.Type.SET,!0,r.digestAlgorithmIdentifiers),r.contentInfo,t.create(t.Class.CONTEXT_SPECIFIC,0,!0,n),t.create(t.Class.CONTEXT_SPECIFIC,1,!0,s),t.create(t.Class.UNIVERSAL,t.Type.SET,!0,r.signerInfos)])])])},sign:function(n){if("content"in r)throw"PKCS#7 signing not yet implemented.";typeof r.content!="object"&&(r.contentInfo=t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(e.pki.oids.data).getBytes())]),"content"in r&&r.contentInfo.value.push(t.create(t.Class.CONTEXT_SPECIFIC,0,!0,[t.create(t.Class.UNIVERSAL,t.Type.OCTETSTRING,!1,r.content)])))},verify:function(){throw"PKCS#7 signature verification not yet implemented."},addCertificate:function(t){typeof t=="string"&&(t=e.pki.certificateFromPem(t)),r.certificates.push(t)},addCertificateRevokationList:function(e){throw"PKCS#7 CRL support not yet implemented."}},r},n.createEncryptedData=function(){var t=null;return t={type:e.pki.oids.encryptedData,version:0,encryptedContent:{algorithm:e.pki.oids["aes256-CBC"]},fromAsn1:function(e){a(t,e,n.asn1.encryptedDataValidator)},decrypt:function(e){e!==undefined&&(t.encryptedContent.key=e),f(t)}},t},n.createEnvelopedData=function(){var r=null;return r={type:e.pki.oids.envelopedData,version:0,recipients:[],encryptedContent:{algorithm:e.pki.oids["aes256-CBC"]},fromAsn1:function(e){var t=a(r,e,n.asn1.envelopedDataValidator);r.recipients=s(t.recipientInfos.value)},toAsn1:function(){return t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.OID,!1,t.oidToDer(r.type).getBytes()),t.create(t.Class.CONTEXT_SPECIFIC,0,!0,[t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,[t.create(t.Class.UNIVERSAL,t.Type.INTEGER,!1,t.integerToDer(r.version).getBytes()),t.create(t.Class.UNIVERSAL,t.Type.SET,!0,o(r.recipients)),t.create(t.Class.UNIVERSAL,t.Type.SEQUENCE,!0,u(r.encryptedContent))])])])},findRecipient:function(e){var t=e.issuer.attributes;for(var n=0;n<r.recipients.length;++n){var i=r.recipients[n],s=i.issuer;if(i.serialNumber!==e.serialNumber)continue;if(s.length!==t.length)continue;var o=!0;for(var u=0;u<t.length;++u)if(s[u].type!==t[u].type||s[u].value!==t[u].value){o=!1;break}if(o)return i}return null},decrypt:function(t,n){if(r.encryptedContent.key===undefined&&t!==undefined&&n!==undefined)switch(t.encryptedContent.algorithm){case e.pki.oids.rsaEncryption:case e.pki.oids.desCBC:var i=n.decrypt(t.encryptedContent.content);r.encryptedContent.key=e.util.createBuffer(i);break;default:throw{message:"Unsupported asymmetric cipher, OID "+t.encryptedContent.algorithm}}f(r)},addRecipient:function(t){r.recipients.push({version:0,issuer:t.subject.attributes,serialNumber:t.serialNumber,encryptedContent:{algorithm:e.pki.oids.rsaEncryption,key:t.publicKey}})},encrypt:function(t,n){if(r.encryptedContent.content===undefined){n=n||r.encryptedContent.algorithm,t=t||r.encryptedContent.key;var i,s,o;switch(n){case e.pki.oids["aes128-CBC"]:i=16,s=16,o=e.aes.createEncryptionCipher;break;case e.pki.oids["aes192-CBC"]:i=24,s=16,o=e.aes.createEncryptionCipher;break;case e.pki.oids["aes256-CBC"]:i=32,s=16,o=e.aes.createEncryptionCipher;break;case e.pki.oids["des-EDE3-CBC"]:i=24,s=8,o=e.des.createEncryptionCipher;break;default:throw{message:"Unsupported symmetric cipher, OID "+n}}if(t===undefined)t=e.util.createBuffer(e.random.getBytes(i));else if(t.length()!=i)throw{message:"Symmetric key has wrong length, got "+t.length()+" bytes, expected "+i};r.encryptedContent.algorithm=n,r.encryptedContent.key=t,r.encryptedContent.parameter=e.util.createBuffer(e.random.getBytes(s));var u=o(t);u.start(r.encryptedContent.parameter.copy()),u.update(r.content);if(!u.finish())throw{message:"Symmetric encryption failed."};r.encryptedContent.content=u.output}for(var a=0;a<r.recipients.length;a++){var f=r.recipients[a];if(f.encryptedContent.content!==undefined)continue;switch(f.encryptedContent.algorithm){case e.pki.oids.rsaEncryption:f.encryptedContent.content=f.encryptedContent.key.encrypt(r.encryptedContent.key.data);break;default:throw{message:"Unsupported asymmetric cipher, OID "+f.encryptedContent.algorithm}}}}},r}}var r="pkcs7";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/pkcs7",["require","module","./aes","./asn1","./des","./oids","./pem","./pkcs7asn1","./random","./util","./x509"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){var t="forge.task",n=0,r={},i=0;e.debug.set(t,"tasks",r);var s={};e.debug.set(t,"queues",s);var o="?",u=30,a=20,f="ready",l="running",c="blocked",h="sleeping",p="done",d="error",v="stop",m="start",g="block",y="unblock",b="sleep",w="wakeup",E="cancel",S="fail",x={};x[f]={},x[f][v]=f,x[f][m]=l,x[f][E]=p,x[f][S]=d,x[l]={},x[l][v]=f,x[l][m]=l,x[l][g]=c,x[l][y]=l,x[l][b]=h,x[l][w]=l,x[l][E]=p,x[l][S]=d,x[c]={},x[c][v]=c,x[c][m]=c,x[c][g]=c,x[c][y]=c,x[c][b]=c,x[c][w]=c,x[c][E]=p,x[c][S]=d,x[h]={},x[h][v]=h,x[h][m]=h,x[h][g]=h,x[h][y]=h,x[h][b]=h,x[h][w]=h,x[h][E]=p,x[h][S]=d,x[p]={},x[p][v]=p,x[p][m]=p,x[p][g]=p,x[p][y]=p,x[p][b]=p,x[p][w]=p,x[p][E]=p,x[p][S]=d,x[d]={},x[d][v]=d,x[d][m]=d,x[d][g]=d,x[d][y]=d,x[d][b]=d,x[d][w]=d,x[d][E]=d,x[d][S]=d;var T=function(s){this.id=-1,this.name=s.name||o,this.parent=s.parent||null,this.run=s.run,this.subtasks=[],this.error=!1,this.state=f,this.blocks=0,this.timeoutId=null,this.swapTime=null,this.userData=null,this.id=i++,r[this.id]=this,n>=1&&e.log.verbose(t,"[%s][%s] init",this.id,this.name,this)};T.prototype.debug=function(n){n=n||"",e.log.debug(t,n,"[%s][%s] task:",this.id,this.name,this,"subtasks:",this.subtasks.length,"queue:",s)},T.prototype.next=function(e,t){typeof e=="function"&&(t=e,e=this.name);var n=new T({run:t,name:e,parent:this});return n.state=l,n.type=this.type,n.successCallback=this.successCallback||null,n.failureCallback=this.failureCallback||null,this.subtasks.push(n),this},T.prototype.parallel=function(t,n){return e.util.isArray(t)&&(n=t,t=this.name),this.next(t,function(r){var i=r;i.block(n.length);var s=function(t,r){e.task.start({type:t,run:function(e){n[r](e)},success:function(e){i.unblock()},failure:function(e){i.unblock()}})};for(var o=0;o<n.length;o++){var u=t+"__parallel-"+r.id+"-"+o,a=o;s(u,a)}})},T.prototype.stop=function(){this.state=x[this.state][v]},T.prototype.start=function(){this.error=!1,this.state=x[this.state][m],this.state===l&&(this.start=new Date,this.run(this),C(this,0))},T.prototype.block=function(e){e=typeof e=="undefined"?1:e,this.blocks+=e,this.blocks>0&&(this.state=x[this.state][g])},T.prototype.unblock=function(e){return e=typeof e=="undefined"?1:e,this.blocks-=e,this.blocks===0&&this.state!==p&&(this.state=l,C(this,0)),this.blocks},T.prototype.sleep=function(e){e=typeof e=="undefined"?0:e,this.state=x[this.state][b];var t=this;this.timeoutId=setTimeout(function(){t.timeoutId=null,t.state=l,C(t,0)},e)},T.prototype.wait=function(e){e.wait(this)},T.prototype.wakeup=function(){this.state===h&&(cancelTimeout(this.timeoutId),this.timeoutId=null,this.state=l,C(this,0))},T.prototype.cancel=function(){this.state=x[this.state][E],this.permitsNeeded=0,this.timeoutId!==null&&(cancelTimeout(this.timeoutId),this.timeoutId=null),this.subtasks=[]},T.prototype.fail=function(e){this.error=!0,k(this,!0);if(e)e.error=this.error,e.swapTime=this.swapTime,e.userData=this.userData,C(e,0);else{if(this.parent!==null){var t=this.parent;while(t.parent!==null)t.error=this.error,t.swapTime=this.swapTime,t.userData=this.userData,t=t.parent;k(t,!0)}this.failureCallback&&this.failureCallback(this)}};var N=function(e){e.error=!1,e.state=x[e.state][m],setTimeout(function(){e.state===l&&(e.swapTime=+(new Date),e.run(e),C(e,0))},0)},C=function(e,t){var n=t>u||+(new Date)-e.swapTime>a,r=function(t){t++;if(e.state===l){n&&(e.swapTime=+(new Date));if(e.subtasks.length>0){var r=e.subtasks.shift();r.error=e.error,r.swapTime=e.swapTime,r.userData=e.userData,r.run(r),r.error||C(r,t)}else k(e),e.error||e.parent!==null&&(e.parent.error=e.error,e.parent.swapTime=e.swapTime,e.parent.userData=e.userData,C(e.parent,t))}};n?setTimeout(r,0):r(t)},k=function(i,o){i.state=p,delete r[i.id],n>=1&&e.log.verbose(t,"[%s][%s] finish",i.id,i.name,i),i.parent===null&&(i.type in s?s[i.type].length===0?e.log.error(t,"[%s][%s] task queue empty [%s]",i.id,i.name,i.type):s[i.type][0]!==i?e.log.error(t,"[%s][%s] task not first in queue [%s]",i.id,i.name,i.type):(s[i.type].shift(),s[i.type].length===0?(n>=1&&e.log.verbose(t,"[%s][%s] delete queue [%s]",i.id,i.name,i.type),delete s[i.type]):(n>=1&&e.log.verbose(t,"[%s][%s] queue start next [%s] remain:%s",i.id,i.name,i.type,s[i.type].length),s[i.type][0].start())):e.log.error(t,"[%s][%s] task queue missing [%s]",i.id,i.name,i.type),o||(i.error&&i.failureCallback?i.failureCallback(i):!i.error&&i.successCallback&&i.successCallback(i)))};e.task=e.task||{},e.task.start=function(r){var i=new T({run:r.run,name:r.name||o});i.type=r.type,i.successCallback=r.success||null,i.failureCallback=r.failure||null,i.type in s?s[r.type].push(i):(n>=1&&e.log.verbose(t,"[%s][%s] create queue [%s]",i.id,i.name,i.type),s[i.type]=[i],N(i))},e.task.cancel=function(e){e in s&&(s[e]=[s[e][0]])},e.task.createCondition=function(){var e={tasks:{}};return e.wait=function(t){t.id in e.tasks||(t.block(),e.tasks[t.id]=t)},e.notify=function(){var t=e.tasks;e.tasks={};for(var n in t)t[n].unblock()},e}}var r="task";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/task",["require","module","./debug","./log","./util"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){function e(e){function n(t,n){var r=n.toString(16);r[0]>="8"&&(r="00"+r);var i=e.util.hexToBytes(r);t.putInt32(i.length),t.putBytes(i)}function r(e,t){e.putInt32(t.length),e.putString(t)}function i(){var t=e.md.sha1.create(),n=arguments.length;for(var r=0;r<n;++r)t.update(arguments[r]);return t.digest()}var t=e.ssh=e.ssh||{};t.privateKeyToPutty=function(t,s,o){o=o||"",s=s||"";var u="ssh-rsa",a=s===""?"none":"aes256-cbc",f="PuTTY-User-Key-File-2: "+u+"\r\n";f+="Encryption: "+a+"\r\n",f+="Comment: "+o+"\r\n";var l=e.util.createBuffer();r(l,u),n(l,t.e),n(l,t.n);var c=e.util.encode64(l.bytes(),64),h=Math.floor(c.length/66)+1;f+="Public-Lines: "+h+"\r\n",f+=c;var p=e.util.createBuffer();n(p,t.d),n(p,t.p),n(p,t.q),n(p,t.qInv);var d;if(!s)d=e.util.encode64(p.bytes(),64);else{var v=p.length()+16-1;v-=v%16;var m=i(p.bytes());m.truncate(m.length()-v+p.length()),p.putBuffer(m);var g=e.util.createBuffer();g.putBuffer(i("\0\0\0\0",s)),g.putBuffer(i("\0\0\0",s));var y=e.aes.createEncryptionCipher(g.truncate(8),"CBC");y.start(e.util.createBuffer().fillWithByte(0,16)),y.update(p.copy()),y.finish();var b=y.output;b.truncate(16),d=e.util.encode64(b.bytes(),64)}h=Math.floor(d.length/66)+1,f+="\r\nPrivate-Lines: "+h+"\r\n",f+=d;var w=i("putty-private-key-file-mac-key",s),E=e.util.createBuffer();r(E,u),r(E,a),r(E,o),E.putInt32(l.length()),E.putBuffer(l),E.putInt32(p.length()),E.putBuffer(p);var S=e.hmac.create();return S.start("sha1",w),S.update(E.bytes()),f+="\r\nPrivate-MAC: "+S.digest().toHex()+"\r\n",f},t.publicKeyToOpenSSH=function(t,i){var s="ssh-rsa";i=i||"";var o=e.util.createBuffer();return r(o,s),n(o,t.e),n(o,t.n),s+" "+e.util.encode64(o.bytes())+" "+i},t.privateKeyToOpenSSH=function(t,n){return n?e.pki.encryptRsaPrivateKey(t,n,{legacy:!0,algorithm:"aes128"}):e.pki.privateKeyToPem(t)}}var r="ssh";if(typeof n!="function"){if(typeof module!="object"||!module.exports)return typeof forge=="undefined"&&(forge={}),e(forge);var i=!0;n=function(e,n){n(t,module)}}var s,o=function(t,n){n.exports=function(n){var i=s.map(function(e){return t(e)}).concat(e);n=n||{},n.defined=n.defined||{};if(n.defined[r])return n[r];n.defined[r]=!0;for(var o=0;o<i.length;++o)i[o](n);return n[r]}},u=n;n=function(e,t){return s=typeof e=="string"?t.slice(2):e.slice(2),i?(delete n,u.apply(null,Array.prototype.slice.call(arguments,0))):(n=u,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/ssh",["require","module","./util","./sha1","./aes","./hmac"],function(){o.apply(null,Array.prototype.slice.call(arguments,0))})}(),function(){var e="forge";if(typeof n!="function"){if(typeof module!="object"||!module.exports){typeof forge=="undefined"&&(forge={disableNativeCode:!1});return}var r=!0;n=function(e,n){n(t,module)}}var i,s=function(t,n){n.exports=function(n){var r=i.map(function(e){return t(e)});n=n||{},n.defined=n.defined||{};if(n.defined[e])return n[e];n.defined[e]=!0;for(var s=0;s<r.length;++s)r[s](n);return n},n.exports.disableNativeCode=!1,n.exports(n.exports)},o=n;n=function(e,t){return i=typeof e=="string"?t.slice(2):e.slice(2),r?(delete n,o.apply(null,Array.prototype.slice.call(arguments,0))):(n=o,n.apply(null,Array.prototype.slice.call(arguments,0)))},n("js/forge",["require","module","./aes","./aesCipherSuites","./asn1","./debug","./des","./hmac","./log","./pbkdf2","./pem","./pkcs7","./pkcs1","./pkcs12","./pki","./prng","./pss","./random","./rc2","./task","./tls","./util","./md","./mgf1","./ssh"],function(){s.apply(null,Array.prototype.slice.call(arguments,0))})}(),window.forge=t("js/forge")})();
TP.boot.$srcPath = '';

        
        TP.extern.forge = forge;
        
    
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETCryptoPost.js';
TP.definePrimitive('decryptStorageValue',function(b,c){var a,d,e,f,g,h;if(!TP.isString(b)||!TP.isString(c)){return TP.raise(this,'TP.sig.InvalidString',arguments);}if(TP.notValid(a=TP.json2js(b))){return null;}if(TP.isEmpty(d=TP.extern.forge.util.hexToBytes(a.at('salt')))){return null;}if(TP.isEmpty(e=TP.extern.forge.util.hexToBytes(a.at('iv')))){return null;}if(TP.isEmpty(f=a.at('value'))){return null;}g=c.computeEncryptionKey(d);h=f.decrypt(g,TP.hc('iv',e));return h;});TP.definePrimitive('encryptStorageValue',function(c,d){var a,b,e,f,g,h;if(!TP.isString(c)||!TP.isString(d)){return TP.raise(this,'TP.sig.InvalidString',arguments);}a=TP.generateRandomValue(128/8);b=TP.generateRandomValue(128/8);e=d.computeEncryptionKey(a);f=c.encrypt(e,TP.hc('iv',b));g=TP.hc('salt',TP.extern.forge.util.bytesToHex(a),'iv',TP.extern.forge.util.bytesToHex(b),'value',f);h=TP.js2json(g);return h;});TP.definePrimitive('hash',function(c,f,g){var b,d,e,a;if(TP.notValid(c)){return TP.raise(null,'TP.sig.InvalidParameter',arguments);}b=TP.str(c);d=TP.ifInvalid(f,TP.HASH_SHA1);e=TP.ifInvalid(g,TP.HASH_HEX);switch(d){case TP.HASH_MD5:a=TP.extern.forge.md.md5.create();a.update(b);break;case TP.HASH_SHA1:a=TP.extern.forge.md.sha1.create();a.update(b);break;}switch(e){case TP.HASH_B64:return TP.extern.forge.util.encode64(a.digest().data);case TP.HASH_LATIN1:return a.digest().data;case TP.HASH_HEX:return a.digest().toHex();}});TP.definePrimitive('hmac',function(d,b,g,h){var c,e,f,a;if(TP.notValid(d)||TP.notValid(b)){return TP.raise(null,'TP.sig.InvalidParameter',arguments);}c=TP.str(d);e=TP.ifInvalid(g,TP.HASH_SHA1);f=TP.ifInvalid(h,TP.HASH_HEX);a=TP.extern.forge.hmac.create();switch(e){case TP.HASH_MD5:a.start('MD5',b);a.update(c);break;case TP.HASH_SHA1:a.start('SHA1',b);a.update(c);break;}switch(f){case TP.HASH_B64:return TP.extern.forge.util.encode64(a.digest().data);case TP.HASH_LATIN1:return a.digest().data;case TP.HASH_HEX:return a.digest().toHex();}});TP.definePrimitive('generateRandomValue',function(a){if(!TP.isNumber(a)){return TP.raise(null,'TP.sig.InvalidNumber',arguments);}return TP.extern.forge.random.getBytesSync(a);});String.Inst.defineMethod('computeEncryptionKey',function(d,a){var e,b,c,f;if(!TP.isString(d)){return this.raise('TP.sig.InvalidString',arguments);}e=this.asString();if(TP.isKindOf(a,TP.lang.Hash)){b=a.atIfInvalid('keySize',TP.PBKDF2_KEYSIZE);c=a.atIfInvalid('iterationCount',TP.PBKDF2_ITERATION_COUNT);}else{b=TP.PBKDF2_KEYSIZE;c=TP.PBKDF2_ITERATION_COUNT;}f=TP.extern.forge.pkcs5.pbkdf2(e,d,c,b);return f;});String.Inst.defineMethod('decrypt',function(b,g){var c,d,e,a,f;if(!TP.isString(b)){return this.raise('TP.sig.InvalidString',arguments);}c=this.asString();d=TP.ifInvalid(g,TP.hc());if(TP.isEmpty(e=d.at('iv'))){return this.raise('TP.sig.InvalidParameter',arguments);}a=TP.extern.forge.aes.createDecryptionCipher(b,'CBC');f=TP.extern.forge.util.createBuffer(TP.extern.forge.util.hexToBytes(c),'raw');a.start(e);a.update(f);a.finish();return a.output.data;});TP.defineCommonMethod('encrypt',function(b,f){var c,d,e,a;if(!TP.isString(b)){return this.raise('TP.sig.InvalidString',arguments);}c=this.asString();d=TP.ifInvalid(f,TP.hc());if(TP.isEmpty(e=d.at('iv'))){return this.raise('TP.sig.InvalidParameter',arguments);}a=TP.extern.forge.aes.createEncryptionCipher(b,'CBC');a.start(e);a.update(TP.extern.forge.util.createBuffer(c));a.finish();return a.output.toHex();});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETInheritance.js';
String.Inst.defineMethod('isJSIdentifier',function(){return TP.regex.JS_IDENTIFIER.test(this);});String.Inst.defineMethod('asJSIdentifier',function(d){var b,c,a;if(this.isJSIdentifier()){return this;}b=this;if(!TP.regex.JS_FIRST_CHAR.test(this)){b='$'+this;}c=TP.ifInvalid(d,true);TP.regex.JS_IDENT_REPLACE.lastIndex=0;a=b.replace(TP.regex.JS_IDENT_REPLACE,'_');if(c&&TP.isValid(TP.ifInvalid(TP[a],TP.global[a]))){a=TP.genID(a);}return a;});TP.sys.addCustomType('TP.lang.RootObject',TP.lang.RootObject);TP.lang.RootObject.Type.defineMethod('asSource',function(){return this.getSupertype().getName()+'.defineSubtype(\''+this.getNamespacePrefix()+':'+this.getLocalName()+'\')';});TP.lang.RootObject.Type.defineMethod('asString',function(a){return this.getName();});TP.lang.RootObject.Type.defineMethod('defineSubtype',function(m){var b,f,d,k,l,e,i,j,a,g,h,n,c;if(TP.isEmpty(m)){return this.raise('TP.sig.InvalidTypeName',arguments);}b=m.split(/:|\./);switch(b.length){case 1:c=this.getNamespaceRoot();d=this.getNamespacePrefix();f=b[0];break;case 2:if(b[0]==='APP'||b[0]==='TP'){TP.ifError()?TP.error('Invalid namespace: '+b[0],TP.LOG,arguments):0;return;}c=this.getNamespaceRoot();d=b[0];f=b[1];break;default:if(b[0]==='TP'||b[0]==='APP'){c=b[0];d=b.slice(1,-1).join('.');}else{c=this.getNamespaceRoot();d=b.slice(0,-1).join('.');}f=b[b.length-1];}if(TP.regex.INTERNAL_TYPENAME.test(f)){return this.raise('TP.sig.InvalidTypeName',arguments);}k=TP.defineNamespace(d,c);e=c+'.'+d+'.'+f;if(TP.sys.cfg('tibet.unique_types')){if(TP.isType(l=TP.sys.getTypeByName(e,false))){return l;}}i=e+'.Type';j=e+'.Inst';TP.sys[j]=new Function();h=TP.sys[j];h[TP.NAME]=j;h.prototype=this[TP.INSTC].$constructPrototype();h.prototype[TP.TYPE]=this[TP.INSTC];h.prototype[TP.NAME]=j;h.prototype[TP.ID]=j;TP.sys[i]=new Function();g=TP.sys[i];g[TP.NAME]=i;g.prototype=this[TP.TYPEC].$constructPrototype();g.prototype[TP.NAME]=i;g.prototype[TP.ID]=i;g.getName=function(){return'TP.meta.'+d+'.'+f;};a=new g();k[f]=a;g[TP.OWNER]=a;h[TP.OWNER]=a;a[TP.TYPE]=a;a[TP.TYPEC]=g;a[TP.INSTC]=h;a[TP.TNAME]=e;a[TP.RNAME]=e;a[TP.SUPER]=this;a[TP.SNAME]=this.getName();a[TP.NAME]=e;a[TP.ID]=e;TP.sys.addCustomType(e,a);a.setID(e);a.$abstract=false;a[TP.ANCESTOR_NAMES]=this.getSupertypeNames().copy();a[TP.ANCESTOR_NAMES].unshift(this.getName());a[TP.ANCESTORS]=this.getSupertypes().copy();a[TP.ANCESTORS].unshift(this);a.nsRoot=c;a.nsPrefix=d;a.localName=f;a.Type=a[TP.TYPEC].prototype;a.Type[TP.OWNER]=a;a.Inst=a[TP.INSTC].prototype;a.Inst[TP.OWNER]=a;this[TP.SUBTYPE_NAMES]=this[TP.SUBTYPE_NAMES]||TP.ac();this[TP.SUBTYPE_NAMES].push(e);this[TP.SUBTYPES]=this[TP.SUBTYPES]||TP.ac();this[TP.SUBTYPES].push(a);TP.sys.addMetadata(this,a,TP.SUBTYPE);if(TP.sys.$$shouldCacheDeepSubtypes()){this.getSupertypes().perform(function(c){var b;b=c[TP.SUBTYPES_DEEP];if(TP.isArray(b)){b.add(a);}b=c[TP.SUBTYPE_NAMES_DEEP];if(TP.isArray(b)){b.add(e);}});}if(TP.sys.shouldLogCodeChanges()){n=this.getName()+'.defineSubtype(\''+d+':'+f+'\');\n';TP.sys.logCodeChange(n,TP.TRACE,arguments);}TP.defineNamespace('meta.'+d,c);if(TP.regex.HAS_PERIOD.test(d)){b=d.split('.');c=self[c].meta;b.perform(function(a){c=c[a];});c[f]=g;}else{self[c].meta[d][f]=g;}return a;});TP.lang.RootObject.Type.defineMethod('getLocalName',function(){return this.$get('localName');});TP.lang.RootObject.Type.defineMethod('getNamespacePrefix',function(){return this.$get('nsPrefix');});TP.lang.RootObject.Type.defineMethod('getNamespaceRoot',function(){return this.$get('nsRoot');});TP.lang.RootObject.Type.defineMethod('getSupertypes',function(){return this[TP.ANCESTORS]||TP.ac();});TP.sys.defineMethod('$$typeNameFunc',function(a){return a.getTypeName();});TP.defineMetaInstMethod('$init',function(){return this;});TP.defineMetaInstMethod('init',function(){return this;});TP.lang.RootObject.Type.defineMethod('isAbstract',function(a){if(TP.isBoolean(a)){this.$abstract=a;}return this.$abstract;});TP.lang.RootObject.Type.defineMethod('canConstruct',function(){return false;});TP.lang.RootObject.Type.defineMethod('constructForSignal',function(a){return this.construct();});TP.lang.RootObject.Type.defineMethod('constructViaSubtype',function(){var a,b;a=this.getConcreteType.apply(this,arguments);if(TP.notValid(a)||a===this){this.raise('TP.sig.NoConcreteType',arguments);return;}b=a.construct.apply(a,arguments);return b;});TP.lang.RootObject.Type.defineMethod('getConcreteType',function(){var a,b,c;a=this.getSubtypes(true);if(TP.isEmpty(a)){return;}a.sort(TP.SUBTYPE_SORT).reverse();c=arguments;b=a.detect(function(a){if(TP.isValid(a)){return a.canConstruct.apply(a,c);}return false;});return b;});TP.FunctionProto.defineAttribute('parsers');TP.lang.RootObject.Type.defineAttribute('parsers');TP.defineMetaTypeMethod('from',function(a){if(TP.isString(a)){return this.fromString.apply(this,arguments);}return this.callBestMethod(arguments,a,'from',null,'fromObject');});TP.lang.RootObject.Type.defineMethod('from',function(a){if(TP.isString(a)){return this.fromString.apply(this,arguments);}return this.callBestMethod(arguments,a,'from',null,'fromObject');});TP.defineMetaTypeMethod('fromObject',function(a){return this.construct(a);});TP.lang.RootObject.Type.defineMethod('fromObject',function(a){return this.construct.apply(this,arguments);});TP.defineMetaTypeMethod('fromString',function(a,b){return this.parse(a,b);});TP.lang.RootObject.Type.defineMethod('fromString',function(a,b){return this.parse(a,b);});TP.defineMetaTypeMethod('addParser',function(b){var a;if(!TP.isType(this)){return TP.raise(this,'TP.sig.InvalidOperation',arguments);}if(!TP.canInvoke(b,'parse')){return this.raise('TP.sig.InvalidParser',arguments,'Registered parsers must implement \'parse\'');}if(TP.notValid(a=this.$get('parsers'))){a=TP.ac();this.$set('parsers',a,false);}a.push(b);return this;});TP.lang.RootObject.Type.defineMethod('addParser',function(b){var a;if(!TP.canInvoke(b,'parse')){return this.raise('TP.sig.InvalidParser',arguments,'Registered parsers must implement \'parse\'');}if(TP.notValid(a=this.$get('parsers'))){a=TP.ac();this.$set('parsers',a,false);}a.push(b);return this;});TP.FunctionProto.defineMethod('parse',function(a,d){var b,c;if(!TP.isType(this)){return this(a,d);}b=this.$get('parsers');if(TP.notEmpty(b)){if(TP.isCallable(b)){c=b(a,this);}else{c=b.detectInvoke('parse',a,this);}if(TP.isValid(c)){return c;}}return this.callBestMethod(arguments,a,'parse',null,null,TP.ac(a,d));});Date.$$parse=Date.parse;Date.Type.defineMethod('parse',function(c){var a,b;if(TP.isDate(a=this.callNextMethod())){return a.getTime();}if(TP.isNumber(b=Date.$$parse(c))){return b;}return NaN;});TP.lang.RootObject.Type.defineMethod('parse',function(b,d){var a,c;a=this.$get('parsers');if(TP.notEmpty(a)){if(TP.isCallable(a)){c=a(b,this);}else{c=a.detectInvoke('parse',b,this);}if(TP.isValid(c)){return c;}}return this.callBestMethod(arguments,b,'parse',null,null,TP.ac(b,d));});TP.defineMetaInstMethod('as',function(a,e){var b,c,f,d;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.isString(a)){b='as'+a.asStartUpper();if(TP.canInvoke(this,b)){return this[b](e);}if(TP.notValid(c=TP.sys.require(a))){return a.transform(this,e);}f=a;}else if(!TP.isType(a)){if(TP.canInvoke(a,'transform')){switch(arguments.length){case 1:return a.transform(this);case 2:return a.transform(this,e);default:d=TP.args(arguments);d.atPut(0,this);return a.transform.apply(a,d);}}else{return;}}else{c=a;if(TP.canInvoke(c,'getName')){f=c.getName();}}if(TP.isKindOf(this,c)){return this;}if(TP.notEmpty(f)){b='as'+TP.escapeTypeName(f);if(!TP.canInvoke(this,b)){b='as'+TP.escapeTypeName(f.asJSIdentifier(false));}if(TP.canInvoke(this,b)){switch(arguments.length){case 1:return this[b]();case 2:return this[b](e);default:d=TP.args(arguments,1);return this[b].apply(this,d);}}}if(TP.canInvoke(c,'from')){switch(arguments.length){case 1:return c.from(this);case 2:return c.from(this,e);default:d=TP.args(arguments);d.atPut(0,this);return c.from.apply(c,d);}}return;});TP.defineMetaInstMethod('format',function(a,b){if(TP.isValid(a)){return a.transform(this,b);}return;});String.Inst.defineMethod('transformDate',function(c,d){var a,b;b=this.toString();if(TP.canInvoke(d,'at')){a=d.at(b);}if(TP.notValid(a)){if(TP.notValid(a=TP.iso.ISO8601.FORMATS.at(b))){if(TP.notValid(a=Date.FORMATS.at(b))){a=null;}}}if(TP.isString(a)){if(/Z$/.test(a)){return a.substitute(c,Date.UTC_TOKENS);}else if(/\+$/.test(a)){b=a.strip(/\+$/).substitute(c,Date.UTC_TOKENS);return b+c.getISOTimezone();}else{return a.substitute(c,Date.LOCALTIME_TOKENS);}}if(/Z$/.test(b)&&/%{/.test(b)){a=b.strip(/\Z$/);return a.substitute(c,Date.UTC_TOKENS);}else if(/\+$/.test(b)&&/%{/.test(b)){a=b.strip(/\+$/);return a.substitute(c,Date.UTC_TOKENS);}else if(/%{/.test(b)){return b.substitute(c,Date.LOCALTIME_TOKENS);}return b;});String.Inst.defineMethod('transformNumber',function(b,c){var a;a=this.toString();if(/#{/.test(a)){return a.substitute(b);}return a;});String.Inst.defineMethod('transformObject',function(b,d){var c,a;a=this.toString();if(/#{/.test(a)){c=TP.ifInvalid(TP.nc(b),b);return a.substitute(c);}else if(/%{/.test(a)){return a.substitute(b,TP.ifInvalid(d,TP.type(b)));}else if(TP.regex.SUBSTITUTION_STRING.test(a)){return a.substitute(b);}return a;});String.Inst.defineMethod('transformString',function(b,c){var a;a=this.toString();if(/@{/.test(a)){return a.substitute(b);}return this.transformObject(b,c);});TP.defineMetaInstMethod('getHandler',function(b,h){var c,g,a,e,d,f;if(TP.notValid(b)){return;}c=TP.ifInvalid(b.getOrigin(),'');c=TP.gid(c).split('#').last();g=TP.isEmpty(c)?false:true;if(g){a=b.getType().getHandlerName(c,false,b);if(TP.canInvoke(this,a)){return this[a];}a=b.getType().getHandlerName(c,true,b);if(TP.canInvoke(this,a)){return this[a];}}a=b.getType().getHandlerName(null,false,b);if(TP.canInvoke(this,a)){return this[a];}a=b.getType().getHandlerName(null,true,b);if(TP.canInvoke(this,a)){return this[a];}if(b.isSpoofed()){if(h){return;}e=b.getTypeSignalNames();}else{e=b.getSupertypeSignalNames();}for(f=0;f<e.getSize();f++){if(TP.isType(d=TP.sys.getTypeByName(e.at(f)))){if(g){a=d.getHandlerName(c,false);if(TP.canInvoke(this,a)){return this[a];}a=d.getHandlerName(c,true);if(TP.canInvoke(this,a)){return this[a];}}a=d.getHandlerName(null,false);if(TP.canInvoke(this,a)){return this[a];}a=d.getHandlerName(null,true);if(TP.canInvoke(this,a)){return this[a];}}}return;});TP.defineMetaInstMethod('handle',function(a,c){var b;if(TP.isCallable(b=this.getHandler(a,c))){return b.apply(this,TP.ac(a));}return;});TP.defineCommonMethod('process',function(b){var a;a=TP.request(b);return this.callBestMethod(arguments,a,'process',null,'processTP_sig_Request',TP.ac(a));});TP.defineCommonMethod('processAndExecuteWith',function(b,c){var a;a=TP.request(b);a.atPut('cmdExecute',true);a.atPut(TP.STDIN,TP.ac(c));return this.process(a);});TP.defineCommonMethod('processTP_sig_Request',function(b){var a;if(TP.notValid(a=b.get('result'))){a=this;}return a;});Window.Inst.defineMethod('canResolveDNU',function(a,b,c,d){return false;});TP.defineMetaInstMethod('canResolveDNU',function(a,b,c,d){return TP.canInvoke(a,b);});TP.defineMetaInstMethod('resolveDNU',function(c,a,b,d){if(!TP.canInvoke(this,a)){return;}switch(b.length){case 0:return this[a]();case 1:return this[a](b[0]);case 2:return this[a](b[0],b[1]);default:return this[a].apply(this,b);}});TP.sys.defineMethod('infer',function(b,a,f,m){var c,g,e,j,h,d,k,i,l;TP.debug('break.infer');if(TP.isType(b)){TP.sys.logInference('Method inferencing disabled for types.',TP.TRACE,arguments);return;}TP.sys.logInference('Checking for implementers of '+a,TP.TRACE,arguments);if(TP.notValid(k=TP.sys.getMethodOwners(a))){TP.sys.logInference('No implementers of '+a+' found.',TP.TRACE,arguments);return;}if(!TP.canInvoke(b,'getSupertypeNames')||TP.notValid(l=b.getSupertypeNames())){return;}i=k.getSize();if(i===0){TP.sys.logInference('No implementers of '+a+' found.',TP.TRACE,arguments);return;}else{TP.sys.logInference('Found '+i+' implementer(s) of '+a+'.',TP.TRACE,arguments);}for(g=0;g<i;g++){h=k.at(g).getName();if(l.containsString(h)){continue;}d='as(\''+h+'\')';if(h===b.getTypeName()){TP.sys.logInference('Inferring this.'+d+'.... would recurse. Skipping.',TP.TRACE,arguments);continue;}TP.sys.logInference('Inferring this.'+d+'.'+a+'()',TP.INFO,arguments);if(TP.sys.$$shouldInvokeInferences()){TP.sys.logInference('Invoking '+TP.id(b)+'.'+d+'.'+a+'();!',TP.INFO,arguments);j='var inst;\n'+'var res;\n'+'inst=this.'+d+';\n'+'if (TP.notValid(inst)) return;\n'+'res=inst.'+a+'.apply(inst, arguments);\n'+'if (TP.notValid(res)) return;\n'+'return res;\n';TP.sys.logInference('Generating inferred '+a+' method:\n'+j,TP.TRACE,arguments);e=TP.fc(j);if(TP.isMutable(b)){b.addLocalMethod(a,e);}else if(TP.isType(b)){b.Type.defineMethod(a,e);}else{b.getType().Inst.defineMethod(a,e);}if(TP.sys.shouldLogCodeChanges()){c='//\tInference generated method\n';c+=b.getTypeName()+'.add';if(TP.isType(b)){c+='TypeMethod(\'';}else{c+='InstMethod(\'';}c+=a+'\','+e.toString().strip(' anonymous')+');\n';TP.sys.logCodeChange(c,TP.TRACE,arguments);}switch(f.length){case 0:return b[a]();case 1:return b[a](f[0]);case 2:return b[a](f[0],f[1]);default:return b[a].apply(b,f);}}}return;});TP.sys.defineMethod('dnu',function(a,b,h,m){var i,l,d,c,p,n,e,g,f,j,o,k;TP.debug('break.dnu');if(TP.notValid(a)){return;}c=TP.id(a);p=TP.tname(a);if(TP.isWindow(a)){TP.debug('break.unbound');TP.sys.logInference((c||'Unresolvable window ')+' triggered backstop for method '+b,TP.TRACE,arguments);return;}if(TP.$$isDNU(a.getTypeName)||TP.$$isDNU(a.getID)||TP.$$isDNU(a.canResolveDNU)||TP.$$isDNU(a.resolveDNU)||TP.$$isDNU(a.as)||TP.$$isDNU(a.getSupertypeNames)||TP.$$isDNU(a.addLocalMethod)){TP.sys.logInference((c||'Unresponsive object ')+' triggered backstop for method '+b,TP.TRACE,arguments);return;}if(TP.sys.shouldLogInferences()){try{throw new Error();}catch(a){n=TP.getStackInfo(a);}TP.sys.logInference(a.getTypeName()+' '+c+' triggered DNU '+b+' at '+n.join(' \xBB '),TP.TRACE,arguments);}if(a.canResolveDNU(a,b,h,m)){TP.sys.logInference(a.getTypeName()+' '+c+' canResolve DNU '+b+'(...) !',TP.TRACE,arguments);return a.resolveDNU(a,b,h,m);}if(TP.sys.$$shouldUseInferencing()){if(TP.isString(b)){if(b.indexOf('get')===0){TP.sys.logInference('Inferring as("'+b.slice(3)+'") from '+a.getTypeName()+'.'+b+'(...)',TP.TRACE,arguments);if(TP.sys.$$shouldInvokeInferences()){d=a.as(b.slice(3));if(TP.isDefined(d)){return d;}}TP.sys.logInference('Inferring as("'+b.slice(3)+'") from '+a.getTypeName()+'.'+b+'(...) was unsuccessful.',TP.TRACE,arguments);}if(b.indexOf('as')===0){g=b.slice(2);TP.sys.logInference('Inferring '+g+'.from(\''+a.getTypeName()+'\')',TP.TRACE,arguments);e=TP.sys.getTypeByName(g);if(TP.isType(e)){f=a.getSupertypeNames().copy();f.splice(0,0,a.getTypeName());TP.sys.logInference('Checking against types '+f,TP.TRACE,arguments);o=f.getSize();for(i=0;i<o;i++){k=TP.escapeTypeName(f.at(i));j=e.getPropertyScope('from'+k);if(j===TP.OVERRIDDEN||j===TP.INTRODUCED||j===TP.LOCAL){TP.sys.logInference('Invoking '+g+'.from(\''+k+'\')',TP.TRACE,arguments);l=new Array();l.push(a);return e['from'+k].apply(e,l.addAll(h).asArray());}}}TP.sys.logInference('Inferring '+g+'.from(\''+a.getTypeName()+'\') was unsuccessful.',TP.TRACE,arguments);}d=TP.sys.infer(a,b,h,m);if(TP.isDefined(d)){return d;}}}TP.sys.logInference(a.getTypeName()+' '+c+' could not solve for '+b,TP.TRACE,arguments);if(TP.sys.shouldUseDebugger()){return TP.sys.$launchDebugger(arguments);}return;});TP.sys.$methodStats=TP.hc();TP.definePrimitive('profile',function(e,f,g){var a,b,c,d;d=TP.ifInvalid(g,1);if(TP.isArray(f)){b=TP.dc();for(a=0;a<d;a++){e.apply(null,f);}c=TP.dc();}else{b=TP.dc();for(a=0;a<d;a++){e();}c=TP.dc();}return TP.ac(c.getTime()-b.getTime(),(c.getTime()-b.getTime())/d);});TP.sys.defineMethod('addStatistic',function(j,h,i){var d,a,f,e,k,l,n,g,m,c,b;f=j.getName();e=TP.name(j[TP.OWNER]);if(TP.notValid(f)||TP.notValid(e)||e===TP.NONE){return;}if(TP.notValid(d=TP.sys.$methodStats.at(f))){d=TP.hc();TP.sys.$methodStats.atPut(f,d);}if(TP.notValid(a=d.at(e))){a=TP.hc();d.atPut(e,a);}g=TP.ifInvalid(a.at('cnt'),0);a.atPut('cnt',g+1);m=TP.ifInvalid(a.at('sum'),0);a.atPut('sum',m+h);k=TP.ifInvalid(a.at('max'),0);a.atPut('max',Math.max(h,k));l=TP.ifInvalid(a.at('min'),Number.POSITIVE_INFINITY);a.atPut('min',Math.min(h,l));n=TP.ifInvalid(a.at('avg'),0);a.atPut('avg',a.at('sum')/a.at('cnt'));if(TP.isArray(i)){if(TP.notValid(c=a.at('stacks'))){c=TP.hc();a.atPut('stacks',c);}b=i.join(' << ');TP.regex.CALL_STACK_ID.lastIndex=0;b=b.replace(TP.regex.CALL_STACK_ID,'anonymous$1','g');if(TP.notValid(g=c.at(b))){c.atPut(b,1);}else{c.atPut(b,g++);}}return d;});TP.sys.defineMethod('getStatistics',function(b){var c,d,a;if(TP.notValid(b)){return TP.sys.$methodStats;}c=b.getName();if(TP.notValid(c)){return;}a=TP.sys.$methodStats.at(c);d=TP.name(b[TP.OWNER]);if(TP.notValid(d)){return a;}if(TP.isValid(a)){return a.at(d);}return;});TP.FunctionProto.defineMethod('getImplementers',function(a){if(this===Function){return TP.sys.getMethodOwners(a);}if(TP.isType(this)){return TP.ac();}return TP.sys.getMethodOwners(this);});TP.defineMetaTypeMethod('executeTraitResolution',function(){return this;});TP.defineMetaTypeMethod('getSupertype',function(){if(this===Object){return;}if(!TP.isType(this)){return Object;}return this[TP.SUPER];});TP.defineMetaTypeMethod('getSupertypeName',function(){if(this===Object){return;}if(!TP.isType(this)){return'Object';}return this[TP.SUPER].getName();});TP.defineMetaTypeMethod('defineSubtype',function(a){return this.raise('TP.sig.InheritanceException',arguments,'Attempt to subtype Native type.');});TP.defineMetaTypeMethod('$alloc',function(){if(TP.notValid(TP.ifInvalid(TP[this.$getName()],TP.global[this.$getName()]))){return new TP.sys[(this.$getName())]();}else{return new TP.ifInvalid(TP[this.$getName()],TP.global[this.$getName()])();}});TP.defineMetaTypeMethod('isAbstract',function(a){return false;});TP.defineMetaTypeMethod('canConstruct',function(){return false;});TP.defineMetaTypeMethod('constructViaSubtype',function(){return;});TP.defineMetaTypeMethod('getConcreteType',function(){if(TP.isType(this)){return this;}return this.getType();});TP.defineMetaTypeMethod('construct',function(){var a,b;if(this.isAbstract()){return this.constructViaSubtype.apply(this,arguments);}a=this.$alloc();a[TP.TYPE]=this[TP.TYPE];a=a.$init.apply(a,arguments);b=a.init.apply(a,arguments);if(TP.isValid(b)){return b;}else{return a;}});TP.FunctionProto.defineMethod('getValue',function(){return this.apply(null,arguments);});TP.FunctionProto.defineMethod('getHandler',function(a){if(!TP.isType(this)){return this;}return this.getBestMethod(arguments,a,'handle','','handleSignal');});TP.FunctionProto.defineMethod('handle',function(a){var b;if(!TP.isType(this)){return this(a);}if(TP.notValid(b=this.construct())){return this.raise('TP.sig.InvalidHandler',arguments,'Unable to construct handler instance.');}return b.handle(a);});TP.lang.RootObject.Type.defineMethod('fromTP_sig_Signal',function(a){return this.construct();});TP.lang.RootObject.Type.defineMethod('handleSignal',function(a){var b;if(TP.notValid(b=this.from(a))){return this.raise('TP.sig.InvalidHandler',arguments,'Unable to construct handler instance');}return b.handle(a);});TP.definePrimitive('backstop',function(f,k,j){var b,h,c,e,i,d,a,g;b=TP.ifInvalid(k,TP.ObjectProto);h=j?true:false;c=0;e=TP.isArray(f)?f:TP.ac().add(f);if(TP.isEmpty(e)){return c;}if(TP.boot.isUA('GECKO')&&b===TP.ObjectProto){return 0;}i=e.getSize();for(d=0;d<i;d++){if(TP.isEmpty(a=e.at(d))){continue;}if(!h&&TP.canInvoke(b,a)){continue;}if(TP.sys.$noDNUs.containsString(a)){continue;}g=Function.constructDNU(a);try{Object.defineProperty(b,a,TP.PROPERTY_DEFAULTS);b[a]=g;c++;}catch(b){TP.ifWarn()?TP.warn(TP.ec(b,'Unable to assign backstop method: '+a),TP.INFERENCE_LOG,arguments):0;}}return c;});TP.definePrimitive('delegate',function(f,h,k){var e,j,b,c,i,d,a,g;if(TP.notValid(h)){TP.raise(null,'TP.sig.InvalidParameter',arguments);return;}e=h;j=k?true:false;b=0;c=TP.isArray(f)?f:TP.ac().add(f);if(TP.isEmpty(c)){return b;}i=c.getSize();for(d=0;d<i;d++){if(TP.isEmpty(a=c.at(d))){continue;}if(!j&&TP.canInvoke(e,a)){continue;}g=Function.constructDelegator(a);try{e[a]=g;b++;}catch(b){TP.ifWarn()?TP.warn(TP.ec(b,'Unable to assign delegation wrapper: '+a),TP.INFERENCE_LOG,arguments):0;}}return b;});TP.definePrimitive('unstop',function(g,j){var b,c,d,e,h,f,a,i;b=TP.ifInvalid(j,TP.ObjectProto);c=0;e=false;d=TP.isArray(g)?g:TP.ac().add(g);if(TP.isEmpty(d)){return c;}if(TP.boot.isUA('GECKO')&&b===TP.ObjectProto){e=true;}h=d.getSize();for(f=0;f<h;f++){if(TP.isEmpty(a=d.at(f))){continue;}if(!TP.canInvoke(b,a)&&!e){continue;}if(e){i=Function.constructNSM(a);try{b[a]=i;c++;}catch(b){TP.ifWarn()?TP.warn(TP.ec(b,'Unable to assign NSM method: '+a),TP.INFERENCE_LOG,arguments):0;}}else{if(TP.owns(b,a)&&TP.$$isDNU(b[a])){try{delete b[a];c++;}catch(b){TP.ifWarn()?TP.warn(TP.ec(b,'Unable to remove DNU method: '+a),TP.INFERENCE_LOG,arguments):0;}}}}return c;});TP.lang.RootObject.Type.defineAttribute('$traitsResolved');TP.lang.RootObject.Type.defineAttribute('$traitsTypeResolutions');TP.lang.RootObject.Type.defineAttribute('$traitsInstResolutions');TP.lang.RootObject.Type.defineMethod('addTraitsFrom',function(d){var b,c,a;if(TP.notValid(b=this[TP.TRAITS])){b=TP.ac();this[TP.TRAITS]=b;}c=arguments.length;for(a=0;a<c;a++){if(TP.isType(arguments[a])&&!b.contains(arguments[a],TP.IDENTITY)){b.push(arguments[a]);}}return this;});TP.lang.RootObject.Type.defineMethod('executeTraitResolution',function(){if(!this.get('$traitsResolved')){this.getSupertype().executeTraitResolution();if(this.hasTraits()){this.$performTraitComposition();this.$performTraitResolution();}else{this.set('$traitsResolved',true);}}return this;});TP.lang.RootObject.Type.defineMethod('getAllTraits',function(){var a,c,b,d;if(TP.notEmpty(a=this[TP.TRAITS])){c=a.getSize();for(b=0;b<c;b++){if(TP.notEmpty(d=a.at(b).getAllTraits())){a=a.concat(d);}}}return a;});TP.lang.RootObject.Type.defineMethod('hasTraits',function(){return TP.notEmpty(this[TP.TRAITS]);});TP.lang.RootObject.Type.defineMethod('$performTraitComposition',function(){var c,a,d,b,e,f;if(TP.isTrue(this.get('$traitsResolved'))){return this;}if(TP.isEmpty(c=this.getAllTraits())){return this;}d=this;if(TP.notValid(a=this.get('$traitsTypeResolutions'))){a=TP.hc();this.set('$traitsTypeResolutions',a);}b=this.getPrototype();e=b.getInterface('known');c.perform(function(c){var f,g;f=c.getPrototype();g=f.getInterface('known');g.perform(function(g){var h,i,j;if(e.indexOf(g)!==TP.NOT_FOUND&&b[g]===f[g]){return;}if(TP.isValid(h=a.at(g))){i=h.at('sources');if(i.indexOf(c)!==TP.NOT_FOUND){return;}i.push(c);}else{if(TP.isDefined(j=b[g])){h=TP.hc('sources',TP.ac(d,c));}else{h=TP.hc('sources',TP.ac(c));}a.atPut(g,h);}});});if(TP.notValid(a=this.get('$traitsInstResolutions'))){a=TP.hc();this.set('$traitsInstResolutions',a);}b=this.getInstPrototype();f=b.getInterface('known');c.perform(function(c){var e,g;e=c.getInstPrototype();g=e.getInterface('known');g.perform(function(g){var h,i,j;if(f.indexOf(g)!==TP.NOT_FOUND&&b[g]===e[g]){return;}if(TP.isValid(h=a.at(g))){i=h.at('sources');if(i.indexOf(c)!==TP.NOT_FOUND){return;}i.push(c);}else{if(TP.isDefined(j=b[g])){h=TP.hc('sources',TP.ac(d,c));}else{h=TP.hc('sources',TP.ac(c));}a.atPut(g,h);}});});return this;});TP.lang.RootObject.Type.defineMethod('$performTraitResolution',function(){var d,e,b,c,a;if(!this.hasTraits()){return this;}d=this;b=this.get('$traitsTypeResolutions');if(TP.notEmpty(b)){a=TP.hc();b.perform(function(g){var c,b,i,h,d,e,f;c=g.first();b=g.last();if(TP.notValid(i=b.at('resolvesTo'))){h=b.at('sources').getSize();for(d=0;d<h;d++){e=b.at('sources').at(d);if(e.getPrototype()[c]!==TP.REQUIRED){if(TP.isValid(b.at('resolvesTo'))){if(TP.notValid(f=a.at(c))){f=TP.ac();}f.push(b.at('resolvesTo'));}else{b.atPut('resolvesTo',e);}}}}if(TP.notValid(b.at('resolvesTo'))){a.at(c).push(TP.UNDEF);}});if(TP.notEmpty(a)){return this.raise('TP.sig.InvalidInstantiation',arguments,TP.sc('Unresolved type traits: ',TP.str(a)));}}c=this.get('$traitsInstResolutions');if(TP.notEmpty(c)){a=TP.hc();e=d.getInstPrototype();c.perform(function(g){var c,b,i,h,d,e,f;c=g.first();b=g.last();if(TP.notValid(i=b.at('resolvesTo'))){h=b.at('sources').getSize();for(d=0;d<h;d++){e=b.at('sources').at(d);if(e.getInstPrototype()[c]!==TP.REQUIRED){if(TP.isValid(b.at('resolvesTo'))){if(TP.notValid(f=a.at(c))){f=TP.ac();}f.push(b.at('resolvesTo'));}else{b.atPut('resolvesTo',e);}}}}if(TP.notValid(b.at('resolvesTo'))){a.at(c).push(TP.UNDEF);}});if(TP.notEmpty(a)){return this.raise('TP.sig.InvalidInstantiation',arguments,TP.sc('Unresolved instance traits: ',TP.str(a)));}}b.perform(function(c){var a,b;a=c.first();b=c.last().at('resolvesTo');if(TP.isType(b)&&this.Type[a]!==TP.REQUIRED&&b.Type[a]===this.Type[a]){return;}this.$populateTraitedSlot(b,a,this.Type,false);}.bind(this));c.perform(function(c){var a,b;a=c.first();b=c.last().at('resolvesTo');if(TP.isType(b)&&this.Inst[a]!==TP.REQUIRED&&b.Inst[a]===this.Inst[a]){return;}this.$populateTraitedSlot(b,a,this.Inst,true);}.bind(this));this.set('$traitsResolved',true);return this;});TP.lang.RootObject.Type.defineMethod('$populateTraitedSlot',function(e,b,k,j){var f,c,g,i,d,h,a;f=this;if(TP.isFunction(e)){k.defineMethod(b,e);}else{if(TP.isArray(e)){c=TP.isString(e.first())?TP.sys.getTypeByName(e.first()):e.first();g=e.last();if(TP.isType(c)){if(j){i=f.Inst[b];d=c.Inst[b];}else{i=f.Type[b];d=c.Type[b];}if(TP.isFunction(g)){d=g(i,d);}else if(TP.isString(g)){switch(g){case TP.BEFORE:a=function(){a.$resolutionMethod.apply(this,arguments);return a.$mainMethod.apply(this,arguments);};a.$resolutionMethod=d;a.$mainMethod=i;a.$propName=b;h=b;break;case TP.AFTER:a=function(){a.$mainMethod.apply(this,arguments);return a.$resolutionMethod.apply(this,arguments);};a.$resolutionMethod=d;a.$mainMethod=i;a.$propName=b;h=b;break;default:h=g;}}}else{}}else if(TP.isString(e)){if(TP.isType(c=TP.sys.getTypeByName(e))&&c!==f){if(j){d=c.Inst[b];}else{d=c.Type[b];}h=b;}else{}}else if(TP.isType(c=e)&&c!==f){if(j){d=c.Inst[b];}else{d=c.Type[b];}h=b;}else{}if(!TP.isMethod(d)){if(j){if(TP.notDefined(f.Inst[b])){f.Inst.defineAttribute(b,d);}}else{if(TP.notDefined(f.Type[b])){f.Type.defineAttribute(b,d);}}return this;}if(TP.notValid(a)){a=function(){return a.$resolutionMethod.apply(this,arguments);};a.$resolutionMethod=d;}k.defineMethod(h,a);a[TP.OWNER]=c;a[TP.DISPLAY]=a[TP.DISPLAY]+'.trait.'+c.getID()+'.'+b;}return this;});TP.lang.RootObject.Inst.defineMethod('resolveTrait',function(d,b,e){var c,a;if(!TP.isPrototype(this)){return this;}if(TP.isTrue(this.get('$traitsResolved'))){return this;}if(TP.notValid(c=this[TP.OWNER].get('$traitsInstResolutions'))){c=TP.hc();this[TP.OWNER].set('$traitsInstResolutions',c);}if(TP.notValid(a=c.at(d))){a=TP.hc('sources',TP.ac(b));c.atPut(d,a);}else{if(!a.at('sources').contains(b,TP.IDENTITY)){a.at('sources').push(b);}}if(TP.isType(b)&&TP.isValid(e)){a.atPut('resolvesTo',TP.ac(b,e));}else{a.atPut('resolvesTo',b);}return this;});TP.lang.RootObject.Inst.defineMethod('resolveTraits',function(a,b){if(!TP.isPrototype(this)){return this;}if(TP.isTrue(this.get('$traitsResolved'))){return this;}if(!TP.isArray(a)){return this.raise('TP.sig.InvalidParameter',arguments,'Not a valid Array of property names for trait resolution.');}a.perform(function(a){this.resolveTrait(a,b);}.bind(this));return this;});TP.lang.RootObject.Type.defineMethod('resolveTrait',function(d,b,e){var c,a;if(!TP.isPrototype(this)){return this;}if(TP.isTrue(this.get('$traitsResolved'))){return this;}if(TP.notValid(c=this[TP.OWNER].get('$traitsTypeResolutions'))){c=TP.hc();this[TP.OWNER].set('$traitsTypeResolutions',c);}if(TP.notValid(a=c.at(d))){a=TP.hc('sources',TP.ac(b));c.atPut(d,a);}else{if(!a.at('sources').contains(b,TP.IDENTITY)){a.at('sources').push(b);}}if(TP.isValid(e)){a.atPut('resolvesTo',TP.name(b)+'::'+e);}else{a.atPut('resolvesTo',b);}return this;});TP.lang.RootObject.Type.defineMethod('resolveTraits',function(a,b){if(!TP.isPrototype(this)){return this;}if(TP.isTrue(this.get('$traitsResolved'))){return this;}if(!TP.isArray(a)){return this.raise('TP.sig.InvalidParameter',arguments,'Not a valid Array of property names for trait resolution.');}a.perform(function(a){this.resolveTrait(a,b);}.bind(this));return this;});TP.defineMetaInstMethod('removeInstProperties',function(a){return this.raise('TP.sig.InvalidType',arguments,this);});TP.defineMetaInstMethod('removeLocalProperties',function(c){var a,d,b;d=c.getSize();for(a=0;a<d;a++){b=c.at(a);if(TP.owns(this,b)){delete this[b];}}return this;});TP.defineMetaInstMethod('removeTypeProperties',function(a){return this.raise('TP.sig.InvalidType',arguments,this);});TP.defineMetaTypeMethod('removeInstProperties',function(d){var a,e,b,c;e=d.getSize();b=this.getInstPrototype();for(a=0;a<e;a++){c=d.at(a);if(TP.owns(b,c)){delete b[c];}}return this;});TP.lang.RootObject.Type.defineMethod('removeInstProperties',function(d){var a,e,b,c;e=d.getSize();b=this.getInstPrototype();for(a=0;a<e;a++){c=d.at(a);if(TP.owns(b,c)){delete b[c];}}return this;});TP.defineMetaTypeMethod('removeTypeProperties',function(c){var a,d,b;d=c.getSize();for(a=0;a<d;a++){b=c.at(a);if(TP.owns(this,b)){delete this[b];}}return this;});TP.lang.RootObject.Type.defineMethod('removeTypeProperties',function(c){var a,d,b;d=c.getSize();for(a=0;a<d;a++){b=c.at(a);if(TP.owns(this,b)){delete this[b];}}return this;});TP.defineMetaInstMethod('isa',function(a){if(TP.notValid(a)){this.raise('TP.sig.InvalidType',arguments);return false;}if(TP.isKindOf(this,a)){return true;}return this.callBestMethod(arguments,this,'isa');});TP.defineMetaInstMethod('isaObject',function(b){var a;if(TP.isType(a=TP.sys.require(b))){if(TP.canInvoke(a,'validate')){return a.validate(this);}}return true;});TP.defineMetaTypeMethod('validate',function(a){if(!TP.isType(this)){return this(a);}return this.callBestMethod(arguments,this,'validate');});TP.defineMetaTypeMethod('validateObject',function(a){if(!TP.isType(this)){return this(a);}if(TP.notValid(a)){return false;}return TP.isKindOf(a,this.getName());});TP.lang.RootObject.Type.defineMethod('validate',function(a){return this.callBestMethod(arguments,this,'validate');});TP.lang.RootObject.Type.defineMethod('validateObject',function(a){if(TP.notValid(a)){return false;}return TP.isKindOf(a,this.getName());});TP.definePrimitive('$$marker',function(f,c,d){var a,b,e;a=TP.isString(c)?c+': ':'';b=f||'';if(TP.sys.shouldLogStack()){try{throw new Error();}catch(a){e=TP.getStackInfo(a);}TP.ifWarn()?TP.warn(a+b+'\n\n'+e.join('\n'),TP.LOG,arguments):0;}else{TP.ifWarn()?TP.warn(a+b,TP.LOG,arguments):0;}if(TP.notEmpty(d)){TP.raise(this,d);}return;});TP.definePrimitive('deprecated',function(a){return TP.$$marker(a,'Deprecated');});TP.definePrimitive('override',function(a){return TP.$$marker(a,'MissingOverride','MissingOverride');});TP.definePrimitive('todo',function(a){return TP.$$marker(a,'TODO');});Array[TP.NAME]='Array';Array[TP.OWNER]=Array;Array[TP.TRACK]=TP.GLOBAL_TRACK;Boolean[TP.NAME]='Boolean';Boolean[TP.OWNER]=Boolean;Boolean[TP.TRACK]=TP.GLOBAL_TRACK;Date[TP.NAME]='Date';Date[TP.OWNER]=Date;Date[TP.TRACK]=TP.GLOBAL_TRACK;Function[TP.NAME]='Function';Function[TP.OWNER]=Function;Function[TP.TRACK]=TP.GLOBAL_TRACK;Number[TP.NAME]='Number';Number[TP.OWNER]=Number;Number[TP.TRACK]=TP.GLOBAL_TRACK;Object[TP.NAME]='Object';Object[TP.OWNER]=Object;Object[TP.TRACK]=TP.GLOBAL_TRACK;RegExp[TP.NAME]='RegExp';RegExp[TP.OWNER]=RegExp;RegExp[TP.TRACK]=TP.GLOBAL_TRACK;String[TP.NAME]='String';String[TP.OWNER]=String;String[TP.TRACK]=TP.GLOBAL_TRACK;Array.Inst.defineAttribute('delimiter',', ');Array.Inst.defineMethod('asArray',function(){return this;});Array.Inst.defineMethod('asBoolean',function(){return this.getSize()>0;});Array.Inst.defineMethod('asNumber',function(){if(this.getSize()===1&&TP.isValid(this.at(0))){return this.at(0).asNumber();}return NaN;});Array.Inst.defineMethod('asString',function(e){var c,a,d,b;c=TP.ifInvalid(e,true);if(!c){return TP.objectToString(this);}this.$sortIfNeeded();if(this.$$format_asString){return TP.recursion(this);}this.$$format_asString=true;a=this.$get('delimiter');if(!TP.isString(a)){if(!TP.isString(a=a.get('join'))){a='';}}try{d=this.collect(function(a,b){return TP.str(a,false);});b=d.join(a);}catch(a){b=this.toString();}delete this.$$format_asString;return b;});Array.Type.defineMethod('fromNodeList',function(b){var a,c;c=this.construct();if(TP.isNodeList(b)){for(a=0;a<b.length;a++){c.push(b[a]);}}return c;});Array.Type.defineMethod('fromString',function(a){return a.split('');});Array.Inst.defineMethod('setDelimiter',function(b){var a;a=TP.ifInvalid(b,', ');if(this.$get('delimiter')!==a){this.$set('delimiter',a);}return this;});Boolean.Inst.defineMethod('asArray',function(){var a;a=TP.ac().add(this);return a;});Boolean.Inst.defineMethod('asBoolean',function(){return this;});Boolean.Inst.defineMethod('asHash',function(){return TP.hc('value',this);});Boolean.Inst.defineMethod('asNumber',function(){return this?1:0;});Boolean.Inst.defineMethod('format',function(a){switch(a){case'y':case'n':return this?'y':'n';case'Y':case'N':return this?'Y':'N';case'yy':case'nn':return this?'yes':'no';case'YY':case'NN':return this?'YES':'NO';case'Yy':case'Nn':return this?'Yes':'No';case't':case'f':return this?'t':'f';case'T':case'F':return this?'T':'F';case'tt':case'ff':return this?'true':'false';case'TT':case'FF':return this?'TRUE':'FALSE';case'Ty':case'Ff':return this?'True':'False';case'0':case'1':return this?'1':'0';default:return this?'true':'false';}});Boolean.Type.defineMethod('fromString',function(a,b){if(!TP.sys.hasKernel()){return new Boolean(a);}return this.parse(a,b);});Date.Inst.defineMethod('asArray',function(){var a;a=TP.ac().add(this);return a;});Date.Inst.defineMethod('asBoolean',function(){return this.toString()!==TP.DateProto.toString();});Date.Inst.defineMethod('asDate',function(){return this;});Date.Inst.defineMethod('asHash',function(){return TP.hc('value',this);});Date.Inst.defineMethod('asNumber',function(){return this.getTime();});Date.Inst.defineMethod('asString',function(b){var a;a=TP.ifInvalid(b,true);if(!a){return TP.objectToString(this);}if(TP.sys.hasKernel()){return TP.sys.getLocale().localizeDate(this);}return this.toUTCString();});Function.Inst.defineMethod('asFunction',function(){return this;});Function.Inst.defineMethod('asHash',function(){return TP.hc('value',this);});Function.Inst.defineMethod('asNumber',function(){return 0;});Function.Inst.defineMethod('asString',function(b){var a;a=TP.ifInvalid(b,true);if(!a){return TP.gid(this);}return TP.objectToString(this);});Number.Inst.defineMethod('asArray',function(){var a;a=TP.ac().add(this);return a;});Number.Inst.defineMethod('asDate',function(){return TP.dc(this);});Number.Inst.defineMethod('asHash',function(){return TP.hc('value',this);});Number.Inst.defineMethod('asNumber',function(){return this;});Number.Type.defineMethod('fromString',function(a,b){if(!TP.sys.hasKernel()){return new Number(a);}return this.parse(a,b);});TP.defineCommonMethod('asArray',function(){var a;if(TP.isArgArray(this)){return TP.ac(this);}a=TP.ac().add(this);return a;});TP.defineCommonMethod('asBoolean',function(){return Boolean.fromString(this.asString());});TP.defineCommonMethod('asDate',function(){var a;a=TP.dc(this.asString());return TP.dc(this.asString());});TP.defineCommonMethod('asFunction',function(){return TP.fc(this.asString());});TP.defineCommonMethod('asNumber',function(){return TP.nc(this.asString());});TP.defineCommonMethod('asRegExp',function(){return TP.rc(this.asString());});RegExp.Inst.defineMethod('asArray',function(){var a;a=TP.ac().add(this);return a;});RegExp.Inst.defineMethod('asHash',function(){return TP.hc('value',this);});RegExp.Inst.defineMethod('asRegExp',function(){return this;});RegExp.Inst.defineMethod('asString',function(a){return this.toString();});String.Inst.defineMethod('asArray',function(b){var a;a=TP.ifInvalid(b,TP.isString(this.$get('delimiter'))?this.$get('delimiter'):'');return this.split(a);});String.Inst.defineMethod('asNumber',function(){var a;if(TP.regex.PERCENTAGE.test(this)){if(TP.isNumber(a=parseFloat(this))){return a/100;}}return parseFloat(this);});String.Inst.defineMethod('defineSubtype',function(b){var a;a=this.asType();if(TP.isType(a)){return a.defineSubtype(b);}return this.raise('TP.sig.InvalidType',arguments,this);});String.Inst.defineMethod('canResolveDNU',function(c,b,d,e){var a;a=this.asType();if(TP.isType(a)){if(TP.canInvoke(a,b)){return true;}return a.canResolveDNU(c,b,d,e);}return false;});String.Inst.defineMethod('construct',function(){var a;a=this.asType();if(TP.isType(a)){return a.construct.apply(a,arguments);}else{return this.raise('TP.sig.InvalidType',arguments,this);}});String.Inst.defineMethod('initialize',function(){var a;if(this===TP.StringProto){return;}a=this.asType();if(TP.isType(a)){return a;}else{return this.raise('TP.sig.InvalidType',arguments,this);}return;});String.Inst.defineMethod('resolveDNU',function(d,c,b,e){var a;a=this.asType();if(TP.isType(a)){switch(b.length){case 0:return a[c]();case 1:return a[c](b[0]);case 2:return a[c](b[0],b[1]);default:return a[c].apply(a,b);}}return this.raise('TP.sig.InvalidType',arguments,this);});TP.lang.RootObject.Type.defineMethod('defineInstGetter',function(b,c){var a=this[TP.INSTC].prototype;Object.defineProperty(a,b,{get:c});return this;});TP.lang.RootObject.Type.defineMethod('defineInstSetter',function(b,c){var a=this[TP.INSTC].prototype;Object.defineProperty(a,b,{set:c});return this;});TP.lang.RootObject.Type.defineMethod('defineTypeGetter',function(b,c){var a=this[TP.TYPEC].prototype;Object.defineProperty(a,b,{get:c});return this;});TP.lang.RootObject.Type.defineMethod('defineTypeSetter',function(b,c){var a=this[TP.TYPEC].prototype;Object.defineProperty(a,b,{set:c});return this;});TP.lang.RootObject.Type.defineMethod('getDescriptorFor',function(b){var a;a=TP.sys.$$meta_attributes.at(this.getName()+'_Type'+b);if(TP.isValid(a)){return a.descriptorObj;}return null;});TP.lang.RootObject.Inst.defineMethod('getDescriptorFor',function(b){var a;a=TP.sys.$$meta_attributes.at(this.getTypeName()+'_Inst_'+b);if(TP.isValid(a)){return a.descriptorObj;}return null;});TP.lang.RootObject.Type.defineAttribute('$$useSingleton',false);TP.lang.RootObject.Type.defineAttribute('$$singleton',null);TP.lang.RootObject.Type.defineMethod('$alloc',function(){var a;if(this.shouldUseSingleton()&&TP.isValid(a=this.$get('$$singleton'))){if(a.isRecyclable()){a.recycle();}return a;}return new this[TP.INSTC]();});TP.lang.RootObject.Type.defineMethod('shouldUseSingleton',function(a){if(TP.isBoolean(a)){this.$set('$$useSingleton',a);}return this.$get('$$useSingleton');});TP.lang.RootObject.Type.defineMethod('construct',function(){var a,b;if(this.isAbstract()){return this.constructViaSubtype.apply(this,arguments);}if(!this.get('$traitsResolved')){this.executeTraitResolution();if(!this.get('$traitsResolved')){return undefined;}}if(TP.canInvoke(this,'initializeLazily')){this.initializeLazily();}a=this.$alloc();a[TP.TYPE]=this[TP.TYPE];a=a.$init.apply(a,arguments);b=a.init.apply(a,arguments);if(TP.isValid(b)){return b;}});TP.lang.RootObject.Inst.defineMethod('init',function(){return this;});TP.lang.RootObject.Inst.defineMethod('isRecyclable',function(a){if(TP.isBoolean(a)){this.$set('recyclable',a);}return TP.isTrue(this.$get('recyclable'));});TP.lang.RootObject.Inst.defineMethod('recycle',function(){return this;});TP.lang.RootObject.Type.defineMethod('callNextMethod',function(){var a,f,e,c,g,d,b;if(this===TP.ObjectProto){return;}a=TP.$$currentCallee$$;if(arguments.length>0){f=arguments;}else{f=TP.$$currentArgs$$;}if(TP.notValid(a)){return this.raise('TP.sig.InvalidContext',arguments);}if(a.hasOwnProperty('$$superfunc')){b=a.$$superfunc;if(b===TP.NONE){return;}}if(TP.notValid(b)){e=a.getName();c=a[TP.OWNER];if(TP.notValid(c)||c===self){return;}g=a[TP.TRACK];switch(g){case TP.INST_TRACK:d=c[TP.SUPER];if(TP.notValid(d)){a.$$superfunc=TP.NONE;return;}if(!TP.isCallable(b=d[TP.INSTC].prototype[e])){a.$$superfunc=TP.NONE;return;}break;case TP.TYPE_TRACK:d=c.$$supertype;if(TP.notValid(d)){a.$$superfunc=TP.NONE;return;}if(!TP.isCallable(b=d[TP.TYPEC].prototype[e])){a.$$superfunc=TP.NONE;return;}break;case TP.TYPE_LOCAL_TRACK:if(!TP.isCallable(b=c[TP.TYPEC].prototype[e])){a.$$superfunc=TP.NONE;return;}break;case TP.LOCAL_TRACK:if(!TP.isCallable(b=c.getType()[TP.INSTC].prototype[e])){a.$$superfunc=TP.NONE;return;}break;case TP.GLOBAL_TRACK:case TP.PRIMITIVE_TRACK:a.$$superfunc=TP.NONE;return;default:return;}if(a===b){a.$$superfunc=TP.NONE;return;}a.$$superfunc=b;}return b.apply(this,f);});TP.lang.RootObject.Inst.defineMethod('callNextMethod',TP.lang.RootObject[TP.TYPEC].prototype.callNextMethod);TP.defineMetaInstMethod('callNextMethod',function(){var a,c,d,b;if(this===TP.ObjectProto){return;}a=TP.$$currentCallee$$;if(arguments.length>0){c=arguments;}else{c=TP.$$currentArgs$$;}if(TP.notValid(a)){return this.raise('TP.sig.InvalidContext',arguments);}if(a.hasOwnProperty('$$superfunc')){b=a.$$superfunc;if(b===TP.NONE){return;}}if(TP.notValid(b)){d=a.getName();if(TP.isType(this)){if(!TP.isCallable(b=Object[d])){a.$$superfunc=TP.NONE;return;}}else{if(!TP.isCallable(b=TP.ObjectProto[d])){a.$$superfunc=TP.NONE;return;}}if(a===b){a.$$superfunc=TP.NONE;return;}a.$$superfunc=b;}return b.apply(this,c);});TP.defineMetaInstMethod('callBestMethod',function(b,e,f,g,h,c){var a,d;a=this.getBestMethodName(b,e,f,g,h,c);if(TP.isEmpty(a)){return;}d=TP.args(c||b);return this[a].apply(this,d);});TP.defineMetaInstMethod('getBestMethod',function(b,c,d,e,f,g){var a;a=this.getBestMethodName(b,c,d,e,f,g);if(TP.notEmpty(a)){return this[a];}return;});TP.defineMetaInstMethod('getBestMethodName',function(j,c,n,m,e,k){var b,a,d,g,l,i,f,h;if(this===TP.ObjectProto){return;}b=n;d=m||'';l=TP.args(k||j);if(TP.isNull(c)){a=b+'Null'+d;if(TP.canInvoke(this,a)){return a;}else if(TP.canInvoke(this,e)){return e;}else{return;}}else if(TP.notDefined(c)){a=b+'Undefined'+d;if(TP.canInvoke(this,a)){return a;}else if(TP.canInvoke(this,e)){return e;}else{return;}}else{if(TP.isType(c)){a=b+TP.escapeTypeName(TP.tname(c))+TP.TYPE_TRACK+d;}else{a=b+TP.escapeTypeName(TP.tname(c))+d;}if(TP.canInvoke(this,a)){return a;}if(TP.notValid(c)){a=TP.str(c).toUpperCase();}else if(TP.isEvent(c)){a=b+'Event'+d;}else if(TP.isError(c)){a=b+'Error'+d;}else if(TP.isNode(c)){switch(c.nodeType){case Node.DOCUMENT_NODE:a=b+'Document'+d;break;case Node.ELEMENT_NODE:a=b+'Element'+d;break;case Node.ATTRIBUTE_NODE:a=b+'Attribute'+d;break;default:a=b+'Node'+d;break;}if(TP.canInvoke(this,a)){return a;}a=b+'Node'+d;}else if(TP.isNodeList(c)){a=b+'NodeList'+d;}else if(TP.isNamedNodeMap(c)){a=b+'NamedNodeMap'+d;}else if(TP.isWindow(c)){a=b+'Window'+d;}else if(TP.isNativeType(TP.type(c))){a=b+'Object'+d;}else if(TP.isType(c)){a=b+'NativeType'+d;}else if(TP.isStyleDeclaration(c)){a=b+'CSSStyleDeclaration'+d;}else if(TP.isStyleRule(c)){a=b+'CSSStyleRule'+d;}else if(TP.isStyleSheet(c)){a=b+'CSSStyleSheet'+d;}else if(TP.isXHR(c)){a=b+'XHR'+d;}else if(TP.canInvoke(c,'getSupertypeNames')){g=c.getSupertypeNames();i=g.getSize();for(f=0;f<i;f++){h=TP.escapeTypeName(g.at(f));a=b+h+d;if(TP.canInvoke(this,a)){return a;}}}}if(!TP.canInvoke(this,a)){if(TP.isString(e)&&e!==a&&TP.canInvoke(this,e)){return e;}}else{return a;}return;});TP.lang.RootObject.Type.defineMethod('getConstructor',function(){if(this===TP.lang.RootObject$$Type.prototype){return Function;}return TP.lang.RootObject$$Type;});TP.lang.RootObject.Type.defineMethod('getName',function(){var a;if(TP.owns(this,'name')){return this.name;}if(TP.notValid(a=this[TP.NAME])){return this.getID();}return a;});TP.lang.RootObject.Type.defineMethod('getSupertype',function(){return this[TP.SUPER];});TP.lang.RootObject.Type.defineMethod('getSupertypeName',function(){return this[TP.SUPER].getName();});TP.lang.RootObject.Type.defineMethod('getSupertypeNames',function(){return this[TP.ANCESTOR_NAMES]||TP.ac();});TP.lang.RootObject.Type.defineMethod('getType',function(){return this[TP.TYPEC];});TP.lang.RootObject.Type.defineMethod('getTypeName',function(){return this.getNamespaceRoot()+'.meta.'+this.getNamespacePrefix()+'.'+this.getLocalName();});TP.lang.RootObject.Type.defineMethod('getTypes',function(){var a;a=this.getSupertypes().copy();a.unshift(this);return a;});TP.lang.RootObject.Type.defineMethod('$$isReferenceType',function(){return true;});TP.lang.RootObject.Type.defineMethod('isInitialized',function(a){if(TP.isBoolean(a)){this.$set('$$initialized',a);}return TP.ifInvalid(this.$get('$$initialized'),false);});TP.lang.RootObject.Type.defineMethod('ownsMethod',function(a){try{if(TP.sys.hasInitialized()&&TP.isMethod(this[a])){return this[a][TP.OWNER]===this;}}catch(a){}return false;});TP.lang.RootObject.Inst.defineMethod('getConstructor',function(){if(this===TP.lang.RootObject$$Inst){return Function;}return TP.lang.RootObject$$Inst;});TP.lang.RootObject.Inst.defineMethod('getLocalName',function(){return this.getType().getLocalName();});TP.lang.RootObject.Inst.defineMethod('getNamespacePrefix',function(){return this.getType().getNamespacePrefix();});TP.lang.RootObject.Inst.defineMethod('getType',function(){return this[TP.TYPE];});TP.lang.RootObject.Inst.defineMethod('getTypeName',function(){var a;if(this===TP.lang.RootObject$$Inst.prototype){return this.getID();}a=this.getType();if(TP.canInvoke(a,'getName')){return a.getName();}return a;});TP.sys.defineMethod('getTypeInitializers',function(){var a;a=TP.sys.getMethodOwners('initialize',true);if(TP.isValid(a)){return a.collect(function(a,b){return function(){var b;b=TP.sys.getTypeByName(a,false);if(TP.notValid(b)||!TP.canInvoke(b,'isInitialized')){return;}try{if(b.isInitialized()){TP.boot.$stdout('Skipping initialized type: '+a,TP.TRACE);return;}TP.boot.$stdout('Initializing type: '+a,TP.TRACE);b.initialize();b.isInitialized(true);}catch(b){TP.boot.$stderr('Initialization error for type: '+a,b);}};});}return TP.ac();});TP.sys.addMetadata(Object,TP.lang.RootObject,TP.SUBTYPE);TP.lang.RootObject.Type.defineMethod('getInstPrototype',function(){if(TP.isValid(this[TP.INSTC])){return this[TP.INSTC].prototype;}return Object.getPrototypeOf(this);});TP.lang.RootObject.Inst.defineMethod('getPrototype',function(){return this.getType().getInstPrototype();});TP.defineMetaInstMethod('getPrototypes',function(){var c,a,b;b=TP.ac();if(this===TP.ObjectProto){return b;}a=this;c=null;while(a!==TP.ObjectProto&&a!==a.constructor.prototype){c=a;a=a.getPrototype();b.add(a);}return b;});TP.definePrimitive('method',function(c,d,b){var a;a=c[d];if(TP.isMethod(a)){if(TP.notEmpty(b)&&a[TP.TRACK]===b){return a;}}return;});TP.definePrimitive('methods',function(a,b){var c,d;c=a.getInterface('methods');d=c.collect(function(d){var c;c=a[d];if(TP.isMethod(c)){if(TP.notEmpty(b)&&c[TP.TRACK]===b){return c;}}return;});return d.compact();});TP.defineMetaInstMethod('getMethod',function(b,c){var a;if(TP.isEmpty(a=c)){if(TP.isPrototype(this)){a=TP.INST_TRACK;}else{a=TP.LOCAL_TRACK;}}return TP.method(this,b,a);});TP.defineMetaInstMethod('getMethods',function(b){var a;if(TP.isEmpty(a=b)){if(TP.isPrototype(this)){a=TP.INST_TRACK;}else{a=TP.LOCAL_TRACK;}}return TP.methods(this,a);});TP.FunctionProto.defineMethod('getMethod',function(d,c){var a,b;if(this===TP.FunctionProto){a=Function;b=TP.ifEmpty(c,TP.INST_TRACK);}else if(TP.isType(this)){a=this;b=TP.ifEmpty(c,TP.TYPE_LOCAL_TRACK);}else{a=this;b=TP.ifEmpty(c,TP.LOCAL_TRACK);}return TP.method(a,d,b);});TP.FunctionProto.defineMethod('getMethods',function(c){var a,b;if(this===TP.FunctionProto){a=Function;b=TP.ifEmpty(c,TP.INST_TRACK);}else if(TP.isType(this)){a=this;b=TP.ifEmpty(c,TP.TYPE_LOCAL_TRACK);}else{a=this;b=TP.ifEmpty(c,TP.LOCAL_TRACK);}return TP.methods(a,b);});TP.lang.RootObject.Type.defineMethod('getMethod',function(d,c){var a,b;if(TP.isPrototype(this)){a=this[TP.OWNER];b=TP.ifEmpty(c,TP.TYPE_TRACK);}else{a=this;b=TP.ifEmpty(c,TP.TYPE_LOCAL_TRACK);}return TP.method(a,d,b);});TP.lang.RootObject.Type.defineMethod('getMethods',function(c){var a,b;if(TP.isPrototype(this)){a=this[TP.OWNER];b=TP.ifEmpty(c,TP.TYPE_TRACK);}else{a=this;b=TP.ifEmpty(c,TP.TYPE_LOCAL_TRACK);}return TP.methods(a,b);});TP.lang.RootObject.Inst.defineMethod('getMethod',function(d,c){var a,b;if(TP.isPrototype(this)){a=this[TP.OWNER];b=TP.ifEmpty(c,TP.INST_TRACK);}else{a=this;b=TP.ifEmpty(c,TP.LOCAL_TRACK);}return TP.method(a,d,b);});TP.lang.RootObject.Inst.defineMethod('getMethods',function(c){var a,b;if(TP.isPrototype(this)){a=this[TP.OWNER];b=TP.ifEmpty(c,TP.INST_TRACK);}else{a=this;b=TP.ifEmpty(c,TP.LOCAL_TRACK);}return TP.methods(a,b);});TP.defineMetaInstMethod('getMethodInfoFor',function(f){var a,b,c,d,e;a=this;b=TP.LOCAL_TRACK;if(!TP.isMethod(c=a.getMethod(f,b))){return null;}d=c[TP.NAME];e=c[TP.DISPLAY];return TP.hc('owner',a,'name',d,'track',b,'display',e);});TP.FunctionProto.defineMethod('getMethodInfoFor',function(f){var a,b,c,d,e;if(this===TP.FunctionProto){a=Function;b=TP.INST_TRACK;}else if(TP.isType(this)){a=this;b=TP.TYPE_LOCAL_TRACK;}else{a=this;b=TP.LOCAL_TRACK;}if(!TP.isMethod(c=a.getMethod(f,b))){return null;}d=c[TP.NAME];e=c[TP.DISPLAY];return TP.hc('owner',a,'name',d,'track',b,'display',e);});TP.lang.RootObject.Type.defineMethod('getMethodInfoFor',function(f){var a,b,c,d,e;if(TP.isPrototype(this)){a=this[TP.OWNER];b=TP.TYPE_TRACK;}else{a=this;b=TP.TYPE_LOCAL_TRACK;}if(!TP.isMethod(c=a.getMethod(f,b))){return null;}d=c[TP.NAME];e=c[TP.DISPLAY];return TP.hc('owner',a,'name',d,'track',b,'display',e);});TP.lang.RootObject.Inst.defineMethod('getMethodInfoFor',function(f){var a,b,c,d,e;if(TP.isPrototype(this)){a=this[TP.OWNER];b=TP.INST_TRACK;}else{a=this;b=TP.LOCAL_TRACK;}if(!TP.isMethod(c=a.getMethod(f,b))){return null;}d=c[TP.NAME];e=c[TP.DISPLAY];return TP.hc('owner',a,'name',d,'track',b,'display',e);});TP.definePrimitive('isGlobalMethod',function(a){return TP.isValid(a[TP.OWNER])&&a[TP.TRACK]===TP.GLOBAL_TRACK;});TP.definePrimitive('isInstMethod',function(a){return TP.isValid(a[TP.OWNER])&&a[TP.TRACK]===TP.INST_TRACK;});TP.definePrimitive('isLocalMethod',function(b){var c,a;c=b[TP.OWNER];a=b[TP.TRACK];return TP.isValid(c)&&a===TP.TYPE_LOCAL_TRACK||a===TP.LOCAL_TRACK;});TP.definePrimitive('isTypeMethod',function(a){return TP.isValid(a[TP.OWNER])&&a[TP.TRACK]===TP.TYPE_TRACK;});TP.lang.RootObject.defineSubtype('Object');TP.lang.Object.Type.defineMethod('fromObject',function(d){var a,e,f,b,c;a=this.construct.apply(this,arguments);if(TP.isMemberOf(d,Object)){e=TP.keys(d);f=e.getSize();for(b=0;b<f;b++){c=e.at(b);a.defineAttribute(c);a.set(c,d[c]);}}return a;});TP.lang.Object.Type.defineMethod('getConstructor',function(){return this.getSupertype()[TP.TYPEC];});TP.lang.Object.Inst.defineMethod('asSource',function(){var a;if(this.$$format_asSource){return TP.recursion(this);}this.$$format_asSource=true;a=TP.tname(this)+'.construct()'+this.$generateSourceSets(this.getUniqueValueKeys());delete this.$$format_asSource;return a;});TP.lang.Object.Inst.defineMethod('$generateSourceSets',function(g,h){var e,b,f,a,c,d;e=TP.ifInvalid(h,false);b=TP.ifInvalid(g,TP.keys(this));f=b.getSize();d=TP.ac();for(a=0;a<f;a++){c=this.get(b.at(a));if(!TP.isValid(c)&&!e){continue;}d.push(TP.join('.set(\'',b.at(a),'\', ',TP.src(c),')'));}return d.join('');});TP.lang.Object.Inst.defineMethod('getConstructor',function(){return this.getType()[TP.INSTC];});TP.lang.Object.Inst.defineMethod('getKeys',function(){var a;a=this.getInstInterface('known_attributes').concat(this.getLocalInterface('known_local_attributes'));a.unique();return a;});TP.lang.Object.Inst.defineMethod('getUniqueValueKeys',function(){var a;a=this.getLocalInterface('known_overridden_attributes').concat(this.getLocalInterface('known_local_attributes'));return a;});TP.FunctionProto.defineMethod('replaceWith',function(b){var a,c;if(TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.isType(this)){return this.raise('TP.sig.InvalidOperation',arguments,'Cannot replace types');}a=this[TP.OWNER];c=this[TP.TRACK];if(TP.isValid(a)&&TP.isValid(c)){try{a.defineMethod(this.getName(),b);}catch(b){return this.raise('TP.sig.InvalidFunction',arguments,TP.ec(b,TP.id(a)+'.defineMethod(func); failed.'));}}return this;});Window.Inst.defineMethod('getType',function(){return Window;});Window.Inst.defineMethod('getTypeName',function(){return'DOMWindow';});TP.defineNamespace('api','TP');
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETNotification.js';
TP.lang.Object.defineSubtype('sig:Signal');TP.sig.Signal.Type.defineAttribute('phases',TP.ac(TP.AT_TARGET,TP.CAPTURING_PHASE,TP.BUBBLING_PHASE));TP.sig.Signal.Type.defineAttribute('bubbling',false);TP.sig.Signal.Type.defineAttribute('cancelable',true);TP.sig.Signal.Type.defineAttribute('defaultPolicy',TP.DEFAULT_FIRING);TP.sig.Signal.Type.defineAttribute('signalRoot',null);TP.sig.Signal.Type.defineMethod('getDefaultPolicy',function(){return this.$get('defaultPolicy');});TP.sig.Signal.Type.defineMethod('getHandlerName',function(e,f,d){var b,a,c;b=TP.ifInvalid(e,'');if(TP.isKindOf(d,TP.sig.Signal)){a=d.getSignalName();}else{a=this.getSignalName();}if(/^TP\.sig\./.test(a)){if(TP.notTrue(f)){c='handle'+b+a.slice(7).asTitleCase();}else{c='handle'+b+TP.escapeTypeName(a);}}else{c='handle'+b+TP.escapeTypeName(a).asTitleCase();}return c;});TP.sig.Signal.Type.defineMethod('getPhases',function(){return this.phases;});TP.sig.Signal.Type.defineMethod('getSignalName',function(){return this.getName();});TP.sig.Signal.Type.defineMethod('getSignalOwner',function(){return null;});TP.sig.Signal.Type.defineMethod('isBubbling',function(){return this.$get('bubbling');});TP.sig.Signal.Type.defineMethod('isCancelable',function(){return this.$get('cancelable');});TP.sig.Signal.Type.defineMethod('isSignalingRoot',function(a){if(TP.isDefined(a)){this.$set('signalRoot',a);}return TP.isTrue(this.$get('signalRoot'));});TP.sig.Signal.isSignalingRoot(true);TP.sig.Signal.Inst.defineAttribute('origin');TP.sig.Signal.Inst.defineAttribute('context');TP.sig.Signal.Inst.defineAttribute('listener');TP.sig.Signal.Inst.defineAttribute('ignoreList');TP.sig.Signal.Inst.defineAttribute('phase');TP.sig.Signal.Inst.defineAttribute('payload');TP.sig.Signal.Inst.defineAttribute('recyclable',false);TP.sig.Signal.Inst.defineAttribute('signalName');TP.sig.Signal.Inst.defineAttribute('$shouldPrevent',false);TP.sig.Signal.Inst.defineAttribute('$shouldStop',false);TP.sig.Signal.Inst.defineAttribute('target');TP.sig.Signal.Inst.defineAttribute('time');TP.sig.Signal.Inst.defineAttribute('elapsed');TP.sig.Signal.Inst.defineMethod('init',function(a){this.callNextMethod();this.setPayload(a);this.recyclable=false;return this;});TP.sig.Signal.Inst.defineMethod('addIfAbsent',function(b,d){var a,c;if(TP.isString(b)){a=b;c=d;}else if(TP.isPair(b)){a=b.first();c=b.last();}else{return this.raise('TP.sig.InvalidParameter',arguments,'Invalid key or item.');}if(TP.isDefined(this.at(a))){return this.at(a);}this.atPut(a,c);return this.at(a);});TP.sig.Signal.Inst.defineMethod('asDumpString',function(){var a;if(this.$$format_asDumpString){return TP.recursion(this);}this.$$format_asDumpString=true;try{a=this.getSignalName()+' :: '+'('+TP.dump(this.getPayload())+')';}catch(b){a=this.toString();}delete this.$$format_asDumpString;return a;});TP.sig.Signal.Inst.defineMethod('asHTMLString',function(){var a;if(this.$$format_asHTMLString){return TP.recursion(this);}this.$$format_asHTMLString=true;try{a='<span class="TP_sig_Signal '+TP.escapeTypeName(TP.tname(this))+'">'+'<span data-name="payload">'+TP.htmlstr(this.getPayload())+'</span>'+'</span>';}catch(b){a=this.toString();}delete this.$$format_asHTMLString;return a;});TP.sig.Signal.Inst.defineMethod('asJSONSource',function(){var a;if(this.$$format_asJSONSource){return TP.recursion(this);}this.$$format_asJSONSource=true;try{a='{"type":'+this.getTypeName().quoted('"')+','+'"data":{"signame":'+this.getSignalName().quoted('"')+','+'"payload":'+TP.json(this.getPayload())+'}}';}catch(b){a=this.toString();}delete this.$$format_asJSONSource;return a;});TP.sig.Signal.Inst.defineMethod('asPrettyString',function(){var a;if(this.$$format_asPrettyString){return TP.recursion(this);}this.$$format_asPrettyString=true;try{a='<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+TP.pretty(this.getPayload())+'</dl>';}catch(b){a=this.toString();}delete this.$$format_asPrettyString;return a;});TP.sig.Signal.Inst.defineMethod('asString',function(c){var b,a;b=TP.ifInvalid(c,true);if(!b){return this.getSignalName()+TP.OID_PREFIX+this.toString().split(TP.OID_PREFIX).last();}if(this.$$format_asString){return TP.recursion(this);}this.$$format_asString=true;try{a=this.getSignalName()+' :: '+'('+TP.str(this.getPayload(),true)+')';}catch(b){a=this.toString();}delete this.$$format_asString;return a;});TP.sig.Signal.Inst.defineMethod('asSource',function(){var c,a,b;if(this.$$format_asSource){return TP.recursion(this);}this.$$format_asSource=true;try{if(TP.isDefined(c=this.getPayload())){a=this.getTypeName()+'.construct('+TP.src(c)+')';}else{a=this.getTypeName()+'.construct()';}b=this.getUniqueValueKeys();b.remove('payload');a+=this.$generateSourceSets(b);}catch(b){a=this.toString();}delete this.$$format_asSource;return a;});TP.sig.Signal.Inst.defineMethod('asXMLString',function(){var a;if(this.$$format_asXMLString){return TP.recursion(this);}this.$$format_asXMLString=true;try{a='<instance type="'+TP.tname(this)+'">'+'<payload>'+TP.xmlstr(this.getPayload())+'</payload>'+'</instance>';}catch(b){a=this.toString();}delete this.$$format_asXMLString;return a;});TP.sig.Signal.Inst.defineMethod('at',function(b){var a;a=this.getPayload();if(TP.isValid(a)){if(TP.canInvoke(a,'at')){return a.at(b);}else if(TP.canInvoke(a,'get')){return a.get(b);}else{try{return a[b];}catch(a){}}}return;});TP.sig.Signal.Inst.defineMethod('atIfInvalid',function(c,a){var b;if(TP.isValid(b=this.at(c))){return b;}else if(TP.isCallable(a)){return a();}else{return a;}});TP.sig.Signal.Inst.defineMethod('atIfNull',function(c,a){var b;if(TP.notNull(b=this.at(c))){return b;}else if(TP.isCallable(a)){return a();}else{return a;}});TP.sig.Signal.Inst.defineMethod('atIfUndefined',function(c,a){var b;if(TP.isDefined(b=this.at(c))){return b;}else if(TP.isCallable(a)){return a();}else{return a;}});TP.sig.Signal.Inst.defineMethod('atPut',function(b,c){var a;a=this.getPayload();if(TP.notValid(a)){this.set('payload',TP.hc(b,c));return this;}if(TP.canInvoke(a,'atPut')){a.atPut(b,c);return this;}if(TP.canInvoke(a,'set')){a.set(b,c);return this;}try{a[b]=c;return this;}catch(a){}this.raise('TP.sig.InvalidPayload',arguments,'Unable to set payload parameter: '+b);return this;});TP.sig.Signal.Inst.defineMethod('atPutIfAbsent',function(b,a){var c,d;c=this.getPayload();if(TP.notValid(c)){this.set('payload',TP.hc(b,a));return a;}if(TP.canInvoke(c,'atPutIfAbsent')){return c.atPutIfAbsent(b,a);}if(TP.notDefined(d=this.at(b))){this.atPut(b,a);return a;}return d;});TP.sig.Signal.Inst.defineMethod('clearIgnores',function(){var a;if(TP.isValid(a=this.get('ignoreList'))){a.empty();}return this;});TP.sig.Signal.Inst.defineMethod('computeSignalName',function(){return this.getTypeName();});TP.sig.Signal.Inst.defineMethod('copy',function(){var a;a=this.getType().construct();a.origin=this.origin;a.context=this.context;a.listener=this.listener;a.ignoreList=this.ignoreList;a.phase=this.phase;a.payload=this.payload;a.recyclable=this.recyclable;a.signalName=this.signalName;a.$shouldPrevent=this.$shouldPrevent;a.$shouldStop=this.$shouldStop;a.target=this.target;a.time=this.time;return a;});TP.sig.Signal.Inst.defineMethod('fire',function(b,c,d){var a;this.stopPropagation(false);this.preventDefault(false);a=TP.ifInvalid(b,this);this.setOrigin(a);this.$set('time',Date.now());return TP.signal(this.getOrigin(),this,arguments,c,d);});TP.sig.Signal.Inst.defineMethod('getActiveTime',function(){var a;if(TP.isNumber(a=this.$get('time'))){return Date.now()-a;}return NaN;});TP.sig.Signal.Inst.defineMethod('getContext',function(){return this.context;});TP.sig.Signal.Inst.defineMethod('getDocument',function(){return this.getWindow().document;});TP.sig.Signal.Inst.defineMethod('getElapsedTime',function(){return this.$get('elapsed')||NaN;});TP.sig.Signal.Inst.defineMethod('getOrigin',function(){return this.origin;});TP.sig.Signal.Inst.defineMethod('getParameters',function(){var a;a=this.getPayload();if(TP.isValid(a)){if(TP.canInvoke(a,TP.ac('at','atPut'))){return a;}}return TP.hc();});TP.sig.Signal.Inst.defineMethod('getPayload',function(){return this.payload;});TP.sig.Signal.Inst.defineMethod('getPhase',function(){return this.phase;});TP.sig.Signal.Inst.defineMethod('getProperty',function(a){return this.$get(a);});TP.sig.Signal.Inst.defineMethod('getRequestID',function(){return this.origin;});TP.sig.Signal.Inst.defineMethod('getSignalName',function(){var a;if(!TP.isString(a=this.$get('signalName'))){a=this.computeSignalName();this.$set('signalName',a,false);}return a;});TP.sig.Signal.Inst.defineMethod('getSignalNames',function(){var a;a=this.getSupertypeSignalNames();a.unshift(this.getSignalName());return a;});TP.sig.Signal.Inst.defineMethod('getSupertypeSignalNames',function(){var b,a;b=this.getType().getSupertypes().copy();a=b.collect(function(a){return a.getSignalName();});a=a.slice(0,a.getPosition('TP.sig.Signal')+1);return a;});TP.sig.Signal.Inst.defineMethod('getSignalOrigin',function(){return this.getOrigin();});TP.sig.Signal.Inst.defineMethod('getTarget',function(){var b,a,c;b=this.getPayload();if(TP.isEvent(b)){if(TP.isValid(b.tibetTarget)){a=b.tibetTarget;}else if(TP.isElement(b.srcElement)){a=b.srcElement;}else{a=b.target;}}else if(TP.isElement(b)){a=b;}else if(TP.canInvoke(b,'at')){if(TP.isEmpty(a=b.at('tibetTarget'))){c=b.at('elementGlobalID');if(TP.notEmpty(c)){if(TP.isValid(a=TP.byOID(c))){if(TP.canInvoke(a,'getNativeNode')){a=a.getNativeNode();}}}else{a=b.at('target');}}}else if(TP.isValid(a=TP.byOID(this.getOrigin()))){if(TP.canInvoke(a,'getNativeNode')){a=a.getNativeNode();}}return a;});TP.sig.Signal.Inst.defineMethod('getTargetGlobalID',function(){var a,b,c;a=this.getPayload();if(TP.isEvent(a)){b=a.elementGlobalID;if(TP.isEmpty(b)){c=a.srcElement||a.target;b=TP.gid(c);}}else if(TP.isElement(a)){b=TP.gid(a);}else if(TP.canInvoke(a,'at')){b=a.at('elementGlobalID');}if(TP.notEmpty(b)){return b;}return this.getOrigin();});TP.sig.Signal.Inst.defineMethod('getTargetLocalID',function(){var a,b,c;a=this.getPayload();if(TP.isEvent(a)){b=a.elementLocalID;if(TP.isEmpty(b)){c=a.srcElement||a.target;b=TP.lid(c);}}else if(TP.isElement(a)){b=TP.lid(a);}else if(TP.canInvoke(a,'at')){b=a.at('elementLocalID');}if(TP.notEmpty(b)){return b;}return this.getOrigin();});TP.sig.Signal.Inst.defineMethod('getTypeSignalNames',function(){var b,a;b=this.getType().getTypes().copy();a=b.collect(function(a){return a.getSignalName();});a=a.slice(0,a.getPosition('TP.sig.Signal')+1);return a;});TP.sig.Signal.Inst.defineMethod('getWindow',function(){var a,b;a=this.getPayload();if(TP.isEvent(a)){return TP.ifInvalid(a.view,TP.sys.getUICanvas(true));}if(TP.canInvoke(a,'at')){return TP.ifInvalid(a.at('view'),TP.sys.getUICanvas(true));}if(TP.isWindow(b=TP.sys.getUICanvas(true))){return b;}return window;});TP.sig.Signal.Inst.defineMethod('ignoreHandler',function(b){var c,a;if(TP.notValid(b)){return;}c=b.getID();if(TP.notValid(a=this.$get('ignoreList'))){a=TP.hc();this.$set('ignoreList',a,false);}return a.atPut(c,true);});TP.sig.Signal.Inst.defineMethod('isBubbling',function(){var a;if(TP.notEmpty(a=this.$get('bubbling'))){return a;}return this.getType().isBubbling();});TP.sig.Signal.Inst.defineMethod('isCancelable',function(){var a;if(TP.notEmpty(a=this.$get('cancelable'))){return a;}return this.getType().isCancelable();});TP.sig.Signal.Inst.defineMethod('isIgnoring',function(a){var b;if(TP.notValid(b=this.get('ignoreList'))){return false;}if(TP.notValid(a)){return true;}return TP.isTrue(b.at(a.getID()));});TP.sig.Signal.Inst.defineMethod('isRecyclable',function(a){if(TP.isBoolean(a)){this.$set('recyclable',a);}return TP.isTrue(this.$get('recyclable'));});TP.sig.Signal.Inst.defineMethod('isSignalingRoot',function(b){var a;a=TP.sig.SignalMap.$getSignalType(this,this.getType());if(!TP.isType(a)){a=TP.sys.getTypeByName(a);}if(!TP.isType(a)){a=this.getType();}return a.isSignalingRoot(b);});TP.sig.Signal.Inst.defineMethod('isSpoofed',function(){return this.getTypeName()!==this.getSignalName();});TP.sig.Signal.Inst.defineMethod('preventDefault',function(b){var a;a=TP.ifInvalid(b,true);return this.shouldPrevent(a);});TP.sig.Signal.Inst.defineMethod('release',function(){this.recyclable=true;return this;});TP.sig.Signal.Inst.defineMethod('recycle',function(){this.origin=null;this.context=null;this.listener=null;this.ignoreList=null;this.phase=null;this.payload=null;this.recyclable=false;this.signalName=null;this.$shouldPrevent=false;this.$shouldStop=false;this.target=null;this.time=null;return this;});TP.sig.Signal.Inst.defineMethod('renewHandler',function(a){var b,c;if(TP.notValid(a)){return;}b=a.getID();if(TP.notValid(c=this.$get('ignoreList'))){return;}return c.atPut(b,false);});TP.sig.Signal.Inst.defineMethod('setContext',function(a){this.context=a;return this;});TP.sig.Signal.Inst.defineMethod('setOrigin',function(a){if(TP.isString(a)){this.origin=a.valueOf();}else{this.origin=a;}return this;});TP.sig.Signal.Inst.defineMethod('setPayload',function(a){this.payload=a;return this;});TP.sig.Signal.Inst.defineMethod('setPhase',function(a){this.phase=a;return this;});TP.sig.Signal.Inst.defineMethod('setSignalName',function(a,b){this.$set('signalName',a);if(TP.isFalse(b)){this.clearIgnores();}this.shouldPrevent(false);this.shouldStop(false);return this;});TP.sig.Signal.Inst.defineMethod('shouldLog',function(){return true;});TP.sig.Signal.Inst.defineMethod('shouldPrevent',function(a){if(TP.isDefined(a)){this.$shouldPrevent=a;}return this.$shouldPrevent;});TP.sig.Signal.Inst.defineMethod('shouldStop',function(a){if(!this.isCancelable()){return false;}if(TP.isDefined(a)){this.$shouldStop=a;}return this.$shouldStop;});TP.sig.Signal.Inst.defineMethod('stopPropagation',function(b){var a;a=TP.ifInvalid(b,true);return this.shouldStop(a);});TP.sig.Signal.defineSubtype('Exception');TP.sig.Exception.isSignalingRoot(true);TP.definePrimitive('ec',function(a,b){var c;c=TP.isEmpty(b)?a.message:b;return TP.sig.Exception.construct(TP.hc('object',a,'message',c));});TP.sig.Exception.Type.defineAttribute('$level',TP.ERROR);TP.sig.Exception.Type.defineAttribute('defaultPolicy',TP.EXCEPTION_FIRING);TP.sig.Exception.Type.defineMethod('getLevel',function(){return this.$get('$level');});TP.sig.Exception.Inst.defineMethod('asSource',function(){var a,b,c,d;if(this.$$format_asSource){return TP.recursion(this);}this.$$format_asSource=true;a=this.at('object');if(TP.isError(a)){b=TP.ifInvalid(a.message,a.toString());}else if(TP.isValid(a)){b=TP.ifInvalid(TP.str(a),a.toString());}else{b=this.getMessage();}try{c=this.getTypeName()+'.construct('+'TP.hc('+'\'object\', '+TP.src(a)+', '+'\'message\', '+'\''+b+'\''+'))';d=this.getUniqueValueKeys();d.remove('payload');c+=this.$generateSourceSets(d);}catch(a){c=this.toString();}delete this.$$format_asSource;return c;});TP.sig.Exception.Inst.defineMethod('asDumpString',function(){var a,b,c;if(this.$$format_asString){return TP.recursion(this);}this.$$format_asString=true;a=this.at('object');if(TP.isError(a)){b=TP.ifInvalid(TP.str(a),a.toString());b+=TP.getStackInfo(a).join('\n');}else if(TP.isValid(a)){b=TP.ifInvalid(TP.str(a),a.toString());}else{b=this.getMessage();}try{c=this.getSignalName()+' :: '+'('+b+')';}catch(a){c=this.toString();}delete this.$$format_asString;return c;});TP.sig.Exception.Inst.defineMethod('asHTMLString',function(){var a,c,b;if(this.$$format_asHTMLString){return TP.recursion(this);}this.$$format_asHTMLString=true;a=this.at('object');if(TP.isValid(a)){c=TP.ifInvalid(TP.str(a),a.toString());}else{c=this.getMessage();}try{if(TP.isValid(a)){b='<span class="TP_sig_Exception '+TP.escapeTypeName(TP.tname(this))+'">'+'<span data-name="payload">'+TP.htmlstr(a)+'</span>'+'</span>';}else{b='<span class="TP_sig_Exception '+TP.escapeTypeName(TP.tname(this))+'">'+'<span data-name="payload"><span data-name="message">'+TP.htmlstr(c)+'</span></span>'+'</span>';}}catch(a){b=this.toString();}delete this.$$format_asHTMLString;return b;});TP.sig.Exception.Inst.defineMethod('asJSONSource',function(){var a,c,b;if(this.$$format_asJSONSource){return TP.recursion(this);}this.$$format_asJSONSource=true;a=this.at('object');if(TP.isValid(a)){c=TP.ifInvalid(TP.str(a),a.toString());}else{c=this.getMessage();}try{if(TP.isValid(a)){b='{"type":'+this.getTypeName().quoted('"')+','+'"data":{'+'"signame":'+this.getSignalName().quoted('"')+','+'"payload":'+TP.json(a)+'}}';}else{b='{"type":'+this.getTypeName().quoted('"')+','+'"data":{'+'"signame":'+this.getSignalName().quoted('"')+','+'"payload":{"message":'+TP.json(c)+'}'+'}}';}}catch(a){b=this.toString();}delete this.$$format_asJSONSource;return b;});TP.sig.Exception.Inst.defineMethod('asPrettyString',function(){var a,c,b;if(this.$$format_asPrettyString){return TP.recursion(this);}this.$$format_asPrettyString=true;a=this.at('object');if(TP.isValid(a)){c=TP.ifInvalid(TP.str(a),a.toString());}else{c=this.getMessage();}try{if(TP.isValid(a)){b='<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+TP.pretty(a)+'</dl>';}else{b='<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+TP.pretty(c)+'</dl>';}}catch(a){b=this.toString();}delete this.$$format_asPrettyString;return b;});TP.sig.Exception.Inst.defineMethod('asString',function(e){var a,b,d,c;d=TP.ifInvalid(e,true);if(!d){return this.getSignalName()+TP.OID_PREFIX+this.toString().split(TP.OID_PREFIX).last();}if(this.$$format_asString){return TP.recursion(this);}this.$$format_asString=true;a=this.at('object');if(TP.isValid(a)){b=TP.ifInvalid(TP.str(a),a.toString());}else{b=this.getMessage();}try{c=this.getSignalName()+' :: '+'('+b+')';}catch(a){c=this.toString();}delete this.$$format_asString;return c;});TP.sig.Exception.Inst.defineMethod('asXMLString',function(){var a,c,b;if(this.$$format_asXMLString){return TP.recursion(this);}this.$$format_asXMLString=true;a=this.at('object');if(TP.isValid(a)){c=TP.ifInvalid(TP.str(a),a.toString());}else{c=this.getMessage();}try{if(TP.isValid(a)){b='<instance type="'+TP.tname(this)+'">'+'<payload>'+TP.xmlstr(a)+'</payload>'+'</instance>';}else{b='<instance type="'+TP.tname(this)+'">'+'<payload><message>'+TP.xmlstr(c)+'</message></payload>'+'</instance>';}}catch(a){b=this.toString();}delete this.$$format_asXMLString;return b;});TP.sig.Exception.Inst.defineMethod('getError',function(){return this.at('object');});TP.sig.Exception.Inst.defineMethod('getLevel',function(){return this.getType().getLevel();});TP.sig.Exception.Inst.defineMethod('getMessage',function(){return this.at('message');});TP.sig.Exception.Inst.defineMethod('preventDefault',function(a){$handled=true;return this.callNextMethod();});TP.sig.Signal.defineSubtype('TRACE');TP.sig.Signal.defineSubtype('INFO');TP.sig.Signal.defineSubtype('SYSTEM');TP.sig.Exception.defineSubtype('WARN');TP.sig.WARN.defineSubtype('ERROR');TP.sig.ERROR.defineSubtype('SEVERE');TP.sig.SEVERE.defineSubtype('FATAL');TP.sig.TRACE.Type.defineAttribute('$level',TP.TRACE);TP.sig.INFO.Type.defineAttribute('$level',TP.INFO);TP.sig.WARN.Type.defineAttribute('$level',TP.WARN);TP.sig.ERROR.Type.defineAttribute('$level',TP.ERROR);TP.sig.SEVERE.Type.defineAttribute('$level',TP.SEVERE);TP.sig.FATAL.Type.defineAttribute('$level',TP.FATAL);TP.sig.SYSTEM.Type.defineAttribute('$level',TP.SYSTEM);TP.sig.Signal.defineSubtype('Change');TP.sig.Change.Type.defineAttribute('defaultPolicy',TP.INHERITANCE_FIRING);TP.sig.Change.isSignalingRoot(true);TP.sig.Change.Inst.defineMethod('getAction',function(){return this.at('action');});TP.sig.Change.Inst.defineMethod('getAspect',function(){return this.at('aspect');});TP.sig.Change.Inst.defineMethod('getSignalNames',function(){var a;a=this.getSupertypeSignalNames();if(!a.contains('TP.sig.Change')){a.unshift('TP.sig.Change');}a.unshift(this.getSignalName());return a;});TP.sig.Change.Inst.defineMethod('getValue',function(){var b,a,c;b=this.at('value');if(TP.isValid(b)){return b;}a=this.getOrigin();if(TP.isString(a)){a=TP.sys.getObjectById(a);if(TP.notValid(a)){return;}}c=this.getAspect();if(TP.isEmpty(c)){return;}if(TP.canInvoke(a,'get')){return a.get(c);}return;});TP.sig.Change.defineSubtype('IndexChange');TP.sig.Change.defineSubtype('ValueChange');TP.sig.ValueChange.defineSubtype('StructureChange');TP.lang.Object.defineSubtype('sig:SignalMap');TP.sig.SignalMap.shouldLog(false);if(TP.notValid(TP.sig.SignalMap.INTERESTS)){TP.sig.SignalMap.INTERESTS=TP.constructOrphanObject();}TP.sig.SignalMap.Type.defineConstant('CHANGE_REGEX',/Change/);TP.sig.SignalMap.Type.defineConstant('INDEX_CHANGE_REGEX',/Index[0-9]+Change/);TP.sig.SignalMap.Type.defineConstant('ERROR_REGEX',/Error|Exception|Invalid|Violation|Failed|NotFound/);TP.sig.SignalMap.Type.defineConstant('ERROR_CODE_REGEX',/^[0-9]+$/);TP.sig.SignalMap.Type.defineConstant('WARN_REGEX',/Warning/);TP.sig.SignalMap.defineMethod('$computeResponderChain',function(d,e,c){var b,a;b=TP.ac();a=e;while(TP.isValid(a)){if(TP.canInvoke(a,'isResponderFor')&&a.isResponderFor(d,c)){b.push(a);}if(TP.canInvoke(a,'getNextResponder')){a=a.getNextResponder(d,c);}else{break;}}if(TP.isTrue(c)){b.reverse();}b.isOriginSet(true);return b;});TP.sig.SignalMap.defineMethod('$getPolicyName',function(a){if(TP.isString(a)){return a;}if(TP.isCallable(a)){return a.getName();}return;});TP.sig.SignalMap.defineMethod('$getSignalInstance',function(b,f,g,d,e){var a,c;if(TP.isString(b)||!TP.canInvoke(b,'clearIgnores')){c=TP.sig.SignalMap.$getSignalType(b,g);if(TP.isType(c)){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Using signal type named: '+c.getName(),TP.SIGNAL_LOG,arguments):0;a=c.construct(f);a.$set('signalName',b.getSignalName());TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Returning instance with signalName: '+a.getSignalName(),TP.SIGNAL_LOG,arguments):0;}else{TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Failed to find signal instance for: '+b,TP.SIGNAL_LOG,arguments):0;a=b;}}else{TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Returning supplied signal instance: '+b,TP.SIGNAL_LOG,arguments):0;a=b;}if(TP.canInvoke(a,'clearIgnores')){a.clearIgnores();}if(TP.notEmpty(d)){a.set('cancelable',d);}if(TP.notEmpty(e)){a.set('bubbling',e);}return a;});TP.sig.SignalMap.defineMethod('$getSignalType',function(a,d){var e,c,b;if(TP.isString(a)){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Getting type for aSignal string: '+a,TP.SIGNAL_LOG,arguments):0;e=a;if(TP.notValid(c=TP.sys.getTypeByName(e))){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('No signal type named: '+e,TP.SIGNAL_LOG,arguments):0;if(TP.sig.SignalMap.ERROR_REGEX.test(a)||TP.sig.SignalMap.ERROR_CODE_REGEX.test(a)){b=TP.ifInvalid(d,TP.sig.ERROR);}else if(TP.sig.SignalMap.WARN_REGEX.test(a)){b=TP.ifInvalid(d,TP.sig.WARN);}else if(TP.sig.SignalMap.CHANGE_REGEX.test(a)){b=TP.ifInvalid(d,TP.sig.Change);}else if(TP.sig.SignalMap.INDEX_CHANGE_REGEX.test(a)){b=TP.ifInvalid(d,TP.sig.IndexChange);}else{b=TP.ifInvalid(d,TP.sig.Signal);}if(TP.isType(b)){c=b;}else{c=TP.sys.getTypeByName(b);}}}else if(TP.isType(a)){c=a;}else{c=TP.type(a);}return c;});TP.sig.SignalMap.defineMethod('$computeOriginID',function(b){var a;a=TP.isValid(b)?TP.id(b):TP.ANY;if(a==='*'||a===''){a=TP.ANY;}return a;});TP.sig.SignalMap.defineMethod('$computeSignalName',function(b){var a;a=TP.isValid(b)?b.getSignalName():TP.ANY;if(TP.notValid(a)||a==='*'||a===''){a=TP.ANY;}return a;});TP.sig.SignalMap.defineMethod('$isInterestSuspended',function(d,e){var b,c,a;b=TP.sig.SignalMap.$computeOriginID(d);c=TP.sig.SignalMap.$computeSignalName(e);a=TP.sig.SignalMap.INTERESTS[b+'.'+c];if(TP.isValid(a)){return a.suspect===true;}});TP.sig.SignalMap.defineMethod('$registerHandlerInfo',function(j,p,r,k,i,h,f,t){var e,c,d,o,a,s,b,m,n,q,l,g;TP.debug('break.signal_register');if(TP.isEmpty(j)||j==='*'){e=TP.ANY;}else{e=j;}e=e.split(' ');if(TP.isEmpty(p)||p==='*'){d=TP.ANY;}else{d=p;}d=d.split(' ');g=TP.ac();s=TP.ifInvalid(t,false);for(b=0;b<e.getSize();b++){c=e.at(b);for(m=0;m<d.getSize();m++){o=d.at(m);if(s){if(j===f){a=TP.constructOrphanObject();a.target=c;}else{if(f.indexOf(' ')===TP.NOT_FOUND){a=TP.constructOrphanObject();if(TP.regex.DOCUMENT_ID.test(c)){a.target=c;}else{a.target=f;a.xml_target=c;}}else{q=f.split(' ');for(n=0;n<q.getSize();n++){l=q.at(n);a=TP.constructOrphanObject();a.target=l;a.xml_target=c;a.event=o;a.handler=r;TP.notEmpty(k)?a.phase=k:0;TP.notEmpty(i)?a.propagate=i:0;TP.notEmpty(h)?a.defaultAction=h:0;TP.notEmpty(l)?a.observer=l:0;g.push(a);}continue;}}}else{a=TP.constructOrphanObject();a.target=c;}a.event=o;a.handler=r;TP.notEmpty(k)?a.phase=k:0;TP.notEmpty(i)?a.propagate=i:0;TP.notEmpty(h)?a.defaultAction=h:0;TP.notEmpty(f)?a.observer=f:0;g.push(a);}}for(b=0;b<g.getSize();b++){this.$registerHandlerEntry(g.at(b),true);}return;});TP.sig.SignalMap.defineMethod('$registerHandlerEntry',function(aHandlerEntry,quiet){var map,orgid,signame,origin,type,owner,root,entry,id,hash,source,phase,win;map=TP.sig.SignalMap.INTERESTS;orgid=TP.sig.SignalMap.$computeOriginID(aHandlerEntry.target);signame=TP.sig.SignalMap.$computeSignalName(aHandlerEntry.event);origin=TP.isTypeName(orgid)?TP.sys.require(orgid):orgid;if(TP.canInvoke(origin,'addObserver')){origin.addObserver(orgid,signame);}type=TP.isTypeName(signame)?TP.sys.require(signame):signame;if(TP.notValid(type)){if(TP.regex.KEY_EVENT.test(signame)){type=TP.sys.require('TP.sig.DOMKeySignal');}}if(TP.canInvoke(type,'getSignalOwner')&&TP.isValid(owner=type.getSignalOwner())){if(owner!==origin&&TP.canInvoke(owner,'addObserver')){owner.addObserver(orgid,signame);}}id=orgid+'.'+signame;root=map[id];if(TP.notValid(root)){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Interest root not found.',TP.SIGNAL_LOG,arguments):0;entry=TP.constructOrphanObject();entry.target=orgid;entry.event=signame;entry.listeners=[];map[id]=entry;root=entry;}entry=null;id=aHandlerEntry.handler;if(TP.notEmpty(id)){phase=aHandlerEntry.phase;entry=root.listeners.detect(function(a){return a.handler===id&&a.phase===phase;});if(TP.notValid(entry)){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Listener not found.',TP.SIGNAL_LOG,arguments):0;}}if(TP.isValid(entry)){if(TP.isTrue(quiet)){return;}if(!TP.sys.shouldAllowDuplicateInterests()){TP.ifWarn(TP.$DEBUG&&TP.$$VERBOSE)?TP.warn(TP.join('Duplicate interest registration for origin: ',orgid,' signal: ',signame,' handler: ',id,' ignored.'),TP.SIGNAL_LOG,arguments):0;return;}if(entry.suspend===true){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Listener currently flagged as suspended.',TP.SIGNAL_LOG,arguments):0;delete entry.suspend;return;}if(entry.remove===true){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Listener currently flagged as removed.',TP.SIGNAL_LOG,arguments):0;delete entry.remove;return;}}TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Creating new listener entry.',TP.SIGNAL_LOG,arguments):0;entry=aHandlerEntry;if(TP.isEmpty(id)||id.startsWith('javascript:')){if(TP.isEmpty(id)){TP.ifWarn()?TP.warn(TP.boot.$annotate(entry,'Invalid handler in listener.'),TP.SIGNAL_LOG,arguments):0;}else{source=TP.xmlEntitiesToLiterals(id.strip(/javascript:/));source='function (triggerSignal) {'+source+'};';}TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Found function source: '+source,TP.SIGNAL_LOG,arguments):0;if(TP.isString(source)){hash=TP.hash(source,TP.HASH_MD5);if(TP.isValid(TP.sys.getObjectById(hash,true))){id=hash;entry.handler=id;return TP.sig.SignalMap.$registerHandlerEntry(entry);}else{try{win=window;eval('win.$$handler = '+source);win.$$handler.setID(hash);id=win.$$handler.getID();TP.sys.registerObject(win.$$handler);}catch(a){TP.ifError()?TP.error(TP.ec(a,'Problem creating handler function.'),TP.SIGNAL_LOG,arguments):0;return;}}}}else if(id.startsWith('#')){}if(TP.isValid(id)){entry.handler=id;root.listeners.push(entry);TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Listener entry created for ID: '+id,TP.SIGNAL_LOG,arguments):0;}return;});TP.sig.SignalMap.defineMethod('$registerInterest',function(j,k,c,i){var d,h,e,f,a,g,b;d=TP.sig.SignalMap.$computeOriginID(j);e=TP.sig.SignalMap.$computeSignalName(k);h=TP.sig.SignalMap.INTERESTS;g=d+'.'+e;f=h[g];if(TP.notValid(f)){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Interest root not found.',TP.SIGNAL_LOG,arguments):0;a=TP.constructOrphanObject();a.target=d;a.event=e;a.listeners=[];h[g]=a;f=a;}a=null;b=TP.gid(c);a=f.listeners.detect(function(a){return a.handler===b;});if(TP.notValid(a)){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Listener entry not found.',TP.SIGNAL_LOG,arguments):0;}if(TP.isValid(a)){if(!TP.sys.shouldAllowDuplicateInterests()){TP.ifWarn(TP.$DEBUG&&TP.$$VERBOSE)?TP.warn(TP.join('Duplicate interest registration for origin: ',d,' signal: ',e,' handler: ',b,' ignored.'),TP.SIGNAL_LOG,arguments):0;return;}if(a.suspend===true){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Listener entry currently flagged as suspended.',TP.SIGNAL_LOG,arguments):0;delete a.suspend;TP.sys.registerObject(c,b,true);return;}if(a.remove===true){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Listener entry currently flagged as removed.',TP.SIGNAL_LOG,arguments):0;delete a.remove;TP.sys.registerObject(c,b,true);return;}}TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Creating listener entry.',TP.SIGNAL_LOG,arguments):0;a=TP.constructOrphanObject();a.target=d;a.event=e;if(i){a.phase='capture';}a.handler=b;TP.sys.registerObject(c);f.listeners.push(a);TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace(TP.join('Listener entry created for ID: ',b,' with handler: ',c),TP.SIGNAL_LOG,arguments):0;return;});TP.sig.SignalMap.defineMethod('$removeInterest',function(m,n,l,e){var f,g,h,i,b,k,d,a,j,c;f=TP.sig.SignalMap.$computeOriginID(m);g=TP.sig.SignalMap.$computeSignalName(n);h=TP.sig.SignalMap.INTERESTS;i=f+'.'+g;b=h[i];if(TP.notValid(b)){return;}if(TP.notValid(l)){if(TP.isTrue(e)){a=b.listeners.select(function(a){return a.phase==='capture';});}else if(TP.isFalse(e)){a=b.listeners.select(function(a){return a.phase!=='capture';});}else{a=b.listeners;}TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Removing '+a.length+' listener entries.',TP.SIGNAL_LOG,arguments):0;for(c=0;c<a.length;c++){j=a.at(c);j.remove===true;if(!TP.sys.shouldIgnoreViaFlag()){b.listeners=a.select(function(a){return a.remove!==true;});}}}else{k=l.getID();d=b.listeners.detect(function(a){return a.handler===k;});if(TP.isValid(d)){d.remove=true;if(!TP.sys.shouldIgnoreViaFlag()){a=b.listeners;b.listeners=a.select(function(a){return a.remove!==true;});}}}return;});TP.sig.SignalMap.Type.defineMethod('getListeners',function(k,m,l){var c,e,g,h,i,j,f,d,a,b;c=TP.ac();e=l;g=TP.sig.SignalMap.$computeOriginID(k);h=TP.sig.SignalMap.$computeSignalName(m);i=TP.sig.SignalMap.INTERESTS;j=g+'.'+h;f=i[j];if(TP.notValid(f)){return c;}d=f.listeners;for(b=0;b<d.length;b++){a=d.at(b);if(a.suspend===true||a.remove===true){continue;}if(TP.isFalse(e)){if(a.phase==='capture'){continue;}}else if(TP.isTrue(e)){if(a.phase!=='capture'){continue;}}c.push(a);}return c;});TP.sig.SignalMap.Type.defineMethod('notifyHandlers',function(q,u,a,t,s,o,r){var h,i,j,n,l,f,e,b,c,d,m,p,g,k;TP.debug('break.signal_notify');if(TP.notValid(a)){return;}n=TP.ifInvalid(t,true);d=a.getOrigin();if(d===TP.ANY){a.setOrigin(null);}if(n&&a.shouldStop()){a.setOrigin(d);return;}l=s;f=TP.sig.SignalMap.$computeOriginID(q);e=TP.sig.SignalMap.$computeSignalName(u);if(TP.isValid(o)){i=o;}else{i=TP.sig.SignalMap.INTERESTS[f+'.'+e];if(TP.notValid(i)){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace(TP.join('Interest not found for: ',f,'.',e),TP.SIGNAL_LOG,arguments):0;a.setOrigin(d);return;}if(i.suspend===true){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace(TP.join('Interest for: ',f,'.',e,' is flagged as suspended.'),TP.SIGNAL_LOG,arguments):0;a.setOrigin(d);return;}}j=i.listeners.slice(0);TP.ifTrace(TP.$$DEBUG&&TP.sys.shouldLogSignals())?TP.trace(TP.join(f,':',e,' has ',j.length,' listeners.'),TP.SIGNAL_LOG,arguments):0;try{$signal_stack.push(a);$signal=a;k=a.getTargetGlobalID();for(h=0;h<j.length;h++){if(n&&a.shouldStop()){a.setOrigin(d);return;}b=j[h];if(b.suspend===true||b.remove===true){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Listener '+h+' is suspended or removed.',TP.SIGNAL_LOG,arguments):0;continue;}if(TP.isFalse(l)){if(b.phase==='capture'){continue;}}else if(TP.isTrue(l)){if(b.phase!=='capture'){continue;}}TP.debug('break.signal_handler');if(TP.isTrue(r)){g=b.xml_target;p=b.observer;if(TP.notEmpty(g)&&g!==TP.ANY){if(g!==k&&g!==p){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace(TP.join('DOM target check ',' wanted: ',g,' found: ',k,'. Skipping listener: ',TP.str(b)),TP.SIGNAL_LOG,arguments):0;continue;}}}c=TP.byOID(b.handler);if(TP.regex.TIBET_URN.test(b.handler)&&c===d){c=TP.uc(b.handler);}if(TP.notValid(c)){TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)?TP.trace('Could not find handler with ID: '+b.handler,TP.SIGNAL_LOG,arguments):0;continue;}if(TP.sys.shouldThrowHandlers()){if(!a.isIgnoring(c)){a.ignoreHandler(c);a.set('listener',b);c.handle(a);}}else{try{if(!a.isIgnoring(c)){a.ignoreHandler(c);a.set('listener',b);c.handle(a);}}catch(b){try{m=c.getHandler(a);if(TP.isCallable(m)){TP.ifError()?TP.error(TP.ec(b,TP.join('Error in: ',f,'.',e,' responder: ',c.getID(),'\nhandler: ',m.getName())),TP.SIGNAL_LOG,arguments):0;}else{TP.ifError()?TP.error(TP.ec(b,TP.join('Error in: ',f,'.',e,' responder: ',c.getID())),TP.SIGNAL_LOG,arguments):0;}}catch(a){}if(TP.sys.shouldRegisterLoggers()){TP.sys.registerObject(c,null,true);}}}if(b.propagate==='stop'){a.stopPropagation(true);}if(b.defaultAction==='cancel'){a.preventDefault(true);}}a.setOrigin(d);}catch(b){TP.ifError()?TP.error(TP.ec(b,TP.join('Problem executing handlers for: ',TP.str(a))),TP.SIGNAL_LOG,arguments):0;}finally{$signal=$signal_stack.pop();}return;});TP.sig.SignalMap.defineMethod('FIRE_ONE',function(f,h,i,j,g){var a,b,d,e,c;e=TP.ifInvalid(h,TP.sig.Signal);a=TP.sig.SignalMap.$getSignalInstance(e,j,g);if(!TP.isKindOf(a,TP.sig.Signal)){return;}c=TP.ifInvalid(f,TP.ANY);a.setOrigin(c);a.setContext(i);b=TP.id(c);d=a.getSignalName();TP.sig.SignalMap.notifyHandlers(b,d,a,true);if(a.shouldStop()){a.isRecyclable(true);return a;}TP.sig.SignalMap.notifyHandlers(b,null,a,true);if(a.shouldStop()){a.isRecyclable(true);return a;}if(b!==TP.ANY){TP.sig.SignalMap.notifyHandlers(null,d,a,true);}a.isRecyclable(true);return a;});TP.sig.SignalMap.defineMethod('DEFAULT_FIRING',function(a,b,j,h,i){var g,e,c,d,f;g=TP.sig.SignalMap.FIRE_ONE;if(TP.isArray(a)&&!a.isOriginSet()||!TP.isArray(a)){e=TP.id(a);if(TP.isArray(b)){for(d=0;d<b.getSize();d++){f=g(e,b.at(d),j,h,i);}}else{f=g(e,b,j,h,i);}}else if(TP.isArray(a)){if(TP.isArray(b)){for(c=0;c<a.getSize();c++){e=TP.id(a.at(c));for(d=0;d<b.getSize();d++){f=g(e,b.at(d),j,h,i);}}}else{for(c=0;c<a.getSize();c++){e=TP.id(a.at(c));f=g(e,b,j,h,i);}}}return f;});TP.sig.SignalMap.defineMethod('DOM_FIRING',function(f,l,o,n,m){var j,a,c,b,k,e,g,h,d,i;TP.debug('break.signal_domfiring');if(TP.notValid(l)||TP.notValid(f)){return TP.sig.SignalMap.raise('TP.sig.InvalidDOMSignal',arguments);}j=TP.sig.SignalMap.INTERESTS;if(!TP.isArray(f)){h=TP.ac(TP.id(f));}else{h=f.collect(function(a){return TP.id(a);});}a=TP.sig.SignalMap.$getSignalInstance(l,n,m);if(!TP.isKindOf(a,TP.sig.Signal)){return;}if(TP.isEmpty(c=a.getSignalName())){c=TP.ANY;}a.setContext(o);a.setPhase(TP.CAPTURING_PHASE);k=a.getTargetGlobalID();d=TP.ac();i=h.getSize();for(e=0;e<i;e++){b=h.at(e);a.setOrigin(b);if(TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)){TP.signal.$suspended=true;TP.sys.logSignal('Checking DOM_FIRING id '+b+'.'+c,TP.TRACE,arguments);TP.signal.$suspended=false;}if(TP.isValid(g=j[b+'.'+c])){if(TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)){TP.signal.$suspended=true;TP.sys.logSignal(TP.join('DOM_FIRING id ',b,'.',c,' found, preserving ',b),TP.TRACE,arguments);TP.signal.$suspended=false;}d.push(b);TP.sig.SignalMap.notifyHandlers(b,c,a,false,true,g,true);}if(TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)){TP.signal.$suspended=true;TP.sys.logSignal('Checking DOM_FIRING id '+b+'.'+TP.ANY,TP.TRACE,arguments);TP.signal.$suspended=false;}if(c!==TP.ANY){if(TP.isValid(g=j[b+'.'+TP.ANY])){if(TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)){TP.signal.$suspended=true;TP.sys.logSignal('DOM_FIRING id '+b+'.'+TP.ANY+' found, preserving '+b,TP.TRACE,arguments);TP.signal.$suspended=false;}if(d.last()!==b){d.push(b);}TP.sig.SignalMap.notifyHandlers(b,null,a,false,true,g,true);}}if(a.shouldStop()){return a;}if(b===k){a.setPhase(TP.AT_TARGET);break;}}d.reverse();if(TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)){TP.signal.$suspended=true;TP.sys.logSignal('Bubbling DOM_FIRING through preserved IDs: '+d.toString(),TP.TRACE,arguments);TP.signal.$suspended=false;}i=d.getSize();for(e=0;e<i;e++){b=d.at(e);a.setOrigin(b);TP.sig.SignalMap.notifyHandlers(b,c,a,false,false,null,true);if(c!==TP.ANY){TP.sig.SignalMap.notifyHandlers(b,null,a,false,false,null,true);}if(a.shouldStop()){return a;}if(a.getPhase()===TP.AT_TARGET){if(!a.isBubbling()){break;}a.setPhase(TP.BUBBLING_PHASE);}}a.setOrigin(k);TP.sig.SignalMap.notifyHandlers(null,c,a,false,true,null,true);if(a.shouldStop()){return a;}TP.sig.SignalMap.notifyHandlers(null,c,a,false,false,null,true);return a;});TP.sig.SignalMap.defineMethod('RESPONDER_FIRING',function(j,e,g,h,i){var a,f,d,b,c;TP.debug('break.signal_responderfiring');if(TP.notValid(e)){return TP.sig.SignalMap.raise('TP.sig.InvalidResponderSignal',arguments);}a=TP.sig.SignalMap.$getSignalInstance(e,h,i);if(!TP.isKindOf(a,TP.sig.Signal)){return;}if(TP.isEmpty(f=a.getSignalName())){f=TP.ANY;}a.setContext(g);d=a.getTargetResponder();if(TP.notEmpty(b=TP.sig.SignalMap.$computeResponderChain(a,d,true))){a.set('currentChain',b);if(TP.unwrap(b.last())===TP.unwrap(d)){b.shift();}a.setPhase(TP.CAPTURING_PHASE);for(c=0;c<b.getSize();c++){a.setOrigin(TP.gid(b.at(c)));TP.handle(b.at(c),a);if(a.shouldStop()){return a;}}}if(TP.notEmpty(b=TP.sig.SignalMap.$computeResponderChain(a,d,false))){a.set('currentChain',b);if(TP.unwrap(b.first())===TP.unwrap(d)){a.setPhase(TP.AT_TARGET);a.setOrigin(TP.gid(b.first()));TP.handle(b.first(),a);if(a.shouldStop()){return a;}b.shift();}if(!a.isBubbling()){return a;}a.setPhase(TP.BUBBLING_PHASE);for(c=0;c<b.getSize();c++){a.setOrigin(TP.gid(b.at(c)));TP.handle(b.at(c),a);if(a.shouldStop()){return a;}}}a.setOrigin(d);return a;});TP.sig.SignalMap.defineMethod('EXCEPTION_FIRING',function(l,d,i,j,k){var c,a,e,f,h,g,b;if(TP.notValid(d)){return;}g=TP.ifInvalid(l,TP.ANY);if(!TP.isArray(d)){b=TP.ac();b.push(d);}else{b=d;}h=b.at(0);a=TP.sig.SignalMap.$getSignalInstance(h,j,TP.ifInvalid(k,TP.sig.Exception));if(!TP.isKindOf(a,TP.sig.Signal)){return;}a.setContext(i);a.setOrigin(g);e=TP.id(g);for(c=0;c<b.getSize();c++){f=b.at(c).getSignalName();TP.sig.SignalMap.notifyHandlers(e,f,a,true);if(a.shouldStop()){break;}if(f!==TP.ANY){if(c===0){TP.sig.SignalMap.notifyHandlers(e,null,a,true);if(a.shouldStop()){break;}}}if(e!==TP.ANY){TP.sig.SignalMap.notifyHandlers(null,f,a,true);if(a.shouldStop()){break;}}}return a;});TP.sig.SignalMap.defineMethod('INHERITANCE_FIRING',function(l,d,o,n,m){var g,h,a,f,e,j,k,c,b,i;g=d;if(TP.isArray(d)){if(d.length>=1){TP.ifError()?TP.error('Invalid Signal Array For Firing Policy. Truncating.',TP.SIGNAL_LOG,arguments):0;g=d[0];}else{TP.ifError()?TP.error('Invalid Signal For Firing Policy. Terminating.',TP.SIGNAL_LOG,arguments):0;return;}}h=TP.ifInvalid(l,TP.ANY);a=TP.sig.SignalMap.$getSignalInstance(g,n,m);if(!TP.isKindOf(a,TP.sig.Signal)){return;}a.setContext(o);a.setOrigin(h);f=TP.id(h);e=a.getType();j=a.getSignalNames();k=j.getSize();for(c=0;c<k;c++){b=j.at(c);if(b==='TP.sig.Signal'){break;}TP.sig.SignalMap.notifyHandlers(f,b,a,true);if(a.shouldStop()){break;}if(b!==TP.ANY){if(c===0){TP.sig.SignalMap.notifyHandlers(f,null,a,true);if(a.shouldStop()){break;}}}if(f!==TP.ANY){TP.sig.SignalMap.notifyHandlers(null,b,a,true);if(a.shouldStop()){break;}}i=a.isSpoofed();if(!i&&e.isSignalingRoot()){break;}if(i){}else{e=e.getSupertype();}}return a;});TP.sig.SignalMap.defineMethod('REGISTER_CAPTURING',function(a,e,d){var b,c;if(TP.notValid(d)){return;}c=TP.sig.SignalMap.$computeSignalName(e);if(TP.isValid(a)){if(/Change/.test(c)){if(TP.isMutable(a)){a.shouldSignalChange(true);}else{}}b=TP.id(a);}else{b=TP.ANY;}return TP.sig.SignalMap.$registerInterest(b,c,d,true);});TP.sig.SignalMap.defineMethod('REGISTER_NONCAPTURING',function(a,e,d){var b,c;if(TP.notValid(d)){return;}c=TP.sig.SignalMap.$computeSignalName(e);if(TP.isValid(a)){if(/Change/.test(c)){if(TP.isMutable(a)){a.shouldSignalChange(true);}else{}}b=TP.id(a);}else{b=TP.ANY;}return TP.sig.SignalMap.$registerInterest(b,c,d,false);});TP.sig.SignalMap.defineMethod('REMOVE_CAPTURING',function(c,d,e){var a,b;a=TP.sig.SignalMap.$computeOriginID(c);b=TP.sig.SignalMap.$computeSignalName(d);return TP.sig.SignalMap.$removeInterest(a,b,e,true);});TP.sig.SignalMap.defineMethod('REMOVE_NONCAPTURING',function(c,d,e){var a,b;a=TP.sig.SignalMap.$computeOriginID(c);b=TP.sig.SignalMap.$computeSignalName(d);return TP.sig.SignalMap.$removeInterest(a,b,e,false);});TP.sig.SignalMap.defineMethod('RESUME',function(d,e){var a,b,c;b=TP.sig.SignalMap.$computeOriginID(d);c=TP.sig.SignalMap.$computeSignalName(e);a=TP.sig.SignalMap.INTERESTS[b+'.'+c];if(TP.isValid(a)){delete a.suspend;}return;});TP.sig.SignalMap.defineMethod('SUSPEND',function(d,e){var a,b,c;b=TP.sig.SignalMap.$computeOriginID(d);c=TP.sig.SignalMap.$computeSignalName(e);a=TP.sig.SignalMap.INTERESTS[b+'.'+c];if(TP.isValid(a)){a.suspend=true;}return;});TP.sig.SignalMap.$ignore=function(j,d,o,n){var f,l,b,h,k,g,a,i,m,e,c;if(!TP.isArray(f=j)){f=TP.ac(j);f.isOriginSet(true);}l=f.getSize();for(b=0;b<l;b++){h=TP.isTypeName(f.at(b))?TP.sys.require(f.at(b)):f.at(b);if(TP.canInvoke(h,'removeObserver')){if(TP.isString(d)){a=TP.expandSignalName(d);if(!TP.isType(e=TP.sys.require(a))){e=d;}}else{e=d;}k=h.removeObserver(h,e,o,n);if(!k){return;}}}if(!TP.isArray(g=d)){g=TP.ac(d);g.isOriginSet(true);}l=g.getSize();for(b=0;b<l;b++){a=TP.isString(g.at(b))?g.at(b):g.at(b).getSignalName();a=TP.expandSignalName(a);i=TP.isTypeName(a)?TP.sys.require(a):a;if(!TP.isType(i)){if(TP.regex.KEY_EVENT.test(a)){i=TP.sys.require('TP.sig.DOMKeySignal');}}if(TP.isType(i)&&TP.canInvoke(i,'getSignalOwner')&&TP.isValid(m=i.getSignalOwner())){if(m!==h&&TP.canInvoke(m,'removeObserver')){k=m.removeObserver(j,a,o,n);if(!k){return;}}}}h=TP.ifInvalid(j,TP.ANY);if(TP.isEmpty(d)){e=TP.ANY;}else if(TP.notEmpty(a=TP.expandSignalName(d))&&TP.isType(TP.sys.require(a))){e=a;}else{e=d;}c=TP.ifInvalid(n,TP.sig.SignalMap.REMOVE_NONCAPTURING);if(!TP.isCallable(c)){if(TP.isCallable(TP.sig.SignalMap[c])){c=TP.sig.SignalMap[c];}else if(TP.isString(c)&&c.toLowerCase()==='capture'){c=TP.sig.SignalMap.REMOVE_CAPTURING;}else{c=TP.sig.SignalMap.REMOVE_NONCAPTURING;}}return TP.sig.SignalMap.$invokePolicy(h,e,o,c);};TP.sig.SignalMap.$invokePolicy=function(a,b,e,f){var c,d;if(TP.isArray(a)&&!a.isOriginSet()||!TP.isArray(a)){if(TP.isArray(b)){for(d=0;d<b.getSize();d++){f(a,b.at(d),e);}}else{f(a,b,e);}}else if(TP.isArray(a)){if(TP.isArray(b)){for(c=0;c<a.getSize();c++){for(d=0;d<b.getSize();d++){f(a.at(c),b.at(d),e);}}}else{for(c=0;c<a.getSize();c++){f(a.at(c),b,e);}}}return;};TP.sig.SignalMap.$observe=function(j,d,n,o){var f,l,b,h,k,g,a,i,m,e,c;if(TP.notValid(n)){TP.ifError()?TP.error('Invalid signal handler.',TP.SIGNAL_LOG,arguments):0;return;}if(!TP.isArray(f=j)){f=TP.ac(j);f.isOriginSet(true);}l=f.getSize();for(b=0;b<l;b++){h=TP.isTypeName(f.at(b))?TP.sys.require(f.at(b)):f.at(b);if(TP.canInvoke(h,'addObserver')){if(TP.isString(d)){a=TP.expandSignalName(d);if(!TP.isType(e=TP.sys.require(a))){e=d;}}else{e=d;}k=h.addObserver(h,e,n,o);if(!k){return;}}}if(!TP.isArray(g=d)){g=TP.ac(d);g.isOriginSet(true);}l=g.getSize();for(b=0;b<l;b++){a=TP.isString(g.at(b))?g.at(b):g.at(b).getSignalName();a=TP.expandSignalName(a);i=TP.isTypeName(a)?TP.sys.require(a):a;if(!TP.isType(i)){if(TP.regex.KEY_EVENT.test(a)){i=TP.sys.require('TP.sig.DOMKeySignal');}}if(TP.isType(i)&&TP.canInvoke(i,'getSignalOwner')&&TP.isValid(m=i.getSignalOwner())){if(m!==h&&TP.canInvoke(m,'addObserver')){k=m.addObserver(j,a,n,o);if(!k){return;}}}}h=TP.ifInvalid(j,TP.ANY);if(TP.isEmpty(d)){e=TP.ANY;}else if(TP.notEmpty(a=TP.expandSignalName(d))&&TP.isType(TP.sys.require(a))){e=a;}else{e=d;}c=TP.ifInvalid(o,TP.sig.SignalMap.REGISTER_NONCAPTURING);if(!TP.isCallable(c)){if(TP.isCallable(TP.sig.SignalMap[c])){c=TP.sig.SignalMap[c];}else if(TP.isString(c)&&c.toLowerCase()==='capture'){c=TP.sig.SignalMap.REGISTER_CAPTURING;}else{c=TP.sig.SignalMap.REGISTER_NONCAPTURING;}}return TP.sig.SignalMap.$invokePolicy(h,e,n,c);};TP.sig.SignalMap.$resume=function(l,c){var e,j,b,f,i,g,a,h,k,d,m;if(!TP.isArray(e=l)){e=TP.ac(l);e.isOriginSet(true);}j=e.getSize();for(b=0;b<j;b++){f=TP.isTypeName(e.at(b))?TP.sys.require(e.at(b)):e.at(b);if(TP.canInvoke(f,'resumeObserver')){if(TP.isString(c)){a=TP.expandSignalName(c);if(!TP.isType(d=TP.sys.require(a))){d=c;}}else{d=c;}i=f.resumeObserver(f,d);if(!i){return;}}}if(!TP.isArray(g=c)){g=TP.ac(c);g.isOriginSet(true);}j=g.getSize();for(b=0;b<j;b++){a=TP.isString(g.at(b))?g.at(b):g.at(b).getSignalName();a=TP.expandSignalName(a);h=TP.isTypeName(a)?TP.sys.require(a):a;if(!TP.isType(h)){if(TP.regex.KEY_EVENT.test(a)){h=TP.sys.require('TP.sig.DOMKeySignal');}}if(TP.isType(h)&&TP.canInvoke(h,'getSignalOwner')&&TP.isValid(k=h.getSignalOwner())){if(k!==f&&TP.canInvoke(k,'resumeObserver')){i=k.resumeObserver(l,a);if(!i){return;}}}}f=TP.ifInvalid(l,TP.ANY);if(TP.isEmpty(c)){d=TP.ANY;}else if(TP.notEmpty(a=TP.expandSignalName(c))&&TP.isType(TP.sys.require(a))){d=a;}else{d=c;}m=TP.sig.SignalMap.RESUME;return TP.sig.SignalMap.$invokePolicy(f,d,null,m);};TP.sig.SignalMap.$suspend=function(l,c){var e,j,b,f,i,g,a,h,k,d,m;if(!TP.isArray(e=l)){e=TP.ac(l);e.isOriginSet(true);}j=e.getSize();for(b=0;b<j;b++){f=TP.isTypeName(e.at(b))?TP.sys.require(e.at(b)):e.at(b);if(TP.canInvoke(f,'suspendObserver')){if(TP.isString(c)){a=TP.expandSignalName(c);if(!TP.isType(d=TP.sys.require(a))){d=c;}}else{d=c;}i=f.suspendObserver(f,d);if(!i){return;}}}if(!TP.isArray(g=c)){g=TP.ac(c);g.isOriginSet(true);}j=g.getSize();for(b=0;b<j;b++){a=TP.isString(g.at(b))?g.at(b):g.at(b).getSignalName();a=TP.expandSignalName(a);h=TP.isTypeName(a)?TP.sys.require(a):a;if(!TP.isType(h)){if(TP.regex.KEY_EVENT.test(a)){h=TP.sys.require('TP.sig.DOMKeySignal');}}if(TP.isType(h)&&TP.canInvoke(h,'getSignalOwner')&&TP.isValid(k=h.getSignalOwner())){if(k!==f&&TP.canInvoke(k,'suspendObserver')){i=k.suspendObserver(l,a);if(!i){return;}}}}f=TP.ifInvalid(l,TP.ANY);if(TP.isEmpty(c)){d=TP.ANY;}else if(TP.notEmpty(a=TP.expandSignalName(c))&&TP.isType(TP.sys.require(a))){d=a;}else{d=c;}m=TP.sig.SignalMap.SUSPEND;return TP.sig.SignalMap.$invokePolicy(f,d,null,m);};TP.sig.SignalMap.$ignore[TP.NAME]='$ignore';TP.sig.SignalMap.$ignore[TP.OWNER]=TP.sig.SignalMap;TP.sig.SignalMap.$ignore[TP.TRACK]='Type';TP.sig.SignalMap.$ignore[TP.DISPLAY]='TP.sig.SignalMap.Type.$ignore';TP.sig.SignalMap.$invokePolicy[TP.NAME]='$invokePolicy';TP.sig.SignalMap.$invokePolicy[TP.OWNER]=TP.sig.SignalMap;TP.sig.SignalMap.$invokePolicy[TP.TRACK]='Type';TP.sig.SignalMap.$ignore[TP.DISPLAY]='TP.sig.SignalMap.Type.$invokePolicy';TP.sig.SignalMap.$observe[TP.NAME]='$observe';TP.sig.SignalMap.$observe[TP.OWNER]=TP.sig.SignalMap;TP.sig.SignalMap.$observe[TP.TRACK]='Type';TP.sig.SignalMap.$ignore[TP.DISPLAY]='TP.sig.SignalMap.Type.$observe';TP.sig.SignalMap.$resume[TP.NAME]='$resume';TP.sig.SignalMap.$resume[TP.OWNER]=TP.sig.SignalMap;TP.sig.SignalMap.$resume[TP.TRACK]='Type';TP.sig.SignalMap.$ignore[TP.DISPLAY]='TP.sig.SignalMap.Type.$resume';TP.sig.SignalMap.$suspend[TP.NAME]='$suspend';TP.sig.SignalMap.$suspend[TP.OWNER]=TP.sig.SignalMap;TP.sig.SignalMap.$suspend[TP.TRACK]='Type';TP.sig.SignalMap.$ignore[TP.DISPLAY]='TP.sig.SignalMap.Type.$suspend';TP.definePrimitive('signal',function(b,a,r,p,o,n,m,l){var i,f,h,k,g,c,e,d,q,j,v,s,u,t,w;TP.sys.trapRecursion(true,false);if(TP.signal.$suspended){return;}i=TP.isTypeName(b)?TP.sys.require(b):b;if(TP.canInvoke(i,'signalObservers')){k=i.signalObservers(b,a,r,p,o,n,m,l);if(!k){return;}}g=TP.isString(a)?a:a.getSignalName();f=TP.isTypeName(g)?TP.sys.require(g):g;if(TP.notValid(f)){if(TP.regex.KEY_EVENT.test(g)){f=TP.sys.require('TP.sig.DOMKeySignal');}}if(TP.canInvoke(f,'getSignalOwner')&&TP.isValid(h=f.getSignalOwner())){if(h!==i&&TP.canInvoke(h,'signalObservers')){k=h.signalObservers(b,a,r,p,o,n,m,l);if(!k){return;}}}TP.debug(TP.sys.cfg('break.signal')&&TP.name(a).indexOf('DOMFocus')!==0);if(TP.sys.cfg('break.signal_exception')){if(/Invalid|Exception/.test(a)||TP.isKindOf(a,TP.sig.Exception)){TP.debug();}}if(TP.isValid(b)){if(b.$suspended){return TP.sys.fireNextSignal();}}if(TP.sig.SignalMap.INTERESTS.suspend===true){if(TP.ifTrace(TP.$DEBUG&&TP.$$VERBOSE)){TP.sys.logSignal('Root interest map is suspended.',TP.TRACE,arguments);}return;}if(TP.sys.shouldLogSignals()&&b!==TP.sys.$changeLog&&b!==TP.sys.$patchLog&&b!==TP.sys.$activityLog){d=a.getSignalName();q=TP.sig.SignalMap.$getSignalType(a);v=TP.canInvoke(q,'shouldLog')?q.shouldLog():false;if(v){if(b){if(TP.isArray(b)&&b.isOriginSet()){if(TP.$$VERBOSE){e='['+b.collect(function(a){return TP.id(a,true);}).join(', ');e+=']';}else{e=TP.id(b.last());}}else{e=TP.id(b,true);}}else{e=TP.NULL_OID;}if(a){if(TP.isArray(a)){if(TP.$$VERBOSE){d='['+a.collect(function(a){return a.getSignalName();}).join(', ');d+=']';}else{d=a.last().getSignalName();}}else{d=a.getSignalName();}}else{d='TP.sig.Signal';}if(TP.notEmpty(e)&&TP.notEmpty(d)){s=d+' @@@ '+e;if(TP.sys.shouldLogSignalStack()){try{w=TP.sys.shouldLogStack();TP.sys.shouldLogStack(true);TP.ifTrace()?TP.sys.logSignal(TP.boot.$annotate(a,s),TP.TRACE,arguments):0;}catch(a){}finally{TP.sys.shouldLogStack(w);}}else{TP.ifTrace()?TP.sys.logSignal(TP.boot.$annotate(a,s),TP.TRACE,arguments):0;}}}}c=o;if(!TP.isCallable(c)){if(TP.isCallable(TP.sig.SignalMap[c])){c=TP.sig.SignalMap[c];}else{if(!TP.isType(f)||TP.isEmpty(c=f.getDefaultPolicy())){c=TP.sig.SignalMap.DEFAULT_FIRING;}else if(!TP.isCallable(c)&&!TP.isCallable(c=TP.sig.SignalMap[c])){c=TP.sig.SignalMap.DEFAULT_FIRING;}}}j=c(b,a,r,p,n,m,l);if(TP.sys.shouldTrackSignalStats()){u=Date.now();t=u-j.get('time');j.$set('elapsed',t);TP.sys.$statistics.$signals=TP.sys.$statistics.$signals||TP.ac();TP.sys.$statistics.$signals.push(t);if(TP.sys.$statistics.$signals.length>TP.sys.cfg('signal.stats_max')){TP.sys.$statistics.$signals.shift();}}TP.sys.fireNextSignal();return j;});TP.definePrimitive('raise',function(m,n,c,a){var h,b,e,g,i,d,j,l,f,k;if(TP.raise.$suspended){return;}e=m;if(TP.isWindow(e)){e=null;}f=TP.ifInvalid(n,'TP.sig.Exception');if(TP.isTypeName(f)){d=TP.sys.getTypeByName(f);if(TP.notValid(d)){d=TP.sig.Exception.defineSubtype(f);}}else{d=f;}l=TP.sys.shouldLogRaise();try{if(l){TP.sys.shouldLogRaise(false);if(TP.isValid(a)){g=' with payload/args: ';if(TP.isString(a.message)){g+=a.toString();}else if(TP.canInvoke(a,'asString')){g+=a.asString();}else if(TP.canInvoke(a,'toString')){g+=a.toString();}else if(TP.isString(a.nodeName)){g+=TP.nodeAsString(a);}else{try{g+=TP.str(a);}catch(a){}}}else{g='';}if(TP.isValid(e)&&TP.isCallable(e.getTypeName)&&TP.isValid(f.getSignalName)){b=TP.id(e)+' raised: '+f.getSignalName()+g;}else if(TP.isCallable(f.getSignalName)){b='Object'+TP.NULL_OID+' raised: '+f.getSignalName()+g;}if(TP.canInvoke(d,'getLevel')){k=d.getLevel();}else{k=TP.ERROR;}switch(k){case TP.TRACE:TP.trace(b,TP.LOG,c);break;case TP.INFO:TP.info(b,TP.LOG,c);break;case TP.WARN:TP.isValid(a)?TP.warn(TP.boot.$annotate(a,b),TP.LOG,c):TP.warn(b,TP.LOG,c);break;case TP.ERROR:TP.isValid(a)?TP.error(TP.boot.$annotate(a,b),TP.LOG,c):TP.error(b,TP.LOG,c);break;case TP.SEVERE:TP.isValid(a)?TP.severe(TP.boot.$annotate(a,b),TP.LOG,c):TP.severe(b,TP.LOG,c);break;case TP.FATAL:TP.isValid(a)?TP.fatal(TP.boot.$annotate(a,b),TP.LOG,c):TP.fatal(b,TP.LOG,c);break;case TP.SYSTEM:TP.system(b,TP.LOG,c);break;default:TP.isValid(a)?TP.error(TP.boot.$annotate(a,b),TP.LOG,c):TP.error(b,TP.LOG,c);break;}}}catch(a){}finally{TP.sys.shouldLogRaise(l);}if(TP.sys.shouldRegisterLoggers()){if(TP.isValid(e)){TP.sys.registerObject(e,null,true);}}if(TP.isSubtypeOf(d,TP.sig.Exception)){i=d.getSupertypes();}else{d=TP.sig.Exception;i=TP.ac();}j=TP.ac();j.push(d);for(h=0;h<i.getSize();h++){j.push(i.at(h));if(i.at(h)===TP.sig.Exception){break;}}$handled=false;TP.signal(e,j,c,a,TP.EXCEPTION_FIRING);if(TP.sys.shouldThrowExceptions()&&!$handled){if(d.getSignalName()!=='AssertionFailed'){$handled=true;throw new Error(d.getSignalName());}}return;});TP.lang.Object.defineSubtype('core:SignalSource');TP.core.SignalSource.defineSubtype('core:MutationSignalSource');TP.core.MutationSignalSource.Type.defineAttribute('observers');TP.core.MutationSignalSource.Type.defineMethod('initialize',function(){this.set('observers',TP.hc());return;});TP.core.MutationSignalSource.Type.defineMethod('addObserverFor',function(b){var a;if(TP.notValid(self.MutationObserver)){return this;}a=new MutationObserver(function(b){var c,a;c=b.length;for(a=0;a<c;a++){this.handleMutationEvent(b.at(a));}}.bind(this));a.observe(b,{childList:true,subtree:true,attributes:false,attributeOldValue:false});this.get('observers').atPut(TP.id(b),a);return this;});TP.core.MutationSignalSource.Type.defineMethod('removeObserverFor',function(c){var a,b;a=TP.id(c);if(TP.isValid(b=this.get('observers').at(a))){b.disconnect();}this.get('observers').removeKey(a);return this;});TP.core.MutationSignalSource.Type.defineMethod('handleMutationEvent',function(d){var a,c,j,b,e,g,m,f,k,h,i,n,l;if(!TP.isElement(a=d.target)){}if(!TP.isType(c=TP.wrap(a).getType())){return this;}j=d.type;switch(j){case'attributes':b='handlePeerTP_sig_DOMAttrChanged';if(TP.canInvoke(c,b)){e=d.attributeName;g=d.oldValue;m=TP.elementGetAttribute(a,e,true);if(TP.notValid(g)&&TP.elementHasAttribute(a,e,true)){f=TP.CREATE;}else if(!TP.elementHasAttribute(a,e,true)){f=TP.DELETE;}else{f=TP.UPDATE;}k=TP.hc('attrName',d.attributeName,'newValue',m,'prevValue',g,'operation',f);c[b](a,k);}break;case'childList':if(TP.notEmpty(h=TP.ac(d.addedNodes))){b='handlePeerTP_sig_DOMNodesAdded';if(TP.canInvoke(c,b)){c[b](a,h);}}if(TP.notEmpty(i=TP.ac(d.removedNodes))){b='handlePeerTP_sig_DOMNodesRemoved';if(TP.canInvoke(c,b)){c[b](a,i);}}if(TP.notEmpty(n=this.get('queries'))){l=TP.nodeGetDocument(a);n.perform(function(a){this.executeSubtreeQueryAndDispatch(a,h,i,l);}.bind(this));}break;}return this;});TP.core.MutationSignalSource.Type.defineMethod('executeSubtreeQueryAndDispatch',function(b,j,i,k){var h,f,a,e,d,g,c;if(TP.isEmpty(f=b.at('query'))||!f.isAccessPath()){return this;}if(TP.isEmpty(a=b.at('target'))){return this;}if(!TP.isElement(h=b.at('root'))){h=k;}e=b.atIfInvalid('addMethod','handlePeerTP_sig_AddFilteredNodes');d=b.atIfInvalid('removeMethod','handlePeerTP_sig_RemoveFilteredNodes');g=f.executeGet(a);if(TP.notEmpty(j)){c=g.intersection(j);if(TP.canInvoke(a,e)){a[e](a,c);}}if(TP.notEmpty(i)){c=g.intersection(i);if(TP.canInvoke(a,d)){a[d](a,c);}}return this;});TP.core.SignalSource.defineSubtype('core:URISignalSource');TP.core.URISignalSource.Inst.defineAttribute('uri');TP.core.URISignalSource.Inst.defineMethod('init',function(b){var a;this.callNextMethod();if(!TP.isURI(a=TP.uc(b))){this.raise('TP.sig.InvalidURI',arguments);return null;}this.set('uri',a);return this;});TP.core.URISignalSource.defineSubtype('core:SSESignalSource');TP.core.URISignalSource.Inst.defineAttribute('$eventSource');TP.core.URISignalSource.Inst.defineAttribute('$customEventHandlers');TP.core.URISignalSource.Inst.defineAttribute('observerCount');TP.core.SSESignalSource.Inst.defineMethod('init',function(a){this.callNextMethod();this.set('$customEventHandlers',TP.hc());return this;});TP.core.SSESignalSource.Inst.defineMethod('addObserver',function(d,c,e,f){var b,a;if(TP.notValid(d)||TP.notValid(c)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.notValid(b=this.get('observerCount'))){b=1;}else{b+=1;}this.set('observerCount',b);if(b>0&&!this.connectionIsOpen()){if(!this.openConnection()){return false;}}if(!TP.isArray(a=c)){a=TP.ac(c);}a=a.collect(function(b){var a,c;a=TP.isType(b)?b:TP.sys.getTypeByName(b);if(TP.notValid(c=a.getSubtypes())){return a;}return TP.ac(a,c);});a=a.flatten();this.setupCustomHandlers(a);return true;});TP.core.SSESignalSource.Inst.defineMethod('closeConnection',function(){var a;if(TP.notValid(a=this.get('$eventSource'))){this.raise('TP.sig.InvalidSource',arguments);return false;}a.close();this.signal('TP.sig.SourceClosed',arguments);this.set('$eventSource',null);this.get('$customEventHandlers').empty();return true;});TP.core.SSESignalSource.Inst.defineMethod('connectionIsOpen',function(){return TP.isValid(this.get('$eventSource'));});TP.core.SSESignalSource.Inst.defineMethod('openConnection',function(){var b,a;if(this.connectionIsOpen()){this.get('$eventSource').close();}if(!TP.isURI(b=this.get('uri'))){this.raise('TP.sig.InvalidURI',arguments);return false;}try{a=new EventSource(b.asString());}catch(a){this.raise('TP.sig.InvalidSource',arguments);return false;}if(TP.isValid(a)){this.set('$eventSource',a);this.setupStandardHandlers();}return true;});TP.core.SSESignalSource.Inst.defineMethod('removeObserver',function(d,c,e,f){var b,a;if(TP.notValid(d)||TP.notValid(c)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.notValid(b=this.get('observerCount'))){b=0;}else{b-=1;}this.set('observerCount',b);if(!TP.isArray(a=c)){a=TP.ac(c);}a=a.collect(function(b){var a,c;a=TP.isType(b)?b:TP.sys.getTypeByName(b);if(TP.notValid(c=a.getSubtypes())){return a;}return TP.ac(a,c);});a=a.flatten();this.teardownCustomHandlers(a);if(b===0&&this.connectionIsOpen()){this.closeConnection();}return true;});TP.core.SSESignalSource.Inst.defineMethod('setupCustomHandlers',function(d){var b,c,a;if(TP.notValid(b=this.get('$eventSource'))){this.raise('TP.sig.InvalidSource',arguments);return this;}c=this;a=this.get('$customEventHandlers');d.perform(function(f){var d,g,e;if(TP.notEmpty(d=f.NATIVE_NAME)){if(a.hasKey(d)){return;}g=f.getSignalName();e=function(a){var b;b=TP.hc('origin',a.origin,'data',a.data,'lastEventId',a.lastEventId,'source',a.source);c.signal(g,arguments,b);return;};a.atPut(d,e);b.addEventListener(d,e,false);}});return this;});TP.core.SSESignalSource.Inst.defineMethod('setupStandardHandlers',function(){var a;if(TP.notValid(a=this.get('$eventSource'))){this.raise('TP.sig.InvalidSource',arguments);return this;}a.addEventListener('open',function(c){var b;b=TP.hc('url',a.url,'withCredentials',a.withCredentials,'readyState',a.readyState);this.signal('TP.sig.SourceOpen',arguments,b);return;}.bind(this),false);a.addEventListener('message',function(a){var b;b=TP.hc('origin',a.origin,'data',a.data,'lastEventId',a.lastEventId,'source',a.source);this.signal('TP.sig.SourceDataReceived',arguments,b);return;}.bind(this),false);a.addEventListener('error',function(c){var b;if(a.readyState===EventSource.CLOSED){this.signal('TP.sig.SourceClosed',arguments);return;}if(a.readyState===EventSource.CONNECTING){this.signal('TP.sig.SourceReconnecting',arguments);return;}b=TP.hc('url',a.url,'withCredentials',a.withCredentials,'readyState',a.readyState);this.signal('TP.sig.SourceError',arguments,b);return;}.bind(this),false);return this;});TP.core.SSESignalSource.Inst.defineMethod('teardownCustomHandlers',function(c){var b,a;if(TP.notValid(b=this.get('$eventSource'))){this.raise('TP.sig.InvalidSource',arguments);return this;}a=this.get('$customEventHandlers');c.perform(function(d){var c,f,e;if(TP.notEmpty(c=d.NATIVE_NAME)){f=d.getSignalName();if(TP.isCallable(e=a.atPut(c))){a.removeKey(c);b.removeEventListener(c,e,false);}}});return this;});TP.sig.Signal.defineSubtype('SourceSignal');TP.sig.SourceSignal.Type.defineAttribute('defaultPolicy',TP.INHERITANCE_FIRING);TP.sig.SourceSignal.defineSubtype('SourceOpen');TP.sig.SourceSignal.defineSubtype('SourceDataReceived');TP.sig.SourceSignal.defineSubtype('SourceClosed');TP.sig.SourceSignal.defineSubtype('SourceReconnecting');TP.sig.SourceSignal.defineSubtype('SourceError');TP.lang.Object.Inst.defineMethod('isResponderFor',function(a,b){return false;});TP.lang.Object.Inst.defineMethod('getNextResponder',function(a,b){return null;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETJobControl.js';
TP.lang.Object.defineSubtype('core:JobStatus');TP.core.JobStatus.isAbstract(true);TP.core.JobStatus.Inst.defineAttribute('result');TP.core.JobStatus.Inst.defineAttribute('faultCode');TP.core.JobStatus.Inst.defineAttribute('faultText');TP.core.JobStatus.Inst.defineAttribute('statusCode');TP.core.JobStatus.Inst.defineAttribute('statusText');TP.core.JobStatus.Inst.defineMethod('checkFaultArguments',function(b,c){var a;a=TP.hc();if(TP.isError(b)){a.atPut('code',TP.ERRORED);if(TP.isEmpty(c)){a.atPut('text',b.message);}else{a.atPut('text',c);}}else if(TP.isNumber(b)){a.atPut('code',b);a.atPut('text',c);}else if(TP.isString(b)){if(TP.isEmpty(c)){a.atPut('code',TP.FAILED);a.atPut('text',b);}else{a.atPut('code',b);a.atPut('text',c);}}else{a.atPut('code',TP.ifInvalid(b,TP.FAILED));}return a;});TP.core.JobStatus.Inst.defineMethod('didCancel',function(){return this.get('statusCode')===TP.CANCELLED;});TP.core.JobStatus.Inst.defineMethod('didComplete',function(){var a;a=this.get('statusCode');switch(a){case TP.CANCELLED:case TP.ERRORED:case TP.FAILED:case TP.SUCCEEDED:case TP.COMPLETED:return true;default:return false;}});TP.core.JobStatus.Inst.defineMethod('didError',function(){return this.get('statusCode')===TP.ERRORED;});TP.core.JobStatus.Inst.defineMethod('didFail',function(){return this.get('statusCode')===TP.FAILED;});TP.core.JobStatus.Inst.defineMethod('didSkip',function(){return this.get('faultCode')===TP.SKIPPED;});TP.core.JobStatus.Inst.defineMethod('didSucceed',function(){var a;a=this.get('statusCode');return a===TP.SUCCEEDED||a===TP.COMPLETED;});TP.core.JobStatus.Inst.defineMethod('didTimeOut',function(){return this.get('faultCode')===TP.TIMED_OUT;});TP.core.JobStatus.Inst.defineMethod('isActive',function(a){if(TP.isBoolean(a)){this.set('statusCode',a?TP.ACTIVE:TP.READY);}return this.get('statusCode')===TP.ACTIVE;});TP.core.JobStatus.Inst.defineMethod('isCancelling',function(){return this.get('statusCode')===TP.CANCELLING;});TP.core.JobStatus.Inst.defineMethod('isCompleting',function(){var a;a=this.get('statusCode');switch(a){case TP.ERRORING:case TP.FAILING:case TP.CANCELLING:case TP.COMPLETING:return true;default:return false;}});TP.core.JobStatus.Inst.defineMethod('isCompleted',function(){return this.didComplete();});TP.core.JobStatus.Inst.defineMethod('isErroring',function(){return this.get('statusCode')===TP.ERRORING;});TP.core.JobStatus.Inst.defineMethod('isFailing',function(){return this.get('statusCode')===TP.FAILING;});TP.core.JobStatus.Inst.defineMethod('isPaused',function(a){if(TP.isBoolean(a)){this.$set('statusCode',a?TP.PAUSED:TP.ACTIVE);}return this.get('statusCode')===TP.PAUSED;});TP.core.JobStatus.Inst.defineMethod('isRunnable',function(){var a;a=this.get('statusCode');switch(a){case TP.READY:case TP.ACTIVE:case TP.PAUSED:return true;default:return false;}});TP.core.JobStatus.Inst.defineMethod('cancel',function(d,e){var a,b,c;if(this.isCompleting()||this.didComplete()){return this;}this.set('result',undefined);this.set('statusCode',TP.CANCELLING);a=this.checkFaultArguments(d,e);b=a.at('code');c=a.at('text');this.set('faultCode',b);this.set('faultText',c);try{this.cancelJob(b,c);}catch(a){TP.ifError()?TP.error(TP.ec(a,'Job completion error.'),TP.LOG,arguments):0;}finally{this.set('statusCode',TP.CANCELLED);}return this;});TP.core.JobStatus.Inst.defineMethod('cancelJob',function(a,b){return this;});TP.core.JobStatus.Inst.defineMethod('complete',function(a){if(this.isCompleting()||this.didComplete()){return this;}this.set('statusCode',TP.COMPLETING);if(arguments.length>0){this.set('result',a);}try{if(TP.isDefined(a)){this.completeJob(a);}else{this.completeJob();}}catch(a){TP.ifError()?TP.error(TP.ec(a,'Job completion error.'),TP.LOG,arguments):0;}finally{if(!this.isCompleted()){this.set('statusCode',TP.SUCCEEDED);}}return this;});TP.core.JobStatus.Inst.defineMethod('completeJob',function(a){return this;});TP.core.JobStatus.Inst.defineMethod('error',function(d,e){var a,b,c;if(this.isCompleting()||this.didComplete()){return this;}this.set('result',undefined);this.set('statusCode',TP.ERRORING);a=this.checkFaultArguments(d,e);b=a.at('code');c=a.at('text');this.set('faultCode',b);this.set('faultText',c);try{this.errorJob(b,c);}catch(a){TP.ifError()?TP.error(TP.ec(a,'Job completion error.'),TP.LOG,arguments):0;}finally{this.set('statusCode',TP.ERRORED);}return this;});TP.core.JobStatus.Inst.defineMethod('errorJob',function(a,b){return this;});TP.core.JobStatus.Inst.defineMethod('fail',function(d,e){var a,b,c;if(this.isCompleting()||this.didComplete()){return this;}this.set('result',undefined);this.set('statusCode',TP.FAILING);a=this.checkFaultArguments(d,e);b=a.at('code');c=a.at('text');this.set('faultCode',b);this.set('faultText',c);try{this.failJob(b,c);}catch(a){TP.ifError()?TP.error(TP.ec(a,'Job completion error.'),TP.LOG,arguments):0;}finally{this.set('statusCode',TP.FAILED);}return this;});TP.core.JobStatus.Inst.defineMethod('failJob',function(a,b){return this;});TP.core.JobStatus.Inst.defineMethod('getFaultCode',function(){if(TP.notDefined(this.faultCode)){this.getType().Inst.defineAttribute('faultCode');}return this.$get('faultCode');});TP.core.JobStatus.Inst.defineMethod('getFaultText',function(){if(TP.notDefined(this.faultText)){this.getType().Inst.defineAttribute('faultText');}return this.$get('faultText');});TP.core.JobStatus.Inst.defineMethod('getStatusCode',function(){if(TP.notDefined(this.statusCode)){this.getType().Inst.defineAttribute('statusCode',TP.READY);}return this.$get('statusCode');});TP.core.JobStatus.Inst.defineMethod('getStatusText',function(){if(TP.notDefined(this.statusText)){this.getType().Inst.defineAttribute('statusText',TP.READY);}return this.$get('statusText');});TP.core.JobStatus.Inst.defineMethod('pause',function(){this.isPaused(true);return this;});TP.core.JobStatus.Inst.defineMethod('reset',function(){this.set('statusCode',TP.READY);this.set('faultCode',null);this.set('faultText',null);return this;});TP.core.JobStatus.Inst.defineMethod('resume',function(){if(this.isPaused()){this.isPaused(false);}return this;});TP.core.JobStatus.Inst.defineMethod('start',function(a){this.isActive(true);return this;});TP.lang.Object.defineSubtype('core:Job');TP.core.Job.addTraitsFrom(TP.core.JobStatus);TP.core.Job.Type.defineConstant('CONTROL_PARAM_KEYS',TP.ac('config','pre','step','post','compute','delay','interval','lastInterval','limit','count','freeze','preserve','restore','stats','isAnimation'));TP.core.Job.Type.defineConstant('ITERATION_INDEX_COMPUTE',function(c,d){var a,b;a=d.at('values');b=c.get('iteration');return a.at(b.min(a.getSize()-1));});TP.core.Job.Type.defineConstant('PERCENTAGE_INDEX_COMPUTE',function(d,e){var b,a,c;b=d.getPercentComplete();a=e.at('values');c=(a.getSize()*b).floor();return a.at(c.min(a.getSize()-1));});TP.core.Job.Type.defineConstant('LINEAR_COMPUTE',function(d,a){var b,c;b=d.getPercentComplete();c=a.at('delta');return b*c+a.at('from');});TP.core.Job.Type.defineConstant('DOUBLE_DECAY',function(a){return a.get('maxInterval').min(a.get('lastInterval')*2);});TP.core.Job.Type.defineConstant('DOUBLE_ON_FAILURE',function(a){if(a.get('wasSuccessful')){return a.get('firstInterval');}else{return a.get('maxInterval').min(a.get('lastInterval')*2);}});TP.core.Job.Type.defineConstant('SIMPLE_DECAY',function(a){return a.get('maxInterval').min(a.get('lastInterval')+1000);});TP.core.Job.Type.defineConstant('SIMPLE_ON_FAILURE',function(a){if(a.get('wasSuccessful')){return a.get('firstInterval');}else{return a.get('maxInterval').min(a.get('lastInterval')+1000);}});TP.core.Job.Type.defineConstant('ZERO_DECAY',function(a){return a.get('lastInterval');});TP.core.Job.Type.defineConstant('ONCE',function(a){return a.get('iteration')>0;});TP.core.Job.Type.defineConstant('UNTIL_FAILURE',function(a){return TP.isFalse(a.get('wasSuccessful'));});TP.core.Job.Type.defineConstant('UNTIL_SUCCESS',function(a){return TP.isTrue(a.get('wasSuccessful'));});TP.core.Job.Type.defineConstant('FOREVER',TP.RETURN_FALSE);TP.core.Job.Type.defineConstant('LOG_STEP_PARAMS',function(a,b){return true;});TP.core.Job.Type.defineConstant('LOG_STEP_VALUE',function(a){return true;});TP.core.Job.Type.defineConstant('PUSH_STEP_VALUE',function(a){a.$steps=a.$steps||TP.ac();a.$steps.push(a.getStepValue());return true;});TP.core.Job.Type.defineAttribute('lastPID',0);TP.core.Job.Type.defineMethod('construct',function(b){var a;if(!TP.canInvoke(b,'atIfInvalid')){return this.raise('TP.sig.InvalidParameter',arguments);}a=this.callNextMethod();a.set('PID',this.getPID());return a;});TP.core.Job.Type.defineMethod('getPID',function(){var a;a=this.get('lastPID')+1;this.$set('lastPID',a);return a;});TP.core.Job.Type.defineMethod('scheduleInvokerJob',function(c,b,e){var a,d;if(!TP.isArray(c)||!TP.isArray(b)){return this.raise('TP.sig.InvalidArray',arguments);}d=TP.ifInvalid(e,TP.ac());a=function(){var b,c;if(a.methodIndex===a.methodArray.getSize()){b=a.objArray.shift();a.methodIndex=0;}else{b=a.objArray.first();}try{c=b[a.methodArray.at(a.methodIndex)].apply(b,a.paramArray);TP.ifInfo()?TP.info(c,TP.LOG,arguments):0;a.methodIndex++;}catch(b){TP.ifError()?TP.error(TP.ec(b,'Error in invocation.'),TP.LOG,arguments):0;a.stopTest=true;}};a.objArray=c.copy();a.methodArray=b;a.paramArray=d;a.methodIndex=b.getSize();a.stopTest=false;TP.schedule(TP.hc('step',a,'interval',50,'limit',function(b){if(TP.isEmpty(a.objArray)||a.stopTest){return true;}return false;}));return this;});TP.core.Job.Type.defineMethod('splitParams',function(a){var b,c;b=a.copy(TP.core.Job.CONTROL_PARAM_KEYS);c=a.copy().removeKeys(TP.core.Job.CONTROL_PARAM_KEYS);return TP.ac(b,c);});TP.core.Job.Inst.defineAttribute('PID');TP.core.Job.Inst.defineAttribute('runstart');TP.core.Job.Inst.defineAttribute('started');TP.core.Job.Inst.defineAttribute('ended');TP.core.Job.Inst.defineAttribute('expected',0);TP.core.Job.Inst.defineAttribute('lastExpected',0);TP.core.Job.Inst.defineAttribute('firstInterval',TP.sys.cfg('job.interval'));TP.core.Job.Inst.defineAttribute('lastInterval',TP.sys.cfg('job.interval'));TP.core.Job.Inst.defineAttribute('maxInterval',TP.sys.cfg('job.interval_max'));TP.core.Job.Inst.defineAttribute('lastOffset',0);TP.core.Job.Inst.defineAttribute('workOffset',0);TP.core.Job.Inst.defineAttribute('lastPaused');TP.core.Job.Inst.defineAttribute('totalPause',0);TP.core.Job.Inst.defineAttribute('count',1);TP.core.Job.Inst.defineAttribute('totalcount',1);TP.core.Job.Inst.defineAttribute('runs',1);TP.core.Job.Inst.defineAttribute('iteration',0);TP.core.Job.Inst.defineAttribute('delay',TP.sys.cfg('job.delay'));TP.core.Job.Inst.defineAttribute('$delayms');TP.core.Job.Inst.defineAttribute('limit',TP.core.Job.ONCE);TP.core.Job.Inst.defineAttribute('$limitms');TP.core.Job.Inst.defineAttribute('interval',TP.sys.cfg('job.interval'));TP.core.Job.Inst.defineAttribute('$intervalms');TP.core.Job.Inst.defineAttribute('parameters');TP.core.Job.Inst.defineAttribute('wasSuccessful',false);TP.core.Job.Inst.defineAttribute('config');TP.core.Job.Inst.defineAttribute('pre');TP.core.Job.Inst.defineAttribute('post');TP.core.Job.Inst.defineAttribute('step');TP.core.Job.Inst.defineAttribute('compute');TP.core.Job.Inst.defineAttribute('work');TP.core.Job.Inst.defineAttribute('$useHeartbeat',false);TP.core.Job.Inst.defineAttribute('$heartbeat');TP.core.Job.Inst.defineAttribute('$timer');TP.core.Job.Inst.defineAttribute('$useRAF',false);TP.core.Job.Inst.defineAttribute('$lastWork');TP.core.Job.Inst.defineAttribute('$timedWork');TP.core.Job.Inst.defineAttribute('$stats');TP.core.Job.Inst.defineAttribute('$steps');TP.core.Job.Inst.defineMethod('init',function(b){var a,c,d;this.callNextMethod();if(TP.isTrue(b.at('isAnimation'))){this.$set('$useRAF',true);}if(TP.notValid(a=b.at('delay'))){a=TP.sys.cfg('job.delay');}this.set('delay',a);if(TP.notValid(a=b.at('interval'))){a=TP.sys.cfg('job.interval');}this.set('interval',a);if(TP.notValid(a=b.at('firstInterval'))){a=TP.sys.cfg('job.interval');}this.set('firstInterval',a);this.set('lastInterval',a);if(TP.notValid(a=b.at('maxInterval'))){a=TP.sys.cfg('job.interval_max');}this.set('maxInterval',a);if(TP.notValid(a=b.at('limit'))){a=TP.core.Job.ONCE;}this.set('limit',a);this.$set('count',b.atIfInvalid('count',1),false);this.$set('totalcount',b.atIfInvalid('count',1),false);this.$set('compute',b.at('compute'),false);this.$set('pre',b.at('pre'),false);this.$set('post',b.at('post'),false);this.$set('config',b.at('config'),false);c=b.at('step');if(!TP.canInvoke(c,'apply')){c=this.$get('step');}else{this.$set('step',c,false);}this.set('work',b.at('work'));d=this;this.$timedWork=function(){d.$work();};return this;});TP.core.Job.Inst.defineMethod('$clearScheduler',function(){try{try{if(TP.isValid(this.$heartbeat)){clearInterval(this.$heartbeat);}}catch(a){}if(TP.isValid(this.$timer)){if(this.$get('$useRAF')){window.cancelAnimFrame(this.$timer);}else{clearTimeout(this.$timer);}}}catch(a){}finally{this.$heartbeat=null;this.$timer=null;}return;});TP.core.Job.Inst.defineMethod('$getEqualityValue',function(){return this.getPID();});TP.core.Job.Inst.defineMethod('complete',function(b){var a;if((a=this.$get('runs'))<this.$get('totalcount')){this.$teardown();this.$set('runs',a+1);this.$startrun();}else{this.$clearScheduler();this.$set('ended',Date.now());this.$teardown();TP.ifTrace(TP.sys.shouldLogJobs())?TP.sys.logJob('Job '+this.getPID()+' completed at '+TP.dc(this.$get('ended')).asTimestamp(),TP.TRACE,arguments):0;if(!this.isCompleted()){this.set('statusCode',TP.SUCCEEDED);}TP.sys.removeJob(this);}return this;});TP.core.Job.Inst.defineMethod('getActiveTime',function(){var a,b;if(TP.notValid(a=this.runstart)){return 0;}a=a+TP.ifInvalid(this.$delayms,0);if(TP.notValid(b=this.ended)){b=Date.now();}return b-a-this.totalPause;});TP.core.Job.Inst.defineMethod('getElapsedTime',function(){var b,a;if(TP.notValid(b=this.runstart)){return 0;}if(TP.notValid(a=this.ended)){a=Date.now();}return a-b;});TP.core.Job.Inst.defineMethod('getPauseTime',function(){return this.totalPause;});TP.core.Job.Inst.defineMethod('getPercentComplete',function(){var b,a;b=typeof this.limit;switch(b){case'string':a=this.getActiveTime()/this.$limitms;break;case'number':a=this.iteration/this.limit;break;case'function':default:return null;}return a.max(0).min(1).round(3);});TP.core.Job.Inst.defineMethod('getPID',function(){return this.PID;});TP.core.Job.Inst.defineMethod('getProjectedTime',function(){var a;if(TP.isNumber(this.$limitms)){return this.$limitms;}a=typeof this.limit;switch(a){case'number':return this.limit*(this.lastOffset+this.$intervalms);default:break;}return;});TP.core.Job.Inst.defineMethod('getStepValue',function(b){var a;try{if(TP.isCallable(this.compute)){a=this.compute(this,TP.isValid(b)?b:this.parameters);if(TP.isArray(this.$steps)){this.$steps.push(a);}}}catch(a){this.raise('TP.sig.JobException',arguments,TP.ec(a,'Error in compute function'));}return a;});TP.core.Job.Inst.defineMethod('isLimited',function(){var b,a,c;a=this.limit;b=typeof a;switch(b){case'number':return this.iteration+1>=a;case'string':c=this.getActiveTime();return c>=this.$limitms;case'function':return a(this,this.parameters);default:return false;}});TP.core.Job.Inst.defineMethod('kill',function(a){this.$clearScheduler();this.$set('ended',Date.now());if(TP.notTrue(a)){TP.ifTrace(TP.sys.shouldLogJobs())?TP.sys.logJob('Job '+this.getPID()+' killed at '+TP.dc(this.$get('ended')).asTimestamp(),TP.TRACE,arguments):0;}this.cancel();TP.sys.removeJob(this);return this;});TP.core.Job.Inst.defineMethod('pause',function(){this.$clearScheduler();this.$set('lastPaused',Date.now());this.isActive(false);this.isPaused(true);return this;});TP.core.Job.Inst.defineMethod('resume',function(){this.$set('totalPause',this.$get('totalPause')+(Date.now()-this.$get('lastPaused')));this.isPaused(false);this.isActive(true);this.$iterate();return this;});TP.core.Job.Inst.defineMethod('schedule',function(){var c,a,b;if(this.isPaused()){return this;}if(this.isLimited()){this.complete();return this;}this.isActive(true);a=this.$get('delay');c=typeof a;switch(c){case'string':a=this.$delayms;break;case'number':a=this.$delayms;break;case'function':a=a(this,this.$get('parameters'));break;default:a=0;break;}if(TP.isNumber(a)&&a>0){if(this.$get('$useRAF')){b=window.requestAnimFrame(this.$timedWork);}else{b=setTimeout(this.$timedWork,a);}this.$set('$timer',b);this.$set('expected',a);return this;}return this.$work();});TP.core.Job.Inst.defineMethod('setDelay',function(a){var b;this.$set('delay',a);b=typeof a;switch(b){case'string':if(TP.isNaN(this.$delayms=parseFloat(a))){this.$delayms=Date.getMillisecondsInDuration(a);}break;case'number':this.$delayms=a;break;case'function':this.$delayms=null;break;default:this.$delayms=0;break;}return this;});TP.core.Job.Inst.defineMethod('setInterval',function(a){var b;this.$set('interval',a);b=typeof a;switch(b){case'string':if(TP.isNaN(this.$intervalms=parseFloat(a))){this.$intervalms=Date.getMillisecondsInDuration(a);}break;case'number':this.$intervalms=a;break;case'function':this.$intervalms=null;break;default:this.$intervalms=0;break;}if(TP.isNumber(this.$intervalms)&&TP.notTrue(this.$get('$useRAF'))){this.$useHeartbeat=this.$intervalms<TP.sys.cfg('job.heartbeat_threshold');}return this;});TP.core.Job.Inst.defineMethod('setLimit',function(a){var b;this.$set('limit',a);b=typeof a;switch(b){case'string':if(TP.isNaN(this.$limitms=parseFloat(a))){this.$limitms=Date.getMillisecondsInDuration(a);}break;case'number':this.$limitms=null;break;case'function':this.$limitms=null;break;default:this.$limitms=null;break;}return this;});TP.core.Job.Inst.defineMethod('setWork',function(c){var b,a;if(TP.notValid(b=c)){a=this.$get('step');b=function(b,c){TP.isCallable(a)?b.wasSuccessful=a(b,c):b.wasSuccessful=a.apply(null,arguments);return b.wasSuccessful;};b.$realFunc=a;}this.$set('work',b);});TP.core.Job.Inst.defineMethod('restart',function(){this.$clearScheduler();this.$teardown();this.$startrun();return this;});TP.core.Job.Inst.defineMethod('shutdown',function(a){TP.ifTrace(TP.sys.shouldLogJobs())?TP.sys.logJob('Job '+this.getPID()+' shutdown requested at '+TP.dc().asTimestamp(),TP.TRACE,arguments):0;if(a){this.$clearScheduler();this.$set('ended',Date.now());this.$teardown();}else{this.$set('totalcount',this.$get('runs'));}return this;});TP.core.Job.Inst.defineMethod('start',function(a){TP.sys.addJob(this);if(TP.isValid(a)){this.$set('parameters',a,false);}this.$configure();this.$setup();this.$set('started',Date.now());this.$set('runstart',this.started);TP.ifTrace(TP.sys.shouldLogJobs())?TP.sys.logJob('Job '+this.getPID()+' started at '+TP.dc(this.$get('started')).asTimestamp(),TP.TRACE,arguments):0;return this.schedule();});TP.core.Job.Inst.defineMethod('$configure',function(){var a;this.$$updateTimingFromStepParameters();a=this.$get('config');if(TP.canInvoke(a,'apply')){try{TP.isCallable(a)?a(this,this.$get('parameters')):a.apply(null,TP.ac(this,this.$get('parameters')));}catch(a){TP.ifError()?TP.error(TP.ec(a,TP.join('Job ',this.getPID(),' configuration failed.')),TP.JOB_LOG,arguments):0;}}this.$$updateMissingParamsAndState();return this;});TP.core.Job.Inst.defineMethod('$iterate',function(){var a,b,d,e,f,g,c,h,i;if(this.isPaused()){return this;}if(this.isLimited()){this.complete();return this;}if(this.$useHeartbeat){if(TP.notValid(this.$heartbeat)){this.$heartbeat=setInterval(this.$timedWork,TP.sys.cfg('job.heartbeat_interval'));}else{}return this;}a=this.interval;switch(typeof a){case'function':a=a(this,this.parameters);if(!TP.isNumber(a)){a=this.lastInterval;}break;case'number':case'string':a=this.$intervalms;break;default:this.complete();return this;}this.lastInterval=a;this.lastExpected=this.expected;b=this.expected;d=this.totalPause;this.expected=b+a;e=Date.now();f=this.runstart;g=e-(f+d);c=g-b;this.lastOffset=c;h=((a-c)/10).round()*10;if(TP.isArray(this.$stats)){this.$stats.push(TP.join('rs: ',f,' pa: ',d,' nw: ',e,' el: ',g,' ex: ',b,' of: ',c,' int: ',a,' nx: ',h));}if(this.$get('$useRAF')){i=window.requestAnimFrame(this.$timedWork);}else{i=setTimeout(this.$timedWork,h);}this.$set('$timer',i);return this;});TP.core.Job.Inst.defineMethod('reset',function(){this.$clearScheduler();this.$set('parameters',null,false);this.$set('runstart',null,false);this.$set('started',null,false);this.$set('ended',null,false);this.$set('expected',0,false);this.$set('lastExpected',0,false);this.$set('lastInterval',this.$get('firstInterval'),false);this.$set('lastOffset',0,false);this.$set('workOffset',0,false);this.$set('lastPaused',null);this.$set('totalPause',0,false);this.$set('totalcount',this.$get('count'),false);this.$set('runs',1,false);this.$set('iteration',0,false);this.$set('wasSuccessful',false,false);this.$heartbeat=null;this.$lastWork=null;this.$timer=null;this.$stats=null;this.$steps=null;this.$set('statusCode',TP.READY,false);return this;});TP.core.Job.Inst.defineMethod('$startrun',function(){var b,c,a;b=this.$get('parameters');c=this.$get('runs');this.reset();this.$set('parameters',b,false);this.$set('runs',c,false);this.$setup();a=Date.now();this.$set('runstart',a,false);TP.ifTrace(TP.sys.shouldLogJobs())?TP.sys.logJob('Job '+this.getPID()+' re-started at '+TP.dc(a).asTimestamp(),TP.TRACE,arguments):0;return this.schedule();});TP.core.Job.Inst.defineMethod('$setup',function(){var a;a=this.$get('pre');if(TP.canInvoke(a,'apply')){try{TP.isCallable(a)?a(this,this.$get('parameters')):a.apply(null,TP.ac(this,this.$get('parameters')));}catch(a){TP.ifError()?TP.error(TP.ec(a,TP.join('Job ',this.getPID(),' pre-processing failed.')),TP.JOB_LOG,arguments):0;}}return this;});TP.core.Job.Inst.defineMethod('$teardown',function(){var a;a=this.$get('post');if(TP.canInvoke(a,'apply')){try{TP.isCallable(a)?a(this,this.$get('parameters')):a.apply(null,TP.ac(this,this.$get('parameters')));}catch(a){TP.ifError()?TP.error(TP.ec(a,TP.join('Job ',this.getPID(),' pos-processing failed.')),TP.JOB_LOG,arguments):0;}}return this;});TP.core.Job.Inst.defineMethod('$$updateMissingParamsAndState',function(){var a,c,d,e,b;if(TP.notValid(a=this.$get('parameters'))){return this;}if(TP.isTrue(a.at('stats'))||!TP.isFalse(a.at('stats'))&&TP.sys.shouldTrackJobStats()){this.$stats=TP.ac();this.$steps=TP.ac();}else{this.$stats=null;this.$steps=null;}c=a.at('from');d=a.at('to');if(TP.isNumber(c)||TP.isNumber(d)||TP.isValid(a.at('by'))){if(TP.isNumber(c)&&TP.isNumber(d)){a.atPut('delta',d-c);}if(!TP.isCallable(this.$get('compute'))){this.$set('compute',TP.core.Job.LINEAR_COMPUTE,false);}}else if(TP.isArray(e=a.at('values'))){b=this.$get('limit');if(TP.notValid(b)){b=e.getSize();this.$set('limit',b,false);}if(TP.isNumber(b)){if(!TP.isCallable(this.$get('compute'))){this.$set('compute',TP.core.Job.ITERATION_INDEX_COMPUTE,false);}}else if(TP.isString(b)){if(!TP.isCallable(this.$get('compute'))){this.$set('compute',TP.core.Job.PERCENTAGE_INDEX_COMPUTE,false);}}else{}}return this;});TP.core.Job.Inst.defineMethod('$$updateTimingFromStepParameters',function(){var b,a;if(TP.notValid(b=this.$get('parameters'))){return this;}if(TP.isValid(a=b.at('delay'))){this.set('delay',a);}if(TP.isValid(a=b.at('firstInterval'))){this.set('firstInterval',a);this.set('lastInterval',a);}if(TP.isValid(a=b.at('maxInterval'))){this.set('maxInterval',a);}if(TP.isValid(a=b.at('interval'))){this.set('interval',a);}if(TP.isValid(a=b.at('limit'))){this.set('limit',a);}if(TP.isValid(a=b.at('count'))){this.set('count',a);this.set('totalcount',a);}return this;});TP.core.Job.Inst.defineMethod('$work',function(){var a,b,c;a=this.work;if(this.isPaused()){return this;}if(this.$useHeartbeat&&TP.isValid(this.$lastWork)){b=Date.now()-this.$lastWork;if(b+TP.sys.cfg('job.heartbeat_interval')/2<this.$intervalms){return this;}}try{this.$lastWork=Date.now();TP.isCallable(a)?this.wasSuccessful=a(this,this.parameters):this.wasSuccessful=a.apply(null,TP.ac(this,this.parameters));if(TP.isFalse(this.wasSuccessful)&&TP.isValid(this.parameters)&&TP.isTrue(this.parameters.at('warn'))){TP.ifWarn()?TP.warn(TP.join('Job ',this.getPID(),' step ',this.iteration,' was unsuccessful.'),TP.JOB_LOG,arguments):0;}}catch(a){this.wasSuccessful=false;TP.ifError()?TP.error(TP.ec(a,TP.join('Job ',this.getPID(),' step-processing error.')),TP.JOB_LOG,arguments):0;this.$clearScheduler();this.fail(TP.FAILED,TP.str(a));TP.ifError()?TP.error(TP.ec(a,TP.join('Job ',this.getPID(),' failed. ','Job remains available in job list.')),TP.JOB_LOG,arguments):0;c=true;}finally{if(c){return this;}this.iteration++;if(this.isLimited()){this.complete();return this;}if(this.$useHeartbeat){if(TP.notValid(this.$heartbeat)){this.$heartbeat=setInterval(this.$timedWork,TP.sys.cfg('job.heartbeat_interval'));}else{}}else{this.$iterate();}}return this;});TP.sys.defineAttribute('$jobs');TP.sys.defineMethod('addJob',function(a){this.getJobs().add(a);return this;});TP.sys.defineMethod('getJob',function(b){var a;a=this.get('$jobs');return a.detect(function(a){return a.getPID()===b;});});TP.sys.defineMethod('getJobs',function(){if(TP.notValid(this.$get('$jobs'))){this.$set('$jobs',TP.ac());}return this.$get('$jobs');});TP.sys.defineMethod('removeJob',function(a){this.getJobs().remove(a);return this;});TP.definePrimitive('job',function(a){return TP.sys.getJob(a);});TP.definePrimitive('kill',function(a){var b;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.canInvoke(a,'kill')){return a.kill();}if(TP.isValid(b=TP.sys.getJob(a))){b.kill();}return b;});TP.definePrimitive('schedule',function(b,c){var a;a=TP.core.Job.construct(b);if(TP.notValid(a)){return;}a.start(c);return a;});TP.lang.Object.defineSubtype('core:JobGroup');TP.core.JobGroup.addTraitsFrom(TP.core.JobStatus);TP.core.JobGroup.Inst.defineAttribute('children');TP.core.JobGroup.Inst.defineMethod('$performOverChildren',function(d,e){var b,c,a;b=this.get('children');c=b.getSize();for(a=0;a<c;a++){b[a][d](e);}return this;});TP.core.JobGroup.Inst.defineMethod('addChild',function(b){var a;a=this.getChildren();a.add(b);return this;});TP.core.JobGroup.Inst.defineMethod('cancel',function(a,b){this.$performOverChildren('cancel',a,b);if(TP.isValid(a)){this.set('faultCode',a);}if(TP.isString(b)){this.set('faultText',b);}this.set('statusCode',TP.CANCELLED);return this;});TP.core.JobGroup.Inst.defineMethod('complete',function(a){this.$performOverChildren('complete',a);if(!this.isCompleted()){this.set('statusCode',TP.SUCCEEDED);}return this;});TP.core.JobGroup.Inst.defineMethod('fail',function(a,b){this.$performOverChildren('fail',a,b);if(TP.isValid(a)){this.set('faultCode',a);}if(TP.isString(b)){this.set('faultText',b);}this.set('statusCode',TP.FAILED);return this;});TP.core.JobGroup.Inst.defineMethod('getChildren',function(){var a;if(TP.notValid(a=this.$get('children'))){a=TP.ac();this.$set('children',a,false);}return a;});TP.core.JobGroup.Inst.defineMethod('pause',function(){return this.$performOverChildren('pause');});TP.core.JobGroup.Inst.defineMethod('removeChild',function(b){var a;a=this.getChildren();a.remove(b,TP.IDENTITY);return this;});TP.core.JobGroup.Inst.defineMethod('reset',function(){return this.$performOverChildren('reset');});TP.core.JobGroup.Inst.defineMethod('resume',function(){return this.$performOverChildren('resume');});TP.core.JobGroup.Inst.defineMethod('start',function(a){return this.$performOverChildren('start',a);});TP.core.JobGroup.Inst.defineMethod('shutdown',function(a){return this.$performOverChildren('shutdown',a);});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETSyncControl.js';
TP.lang.Object.defineSubtype('core:SyncAsync');TP.core.SyncAsync.isAbstract(true);TP.core.SyncAsync.Type.defineConstant('SYNCHRONOUS',0);TP.core.SyncAsync.Type.defineConstant('ASYNCHRONOUS',1);TP.core.SyncAsync.Type.defineConstant('DUAL_MODE',2);TP.core.SyncAsync.Type.defineConstant('MODES',TP.ac(TP.core.SyncAsync.SYNCHRONOUS,TP.core.SyncAsync.ASYNCHRONOUS,TP.core.SyncAsync.DUAL_MODE));TP.core.SyncAsync.Type.defineAttribute('supportedModes',TP.core.SyncAsync.DUAL_MODE);TP.core.SyncAsync.Type.defineAttribute('mode',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.SyncAsync.Type.defineMethod('isAsyncOnly',function(){return this.$get('supportedModes')===TP.core.SyncAsync.ASYNCHRONOUS;});TP.core.SyncAsync.Type.defineMethod('isDualMode',function(){return this.$get('supportedModes')===TP.core.SyncAsync.DUAL_MODE;});TP.core.SyncAsync.Type.defineMethod('isSyncOnly',function(){return this.$get('supportedModes')===TP.core.SyncAsync.SYNCHRONOUS;});TP.core.SyncAsync.Type.defineMethod('setMode',function(a){var b;if(!TP.core.SyncAsync.MODES.containsString(a)){return this.raise('TP.sig.InvalidProcessMode',arguments);}if((b=this.get('supportedModes'))!==TP.core.SyncAsync.DUAL_MODE){if(a!==b){return this.raise('TP.sig.InvalidProcessMode',arguments);}}return this.$set('mode',a);});TP.core.SyncAsync.Inst.defineAttribute('mode');TP.core.SyncAsync.Inst.defineMethod('getMode',function(){return TP.ifInvalid(this.$get('mode'),this.getType().get('mode'));});TP.core.SyncAsync.Inst.defineMethod('isSynchronous',function(){return!this.getType().isAsyncOnly();});TP.core.SyncAsync.Inst.defineMethod('rewriteRequestMode',function(b){var e,a,c,d;a=TP.ifKeyInvalid(b,'async',null);d=TP.ifKeyInvalid(b,'refresh',null);c=TP.ifKeyInvalid(b,'uri',TP.str(TP.uri(this)));if(TP.notValid(a)){if(!d){return false;}e=this.getMode();switch(e){case TP.core.SyncAsync.SYNCHRONOUS:a=false;break;case TP.core.SyncAsync.ASYNCHRONOUS:a=true;break;default:a=false;break;}}if(this.getType().isDualMode()){return a;}if(a&&this.getType().isSyncOnly()){TP.ifWarn()?TP.warn('Overriding async request for sync-only URI: '+c,TP.LOG,arguments):0;a=false;}if(!a&&this.getType().isAsyncOnly()){if(!d){return false;}TP.ifWarn()?TP.warn('Overriding sync request for async-only URI: '+c,TP.LOG,arguments):0;a=true;}return a;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETProxyTypes.js';
TP.lang.Object.defineSubtype('Proxy');TP.lang.Proxy.Inst.defineMethod('$$fault',function(){var a,b;a=''+this;TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.trace('Faulting in \''+a+'\'.',TP.LOG,arguments):0;b=TP.sys.require(a,null,true);if(!TP.isType(b)){TP.ifError()?TP.error('Faulting in \''+a+'\' failed. Removing proxy.',TP.LOG,arguments):0;TP.sys.defineGlobal(a,null,true);}return b;});TP.lang.Proxy.Inst.defineMethod('$$isMemberOf',function(a){return a==='TP.lang.Proxy'||a===TP.lang.Proxy||a==='String'||a===String;});TP.lang.Proxy.Inst.defineMethod('defineSubtype',function(b){var a;a=this.$$fault();if(TP.isType(a)){return a.defineSubtype(b);}return this.getType().construct(b);});TP.lang.Proxy.Inst.defineMethod('asSource',function(){return this.quoted('"')+'.asType();';});TP.lang.Proxy.Inst.defineMethod('canConstruct',function(){var a;a=this.$$fault();if(TP.isType(a)){return a.canConstruct.apply(a,arguments);}return false;});TP.lang.Proxy.Inst.defineMethod('canResolveDNU',function(a,b,c,d){return true;});TP.lang.Proxy.Inst.defineMethod('construct',function(){var a;try{a=this.$$fault();}catch(a){}if(TP.isType(a)){return a.construct.apply(a,arguments);}return;});TP.lang.Proxy.Inst.defineMethod('from',function(){var a;try{a=this.$$fault();}catch(a){}if(TP.isType(a)){return a.from.apply(a,arguments);}return;});TP.lang.Proxy.Inst.defineMethod('init',function(c){var a,b;this.callNextMethod();if(TP.isType(a=TP.sys.getTypeByName(c,false))){return a;}a=new String(c);b=TP.lang.Proxy.getInstPrototype();a.$$fault=b.$$fault;a.$$isMemberOf=b.$$isMemberOf;a.defineSubtype=b.defineSubtype;a.canConstruct=b.canConstruct;a.canResolveDNU=b.canResolveDNU;a.construct=b.construct;a.from=b.from;a.isInitialized=b.isInitialized;a.resolveDNU=b.resolveDNU;a.asSource=b.asSource;TP.sys.addCustomType(c,a);TP.sys.defineGlobal(c,a,true);return a;});TP.lang.Proxy.Inst.defineMethod('isInitialized',function(){return true;});TP.lang.Proxy.Inst.defineMethod('resolveDNU',function(b,c,d,e){var a;a=this.$$fault();if(TP.isType(a)){return a.resolveDNU(b,c,d,e);}return;});TP.sys.defineMethod('initializeTypeProxies',function(){var b,e,f,d,c,a;b=TP.lang.Proxy.getInstPrototype();e=TP.sys.getCustomTypeNames();f=e.getSize();for(d=0;d<f;d++){try{c=e.at(d);if(TP.notValid(a=TP.sys.getTypeByName(c,false))){a=new String(c);a.$$fault=b.$$fault;a.$$isMemberOf=b.$$isMemberOf;a.defineSubtype=b.defineSubtype;a.canConstruct=b.canConstruct;a.canResolveDNU=b.canResolveDNU;a.construct=b.construct;a.from=b.from;a.isInitialized=b.isInitialized;a.resolveDNU=b.resolveDNU;TP.sys.addCustomType(c,a);TP.sys.defineGlobal(c,a,true);TP.sys.defineGlobal(c.asJSIdentifier(),a,true);}}catch(a){TP.ifError()?TP.error(TP.ec(a,TP.join('Error initializing ',c,' type proxy')),TP.LOG,arguments):0;}}TP.ifTrace()?TP.trace('Initialized '+f+' type proxies.',TP.LOG,arguments):0;return;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETUnicode.js';
TP.lang.Object.defineSubtype('core:Unicode');TP.core.Unicode.Type.defineConstant('BaseChar','[A-Z]|[a-z]|[\xC0-\xD6]|[\xD8-\xF6]|[\xF8-\xFF]|[\u0100-\u0131]|[\u0134-\u013E]|[\u0141-\u0148]|[\u014A-\u017E]|[\u0180-\u01C3]|[\u01CD-\u01F0]|[\u01F4-\u01F5]|[\u01FA-\u0217]|[\u0250-\u02A8]|[\u02BB-\u02C1]|\u0386|[\u0388-\u038A]|\u038C|[\u038E-\u03A1]|[\u03A3-\u03CE]|[\u03D0-\u03D6]|\u03DA|\u03DC|\u03DE|\u03E0|[\u03E2-\u03F3]|[\u0401-\u040C]|[\u040E-\u044F]|[\u0451-\u045C]|[\u045E-\u0481]|[\u0490-\u04C4]|[\u04C7-\u04C8]|[\u04CB-\u04CC]|[\u04D0-\u04EB]|[\u04EE-\u04F5]|[\u04F8-\u04F9]|[\u0531-\u0556]|\u0559|[\u0561-\u0586]|[\u05D0-\u05EA]|[\u05F0-\u05F2]|[\u0621-\u063A]|[\u0641-\u064A]|[\u0671-\u06B7]|[\u06BA-\u06BE]|[\u06C0-\u06CE]|[\u06D0-\u06D3]|\u06D5|[\u06E5-\u06E6]|[\u0905-\u0939]|\u093D|[\u0958-\u0961]|[\u0985-\u098C]|[\u098F-\u0990]|[\u0993-\u09A8]|[\u09AA-\u09B0]|\u09B2|[\u09B6-\u09B9]|[\u09DC-\u09DD]|[\u09DF-\u09E1]|[\u09F0-\u09F1]|[\u0A05-\u0A0A]|[\u0A0F-\u0A10]|[\u0A13-\u0A28]|[\u0A2A-\u0A30]|[\u0A32-\u0A33]|[\u0A35-\u0A36]|[\u0A38-\u0A39]|[\u0A59-\u0A5C]|\u0A5E|[\u0A72-\u0A74]|[\u0A85-\u0A8B]|\u0A8D|[\u0A8F-\u0A91]|[\u0A93-\u0AA8]|[\u0AAA-\u0AB0]|[\u0AB2-\u0AB3]|[\u0AB5-\u0AB9]|\u0ABD|\u0AE0|[\u0B05-\u0B0C]|[\u0B0F-\u0B10]|[\u0B13-\u0B28]|[\u0B2A-\u0B30]|[\u0B32-\u0B33]|[\u0B36-\u0B39]|\u0B3D|[\u0B5C-\u0B5D]|[\u0B5F-\u0B61]|[\u0B85-\u0B8A]|[\u0B8E-\u0B90]|[\u0B92-\u0B95]|[\u0B99-\u0B9A]|\u0B9C|[\u0B9E-\u0B9F]|[\u0BA3-\u0BA4]|[\u0BA8-\u0BAA]|[\u0BAE-\u0BB5]|[\u0BB7-\u0BB9]|[\u0C05-\u0C0C]|[\u0C0E-\u0C10]|[\u0C12-\u0C28]|[\u0C2A-\u0C33]|[\u0C35-\u0C39]|[\u0C60-\u0C61]|[\u0C85-\u0C8C]|[\u0C8E-\u0C90]|[\u0C92-\u0CA8]|[\u0CAA-\u0CB3]|[\u0CB5-\u0CB9]|\u0CDE|[\u0CE0-\u0CE1]|[\u0D05-\u0D0C]|[\u0D0E-\u0D10]|[\u0D12-\u0D28]|[\u0D2A-\u0D39]|[\u0D60-\u0D61]|[\u0E01-\u0E2E]|\u0E30|[\u0E32-\u0E33]|[\u0E40-\u0E45]|[\u0E81-\u0E82]|\u0E84|[\u0E87-\u0E88]|\u0E8A|\u0E8D|[\u0E94-\u0E97]|[\u0E99-\u0E9F]|[\u0EA1-\u0EA3]|\u0EA5|\u0EA7|[\u0EAA-\u0EAB]|[\u0EAD-\u0EAE]|\u0EB0|[\u0EB2-\u0EB3]|\u0EBD|[\u0EC0-\u0EC4]|[\u0F40-\u0F47]|[\u0F49-\u0F69]|[\u10A0-\u10C5]|[\u10D0-\u10F6]|\u1100|[\u1102-\u1103]|[\u1105-\u1107]|\u1109|[\u110B-\u110C]|[\u110E-\u1112]|\u113C|\u113E|\u1140|\u114C|\u114E|\u1150|[\u1154-\u1155]|\u1159|[\u115F-\u1161]|\u1163|\u1165|\u1167|\u1169|[\u116D-\u116E]|[\u1172-\u1173]|\u1175|\u119E|\u11A8|\u11AB|[\u11AE-\u11AF]|[\u11B7-\u11B8]|\u11BA|[\u11BC-\u11C2]|\u11EB|\u11F0|\u11F9|[\u1E00-\u1E9B]|[\u1EA0-\u1EF9]|[\u1F00-\u1F15]|[\u1F18-\u1F1D]|[\u1F20-\u1F45]|[\u1F48-\u1F4D]|[\u1F50-\u1F57]|\u1F59|\u1F5B|\u1F5D|[\u1F5F-\u1F7D]|[\u1F80-\u1FB4]|[\u1FB6-\u1FBC]|\u1FBE|[\u1FC2-\u1FC4]|[\u1FC6-\u1FCC]|[\u1FD0-\u1FD3]|[\u1FD6-\u1FDB]|[\u1FE0-\u1FEC]|[\u1FF2-\u1FF4]|[\u1FF6-\u1FFC]|\u2126|[\u212A-\u212B]|\u212E|[\u2180-\u2182]|[\u3041-\u3094]|[\u30A1-\u30FA]|[\u3105-\u312C]|[\uAC00-\uD7A3]');TP.core.Unicode.Type.defineConstant('Ideographic','[\u4E00-\u9FA5]|\u3007|[\u3021-\u3029]');TP.core.Unicode.Type.defineConstant('Letter',TP.join(TP.core.Unicode.BaseChar,'|',TP.core.Unicode.Ideographic));TP.core.Unicode.Type.defineConstant('CombiningChar','[\u0300-\u0345]|[\u0360-\u0361]|[\u0483-\u0486]|[\u0591-\u05A1]|[\u05A3-\u05B9]|[\u05BB-\u05BD]|\u05BF|[\u05C1-\u05C2]|\u05C4|[\u064B-\u0652]|\u0670|[\u06D6-\u06DC]|[\u06DD-\u06DF]|[\u06E0-\u06E4]|[\u06E7-\u06E8]|[\u06EA-\u06ED]|[\u0901-\u0903]|\u093C|[\u093E-\u094C]|\u094D|[\u0951-\u0954]|[\u0962-\u0963]|[\u0981-\u0983]|\u09BC|\u09BE|\u09BF|[\u09C0-\u09C4]|[\u09C7-\u09C8]|[\u09CB-\u09CD]|\u09D7|[\u09E2-\u09E3]|\u0A02|\u0A3C|\u0A3E|\u0A3F|[\u0A40-\u0A42]|[\u0A47-\u0A48]|[\u0A4B-\u0A4D]|[\u0A70-\u0A71]|[\u0A81-\u0A83]|\u0ABC|[\u0ABE-\u0AC5]|[\u0AC7-\u0AC9]|[\u0ACB-\u0ACD]|[\u0B01-\u0B03]|\u0B3C|[\u0B3E-\u0B43]|[\u0B47-\u0B48]|[\u0B4B-\u0B4D]|[\u0B56-\u0B57]|[\u0B82-\u0B83]|[\u0BBE-\u0BC2]|[\u0BC6-\u0BC8]|[\u0BCA-\u0BCD]|\u0BD7|[\u0C01-\u0C03]|[\u0C3E-\u0C44]|[\u0C46-\u0C48]|[\u0C4A-\u0C4D]|[\u0C55-\u0C56]|[\u0C82-\u0C83]|[\u0CBE-\u0CC4]|[\u0CC6-\u0CC8]|[\u0CCA-\u0CCD]|[\u0CD5-\u0CD6]|[\u0D02-\u0D03]|[\u0D3E-\u0D43]|[\u0D46-\u0D48]|[\u0D4A-\u0D4D]|\u0D57|\u0E31|[\u0E34-\u0E3A]|[\u0E47-\u0E4E]|\u0EB1|[\u0EB4-\u0EB9]|[\u0EBB-\u0EBC]|[\u0EC8-\u0ECD]|[\u0F18-\u0F19]|\u0F35|\u0F37|\u0F39|\u0F3E|\u0F3F|[\u0F71-\u0F84]|[\u0F86-\u0F8B]|[\u0F90-\u0F95]|\u0F97|[\u0F99-\u0FAD]|[\u0FB1-\u0FB7]|\u0FB9|[\u20D0-\u20DC]|\u20E1|[\u302A-\u302F]|\u3099|\u309A');TP.core.Unicode.Type.defineConstant('Digit','[0-9]|[\u0660-\u0669]|[\u06F0-\u06F9]|[\u0966-\u096F]|[\u09E6-\u09EF]|[\u0A66-\u0A6F]|[\u0AE6-\u0AEF]|[\u0B66-\u0B6F]|[\u0BE7-\u0BEF]|[\u0C66-\u0C6F]|[\u0CE6-\u0CEF]|[\u0D66-\u0D6F]|[\u0E50-\u0E59]|[\u0ED0-\u0ED9]|[\u0F20-\u0F29]');TP.core.Unicode.Type.defineConstant('Extender','\xB7|\u02D0|\u02D1|\u0387|\u0640|\u0E46|\u0EC6|\u3005|[\u3031-\u3035]|[\u309D-\u309E]|[\u30FC-\u30FE]');TP.core.Unicode.Type.defineConstant('NameChar',TP.join(TP.core.Unicode.Letter,'|',TP.core.Unicode.Digit,'|','\\.','|',':','|','_','|','-','|',TP.core.Unicode.CombiningChar,'|',TP.core.Unicode.Extender));TP.core.Unicode.Type.defineConstant('Char','\t|\n|\r|[ -\uD7FF]|[\uE000-\uFFFD]');
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETDevicePrimitivesPre.js';
TP.W3C_EVENT_PROPERTIES=/(type|target|currentTarget|eventPhase|bubbles|cancelable|timeStamp)/;TP.EXTRA_EVENT_PROPERTIES=/(offsetX|offsetY)/;TP.TIBET_EVENT_PROPERTIES=TP.ac('$$target','$$type','$$timestamp','$$clientX','$$clientY','$$clientPt','$$offsetX','$$offsetY','$$offsetPt','$$view','$$pageX','$$pageY','$$pagePt','$$screenX','$$screenY','$$screenPt','$$keyCode','$$altKey','$$ctrlKey','$$shiftKey','$$button','$$wheelDelta','$$wheelDeltaX','$$wheelDeltaY','$captured','$normalized','$notSignaled','$unicodeCharCode','$computedName');TP.DOM_EVENT_PROPERTIES=TP.ac('bubbles','cancelable','currentTarget','eventPhase','target','timeStamp','type','defaultPrevented','isTrusted');TP.DOM_UI_EVENT_PROPERTIES=TP.DOM_EVENT_PROPERTIES.concat(TP.ac('detail','view','layerX','layerY','offsetX','offsetY','pageX','pageY'));TP.DOM_FOCUS_EVENT_PROPERTIES=TP.DOM_UI_EVENT_PROPERTIES.concat(TP.ac('relatedTarget'));TP.DOM_MOUSE_EVENT_PROPERTIES=TP.DOM_UI_EVENT_PROPERTIES.concat(TP.ac('clientX','clientY','screenX','screenY','altKey','ctrlKey','shiftKey','metaKey','button','buttons','relatedTarget'));TP.DOM_WHEEL_EVENT_PROPERTIES=TP.DOM_MOUSE_EVENT_PROPERTIES.concat(TP.ac('wheelDelta','axis','deltaMode','deltaX','deltaY','deltaZ'));TP.DOM_KEY_EVENT_PROPERTIES=TP.DOM_UI_EVENT_PROPERTIES.concat(TP.ac('char','key','locale','location','repeat','altKey','ctrlKey','metaKey','shiftKey','charCode','keyCode','which'));TP.DOM_MUTATION_EVENT_PROPERTIES=TP.DOM_EVENT_PROPERTIES.concat(TP.ac('relatedNode','prevValue','newValue','attrName','attrChange'));if(TP.notValid(TP.DOM_SIGNAL_TYPE_MAP)){TP.DOM_SIGNAL_TYPE_MAP=TP.hc('abort','TP.sig.DOMAbort','blur','TP.sig.DOMBlur','change','TP.sig.DOMChange','click','TP.sig.DOMClick','copy','TP.sig.DOMCopy','contextmenu','TP.sig.DOMContextMenu','cut','TP.sig.DOMCut','dblclick','TP.sig.DOMDblClick','error','TP.sig.DOMError','focus','TP.sig.DOMFocus','keydown','TP.sig.DOMKeyDown','keypress','TP.sig.DOMKeyPress','keyup','TP.sig.DOMKeyUp','load','TP.sig.DOMLoad','mousedown','TP.sig.DOMMouseDown','mouseenter','TP.sig.DOMMouseEnter','mousehover','TP.sig.DOMMouseHover','mouseleave','TP.sig.DOMMouseLeave','mousemove','TP.sig.DOMMouseMove','mouseout','TP.sig.DOMMouseOut','mouseover','TP.sig.DOMMouseOver','mouseup','TP.sig.DOMMouseUp','dragdown','TP.sig.DOMDragDown','draghover','TP.sig.DOMDragHover','dragmove','TP.sig.DOMDragMove','dragout','TP.sig.DOMDragOut','dragover','TP.sig.DOMDragOver','dragup','TP.sig.DOMDragUp','move','TP.sig.DOMMove','paste','TP.sig.DOMPaste','reset','TP.sig.DOMReset','resize','TP.sig.DOMResize','submit','TP.sig.DOMSubmit','unload','TP.sig.DOMUnload');if(TP.boot.isUA('GECKO')){TP.DOM_SIGNAL_TYPE_MAP.atPut('DOMMouseScroll','TP.sig.DOMMouseWheel');}if(TP.boot.isUA('IE')||TP.boot.isUA('WEBKIT')){TP.DOM_SIGNAL_TYPE_MAP.atPut('mousewheel','TP.sig.DOMMouseWheel');}};
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETDevicePrimitivesBase.js';
TP.definePrimitive('eventPreventDefault',function(a){if(!TP.isEvent(a)){return TP.raise(this,'TP.sig.InvalidEvent',arguments);}a.preventDefault();return a;});TP.definePrimitive('eventStopPropagation',function(a){if(!TP.isEvent(a)){return TP.raise(this,'TP.sig.InvalidEvent',arguments);}a.stopPropagation();return a;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETDevicePrimitivesPlatform.js';
TP.definePrimitive('eventNormalize',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a,e){var b,c,d;if(!TP.isEvent(a)){return TP.raise(this,'TP.sig.InvalidEvent',arguments);}if(a.$normalized){return a;}a.$normalized=true;a.$$keyCode=a.keyCode||a.charCode;if(a.$$type==='DOMMouseScroll'||a.type==='DOMMouseScroll'){b=a.detail;if(b>100){b=3;}else if(b<-100){b=-3;}if(a.axis===a.HORIZONTAL_AXIS){c=b;d=0;}else{c=0;d=b;}a.$$wheelDelta=b;a.$$wheelDeltaX=c;a.$$wheelDeltaY=d;}a.$$view=TP.$eventGetNormalizedView(a,e);a.$$timestamp=a.timeStamp;return a;},'trident',function(a,e){var b,c,d;if(a.$normalized){return a;}if(!TP.isEvent(a)){return TP.raise(this,'TP.sig.InvalidEvent',arguments);}a.$normalized=true;a.$$keyCode=a.keyCode;if(a.$$type==='mousewheel'||a.type==='mousewheel'){b=-a.wheelDelta/40;c=0;d=b;a.$$wheelDelta=b;a.$$wheelDeltaX=c;a.$$wheelDeltaY=d;}a.$$view=TP.$eventGetNormalizedView(a,e);a.$$timestamp=a.timeStamp;return a;},'webkit',function(a,e){var b,c,d;if(!TP.isEvent(a)){return TP.raise(this,'TP.sig.InvalidEvent',arguments);}if(a.$normalized){return a;}a.$normalized=true;a.$$keyCode=a.keyCode;if(a.$$type==='mousewheel'||a.type==='mousewheel'){b=-a.wheelDelta/40;c=-a.wheelDeltaX/40;d=-a.wheelDeltaY/40;a.$$wheelDelta=b;a.$$wheelDeltaX=c;a.$$wheelDeltaY=d;}a.$$view=TP.$eventGetNormalizedView(a,e);a.$$timestamp=a.timeStamp;return a;}));TP.definePrimitive('$eventGetNormalizedView',function(a,b){if(TP.isValid(a.$$view)){return a.$$view;}if(TP.isValid(a.view)){return a.view;}if(TP.isValid(b)&&TP.isValid(b.defaultView)){return b.defaultView;}if(TP.isValid(a.currentTarget)&&TP.isValid(a.currentTarget.defaultView)){return a.currentTarget.defaultView;}if(TP.isValid(a.srcElement)&&TP.isValid(a.srcElement.defaultView)){return a.srcElement.defaultView;}});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETDevicePrimitivesPost.js';
TP.definePrimitive('eventNameNativeValue',function(a){var b,c;if(TP.isEmpty(a)){return TP.raise(this,'TP.sig.InvalidString',arguments);}if(TP.regex.KEY_EVENT.test(a)){if(TP.regex.PRESS_END.test(a)){b='keypress';}else if(TP.regex.DOWN_END.test(a)){b='keydown';}else if(TP.regex.UP_END.test(a)){b='keyup';}}else if(TP.isType(c=a.asType())){b=c.NATIVE_NAME;}return b;});TP.definePrimitive('eventGetPropertyKeys',function(b){var a;a=TP.eventGetType(b);switch(a){case'change':case'reset':case'submit':return TP.DOM_EVENT_PROPERTIES;case'abort':case'blur':case'change':case'error':case'focus':case'load':case'reset':case'resize':case'scroll':case'select':case'submit':case'unload':return TP.DOM_UI_EVENT_PROPERTIES;case'blur':case'focus':case'focusin':case'focusout':return TP.DOM_FOCUS_EVENT_PROPERTIES;case'keydown':case'keypress':case'keyup':return TP.DOM_KEY_EVENT_PROPERTIES;case'click':case'dblclick':case'mousedown':case'mouseenter':case'mouseleave':case'mousemove':case'mouseout':case'mouseover':case'mouseup':return TP.DOM_MOUSE_EVENT_PROPERTIES;case'DOMMouseScroll':case'mousewheel':case'wheel':return TP.DOM_WHEEL_EVENT_PROPERTIES;case'DOMAttrModified':case'DOMNodeInserted':case'DOMNodeRemoved':case'DOMCharacterDataModified':case'DOMNodeInsertedIntoDocument':case'DOMNodeRemovedFromDocument':case'DOMSubtreeModified':return TP.DOM_MUTATION_EVENT_PROPERTIES;default:return TP.DOM_EVENT_PROPERTIES;}return;});TP.definePrimitive('eventGetTarget',function(b){var a;a=TP.eventNormalize(b);return TP.ifInvalid(a.$$target,a.target);});TP.definePrimitive('eventGetTargetDocument',function(b){var a;if(TP.isElement(a=TP.eventGetTarget(b))){return TP.nodeGetDocument(a);}return null;});TP.definePrimitive('eventGetTime',function(c){var a,b;a=TP.eventNormalize(c);b=TP.ifInvalid(a.$$timestamp,a.timeStamp);if(TP.isNumber(b)){return b;}return;});TP.definePrimitive('eventGetType',function(b){var a;a=TP.eventNormalize(b);return TP.ifInvalid(a.$$type,a.type);});TP.definePrimitive('eventGetWindow',function(b){var a;a=TP.eventNormalize(b);return TP.ifInvalid(a.$$view,a.view);});TP.definePrimitive('eventResolveTarget',function(c){var b,d,e,a,f;if(!TP.isEvent(c)){return TP.raise(this,'TP.sig.InvalidEvent',arguments);}b=TP.eventGetTarget(c);if(!TP.isNode(b)){return null;}if(b.nodeType===Node.DOCUMENT_NODE){return b;}else if(TP.isTextNode(b)){b=TP.ifInvalid(b.parentNode,b);}e=TP.DOM_SIGNAL_TYPE_MAP.at(TP.eventGetType(c));if(TP.notValid(e)){return b;}a=b;while(a&&a.nodeType!==Node.DOCUMENT_NODE&&a.nodeType!==Node.DOCUMENT_FRAGMENT_NODE){if(!TP.isElement(a)){a=a.parentNode;continue;}if(TP.elementHasAttribute(a,'tibet:disabled',true)){return null;}if(TP.notValid(d)){if(TP.elementHasAttribute(a,'tibet:captures',true)){f=TP.elementGetAttribute(a,'tibet:captures',true);if(f.indexOf(e)!==TP.NOT_FOUND){d=a;}}}a=a.parentNode;}return d||b;});TP.definePrimitive('eventGetAltKey',function(b){var a;a=TP.eventNormalize(b);return TP.ifInvalid(a.$$altKey,a.altKey);});TP.definePrimitive('eventGetKeyCode',function(b){var a;a=TP.eventNormalize(b);return a.$$keyCode;});TP.definePrimitive('eventGetCtrlKey',function(b){var a;a=TP.eventNormalize(b);return TP.ifInvalid(a.$$ctrlKey,a.ctrlKey);});TP.definePrimitive('eventGetMetaKey',function(b){var a;a=TP.eventNormalize(b);return TP.ifInvalid(a.$$metaKey,a.metaKey);});TP.definePrimitive('eventGetShiftKey',function(b){var a;a=TP.eventNormalize(b);return TP.ifInvalid(a.$$shiftKey,a.shiftKey);});TP.definePrimitive('eventGetUnicodeCharCode',function(c){var b,a;b=TP.eventNormalize(c);if(TP.notValid(a=b.$unicodeCharCode)){if(!TP.isString(a=String.fromCharCode(TP.eventGetKeyCode(b)))){return null;}a=a.asUnicodeLiteral().replace('\\u','U');}return a;});TP.definePrimitive('eventGetButton',function(c){var a,b;a=TP.eventNormalize(c);b=TP.ifInvalid(a.$$button,a.button);switch(b){case 0:if(!TP.boot.isUA('IE')){return TP.LEFT;}break;case 1:if(TP.boot.isUA('IE')){return TP.LEFT;}else{return TP.MIDDLE;}break;case 2:return TP.RIGHT;case 4:if(TP.boot.isUA('IE')){return TP.MIDDLE;}break;default:break;}return;});TP.definePrimitive('eventGetClientXY',function(c){var a,b;a=TP.eventNormalize(c);b=TP.ac(TP.ifInvalid(a.$$clientX,a.clientX),TP.ifInvalid(a.$$clientY,a.clientY));return b;});TP.definePrimitive('eventGetOffsetXY',function(c){var a,b;a=TP.eventNormalize(c);b=TP.ac(TP.ifInvalid(a.$$offsetX,a.offsetX),TP.ifInvalid(a.$$offsetY,a.offsetY));return b;});TP.definePrimitive('eventGetPageXY',function(c){var a,b;a=TP.eventNormalize(c);b=TP.ac(TP.ifInvalid(a.$$pageX,a.pageX),TP.ifInvalid(a.$$pageY,a.pageY));return b;});TP.definePrimitive('eventGetRelatedTarget',function(b){var a;a=TP.eventNormalize(b);return TP.ifInvalid(a.$$relatedTarget,a.relatedTarget);});TP.definePrimitive('eventGetResolvedTarget',function(b){var a;a=TP.eventNormalize(b);return TP.ifInvalid(a.resolvedTarget);});TP.definePrimitive('eventGetWheelDelta',function(b){var a;a=TP.eventNormalize(b);return TP.ifInvalid(a.$$wheelDelta,a.wheelDelta);});TP.definePrimitive('eventSetType',function(b,c){var a;a=TP.eventNormalize(b);a.$$type=c;return;});TP.definePrimitive('eventIsDuplicate',function(f,g){var i,a,b,d,h,c,e;if(TP.notValid(f)||TP.notValid(g)){return false;}a=TP.isEvent(f)?f:f.get('event');b=TP.isEvent(g)?g:g.get('event');if(!TP.isEvent(a)||!TP.isEvent(b)){return false;}i=a.type;if(i!==b.type){return false;}switch(i){case'keypress':case'keydown':case'keyup':return a.keyCode===b.keyCode&&a.charCode===b.charCode&&a.which===b.which&&a.shiftKey===b.shiftKey&&a.ctrlKey===b.ctrlKey&&a.altKey===b.altKey&&a.metaKey===b.metaKey;default:d=TP.eventGetPropertyKeys(a);h=d.getSize();for(c=0;c<h;c++){e=d[c];if(a[e]!==b[e]){return false;}}d=TP.TIBET_EVENT_PROPERTIES;h=d.getSize();for(c=0;c<h;c++){e=d[c];if(a[e]!==b[e]){return false;}}return true;}});TP.definePrimitive('dispatch',function(b,e,c,m,n,r,q){var a,f,g,j,d,k,i,p,l,h,o;TP.debug('break.signal_dispatch');a=m;if(TP.isEmpty(b)){if(TP.isElement(c)){f=TP.lid(c,true);g=TP.gid(c);}}else if(TP.isElement(b)){f=TP.lid(b,true);g=TP.gid(b);}else if(!TP.isString(b)){f=TP.lid(b);g=TP.gid(b);}else{if(TP.regex.ELEMENT_ID.test(b)){f=b.slice(b.lastIndexOf('#')+1);}else{f=b;}g=b;}j=g;if(TP.notValid(e)&&TP.isEvent(a)){d=TP.DOM_SIGNAL_TYPE_MAP.at(a.type);}else if(TP.isString(e)){if(TP.notEmpty(k=TP.expandSignalName(e))&&TP.isType(TP.sys.require(k))){d=k;}else{d=e;}}else if(TP.isKindOf(e,TP.sig.Signal)){d=e.getSignalName();}else{return null;}if(TP.notValid(i=n)){if(TP.isString(d)){if(TP.isType(p=TP.sys.getTypeByName(d))){i=p.getDefaultPolicy();}else{i=TP.INHERITANCE_FIRING;}}else{i=TP.DOM_FIRING;}}if(TP.isElement(c)){h=TP.nodeGetWindow(c);}if(TP.notValid(h)){h=TP.ifInvalid(TP.sys.getWindowById(TP.sys.getUICanvasName()),window);}if(TP.isEvent(a)){h.TP.boot.$$dispatch(b,d,c,m,n,false);}if(i===TP.DOM_FIRING&&TP.isElement(c)){j=TP.elementGetEventIds(c);l='TP.sig.DOMSignal';}if(TP.notValid(a)){a=TP.hc();}if(TP.canInvoke(a,'atPut')){a.atPut('elementGlobalID',g);a.atPut('elementLocalID',f);a.atPut('tibetTarget',c);a.atPut('$$view',h);}else{try{a.elementGlobalID=g;a.elementLocalID=f;a.tibetTarget=c;a.$$view=h;}catch(a){}}o=TP.signal(j,TP.isKindOf(e,TP.sig.Signal)?e:d,arguments,a,i,l,r,q);return o;});TP.definePrimitive('$dispatchEventToTIBET',function(b){var e,f,d,a,c,g,i,h,j,k,l;if(!TP.isEvent(b)){return TP.raise(this,'TP.sig.InvalidEvent',arguments);}a=b.target;c=TP.nodeGetWindow(a);e=TP.DOM_SIGNAL_TYPE_MAP.at(b.type);if(b.type.indexOf('key')===0){return TP.sys.getTypeByName('TP.core.Keyboard').$$handleKeyEvent(b);}else if(b.type.indexOf('mouse')===0){return TP.sys.getTypeByName('TP.core.Mouse').$$handleMouseEvent(b);}TP.eventStopPropagation(b);if(TP.isTextNode(a)){if(TP.notValid(a=a.parentNode)){a=c.document;}}g=b.currentTarget;if(TP.isEmpty(a.id)&&a!==c.document){a=g;}if(TP.boot.isUA('IE')){if(g===c.document&&a!==TP.documentGetBody(c.document)&&!c.$$allElementEvents.containsString(TP.DOM_SIGNAL_TYPE_MAP.at(b.type))){return;}}i=TP.lid(a,true);h=TP.gid(a,true);d=TP.eventNormalize(b);try{d.elementGlobalID=h;d.elementLocalID=i;d.tibetTarget=a;}catch(a){}if(TP.isValid(l=a.firingPolicy)&&l!==TP.DOM_FIRING){TP.ifTrace(TP.sys.shouldLogSignals())?TP.trace('Sending '+e+' to TIBET with supertype '+f,TP.SIGNAL_LOG,arguments):0;k=TP.signal(h,e,null,d,a.firingPolicy,f);}else{TP.ifTrace(TP.sys.shouldLogSignals())?TP.trace('Sending '+e+' to TIBET with supertype '+f,TP.SIGNAL_LOG,arguments):0;j=TP.elementGetEventIds(a);k=TP.signal(j,e,null,d,TP.DOM_FIRING,f);}return;});TP.definePrimitive('$$handleFocus',function(a){return TP.$$handleNonKeyOrMouseEvent(a);});TP.definePrimitive('$$handleBlur',function(a){return TP.$$handleNonKeyOrMouseEvent(a);});TP.definePrimitive('$$handleChange',function(a){return TP.$$handleNonKeyOrMouseEvent(a);});TP.definePrimitive('$$handleCut',function(a){return TP.$$handleNonKeyOrMouseEvent(a);});TP.definePrimitive('$$handleCopy',function(a){return TP.$$handleNonKeyOrMouseEvent(a);});TP.definePrimitive('$$handlePaste',function(a){return TP.$$handleNonKeyOrMouseEvent(a);});TP.definePrimitive('$$handleNonKeyOrMouseEvent',function(a){var b,c,d;if(a.$captured){return;}a.$captured=true;if(TP.isElement(b=TP.eventGetResolvedTarget(a))){c='handlePeer'+TP.escapeTypeName(TP.DOM_SIGNAL_TYPE_MAP.at(TP.eventGetType(a)));d=TP.wrap(b).getType();if(TP.canInvoke(d,c)){d[c](b,a);}if(a.defaultPrevented===true){return;}TP.dispatch(null,TP.DOM_SIGNAL_TYPE_MAP.at(TP.eventGetType(a)),b,a,TP.DOM_FIRING);}return;});TP.definePrimitive('elementGetEventIds',function(e,g){var b,a,d,f,c;if(!TP.isElement(e)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.notValid(b=e.eventIds)||TP.isTrue(g)){b=TP.ac();a=e;d=TP.nodeGetDocument(a);while(TP.isElement(a)){if(a!==d&&TP.isEmpty(TP.elementGetAttribute(a,'id'))){a=a.parentNode;continue;}f=TP.lid(a);if(TP.notEmpty(f)){b.push(TP.gid(a));}if(a===d&&TP.isWindow(c=TP.nodeGetWindow(d))){if(TP.isIFrameWindow(c)){b.push(TP.gid(c));a=c.frameElement;d=TP.nodeGetDocument(a);continue;}else{break;}}a=a.parentNode;}c=TP.nodeGetWindow(d);if(TP.isElement(c)){b.push(TP.gid(c));}b.reverse();b.isOriginSet(true);e.eventIds=b;}return b;});TP.definePrimitive('windowArmListeners',function(d,h){var e,a,b,f,c,g;if(!TP.isWindow(d)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(!TP.isDocument(h)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}e=TP.nodeEvaluateXPath(h,'//tibet_listener[starts-with(@event, "UI")]',TP.NODESET);c=0;for(b=0;b<e.length;b++){a=e[b];TP.windowArmNode(d,TP.elementGetAttribute(a,'local_origin'),TP.elementGetAttribute(a,'event'));c++;g=TP.elementGetAttribute(a,'origin');if(TP.isString(g)){f=g.split('.');TP.windowArmNode(d,f[f.length-1],TP.elementGetAttribute(a,'event'));c++;}}return c;});TP.definePrimitive('windowArmNode',function(d,a,e,g,i){var b,k,j,h,f,c;TP.debug('break.signal_arm');if(!TP.isWindow(d)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(TP.notValid(a)||TP.isEmpty(e)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.isString(e)){c=e.split(' ');}else if(TP.isCollection(e)){c=e;}else{return TP.raise(this,'TP.sig.InvalidParameter',arguments,'Event specification not a string or collection.');}k=c.getSize();for(b=0;b<k;b++){j=c.at(b);if(!TP.isString(j)){c.atPut(b,j.getSignalName());}}if(a===TP.ANY){TP.windowArmEvents(d,c,g);}else if(TP.isDocument(a)){TP.$windowArmNodeForEvents(d,a,c,g,i);return;}else if(TP.isElement(a)){TP.elementSetAttribute(a,'tibet:armed','true',true);TP.$windowArmNodeForEvents(d,a,c,g,i);return;}else if(TP.isString(a)){f=a.split(' ');}else{f=a;}if(TP.isArray(f)){for(b=0;b<f.length;b++){h=TP.nodeGetElementById(d.document,f[b]);if(TP.isElement(h)){TP.elementSetAttribute(h,'tibet:armed','true',true);TP.$windowArmNodeForEvents(d,h,c,g,i);}}}return;});TP.definePrimitive('$windowArmNodeForEvents',function(u,a,j,s,r){var e,f,g,q,n,c,t,m,b,o,l,h,i,d,p,k;if(!TP.isWindow(u)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isEmpty(j)){return TP.raise(this,'TP.sig.InvalidArray',arguments);}if(TP.isDocument(a)){e=a.documentElement;c=a;}else{e=a;c=TP.nodeGetDocument(a);}t=TP.nodeGetWindow(c);m=TP.lid(e,true);if(TP.notEmpty(o=TP.nodeGetDescendantElementsByIdOrName(c,m))){b=o;}else{b=TP.ac();b.push(e);}l=TP.ifInvalid(r,TP.DOM_FIRING);h=TP.ifInvalid(s,TP.$dispatchEventToTIBET);q=b.getSize();for(f=0;f<q;f++){d=b.at(f);n=j.getSize();for(g=0;g<n;g++){p=j.at(g);k=TP.eventNameNativeValue(p);i=function(c){var b;b=TP.eventNormalize(c,a);return h(b);};h.$$wrapper=i;if(TP.boot.isUA('IE')){d.attachEvent('on'+k,i);}else{d.addEventListener(k,h,false);}d.firingPolicy=l;}}return;});TP.definePrimitive('windowDisarmNode',function(d,c,e,g){var a,h,i,f,b;if(!TP.isWindow(d)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(TP.notValid(c)||TP.isEmpty(e)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.isString(e)){b=e.split(' ');}else if(TP.isCollection(e)){b=e;}else{return TP.raise(this,'TP.sig.InvalidParameter',arguments,'Event specification not a string or collection.');}for(a=0;a<b.getSize();a++){h=b.at(a);if(!TP.isString(h)){b.atPut(a,h.getSignalName());}}if(c===TP.ANY){TP.windowDisarmEvents(d,b,g);return;}else if(TP.isNode(c)){TP.$windowDisarmNodeForEvents(d,c,b,g);return;}else if(TP.isString(c)){f=c.split(' ');}else{f=c;}for(a=0;a<f.length;a++){i=TP.nodeGetElementById(d.document,f[a]);if(TP.isElement(i)){TP.$windowDisarmNodeForEvents(d,i,b,g);}}return;});TP.definePrimitive('$windowDisarmNodeForEvents',function(o,a,g,q){var d,e,l,k,f,p,j,b,c,m,h,n,i;if(!TP.isWindow(o)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isEmpty(g)){return TP.raise(this,'TP.sig.InvalidArray',arguments);}f=TP.nodeGetDocument(a);p=TP.nodeGetWindow(f);j=TP.lid(a);b=TP.ifInvalid(q,TP.$dispatchEventToTIBET);if(!TP.isWindow(a)&&!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)&&TP.notEmpty(m=TP.nodeGetDescendantElementsByIdOrName(f,j))){c=m;}else{c=TP.ac();c.push(a);}l=c.getSize();for(d=0;d<l;d++){h=c.at(d);k=g.getSize();for(e=0;e<k;e++){n=g.at(e);i=TP.eventNameNativeValue(n);if(TP.isValid(b.$$wrapper)){b=b.$$wrapper;}if(TP.boot.isUA('IE')){h.detachEvent('on'+i,b);}else{h.removeEventListener(i,b,false);}}}return;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETDHTMLPrimitivesPre.js';

TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETDHTMLPrimitivesBase.js';
TP.XHTML_10_NONINLINE_ELEMENTS=TP.hc('address','block','applet','block','blockquote','block','body','block','caption','table-caption','center','block','col','table-column','colgroup','table-column-group','dd','block','dir','block','div','block','dl','block','dt','block','fieldset','block','form','block','frame','block','frameset','block','h1','block','h2','block','h3','block','h4','block','h5','block','h6','block','hr','block','iframe','block','li','list-item','menu','block','noframes','block','object','block','ol','block','p','block','pre','block','table','table','td','table-cell','th','table-cell','tr','table-row','thead','table-header-group','tbody','table-row-group','tfoot','table-footer-group','ul','block');TP.definePrimitive('objectGetXY',function(a){var b,c;if(TP.notValid(a)){return TP.raise(this,'TP.sig.InvalidObject',arguments);}if(TP.isElement(a)){return TP.elementGetPageXY(a);}if(TP.isEvent(a)){return TP.ac(a.pageX,a.pageY);}if(TP.isArray(a)){return TP.ac(a.first(),a.last());}if(TP.isNumber(b=a.get('x'))&&TP.isNumber(c=a('y'))){return TP.ac(b,c);}return TP.ac();});TP.definePrimitive('documentGetHeight',function(a){if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}return TP.documentGetBody(a).offsetHeight;});TP.definePrimitive('documentGetScrollX',function(a){var b;if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}return TP.isWindow(b=TP.nodeGetWindow(a))?b.pageXOffset:0;});TP.definePrimitive('documentGetScrollY',function(a){var b;if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}return TP.isWindow(b=TP.nodeGetWindow(a))?b.pageYOffset:0;});TP.definePrimitive('documentGetViewableHeight',function(a){if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}return a.defaultView.innerHeight;});TP.definePrimitive('documentGetViewableWidth',function(a){if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}return a.documentElement.clientWidth;});TP.definePrimitive('documentGetVisibility',function(a){var b;if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.isDefined(a.mozHidden)){b='mozVisibilityState';}else if(TP.isDefined(a.webkitHidden)){b='webkitVisibilityState';}else if(TP.isDefined(a.msHidden)){b='msVisibilityState';}else{b='visibilityState';}return a[b];});TP.definePrimitive('documentGetWidth',function(a){if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}return TP.documentGetBody(a).offsetWidth;});TP.definePrimitive('documentIsVisible',function(a){var b;if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.isDefined(a.mozHidden)){b='mozHidden';}else if(TP.isDefined(a.webkitHidden)){b='webkitHidden';}else if(TP.isDefined(a.msHidden)){b='msHidden';}else{b='hidden';}if(a[b]===false){return true;}return false;});TP.definePrimitive('documentClearSelection',function(a){var b;if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}b=TP.nodeGetWindow(a).getSelection();if(TP.isValid(b)){b.removeAllRanges();}return;});TP.definePrimitive('documentCollapseSelection',function(b,c){var a;if(!TP.isHTMLDocument(b)&&!TP.isXHTMLDocument(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}a=TP.nodeGetWindow(b).getSelection();if(TP.notValid(a)){return;}if(a.rangeCount===0){return;}try{if(TP.isTrue(c)){a.collapseToStart();}else{a.collapseToEnd();}}catch(a){}return;});TP.definePrimitive('documentCreateSelectionMarker',function(b){var a,c;if(!TP.isHTMLDocument(b)&&!TP.isXHTMLDocument(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}a=TP.nodeGetWindow(b).getSelection();if(a.rangeCount<1){return;}if(TP.isValid(a)){c=a.getRangeAt(0);if(TP.isValid(c)){return c.cloneRange();}}return null;});TP.definePrimitive('documentInsertAfterSelection',function(c,e){var a,b,d;if(!TP.isHTMLDocument(c)&&!TP.isXHTMLDocument(c)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.notValid(a=TP.nodeGetWindow(c).getSelection())){return;}if(a.rangeCount===0){return;}b=a.getRangeAt(0);b.collapse(false);d=b.createContextualFragment(TP.str(e));b.insertNode(d);a.removeAllRanges();return;});TP.definePrimitive('documentInsertBeforeSelection',function(c,e){var a,b,d;if(!TP.isHTMLDocument(c)&&!TP.isXHTMLDocument(c)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.notValid(a=TP.nodeGetWindow(c).getSelection())){return;}if(a.rangeCount===0){return;}b=a.getRangeAt(0);b.collapse(true);d=b.createContextualFragment(TP.str(e));b.insertNode(d);a.removeAllRanges();return;});TP.definePrimitive('documentIsSelectionCollapsed',function(b){var a;if(!TP.isHTMLDocument(b)&&!TP.isXHTMLDocument(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}a=TP.nodeGetWindow(b).getSelection();if(TP.notValid(a)){return true;}return a.isCollapsed||TP.isEmpty(a.toString());});TP.definePrimitive('documentGetSelectionElement',function(a){var d,b,c;if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}d=TP.documentGetSelectionType(a);if(d!==TP.SELECTION_ELEMENT){return null;}b=TP.nodeGetWindow(a).getSelection();c=b.anchorNode.childNodes[b.anchorOffset];if(TP.isElement(c)){return c;}return null;});TP.definePrimitive('documentGetSelectionParent',function(a){var c,d,b,e;if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}c=TP.documentGetSelectionType(a);if(c===TP.SELECTION_ELEMENT){if(TP.isElement(d=TP.documentGetSelectionElement(a))){return d.parentNode;}return null;}b=TP.nodeGetWindow(a).getSelection();if(TP.notValid(b)){return null;}e=TP.nodeDetectAncestor(b.anchorNode,function(a){if(TP.isElement(a)){return true;}return false;});return e;});TP.definePrimitive('documentGetSelectionText',function(a){var c,b;if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}c=TP.documentGetSelectionType(a);if(c===TP.SELECTION_ELEMENT){return null;}b=TP.nodeGetWindow(a).getSelection();if(TP.notValid(b)){return null;}return b.toString();});TP.definePrimitive('documentGetSelectionType',function(c){var b,a;if(!TP.isHTMLDocument(c)&&!TP.isXHTMLDocument(c)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}b=TP.nodeGetWindow(c).getSelection();if(TP.notValid(b)||TP.isTrue(b.isCollapsed)){return TP.SELECTION_NONE;}if(b.rangeCount===1){a=b.getRangeAt(0);if(a.startContainer===a.endContainer&&a.endOffset-a.startOffset===1&&!TP.isTextNode(a.startContainer)){return TP.SELECTION_ELEMENT;}}return TP.SELECTION_TEXT;});TP.definePrimitive('documentMoveSelectionToMarker',function(b,c){var a;if(!TP.isHTMLDocument(b)&&!TP.isXHTMLDocument(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}a=TP.nodeGetWindow(b).getSelection();if(TP.isValid(a)){a.removeAllRanges();a.addRange(c);}return;});TP.definePrimitive('documentRemoveSelection',function(a){if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.documentGetSelectionType(a)!==TP.SELECTION_NONE){TP.nodeGetWindow(a).getSelection().deleteFromDocument();}return;});TP.definePrimitive('documentReplaceSelection',function(c,e){var b,a,d;if(!TP.isHTMLDocument(c)&&!TP.isXHTMLDocument(c)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.notValid(b=TP.nodeGetWindow(c).getSelection())){return;}if(b.rangeCount===0){return;}a=b.getRangeAt(0);a.deleteContents();a.collapse(true);d=a.createContextualFragment(TP.str(e));a.insertNode(d);b.removeAllRanges();return;});TP.definePrimitive('elementContentIsScrolled',function(a){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}return a.scrollWidth>a.clientWidth||a.scrollHeight>a.clientHeight;});TP.definePrimitive('elementGetElementAtPoint',function(a,b,c){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isNumber(b)||!TP.isNumber(c)){return TP.raise(this,'TP.sig.InvalidNumber',arguments);}return TP.nodeGetDocument(a).elementFromPoint(b,c);});TP.definePrimitive('elementIsTransformed',function(c){var d,e,b,a;if(!TP.isElement(c)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}d=TP.nodeGetDocument(c);e=TP.nodeGetWindow(c);b=c;while(b&&b!==d.documentElement){a=e.getComputedStyle(b,null);if(TP.notValid(a)){break;}if(TP.notEmpty(a.OTransform||a.WebkitTransform||a.msTransform||a.MozTransform||a.transform)){return true;}b=b.parentNode;}return false;});TP.definePrimitive('elementGetIFrameDocument',function(a){if(!TP.isElement(a)||TP.elementGetLocalName(a).toLowerCase()!=='iframe'&&TP.elementGetLocalName(a).toLowerCase()!=='object'){return TP.raise(this,'TP.sig.InvalidElement',arguments);}return a.contentDocument;});TP.definePrimitive('elementGetIFrameWindow',function(a){var b;if(!TP.isElement(a)||TP.elementGetLocalName(a).toLowerCase()!=='iframe'&&TP.elementGetLocalName(a).toLowerCase()!=='object'){return TP.raise(this,'TP.sig.InvalidElement',arguments);}b=a.contentWindow;if(TP.notValid(b)){return null;}if(TP.isEmpty(b.name)){b.name=TP.elementGetAttribute(a,'id');}return b;});TP.definePrimitive('elementGetOpacity',function(b){var a;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}a=TP.elementGetComputedStyleObj(b);if(TP.isEmpty(a.opacity)){return 1;}return parseFloat(a.opacity);});TP.definePrimitive('elementGetOuterContent',function(a){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}return a.outerHTML;});TP.definePrimitive('elementGetStyleValueInPixels',function(a,b,d){var c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}c=TP.elementGetComputedStyleObj(a);return TP.elementGetPixelValue(a,c[b],b,d);});TP.definePrimitive('elementGetStyleValuesInPixels',function(c,b,g){var e,d,f,a;if(!TP.isElement(c)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}e=TP.elementGetComputedStyleObj(c);d=TP.hc();f=b.getSize();for(a=0;a<f;a++){d.atPut(b.at(a),TP.elementGetPixelValue(c,e[b.at(a)],b.at(a),g));}return d;});TP.definePrimitive('elementGetComputedTransformMatrix',function(b,l){var e,a,c,i,f,d,j,k,h,g;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}e=TP.matrixFromCSSString('matrix(1,0,0,1,0,0)');a=e;c=b;i=TP.nodeGetDocument(b);f=TP.nodeGetWindow(b);while(c&&c!==i.documentElement){d=f.getComputedStyle(c,null)||{};j=(d.OTransform||d.WebkitTransform||d.msTransform||d.MozTransform||d.transform||'none').replace(/^none$/,'matrix(1,0,0,1,0,0)');k=TP.matrixFromCSSString(j);a=TP.multiplyMatrix(a,k);c=c.parentNode;}if(TP.str(a)===TP.str(e)){a=e;}else{a=TP.translateMatrix(a,-f.pageXOffset,-f.pageYOffset,0);h=TP.$elementTransformBoundingClientRect(b,a);g=b.getBoundingClientRect(b);a=TP.translateMatrix(a,g.left-h.left,g.top-h.top,0);}if(TP.isValid(a)&&TP.isTrue(l)){return TP.matrixAs2DMatrix(a);}return a;});TP.definePrimitive('elementGetTransformValues',function(k){var d,r,q,p,l,b,i,h,j,g,m,n,o,a,f,e,c;if(!TP.isElement(k)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}d=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]);};r=function(b){var a=d(b);return a?[b[0]/a,b[1]/a]:[0,0];};q=function(a,b){return a[0]*b[0]+a[1]*b[1];};p=Math.atan2;l=function(a,b,c,d){return[c*a[0]+d*b[0],c*a[1]+d*b[1]];};if(TP.notValid(b=TP.elementGetTransformMatrix(k,true))){return TP.hc();}i=b[0];h=b[1];j=b[2];g=b[3];m=b[4];n=b[5];if(i*g-h*j===0){return null;}o=[m,n];a=[[i,h],[j,g]];f=[d(a[0])];a[0]=r(a[0]);e=q(a[0],a[1]);a[1]=l(a[1],a[0],1,-e);f[1]=d(a[1]);e/=f[1];c=p(a[0][1],a[0][0]);c=c*(180/Math.PI);return TP.hc(TP.ROTATE,c,TP.SKEW,e,TP.SCALE,f,TP.TRANSLATE,o);});TP.definePrimitive('elementSelectContent',function(a,e){var d,b,c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}d=TP.elementGetLocalName(a).toLowerCase();if(d==='input'&&a.type==='text'||d==='textarea'){a.setSelectionRange(0,a.value.length);return;}b=TP.nodeGetWindow(a).getSelection();if(TP.notValid(b)){return;}if(TP.isTrue(e)){c=TP.nodeGetDocument(a).createRange();if(TP.isValid(c)){c.selectNode(a);b.removeAllRanges();b.addRange(c);}}else{b.selectAllChildren(a);}return;});TP.definePrimitive('elementSetClass',function(a,b){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.notValid(b)){TP.elementRemoveAttribute(a,'class');}else{a.setAttribute('class',b);}return;});TP.definePrimitive('elementSetOpacity',function(a,b){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}TP.elementGetStyleObj(a).opacity=b;return;});TP.definePrimitive('$elementTransformBoundingClientRect',function(a,c){var b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}b=TP.multiplyMatrix(TP.matrixAs3DMatrix(c),[[0,a.offsetWidth,0,a.offsetWidth],[0,0,a.offsetHeight,0,a.offsetHeight],[0,0,0,0],[1,1,1,1]]);return{left:Math.min.apply(Math,b[0]),top:Math.min.apply(Math,b[1]),right:Math.max.apply(Math,b[0]),bottom:Math.max.apply(Math,b[1])};});TP.definePrimitive('textElementInsertContent',function(a,b){var d,c,e;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}d=TP.elementGetLocalName(a).toLowerCase();if(d!=='textarea'&&(d!=='input'||a.type!=='text')){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isString(b)){return TP.raise(this,'TP.sig.InvalidString',arguments);}try{a.focus();if(TP.isNumber(a.selectionStart)){c=a.selectionStart;e=a.selectionEnd;a.value=a.value.substr(0,c)+b+a.value.substr(e);a.selectionStart=c+b.length;a.selectionEnd=c+b.length;}else{a.value+=b;}}catch(a){return TP.raise(this,'TP.sig.DOMComponentException',arguments,TP.ec(a));}return;});TP.definePrimitive('textElementReplaceSelection',function(a,b){var d,c,e;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}d=TP.elementGetLocalName(a).toLowerCase();if(d!=='textarea'&&(d!=='input'||a.type!=='text')){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isString(b)){return TP.raise(this,'TP.sig.InvalidString',arguments);}try{c=a.selectionStart;e=a.selectionEnd;a.value=TP.join(a.value.substring(0,c),b,a.value.substring(e));a.setSelectionRange(c+b.length,c+b.length);}catch(a){return TP.raise(this,'TP.sig.DOMComponentException',arguments,TP.ec(a));}return;});TP.definePrimitive('nodeGetWindow',function(a){var b;if(a===null){return;}if(a.nodeType===Node.DOCUMENT_NODE){return a.defaultView;}if(TP.isDocument(b=a.ownerDocument)){return b.defaultView;}return;});TP.definePrimitive('nodeHasWindow',function(a){if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}return TP.isWindow(TP.nodeGetWindow(a));});TP.definePrimitive('windowArmEvents',function(c,b,h){var a,d,e,f,g;if(!TP.isWindow(c)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidArray',arguments);}g=TP.ifInvalid(h,TP.$dispatchEventToTIBET);d=b.getSize();for(a=0;a<d;a++){e=b.at(a);f=TP.eventNameNativeValue(e);c.document.addEventListener(f,g,false);}return;});TP.definePrimitive('windowConstructObject',function(aWindow,objectName){var constructorObj,$$newinst;if(!TP.isWindow(aWindow)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}constructorObj=aWindow[objectName];if(TP.notValid(constructorObj)){return null;}switch(arguments.length){case 2:$$newinst=new constructorObj();break;case 3:$$newinst=new constructorObj(arguments[2]);break;case 4:$$newinst=new constructorObj(arguments[2],arguments[3]);break;case 5:$$newinst=new constructorObj(arguments[2],arguments[3],arguments[4]);break;case 6:$$newinst=new constructorObj(arguments[2],arguments[3],arguments[4],arguments[5]);break;case 7:$$newinst=new constructorObj(arguments[2],arguments[3],arguments[4],arguments[5],arguments[6]);break;case 8:$$newinst=new constructorObj(arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7]);break;case 9:$$newinst=new constructorObj(arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7],arguments[8]);break;default:eval('$$newinst = new constructorObj('+TP.sys.$buildArgString(2,arguments.length)+');');break;}return $$newinst;});TP.definePrimitive('windowDisarmEvents',function(c,b,h){var a,d,e,f,g;if(!TP.isWindow(c)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidArray',arguments);}g=TP.ifInvalid(h,TP.$dispatchEventToTIBET);d=b.getSize();for(a=0;a<d;a++){e=b.at(a);f=TP.eventNameNativeValue(e);c.document.removeEventListener(f,g,false);}return;});TP.definePrimitive('windowGetInnerHeight',function(a){if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}return a.innerHeight;});TP.definePrimitive('windowGetInnerWidth',function(a){if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}return a.innerWidth;});TP.definePrimitive('windowGetOuterHeight',function(a){if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}return a.outerHeight;});TP.definePrimitive('windowGetOuterWidth',function(a){if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}return a.outerWidth;});TP.definePrimitive('windowGetX',function(a){if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}return a.screenX;});TP.definePrimitive('windowGetY',function(a){if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}return a.screenY;});TP.definePrimitive('windowInstallOnlineOfflineHook',function(b){var a;if(!TP.isWindow(b)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(!TP.isElement(a=TP.documentGetBody(b.document))){return TP.raise(this,'TP.sig.InvalidElement',arguments);}a.addEventListener('online',function(){TP.sys.isOffline(false);TP.signal(null,'TP.sig.AppOnline',arguments);},false);a.addEventListener('offline',function(){TP.sys.isOffline(true);TP.signal(null,'TP.sig.AppOffline',arguments);},false);return;});TP.definePrimitive('windowInstallDocumentVisibilityHook',function(c){var a,b;if(!TP.isWindow(c)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(!TP.isDocument(a=c.document)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isDefined(a.mozHidden)){b='mozvisibilitychange';}else if(TP.isDefined(a.webkitHidden)){b='webkitvisibilitychange';}else if(TP.isDefined(a.msHidden)){b='msvisibilitychange';}else{b='visibilitychange';}a.addEventListener(b,function(){if(TP.documentIsVisible(a)){TP.signal(null,'TP.sig.DocumentVisible',arguments,TP.documentGetVisibility(a));}else{TP.signal(null,'TP.sig.DocumentInvisible',arguments,TP.documentGetVisibility(a));}},false);return;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETDHTMLPrimitivesPlatform.js';
TP.definePrimitive('documentCreateIFrameElement',TP.hc('test','webkit','true',function(b,g,d){var e,a,c,f;if(!TP.isDocument(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.isString(g)){e=g;}else{if(TP.isHTMLDocument(b)){e=TP.ietf.Mime.HTML;}else{e=TP.ietf.Mime.XHTML;}}if(e===TP.ietf.Mime.HTML){a=TP.documentCreateElement(b,'iframe',TP.w3.Xmlns.XHTML);TP.elementSetAttribute(a,'frameborder',0);if(TP.isString(d)){TP.elementSetAttribute(a,'id',d);}TP.nodeAppendChild(TP.documentGetBody(b),a,false);c=TP.elementGetIFrameDocument(a);c.open();c.write('<html><head><meta http-equiv="X-UA-Compatible" content="IE=9" /></head><body></body></html>');c.close();}else{a=TP.documentCreateElement(b,'span',TP.w3.Xmlns.XHTML);TP.nodeAppendChild(TP.documentGetBody(b),a,false);TP.regex.INVALID_ID_CHARS.lastIndex=0;f=TP.isString(d)?d:TP.genID('html_object').replace(TP.regex.INVALID_ID_CHARS,'_');a.outerHTML='<object id="'+f+'" type="application/xhtml+xml" data="data:application/xhtml+xml,&lt;?xml version=&quot;1.0&quot;?&gt;&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;"><p>Couldn\'t create XHTML iframe...</p></object>';a=TP.nodeGetElementById(b,f);c=TP.elementGetIFrameDocument(a);a.contentWindow=c.defaultView;if(TP.isString(d)){TP.nodeGetWindow(b).frames[d]=c.defaultView;}}return a;},TP.DEFAULT,function(b,f,d){var e,a,c;if(!TP.isDocument(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.isString(f)){e=f;}else{if(TP.isHTMLDocument(b)){e=TP.ietf.Mime.HTML;}else{e=TP.ietf.Mime.XHTML;}}if(e===TP.ietf.Mime.HTML){a=TP.documentCreateElement(b,'iframe',TP.w3.Xmlns.XHTML);TP.elementSetAttribute(a,'frameborder',0);if(TP.isString(d)){TP.elementSetAttribute(a,'id',d);}TP.nodeAppendChild(TP.documentGetBody(b),a,false);c=TP.elementGetIFrameDocument(a);c.open();c.write('<html><head><meta http-equiv="X-UA-Compatible" content="IE=9" /></head><body></body></html>');c.close();}else{a=TP.documentCreateElement(b,'object',TP.w3.Xmlns.XHTML);if(TP.isString(d)){TP.elementSetAttribute(a,'id',d);}TP.elementSetAttribute(a,'type',TP.XHTML_ENCODED);TP.elementSetAttribute(a,'data','data:application/xhtml+xml,<?xml version="1.0"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><body></body></html>');TP.nodeAppendChild(TP.documentGetBody(b),a,false);c=TP.elementGetIFrameDocument(a);a.contentWindow=c.defaultView;if(TP.isString(d)){TP.nodeGetWindow(b).frames[d]=c.defaultView;}}return a;}));TP.definePrimitive('documentCreateEvent',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(g,e){var a,d,c,b,f;if(TP.isEvent(e)){a=e;a.at=function(a){return this[a];};}else if(TP.isValid(e)){a=TP.hc(e);}else{a=TP.hc();}d=TP.ifInvalid(g,TP.sys.getUICanvas().getNativeDocument());c=TP.ifKeyInvalid(a,'type');switch(c){case'abort':case'blur':case'change':case'error':case'focus':case'load':case'reset':case'resize':case'scroll':case'select':case'submit':case'unload':b=d.createEvent('HTMLEvents');b.initEvent(c,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true));break;case'focusin':case'focusout':b=d.createEvent('UIEvents');b.initUIEvent(c,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true),TP.ifKeyInvalid(a,'view',TP.sys.getUICanvas(true)),TP.ifKeyInvalid(a,'detail',0));break;case'keydown':case'keypress':case'keyup':b=d.createEvent('KeyboardEvent');f=((a.at('ctrlKey')?'Control':'')+(a.at('shiftKey')?' Shift':'')+(a.at('altKey')?' Alt':'')+(a.at('metaKey')?' Meta':'')).trim();b.initKeyboardEvent(c,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true),TP.ifKeyInvalid(a,'view',TP.sys.getUICanvas(true)),TP.ifKeyInvalid(a,'char',null),TP.ifKeyInvalid(a,'key',null),TP.ifKeyInvalid(a,'location',null),f,TP.ifKeyInvalid(a,'repeat',0),TP.ifKeyInvalid(a,'locale',0));break;case'click':case'dblclick':case'mousedown':case'mouseenter':case'mousemove':case'mouseleave':case'mouseout':case'mouseover':case'mouseup':b=d.createEvent('MouseEvents');b.initMouseEvent(c,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true),TP.ifKeyInvalid(a,'view',TP.sys.getUICanvas(true)),TP.ifKeyInvalid(a,'detail',0),TP.ifKeyInvalid(a,'screenX',0),TP.ifKeyInvalid(a,'screenY',0),TP.ifKeyInvalid(a,'clientX',0),TP.ifKeyInvalid(a,'clientY',0),TP.ifKeyInvalid(a,'ctrlKey',false),TP.ifKeyInvalid(a,'altKey',false),TP.ifKeyInvalid(a,'shiftKey',false),TP.ifKeyInvalid(a,'metaKey',false),TP.ifKeyInvalid(a,'button',0),TP.ifKeyInvalid(a,'relatedTarget',null));b.$$pageX=TP.ifKeyInvalid(a,'pageX',0);b.$$pageY=TP.ifKeyInvalid(a,'pageY',0);b.$$offsetX=TP.ifKeyInvalid(a,'offsetX',0);b.$$offsetY=TP.ifKeyInvalid(a,'offsetY',0);break;case'DOMMouseScroll':b=d.createEvent('MouseScrollEvents');b.initMouseScrollEvent(c,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true),TP.ifKeyInvalid(a,'view',TP.sys.getUICanvas(true)),TP.ifKeyInvalid(a,'detail',0),TP.ifKeyInvalid(a,'screenX',0),TP.ifKeyInvalid(a,'screenY',0),TP.ifKeyInvalid(a,'clientX',0),TP.ifKeyInvalid(a,'clientY',0),TP.ifKeyInvalid(a,'ctrlKey',false),TP.ifKeyInvalid(a,'altKey',false),TP.ifKeyInvalid(a,'shiftKey',false),TP.ifKeyInvalid(a,'metaKey',false),TP.ifKeyInvalid(a,'button',0),TP.ifKeyInvalid(a,'relatedTarget',null),TP.ifKeyInvalid(a,'axis',2));b.$$pageX=TP.ifKeyInvalid(a,'pageX',0);b.$$pageY=TP.ifKeyInvalid(a,'pageY',0);b.$$offsetX=TP.ifKeyInvalid(a,'offsetX',0);b.$$offsetY=TP.ifKeyInvalid(a,'offsetY',0);break;case'DOMAttrModified':case'DOMNodeInserted':case'DOMNodeRemoved':case'DOMCharacterDataModified':case'DOMNodeInsertedIntoDocument':case'DOMNodeRemovedFromDocument':case'DOMSubtreeModified':b=d.createEvent('MutationEvents');b.initMutationEvent(c,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true),TP.ifKeyInvalid(a,'relatedTarget',null),TP.ifKeyInvalid(a,'prevValue',null),TP.ifKeyInvalid(a,'newValue',null),TP.ifKeyInvalid(a,'attrName',null),TP.ifKeyInvalid(a,'attrChange',null));break;default:b=d.createEvent('Events');b.initEvent(c,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true));TP.keys(a).perform(function(c){if(TP.W3C_EVENT_PROPERTIES.test(c)||TP.EXTRA_EVENT_PROPERTIES.test(c)){return;}b[c]=a.at(c);});break;}TP.TIBET_EVENT_PROPERTIES.perform(function(c){try{b[c]=a.at(c.slice(2));}catch(a){}});return b;},'trident',function(g,e){var a,c,d,b,f;if(TP.isEvent(e)){a=e;a.at=function(a){return this[a];};}else if(TP.isValid(e)){a=TP.hc(e);}else{a=TP.hc();}c=TP.ifInvalid(g,TP.sys.getUICanvas().getNativeDocument());d=TP.ifKeyInvalid(a,'type');switch(d){case'abort':case'blur':case'change':case'error':case'focus':case'load':case'reset':case'resize':case'scroll':case'select':case'submit':case'unload':b=c.createEvent('HTMLEvents');b.initEvent(d,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true));break;case'focusin':case'focusout':b=c.createEvent('UIEvents');b.initUIEvent(d,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true),TP.ifKeyInvalid(a,'view',TP.sys.getUICanvas(true)),TP.ifKeyInvalid(a,'detail',0));break;case'keydown':case'keypress':case'keyup':b=c.createEvent('KeyboardEvent');f=((a.at('ctrlKey')?'Control':'')+(a.at('shiftKey')?' Shift':'')+(a.at('altKey')?' Alt':'')+(a.at('metaKey')?' Meta':'')).trim();b.initKeyboardEvent(d,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true),TP.ifKeyInvalid(a,'view',TP.sys.getUICanvas(true)),TP.ifKeyInvalid(a,'key',null),TP.ifKeyInvalid(a,'location',null),f,TP.ifKeyInvalid(a,'repeat',0),TP.ifKeyInvalid(a,'locale',0));break;case'click':case'dblclick':case'mousedown':case'mouseenter':case'mousemove':case'mouseleave':case'mouseout':case'mouseover':case'mouseup':b=c.createEvent('MouseEvents');b.initMouseEvent(d,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true),TP.ifKeyInvalid(a,'view',TP.sys.getUICanvas(true)),TP.ifKeyInvalid(a,'detail',0),TP.ifKeyInvalid(a,'screenX',0),TP.ifKeyInvalid(a,'screenY',0),TP.ifKeyInvalid(a,'clientX',0),TP.ifKeyInvalid(a,'clientY',0),TP.ifKeyInvalid(a,'ctrlKey',false),TP.ifKeyInvalid(a,'altKey',false),TP.ifKeyInvalid(a,'shiftKey',false),TP.ifKeyInvalid(a,'metaKey',false),TP.ifKeyInvalid(a,'button',0),TP.ifKeyInvalid(a,'relatedTarget',null));b.pageX=TP.ifKeyInvalid(a,'pageX',0);b.pageY=TP.ifKeyInvalid(a,'pageY',0);b.offsetX=TP.ifKeyInvalid(a,'offsetX',0);b.offsetY=TP.ifKeyInvalid(a,'offsetY',0);break;case'mousewheel':b=c.createEvent('WheelEvent');b.initWheelEvent(TP.ifKeyInvalid(a,'wheelDeltaX',0),TP.ifKeyInvalid(a,'wheelDeltaY',0),TP.ifKeyInvalid(a,'view',TP.sys.getUICanvas(true)),TP.ifKeyInvalid(a,'screenX',0),TP.ifKeyInvalid(a,'screenY',0),TP.ifKeyInvalid(a,'clientX',0),TP.ifKeyInvalid(a,'clientY',0),TP.ifKeyInvalid(a,'ctrlKey',false),TP.ifKeyInvalid(a,'altKey',false),TP.ifKeyInvalid(a,'shiftKey',false),TP.ifKeyInvalid(a,'metaKey',false));b.pageX=TP.ifKeyInvalid(a,'pageX',0);b.pageY=TP.ifKeyInvalid(a,'pageY',0);b.offsetX=TP.ifKeyInvalid(a,'offsetX',0);b.offsetY=TP.ifKeyInvalid(a,'offsetY',0);break;case'DOMAttrModified':case'DOMNodeInserted':case'DOMNodeRemoved':case'DOMCharacterDataModified':case'DOMNodeInsertedIntoDocument':case'DOMNodeRemovedFromDocument':case'DOMSubtreeModified':b=c.createEvent('MutationEvents');b.initMutationEvent(d,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true),TP.ifKeyInvalid(a,'relatedTarget',null),TP.ifKeyInvalid(a,'prevValue',null),TP.ifKeyInvalid(a,'newValue',null),TP.ifKeyInvalid(a,'attrName',null),TP.ifKeyInvalid(a,'attrChange',null));break;default:b=c.createEvent('Events');b.initEvent(d,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true));TP.keys(a).perform(function(c){if(TP.W3C_EVENT_PROPERTIES.test(c)||TP.EXTRA_EVENT_PROPERTIES.test(c)){return;}b[c]=a.at(c);});break;}TP.TIBET_EVENT_PROPERTIES.perform(function(c){try{b[c]=a.at(c.slice(2));}catch(a){}});return b;},'webkit',function(f,e){var a,c,d,b;if(TP.isEvent(e)){a=e;a.at=function(a){return this[a];};}else if(TP.isValid(e)){a=TP.hc(e);}else{a=TP.hc();}c=TP.ifInvalid(f,TP.sys.getUICanvas().getNativeDocument());d=TP.ifKeyInvalid(a,'type');switch(d){case'abort':case'blur':case'change':case'error':case'focus':case'load':case'reset':case'resize':case'scroll':case'select':case'submit':case'unload':b=c.createEvent('HTMLEvents');b.initEvent(d,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true));break;case'focusin':case'focusout':b=c.createEvent('UIEvents');b.initUIEvent(d,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true),TP.ifKeyInvalid(a,'view',TP.sys.getUICanvas(true)),TP.ifKeyInvalid(a,'detail',0));break;case'keydown':case'keypress':case'keyup':b=c.createEvent('KeyboardEvent');b.initKeyboardEvent(d,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true),TP.ifKeyInvalid(a,'view',TP.sys.getUICanvas(true)),TP.ifKeyInvalid(a,'key',false),TP.ifKeyInvalid(a,'location',false),TP.ifKeyInvalid(a,'ctrlKey',false),TP.ifKeyInvalid(a,'altKey',false),TP.ifKeyInvalid(a,'shiftKey',false),TP.ifKeyInvalid(a,'metaKey',false));break;case'click':case'dblclick':case'mousedown':case'mouseenter':case'mousemove':case'mouseleave':case'mouseout':case'mouseover':case'mouseup':b=c.createEvent('MouseEvents');b.initMouseEvent(d,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true),TP.ifKeyInvalid(a,'view',TP.sys.getUICanvas(true)),TP.ifKeyInvalid(a,'detail',0),TP.ifKeyInvalid(a,'screenX',0),TP.ifKeyInvalid(a,'screenY',0),TP.ifKeyInvalid(a,'clientX',0),TP.ifKeyInvalid(a,'clientY',0),TP.ifKeyInvalid(a,'ctrlKey',false),TP.ifKeyInvalid(a,'altKey',false),TP.ifKeyInvalid(a,'shiftKey',false),TP.ifKeyInvalid(a,'metaKey',false),TP.ifKeyInvalid(a,'button',0),TP.ifKeyInvalid(a,'relatedTarget',null));b.pageX=TP.ifKeyInvalid(a,'pageX',0);b.pageY=TP.ifKeyInvalid(a,'pageY',0);b.offsetX=TP.ifKeyInvalid(a,'offsetX',0);b.offsetY=TP.ifKeyInvalid(a,'offsetY',0);break;case'mousewheel':b=c.createEvent('WheelEvent');b.initWheelEvent(TP.ifKeyInvalid(a,'wheelDeltaX',0),TP.ifKeyInvalid(a,'wheelDeltaY',0),TP.ifKeyInvalid(a,'view',TP.sys.getUICanvas(true)),TP.ifKeyInvalid(a,'screenX',0),TP.ifKeyInvalid(a,'screenY',0),TP.ifKeyInvalid(a,'clientX',0),TP.ifKeyInvalid(a,'clientY',0),TP.ifKeyInvalid(a,'ctrlKey',false),TP.ifKeyInvalid(a,'altKey',false),TP.ifKeyInvalid(a,'shiftKey',false),TP.ifKeyInvalid(a,'metaKey',false));b.pageX=TP.ifKeyInvalid(a,'pageX',0);b.pageY=TP.ifKeyInvalid(a,'pageY',0);b.offsetX=TP.ifKeyInvalid(a,'offsetX',0);b.offsetY=TP.ifKeyInvalid(a,'offsetY',0);break;case'DOMAttrModified':case'DOMNodeInserted':case'DOMNodeRemoved':case'DOMCharacterDataModified':case'DOMNodeInsertedIntoDocument':case'DOMNodeRemovedFromDocument':case'DOMSubtreeModified':b=c.createEvent('MutationEvents');b.initMutationEvent(d,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true),TP.ifKeyInvalid(a,'relatedTarget',null),TP.ifKeyInvalid(a,'prevValue',null),TP.ifKeyInvalid(a,'newValue',null),TP.ifKeyInvalid(a,'attrName',null),TP.ifKeyInvalid(a,'attrChange',null));break;default:b=c.createEvent('Events');b.initEvent(d,TP.ifKeyInvalid(a,'bubbles',true),TP.ifKeyInvalid(a,'cancelable',true));TP.keys(a).perform(function(c){if(TP.W3C_EVENT_PROPERTIES.test(c)||TP.EXTRA_EVENT_PROPERTIES.test(c)){return;}b[c]=a.at(c);});break;}TP.TIBET_EVENT_PROPERTIES.perform(function(c){try{b[c]=a.at(c.slice(2));}catch(a){}});return b;}));TP.definePrimitive('documentCreateScriptElement',TP.hc('test','trident','true',function(b,c,d,e){var a,f;if(!TP.isHTMLDocument(b)&&!TP.isXHTMLDocument(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}a=b.createElement('script');TP.elementSetAttribute(a,'type',TP.JS_TEXT_ENCODED);TP.elementSetAttribute(a,'charset',TP.UTF8);TP.elementSetAttribute(a,'async',false);if(TP.notEmpty(c)){TP.elementSetAttribute(a,'src',c);}else if(TP.notEmpty(d)){f=b.createTextNode(d);a.appendChild(f);}if(TP.isCallable(e)){a.onreadystatechange=function(){if(a.readyState==='loaded'||a.readyState==='complete'){e();}};}return a;},TP.DEFAULT,function(b,c,d,e){var a,f;if(!TP.isHTMLDocument(b)&&!TP.isXHTMLDocument(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}a=TP.documentCreateElement(b,'script',TP.w3.Xmlns.XHTML);TP.elementSetAttribute(a,'type',TP.JS_TEXT_ENCODED);TP.elementSetAttribute(a,'charset',TP.UTF8);TP.elementSetAttribute(a,'async',false);if(TP.notEmpty(c)){TP.elementSetAttribute(a,'src',c);}else if(TP.notEmpty(d)){f=b.createTextNode(d);a.appendChild(f);}if(TP.isCallable(e)){a.onload=e;}return a;}));TP.definePrimitive('$$buildTableDOM',TP.hc('test','trident','true',function(d,f,c,g){var a,e,b;a=f.createElement('div');e=TP.ifInvalid(g,true);switch(d){case'table':if(e){a.innerHTML=TP.join('<table>',c,'</table>');b=a.firstChild;}else{a.innerHTML=c;b=a;}break;case'thead':case'tbody':case'tfoot':if(e){a.innerHTML=TP.join('<table><',d,'>',c,'</',d,'></table>');b=a.firstChild.firstChild;}else{a.innerHTML=TP.join('<table>',c,'</table>');b=a.firstChild;}break;case'th':case'tr':if(e){a.innerHTML=TP.join('<table><tbody><',d,'>',c,'</',d,'></tbody></table>');b=a.firstChild.firstChild.firstChild;}else{a.innerHTML=TP.join('<table><tbody>',c,'</tbody></table>');b=a.firstChild.firstChild;}break;case'td':if(e){a.innerHTML=TP.join('<table><tbody><tr><td>',c,'<td></tr></tbody></table>');b=a.firstChild.firstChild.firstChild.firstChild;}else{a.innerHTML=TP.join('<table><tbody><tr>',c,'</tr></tbody></table>');b=a.firstChild.firstChild.firstChild;}break;}return b;},TP.DEFAULT,function(a,b,c,d){return;}));TP.definePrimitive('elementDisableUserSelect',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}TP.elementGetStyleObj(a).MozUserSelect='none';return;},'trident',function(a){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}TP.elementGetStyleObj(a).msUserSelect='none';return;},'webkit',function(a){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}TP.elementGetStyleObj(a).WebkitUserSelect='none';return;}));TP.definePrimitive('elementEnableUserSelect',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}TP.elementGetStyleObj(a).MozUserSelect='text';return;},'trident',function(a){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}TP.elementGetStyleObj(a).msUserSelect='text';return;},'webkit',function(a){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}TP.elementGetStyleObj(a).WebkitUserSelect='text';return;}));TP.definePrimitive('elementGetBorderInPixels',TP.hc('test','trident','true',function(a,d,c){var e,b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}b=0;try{if(TP.isEmpty(d)){e=TP.elementGetStyleValuesInPixels(a,TP.ac('borderTopWidth','borderRightWidth','borderBottomWidth','borderLeftWidth'),c);return e;}switch(d){case TP.TOP:b=TP.elementGetStyleValueInPixels(a,'borderTopWidth',c);break;case TP.RIGHT:b=TP.elementGetStyleValueInPixels(a,'borderRightWidth',c);break;case TP.BOTTOM:b=TP.elementGetStyleValueInPixels(a,'borderBottomWidth',c);break;case TP.LEFT:b=TP.elementGetStyleValueInPixels(a,'borderLeftWidth',c);break;}}catch(a){}return b;},TP.DEFAULT,function(d,e,g){var f,a,b,c;if(!TP.isElement(d)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}f=TP.elementGetComputedStyleObj(d);a=function(b){var a;a=f.getPropertyCSSValue(b).getFloatValue(CSSPrimitiveValue.CSS_PX);if(TP.isTrue(g)){a=TP.elementTransformCSSPixelValue(d,a,b.asDOMName());}return a;};b=0;try{if(TP.isEmpty(e)){c=TP.ac();c.push(a('border-top-width'));c.push(a('border-right-width'));c.push(a('border-left-width'));c.push(a('border-bottom-width'));return c;}switch(e){case TP.TOP:b=a('border-top-width');break;case TP.RIGHT:b=a('border-right-width');break;case TP.BOTTOM:b=a('border-bottom-width');break;case TP.LEFT:b=a('border-left-width');break;}}catch(a){}return b;}));TP.definePrimitive('elementGetMarginInPixels',TP.hc('test','trident','true',function(a,d,c){var b,e;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(d)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}b=0;try{if(TP.isEmpty(d)){e=TP.elementGetStyleValuesInPixels(a,TP.ac('marginTop','marginRight','marginBottom','marginLeft'),c);return e;}switch(d){case TP.TOP:b=TP.elementGetStyleValueInPixels(a,'marginTop',c);break;case TP.RIGHT:b=TP.elementGetStyleValueInPixels(a,'marginRight',c);break;case TP.BOTTOM:b=TP.elementGetStyleValueInPixels(a,'marginBottom',c);break;case TP.LEFT:b=TP.elementGetStyleValueInPixels(a,'marginLeft',c);break;}}catch(a){}return b;},TP.DEFAULT,function(d,e,g){var f,a,b,c;if(!TP.isElement(d)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(e)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}f=TP.elementGetComputedStyleObj(d);a=function(b){var a;a=f.getPropertyCSSValue(b).getFloatValue(CSSPrimitiveValue.CSS_PX);if(TP.isTrue(g)){a=TP.elementTransformCSSPixelValue(d,a,b.asDOMName());}return a;};b=0;try{if(TP.isEmpty(e)){c=TP.ac();c.push(a('margin-top'));c.push(a('margin-right'));c.push(a('margin-left'));c.push(a('margin-bottom'));return c;}switch(e){case TP.TOP:b=a('margin-top');break;case TP.RIGHT:b=a('margin-right');break;case TP.BOTTOM:b=a('margin-bottom');break;case TP.LEFT:b=a('margin-left');break;}}catch(a){}return b;}));TP.definePrimitive('elementGetOffsetParent',TP.hc('test','trident','true',function(a){return a.offsetParent;},TP.DEFAULT,function(a){var e,b,c,d;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}e=TP.elementGetComputedStyleObj(a).position;b=/(fixed|absolute)/.test(e);c=TP.nodeGetDocument(a);d=TP.nodeDetectAncestor(a,function(a){var d;d=TP.elementGetComputedStyleObj(a).position;b=b&&d==='static'&&a!==c.documentElement&&a!==TP.documentGetBody(c);if(!b&&(TP.elementContentIsScrolled(a)||/(fixed|absolute)/.test(d))){return a;}});if(TP.notValid(d)){return a.parentNode;}return d;}));TP.definePrimitive('elementGetPaddingInPixels',TP.hc('test','trident','true',function(a,d,c){var b,e;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(d)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}b=0;try{if(TP.isEmpty(d)){e=TP.elementGetStyleValuesInPixels(a,TP.ac('paddingTop','paddingRight','paddingBottom','paddingLeft'),c);return e;}switch(d){case TP.TOP:b=TP.elementGetStyleValueInPixels(a,'paddingTop',c);break;case TP.RIGHT:b=TP.elementGetStyleValueInPixels(a,'paddingRight',c);break;case TP.BOTTOM:b=TP.elementGetStyleValueInPixels(a,'paddingBottom',c);break;case TP.LEFT:b=TP.elementGetStyleValueInPixels(a,'paddingLeft',c);break;}}catch(a){}return b;},TP.DEFAULT,function(d,e,g){var f,a,b,c;if(!TP.isElement(d)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(e)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}f=TP.elementGetComputedStyleObj(d);a=function(b){var a;a=f.getPropertyCSSValue(b).getFloatValue(CSSPrimitiveValue.CSS_PX);if(TP.isTrue(g)){a=TP.elementTransformCSSPixelValue(d,a,b.asDOMName());}return a;};b=0;try{if(TP.isEmpty(e)){c=TP.ac();c.push(a('padding-top'));c.push(a('padding-right'));c.push(a('padding-left'));c.push(a('padding-bottom'));return c;}switch(e){case TP.TOP:b=a('padding-top');break;case TP.RIGHT:b=a('padding-right');break;case TP.BOTTOM:b=a('padding-bottom');break;case TP.LEFT:b=a('padding-left');break;}}catch(a){}return b;}));TP.definePrimitive('elementGetTransformMatrix',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a,d){var b,c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isValid(b=TP.elementGetComputedStyleObj(a).MozTransform)){c=TP.matrixFromCSSString(b,d);}return c;},'trident',function(a,d){var b,c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isValid(b=TP.elementGetComputedStyleObj(a).msTransform)){c=TP.matrixFromCSSString(b,d);}return c;},'webkit',function(a,d){var b,c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isValid(b=TP.elementGetComputedStyleObj(a).WebkitTransform)){c=TP.matrixFromCSSString(b,d);}return c;}));TP.definePrimitive('elementGlobalToLocalXY',TP.hc('test','webkit','true',function(a,c,d){var b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}b=TP.nodeGetWindow(a).webkitConvertPointFromPageToNode(a,new WebKitPoint(c,d));return TP.ac(parseFloat((b.x||0).toFixed(1)),parseFloat((b.y||0).toFixed(1)));},TP.DEFAULT,function(b,d,e){var c,a,f,g;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}c=TP.nodeGetWindow(b);a=TP.translateMatrix(TP.elementGetComputedTransformMatrix(b),c.pageXOffset,c.pageYOffset,0);f=((d-a[0][3])*a[1][1]-(e-a[1][3])*a[0][1])/(a[0][0]*a[1][1]-a[0][1]*a[1][0]);g=(a[0][0]*(e-a[1][3])-a[1][0]*(d-a[0][3]))/(a[0][0]*a[1][1]-a[0][1]*a[1][0]);return TP.ac(parseFloat((f||0).toFixed(1)),parseFloat((g||0).toFixed(1)));}));TP.definePrimitive('elementLocalToGlobalXY',TP.hc('test','webkit','true',function(a,c,d){var b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}b=TP.nodeGetWindow(a).webkitConvertPointFromNodeToPage(a,new WebKitPoint(c,d));return TP.ac(parseFloat((b.x||0).toFixed(1)),parseFloat((b.y||0).toFixed(1)));},TP.DEFAULT,function(a,b,c){TP.raise(this,'TP.sig.UnsupportedOperation',arguments);return TP.ac();}));TP.definePrimitive('elementSetTransform',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a,b){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}TP.elementGetStyleObj(a).MozTransform=b;return;},'trident',function(a,b){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}TP.elementGetStyleObj(a).msTransform=b;return;},'webkit',function(a,b){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}TP.elementGetStyleObj(a).WebkitTransform=b;return;}));TP.definePrimitive('elementSetTransformOrigin',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(c,a,b){var d,e;if(!TP.isElement(c)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}d=TP.isNumber(a)?a+'px':a;e=TP.isNumber(b)?b+'px':b;TP.elementGetStyleObj(c).MozTransformOrigin=TP.join(d,' ',e);return;},'trident',function(c,a,b){var d,e;if(!TP.isElement(c)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}d=TP.isNumber(a)?a+'px':a;e=TP.isNumber(b)?b+'px':b;TP.elementGetStyleObj(c).msTransformOrigin=TP.join(d,' ',e);return;},'webkit',function(c,a,b){var d,e;if(!TP.isElement(c)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}d=TP.isNumber(a)?a+'px':a;e=TP.isNumber(b)?b+'px':b;TP.elementGetStyleObj(c).WebkitTransformOrigin=TP.join(d,' ',e);return;}));TP.definePrimitive('windowBuildFunctionFor',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(b,a){return a;},'trident',function(aWindow,aFunction){if(!TP.isWindow(aWindow)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(!TP.isCallable(aFunction)){return TP.raise(this,'TP.sig.InvalidFunction',arguments);}eval('aWindow.$$newinst = function () {window.$$newinst.$realFunc('+TP.sys.$buildArgString(0,aFunction.getArity()-1)+')}');aWindow.$$newinst.$realFunc=aFunction;return aWindow.$$newinst;},'webkit',function(b,a){return a;}));TP.definePrimitive('windowConstructObject',TP.hc('test','trident','true',function(aWindow,objectName){if(!TP.isWindow(aWindow)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}aWindow.creationArgs=arguments;switch(arguments.length){case 2:eval('aWindow.$$newinst = new '+objectName+'()');break;case 3:eval('aWindow.$$newinst = new '+objectName+'(window.creationArgs[2])');break;case 4:eval('aWindow.$$newinst = new '+objectName+'(window.creationArgs[2], window.creationArgs[3])');break;case 5:eval('aWindow.$$newinst = new '+objectName+'(window.creationArgs[2], window.creationArgs[3], window.creationArgs[4])');break;case 6:eval('aWindow.$$newinst = new '+objectName+'(window.creationArgs[2], window.creationArgs[3], window.creationArgs[4], window.creationArgs[5])');break;case 7:eval('aWindow.$$newinst = new '+objectName+'(window.creationArgs[2], window.creationArgs[3], window.creationArgs[4], window.creationArgs[5], window.creationArgs[6])');break;case 8:eval('aWindow.$$newinst = new '+objectName+'(window.creationArgs[2], window.creationArgs[3], window.creationArgs[4], window.creationArgs[5], window.creationArgs[6], window.creationArgs[7])');break;case 9:eval('aWindow.$$newinst = new '+objectName+'(window.creationArgs[2], window.creationArgs[3], window.creationArgs[4], window.creationArgs[5], window.creationArgs[6], window.creationArgs[7], window.creationArgs[8])');break;default:eval('aWindow.$$newinst = new '+objectName+'('+TP.sys.$buildArgString(2,arguments.length,'window.creationArgs')+')');break;}aWindow.creationArgs=null;return aWindow.$$newinst;},TP.DEFAULT,function(aWindow,objectName){var constructorObj,$$newinst;if(!TP.isWindow(aWindow)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}constructorObj=aWindow[objectName];if(TP.notValid(constructorObj)){return null;}switch(arguments.length){case 2:$$newinst=new constructorObj();break;case 3:$$newinst=new constructorObj(arguments[2]);break;case 4:$$newinst=new constructorObj(arguments[2],arguments[3]);break;case 5:$$newinst=new constructorObj(arguments[2],arguments[3],arguments[4]);break;case 6:$$newinst=new constructorObj(arguments[2],arguments[3],arguments[4],arguments[5]);break;case 7:$$newinst=new constructorObj(arguments[2],arguments[3],arguments[4],arguments[5],arguments[6]);break;case 8:$$newinst=new constructorObj(arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7]);break;case 9:$$newinst=new constructorObj(arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7],arguments[8]);break;default:eval('$$newinst = new constructorObj('+TP.sys.$buildArgString(2,arguments.length)+');');break;}return $$newinst;}));TP.definePrimitive('windowInstallOnBeforeUnloadHook',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a,b){if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(a.name!==top.name){return;}a.onbeforeunload=function(){if(TP.notValid(TP.documentGetBody(a.document))){return;}if(TP.elementGetAttribute(TP.documentGetBody(a.document),'allowUnload')==='true'){return;}return TP.join('You should use your application\'s Back/Exit ','features (if provided) to navigate or quit.\n\n','You may lose unsaved data if you click OK !');};},'trident',function(a,b){if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(a.name!==top.name){return;}a.attachEvent('onbeforeunload',function(){if(TP.notValid(TP.documentGetBody(a.document))){return;}if(TP.elementGetAttribute(TP.documentGetBody(a.document),'allowUnload')==='true'){return;}a.event.returnValue=TP.join('You should use your application\'s Back/Exit ','features (if provided) to navigate or quit.\n\n','You may lose unsaved data if you click OK !');return;});},'webkit',function(a,b){if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(a.name!==top.name){return;}a.onbeforeunload=function(){if(TP.notValid(TP.documentGetBody(a.document))){return;}if(TP.elementGetAttribute(TP.documentGetBody(a.document),'allowUnload')==='true'){return;}if(TP.$browser==='chrome'){return TP.join('You should use your application\'s Back/Exit ','features (if provided) to navigate or quit.\n\n','You may lose unsaved data if you click ','"Leave this page" !');}else{return TP.join('You should use your application\'s Back/Exit ','features (if provided) to navigate or quit.\n\n','You may lose unsaved data if you click "OK" !');}};return;}));TP.definePrimitive('windowStopLoading',TP.hc('test','trident','true',function(a){if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}return a.document.execCommand('Stop');},TP.DEFAULT,function(a){if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}return a.stop();}));
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETDHTMLPrimitivesPost.js';
TP.definePrimitive('computeCommonSizes',function(){var b,c,h,f,j,d,g,i,a,e;if(TP.notValid(TP.FONT_HEIGHTS)){TP.FONT_HEIGHTS=TP.hc('1em',0,'1ex',0,'100%',0,'12pt',0,'16px',0,'xx-small',0,'x-small',0,'small',0,'medium',0,'large',0,'x-large',0,'xx-large',0);b=document.createElement('div');TP.elementSetStyle(b,'position: absolute; top: 0px; left: -100px; '+'width: 30px; height: 1000em; '+'border: 0px; margin: 0px; padding: 0px; outline: 0px; '+'line-height: 1; overflow: hidden;');TP.nodeAppendChild(TP.documentGetBody(document),b,false);if(TP.boot.isUA('IE')){c=TP.elementGetStyleObj(document.documentElement);h=c.fontSize;c.fontSize='100%';}f=TP.keys(TP.FONT_HEIGHTS);j=f.getSize();i=TP.elementGetStyleObj(b);for(d=0;d<j;d++){g=f[d];i.fontSize=g;TP.FONT_HEIGHTS.atPut(g,Math.round(b.offsetHeight*12/16)*(16/12)/1000);}TP.nodeDetach(b);if(TP.boot.isUA('IE')){c.fontSize=h;}}if(TP.notValid(TP.SCROLLER_WIDTH)){a=document.createElement('div');TP.elementSetStyle(a,'position: absolute; top: -300px; left: 0px; '+'width: 100px; height: 100px; overflow: scroll;');e=document.createElement('div');TP.elementSetStyle(e,'width: 400px; height: 400px;');TP.nodeAppendChild(a,e,false);TP.nodeAppendChild(TP.documentGetBody(document),a,false);TP.SCROLLER_WIDTH=a.offsetWidth-a.clientWidth;TP.nodeDetach(a);}return;});TP.definePrimitive('getPixelsPerPoint',function(){var a;if(TP.notValid(a=TP.FONT_HEIGHTS.at('12pt'))){return 0;}return a/12;});TP.definePrimitive('documentEnsureHeadElement',function(a){var b;if(!TP.isDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}b=TP.nodeGetFirstElementByTagName(a,'head');if(TP.notValid(b)){b=TP.documentCreateElement(a,'head',TP.w3.Xmlns.XHTML);TP.nodeInsertBefore(a.documentElement,b,a.documentElement.firstChild,false);}return b;});TP.definePrimitive('documentFocusAutofocusedElement',function(a){var b;if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.isElement(b=TP.byCSS('*[autofocus]',a).first())){TP.wrap(b).focus();}return;});TP.definePrimitive('documentGetAllIFrames',function(d){var e,a,b,c;if(!TP.isHTMLDocument(d)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}e=TP.ac();a=TP.nodeGetElementsByTagName(d,'iframe');b=TP.nodeGetElementsByTagName(d,'object');b=b.select(function(a){return TP.isDocument(a.contentDocument);});a=a.concat(b);for(c=0;c<a.length;c++){e.addAll(TP.documentGetAllIFrames(TP.elementGetIFrameDocument(a[c])));}return e;});TP.definePrimitive('documentGetBody',function(a){if(!TP.isDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.isHTMLDocument(a)){return a.body;}return TP.nodeGetFirstElementByTagName(a,'body');});TP.definePrimitive('documentGetBodyContent',function(a){var b;if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}b=TP.nodeGetFirstElementByTagName(a,'body');if(TP.isElement(b)){return b.innerHTML;}return null;});TP.definePrimitive('documentGetHead',function(a){if(!TP.isDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}return TP.nodeGetFirstElementByTagName(a,'head');});TP.definePrimitive('documentGetHeadContent',function(a){var b;if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}b=TP.nodeGetFirstElementByTagName(a,'head');if(TP.isElement(b)){return b.innerHTML;}return null;});TP.definePrimitive('documentGetFocusedElement',function(a){var b;if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(!TP.isElement(b=a.activeElement)){if(!TP.isElement(b=TP.byCSS('*[pclass|focus]',a,true))){b=TP.documentGetBody(a);}}return b;});TP.definePrimitive('documentGetLinkFileNames',function(c){var d,e,f,a,b;if(!TP.isHTMLDocument(c)&&!TP.isXHTMLDocument(c)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}e=TP.nodeGetElementsByTagName(c,'a');f=e.getSize();d=TP.ac();for(a=0;a<f;a++){b=TP.elementGetAttribute(e[a],'href');if(TP.notEmpty(b)&&!TP.regex.JS_SCHEME.test(b)){d.push(b);}}return d;});TP.definePrimitive('documentGetTitleContent',function(a){var b;if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.isElement(b=a.getElementsByTagName('title')[0])){return b.text;}return null;});TP.definePrimitive('documentGetLocation',function(d,h){var b,e,f,c,a,g;c=TP.ifInvalid(h,false);if(!TP.isDocument(b=d)){b=TP.nodeGetDocument(d);if(TP.notValid(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}}if(TP.notValid(b.documentElement)){return'';}if(TP.notEmpty(a=TP.elementGetAttribute(b.documentElement,'tibet:src',true))){a=TP.uriExpandPath(a);}else if(TP.notTrue(c)&&TP.notEmpty(a=TP.elementGetAttribute(b.documentElement,'xml:base',true))){a=TP.uriExpandPath(a);}else if(TP.notTrue(c)&&TP.notEmpty(g=b.getElementsByTagName('base')[0])){a=TP.elementGetAttribute(g,'href');}if(TP.isEmpty(a)){if(TP.notValid(e=TP.nodeGetWindow(b))){return'';}a=e.location.toString();}if(a==='file:///'||a==='file://'){return'';}if(c){f=a.lastIndexOf('/');if(f!==TP.NOT_FOUND){a=a.slice(0,a.lastIndexOf('/'));}}a=a.strip(/^tibet:\/\/\//).strip(/#document$/);return decodeURI(a).chop('#');});TP.definePrimitive('documentGetPixelsForFontSize',function(b,e){var c,d,f,a;if(!TP.isHTMLDocument(b)&&!TP.isXHTMLDocument(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}c=0;if(TP.notValid(TP.FONT_HEIGHTS)){TP.FONT_HEIGHTS=TP.hc();}if(TP.notValid(c=TP.FONT_HEIGHTS.at(e))){if(TP.boot.isUA('IE')){d=TP.elementGetStyleObj(b.documentElement);f=d.fontSize;d.fontSize='100%';}a=b.createElement('div');TP.elementSetStyle(a,'position: absolute; top 0px; left: -100px; '+'width: 30px; height: 1000em; border: 0px; margin: 0px; '+'padding: 0px; outline: 0px; line-height: 1; '+'overflow: hidden;');TP.nodeAppendChild(TP.documentGetBody(b),a,false);TP.elementGetStyleObj(a).fontSize=e;c=Math.round(a.offsetHeight*12/16)*16/12/1000;TP.nodeDetach(a);TP.FONT_HEIGHTS.atPut(e,c);if(TP.boot.isUA('IE')){d.fontSize=f;}}return c;});TP.definePrimitive('documentGetScriptFileNames',function(e){var c,b,f,a,d;if(!TP.isDocument(e)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}b=TP.nodeGetElementsByTagName(e,'script');f=b.getSize();c=TP.ac();for(a=0;a<f;a++){d=TP.elementGetAttribute(b[a],'src')||TP.elementGetAttribute(b[a],'source');if(TP.notEmpty(d)){c.push(d);}}return c;});TP.definePrimitive('documentGetScriptNodes',function(a){if(!TP.isDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}return TP.nodeGetElementsByTagName(a,'script');});TP.definePrimitive('documentRewriteSpecialHacks',function(b){var a;if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidString',arguments);}a=b;a=a.replace(/_colon_/g,':');a=TP.$unescapeCSSConstructs(a);return a;});TP.definePrimitive('documentScrollBy',function(a,b,c){if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}TP.nodeGetWindow(a).scrollBy(b,c);return;});TP.definePrimitive('documentScrollTo',function(a,b,c){if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}TP.nodeGetWindow(a).scrollTo(b,c);return;});TP.definePrimitive('documentSetLocation',function(d,e,f){var b,c,a;if(!TP.isDocument(b=d)){b=TP.nodeGetDocument(d);if(TP.notValid(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}}c=e;if(TP.notValid(c)){return;}a=b.documentElement;if(TP.notValid(a)){return;}if((TP.elementHasAttribute(a,'tibet:src',true)||TP.elementHasAttribute(a,'xml:base',true))&&TP.notTrue(f)){return;}TP.elementSetAttributeInNS(a,'tibet:src',c,TP.w3.Xmlns.TIBET);return;});TP.definePrimitive('documentSetTitleContent',function(a,e){var c,d,b;if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(!TP.isString(c=e)){c='';}d=TP.documentEnsureHeadElement(a);b=TP.nodeGetFirstElementByTagName(a,'title');if(TP.notValid(b)){b=TP.documentCreateElement(a,'title',TP.w3.Xmlns.XHTML);TP.nodeAppendChild(d,b,false);}b.text=c;return;});TP.definePrimitive('htmlDocumentAddContent',function(a,e,b,c){var d;if(!TP.isHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.isElement(d=TP.documentGetBody(a))){return TP.htmlElementAddContent(d.theContent,b,c);}else{return TP.htmlElementAddContent(a.documentElement,e,b,c);}});TP.definePrimitive('htmlDocumentInsertContent',function(a,b,c,d,e){if(!TP.isHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}return TP.htmlElementInsertContent(a.documentElement,b,c,d,e);});TP.definePrimitive('htmlDocumentSetContent',function(c,m,k,l){var j,d,b,i,h,f,g,a,e;TP.debug('break.html_content');if(!TP.isHTMLDocument(c)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}j=TP.ifInvalid(l,TP.nodeHasWindow(c));d=TP.unwrap(m);if(TP.isHTMLNode(d)||TP.isXHTMLNode(d)){if(TP.isDocument(d)){b=d.documentElement;}else{b=d;}i=null;}else{i=TP.htmlstr(d);b=null;}if(TP.isNode(b)){if(TP.isElement(h=TP.nodeGetFirstElementChildByTagName(b,'head'))){f=b.getElementsByTagName('base')[0];g=TP.elementGetAttribute(TP.nodeGetDocument(b).documentElement,'xml:base',true);}else{h=TP.documentCreateElement(TP.nodeGetDocument(b),'head',TP.w3.Xmlns.XHTML);TP.nodeAppendChild(TP.nodeGetDocument(b).documentElement,h,false);f=null;g='';}if(TP.notValid(f)&&TP.notEmpty(g)){if(g.last()!=='/'){g+='/';}f=TP.documentCreateElement(TP.nodeGetDocument(b),'base',TP.w3.Xmlns.XHTML);TP.elementSetAttribute(f,'href',g);TP.nodeInsertBefore(h,f,h.firstChild,false);}a=TP.htmlstr(d);}else if(TP.isString(i)){a=i;}if(TP.boot.isUA('IE')){a=a.replace(/&apos;/g,'&#39;');}a=TP.documentRewriteSpecialHacks(a);e=TP.nodeGetWindow(c);if(!/<!DOCTYPE/.test(a)){a=TP.w3.DocType.HTML_401_STRICT.asString()+'\n'+a;}if(TP.boot.isUA('GECKO')||TP.boot.isUA('WEBKIT')){try{c.open(TP.HTML_TEXT_ENCODED,'replace');c.write('');TP.$$processDocumentUnloaded(e,false);}catch(a){}finally{c.close();}}if(TP.isCallable(k)){TP.core.Window.registerOnloadFunction(e,k);}TP.core.Window.setWindowInfo(TP.gid(e),'shouldAwake',j);try{TP.core.Window.$$isDocumentWriting=true;c.open(TP.HTML_TEXT_ENCODED,'replace');if(TP.boot.isUA('WEBKIT')){TP.keys(TP.sys.$globals).perform(function(a){e[a]=null;});}if(!/tibet_hook/.test(a)){TP.core.Window.installLoadUnloadHooks(e);e.$$tibet=window;}c.write(a);}catch(a){}finally{c.close();}return c.documentElement;});TP.definePrimitive('elementAddClass',function(a,b){var c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return;}if(TP.elementHasClass(a,b)){return a;}if(TP.isValid(a.classList)){return a.classList.add(b);}if(TP.notEmpty(c=TP.elementGetClass(a))){TP.elementSetAttribute(a,'class',c+' '+b);}else{TP.elementSetAttribute(a,'class',b);}return a;});TP.definePrimitive('elementComputeBoxSizeOfMarkup',function(b,d,h,e){var c,a,f,g;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(d)){return TP.raise(this,'TP.sig.InvalidString',arguments);}c=TP.ifInvalid(h,TP.BORDER_BOX);a=TP.nodeCloneNode(b);TP.elementSetInnerContent(a,d);TP.nodeAppendChild(b.parentNode,a,false);f=TP.elementGetWidth(a,c,e);g=TP.elementGetHeight(a,c,e);TP.nodeDetach(a);return TP.ac(f,g);});TP.definePrimitive('elementComputeCornerUsing',function(j,c,d,m,n,k,l){var e,f,h,i,g,b,a;if(!TP.isElement(j)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}e=TP.elementGetBorderBox(j);g=e.at('left');f=e.at('top');h=g+e.at('width');i=f+e.at('height');if(c<g||c>h||d<f||d>i){return null;}b=null;a=null;if(c>g&&c<g+l){b='LEFT';}else if(c>h-n&&c<h){b='RIGHT';}if(d>f&&d<f+m){a='TOP';}else if(d>i-k&&d<i){a='BOTTOM';}if(TP.isString(b)&&TP.notValid(a)){return TP[b];}if(TP.isString(a)&&TP.notValid(b)){return TP[a];}if(TP.isString(b)&&TP.isString(a)){return TP[a+'_'+b];}return null;});TP.definePrimitive('elementComputeOnScreenXY',function(g,u,x,E,D,C){var p,o,w,h,y,s,t,z,l,A,r,k,j,m,n,i,f,q,B,e,c,d,a,b,v;if(!TP.isElement(g)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isNumber(u)||!TP.isNumber(x)){return TP.raise(this,'TP.sig.InvalidNumber',arguments);}p=TP.ifInvalid(E,0);o=TP.ifInvalid(D,0);w=TP.ifInvalid(C,TP.ac(TP.TOP_LEFT));h=TP.nodeGetDocument(g);y=TP.documentGetViewableWidth(h);s=TP.documentGetViewableHeight(h);t=TP.documentGetScrollX(h);z=TP.documentGetScrollY(h);l=TP.elementGetStyleObj(g);A=l.display;l.display='';r=TP.elementGetWidth(g,TP.BORDER_BOX);k=TP.elementGetHeight(g,TP.BORDER_BOX);l.display=A;j=-1;m=-1;n=null;i=Infinity;B=w.length;for(q=0;q<B;q++){e=w[q];f=true;if(e===TP.TOP_LEFT||e===TP.BOTTOM_LEFT){c=u+p;}else{c=u-r-p;}if(e===TP.TOP_LEFT||e===TP.TOP_RIGHT){d=x+o;}else{d=x-k-o;}if(c<0){c=0;f=false;}if(d<0){d=0;f=false;}a=c+r;if(a>y){a=y-r;f=false;}else{a=c;}a=a.max(p)+t;b=d+k;if(b>s){b=s-k;f=false;}else{b=d;}b=b.max(o)+z;if(f){j=a;m=b;i=0;n=e;break;}v=(a-c-t).pow(2)+(b-d-z).pow(2);if(i>v){j=a;m=b;i=v;n=e;}}return TP.ac(j,m,n,i);});TP.definePrimitive('elementContainsPoint',function(b,c,d){var a;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isNumber(c)||!TP.isNumber(d)){return TP.raise(this,'TP.sig.InvalidNumber',arguments);}a=TP.elementGetBorderBox(b);if(c>=a.at('left')&&d>=a.at('top')&&c<=a.at('left')+b.offsetWidth&&d<=a.at('top')+b.offsetHeight){return true;}return false;});TP.definePrimitive('elementDefaultDisplay',function(a){var b,c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}TP.elementGetStyleObj(a).display='';b=TP.elementGetComputedStyleObj(a).display;if(b==='none'){c=TP.elementGetLocalName(a).toLowerCase();b=TP.XHTML_10_NONINLINE_ELEMENTS.at(c);if(TP.isString(b)){TP.elementGetStyleObj(a).display=b;}else{TP.elementGetStyleObj(a).display='inline';}}return;});TP.definePrimitive('elementGetBorderBox',function(b,k){var f,j,a,g,c,d,h,i,e;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}f=TP.nodeGetDocument(b);j=TP.isTrue(k)||!TP.elementIsTransformed(b);if(!j){c=b.offsetLeft;d=b.offsetTop;a=TP.elementGetOffsetParent(b);while(TP.isElement(a)){g=TP.elementGetStyleValuesInPixels(a,TP.ac('borderTopWidth','borderLeftWidth'));c+=a.offsetLeft+g.at('borderLeftWidth');d+=a.offsetTop+g.at('borderTopWidth');if(a!==f.body&&a!==f.documentElement){c-=a.scrollLeft;d-=a.scrollTop;}a=TP.elementGetOffsetParent(a);}h=b.offsetWidth;i=b.offsetHeight;}else{e=b.getBoundingClientRect();c=e.left.round();d=e.top.round();h=e.width.round();i=e.height.round();c+=TP.documentGetScrollX(f);d+=TP.documentGetScrollY(f);}return TP.hc('left',c,'top',d,'width',h,'height',i);});TP.definePrimitive('elementGetFirstEnabledWith',function(f,c,d){var a,b,e;a=f;b=null;e=TP.notEmpty(d);while(a.nodeType!==Node.DOCUMENT_NODE&&a.nodeType!==Node.DOCUMENT_FRAGMENT_NODE){if(TP.elementHasAttribute(a,'disabled')){b=null;break;}if(TP.notValid(b)){if(e&&TP.elementGetAttribute(a,c,true)===d){b=a;}else if(TP.elementHasAttribute(a,c,true)){b=a;}}a=a.parentNode;}return b;});TP.definePrimitive('$elementGetBusyLayer',function(a){var b,c,d,e;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments,a);}if(TP.isElement(b=a.busyElement)){return b;}b=a.ownerDocument.createElement('div');TP.elementSetAttribute(b,'busyFor',TP.elementGetAttribute(a,'id'));c=a.ownerDocument.createElement('div');TP.elementSetClass(c,'background');TP.elementSetStyle(c,'position: absolute; left: 0px; top: 0px;'+' width: 100%; height: 100%');TP.nodeAppendChild(b,c,false);d=a.ownerDocument.createElement('div');TP.elementSetClass(d,'controlImage');TP.nodeAppendChild(b,d,false);e=a.ownerDocument.createElement('span');TP.nodeAppendChild(b,e,false);TP.nodeAppendChild(e,a.ownerDocument.createTextNode(' '),false);TP.nodeAppendChild(TP.documentGetBody(a.ownerDocument),b,false);a.busyElement=b;a.busyMessageElement=e;a.busyControlImageElement=d;return b;});TP.definePrimitive('elementGetClass',function(a){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isSVGNode(a)){return a.className.baseVal;}return a.className;});TP.definePrimitive('elementGetClipRect',function(d){var e,b,c,a;if(!TP.isElement(d)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}e=TP.elementGetComputedStyleObj(d).clip;b=null;b=TP.regex.CSS_CLIP_RECT.exec(e);if(TP.isArray(b)){b.shift();for(c=0;c<b.getSize();c++){a=b.at(c);a=a.strip(/,$/);if(a==='auto'){a=null;}else if(!TP.isNaN(parseInt(a,10))){if(c.isEven()){a=TP.elementGetPixelValue(d,a,'height');}else{a=TP.elementGetPixelValue(d,a,'width');}}b.atPut(c,a);}}return b;});TP.definePrimitive('elementGetContentHeight',function(a,c){var b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if((b=a.scrollHeight)===0){b=TP.elementGetBorderBox(a,c).at('height');}return b;});TP.definePrimitive('elementGetContentWidth',function(a,c){var b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if((b=a.scrollWidth)===0){b=TP.elementGetBorderBox(a,c).at('width');}return b;});TP.definePrimitive('elementGetEffectiveBackgroundColor',function(b){var a;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if((a=TP.elementGetComputedStyleObj(b).backgroundColor)!=='transparent'){return a;}a=null;TP.nodeDetectAncestor(b,function(c){var b;b=TP.elementGetComputedStyleObj(c);if((a=b.backgroundColor)!=='transparent'){return true;}return false;});if(TP.notValid(a)||a==='transparent'){a='white';}return a;});TP.definePrimitive('elementGetGlobalBox',function(b,g,j){var e,f,k,h,i,c,d,a;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isWindow(e=TP.nodeGetWindow(b))){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(j){a=TP.elementGetPageBox(b,g,null,false);k=TP.windowComputeTransformationMatrix(e);h=TP.elementGetComputedTransformMatrix(b);i=TP.multiplyMatrix(k,h);c=TP.matrixTransformRect(i,a.at('left'),a.at('top'),a.at('width'),a.at('height'));a=TP.hc('left',c.at(0),'top',c.at(1),'width',c.at(2),'height',c.at(3));}else{a=TP.elementGetPageBox(b,g,null,false);}if(TP.isElement(f=e.frameElement)){d=TP.windowComputeWindowOffsets(top,TP.elementGetIFrameWindow(f),j);}else{d=TP.ac(0,0);}a.atPut('left',a.at('left')+d.first());a.atPut('top',a.at('top')+d.last());return a;});TP.definePrimitive('elementGetGlobalX',function(a,e,b,f){var g,h,c,d,i;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isWindow(g=TP.nodeGetWindow(a))){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(TP.isElement(h=g.frameElement)){c=TP.windowComputeWindowOffsets(top,TP.elementGetIFrameWindow(h)).first();}else{c=0;}d=TP.elementGetPageX(a,e,null,f)+c;if(TP.isElement(b)&&TP.nodeContainsNode(b,a)){if(TP.isNumber(i=TP.elementGetGlobalX(b,e,f))){return d-i;}}return d;});TP.definePrimitive('elementGetGlobalY',function(a,e,b,f){var g,h,c,d,i;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isWindow(g=TP.nodeGetWindow(a))){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(TP.isElement(h=g.frameElement)){c=TP.windowComputeWindowOffsets(top,TP.elementGetIFrameWindow(h)).last();}else{c=0;}d=TP.elementGetPageY(a,e,null,f)+c;if(TP.isElement(b)&&TP.nodeContainsNode(b,a)){if(TP.isNumber(i=TP.elementGetGlobalY(b,e,f))){return d-i;}}return d;});TP.definePrimitive('elementGetGlobalXY',function(b,f,d,g){var h,i,c,a,e;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isWindow(h=TP.nodeGetWindow(b))){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(TP.isElement(i=h.frameElement)){c=TP.windowComputeWindowOffsets(top,TP.elementGetIFrameWindow(i));}else{c=TP.ac(0,0);}a=TP.elementGetPageXY(b,f,null,g);a=TP.ac(c.first()+a.first(),c.last()+a.last());if(TP.isElement(d)&&TP.nodeContainsNode(d,b)){if(TP.isArray(e=TP.elementGetGlobalXY(d,f,null,g))){return TP.ac(a.first()-e.first(),a.last()-e.last());}}return a;});TP.definePrimitive('elementGetHeight',function(a,e,b){var c,d;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}c=TP.elementGetBorderBox(a,b).at('height');d=TP.ifInvalid(e,TP.BORDER_BOX);switch(d){case TP.CONTENT_BOX:c-=TP.elementGetPaddingInPixels(a,TP.TOP,b)+TP.elementGetBorderInPixels(a,TP.TOP,b);c-=TP.elementGetPaddingInPixels(a,TP.BOTTOM,b)+TP.elementGetBorderInPixels(a,TP.BOTTOM,b);break;case TP.PADDING_BOX:c-=TP.elementGetBorderInPixels(a,TP.TOP,b);c-=TP.elementGetBorderInPixels(a,TP.BOTTOM,b);break;case TP.BORDER_BOX:break;case TP.MARGIN_BOX:c+=TP.elementGetMarginInPixels(a,TP.TOP,b);c+=TP.elementGetMarginInPixels(a,TP.BOTTOM,b);break;}return c;});TP.definePrimitive('elementGetInnerContent',function(a){var b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isHTMLNode(a)){return a.innerHTML;}b=TP.nodeAsString(a,false,false);return b.slice(b.indexOf('>')+1,b.lastIndexOf('<'));});TP.definePrimitive('elementGetOffsetFromContainer',function(a,c){var d,b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}d=TP.nodeGetDocument(a);b=TP.elementGetOffsetParent(a);if(TP.isElement(b)&&TP.nodeContainsNode(b,a)){return TP.elementGetPageXY(a,TP.BORDER_BOX,b,c);}else{return TP.ac(0,0);}});TP.definePrimitive('elementGetPageBox',function(c,g,f,d){var a,h,b,e;if(!TP.isElement(c)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}a=TP.elementGetBorderBox(c,d);h=TP.ifInvalid(g,TP.BORDER_BOX);switch(h){case TP.CONTENT_BOX:b=TP.elementGetStyleValuesInPixels(c,TP.ac('borderTopWidth','borderBottomWidth','borderLeftWidth','borderRightWidth','paddingTop','paddingBottom','paddingLeft','paddingRight'),d);a.atPut('top',a.at('top')+(b.at('borderTopWidth')+b.at('paddingTop')));a.atPut('right',a.at('right')-(b.at('borderRightWidth')+b.at('paddingRight')));a.atPut('bottom',a.at('bottom')-(b.at('borderBottomWidth')+b.at('paddingBottom')));a.atPut('left',a.at('left')+(b.at('borderLeftWidth')+b.at('paddingLeft')));a.atPut('height',a.at('height')-(b.at('borderBottomWidth')+b.at('paddingBottom')));a.atPut('width',a.at('width')-(b.at('borderLeftWidth')+b.at('paddingLeft')));break;case TP.PADDING_BOX:b=TP.elementGetStyleValuesInPixels(c,TP.ac('borderTopWidth','borderBottomWidth','borderLeftWidth','borderRightWidth'),d);a.atPut('top',a.at('top')+b.at('borderTopWidth'));a.atPut('right',a.at('right')-b.at('borderRightWidth'));a.atPut('bottom',a.at('bottom')-b.at('borderBottomWidth'));a.atPut('left',a.at('left')+b.at('borderLeftWidth'));a.atPut('height',a.at('height')-b.at('borderBottomWidth'));a.atPut('width',a.at('width')-b.at('borderLeftWidth'));break;case TP.BORDER_BOX:break;case TP.MARGIN_BOX:b=TP.elementGetStyleValuesInPixels(c,TP.ac('marginTop','marginWidth','marginLeft','marginRight'),d);a.atPut('top',a.at('top')-b.at('marginTop'));a.atPut('right',a.at('right')+b.at('marginRight'));a.atPut('bottom',a.at('bottom')+b.at('marginBottom'));a.atPut('left',a.at('left')-b.at('marginLeft'));a.atPut('height',a.at('height')+b.at('marginBottom'));a.atPut('width',a.at('width')+b.at('marginLeft'));break;}if(TP.isElement(f)&&TP.nodeContainsNode(f,c)){if(TP.isNumber(e=TP.elementGetPageBox(f,g,null,d))){return TP.hc('top',a.at('top')-e.at('top'),'right',a.at('right')-e.at('right'),'bottom',a.at('bottom')-e.at('bottom'),'left',a.at('left')-e.at('left'),'width',a.at('width'),'height',a.at('height'));}}return a;});TP.definePrimitive('elementGetPageX',function(a,e,d,c){var h,b,f,g;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}h=TP.nodeGetDocument(a);b=TP.elementGetBorderBox(a,c).at('left');f=TP.ifInvalid(e,TP.BORDER_BOX);switch(f){case TP.CONTENT_BOX:b+=TP.elementGetBorderInPixels(a,c,TP.LEFT);b+=TP.elementGetPaddingInPixels(a,c,TP.LEFT);break;case TP.PADDING_BOX:b+=TP.elementGetBorderInPixels(a,c,TP.LEFT);break;case TP.BORDER_BOX:break;case TP.MARGIN_BOX:b-=TP.elementGetMarginInPixels(a,c,TP.LEFT);break;}if(TP.isElement(d)&&TP.nodeContainsNode(d,a)){if(TP.isNumber(g=TP.elementGetPageX(d,e,null,c))){return b-g;}}return b;});TP.definePrimitive('elementGetPageY',function(a,e,d,c){var h,b,f,g;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}h=TP.nodeGetDocument(a);b=TP.elementGetBorderBox(a,c).at('top');f=TP.ifInvalid(e,TP.BORDER_BOX);switch(f){case TP.CONTENT_BOX:b+=TP.elementGetBorderInPixels(a,c,TP.TOP);b+=TP.elementGetPaddingInPixels(a,c,TP.TOP);break;case TP.PADDING_BOX:b+=TP.elementGetBorderInPixels(a,c,TP.TOP);break;case TP.BORDER_BOX:break;case TP.MARGIN_BOX:b-=TP.elementGetMarginInPixels(a,c,TP.TOP);break;}if(TP.isElement(d)&&TP.nodeContainsNode(d,a)){if(TP.isNumber(g=TP.elementGetPageY(d,e,null,c))){return b-g;}}return b;});TP.definePrimitive('elementGetPageXY',function(a,h,f,b){var j,g,c,d,i,e;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}j=TP.nodeGetDocument(a);g=TP.elementGetBorderBox(a,b);c=g.at('left');d=g.at('top');i=TP.ifInvalid(h,TP.BORDER_BOX);switch(i){case TP.CONTENT_BOX:c+=TP.elementGetBorderInPixels(a,TP.LEFT,b);c+=TP.elementGetPaddingInPixels(a,TP.LEFT,b);d+=TP.elementGetBorderInPixels(a,TP.TOP,b);d+=TP.elementGetPaddingInPixels(a,TP.TOP,b);break;case TP.PADDING_BOX:c+=TP.elementGetBorderInPixels(a,TP.LEFT,b);d+=TP.elementGetBorderInPixels(a,TP.TOP,b);break;case TP.BORDER_BOX:break;case TP.MARGIN_BOX:c-=TP.elementGetMarginInPixels(a,TP.LEFT,b);d-=TP.elementGetMarginInPixels(a,TP.TOP,b);break;}if(TP.isElement(f)&&TP.nodeContainsNode(f,a)){if(TP.isArray(e=TP.elementGetPageXY(f,h,null,b))){return TP.ac(c-e.first(),d-e.last());}}return TP.ac(c,d);});TP.definePrimitive('elementGetOffsetBox',function(b,d,e){var f,c,a;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isElement(f=TP.elementGetOffsetParent(b))){c=TP.elementGetPageXY(f,d,null,e);}a=TP.elementGetPageBox(b,d,null,e);a.atPut('left',a.at('left')-c.first());a.atPut('top',a.at('top')-c.last());return a;});TP.definePrimitive('elementGetOffsetX',function(a,b,c){var d;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isElement(d=TP.elementGetOffsetParent(a))){return TP.elementGetPageX(a,b,d,c);}return TP.elementGetPageX(a,b,null,c);});TP.definePrimitive('elementGetOffsetY',function(a,b,c){var d;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isElement(d=TP.elementGetOffsetParent(a))){return TP.elementGetPageY(a,b,d,c);}return TP.elementGetPageY(a,b,null,c);});TP.definePrimitive('elementGetOffsetXY',function(a,b,c){var d;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isElement(d=TP.elementGetOffsetParent(a))){return TP.elementGetPageXY(a,b,d,c);}return TP.elementGetPageXY(a,b,null,c);});TP.definePrimitive('elementGetScrollOffsetFromAncestor',function(b,h,f){var g,c,d,e,a;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}g=TP.ifInvalid(h,TP.nodeGetDocument(b));if(TP.isTrue(f)){c=TP.elementLocalToGlobalXY(b,b.scrollLeft||0,b.scrollTop||0);d=c.first();e=c.last();}else{d=b.scrollLeft||0;e=b.scrollTop||0;}a=b.parentNode;while(TP.isElement(a)&&a!==g){if(TP.isTrue(f)){c=TP.elementLocalToGlobalXY(a,a.scrollLeft||0,a.scrollTop||0);d+=c.first();e+=c.last();}else{d+=a.scrollLeft||0;e+=a.scrollTop||0;}a=a.parentNode;}return TP.ac(d,e);});TP.definePrimitive('elementGetScrollOffsetFromContainer',function(b,e){var d,a,c;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}d=TP.nodeGetDocument(b);a=TP.elementGetOffsetParent(b);while(TP.isElement(a)){if(a===TP.documentGetBody(d)){break;}c=TP.elementGetComputedStyleObj(a);if(c.position==='absolute'||c.position==='relative'){break;}a=TP.elementGetOffsetParent(a);}a=TP.isDocument(a)?a.documentElement:a;return TP.elementGetScrollOffsetFromAncestor(b,a,e);});TP.definePrimitive('elementGetScrollXY',function(a,c){var b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isTrue(c)){b=TP.elementLocalToGlobalXY(a,a.scrollLeft,a.scrollTop);}else{b=TP.ac(a.scrollLeft,a.scrollTop);}return b;});TP.definePrimitive('elementGetSideClosestTo',function(a,j,i){var d,e,g,h,f,c,b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}d=TP.elementGetPageXY(a,TP.CONTENT_BOX);e=TP.elementGetWidth(a,TP.BORDER_BOX);g=TP.elementGetHeight(a,TP.BORDER_BOX);h=d.first()+e/2;f=d.last()+g/2;if(j<h){c=TP.LEFT;}else{c=TP.RIGHT;}if(i<f){b=TP.TOP;}else{b=TP.BOTTOM;}return TP.ac(c,b);});TP.definePrimitive('elementGetWidth',function(a,e,b){var c,d;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}c=TP.elementGetBorderBox(a,b).at('width');d=TP.ifInvalid(e,TP.BORDER_BOX);switch(d){case TP.CONTENT_BOX:c-=TP.elementGetPaddingInPixels(a,TP.LEFT,b)+TP.elementGetBorderInPixels(a,TP.LEFT,b);c-=TP.elementGetPaddingInPixels(a,TP.RIGHT,b)+TP.elementGetBorderInPixels(a,TP.RIGHT,b);break;case TP.PADDING_BOX:c-=TP.elementGetBorderInPixels(a,TP.LEFT,b);c-=TP.elementGetBorderInPixels(a,TP.RIGHT,b);break;case TP.BORDER_BOX:break;case TP.MARGIN_BOX:c+=TP.elementGetMarginInPixels(a,TP.LEFT,b);c+=TP.elementGetMarginInPixels(a,TP.RIGHT,b);break;}return c;});TP.definePrimitive('elementHasClass',function(a,b){var c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isValid(a.classList)){return a.classList.contains(b);}c=TP.rc('(^|\\s)'+b+'(\\s|$)');return c.test(TP.elementGetClass(a));});TP.definePrimitive('elementHasFocus',function(a){return TP.documentGetFocusedElement(TP.nodeGetDocument(a))===a;});TP.definePrimitive('elementHide',function(a,b){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}TP.elementGetStyleObj(a).visibility='hidden';if(TP.notTrue(b)){TP.elementGetStyleObj(a).display='none';}return;});TP.definePrimitive('elementHideBusyMessage',function(a){var b;if(TP.isElement(b=a.busyElement)){TP.elementGetStyleObj(b).display='none';if(TP.boot.isUA('IE')){a.ownerDocument.parentWindow.detachEvent('onresize',b.busyResizeFunction);}else{a.ownerDocument.defaultView.removeEventListener('resize',b.busyResizeFunction,false);}b.busyResizeFunction=null;}if(a.oldOverflow){TP.elementGetStyleObj(a).overflow=a.oldOverflow;}return b;});TP.definePrimitive('elementIsDisplayed',function(a){var b,c,d;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.notValid(b=TP.elementGetComputedStyleObj(a))){return TP.raise(this,'TP.sig.InvalidStyle',arguments);}c=b.display;if(c==='none'){return false;}d=b.visibility;if(d==='hidden'){return false;}if(TP.notValid(a.parentNode)||TP.isDocument(a.parentNode)){return true;}return TP.elementIsDisplayed(a.parentNode);});TP.definePrimitive('elementIsVisible',function(c){var b,d,a,e;if(!TP.isElement(c)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.notValid(b=TP.nodeGetDocument(c))){return false;}if(TP.notValid(d=TP.nodeGetWindow(b))){return false;}a=TP.elementGetBorderBox(c,true);e=a.bottom>0&&a.right>0&&a.left<(d.innerWidth||b.documentElement.clientWidth)&&a.top<(d.innerHeight||b.documentElement.clientHeight);return e;});TP.definePrimitive('elementMakeAbsolute',function(a){var b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.elementGetComputedStyleObj(a).position==='absolute'){return;}b=TP.elementGetPageXY(a);TP.elementGetStyleObj(a).position='absolute';TP.elementGetStyleObj(a).left=b.at(0)+'px';TP.elementGetStyleObj(a).top=b.at(1)+'px';TP.elementGetStyleObj(a).width=a.clientWidth+'px';TP.elementGetStyleObj(a).height=a.clientHeight+'px';return;});TP.definePrimitive('elementMakePositioned',function(a){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!/absolute|relative/i.test(TP.elementGetComputedStyleObj(a).position)){TP.elementMakeRelative(a);}return;});TP.definePrimitive('elementMakeRelative',function(b){var a,c,d;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.elementGetComputedStyleObj(b).position==='relative'){return;}a=TP.elementGetStyleObj(b);if(TP.notEmpty(a.left)){c=TP.elementGetPixelValue(b,a.left,'left');}else{c=0;}if(TP.notEmpty(a.top)){d=TP.elementGetPixelValue(b,a.top,'top');}else{d=0;}a.position='relative';a.left=c+'px';a.top=d+'px';return;});TP.definePrimitive('elementMoveBy',function(a,d,e){var b,c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!/absolute|relative/i.test(TP.elementGetComputedStyleObj(a).position)){return;}b=TP.elementGetPageXY(a);c=TP.elementGetStyleObj(a);c.left=b.first()+d+'px';c.top=b.last()+e+'px';return;});TP.definePrimitive('elementMoveTo',function(d,b,c){var a;if(!TP.isElement(d)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}a=TP.elementGetStyleObj(d);if(TP.isNumber(b)){a.left=b+'px';}else{a.left=b;}if(TP.isNumber(c)){a.top=c+'px';}else{a.top=c;}return;});TP.definePrimitive('elementOrderOver',function(a,b){var c;if(!TP.isElement(a)||!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}c=parseInt(TP.elementGetComputedStyleObj(b).zIndex,10);TP.elementGetStyleObj(a).zIndex=c+1;return;});TP.definePrimitive('elementOrderUnder',function(a,b){var c;if(!TP.isElement(a)||!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}c=parseInt(TP.elementGetComputedStyleObj(b).zIndex,10);TP.elementGetStyleObj(a).zIndex=c-1;return;});TP.definePrimitive('elementPlaceNearElement',function(g,a,w,v,u,t){var d,i,j,r,l,h,q,p,o,c,k,m,f,e,s,b,n;if(!TP.isElement(g)||!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}d=TP.ifInvalid(u,TP.BORDER_BOX);i=TP.ifInvalid(t,TP.ac(TP.TOP_LEFT,TP.BOTTOM_LEFT,TP.BOTTOM_LEFT,TP.TOP_LEFT));j=TP.elementGetStyleObj(a);r=j.display;j.display='';l=TP.elementGetPageX(a,d);h=TP.elementGetPageY(a,d);q=TP.elementGetWidth(a,d);p=TP.elementGetHeight(a,d);TP.elementGetStyleObj(g).display=r;o=Infinity;c=null;s=i.length;for(e=0;e<s;e++){b=i[e];if(b===TP.TOP_LEFT||b===TP.BOTTOM_LEFT){k=l;}else{k=l+q;}if(b===TP.TOP_LEFT||b===TP.TOP_RIGHT){m=h;}else{m=h+p;}c=TP.elementComputeOnScreenXY(g,k,m,w,v,TP.ac(b));f=c.at(3);if(f===0){break;}if(o>f){o=f;}}if(TP.isArray(c)){n=TP.elementGetStyleObj(g);n.left=c.first()+'px';n.top=c.last()+'px';}return;});TP.definePrimitive('elementRemoveAttributeValue',function(a,b,c){var d,e;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidString',arguments);}if(TP.notValid(c)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.notEmpty(d=TP.elementGetAttribute(a,b,true))){e=TP.rc(' ?'+c+' ?','g');TP.elementSetAttribute(a,b,d.strip(e),true);}return a;});TP.definePrimitive('elementReplaceAttributeValue',function(a,c,e,d){var b,f;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(e)){return TP.raise(this,'TP.sig.InvalidString',arguments);}if(TP.isEmpty(d)){}if(TP.isEmpty(b=TP.elementGetAttribute(a,c,true))){TP.elementSetAttribute(a,c,d,true);return a;}f=TP.rc('(^|\\s)'+e+'(\\s|$)');b=b.replace(f,'$1'+d+'$2');TP.elementSetAttribute(a,c,b,true);return a;});TP.definePrimitive('elementRemoveClass',function(a,c){var d,b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(c)){return;}if(TP.isValid(a.classList)){return a.classList.remove(c);}b=TP.elementGetClass(a);if(TP.isEmpty(b)){return a;}d=TP.rc('(^|\\s)'+c+'(\\s|$)');b=b.replace(d,'$2');TP.elementSetAttribute(a,'class',b);return a;});TP.definePrimitive('elementReplaceClass',function(a,d,c){var b,e;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(d)||TP.isEmpty(c)){return TP.raise(this,'TP.sig.InvalidString',arguments);}b=TP.elementGetClass(a);if(TP.isEmpty(b=TP.elementGetClass(a))){TP.elementSetClass(a,c);return a;}e=TP.rc('(^|\\s)'+d+'(\\s|$)');b=b.replace(e,'$1'+c+'$2');TP.elementSetClass(a,b);return a;});TP.definePrimitive('elementReplaceTextWithEditor',function(a){var c,d,b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}c=TP.nodeGetDocument(a);d=TP.nodeGetTextContent(a);b=TP.documentCreateElement(c,'input',TP.w3.Xmlns.XHTML);TP.nodeEmptyContent(a);TP.nodeAppendChild(a,b,false);b.value=d;b.select();return a;});TP.definePrimitive('elementScrollBy',function(a,b,c){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isNumber(b)||!TP.isNumber(c)){return TP.raise(this,'TP.sig.InvalidNumber',arguments);}a.scrollLeft+=b;a.scrollTop+=c;return;});TP.definePrimitive('elementScrollTo',function(a,b,c){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isNumber(b)||!TP.isNumber(c)){return TP.raise(this,'TP.sig.InvalidNumber',arguments);}a.scrollLeft=b;a.scrollTop=c;return;});TP.definePrimitive('elementSetBusyMessage',function(b,c){var a;if(TP.notValid(a=b.busyMessageElement)){return;}a.firstChild.nodeValue=c;return;});TP.definePrimitive('elementSetClipRect',function(e,a,b,c,d){if(!TP.isElement(e)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}TP.elementGetStyleObj(e).clip='rect('+(!TP.isNaN(a)?a+'px ':a)+(!TP.isNaN(b)?b+'px ':b)+(!TP.isNaN(c)?c+'px ':c)+(!TP.isNaN(d)?d+'px':d)+')';return;});TP.definePrimitive('elementSetHeight',function(a,b){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isNumber(b)){TP.elementGetStyleObj(a).height=b+'px';}else{TP.elementGetStyleObj(a).height=b;}return;});TP.definePrimitive('elementSetWidth',function(a,b){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isNumber(b)){TP.elementGetStyleObj(a).width=b+'px';}else{TP.elementGetStyleObj(a).width=b;}return;});TP.definePrimitive('elementShow',function(a){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}TP.elementDefaultDisplay(a);TP.elementGetStyleObj(a).visibility='visible';return;});TP.definePrimitive('$elementShowBusyLayer',function(a,k,j,n,f,e){var c,h,i,b,l,m,g,d;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(k)){return TP.raise(this,'TP.sig.InvalidString',arguments);}c=a.busyElement;h=a.busyMessageElement;i=a.busyControlImageElement;b=TP.elementGetStyleObj(c);l=TP.isNumber(j)?j:TP.elementGetPageY(a);b.top=l+'px';m=TP.isNumber(n)?n:TP.elementGetPageX(a);b.left=m+'px';g=TP.isNumber(f)?f:TP.elementGetWidth(a);b.width=g+'px';d=TP.isNumber(e)?e:TP.elementGetHeight(a);b.height=d+'px';h.firstChild.nodeValue=k;TP.elementGetStyleObj(i).marginTop=d*0.5-TP.BUSY_HEIGHT+'px';TP.elementGetStyleObj(h).marginTop=d*0.5+'px';c.busyResizeFunction=function(){g=TP.isNumber(f)?f:a.offsetWidth;b.width=g+'px';d=TP.isNumber(e)?e:a.offsetHeight;b.height=d+'px';};if(TP.boot.isUA('IE')){a.ownerDocument.parentWindow.attachEvent('onresize',c.busyResizeFunction);}else{a.ownerDocument.defaultView.addEventListener('resize',c.busyResizeFunction,false);}b.display='block';return c;});TP.definePrimitive('elementShowBusyMessage',function(a,d){var b,e,f,g,c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(d)){return TP.raise(this,'TP.sig.InvalidString',arguments);}b=TP.$elementGetBusyLayer(a);TP.elementSetStyle(b,TP.join('position: absolute;',' display: none;',' z-index: ',TP.POPUP_TIER,';'));e=b.getElementsByTagName('div')[1];f=TP.uriExpandPath(TP.sys.cfg('path.lib_img'))+'/tibet_busy.gif';TP.elementSetStyle(e,TP.join('position: absolute;',' left: 50%;',' margin-left: -14px;',' width: 28px;',' height: 28px;',' background-image: url(',f,');'));g=b.getElementsByTagName('span')[0];TP.elementSetStyle(g,TP.join('position: absolute;',' font-family: Tahoma, Verdana, Arial, Helvetica, sans-serif;',' font-size: small;',' width: 100%;',' text-align: center;'));c=TP.elementGetStyleObj(a);a.oldOverflow=c.overflow;c.overflow='hidden';TP.$elementShowBusyLayer(a,d);return;});TP.definePrimitive('elementSumAncestorValues',function(b,e,g){var c,a,f,d;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(e)){return TP.raise(this,'TP.sig.InvalidString',arguments);}d=TP.ifInvalid(g,false);c=0;if(d){a=TP.elementGetOffsetParent(b);}else{a=b.parentNode;}while(TP.isElement(a)&&a.nodeType!==Node.DOCUMENT_NODE){if(TP.isNumber(f=a[e])){c+=f;}if(d){a=TP.elementGetOffsetParent(a);}else{a=a.parentNode;}}return c;});TP.definePrimitive('elementSumAttributeValue',function(a,b,c,h,i){var e,f,d,g;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidString',arguments);}if(TP.notValid(c)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}e=TP.ifInvalid(i,false);f=TP.ifInvalid(h,true);if(TP.notEmpty(d=TP.elementGetAttribute(a,b,true))){if(!e){g=TP.rc('(^|\\s)'+c+'(\\s|$)');if(g.test(d)){return a;}}if(f){TP.elementSetAttribute(a,b,d+' '+c,true);}else{TP.elementSetAttribute(a,b,c+' '+d,true);}}else{TP.elementSetAttribute(a,b,c,true);}return a;});TP.definePrimitive('elementWrapToContent',function(a){var c,d,b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}c=TP.elementGetContentWidth(a);d=TP.elementGetContentHeight(a);TP.elementSetWidth(a,c);TP.elementSetHeight(a,d);b=TP.elementGetClipRect(a);TP.elementSetClipRect(a,b.at(0),b.at(3)+c,b.at(0)+d,b.at(3));return;});TP.definePrimitive('htmlElementAddContent',function(a,b,c,d){return TP.htmlElementInsertContent(a,b,TP.BEFORE_END,c,d);});TP.definePrimitive('htmlElementInsertContent',function(a,j,t,r,s){var b,c,k,f,d,q,n,o,m,p,i,e,g,h,l;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}b=TP.ifInvalid(s,TP.nodeHasWindow(a));c=TP.ifEmpty(t,TP.BEFORE_END);k=TP.nodeGetDocument(a);if(TP.isHTMLNode(j)){if(TP.isDocument(j)){f=j.documentElement;}else{f=j;}d=null;}else{d=TP.htmlstr(j);f=null;}if(TP.isNode(f)){switch(c){case TP.AFTER_END:TP.nodeInsertBefore(a.parentNode,f,a.nextSibling,b);break;case TP.BEFORE_BEGIN:TP.nodeInsertBefore(a.parentNode,f,a,b);break;case TP.AFTER_BEGIN:TP.nodeInsertBefore(a,f,a.firstChild,b);break;case TP.BEFORE_END:TP.nodeAppendChild(a,f,b);break;default:if(TP.isNode(q=TP.nodeEvaluatePath(a,c,null,true))){TP.nodeInsertBefore(a,f,q,b);}}}else if(TP.isString(d)){if(TP.boot.isUA('IE')){d=d.replace(/&apos;/g,'&#39;');n=a.firstChild;o=a.lastChild;m=a.tagName.toLowerCase();p=a.parentNode;if(/(table|thead|tbody|tfoot|tr|th|td)/.test(m)){if(c===TP.AFTER_BEGIN||c===TP.BEFORE_END){i=TP.$$buildTableDOM(m,k,d,true);}else{i=TP.$$buildTableDOM(m,k,d,false);}while(i.hasChildNodes()){switch(c){case TP.AFTER_END:p.insertBefore(i.firstChild,a.nextSibling);break;case TP.BEFORE_BEGIN:p.insertBefore(i.firstChild,a);break;case TP.AFTER_BEGIN:a.insertBefore(i.firstChild,a.firstChild);break;case TP.BEFORE_END:a.appendChild(i.firstChild);break;}}}else{a.insertAdjacentHTML(c,d);}if(b){switch(c){case TP.AFTER_END:e=TP.nodeGetChildIndex(a.parentNode,a)+1;TP.nodeAwakenChildNodesFromTo(a.parentNode,e,TP.LAST);break;case TP.BEFORE_BEGIN:e=TP.nodeGetChildIndex(a.parentNode,a)-1;TP.nodeAwakenChildNodesFromTo(a.parentNode,TP.FIRST,e);break;case TP.AFTER_BEGIN:if(TP.isNode(n)){e=TP.nodeGetChildIndex(a,n)-1;}else{e=a.childNodes.length-1;}TP.nodeAwakenChildNodesFromTo(a,TP.FIRST,e);break;case TP.BEFORE_END:if(TP.isNode(o)){e=TP.nodeGetChildIndex(a,o)+1;}else{e=0;}TP.nodeAwakenChildNodesFromTo(a,e,TP.LAST);break;}}}else{g=k.createRange();switch(c){case TP.AFTER_END:g.setStartAfter(a);break;case TP.BEFORE_BEGIN:g.setStartBefore(a);break;case TP.AFTER_BEGIN:g.selectNodeContents(a);g.collapse(true);break;case TP.BEFORE_END:g.selectNodeContents(a);g.collapse(false);break;}try{h=g.createContextualFragment(d);TP.$htmlFragmentRepair(h);}catch(a){h=k.createTextNode(d);b=false;}switch(c){case TP.AFTER_END:TP.nodeInsertBefore(a.parentNode,h,a.nextSibling,b);break;case TP.BEFORE_BEGIN:TP.nodeInsertBefore(a.parentNode,h,a,b);break;case TP.AFTER_BEGIN:TP.nodeInsertBefore(a,h,a.firstChild,b);break;case TP.BEFORE_END:TP.nodeAppendChild(a,h,b);break;}}}switch(c){case TP.AFTER_END:l=a.nextSibling;break;case TP.BEFORE_BEGIN:l=a.previousSibling;break;case TP.AFTER_BEGIN:l=a.firstChild;break;case TP.BEFORE_END:l=a.lastChild;break;}if(TP.isCallable(r)){r(a);}if(TP.sys.shouldSignalDOMLoaded()){TP.signal(TP.gid(a),'TP.sig.DOMContentLoaded',arguments,j);}return l;});TP.definePrimitive('htmlElementReplaceWith',function(a,d,n,o){var g,h,e,c,b,k,f,m,l,j,i;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}g=TP.ifInvalid(o,TP.nodeHasWindow(a));h=TP.nodeGetDocument(a);if(TP.isHTMLNode(d)){if(TP.isDocument(d)){e=d.documentElement;}else{e=d;}c=null;}else{c=TP.htmlstr(d);e=null;}if(TP.isNode(e)){b=TP.nodeReplaceChild(a.parentNode,e,a,g);}else if(TP.isString(c)){if(TP.boot.isUA('IE')){c=c.replace(/&apos;/g,'&#39;');k=a.tagName.toLowerCase();f=a.parentNode;m=TP.nodeGetChildIndex(f,a);if(/(table|thead|tbody|tfoot|tr|th|td)/.test(k)){l=TP.$$buildTableDOM(k,h,c,false);while(l.hasChildNodes()){f.insertBefore(l.firstChild,a);}f.removeChild(a);}else{a.outerHTML=c;}b=f.childNodes[m];if(g){TP.nodeAwakenContent(b);}}else{j=h.createRange();j.setStartBefore(a);try{i=j.createContextualFragment(c);TP.$htmlFragmentRepair(i);b=i.firstChild;}catch(a){b=h.createTextNode(c);}b=TP.nodeReplaceChild(a.parentNode,b,a,g);}}if(TP.isCallable(n)){n(b.parentNode);}if(TP.sys.shouldSignalDOMLoaded()){TP.signal(TP.gid(b.parentNode),'TP.sig.DOMContentLoaded',arguments,d);}return b;});TP.definePrimitive('htmlElementSetContent',function(a,c,g,i){var h,d,b,e,f;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}h=TP.ifInvalid(i,TP.nodeHasWindow(a));if(TP.isHTMLNode(c)){if(TP.isDocument(c)){d=c.documentElement;}else{d=c;}b=null;}else{b=TP.htmlstr(c);d=null;}if(TP.isNode(d)){if(TP.boot.isUA('IE')){e=a.tagName.toLowerCase();if(/(table|thead|tbody|tfoot|tr|th|td)/.test(e)){while(a.hasChildNodes()){a.removeChild(a.lastChild);}}else{a.innerHTML='';}}else{a.innerHTML='';}d=TP.nodeAppendChild(a,d,false);}else if(TP.isString(b)){if(TP.boot.isUA('IE')){b=b.replace(/&apos;/g,'&#39;');e=a.tagName.toLowerCase();if(/(table|thead|tbody|tfoot|tr|th|td)/.test(e)){while(a.hasChildNodes()){a.removeChild(a.lastChild);}f=TP.$$buildTableDOM(e,TP.nodeGetDocument(a),b,true);while(f.hasChildNodes()){a.appendChild(f.firstChild);}}else{a.innerHTML=b;}}else{a.innerHTML=b;}}if(h){TP.nodeAwakenChildNodesFromTo(a,TP.FIRST,TP.LAST);}if(TP.isCallable(g)){g(a);}if(TP.sys.shouldSignalDOMLoaded()){TP.signal(TP.gid(a),'TP.sig.DOMContentLoaded',arguments,c);}return a;});TP.definePrimitive('htmlElementAsXHTMLString',function(c){var a,d,b,e;if(!TP.isHTMLNode(c)||!TP.isElement(c)){return TP.raise(this,'TP.sig.InvalidElement',arguments,'Element must be an HTML element.');}a=TP.ac();d=TP.sys.getTargetLanguage();b=true;e=false;TP.nodeDepthTraversal(c,function(c){var i,n,m,l,j,g,f,h,o,k;if(TP.isEmpty(i=c.tagName.toLowerCase())){return;}if(i==='!'){a.push(c.text);return;}if(i==='meta'){if(c.name.toLowerCase()==='generator'){return;}}k=TP.ac();if(i==='html'){a.push(TP.XML_10_HEADER,TP.w3.DocType.XHTML_10_STRICT.asString());}a.push('<',i);n=false;m=false;l=c.attributes;for(j=0;j<l.length;j++){g=l[j].name.toLowerCase();if(g.contains(':')){h=g.slice(0,g.indexOf(':'));if(/xmlns/.test(h)){continue;}if(!k.contains(h)){o=TP.w3.Xmlns.getPrefixURI(h);if(TP.notEmpty(o)){a.push(' ','xmlns:',h,'="',o,'"');}else{a.push(' ','xmlns:',h,'="urn:tibet:unrecognizednamespace"');}k.push(h);}}switch(g){case'style':f=TP.elementGetStyleObj(c).cssText.toLowerCase();break;case'class':f=c.className;break;case'http-equiv':f=c.httpEquiv;break;case'name':f=c.name;break;case'for':f=c.htmlFor;break;case'xmlns':n=true;break;case'lang':case'xml:lang':m=true;break;case'noshade':case'checked':case'selected':case'multiple':case'nowrap':case'disabled':f=g;break;default:try{f=c.getAttribute(g,2);}catch(a){continue;}break;}if(TP.isEmpty(f)){a.push(' ',g,'=""');}else{a.push(' ',g,'="',TP.xmlLiteralsToEntities(f),'"');}}if(!e){if(!m){a.push(' lang="',d,'" xml:lang="',d,'"');}if(!n){a.push(' xmlns="http://www.w3.org/1999/xhtml"');}e=true;}a.push('>');if(i==='pre'){b=false;}else{b=true;}k.empty();},function(b){if(b.tagName==='!'){return;}a.push('</',b.tagName.toLowerCase(),'>');},function(c){var d;switch(c.nodeType){case Node.TEXT_NODE:if(b){a.push(TP.xmlLiteralsToEntities(TP.htmlEntitiesToXmlEntities(c.nodeValue)));}else{a.push(c.nodeValue);}break;case Node.COMMENT_NODE:d=c.nodeValue.replace(/--/g,'__');a.push('<!--'+d+'-->');break;}});a=TP.htmlEntitiesToXmlEntities(a.join(''));return a;});TP.definePrimitive('$htmlFragmentRepair',function(g){var f,d,e,b,a,c;if(TP.notEmpty(g)){f=g.childNodes;for(d=0;d<f.length;d++){if(!TP.isElement(f[d])){continue;}e=f[d].getElementsByTagName('svg');for(b=0;b<e.length;b++){a=e[b];if(TP.isElement(c=TP.elem(TP.str(a)))){c=a.ownerDocument.adoptNode(c);a.parentNode.replaceChild(c,a);}}e=f[d].getElementsByTagName('svg:svg');for(b=0;b<e.length;b++){a=e[b];if(TP.isElement(c=TP.elem(TP.str(a)))){c=a.ownerDocument.adoptNode(c);a.parentNode.replaceChild(c,a);}}}}return;});TP.definePrimitive('htmlNodeAsXHTMLNode',function(a,e){var c,b,d;if(!TP.isHTMLNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node must be an HTML node.');}c=TP.isXMLDocument(e)?e:TP.XML_FACTORY_DOCUMENT;switch(a.nodeType){case Node.ELEMENT_NODE:return TP.elementFromString(TP.htmlElementAsXHTMLString(a));case Node.ATTRIBUTE_NODE:b=c.createAttribute(a.name);b.value=a.value;return b;case Node.TEXT_NODE:return c.createTextNode(a.data);case Node.CDATA_SECTION_NODE:return c.createCDATASection(a.data);case Node.DOCUMENT_FRAGMENT_NODE:b=c.createDocumentFragment();for(d=0;d<a.childNodes.length;d++){TP.nodeAppendChild(b,TP.htmlNodeAsXHTMLNode(a.childNodes[d],c));}return b;case Node.PROCESSING_INSTRUCTION_NODE:return c.createProcessingInstruction(a.target,a.data);case Node.COMMENT_NODE:return c.createComment(a.data);case Node.ENTITY_REFERENCE_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.ENTITY_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.DOCUMENT_TYPE_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.NOTATION_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.DOCUMENT_NODE:b=TP.documentFromString(TP.htmlElementAsXHTMLString(a.documentElement));if(!TP.isDocument(b)){b=TP.createDocument(null,'htmlNodeConversionError');TP.nodeAppendChild(b.documentElement,b.createTextNode(TP.nodeAsString(a)),false);}return b;}return null;});TP.definePrimitive('htmlNodeAsXHTMLString',function(a){var b;if(!TP.isHTMLNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node must be an HTML node.');}if(TP.isNode(b=TP.htmlNodeAsXHTMLNode(a))){return TP.nodeAsString(b);}return null;});TP.definePrimitive('iframeAddContent',function(a,c){var b;if(TP.notValid(c)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(!TP.isElement(a)||TP.elementGetLocalName(a).toLowerCase()!=='iframe'&&TP.elementGetLocalName(a).toLowerCase()!=='object'){return TP.raise(this,'TP.sig.InvalidElement',arguments,'Element must be an iframe.');}b=TP.elementGetIFrameDocument(a);if(TP.notValid(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments,'iframe document not value.');}TP.documentAddContent(b,c,null,true);return;});TP.definePrimitive('iframeSetContent',function(b,c,e,f){var a,d;if(TP.notValid(c)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(!TP.isElement(b)||TP.elementGetLocalName(b).toLowerCase()!=='iframe'&&TP.elementGetLocalName(b).toLowerCase()!=='object'){return TP.raise(this,'TP.sig.InvalidElement',arguments,'Element must be an iframe.');}a=TP.elementGetIFrameDocument(b);if(TP.notValid(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments,'iframe document not value.');}if(TP.isNode(c)){if(TP.isDocument(c)){d=c.documentElement;}else{d=c;}if(!TP.elementHasAttribute(b,'inited')){a.open();a.write('<html><head></head><body></body></html>');a.close();TP.elementSetAttribute(b,'inited','true');}TP.documentSetContent(a,d,e,f);}else{TP.documentSetContent(a,c,e,f);}return;});TP.definePrimitive('nodeAsHTMLNode',function(a,f){var c,b,d,e;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isHTMLNode(a)){return a;}c=TP.isHTMLDocument(f)?f:TP.sys.getUICanvas().getNativeDocument();switch(a.nodeType){case Node.ELEMENT_NODE:return TP.stringAsHTMLNode(TP.nodeAsString(a),c);case Node.ATTRIBUTE_NODE:b=c.createAttribute(a.name);b.value=a.value;return b;case Node.TEXT_NODE:return c.createTextNode(a.data);case Node.CDATA_SECTION_NODE:return c.createCDATASection(a.data);case Node.DOCUMENT_FRAGMENT_NODE:b=c.createDocumentFragment();for(d=0;d<a.childNodes.length;d++){TP.nodeAppendChild(b,TP.nodeAsHTMLNode(a.childNodes[d],c),false);}return b;case Node.PROCESSING_INSTRUCTION_NODE:return c.createTextNode(TP.join('PIs cannot be created in HTML: <?',a.target,' ',a.data,'?>'));case Node.COMMENT_NODE:return c.createComment(a.data);case Node.ENTITY_REFERENCE_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.ENTITY_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.DOCUMENT_TYPE_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.NOTATION_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;case Node.DOCUMENT_NODE:e=TP.nodeAsHTMLNode(a.documentElement);if(TP.isElement(e)){if(TP.isHTMLDocument(b=TP.elementGetIFrameDocument(TP.documentCreateIFrameElement(c)))){if(TP.isElement(TP.documentGetBody(b))){TP.nodeAppendChild(TP.documentGetBody(b),e,false);}else{TP.nodeAppendChild(b.documentElement,e,false);}}}else{b=TP.createDocument(null,'xmlNodeConversionError');TP.nodeAppendChild(b.documentElement,b.createTextNode(TP.nodeAsString(a)),false);}return b;}return null;});TP.definePrimitive('nodeAsHTMLString',function(a){if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isHTMLNode(a)){return TP.nodeAsString(a);}return TP.stringAsHTMLString(TP.nodeAsString(a));});TP.definePrimitive('nodeAsXMLNode',function(a,b){var c;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}c=TP.isXMLDocument(b)?b:TP.XML_FACTORY_DOCUMENT;if(TP.isXMLNode(a)){return a;}return TP.htmlNodeAsXHTMLNode(a,c);});TP.definePrimitive('nodeAsXMLString',function(a){if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isXMLNode(a)){return TP.nodeAsString(a);}return TP.htmlNodeAsXHTMLString(a);});TP.definePrimitive('stringAsHTMLAttribute',function(a){if(TP.isEmpty(a)){return'';}return a.replace(/&/g,'&amp;').replace(/</g,'&lt;');});TP.definePrimitive('stringAsHTMLNode',function(g,j){var c,a,f,d,k,h,i,b,e;if(!TP.isString(g)){return TP.raise(this,'TP.sig.InvalidString',arguments);}c=TP.isHTMLDocument(j)?j:TP.sys.getUICanvas().getNativeDocument();a=TP.stringAsHTMLString(g);if(/<(html:)?(html|head|body)(\s+|>)/i.test(a)){f=TP.documentCreateIFrameElement(c);d=TP.elementGetIFrameDocument(f);TP.regex.HTML_HTML_ELEM.lastIndex=0;k=a.replace(TP.regex.HTML_HTML_ELEM,'$3');TP.regex.HTML_HEAD_ELEM.lastIndex=0;h=a.replace(TP.regex.HTML_HEAD_ELEM,'$3');TP.regex.HTML_BODY_ELEM.lastIndex=0;i=a.replace(TP.regex.HTML_BODY_ELEM,'$3');d.getElementsByTagName('head')[0].innerHTML=h.stripExternalHeadContent();TP.documentGetBody(d).innerHTML=i.stripExternalBodyContent();b=d.documentElement;TP.nodeDetach(f);}else{e=c.createElement('div');e.innerHTML=a;switch(e.childNodes.length){case 0:b=c.createTextNode(a);break;case 1:b=TP.nodeDetach(e.firstChild);break;default:b=TP.nodeListAsFragment(c.childNodes);break;}}return b;});TP.definePrimitive('stringAsHTMLString',function(c){var a,b;if(!TP.isString(c)){return TP.raise(this,'TP.sig.InvalidString',arguments);}a=c;a=a.strip(TP.regex.XML_DECL);b=TP.ac();TP.regex.XML_COMMENT.lastIndex=0;a=a.replace(TP.regex.XML_COMMENT,function(c,d,a){b.push(a);return TP.join('<!--',b.getSize()-1,'-->');});TP.regex.XML_EMPTY_TAG.lastIndex=0;a=a.replace(TP.regex.XML_EMPTY_TAG,function(c,a,b){if(TP.regex.XHTML_10_EMPTY_ELEMENTS.test(a)){return TP.join('<',a,b,'>');}else{return TP.join('<',a,b,'>','</',a,'>');}});TP.regex.XHTML_10_EMPTY_ELEMENTS_STRIP.lastIndex=0;a=a.strip(TP.regex.XHTML_10_EMPTY_ELEMENTS_STRIP);TP.regex.NON_PREFIXED_NS_ATTR.lastIndex=0;a=a.replace(TP.regex.NON_PREFIXED_NS_ATTR,function(b,c,a){if(a===TP.w3.Xmlns.SVG||a===TP.w3.Xmlns.VML){return b;}return'';});TP.regex.PREFIXED_NS_ATTR.lastIndex=0;a=a.replace(TP.regex.PREFIXED_NS_ATTR,function(a,b,c){return'';});a=a.replace(/<(\/)?(html|svg|m):/g,'<$1');a=a.replace(/<(script|style)([^>]*)>\s*<!\[CDATA\[/g,'<$1$2>');a=a.replace(/\]\]>\s*<\/(script|style)>/g,'</$1>');a=a.replace(/<!\[CDATA\[([\s\S]*?)\]\]>/g,function(b,a){return TP.htmlLiteralsToEntities(a);});a=a.replace(/<!--(\d+)-->/g,function(c,a){return TP.join('<!--',b.at(parseInt(a,10)),'-->');});return a;});TP.definePrimitive('nodeAwakenContent',function(a,b,c){return;});TP.definePrimitive('nodeAwakenChildNodesFromTo',function(a,f,g){var c,d,b,e,h,i;if(!TP.isCollectionNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments,'Node not a collection Node.');}if(f===TP.FIRST){c=0;}else{c=f;}if(g===TP.LAST){d=a.childNodes.length-1;}else{d=g;}if(TP.notValid(h=TP.nodeGetDocument(a))){return;}if(TP.notValid(i=TP.nodeGetWindow(h))){return;}for(b=c;b<=d;b++){e=a.childNodes[b];if(TP.isElement(e)){TP.nodeAwakenContent(e);}}return;});TP.definePrimitive('nodeGetElementsByClassName',function(a,c){var b,d;if(!TP.isElement(a)&&!TP.isDocument(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}b=TP.isDocument(a)?a.documentElement:a;if(TP.isCallable(b.getElementsByClassName)){return TP.ac(b.getElementsByClassName(c));}d='.'+c.split(' ').join(' .');return TP.nodeEvaluateCSS(b,d);});TP.definePrimitive('nodeEmptyContent',function(a){var b;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}switch(a.nodeType){case Node.ELEMENT_NODE:if(TP.isHTMLNode(a)){if(TP.boot.isUA('IE')){b=a.tagName.toLowerCase();if(/(table|thead|tbody|tfoot|tr|th|td)/.test(b)){while(a.hasChildNodes()){a.removeChild(a.lastChild);}}else{a.innerHTML='';}}else{a.innerHTML='';}}else{while(a.hasChildNodes()){TP.nodeDetach(a.lastChild);}}break;case Node.TEXT_NODE:case Node.CDATA_SECTION_NODE:case Node.PROCESSING_INSTRUCTION_NODE:case Node.COMMENT_NODE:a.data='';break;case Node.DOCUMENT_NODE:case Node.DOCUMENT_FRAGMENT_NODE:while(a.hasChildNodes()){TP.nodeDetach(a.lastChild);}break;case Node.ATTRIBUTE_NODE:a.value='';break;case Node.ENTITY_REFERENCE_NODE:case Node.ENTITY_NODE:case Node.DOCUMENT_TYPE_NODE:case Node.NOTATION_NODE:TP.raise(this,'TP.sig.UnsupportedOperation',arguments);break;default:break;}return a;});TP.definePrimitive('computeAngleFromCenter',function(h,i){var a,b,c,d,e,f,g;a=TP.coord(h);b=TP.coord(i);c=a.first();d=a.last();e=b.first();f=b.last();g=(f-d).atan2D(e-c);return g.standardizeAngle();});TP.definePrimitive('computeAngleFromEnds',function(k,l){var e,f,b,a,c,d,j,g,h,i;e=TP.coord(k);f=TP.coord(l);b=e.first();a=e.last();c=f.first();d=f.last();j=((c-b).abs()*(c-b).abs()+(d-a).abs()*(d-a).abs()).sqrt();g=b;h=a-j;i=(2*(d-h).atan2(c-g)).radiansToDegrees();return i.standardizeAngle();});TP.definePrimitive('computeCompassCorner',function(d,b,f){var e,c,a;if(!TP.isNumber(d)){return TP.raise(this,'TP.sig.InvalidNumber',arguments);}e=TP.ifInvalid(f,true);c=d;if(TP.isNumber(b)&&e){c+=360/b/2;}a=c/11.25+1.5;if(a>=33){a-=32;}a=a.floor();if(TP.isNumber(b)){a-=(a-1)%(32/b);}return a;});TP.definePrimitive('computeDistance',function(h,i){var a,b,c,d,e,f,g;a=TP.coord(h);b=TP.coord(i);c=a.first();d=a.last();e=b.first();f=b.last();g=((e-c).pow(2)+(f-d).pow(2)).sqrt();return g;});TP.definePrimitive('computeVector',function(i,j){var b,c,a,e,f,d,g,h;b=TP.coord(i);c=TP.coord(j);a=b.first();e=b.last();f=c.first();d=c.last();g=((f-a).pow(2)+(d-e).pow(2)).sqrt();h=(d-e).atan2D(f-a).standardizeAngle();return TP.ac(g,h);});TP.definePrimitive('$computeOpaqueEnabledTargetFrom',function(c){var a,b;if(!TP.isElement(c)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}a=c;b=null;while(a.nodeType!==Node.DOCUMENT_NODE){if(TP.elementHasAttribute(a,'disabled')){b=null;break;}if(TP.notValid(b)&&TP.elementHasAttribute(a,'tibet:opaque',true)){b=a;}a=a.parentNode;}return b;});TP.definePrimitive('$$checkWindowClosed',function(b,a){if(TP.notValid(b)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(TP.isEmpty(a)){return TP.raise(this,'TP.sig.InvalidString',arguments);}if(b.closed){try{TP.signal(a,'TP.sig.WindowClosed',null,null);}catch(a){}finally{TP.core.Window.removeWindowInfo(a);TP.global[a]=null;}return true;}return false;});TP.definePrimitive('open',function(h,c,e,f){var b,g,d,a;if(TP.isString(c)){if(/^top./.test(c)){d=c.slice(4,c.length);}else if(/^parent./.test(c)){d=c.slice(7,c.length);}else{d=c;}}else{d=TP.getNextWindowName();}if(TP.isString(e)){a=e;}else if(TP.notEmpty(e)){a='';e.perform(function(b){a+=b.first()+'='+b.last()+',';});a=a.chop(',');}if(TP.notEmpty(a)&&TP.boot.isUA('GECKO')){a=a.replace('top','screenY');a=a.replace('left','screenX');}if(TP.notValid(a)&&!f){b=window.open('',d);}else if(TP.notValid(a)){b=window.open('',d,null,f);}else{b=window.open('',d,a,f);}if(TP.notValid(b)){TP.raise(this,'TP.sig.WindowException',arguments,'Unable to open window');return;}if(TP.notEmpty(h)){g=TP.core.Window.construct(b);g.setLocation(h);}else{if(TP.isTrue(f)){b.document.open(TP.HTML_TEXT_ENCODED,'replace');}else{b.document.open(TP.HTML_TEXT_ENCODED);}b.document.write('<html><body></body></html>');b.document.close();g=TP.core.Window.construct(b);}return b;});TP.definePrimitive('$$processDocumentLoaded',function(a){var b,c,d;TP.debug('break.document_loaded');if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(TP.$$DEBUG){TP.boot.$stdout(a.document.documentElement,TP.TRACE);}TP.core.Window.$$isDocumentWriting=false;TP.core.Window.instrument(a);TP.windowAssignACLKeys(a);b=TP.core.Window.getWindowInfo(TP.gid(a),'loadFunctions');if(TP.notEmpty(b)){TP.core.Window.setWindowInfo(a,'loadFunctions',TP.ac());try{b=b.unique();d=b.length;for(c=0;c<d;c++){b[c](a.document);}b.empty();}catch(a){TP.ifError()?TP.error(TP.ec(a,TP.join('Pageload function: ',TP.str(b[c]),' generated error.')),TP.LOG,arguments):0;}}if(TP.isTrue(TP.core.Window.getWindowInfo(TP.gid(a),'shouldAwake'))){try{TP.nodeAwakenContent(a.document.documentElement);}catch(a){TP.ifError()?TP.error(TP.ec(a,'Window content awaken generated error.'),TP.LOG,arguments):0;}}TP.documentFocusAutofocusedElement(a.document);try{TP.signal(TP.gid(a),'TP.sig.DocumentLoaded',arguments);TP.signal('tibet://'+TP.gid(a),'TP.sig.DocumentLoaded',arguments);if(TP.sys.shouldSignalDOMLoaded()){TP.signal(TP.gid(a.document),'TP.sig.DOMContentLoaded',arguments,a.document.documentElement);TP.signal('tibet://'+TP.gid(a)+'/#document','TP.sig.DOMContentLoaded',arguments,a.document.documentElement);}}catch(a){TP.ifError()?TP.error(TP.ec(a,'TP.sig.DOMContentLoaded handler generated error.'),TP.LOG,arguments):0;}return;});TP.$$processDocumentUnloaded=function(a,e){var d,b,c;TP.debug('break.document_unloaded');if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}d=TP.ifInvalid(e,true);b=TP.gid(a);TP.signal(b,'TP.sig.DocumentUnloaded',arguments);TP.signal('tibet://'+b,'TP.sig.DocumentUnloaded',arguments);if(TP.$$processDocumentUnloaded.codeframe===a&&TP.boot.isUA('GECKO')){TP.core.Window.closeRegisteredWindows();return;}TP.core.Window.removeWindowInfo(a,'backhack1');TP.core.Window.removeWindowInfo(a,'backhack2');TP.core.Window.removeWindowInfo(a,'backhack3');if(d){c=false;TP.schedule(TP.hc('step',function(){c=TP.$$checkWindowClosed(a,b);return c;},'delay',1000,'interval',500,'limit',function(a){if(a.get('iteration')>5){return true;}if(c){return true;}return false;}));}return;};TP.definePrimitive('$$processDocumentUnloaded',TP.$$processDocumentUnloaded);TP.$$processDocumentUnloaded.codeframe=window;TP.definePrimitive('win',function(a){if(TP.notValid(a)){return;}else if(TP.isString(a)){return TP.sys.getWindowById(a);}else if(TP.isWindow(a)){return a;}else if(TP.isElement(a)&&(a.tagName.toLowerCase()==='iframe'||a.tagName.toLowerCase()==='object')){return TP.elementGetIFrameWindow(a);}else if(TP.isNode(a)){return TP.nodeGetWindow(a);}else if(TP.canInvoke(a,'getNativeWindow')){return a.getNativeWindow();}return;});TP.definePrimitive('windowAssignACLKeys',function(b,c){var a;if(!TP.isWindow(b)){return TP.raise(null,'TP.sig.InvalidWindow',arguments);}if(TP.notValid(TP.sys.getTypeByName('TP.core.User'))){return;}a=b.document;if(TP.isElement(TP.documentGetBody(a))){switch(c){case TP.ACL_REAL:TP.elementSetAttribute(TP.documentGetBody(a),TP.ACL_REAL,TP.core.User.getRealAccessKeys().join(' '),true);break;case TP.ACL_EFFECTIVE:TP.elementSetAttribute(TP.documentGetBody(a),TP.ACL_EFFECTIVE,TP.core.User.getEffectiveAccessKeys().join(' '),true);break;default:TP.elementSetAttribute(TP.documentGetBody(a),TP.ACL_REAL,TP.core.User.getRealAccessKeys().join(' '),true);TP.elementSetAttribute(TP.documentGetBody(a),TP.ACL_EFFECTIVE,TP.core.User.getEffectiveAccessKeys().join(' '),true);break;}}return;});TP.definePrimitive('windowAssignCommonIds',function(c){var b,a,d;if(!TP.isWindow(c)){return TP.raise(null,'TP.sig.InvalidWindow',arguments);}b=c.document;if(TP.isElement(a=b.documentElement)){if(TP.isEmpty(TP.elementGetAttribute(a,'id'))){if((d=a.nodeName.indexOf(':'))!==TP.NOT_FOUND){TP.elementSetAttribute(a,'id',a.nodeName.slice(d));}else{TP.elementSetAttribute(a,'id',a.nodeName);}}}if(TP.isElement(a=TP.nodeGetFirstElementByTagName(b,'head'))){b.head=a;if(TP.isEmpty(TP.elementGetAttribute(a,'id'))){TP.elementSetAttribute(a,'id','head');}}if(TP.isElement(a=TP.documentGetBody(b))){if(TP.isEmpty(TP.elementGetAttribute(a,'id'))){TP.elementSetAttribute(a,'id','body');}}return;});TP.definePrimitive('windowComputeWindowOffsets',function(h,j,i){var e,d,c,b,a,f,g;if(!TP.isWindow(h)||!TP.isWindow(j)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}e=0;d=0;c=h;while(TP.isElement(b=c.frameElement)){a=TP.elementGetBorderBox(b,i);e+=a.at('left');d+=a.at('top');c=TP.nodeGetWindow(b);}f=0;g=0;c=j;while(TP.isElement(b=c.frameElement)){a=TP.elementGetBorderBox(b,i);f+=a.at('left');g+=a.at('top');c=TP.nodeGetWindow(b);}return TP.ac(f-e,g-d);});TP.definePrimitive('windowComputeTransformationMatrix',function(d,g){var e,a,f,b,c;if(!TP.isWindow(d)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}e=TP.matrixFromCSSString('matrix(1,0,0,1,0,0)');a=e;b=d;while(TP.isElement(c=b.frameElement)){if(TP.isArray(f=TP.elementGetComputedTransformMatrix(c))){a=TP.multiplyMatrix(a,f);}b=TP.nodeGetWindow(c);}if(TP.isValid(a)&&TP.isTrue(g)){return TP.matrixAs2DMatrix(a);}return a;});TP.definePrimitive('windowGetParentNames',function(a){var b,c;if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}b=TP.ac();if(a===a.top){return b;}c=a.parent;while(c!==a.top){b.push(TP.lid(c));c=c.parent;}b.push(TP.lid(a.top));b.reverse();return b;});TP.definePrimitive('windowGetScreenWidthAndHeight',function(a){if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}return TP.ac(a.screen.availWidth,a.screen.availHeight);});TP.definePrimitive('windowIsInstrumented',function(a){if(!TP.isWindow(a)){return false;}return TP.isTrue(a.$$instrumented);});TP.definePrimitive('windowMoveBy',function(a,b,c){if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(!TP.isNumber(b)||!TP.isNumber(c)){return TP.raise(this,'TP.sig.InvalidNumber',arguments);}a.moveBy(b,c);return;});TP.definePrimitive('windowMoveTo',function(a,b,c){if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(!TP.isNumber(b)||!TP.isNumber(c)){return TP.raise(this,'TP.sig.InvalidNumber',arguments);}a.moveTo(b,c);return;});TP.definePrimitive('windowResetLocation',function(a){TP.windowStopLoading(a);(function(){var b,c,d,e;b=a.location.toString();a.frameElement.setAttribute('tibet_settinglocation',b);b=decodeURI(b);if(b.contains('#')){c=b.split('#');d=c.last();b=TP.atob(d);}e=TP.uc(b);TP.tpwin(a).setContent(e,TP.request('loadFunc',function(b){a.frameElement.removeAttribute('tibet_settinglocation');}));}.afterUnwind());});TP.definePrimitive('windowSetupBackKeyHandlers',function(a){if(!TP.isWindow(a)){return;}if(TP.boot.isUA('GECKO')||TP.boot.isUA('WEBKIT')){a.document.documentElement.addEventListener('keypress',function(a){if(a.keyCode===TP.BACK_SPACE_KEY&&a.target===this){a.preventDefault();}},false);}else if(TP.boot.isUA('IE')){TP.documentGetBody(a.document).attachEvent('onkeydown',function(b){if(b.keyCode===TP.BACK_SPACE_KEY&&b.srcElement===TP.documentGetBody(a.document)){b.returnValue=false;}});}return;});TP.definePrimitive('windowSetupFocusHandlers',function(a){if(!TP.isWindow(a)){return;}if(TP.boot.isUA('GECKO')){a.addEventListener('focus',function(c){var b;if(c.target===a){if(TP.isElement(b=TP.documentGetBody(TP.sys.getUICanvas(true).document))){b.focus();}}},false);}else if(TP.boot.isUA('WEBKIT')){a.addEventListener('focus',function(b){if(b.target===a){TP.sys.getUICanvas(true).focus();}});}else if(TP.boot.isUA('IE')){a.attachEvent('onfocus',function(b){if(b.srcElement===a){TP.sys.getUICanvas(true).focus();}});}return;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETStringPrimitivesPost.js';
TP.runConditionalFunction(TP.hc('test','trident','true',function(){TP.defineAttribute(TP,'$$atobData',TP.ac());TP.definePrimitive('$$atobInit',function(){var a;for(a=0;a<26;a++){TP.$$atobData.push(String.fromCharCode(65+a));}for(a=0;a<26;a++){TP.$$atobData.push(String.fromCharCode(97+a));}for(a=0;a<10;a++){TP.$$atobData.push(String.fromCharCode(48+a));}TP.$$atobData.push('+');TP.$$atobData.push('/');});TP.$$atobInit();TP.defineAttribute(TP,'$$btoaData',TP.ac());TP.definePrimitive('$$btoaInit',function(){var a;for(a=0;a<128;a++){TP.$$btoaData.push(-1);}for(a=0;a<64;a++){TP.$$btoaData[TP.$$atobData[a].charCodeAt(0)]=a;}});TP.$$btoaInit();}));TP.definePrimitive('atob',TP.hc('test','trident','true',function(j){var c,d,g,f,a,b,i,e,h;if(!TP.isString(j)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}i=j.split('');h=0;e='';b=0;do{f=i[h++].charCodeAt(0);a=TP.$$btoaData[f];if(f>=0&&f<128&&a!==-1){if(b%4===0){c=a<<2;}else if(b%4===1){c=c|a>>4;d=(a&15)<<4;}else if(b%4===2){d=d|a>>2;g=(a&3)<<6;}else{g=g|a;}b++;if(b%4===0){e+=String.fromCharCode(c)+String.fromCharCode(d)+String.fromCharCode(g);}}}while(TP.isDefined(i[h]));if(b%4===3){e+=String.fromCharCode(c)+String.fromCharCode(d);}else if(b%4===2){e+=String.fromCharCode(c);}return e;},TP.DEFAULT,function(a){try{return atob(a);}catch(a){return;}}));TP.definePrimitive('btoa',TP.hc('test','trident','true',function(j){var d,e,f,l,k,g,h,b,c,i,a;if(TP.notValid(j)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}b=TP.str(j).split('');c=-1;i='';a=0;while(a===0){d=TP.isDefined(b[++c])?b[c].charCodeAt(0):(a=1)?0:0;e=TP.isDefined(b[++c])?b[c].charCodeAt(0):(a+=1)?0:0;f=TP.isDefined(b[++c])?b[c].charCodeAt(0):(a+=1)?0:0;l=TP.$$atobData[d>>2];k=TP.$$atobData[(3&d)<<4|e>>4];g=TP.$$atobData[(15&e)<<2|f>>6];h=TP.$$atobData[f&63];if(a>=1){h='=';}if(a===2){g='=';}if(a<3){i+=l+k+g+h;}}return i;},TP.DEFAULT,function(a){return btoa(a);}));TP.definePrimitive('utf82unicode',function(c){var d,a,b,e,f;d='';a=0;while(a<c.length){b=c.charCodeAt(a);if(b<128){d+=String.fromCharCode(b);a++;}else if(b>=192&&b<224){e=c.charCodeAt(a+1);d+=String.fromCharCode((b&31)<<6|e&63);a+=2;}else{e=c.charCodeAt(a+1);f=c.charCodeAt(a+2);d+=String.fromCharCode((b&15)<<12|(e&63)<<6|f&63);a+=3;}}return d;});TP.definePrimitive('utf8decode',function(a){if(a.length>0&&a.charCodeAt(0)===157){return TP.utf82unicode(a.substring(1));}return a;});TP.definePrimitive('utf8encode',function(a){var c,b;c=false;for(b=0;b<a.length;b++){if(a.charCodeAt(b)===157||a.charCodeAt(b)>255){c=true;break;}}if(!c){return a;}return String.fromCharCode(157)+TP.unicode2utf8(a);});TP.definePrimitive('unicode2utf8',function(d){var b,c,a;b='';for(c=0;c<d.length;c++){a=d.charCodeAt(c);if(a<=127){b+=String.fromCharCode(a);}else if(a>=128&&a<=2047){b+=String.fromCharCode(a>>6|192);b+=String.fromCharCode(a&63|128);}else{b+=String.fromCharCode(a>>12|224);b+=String.fromCharCode(a>>6&63|128);b+=String.fromCharCode(a&63|128);}}return b;});TP.definePrimitive('stringFindDelimiterIndex',function(b,d,h,e){var a,k,c,i,j,g,f;if(TP.isNumber(e)){a=b.indexOf(d,e);}else if(TP.isString(e)){a=b.indexOf(d,b.indexOf(e)+e.getSize());}else{a=b.indexOf(d);}a+=d.getSize();k=TP.rc(TP.regExpEscape(d),'g');g=h.getSize();while((c=b.indexOf(h,a))!==-1){i=b.slice(a,c);if(!k.test(i)){return c;}else{j=i.match(k).getSize();f=c+g;while((c=b.indexOf(h,f))!==-1&&j>0){j--;f=c+g;}a=f-g;}}return-1;});TP.definePrimitive('stringMatchRecursive',function(g,h,l,k){var b,j,c,i,d,a,f,e;b=k||'';j=b.indexOf('g')>-1;c=TP.rc(h+'|'+l,'g'+b);i=TP.rc(h,b.strip(/g/g));d=TP.ac();do{a=0;while(e=c.exec(g)){if(i.test(e.at(0))){if(!a++){f=c.lastIndex;}}else if(a>0){if(!--a){d.push(g.slice(f,e.index));if(!j){return d;}}}}}while(a>0&&(c.lastIndex=f));return d;});TP.definePrimitive('stringTokenizeUsingDelimiters',function(a,e,h,i,l,k){var c,j,f,b,d,g;c=TP.ac();j=e.getSize();f=h.getSize();b=a.indexOf(e);if(b===TP.NOT_FOUND){return a;}c.push(a.slice(0,b));g=i.getSize();while((d=TP.stringFindDelimiterIndex(a,e,h,b))!==-1){i.push(a.slice(b+j,d));c.push(l,g++,k);if((b=a.indexOf(e,d+f))===TP.NOT_FOUND){break;}c.push(a.slice(d+f,b));}c.push(a.slice(d+f));return c.join('');});TP.definePrimitive('stringUntokenizeUsingDelimiters',function(a,b,c,d,e,f){return a.replace(TP.rc(e+'(\\d+)'+f,'g'),function(e,a){return b+d.at(parseInt(a,10))+c;});});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETCSSPrimitivesPre.js';
TP.regex.STYLE_CAPTURE=/<style.*?>(?:<!\[CDATA\[)*([\s\S]*?)(?:\]\]>)*<\/style>/g;TP.regex.CSS_PIXEL=/^-?[\d\.]+(px)?$/i;TP.regex.CSS_UNIT=/(^|\s+)-?([\d\.]+)(%|in|cm|mm|em|ex|pt|pc|px)/;TP.regex.CSS_NON_RELATIVE_UNIT=/(^|\s+)-?([\d\.]+)(in|cm|mm|pt|pc|px)/;TP.regex.CSS_HEX=/#?([A-F0-9]{3})?([A-F0-9]{3}){1}$/i;TP.regex.CSS_RGB=/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/;TP.regex.CSS_RGBA=/rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\,\s*([\d.]+)\s*\)/;TP.regex.CSS_HSL=/hsl\s*\(\s*(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%\s*\)/;TP.regex.CSS_HSLA=/hsla\s*\(\s*(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%\s*\,\s*([\d.]+)\s*\)/;TP.regex.CSS_NON_NAME_COLOR=/(#?([A-F0-9]{3})?([A-F0-9]{3}){1})(\s+|$)|(rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\))|(rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\,\s*([\d.]+)\s*\))|(hsl\s*\(\s*(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%\s*\))|(hsla\s*\(\s*(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%\s*\,\s*([\d.]+)\s*\))/gi;TP.regex.CSS_COLOR=/(#?([A-F0-9]{3})?([A-F0-9]{3}){1})(\s+|$)|(rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\))|(rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\,\s*([\d.]+)\s*\))|(hsl\s*\(\s*(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%\s*\))|(hsla\s*\(\s*(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%\s*\,\s*([\d.]+)\s*\))|(?:^|\s+)[A-Z]+(?:\s+|$)/i;TP.regex.CSS_COLOR_GLOBAL=/(#?([A-F0-9]{3})?([A-F0-9]{3}){1})(\s+|$)|(rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\))|(rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\,\s*([\d.]+)\s*\))|(hsl\s*\(\s*(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%\s*\))|(hsla\s*\(\s*(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%\s*\,\s*([\d.]+)\s*\))|(?:^|\s+)[A-Z]+(?:\s+|$)/gi;TP.regex.CSS_TRANSFORM=/^(matrix|rotate|scale|skewX|skewY|translate)\s*\(.+?\)$/;TP.regex.CSS_GRADIENT=/^(gradient-linear|gradient-radial)\s*\(.+?\)$/;TP.regex.CSS_PATTERN=/^pattern\s*\(.+?\)$/;TP.regex.COMBINATOR=/\s*[>+~\s]+\s*/;TP.regex.ATTR_SELECTOR=/\[([\w|:]+)([~=|*^$]*)['"]*(\w*)['"]*/g;TP.regex.CSS_NATIVE_CUSTOM=/-(moz|ms|webkit)/;TP.regex.CUSTOM_DECLARATIONS=/(^|\s+)-((?!moz|ms|webkit)[-\w]+)\s*:\s*([^;]+);?/g;TP.regex.CUSTOM_DECLARATIONS_NAME=/^-((?!moz|ms|webkit)[-\w]+)/;TP.regex.CUSTOM_DECLARATIONS_VALUE=/^((?!attr|var|calc|hsl|hsla)\(|url\(~)/;TP.regex.CSS_PNG_IMAGE=/(^|\s+|;)(.+image:)\s*(url\()?['"]?(.*?\.png)['"]?(\))?;?/g;TP.regex.PCLASS_CONVERSION=new RegExp(':(hover|active|focus)','g');TP.regex.PCLASS_CHANGE=new RegExp('^(hover|active|focus)$');TP.regex.UNSUPPORTED_SELECTOR=new RegExp(':()');TP.definePrimitive('$escapeCSSConstructs',function(a){return a;});TP.definePrimitive('$unescapeCSSConstructs',function(a){return a;});TP.definePrimitive('$nodeEscapeCSSConstructs',function(d){var a,b,e,f,c;a=d;if(TP.nodeGetNSURI(a)!==TP.w3.Xmlns.XHTML){return a;}if(TP.isDocument(a)){b=TP.nodeGetFirstElementByTagName(a,'head');}else if(TP.elementGetLocalName(a).toLowerCase()==='head'){b=a;}if(TP.notValid(b)){return a;}e=TP.nodeDetectDescendantElement(b,function(b){var a;a=TP.elementGetLocalName(b).toLowerCase();return a==='link'||a==='style';});if(TP.notValid(e)){return a;}f=TP.str(a);c=TP.$escapeCSSConstructs(f);if(TP.isDocument(d)){a=TP.documentFromString(c,null,true);if(!TP.isDocument(a)){TP.raise(this,'TP.sig.InvalidDocument',arguments,'Unable to escape style. Missing CDATA block?');return;}}else{a=TP.nodeFromString(c,null,true);if(!TP.isNode(a)){TP.raise(this,'TP.sig.InvalidNode',arguments,'Unable to escape style. Missing CDATA block?');return;}}return a;});TP.definePrimitive('$elementProcessCSSAttributeChange',function(b,c,d,a){if(TP.isCallable(a)){a();}return;});TP.definePrimitive('$elementCSSFlush',function(a){return;});TP.definePrimitive('matrixAs2DMatrix',function(a){var b;if(a.length===2){return a;}b=[[a[0][0],a[1][0],a[0][3]],[a[0][1],a[1][1],a[1][3]]];return b;});TP.definePrimitive('matrixAs3DMatrix',function(a){var b;if(a.length===4){return a;}b=[[a[0],a[1],0,0],[a[2],a[3],0,0],[0,0,1,0],[a[4],a[5],0,1]];return b;});TP.definePrimitive('matrixFromCSSString',function(e,f){var a,b,c,d;if(!/matrix3?d?\(([^\)]+)\)/i.test(e)){return null;}a=e.match(/matrix3?d?\(([^\)]+)\)/i)[1].split(',');if(a.length===6){a=[a[0],a[1],0,0,a[2],a[3],0,0,0,0,1,0,a[4],a[5],0,1];}b=[];for(c=0;c<4;c++){for(d=0;d<4;d++){b[c]=b[c]||[];b[c][d]=parseFloat(a[d*4+c]);}}if(TP.isValid(b)&&TP.isTrue(f)){return TP.matrixAs2DMatrix(b);}return b;});TP.definePrimitive('multiplyMatrix',function(e,g){var b=[],a,c,d,f;for(a=0;a<e.length;a++){for(c=0;c<g[0].length;c++){f=0;for(d=0;d<e[0].length;d++){f+=e[a][d]*g[d][c];}b[a]=b[a]||[];b[a][c]=f;}}return b;});TP.definePrimitive('translateMatrix',function(d){var a,b,c=[];for(a=0;a<4;a++){c[a]=[];for(b=0;b<4;b++){c[a][b]=d[a][b]+(b===3?+arguments[1+a]||0:0);}}return c;});TP.definePrimitive('matrixTransformPoint',function(b,c,d){var a;if(b.length===4){a=TP.matrixAs2DMatrix(b);}else{a=b;}return[a[0][0]*c+a[0][1]*d+a[0][2],a[1][0]*c+a[1][1]*d+a[1][2]];});TP.definePrimitive('matrixTransformRect',function(b,c,d,e,f){var a;if(b.length===4){a=TP.matrixAs2DMatrix(b);}else{a=b;}return[a[0][0]*c+a[0][1]*d+a[0][2],a[1][0]*c+a[1][1]*d+a[1][2],a[0][0]*e+a[0][1]*f,a[1][0]*e+a[1][1]*f];});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETCSSPrimitivesBase.js';
TP.definePrimitive('elementGetAttribute',function(b,d,f){var e,a,c;a=TP.$elementGetAttribute(b,d,f);if(TP.notEmpty(a)){return a;}try{if(TP.isString(c=b.getAttribute(d))&&TP.isString(c.value)){return c.value;}}catch(a){}if(!TP.isXMLDocument(TP.nodeGetDocument(b))){if(TP.regex.PCLASS_CHANGE.test(d)){e='pclass:'+d;if(!TP.elementHasAttribute(b,e,true)){return'';}a=TP.$elementGetAttribute(b,e);if(TP.notEmpty(a)){return a;}try{a=b.getAttribute(e);if(TP.isString(c=b.getAttribute(d))&&TP.isString(c.value)){return c.value;}}catch(a){}}}return TP.notValid(a)?'':a;});TP.definePrimitive('elementSetAttribute',function(a,d,c,h){var b,e,f,g;if(TP.isHTMLNode(a)){if(TP.regex.PCLASS_CHANGE.test(d)){b='pclass:'+d;}else{b=d;}if(TP.isType(g=TP.sys.getTypeByName('css:sheet'))){e=a.getAttribute(b);if(e===c){return;}f=TP.hc('targetElement',a,'attribute',b,'oldValue',e,'newValue',c,'operation',TP.notEmpty(e)?TP.UPDATE:TP.CREATE);g.willChangeAttribute(f);TP.$elementSetAttribute(a,b,c,false);g.didChangeAttribute(f);}else{TP.$elementSetAttribute(a,b,c,false);}TP.$elementCSSFlush(a);}else{TP.$elementSetAttribute(a,d,c,h);}return;});TP.definePrimitive('documentAddCSSElement',function(a,c,e){var f,d,b;if(!TP.isDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}f=TP.documentEnsureHeadElement(a);if(TP.isTrue(e)){d=TP.uc(c).getResourceText(TP.hc('async',false));b=TP.documentAddStyleElement(a,d);}else{b=TP.documentAddLinkElement(a,c);}return b;});TP.definePrimitive('documentAddLinkElement',function(b,e,f){var c,a,d;if(!TP.isDocument(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}c=TP.documentEnsureHeadElement(b);a=TP.documentCreateElement(b,'link',TP.w3.Xmlns.XHTML);TP.elementSetAttribute(a,'type',TP.CSS_TEXT_ENCODED);TP.elementSetAttribute(a,'rel','stylesheet');d=TP.ifInvalid(f,null);TP.nodeInsertBefore(c,a,d,false);TP.elementSetAttribute(a,'href',e);return a;});TP.definePrimitive('documentAddStyleElement',function(b,c,f){var d,a,e;if(!TP.isDocument(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}d=TP.documentEnsureHeadElement(b);a=TP.documentCreateElement(b,'style',TP.w3.Xmlns.XHTML);TP.elementSetAttribute(a,'type',TP.CSS_TEXT_ENCODED);e=TP.ifInvalid(f,null);TP.nodeInsertBefore(d,a,e,false);if(TP.isString(c)){TP.styleElementSetContent(a,c);}return a;});TP.definePrimitive('documentCopyCSSElements',function(c,d){var a,b,e;if(!TP.isDocument(d)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(!TP.isArray(c)){return TP.raise(this,'TP.sig.InvalidArray',arguments);}for(a=0;a<c.getSize();a++){b=c.at(a);e=TP.elementGetLocalName(b).toLowerCase();if(e==='link'){TP.documentCopyCSSLinkElement(b,d);}else if(e==='style'){TP.documentCopyCSSStyleElement(b,d);}}return;});TP.definePrimitive('documentCopyCSSLinkElement',function(a,b,m,l){var j,e,h,f,c,i,g,d,k;if(!TP.isDocument(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.elementGetLocalName(a).toLowerCase()!=='link'||TP.elementGetAttribute(a,'rel')!=='stylesheet'){return TP.raise(this,'TP.sig.InvalidElement',arguments);}j=TP.ifInvalid(l,false);e=TP.elementGetAttribute(a,'href');h=b.getElementsByTagName('head')[0];if(TP.isElement(h)&&j){f=TP.nodeGetElementsByTagName(h,'link');for(c=0;c<f.getSize();c++){if(f.at(c).rel==='stylesheet'&&TP.elementGetAttribute(f.at(c),'href')===e){return f.at(c);}}}i=TP.uriCollectionPath(TP.documentGetLocation(TP.nodeGetDocument(a)));if(TP.sys.shouldProcessCSS()&&!TP.elementHasAttribute(a,'tibet:opaque',true)&&!TP.elementHasAttribute(a,'dontprocess')){g=TP.uc(e).getResourceText(TP.hc('async',false));d=TP.documentAddStyleElement(b,g);k=TP.nodeGetWindow(b);TP.$windowProcessCSSStyleElement(k,d,i);return;}else if(TP.isTrue(m)){g=TP.uc(e).getResourceText(TP.hc('async',false));d=TP.documentAddStyleElement(b,g);}else{d=TP.documentAddLinkElement(b,TP.uriJoinPaths(i,e));}return d;});TP.definePrimitive('documentCopyCSSStyleElement',function(a,b){var d,c,e,f;if(!TP.isDocument(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.elementGetLocalName(a).toLowerCase()!=='style'){return TP.raise(this,'TP.sig.InvalidElement',arguments);}d=TP.styleElementGetContent(a);c=TP.documentAddStyleElement(b,d);if(TP.sys.shouldProcessCSS()&&!TP.elementHasAttribute(a,'tibet:opaque',true)&&!TP.elementHasAttribute(a,'dontprocess')){e=TP.nodeGetWindow(b);f=TP.uriCollectionPath(TP.documentGetLocation(TP.nodeGetDocument(a)));TP.$windowProcessCSSStyleElement(e,c,f);}else{return c;}return;});TP.definePrimitive('documentGetNativeCSSElements',function(c){var a,d,e,b;if(!TP.isDocument(c)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}d=TP.nodeGetElementsByTagName(c,'head');if(!TP.isElement(a=d.at(0))){return TP.ac();}e=TP.nodeGetElementsByTagName(a,'link');b=e.select(function(a){if(TP.elementGetAttribute(a,'rel')==='stylesheet'&&TP.elementGetAttribute(a,'type')===TP.CSS_TEXT_ENCODED){return true;}return false;});b.addAll(TP.nodeGetElementsByTagName(a,'style'));return b;});TP.definePrimitive('documentGetNativeStyleRules',function(b){var c,d,a;if(!TP.isHTMLDocument(b)&&!TP.isXHTMLDocument(b)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}c=b.styleSheets;d=TP.ac();for(a=0;a<c.length;a++){d.addAll(TP.styleSheetGetStyleRules(c[a]));}return d;});TP.definePrimitive('documentGetStyleRules',function(a){return TP.documentGetNativeStyleRules(a);});TP.definePrimitive('$documentRefreshAppliedRulesCaches',function(a){var e,b,f,g,c,d;if(!TP.isHTMLDocument(a)&&!TP.isXHTMLDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}a.appliedRules=TP.ac();e=TP.documentGetNativeStyleRules(a);for(b=0;b<e.getSize();b++){f=e.at(b);g=TP.nodeEvaluateCSS(null,f.selectorText);for(c=0;c<g.getSize();c++){d=g.at(c);if(TP.notValid(d.appliedRules)){d.appliedRules=TP.ac();}d.appliedRules.push(f);}}return;});TP.definePrimitive('elementGetComputedStyleObj',function(a){var b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isDocument(b=TP.nodeGetDocument(a))){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}return TP.nodeGetWindow(b).getComputedStyle(a,null);});TP.definePrimitive('elementGetPixelValue',function(d,b,c,e){var h,a,f,i,g;if(!TP.isElement(d)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidString',arguments);}if(TP.regex.CSS_PIXEL.test(b)){if(TP.isNaN(a=parseFloat(b))){return 0;}return TP.isTrue(e)?TP.elementTransformCSSPixelValue(d,a,c):a;}if(!TP.regex.CSS_UNIT.test(b)){switch(b){case'inherit':if(TP.isElement(h=d.parentNode)){return TP.elementGetPixelValue(h,b,c,e);}break;case'initial':return NaN;case'normal':return NaN;case'thin':case'medium':case'thick':if(/border.*?Width/.test(c)){switch(b){case'thin':a=2;break;case'medium':a=4;break;case'thick':a=6;break;}return TP.isTrue(e)?TP.elementTransformCSSPixelValue(d,a,c):a;}return NaN;case'auto':case'none':default:return NaN;}return;}if(TP.regex.CSS_NON_RELATIVE_UNIT.test(b)){a=TP.regex.CSS_NON_RELATIVE_UNIT.exec(b);f=parseFloat(a.at(2));i=a.at(3);g=TP.getPixelsPerPoint();switch(i){case'pt':a=g*f;break;case'in':a=g*f*72;break;case'pc':a=g*f*12;break;case'mm':a=g*(f/(7.2/2.54));break;case'cm':a=g*(f/(72/2.54));break;default:break;}return TP.isTrue(e)?TP.elementTransformCSSPixelValue(d,a,c):a;}if(TP.regex.PERCENTAGE.test(b)){if(TP.notValid(c)){TP.ifError()?TP.error('Percentage computation needs target property',TP.CSS_LOG,arguments):0;return 0;}return TP.elementGetNumericValueFromPercentage(d,c,b,e);}return TP.elementConvertUnitLengthToPixels(d,b,c,e);});TP.definePrimitive('elementGetPseudoInlineStyleObj',function(c){var h,f,d,a,j,e,g,i,b;if(!TP.isElement(c)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}h=false;if(!TP.isElement(f=TP.nodeGetElementById(TP.nodeGetDocument(c),'pseudo_inline_rules'))){if(!TP.isElement(f=TP.documentAddStyleElement(TP.nodeGetDocument(c)))){}TP.elementSetAttribute(f,'id','pseudo_inline_rules');h=true;}d=TP.cssElementGetStyleSheet(f);a=d.cssRules?d.cssRules:d.rules;if(TP.isNumber(j=c._pseudoInlineRuleIndex)){if(TP.isValid(e=a[j])&&e.type===CSSRule.STYLE_RULE){return e.style;}}g=TP.lid(c,true);TP.elementSetAttribute(c,'pseudoinline',g);i='*[id="'+g+'"][pseudoinline="'+g+'"]';if(!h){for(b=0;b<a.length;b++){if(a[b].type===a[b].STYLE_RULE&&a[b].selectorText===i){e=a[b];c._pseudoInlineRuleIndex=b;return e.style;}}}TP.styleSheetInsertRule(d,i,'');a=d.cssRules?d.cssRules:d.rules;c._pseudoInlineRuleIndex=a.length-1;return a[a.length-1].style;});TP.definePrimitive('elementTransformCSSPixelValue',function(b,a,c){if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(!TP.isNumber(a)){return TP.raise(this,'TP.sig.InvalidNumber',arguments);}if(!TP.isString(c)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(/(top|bottom)/i.test(c)){return TP.elementLocalToGlobalXY(b,0,a).last();}else if(/(left|right)/i.test(c)){return TP.elementLocalToGlobalXY(b,a,0).first();}else{return a;}});TP.definePrimitive('styleElementGetContent',function(a){if(!TP.isElement(a)||TP.elementGetLocalName(a).toLowerCase()!=='style'){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.notValid(a.firstChild)){return'';}return a.firstChild.nodeValue;});TP.definePrimitive('styleElementSetContent',function(a,b){var c;if(!TP.isElement(a)||TP.elementGetLocalName(a).toLowerCase()!=='style'){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.notValid(c=a.firstChild)){TP.nodeAppendChild(a,TP.nodeGetDocument(a).createTextNode(b),false);}else{c.nodeValue=b;}return;});TP.definePrimitive('styleRuleGetStyleSheet',function(a){if(TP.notValid(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}return a.parentStyleSheet;});TP.definePrimitive('styleSheetGetStyleRules',function(d,f){var c,b,e,a;if(TP.notValid(d)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}e=TP.ifInvalid(f,true);c=TP.ac();b=d.cssRules;for(a=0;a<b.length;a++){if(e&&b[a].type===b[a].IMPORT_RULE){c.addAll(TP.styleSheetGetStyleRules(b[a].styleSheet));}else{c.push(b[a]);}}return c;});TP.definePrimitive('styleSheetGetStyleRulesMatching',function(e,d){var c,b,a;if(TP.notValid(e)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.isEmpty(d)){return TP.raise(this,'TP.sig.InvalidString',arguments);}c=TP.ac();b=e.cssRules;for(a=0;a<b.length;a++){if(b[a].type===b[a].IMPORT_RULE){c.addAll(TP.styleSheetGetStyleRulesMatching(b[a].styleSheet,d));}else if(b[a].selectorText===d){c.push(b[a]);}}return c;});TP.definePrimitive('styleSheetInsertRule',function(a,c,e,f){var d,b;if(TP.notValid(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.isEmpty(c)){return TP.raise(this,'TP.sig.InvalidString',arguments);}d=TP.ifInvalid(e,'');b=TP.ifInvalid(f,a.cssRules.length);a.insertRule(TP.join(c,'{',d,'}'),b);return b;});TP.definePrimitive('styleSheetRemoveRule',function(a,b){if(TP.notValid(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}a.deleteRule(b);return;});TP.definePrimitive('cssElementGetStyleSheet',function(a){var b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}b=TP.elementGetLocalName(a).toLowerCase();if(b!=='link'&&b!=='style'){return TP.raise(this,'TP.sig.InvalidElement',arguments);}return a.sheet;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETCSSPrimitivesPlatform.js';
TP.definePrimitive('$elementCSSFlush',TP.hc('test','trident','true',function(a){a.className=a.className;return;},TP.DEFAULT,function(a){return;}));TP.definePrimitive('$eventHandleStyleInsertion',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(c){var a,b;a=c.target;if(!TP.isElement(a)){return;}b=TP.nodeGetWindow(a);if(TP.elementHasAttribute(a,'tibet:opaque',true)){TP.elementSetAttribute(a,'dontprocess','true');return;}if(a.tagName.toLowerCase()==='style'){if(TP.notValid(b.$globalStyleElements)){b.$globalStyleElements=TP.ac();}b.$globalStyleElements.push(a);TP.nodeDetach(a);}if(a.tagName.toLowerCase()==='link'){if(TP.elementGetAttribute(a,'rel')!=='stylesheet'){return;}if(TP.notValid(b.$globalLinkElements)){b.$globalLinkElements=TP.ac();}b.$globalLinkElements.push(a);TP.nodeDetach(a);}return;},'webkit',function(d){var a,b,c;a=d.target;if(!TP.isElement(a)){return;}c=TP.nodeGetDocument(a);if(c.readyState==='complete'){return;}b=TP.nodeGetWindow(a);if(TP.elementHasAttribute(a,'tibet:opaque',true)){TP.elementSetAttribute(a,'dontprocess','true');return;}if(a.tagName.toLowerCase()==='style'){if(TP.notValid(b.$globalStyleElements)){b.$globalStyleElements=TP.ac();}b.$globalStyleElements.push(a);TP.nodeDetach(a);}if(a.tagName.toLowerCase()==='link'){if(TP.elementGetAttribute(a,'rel')!=='stylesheet'){return;}if(TP.notValid(b.$globalLinkElements)){b.$globalLinkElements=TP.ac();}b.$globalLinkElements.push(a);TP.nodeDetach(a);}return;}));TP.definePrimitive('elementClearStyleProperty',TP.hc('test','trident','true',function(a,b){if(b==='clip'){TP.elementGetStyleObj(a).cssText=a.style.cssText.strip(/\s*clip(top|right|bottom|left)?:.+?(;\s*|$)/i);return;}TP.elementGetStyleObj(a)[b]='';return;},TP.DEFAULT,function(a,b){TP.elementGetStyleObj(a)[b]='';return;}));TP.definePrimitive('elementConvertUnitLengthToPixels',TP.hc('test','trident','true',function(b,e,h,i){var a,c,f,g,d;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(e)){return TP.raise(this,'TP.sig.InvalidString',arguments);}if(!TP.regex.CSS_UNIT.test(e)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}a=TP.ifInvalid(h,'left');a=a.toLowerCase();switch(a){case'top':c='pixelTop';break;case'right':c='pixelRight';break;case'bottom':c='pixelBottom';break;case'left':c='pixelLeft';break;case'width':c='pixelWidth';break;case'height':c='pixelHeight';break;default:a='left';c='pixelLeft';break;}f=b.style[a];g=b.runtimeStyle[a];b.runtimeStyle[a]=b.currentStyle[a];b.style[a]=e||0;d=b.style[c];b.style[a]=f;b.runtimeStyle[a]=g;if(TP.isNaN(d)){return 0;}if(TP.isTrue(i)){return TP.elementTransformCSSPixelValue(b,d,a);}return d;},TP.DEFAULT,function(b,e,h,i){var a,c,f,g,d;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(e)){return TP.raise(this,'TP.sig.InvalidString',arguments);}if(!TP.regex.CSS_UNIT.test(e)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}a=TP.ifInvalid(h,'left');a=a.toLowerCase();c=TP.elementGetStyleObj(b);f=c[a];c[a]=e||0;g=TP.elementGetComputedStyleObj(b);try{d=parseInt(g.getPropertyCSSValue(a).getFloatValue(CSSPrimitiveValue.CSS_PX),10);}catch(a){return 0;}c[a]=f;if(TP.isNaN(d)){return 0;}if(TP.isTrue(i)){return TP.elementTransformCSSPixelValue(b,d,a);}return d;}));TP.definePrimitive('elementGetAppliedNativeStyleRules',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a){var b,c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}b=TP.ac();c=TP.executePrivileged(TP.ACCESS_DOM_INSPECT,TP.sc('This TIBET-based application would like to read style '+'rules'),TP.sc('This TIBET-based application cannot read style rules'),false,function(){var e,d,c;try{e=Components.classes['@mozilla.org/inspector/dom-utils;1'].getService(Components.interfaces.nsIDOMUtils);}catch(a){TP.raise(this,'TP.sig.DOMComponentException',arguments,TP.ec(a));return false;}d=e.getCSSStyleRules(a);for(c=0;c<d.Count();c++){b.push(d.GetElementAt(c));}});if(!c){if(TP.notValid(a.appliedRules)){TP.$documentRefreshAppliedRulesCaches(TP.nodeGetDocument(a));}b=a.appliedRules;}return b;},'trident',function(a){var b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}b=TP.ac();if(TP.notValid(a.appliedRules)){TP.$documentRefreshAppliedRulesCaches(TP.nodeGetDocument(a));}b=a.appliedRules;return b;},'webkit',function(a){var b,e,d,c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}b=TP.ac();e=TP.nodeGetWindow(a);try{d=e.getMatchedCSSRules(a,'');for(c=0;c<d.length;c++){b.push(d[c]);}}catch(c){if(TP.notValid(a.appliedRules)){TP.$documentRefreshAppliedRulesCaches(TP.nodeGetDocument(a));}b=a.appliedRules;}return b;}));TP.definePrimitive('styleRuleGetSourceInfo',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(a){var b,c;if(TP.notValid(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(!TP.sys.shouldRequestPrivileges()){TP.sys.logSecurity('Permission not available to read style rule origin.',TP.TRACE,arguments);return;}b=a.parentStyleSheet;TP.executePrivileged(TP.ACCESS_DOM_INSPECT,TP.sc('This TIBET-based application would like to read style'+' rule info'),TP.sc('This TIBET-based application cannot read style rule info'),false,function(){var f,d,e;try{f=Components.classes['@mozilla.org/inspector/dom-utils;1'].getService(Components.interfaces.nsIDOMUtils);}catch(a){return TP.raise(this,'TP.sig.DOMComponentException',arguments,TP.ec(a));}if(TP.isEmpty(d=b.href)){d='style element';}if(a.type===CSSRule.STYLE_RULE){e=f.getRuleLine(a);}else{e='';}c=TP.ac(d,e);});return c;},'trident',function(c){var a,b,d;if(TP.notValid(c)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.notValid(a=TP.styleRuleGetStyleSheet(c))){return TP.ac();}if(TP.isFalse(a.readOnly)){b='style element';}else{b=a.href;}d='';return TP.ac(b,d);},'webkit',function(a){if(TP.notValid(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}return TP.todo();}));
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETCSSPrimitivesPost.js';
TP.CSS_ALL_PROPERTIES=TP.ac('azimuth','background','backgroundAttachment','backgroundColor','backgroundImage','backgroundPosition','backgroundRepeat','border','borderCollapse','borderColor','borderSpacing','borderStyle','borderTop','borderRight','borderBottom','borderLeft','borderTopColor','borderRightColor','borderBottomColor','borderLeftColor','borderTopStyle','borderRightStyle','borderBottomStyle','borderLeftStyle','borderTopWidth','borderRightWidth','borderBottomWidth','borderLeftWidth','borderWidth','bottom','captionSide','clear','clip','color','content','counterIncrement','counterReset','cssFloat','cue','cueAfter','cueBefore','cursor','direction','display','elevation','emptyCells','font','fontFamily','fontSize','fontSizeAdjust','fontStretch','fontStyle','fontVariant','fontWeight','height','imeMode','length','left','letterSpacing','lineHeight','listStyle','listStyleImage','listStylePosition','listStyleType','margin','marginTop','marginRight','marginBottom','marginLeft','markerOffset','marks','maxHeight','maxWidth','minHeight','minWidth','opacity','orphans','outline','outlineColor','outlineOffset','outlineStyle','outlineWidth','overflow','overflowX','overflowY','padding','paddingTop','paddingRight','paddingBottom','paddingLeft','page','pageBreakAfter','pageBreakBefore','pageBreakInside','parentRule','pause','pauseAfter','pauseBefore','pitch','pitchRange','pointerEvents','position','quotes','richness','right','size','speak','speakHeader','speakNumeral','speakPunctuation','speechRate','stress','tableLayout','textAlign','textDecoration','textIndent','textShadow','textTransform','top','unicodeBidi','verticalAlign','visibility','voiceFamily','volume','whiteSpace','width','widows','wordSpacing','wordWrap','zIndex');TP.CSS_COLOR_PROPERTIES=TP.ac('backgroundColor','borderColor','borderBottomColor','borderLeftColor','borderRightColor','borderTopColor','color','outlineColor');TP.CSS_LENGTH_PROPERTIES=TP.ac('borderWidth','borderBottomWidth','borderLeftWidth','borderRightWidth','borderTopWidth','bottom','fontSize','height','left','letterSpacing','lineHeight','margin','marginBottom','marginLeft','marginRight','marginTop','maxHeight','maxWidth','minHeight','minWidth','outlineWidth','padding','paddingBottom','paddingLeft','paddingRight','paddingTop','right','textIndent','top','verticalAlign','width','wordSpacing');TP.CSS_UNITLESS_PROPERTIES=TP.ac('opacity','orphans','widows','zIndex');TP.CSS_DISALLOW_NEGATIVE_VALUES=TP.ac('borderWidth','borderBottomWidth','borderLeftWidth','borderRightWidth','borderTopWidth','fontSize','height','lineHeight','maxHeight','maxWidth','minHeight','minWidth','opacity','outlineWidth','paddingBottom','paddingLeft','paddingRight','paddingTop','width');TP.regex.CSS_COLOR_PROPERTY=/color/i;TP.CSS_COLOR_NAMES=TP.hc('aliceblue','#F0F8FF','antiquewhite','#FAEBD7','aqua','#00FFFF','aquamarine','#7FFFD4','azure','#F0FFFF','beige','#F5F5DC','bisque','#FFE4C4','black','#000000','blanchedalmond','#FFEBCD','blue','#0000FF','blueviolet','#8A2BE2','brown','#A52A2A','burlywood','#DEB887','cadetblue','#5F9EA0','chartreuse','#7FFF00','chocolate','#D2691E','coral','#FF7F50','cornflowerblue','#6495ED','cornsilk','#FFF8DC','crimson','#DC143C','cyan','#00FFFF','darkblue','#00008B','darkcyan','#008B8B','darkgoldenrod','#B8860B','darkgray','#A9A9A9','darkgrey','#A9A9A9','darkgreen','#006400','darkkhaki','#BDB76B','darkmagenta','#8B008B','darkolivegreen','#556B2F','darkorange','#FF8C00','darkorchid','#9932CC','darkred','#8B0000','darksalmon','#E9967A','darkseagreen','#8FBC8F','darkslateblue','#483D8B','darkslategray','#2F4F4F','darkslategrey','#2F4F4F','darkturquoise','#00CED1','darkviolet','#9400D3','deeppink','#FF1493','deepskyblue','#00BFFF','dimgray','#696969','dimgrey','#696969','dodgerblue','#1E90FF','firebrick','#B22222','floralwhite','#FFFAF0','forestgreen','#228B22','fuchsia','#FF00FF','gainsboro','#DCDCDC','ghostwhite','#F8F8FF','gold','#FFD700','goldenrod','#DAA520','gray','#808080','grey','#808080','green','#00FF00','greenyellow','#ADFF2F','honeydew','#F0FFF0','hotpink','#FF69B4','indianred','#CD5C5C','indigo','#4B0082','ivory','#FFFFF0','khaki','#F0E68C','lavender','#E6E6FA','lavenderblush','#FFF0F5','lawngreen','#7CFC00','lemonchiffon','#FFFACD','lightblue','#ADD8E6','lightcoral','#F08080','lightcyan','#E0FFFF','lightgoldenrodyellow','#FAFAD2','lightgray','#D3D3D3','lightgrey','#D3D3D3','lightgreen','#90EE90','lightpink','#FFB6C1','lightsalmon','#FFA07A','lightseagreen','#20B2AA','lightskyblue','#87CEFA','lightslategray','#778899','lightslategrey','#778899','lightsteelblue','#B0C4DE','lightyellow','#FFFFE0','lime','#00FF00','limegreen','#32CD32','linen','#FAF0E6','magenta','#FF00FF','maroon','#800000','mediumaquamarine','#66CDAA','mediumblue','#0000CD','mediumorchid','#BA55D3','mediumpurple','#9370D8','mediumseagreen','#3CB371','mediumslateblue','#7B68EE','mediumspringgreen','#00FA9A','mediumturquoise','#48D1CC','mediumvioletred','#C71585','midnightblue','#191970','mintcream','#F5FFFA','mistyrose','#FFE4E1','moccasin','#FFE4B5','navajowhite','#FFDEAD','navy','#000080','oldLace','#FDF5E6','olive','#808000','olivedrab','#6B8E23','orange','#FFA500','orangered','#FF4500','orchid','#DA70D6','palegoldenrod','#EEE8AA','palegreen','#98FB98','paleturquoise','#AFEEEE','palevioletred','#D87093','papayawhip','#FFEFD5','peachpuff','#FFDAB9','peru','#CD853F','pink','#FFC0CB','plum','#DDA0DD','powderblue','#B0E0E6','purple','#800080','rebeccapurple','#663399','red','#FF0000','rosybrown','#BC8F8F','royalblue','#4169E1','saddlebrown','#8B4513','salmon','#FA8072','sandybrown','#F4A460','seagreen','#2E8B57','seashell','#FFF5EE','sienna','#A0522D','silver','#C0C0C0','skyblue','#87CEEB','slateblue','#6A5ACD','slategray','#708090','slategrey','#708090','snow','#FFFAFA','springgreen','#00FF7F','steelblue','#4682B4','tan','#D2B48C','teal','#008080','thistle','#D8BFD8','tomato','#FF6347','turquoise','#40E0D0','violet','#EE82EE','wheat','#F5DEB3','white','#FFFFFF','whitesmoke','#F5F5F5','yellow','#FFFF00','yellowgreen','#9ACD32');TP.regex.JQUERY_EXTENDED_SELECTORS=new RegExp('(:first|:last|:even|:odd|'+':eq|:gt|:lt|'+':header|:animated|:contains|:has|:parent|'+':hidden|:visible|'+':input|:text|:password|:radio|:checkbox|:submit|:image|'+':reset|:button|:file|:hidden|'+':selected)');TP.definePrimitive('convertHueToRGB',function(b,c,e){var a,d;if(!TP.isNumber(b)||!TP.isNumber(c)||!TP.isNumber(e)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}a=e;if(a<0){a++;}if(a>1){a--;}d=a*6;if(d<1){return b+(c-b)*d;}if(a*2<1){return c;}if(a*3<2){return b+(c-b)*(2/3-a)*6;}return b;});TP.definePrimitive('convertHSLAToRGBA',function(g,d,a,h){var e,c,b,i,j,k,f;if(!TP.isNumber(g)||!TP.isNumber(d)||!TP.isNumber(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}e=(g%360+360)%360/360;if(a<=0.5){b=a*(d+1);}else{b=a+d-a*d;}c=a*2-b;i=TP.convertHueToRGB(c,b,e+1/3)*256;j=TP.convertHueToRGB(c,b,e)*256;k=TP.convertHueToRGB(c,b,e-1/3)*256;f=TP.ac(i,j,k);if(TP.isNumber(h)){f.push(h);}return f;});TP.definePrimitive('convertColorStringToHex',function(a){var e,d,b,c;if(!TP.isString(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(/transparent/.test(a)){return a;}if(TP.regex.CSS_HEX.test(a)){e=a.getSize();if(e===7){b=a;}else if(e===6){b='#'+a;}else if(e===3||e===4){d=TP.regex.CSS_HEX.exec(a).at(2).split('');b=TP.join('#',d.at(0),d.at(0),d.at(1),d.at(1),d.at(2),d.at(2));}else{return null;}return b.toUpperCase();}b=null;c=null;if(TP.regex.CSS_RGB.test(a)||TP.regex.CSS_RGBA.test(a)||TP.regex.CSS_HSL.test(a)||TP.regex.CSS_HSLA.test(a)){c=TP.convertColorStringToArray(a);}if(TP.isArray(c)){if(c.getSize()===4){c.pop();}b='#';c=c.collect(function(b){var a;a=parseInt(b,10).toString(16).pad(2,'0',TP.RIGHT);return a;});b+=c.join('').toUpperCase();return b;}if(TP.notValid(b=TP.CSS_COLOR_NAMES.at(a.toLowerCase()))){return null;}return b;});TP.definePrimitive('convertColorStringToArray',function(b){var a,c,d,e,f;if(!TP.isString(b)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.regex.CSS_RGBA.test(b)){a=TP.regex.CSS_RGBA.match(b);a.shift();a.atPut(0,parseInt(a.at(0),10));a.atPut(1,parseInt(a.at(1),10));a.atPut(2,parseInt(a.at(2),10));a.atPut(3,parseFloat(a.at(3)));return a;}if(TP.regex.CSS_RGB.test(b)){a=TP.regex.CSS_RGB.match(b);a.shift();a.atPut(0,parseInt(a.at(0),10));a.atPut(1,parseInt(a.at(1),10));a.atPut(2,parseInt(a.at(2),10));return a;}if(TP.regex.CSS_HSLA.test(b)){a=TP.regex.CSS_HSLA.match(b);a.shift();a=TP.convertHSLAToRGBA(parseFloat(a.at(0)),parseFloat(a.at(1))/100,parseFloat(a.at(2))/100,parseFloat(a.at(3)));return a;}if(TP.regex.CSS_HSL.test(b)){a=TP.regex.CSS_HSL.match(b);a.shift();a=TP.convertHSLAToRGBA(parseFloat(a.at(0)),parseFloat(a.at(1))/100,parseFloat(a.at(2))/100);return a;}c=TP.convertColorStringToHex(b);if(TP.isEmpty(c)){return null;}d=parseInt(c.slice(0*2+1,0*2+3),16);e=parseInt(c.slice(1*2+1,1*2+3),16);f=parseInt(c.slice(2*2+1,2*2+3),16);return TP.ac(d,e,f);});TP.definePrimitive('convertColorStringToLongNumber',function(a){var b;if(!TP.isString(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.isString(b=TP.convertColorStringToHex(a))){return parseInt(b.slice(1),16);}return null;});TP.definePrimitive('convertLongNumberToColorString',function(c){var d,a,b;if(!TP.isNumber(c)){return TP.raise(this,'TP.sig.InvalidNumber',arguments);}d='0123456789ABCDEF';a='#';for(b=24;(b-=4)>=0;){a+=d.charAt(c>>b&15);}return a;});TP.definePrimitive('interpolateColors',function(d,e,b){var c,a,f,g,h;if(!TP.isNumber(d)||!TP.isNumber(e)||!TP.isNumber(b)){return TP.raise(this,'TP.sig.InvalidNumber',arguments);}c=0;for(a=24;(a-=8)>=0;){f=d>>a&255;g=e>>a&255;h=Math.floor(f*(1-b)+g*b);c|=h<<a;}return c;});TP.definePrimitive('elementGetNumericValueFromPercentage',function(b,e,f,h){var c,g,a,d;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(e)||TP.isEmpty(f)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}switch(e){case'fontSize':if(TP.notValid(a=b.parentNode)){return 0;}c=TP.elementGetStyleValueInPixels(a,'fontSize');break;case'lineHeight':a=b;c=TP.elementGetStyleValueInPixels(a,'fontSize');break;case'verticalAlign':a=b;c=TP.elementGetStyleValueInPixels(a,'lineHeight');break;case'height':case'minHeight':case'maxHeight':case'top':case'bottom':if(TP.notValid(a=TP.elementGetOffsetParent(b))){if(b===TP.documentGetBody(TP.nodeGetDocument(b))){a=b.parentNode;}else{return 0;}}c=a.offsetHeight;break;case'width':case'minWidth':case'maxWidth':case'left':case'right':case'marginTop':case'marginRight':case'marginLeft':case'marginBottom':case'paddingTop':case'paddingRight':case'paddingLeft':case'paddingBottom':case'textIndent':if(TP.notValid(a=TP.elementGetOffsetParent(b))){if(b===TP.documentGetBody(TP.nodeGetDocument(b))){a=b.parentNode;}else{return 0;}}c=a.offsetWidth;break;case'wordSpacing':break;default:return 0;}if(TP.regex.PERCENTAGE.test(c)){c=TP.elementGetNumericValueFromPercentage(a,e,c);}d=TP.elementGetPixelValue(a,c,e);if(TP.isNaN(d)){return 0;}if(TP.isNumber(g=parseFloat(f)/100)){d*=g;}else{return 0;}if(TP.isTrue(h)){d=TP.elementTransformCSSPixelValue(a,d,e);}return d;});TP.definePrimitive('elementGetPropertyValueAsNumber',function(b,c,a,d){if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(c)||TP.isEmpty(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.regex.PERCENTAGE.test(a)){return TP.elementGetNumericValueFromPercentage(b,c,a,d);}if(TP.isTrue(d)){return TP.elementTransformCSSPixelValue(b,c,parseFloat(a));}return parseFloat(a);});TP.definePrimitive('elementAddStyle',function(b,g,f){var c,a,d,e;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}c=TP.elementGetStyle(b);a=TP.styleStringAsHash(c);d=g.asDOMName();e=a.at(d);if(TP.isEmpty(e)){a.atPut(d,f);}else{a.atPut(d,TP.join(e,' ',f));}c=TP.styleStringFromHash(a);TP.elementSetStyle(b,c);return b;});TP.definePrimitive('elementGetComputedStyle',function(e,a){var b,c,d;if(!TP.isElement(e)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.notValid(b=TP.elementGetComputedStyleObj(e))){return TP.raise(this,'TP.sig.InvalidStyle',arguments);}if(TP.isString(a)){return TP.join(a.asCSSName(),':',b[a.asDOMName()],';');}if(TP.isEmpty(c=a)){c=TP.CSS_ALL_PROPERTIES;}d=TP.ac();c.perform(function(c){var a;a=b[c.asDOMName()];if(TP.notEmpty(a)){d.push(c.asCSSName(),':',a,';');}});return d.join('');});TP.definePrimitive('elementGetComputedStyleProperty',function(a,b){var c,d;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.notValid(c=TP.elementGetComputedStyleObj(a))){return TP.raise(this,'TP.sig.InvalidStyle',arguments);}d=c[b.asDOMName()];return d;});TP.definePrimitive('elementGetStyle',function(e,a){var b,c,f,d;if(!TP.isElement(e)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}b=TP.elementGetStyleObj(e).cssText.toLowerCase();if(TP.isEmpty(a)||TP.isEmpty(b)){return b;}c=TP.styleStringAsHash(b);if(TP.isString(a)){return TP.join(a.asCSSName(),':',c.at(a.asDOMName()),';');}else{f=a;}d=TP.ac();f.perform(function(b){var a;a=c.at(b.asDOMName());if(TP.notEmpty(a)){d.push(b.asCSSName(),':',a,';');}});return d.join('');});TP.definePrimitive('elementGetStyleObj',function(a){var b;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isStyleDeclaration(b=a.style)){return b;}return TP.elementGetPseudoInlineStyleObj(a);});TP.definePrimitive('elementGetStyleProperty',function(a,b){var c,d;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}c=a.style.cssText.toLowerCase();d=TP.styleStringAsHash(c);return d.at(b.asDOMName());});TP.definePrimitive('elementHasStyle',function(a,b){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}return TP.notEmpty(TP.elementGetStyle(a,b));});TP.definePrimitive('elementPopStyleProperty',function(a,b){var c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(TP.isArray(c=a[b+'_vals'])){return c.pop();}else{return null;}return null;});TP.definePrimitive('elementPopAndSetStyleProperty',function(a,b){var c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}c=TP.elementPopStyleProperty(a,b);TP.elementSetStyleProperty(a,b,c);return c;});TP.definePrimitive('elementPreserveStyle',function(a){TP.elementSetAttribute(a,'tibet:style',TP.elementGetStyle(a),true);return a;});TP.definePrimitive('elementPushStyleProperty',function(b,c,e){var d,a;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(c)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}d=TP.ifInvalid(e,'');if(TP.isArray(a=b[c+'_vals'])){a.push(d);}else{a=TP.ac(d);b[c+'_vals']=a;}return;});TP.definePrimitive('elementPushAndSetStyleProperty',function(a,b,c){if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}TP.elementPushStyleProperty(a,b,TP.elementGetStyleProperty(a,b));TP.elementSetStyleProperty(a,b,c);return;});TP.definePrimitive('elementRemoveStyle',function(a,d){var b,e,c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}c=TP.elementGetStyle(a);if(TP.isEmpty(c)){return a;}if(TP.isEmpty(d)){b='';}else{e=TP.rc(d.asCSSName()+'(.*)?;');b=c.strip(e);}return TP.elementSetStyle(a,b);});TP.definePrimitive('elementRemoveStyleProperty',function(d,a){var e,b,c;if(!TP.isElement(d)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}e=TP.elementGetStyleObj(d).cssText.toLowerCase();b=TP.styleStringAsHash(e);if(TP.isArray(a)){for(c=0;c<a.getSize();c++){b.removeKey(a.at(c).asDOMName());}}else{b.removeKey(a.asDOMName());}TP.elementSetStyle(d,b);return;});TP.definePrimitive('elementReplaceStyle',function(a,d,f,g){var b,e,c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}c=TP.elementGetStyle(a);if(TP.isEmpty(c)){return a;}if(TP.isEmpty(d)){b='';}else{e=TP.rc(d.asCSSName()+'(.*)?;');b=c.strip(e);}return TP.elementSetStyle(a,b);});TP.definePrimitive('elementRestoreStyle',function(a){if(TP.elementHasAttribute(a,'tibet:style',true)){TP.elementSetStyle(a,TP.elementGetAttribute(a,'tibet:style',true));}return a;});TP.definePrimitive('elementSetStyle',function(c,a){var b;if(!TP.isElement(c)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}b=TP.elementGetStyleObj(c);if(TP.notValid(a)){b.cssText=null;}else if(TP.isString(a)){b.cssText=a;}else if(TP.isKindOf(a,'TP.lang.Hash')){b.cssText=TP.styleStringFromHash(a,false);}else{return TP.raise(this,'InvalidStyle',arguments,'Style content must be string or TP.lang.Hash');}return c;});TP.definePrimitive('elementSetStyleProperty',function(b,c,d){var e,a;if(!TP.isElement(b)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(c)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}e=TP.elementGetStyleObj(b).cssText.toLowerCase();a=TP.styleStringAsHash(e);if(TP.isEmpty(d)){a.removeKey(c.asDOMName());}else{a.atPut(c.asDOMName(),d);}TP.elementSetStyle(b,a);return;});TP.definePrimitive('styleStringAsHash',function(a){if(TP.isEmpty(a)){return TP.hc();}return TP.lang.Hash.fromString(a);});TP.definePrimitive('styleStringFromHash',function(e,h){var a,c,f,b,d,g;if(TP.isEmpty(e)){return'';}a=TP.ac();c=TP.keys(e);f=c.getSize();g=TP.ifInvalid(h,false);for(b=0;b<f;b++){if(/ /.test(d=e.at(c.at(b)))&&g){d=d.quoted('"');}a.push(c.at(b).asCSSName(),':',d,'; ');}a=a.join('');return a.slice(0,a.getSize()-1);});TP.definePrimitive('cssDimensionValuesFromString',function(b){var a;if(TP.isEmpty(b)){return TP.hc();}a=b.split(' ');switch(a.getSize()){case 1:return TP.hc('top',a.at(0),'right',a.at(0),'bottom',a.at(0),'left',a.at(0));case 2:return TP.hc('top',a.at(0),'right',a.at(1),'bottom',a.at(0),'left',a.at(1));case 3:return TP.hc('top',a.at(0),'right',a.at(1),'bottom',a.at(2),'left',a.at(1));case 4:return TP.hc('top',a.at(0),'right',a.at(1),'bottom',a.at(2),'left',a.at(3));}return;});TP.SELECTOR_IDENTIFIER=1;TP.SELECTOR_ADJACENT_SIBLING_COMBINATOR=2;TP.SELECTOR_DOT=3;TP.SELECTOR_COLON=4;TP.SELECTOR_ATTR_EQUALS=5;TP.SELECTOR_ASTERISK=6;TP.SELECTOR_ESCAPED_COLON=7;TP.SELECTOR_LEFT_PAREN=8;TP.SELECTOR_RIGHT_PAREN=9;TP.SELECTOR_EOF=10;TP.SELECTOR_STRING=11;TP.SELECTOR_HASH=12;TP.SELECTOR_BANG=13;TP.SELECTOR_CHILD_COMBINATOR=14;TP.SELECTOR_GENERAL_SIBLING_COMBINATOR=15;TP.SELECTOR_ATTR_START=16;TP.SELECTOR_ATTR_END=17;TP.SELECTOR_ATTR_SPACE_EQUALS=18;TP.SELECTOR_ATTR_HYPHEN_EQUALS=19;TP.SELECTOR_ATTR_BEGIN_EQUALS=20;TP.SELECTOR_ATTR_END_EQUALS=21;TP.SELECTOR_ATTR_SUBSTR_EQUALS=22;TP.SELECTOR_ATTR_EXISTS=23;TP.SELECTOR_WHITESPACE=24;TP.SELECTOR_NAME=25;TP.SELECTOR_UNKNOWN=26;TP.regex.CSS_WHITESPACE=/^[ \t\r\n\f]+/;TP.regex.CSS_IDENTIFIER=/^-?([_a-z]|[^\x00-\x7F]|(\\[0-9a-f]{1,6}(\r\n|[ \n\r\t\f])?)|\\[^\n\r\f0-9a-f:])([_a-z0-9-]|[^\x00-\x7F]|(\\[0-9a-f]{1,6}(\r\n|[ \n\r\t\f])?)|\\[^\n\r\f0-9a-f:])*/i;TP.regex.CSS_NAME=/^([_a-z0-9-]|[^\x00-\x7F]|(\\[0-9a-f]{1,6}(\r\n|[ \n\r\t\f])?)|\\[^\n\r\f0-9a-f:])+/i;TP.regex.CSS_DOUBLE_QUOTED_STR=/^\"([^\n\r\f\\\"]|\\(\n|\r\n|\r|\f)|[^\x00-\x7F]|(\\[0-9a-f]{1,6}(\r\n|[ \n\r\t\f])?)|\\[^\n\r\f0-9a-f])*\"/i;TP.regex.CSS_SINGLE_QUOTED_STR=/^\'([^\n\r\f\\\']|\\(\n|\r\n|\r|\f)|[^\x00-\x7F]|(\\[0-9a-f]{1,6}(\r\n|[ \n\r\t\f])?)|\\[^\n\r\f0-9a-f])*\'/i;TP.definePrimitive('$$setupSelectorParseRecord',function(u){var k='.',c=':',e='(',f=')',g='<',h='>',i='#',j='*',b='=',d='-',m='!',n='[',o=']',p='~',q='|',r='+',s='^',t='$',l='\\',a;a={};a.selectorStr=u;a.offset=0;a.currentToken=TP.SELECTOR_UNKNOWN;a.lastMatch='';a.fetchNextToken=function(){var a,v,x,w,u;a=TP.SELECTOR_UNKNOWN;v=this.selectorStr.substring(this.offset);if(this.offset>=this.selectorStr.length){a=TP.SELECTOR_EOF;}else if(v.match(TP.regex.CSS_WHITESPACE)){u=RegExp.lastMatch;a=TP.SELECTOR_WHITESPACE;this.offset+=u.length;}else if(v.match(TP.regex.CSS_IDENTIFIER)){u=RegExp.lastMatch;a=TP.SELECTOR_IDENTIFIER;this.lastMatch=u;this.offset+=u.length;}else if(v.match(TP.regex.CSS_NAME)){u=RegExp.lastMatch;a=TP.SELECTOR_NAME;this.lastMatch=u;this.offset+=u.length;}else if(v.match(TP.regex.CSS_DOUBLE_QUOTED_STR)||v.match(TP.regex.CSS_SINGLE_QUOTED_STR)){a=TP.SELECTOR_STRING;u=RegExp.lastMatch;this.lastMatch=u.substr(1,u.length-2);this.offset+=u.length;}else{x=v.substr(0,1);w=v.substr(1,1);switch(x){case k:a=TP.SELECTOR_DOT;break;case c:a=TP.SELECTOR_COLON;break;case l:if(c===w){a=TP.SELECTOR_ESCAPED_COLON;this.offset++;}else{a=TP.SELECTOR_UNKNOWN;TP.ifWarn()?TP.warn('\'\\\' encountered - '+'unknown resolution',TP.LOG,arguments):0;}break;case e:a=TP.SELECTOR_LEFT_PAREN;break;case f:a=TP.SELECTOR_RIGHT_PAREN;break;case g:a=TP.SELECTOR_UNKNOWN;TP.ifWarn()?TP.warn('\'<\' encountered - unknown resolution',TP.LOG,arguments):0;break;case h:a=TP.SELECTOR_CHILD_COMBINATOR;break;case i:a=TP.SELECTOR_HASH;break;case j:if(b===w){a=TP.SELECTOR_ATTR_SUBSTR_EQUALS;this.offset++;}else{a=TP.SELECTOR_ASTERISK;}break;case b:a=TP.SELECTOR_ATTR_EQUALS;break;case d:a=TP.SELECTOR_UNKNOWN;TP.ifWarn()?TP.warn('\'-\' encountered - unknown resolution',TP.LOG,arguments):0;break;case m:a=TP.SELECTOR_BANG;break;case n:a=TP.SELECTOR_ATTR_START;break;case o:a=TP.SELECTOR_ATTR_END;break;case p:if(b===w){a=TP.SELECTOR_ATTR_SPACE_EQUALS;this.offset++;}else{a=TP.SELECTOR_GENERAL_SIBLING_COMBINATOR;}break;case q:if(b===w){a=TP.SELECTOR_ATTR_HYPHEN_EQUALS;this.offset++;}else{a=TP.SELECTOR_UNKNOWN;TP.ifWarn()?TP.warn('Standalone \'|\' encountered -'+' unknown resolution',TP.LOG,arguments):0;}break;case r:a=TP.SELECTOR_ADJACENT_SIBLING_COMBINATOR;break;case s:if(b===w){a=TP.SELECTOR_ATTR_BEGIN_EQUALS;this.offset++;}else{a=TP.SELECTOR_UNKNOWN;TP.ifWarn()?TP.warn('Standalone \'^\' encountered'+' - unknown resolution',TP.LOG,arguments):0;}break;case t:if(b===w){a=TP.SELECTOR_ATTR_END_EQUALS;this.offset++;}else{a=TP.SELECTOR_UNKNOWN;TP.ifWarn()?TP.warn('Standalone \'$\' encountered'+' - unknown resolution',TP.LOG,arguments):0;}break;default:TP.ifWarn()?TP.warn('Unknown token encountered: '+x,TP.LOG,arguments):0;break;}this.offset++;}this.currentToken=a;return a;};a.peekNextToken=function(){var a,b,c;a=this.offset;b=this.lastMatch;c=this.fetchNextToken();this.offset=a;this.lastMatch=b;return c;};a.getLastMatch=function(){return this.lastMatch;};a.getCurrentOffset=function(){return this.offset;};a.getCurrentToken=function(){return this.currentToken;};a.fetchNextNonWSToken=function(){var a;a=this.fetchNextToken();while(a===TP.SELECTOR_WHITESPACE){a=this.fetchNextToken();}return a;};return a;});TP.definePrimitive('parseCSSSelector',function(s,t){var m,g,b,j,d,a,e,k,l,h,c,n,i,o,p,q,r,f;m=TP.ifInvalid(t,false);g=s;g=g.replace(/\|/g,'__NSESC__');b=TP.$$setupSelectorParseRecord(g);j=TP.ac();j.defineAttribute('fullSelector',g);a=b.fetchNextToken();while(a!==TP.SELECTOR_EOF){d=TP.hc();j.push(d);k=TP.ac();l=TP.hc();h=TP.ac();if(a===TP.SELECTOR_IDENTIFIER||a===TP.SELECTOR_ASTERISK){c=a===TP.SELECTOR_ASTERISK?'*':b.getLastMatch();a=b.fetchNextToken();if(a===TP.SELECTOR_ESCAPED_COLON){d.atPut('namespace',c);a=b.fetchNextToken();if(a===TP.SELECTOR_IDENTIFIER||a===TP.SELECTOR_ASTERISK){c=a===TP.SELECTOR_ASTERISK?'*':b.getLastMatch();d.atPut('tagName',c);a=b.fetchNextToken();}}else{d.atPut('tagName',c);}}while(a===TP.SELECTOR_HASH||a===TP.SELECTOR_DOT||a===TP.SELECTOR_ATTR_START||a===TP.SELECTOR_COLON){if(a===TP.SELECTOR_HASH){a=b.fetchNextToken();if(a===TP.SELECTOR_IDENTIFIER||a===TP.SELECTOR_NAME){c=b.getLastMatch();d.atPut('id',c);}}else if(a===TP.SELECTOR_DOT){a=b.fetchNextToken();if(a===TP.SELECTOR_IDENTIFIER){c=b.getLastMatch();k.push(c);}}else if(a===TP.SELECTOR_ATTR_START){a=b.fetchNextNonWSToken();if(a===TP.SELECTOR_IDENTIFIER){c=b.getLastMatch();i=TP.hc();l.atPut(c.replace('__NSESC__',':'),i);a=b.fetchNextNonWSToken();switch(a){case TP.SELECTOR_ATTR_BEGIN_EQUALS:case TP.SELECTOR_ATTR_END_EQUALS:case TP.SELECTOR_ATTR_SUBSTR_EQUALS:case TP.SELECTOR_ATTR_EQUALS:case TP.SELECTOR_ATTR_SPACE_EQUALS:case TP.SELECTOR_ATTR_HYPHEN_EQUALS:i.atPut('attrOp',a);break;case TP.SELECTOR_ATTR_END:i.atPut('attrOp',TP.SELECTOR_ATTR_EXISTS);break;default:TP.ifWarn()?TP.warn('Unrecognized attribute'+' operator: '+a,TP.LOG,arguments):0;break;}if(a!==TP.SELECTOR_ATTR_END){a=b.fetchNextNonWSToken();if(a===TP.SELECTOR_IDENTIFIER||a===TP.SELECTOR_STRING){c=b.getLastMatch();i.atPut('attrValue',c);}a=b.fetchNextNonWSToken();}}}else if(a===TP.SELECTOR_COLON){a=b.fetchNextToken();if(a===TP.SELECTOR_IDENTIFIER){c=b.getLastMatch();if(m){switch(c.toLowerCase()){case'first-line':case'first-letter':case'before':case'after':d.atPut('pseudoElement',c.toLowerCase());break;case'active':case'visited':case'link':case'hover':case'focus':case'first-child':h.push(c.toLowerCase());break;default:break;}}else{e=b.peekNextToken();if(e===TP.SELECTOR_LEFT_PAREN){n=c.toLowerCase();a=b.fetchNextToken();a=b.fetchNextNonWSToken();o=b.getCurrentOffset()-1;while(a!==TP.SELECTOR_RIGHT_PAREN&&a!==TP.SELECTOR_EOF){a=b.fetchNextNonWSToken();}p=b.getCurrentOffset()-1;q=g.slice(o,p);r=TP.parseCSSSelector(q);h.push(TP.ac(n,r));}else{h.push(c.toLowerCase());}}}else if(a===TP.SELECTOR_COLON){a=b.fetchNextToken();if(a===TP.SELECTOR_IDENTIFIER){c=b.getLastMatch();if(m){switch(c.toLowerCase()){case'first-line':case'first-letter':case'before':case'after':case'selection':d.atPut('pseudoElement',c.toLowerCase());break;}}else{d.atPut('pseudoElement',c.toLowerCase());}}}}a=b.fetchNextToken();}if(a===TP.SELECTOR_WHITESPACE){e=b.peekNextToken();if(e===TP.SELECTOR_CHILD_COMBINATOR||e===TP.SELECTOR_ADJACENT_SIBLING_COMBINATOR||e===TP.SELECTOR_GENERAL_SIBLING_COMBINATOR||e===TP.SELECTOR_EOF){a=b.fetchNextToken();}}switch(a){case TP.SELECTOR_WHITESPACE:case TP.SELECTOR_CHILD_COMBINATOR:case TP.SELECTOR_ADJACENT_SIBLING_COMBINATOR:case TP.SELECTOR_GENERAL_SIBLING_COMBINATOR:case TP.SELECTOR_EOF:j.push(a);break;default:TP.ifWarn()?TP.warn('Unknown token encountered: '+a,TP.LOG,arguments):0;break;}if(TP.isString(f=d.at('tagName'))&&/\__NSESC__/.test(f)){f=f.split('__NSESC__');d.atPut('namespace',f.first());d.atPut('tagName',f.last());}if(TP.notEmpty(k)){d.atPut('classes',k);}if(TP.notEmpty(l)){d.atPut('attributes',l);}if(TP.notEmpty(h)){d.atPut('pseudoclasses',h);}a=b.fetchNextNonWSToken();}return j;});
TP.boot.$srcPath = '~app/node_modules/tibet/deps/jquery-sizzle-tpi.js';
(function(){var j=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,i=0,l=Object.prototype.toString,h=false,n=true,d=/\\/g,g=/\W/;l=Object.prototype.toString;[0,0].sort(function(){n=false;return 0;});var a=function(m,e,h,t){h=h||[];e=e||document;var x=e;if(e.nodeType!==1&&e.nodeType!==9){return[];}if(!m||typeof m!=='string'){return h;}var n,k,f,u,i,p,s,g,v=true,r=a.isXML(e),d=[],w=m;do{j.exec('');n=j.exec(w);if(n){w=n[3];d.push(n[1]);if(n[2]){u=n[3];break;}}}while(n);if(d.length>1&&q.exec(m)){if(d.length===2&&b.relative[d[0]]){k=o(d[0]+d[1],e);}else{k=b.relative[d[0]]?[e]:a(d.shift(),e);while(d.length){m=d.shift();if(b.relative[m]){m+=d.shift();}k=o(m,k);}}}else{if(!t&&d.length>1&&e.nodeType===9&&!r&&b.match.ID.test(d[0])&&!b.match.ID.test(d[d.length-1])){i=a.find(d.shift(),e,r);e=i.expr?a.filter(i.expr,i.set)[0]:i.set[0];}if(e){i=t?{expr:d.pop(),set:c(t)}:a.find(d.pop(),d.length===1&&(d[0]==='~'||d[0]==='+')&&e.parentNode?e.parentNode:e,r);k=i.expr?a.filter(i.expr,i.set):i.set;if(d.length>0){f=c(k);}else{v=false;}while(d.length){p=d.pop();s=p;if(!b.relative[p]){p='';}else{s=d.pop();}if(s==null){s=e;}b.relative[p](f,s,r);}}else{f=d=[];}}if(!f){f=k;}if(!f){a.error(p||m);}if(l.call(f)==='[object Array]'){if(!v){h.push.apply(h,f);}else if(e&&e.nodeType===1){for(g=0;f[g]!=null;g++){if(f[g]&&(f[g]===true||f[g].nodeType===1&&a.contains(e,f[g]))){h.push(k[g]);}}}else{for(g=0;f[g]!=null;g++){if(f[g]&&f[g].nodeType===1){h.push(k[g]);}}}}else{c(f,h);}if(u){a(u,x,h,t);a.uniqueSort(h);}return h;};a.uniqueSort=function(a){if(m){h=n;a.sort(m);if(h){for(var b=1;b<a.length;b++){if(a[b]===a[b-1]){a.splice(b--,1);}}}}return a;};a.matches=function(b,c){return a(b,null,null,c);};a.matchesSelector=function(b,c){return a(c,null,null,[b]).length>0;};a.find=function(c,h,k){var e;if(!c){return[];}for(var f=0,j=b.order.length;f<j;f++){var a,g=b.order[f];if(a=b.leftMatch[g].exec(c)){var i=a[1];a.splice(1,1);if(i.substr(i.length-1)!=='\\'){a[1]=(a[1]||'').replace(d,'');e=b.find[g](a,h,k);if(e!=null){c=c.replace(b.match[g],'');break;}}}}if(!e){e=typeof h.getElementsByTagName!=='undefined'?h.getElementsByTagName('*'):[];}return{set:e,expr:c};};a.filter=function(f,j,m,s){var c,g,n=f,h=[],e=j,q=j&&j[0]&&a.isXML(j[0]);var i;while(f&&j.length){for(var d=0;d<b.filterKeys.length;d++){i=b.filterKeys[d];if((c=b.leftMatch[i].exec(f))!=null&&c[2]){var k,l,r=b.filter[i],o=c[1];g=false;c.splice(1,1);if(o.substr(o.length-1)==='\\'){continue;}if(e===h){h=[];}if(b.preFilter[i]){c=b.preFilter[i](c,e,m,h,s,q);if(!c){g=k=true;}else if(c===true){continue;}}if(c){for(var d=0;(l=e[d])!=null;d++){if(l){k=r(l,c,d,e);var p=s^!!k;if(m&&k!=null){if(p){g=true;}else{e[d]=false;}}else if(p){h.push(l);g=true;}}}}if(k!==undefined){if(!m){e=h;}f=f.replace(b.match[i],'');if(!g){return[];}break;}}}if(f===n){if(g==null){a.error(f);}else{break;}}n=f;}return e;};a.error=function(a){throw'Syntax error, unrecognized expression: '+a;};var b=a.selectors={order:['ID','NAME','TAG'],matchKeys:['ID','CLASS','NAME','ATTR','TAG','CHILD','POS','PSEUDO'],match:{ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{'class':'className','for':'htmlFor'},attrHandle:{href:function(a){return a.getAttribute('href');},type:function(a){return a.getAttribute('type');}},relative:{'+':function(e,c){var f=typeof c==='string',h=f&&!g.test(c),i=f&&!h;if(h){c=c.toLowerCase();}for(var d=0,j=e.length,b;d<j;d++){if(b=e[d]){while((b=b.previousSibling)&&b.nodeType!==1){}e[d]=i||b&&b.nodeName.toLowerCase()===c?b||false:b===c;}}if(i){a.filter(c,e,true);}},'>':function(e,c){var d,f=typeof c==='string',b=0,h=e.length;if(f&&!g.test(c)){c=c.toLowerCase();for(;b<h;b++){d=e[b];if(d){var i=d.parentNode;e[b]=i.nodeName.toLowerCase()===c?i:false;}}}else{for(;b<h;b++){d=e[b];if(d){e[b]=f?d.parentNode:d.parentNode===c;}}if(f){a.filter(c,e,true);}}},'':function(e,a,f){var c,d=i++,b=s;if(typeof a==='string'&&!g.test(a)){a=a.toLowerCase();c=a;b=r;}b('parentNode',a,d,e,c,f);},'~':function(e,a,f){var c,d=i++,b=s;if(typeof a==='string'&&!g.test(a)){a=a.toLowerCase();c=a;b=r;}b('previousSibling',a,d,e,c,f);}},find:{ID:function(c,b,d){if(typeof b.getElementById!=='undefined'&&!d){var a=b.getElementById(c[1]);return a&&a.parentNode?[a]:[];}},NAME:function(d,e){if(typeof e.getElementsByName!=='undefined'){var b=[],c=e.getElementsByName(d[1]);for(var a=0,f=c.length;a<f;a++){if(c[a].getAttribute('name')===d[1]){b.push(c[a]);}}return b.length===0?null:b;}},TAG:function(b,a){if(typeof a.getElementsByTagName!=='undefined'){return a.getElementsByTagName(b[1]);}}},preFilter:{CLASS:function(b,e,f,g,h,i){b=' '+b[1].replace(d,'')+' ';if(i){return b;}for(var c=0,a;(a=e[c])!=null;c++){if(a){if(h^(a.className&&(' '+a.className+' ').replace(/[\t\n\r]/g,' ').indexOf(b)>=0)){if(!f){g.push(a);}}else if(f){e[c]=false;}}}return false;},ID:function(a){return a[1].replace(d,'');},TAG:function(a,b){return a[1].replace(d,'').toLowerCase();},CHILD:function(b){if(b[1]==='nth'){if(!b[2]){a.error(b[0]);}b[2]=b[2].replace(/^\+|\s*/g,'');var c=/(-?)(\d*)(?:n([+\-]?\d*))?/.exec(b[2]==='even'&&'2n'||b[2]==='odd'&&'2n+1'||!/\D/.test(b[2])&&'0n+'+b[2]||b[2]);b[2]=c[1]+(c[2]||1)-0;b[3]=c[3]-0;}else if(b[2]){a.error(b[0]);}b[0]=i++;return b;},ATTR:function(a,f,g,h,i,e){var c=a[1]=a[1].replace(d,'');if(!e&&b.attrMap[c]){a[1]=b.attrMap[c];}a[4]=(a[4]||a[5]||'').replace(d,'');if(a[2]==='~='){a[4]=' '+a[4]+' ';}return a;},PSEUDO:function(c,d,e,f,h){if(c[1]==='not'){if((j.exec(c[3])||'').length>1||/^\w/.test(c[3])){c[3]=a(c[3],null,null,d);}else{var g=a.filter(c[3],d,e,true^h);if(!e){f.push.apply(f,g);}return false;}}else if(b.match.POS.test(c[0])||b.match.CHILD.test(c[0])){return true;}return c;},POS:function(a){a.unshift(true);return a;}},filters:{enabled:function(a){return a.disabled===false&&a.type!=='hidden';},disabled:function(a){return a.disabled===true;},checked:function(a){return a.checked===true;},selected:function(a){if(a.parentNode){a.parentNode.selectedIndex;}return a.selected===true;},parent:function(a){return!!a.firstChild;},empty:function(a){return!a.firstChild;},has:function(b,d,c){return!!a(c[3],b).length;},header:function(a){return/h\d/i.test(a.nodeName);},text:function(a){var b=a.getAttribute('type'),c=a.type;return a.nodeName.toLowerCase()==='input'&&'text'===c&&(b===c||b===null);},radio:function(a){return a.nodeName.toLowerCase()==='input'&&'radio'===a.type;},checkbox:function(a){return a.nodeName.toLowerCase()==='input'&&'checkbox'===a.type;},file:function(a){return a.nodeName.toLowerCase()==='input'&&'file'===a.type;},password:function(a){return a.nodeName.toLowerCase()==='input'&&'password'===a.type;},submit:function(b){var a=b.nodeName.toLowerCase();return(a==='input'||a==='button')&&'submit'===b.type;},image:function(a){return a.nodeName.toLowerCase()==='input'&&'image'===a.type;},reset:function(b){var a=b.nodeName.toLowerCase();return(a==='input'||a==='button')&&'reset'===b.type;},button:function(b){var a=b.nodeName.toLowerCase();return a==='input'&&'button'===b.type||a==='button';},input:function(a){return/input|select|textarea|button/i.test(a.nodeName);},focus:function(a){return a===a.ownerDocument.activeElement;}},setFilters:{first:function(b,a){return a===0;},last:function(c,a,d,b){return a===b.length-1;},even:function(b,a){return a%2===0;},odd:function(b,a){return a%2===1;},lt:function(c,a,b){return a<b[3]-0;},gt:function(c,a,b){return a>b[3]-0;},nth:function(c,a,b){return b[3]-0===a;},eq:function(c,a,b){return b[3]-0===a;}},filterKeys:['PSEUDO','CHILD','ID','TAG','CLASS','ATTR','POS'],filter:{PSEUDO:function(c,e,j,k){var d=e[1],g=b.filters[d];if(g){return g(c,j,e,k);}else if(d==='contains'){return(c.textContent||c.innerText||a.getText([c])||'').indexOf(e[3])>=0;}else if(d==='not'){var h=e[3];for(var f=0,i=h.length;f<i;f++){if(h[f]===c){return false;}}return true;}else{a.error(d);}},CHILD:function(d,e){var i=e[1],a=d;switch(i){case'only':case'first':while(a=a.previousSibling){if(a.nodeType===1){return false;}}if(i==='first'){return true;}a=d;case'last':while(a=a.nextSibling){if(a.nodeType===1){return false;}}return true;case'nth':var b=e[2],g=e[3];if(b===1&&g===0){return true;}var h=e[0],c=d.parentNode;if(c&&(c.sizcache!==h||!d.nodeIndex)){var j=0;for(a=c.firstChild;a;a=a.nextSibling){if(a.nodeType===1){a.nodeIndex=++j;}}c.sizcache=h;}var f=d.nodeIndex-g;if(b===0){return f===0;}else{return f%b===0&&f/b>=0;}}},ID:function(a,b){return a.nodeType===1&&a.getAttribute('id')===b;},TAG:function(a,b){return b==='*'&&a.nodeType===1||a.nodeName.toLowerCase()===b;},CLASS:function(a,b){return(' '+(a.className||a.getAttribute('class'))+' ').indexOf(b)>-1;},ATTR:function(f,h){var e=h[1],g=b.attrHandle[e]?b.attrHandle[e](f):f[e]!=null?f[e]:f.getAttribute(e.replace(/\\/g,'')),c=g+'',d=h[2],a=h[4];return g==null?d==='!=':d==='='?c===a:d==='*='?c.indexOf(a)>=0:d==='~='?(' '+c+' ').indexOf(a)>=0:!a?c&&g!==false:d==='!='?c!==a:d==='^='?c.indexOf(a)===0:d==='$='?c.substr(c.length-a.length)===a:d==='|='?c===a||c.substr(0,a.length+1)===a+'-':false;},POS:function(e,c,f,g){var d=c[2],a=b.setFilters[d];if(a){return a(e,f,c,g);}}}};var q=b.match.POS,p=function(b,a){return'\\'+(a-0+1);};for(var k=0;k<b.matchKeys.length;k++){var e=b.matchKeys[k];b.match[e]=new RegExp(b.match[e].source+/(?![^\[]*\])(?![^\(]*\))/.source);b.leftMatch[e]=new RegExp(/(^(?:.|\r|\n)*?)/.source+b.match[e].source.replace(/\\(\d+)/g,p));}var c=function(a,b){a=Array.prototype.slice.call(a,0);if(b){b.push.apply(b,a);return b;}return a;};try{Array.prototype.slice.call(document.documentElement.childNodes,0)[0].nodeType;}catch(a){c=function(a,e){var b=0,c=e||[];if(l.call(a)==='[object Array]'){Array.prototype.push.apply(c,a);}else{if(typeof a.length==='number'){for(var d=a.length;b<d;b++){c.push(a[b]);}}else{for(;a[b];b++){c.push(a[b]);}}}return c;};}var m,f;if(document.documentElement.compareDocumentPosition){m=function(a,b){if(a===b){h=true;return 0;}if(!a.compareDocumentPosition||!b.compareDocumentPosition){return a.compareDocumentPosition?-1:1;}return a.compareDocumentPosition(b)&4?-1:1;};}else{m=function(g,c){if(g===c){h=true;return 0;}else if(g.sourceIndex&&c.sourceIndex){return g.sourceIndex-c.sourceIndex;}var k,l,d=[],e=[],i=g.parentNode,j=c.parentNode,b=i;if(i===j){return f(g,c);}else if(!i){return-1;}else if(!j){return 1;}while(b){d.unshift(b);b=b.parentNode;}b=j;while(b){e.unshift(b);b=b.parentNode;}k=d.length;l=e.length;for(var a=0;a<k&&a<l;a++){if(d[a]!==e[a]){return f(d[a],e[a]);}}return a===k?f(g,e[a],-1):f(d[a],c,1);};f=function(b,c,d){if(b===c){return d;}var a=b.nextSibling;while(a){if(a===c){return-1;}a=a.nextSibling;}return 1;};}a.getText=function(e){var c='',b;for(var d=0;e[d];d++){b=e[d];if(b.nodeType===3||b.nodeType===4){c+=b.nodeValue;}else if(b.nodeType!==8){c+=a.getText(b.childNodes);}}return c;};(function(){var a=document.createElement('div'),d='script'+new Date().getTime(),c=document.documentElement;a.innerHTML='<a name=\''+d+'\'/>';c.insertBefore(a,c.firstChild);if(document.getElementById(d)){b.find.ID=function(b,c,d){if(typeof c.getElementById!=='undefined'&&!d){var a=c.getElementById(b[1]);return a?a.id===b[1]||typeof a.getAttributeNode!=='undefined'&&a.getAttributeNode('id').nodeValue===b[1]?[a]:undefined:[];}};b.filter.ID=function(a,c){var b=typeof a.getAttributeNode!=='undefined'&&a.getAttributeNode('id');return a.nodeType===1&&b&&b.nodeValue===c;};}c.removeChild(a);c=a=null;}());(function(){var a=document.createElement('div');a.appendChild(document.createComment(''));if(a.getElementsByTagName('*').length>0){b.find.TAG=function(d,e){var a=e.getElementsByTagName(d[1]);if(d[1]==='*'){var c=[];for(var b=0;a[b];b++){if(a[b].nodeType===1){c.push(a[b]);}}a=c;}return a;};}a.innerHTML='<a href=\'#\'></a>';if(a.firstChild&&typeof a.firstChild.getAttribute!=='undefined'&&a.firstChild.getAttribute('href')!=='#'){b.attrHandle.href=function(a){return a.getAttribute('href',2);};}a=null;}());if(document.querySelectorAll){(function(){var d=a,e=document.createElement('div'),g='__sizzle__';e.innerHTML='<p class=\'TEST\'></p>';if(e.querySelectorAll&&e.querySelectorAll('.TEST').length===0){return;}a=function(i,e,h,p){e=e||document;if(!p&&!a.isXML(e)){var f=/^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec(i);if(f&&(e.nodeType===1||e.nodeType===9)){if(f[1]){return c(e.getElementsByTagName(i),h);}else if(f[2]&&b.find.CLASS&&e.getElementsByClassName){return c(e.getElementsByClassName(f[2]),h);}}if(e.nodeType===9){if(i==='body'&&e.body){return c([e.body],h);}else if(f&&f[3]){var j=e.getElementById(f[3]);if(j&&j.parentNode){if(j.id===f[3]){return c([j],h);}}else{return c([],h);}}try{return c(e.querySelectorAll(i),h);}catch(a){}}else if(e.nodeType===1&&e.nodeName.toLowerCase()!=='object'){var o=e,l=e.getAttribute('id'),k=l||g,n=e.parentNode,m=/^\s*[+~]/.test(i);if(!l){e.setAttribute('id',k);}else{k=k.replace(/'/g,'\\$&');}if(m&&n){e=e.parentNode;}try{if(!m||n){return c(e.querySelectorAll('[id=\''+k+'\'] '+i),h);}}catch(a){}finally{if(!l){o.removeAttribute('id');}}}}return d(i,e,h,p);};for(var f in d){if(TP.regex.INTERNAL_SLOT.test(f)||!d.hasOwnProperty(f))continue;a[f]=d[f];}e=null;}());}(function(){var c=document.documentElement,d=c.matchesSelector||c.mozMatchesSelector||c.webkitMatchesSelector||c.msMatchesSelector;if(d){var f=!d.call(document.createElement('div'),'div'),e=false;try{d.call(document.documentElement,'[test!=\'\']:sizzle');}catch(a){e=true;}a.matchesSelector=function(g,c){c=c.replace(/\=\s*([^'"\]]*)\s*\]/g,'=\'$1\']');if(!a.isXML(g)){try{if(e||!b.match.PSEUDO.test(c)&&!/!=/.test(c)){var h=d.call(g,c);if(h||!f||g.document&&g.document.nodeType!==11){return h;}}}catch(a){}}return a(c,null,null,[g]).length>0;};}}());(function(){var a=document.createElement('div');a.innerHTML='<div class=\'test e\'></div><div class=\'test\'></div>';if(!a.getElementsByClassName||a.getElementsByClassName('e').length===0){return;}a.lastChild.className='e';if(a.getElementsByClassName('e').length===1){return;}b.order.splice(1,0,'CLASS');b.find.CLASS=function(b,a,c){if(typeof a.getElementsByClassName!=='undefined'&&!c){return a.getElementsByClassName(b[1]);}};a=null;}());function r(f,h,e,d,j,i){for(var b=0,g=d.length;b<g;b++){var a=d[b];if(a){var c=false;a=a[f];while(a){if(a.sizcache===e){c=d[a.sizset];break;}if(a.nodeType===1&&!i){a.sizcache=e;a.sizset=b;}if(a.nodeName.toLowerCase()===h){c=a;break;}a=a[f];}d[b]=c;}}}function s(h,f,g,e,k,j){for(var c=0,i=e.length;c<i;c++){var b=e[c];if(b){var d=false;b=b[h];while(b){if(b.sizcache===g){d=e[b.sizset];break;}if(b.nodeType===1){if(!j){b.sizcache=g;b.sizset=c;}if(typeof f!=='string'){if(b===f){d=true;break;}}else if(a.filter(f,[b]).length>0){d=b;break;}}b=b[h];}e[c]=d;}}}if(document.documentElement.contains){a.contains=function(a,b){return a!==b&&(a.contains?a.contains(b):true);};}else if(document.documentElement.compareDocumentPosition){a.contains=function(a,b){return!!(a.compareDocumentPosition(b)&16);};}else{a.contains=function(){return false;};}a.isXML=function(a){var b=(a?a.ownerDocument||a:0).documentElement;return b?b.nodeName!=='HTML':false;};var o=function(c,e){var i,f=[],g='',h=e.nodeType?[e]:e;while(i=b.match.PSEUDO.exec(c)){g+=i[0];c=c.replace(b.match.PSEUDO,'');}c=b.relative[c]?c+'*':c;for(var d=0,j=h.length;d<j;d++){a(c,h[d],f);}return a.filter(g,f);};window.Sizzle=a;}());
TP.boot.$srcPath = '';

        
        TP.extern.Sizzle = Sizzle;
        
    
TP.boot.$srcPath = '~app/node_modules/tibet/deps/jquery-jquery-tpi.js';
var jQuery=function(){var a=function(b,c){return new a.fn.init(b,c,q);},y=window.jQuery,A=window.$,q,w=/^(?:[^<]*(<[\w\W]+>)[^>]*$|#([\w\-]*)$)/,h=/\S/,j=/^\s+/,k=/\s+$/,B=/\d/,C=/^<(\w+)\s*\/?>(?:<\/\1>)?$/,D=/^[\],:{}\s]*$/,E=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,F=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,o=/(?:^|:|,)(?:\s*\[)+/g,p=/(webkit)[ \/]([\w.]+)/,n=/(opera)(?:.*version)?[ \/]([\w.]+)/,r=/(msie) ([\w.]+)/,s=/(mozilla)(?:.*? rv:([\w.]+))?/,t=/-([a-z])/gi,u=function(b,a){return a.toUpperCase();},v=navigator.userAgent,d,e,b,z=Object.prototype.toString,f=Object.prototype.hasOwnProperty,g=Array.prototype.push,c=Array.prototype.slice,l=String.prototype.trim,m=Array.prototype.indexOf,i={};a.fn=a.prototype={constructor:a,init:function(b,c,g){var d,f,e,h;if(!b){return this;}if(b.nodeType){this.context=this[0]=b;this.length=1;return this;}if(b==='body'&&!c&&document.body){this.context=document;this[0]=document.body;this.selector=b;this.length=1;return this;}if(typeof b==='string'){if(b.charAt(0)==='<'&&b.charAt(b.length-1)==='>'&&b.length>=3){d=[null,b,null];}else{d=w.exec(b);}if(d&&(d[1]||!c)){if(d[1]){c=c instanceof a?c[0]:c;h=c?c.ownerDocument||c:document;e=C.exec(b);if(e){if(a.isPlainObject(c)){b=[document.createElement(e[1])];a.fn.attr.call(b,c,true);}else{b=[h.createElement(e[1])];}}else{e=a.buildFragment([d[1]],[h]);b=(e.cacheable?a.clone(e.fragment):e.fragment).childNodes;}return a.merge(this,b);}else{f=document.getElementById(d[2]);if(f&&f.parentNode){if(f.id!==d[2]){return g.find(b);}this.length=1;this[0]=f;}this.context=document;this.selector=b;return this;}}else if(!c||c.jquery){return(c||g).find(b);}else{return this.constructor(c).find(b);}}else if(a.isFunction(b)){return g.ready(b);}if(b.selector!==undefined){this.selector=b.selector;this.context=b.context;}return a.makeArray(b,this);},selector:'',jquery:'@VERSION',length:0,size:function(){return this.length;},toArray:function(){return c.call(this,0);},get:function(a){return a==null?this.toArray():a<0?this[this.length+a]:this[a];},pushStack:function(c,d,e){var b=this.constructor();if(a.isArray(c)){g.apply(b,c);}else{a.merge(b,c);}b.prevObject=this;b.context=this.context;if(d==='find'){b.selector=this.selector+(this.selector?' ':'')+e;}else if(d){b.selector=this.selector+'.'+d+'('+e+')';}return b;},each:function(b,c){return a.each(this,b,c);},ready:function(b){a.bindReady();e.done(b);return this;},eq:function(a){return a===-1?this.slice(a):this.slice(a,+a+1);},first:function(){return this.eq(0);},last:function(){return this.eq(-1);},slice:function(){return this.pushStack(c.apply(this,arguments),'slice',c.call(arguments).join(','));},map:function(b){return this.pushStack(a.map(this,function(a,c){return b.call(a,c,a);}));},end:function(){return this.prevObject||this.constructor(null);},push:g,sort:[].sort,splice:[].splice};a.fn.init.prototype=a.fn;a.extend=a.fn.extend=function(){var i,f,d,c,k,h,b=arguments[0]||{},e=1,j=arguments.length,g=false;if(typeof b==='boolean'){g=b;b=arguments[1]||{};e=2;}if(typeof b!=='object'&&!a.isFunction(b)){b={};}if(j===e){b=this;--e;}for(;e<j;e++){if((i=arguments[e])!=null){for(f in i){d=b[f];c=i[f];if(b===c){continue;}if(g&&c&&(a.isPlainObject(c)||(k=a.isArray(c)))){if(k){k=false;h=d&&a.isArray(d)?d:[];}else{h=d&&a.isPlainObject(d)?d:{};}b[f]=a.extend(g,h,c);}else if(c!==undefined){b[f]=c;}}}}return b;};a.extend({noConflict:function(b){if(window.$===a){window.$=A;}if(b&&window.jQuery===a){window.jQuery=y;}return a;},isReady:false,readyWait:1,holdReady:function(b){if(b){a.readyWait++;}else{a.ready(true);}},ready:function(b){if(b===true&&!--a.readyWait||b!==true&&!a.isReady){if(!document.body){return setTimeout(a.ready,1);}a.isReady=true;if(b!==true&&--a.readyWait>0){return;}e.resolveWith(document,[a]);if(a.fn.trigger){a(document).trigger('ready').unbind('ready');}}},bindReady:function(){if(e){return;}e=a._Deferred();if(document.readyState==='complete'){return setTimeout(a.ready,1);}if(document.addEventListener){document.addEventListener('DOMContentLoaded',b,false);window.addEventListener('load',a.ready,false);}else if(document.attachEvent){document.attachEvent('onreadystatechange',b);window.attachEvent('onload',a.ready);var c=false;try{c=window.frameElement==null;}catch(a){}if(document.documentElement.doScroll&&c){x();}}},isFunction:function(b){return a.type(b)==='function';},isArray:Array.isArray||function(b){return a.type(b)==='array';},isWindow:function(a){return a&&typeof a==='object'&&'setInterval'in a;},isNaN:function(a){return a==null||!B.test(a)||isNaN(a);},type:function(a){return a==null?String(a):i[z.call(a)]||'object';},isPlainObject:function(b){if(!b||a.type(b)!=='object'||b.nodeType||a.isWindow(b)){return false;}if(b.constructor&&!f.call(b,'constructor')&&!f.call(b.constructor.prototype,'isPrototypeOf')){return false;}var c;for(c in b){}return c===undefined||f.call(b,c);},isEmptyObject:function(a){for(var b in a){return false;}return true;},error:function(a){throw a;},parseJSON:function(b){if(typeof b!=='string'||!b){return null;}b=a.trim(b);if(window.JSON&&window.JSON.parse){return window.JSON.parse(b);}if(D.test(b.replace(E,'@').replace(F,']').replace(o,''))){return new Function('return '+b)();}a.error('Invalid JSON: '+b);},parseXML:function(d,b,c){if(window.DOMParser){c=new DOMParser();b=c.parseFromString(d,'text/xml');}else{b=new ActiveXObject('Microsoft.XMLDOM');b.async='false';b.loadXML(d);}c=b.documentElement;if(!c||!c.nodeName||c.nodeName==='parsererror'){a.error('Invalid XML: '+d);}return b;},noop:function(){},globalEval:function(a){if(a&&h.test(a)){(window.execScript||function(a){window['eval'].call(window,a);})(a);}},camelCase:function(a){return a.replace(t,u);},nodeName:function(a,b){return a.nodeName&&a.nodeName.toUpperCase()===b.toUpperCase();},each:function(b,e,g){var d,c=0,f=b.length,h=f===undefined||a.isFunction(b);if(g){if(h){for(d in b){if(e.apply(b[d],g)===false){break;}}}else{for(;c<f;){if(e.apply(b[c++],g)===false){break;}}}}else{if(h){for(d in b){if(e.call(b[d],d,b[d])===false){break;}}}else{for(;c<f;){if(e.call(b[c],c,b[c++])===false){break;}}}}return b;},trim:l?function(a){return a==null?'':l.call(a);}:function(a){return a==null?'':a.toString().replace(j,'').replace(k,'');},makeArray:function(b,e){var c=e||[];if(b!=null){var d=a.type(b);if(b.length==null||d==='string'||d==='function'||d==='regexp'||a.isWindow(b)){g.call(c,b);}else{a.merge(c,b);}}return c;},inArray:function(c,b){if(m){return m.call(b,c);}for(var a=0,d=b.length;a<d;a++){if(b[a]===c){return a;}}return-1;},merge:function(b,c){var d=b.length,a=0;if(typeof c.length==='number'){for(var e=c.length;a<e;a++){b[d++]=c[a];}}else{while(c[a]!==undefined){b[d++]=c[a++];}}b.length=d;return b;},grep:function(b,g,c){var d=[],e;c=!!c;for(var a=0,f=b.length;a<f;a++){e=!!g(b[a],a);if(c!==e){d.push(b[a]);}}return d;},map:function(b,h,i){var e,g,c=[],f=0,d=b.length,j=b instanceof a||d!==undefined&&typeof d==='number'&&(d>0&&b[0]&&b[d-1]||d===0||a.isArray(b));if(j){for(;f<d;f++){e=h(b[f],f,i);if(e!=null){c[c.length]=e;}}}else{for(g in b){e=h(b[g],g,i);if(e!=null){c[c.length]=e;}}}return c.concat.apply([],c);},guid:1,proxy:function(b,d){if(typeof d==='string'){var f=b[d];d=b;b=f;}if(!a.isFunction(b)){return undefined;}var g=c.call(arguments,2),e=function(){return b.apply(d,g.concat(c.call(arguments)));};e.guid=b.guid=b.guid||e.guid||a.guid++;return e;},access:function(b,d,e,f,g,j){var h=b.length;if(typeof d==='object'){for(var i in d){a.access(b,i,d[i],f,g,e);}return b;}if(e!==undefined){f=!j&&f&&a.isFunction(e);for(var c=0;c<h;c++){g(b[c],d,f?e.call(b[c],c,g(b[c],d)):e,j);}return b;}return h?g(b[0],d):undefined;},now:function(){return new Date().getTime();},uaMatch:function(a){a=a.toLowerCase();var b=p.exec(a)||n.exec(a)||r.exec(a)||a.indexOf('compatible')<0&&s.exec(a)||[];return{browser:b[1]||'',version:b[2]||'0'};},sub:function(){function b(a,c){return new b.fn.init(a,c);}a.extend(true,b,this);b.superclass=this;b.fn=b.prototype=this();b.fn.constructor=b;b.sub=this.sub;b.fn.init=function d(f,e){if(e&&e instanceof a&&!(e instanceof b)){e=b(e);}return a.fn.init.call(this,f,e,c);};b.fn.init.prototype=b.fn;var c=b(document);return b;},browser:{}});a.each('Boolean Number String Function Array Date RegExp Object'.split(' '),function(b,a){i['[object '+a+']']=a.toLowerCase();});d=a.uaMatch(v);if(d.browser){a.browser[d.browser]=true;a.browser.version=d.version;}if(a.browser.webkit){a.browser.safari=true;}if(h.test('\xA0')){j=/^[\s\xA0]+/;k=/[\s\xA0]+$/;}q=a(document);if(document.addEventListener){b=function(){document.removeEventListener('DOMContentLoaded',b,false);a.ready();};}else if(document.attachEvent){b=function(){if(document.readyState==='complete'){document.detachEvent('onreadystatechange',b);a.ready();}};}function x(){if(a.isReady){return;}try{document.documentElement.doScroll('left');}catch(a){setTimeout(x,1);return;}a.ready();}return a;}();jQuery.find=TP.extern.Sizzle;jQuery.expr=TP.extern.Sizzle.selectors;jQuery.expr[':']=jQuery.expr.filters;jQuery.unique=TP.extern.Sizzle.uniqueSort;jQuery.text=TP.extern.Sizzle.getText;jQuery.isXMLDoc=TP.extern.Sizzle.isXML;jQuery.contains=TP.extern.Sizzle.contains;
TP.boot.$srcPath = '';

        
        TP.extern.jQuery = jQuery;
        
    
TP.boot.$srcPath = '~app/node_modules/tibet/deps/jquery-xmlns-tpi.js';
(function(a){var e={'xml':'http://www.w3.org/XML/1998/namespace','xmlns':'http://www.w3.org/2000/xmlns/','html':'http://www.w3.org/1999/xhtml'};var i={};for(var g in e){i[e[g]]=g;}a.extend({xmlns:a.extend({},e,{'':'*'})});var f=[];a.fn.extend({xmlns:function(c,d){if(typeof c=='string'){c={'':c};}if(c){f.push(a.xmlns);a.xmlns=a.extend({},a.xmlns,c);if(d!==undefined){if(typeof d=='string'){return this.find(d).xmlns(undefined);}else{var b=this;try{b=d.call(this);if(!b){b=this;}}finally{b.xmlns(undefined);}return b;}}else{return this;}}else{a.xmlns=f?f.pop():{};return this;}}});var d=function(b){if(!b){return a.xmlns[''];}b=b.substr(0,b.length-1);if(b==''||b=='*'){return b;}var c=a.xmlns[b];if(typeof c=='undefined'){throw'Syntax error, undefined namespace prefix \''+b+'\'';}return c;};var h=function(b,c){a.expr.match[b]=new RegExp(c.source+/(?![^\[]*\])(?![^\(]*\))/.source);if(a.expr.leftMatch){a.expr.leftMatch[b]=new RegExp(/(^(?:.|\r|\n)*?)/.source+a.expr.match[b].source.replace(/\\(\d+)/g,function(b,a){return'\\'+(a-0+1);}));}};h('TAG',/^((?:((?:[\w\u00c0-\uFFFF\*_-]*\|)?)((?:[\w\u00c0-\uFFFF\*_-]|\\.)+)))/);var b=document.createElement('div');var j=false;b.appendChild(document.createComment(''));if(b.getElementsByTagName('*').length>0){j=true;}var k=true;if(b.localName&&b.localName=='div'){k=false;}b=null;a.expr.find.TAG=function(i,c,k){var e=d(i[2]);var f=i[3];var a;if(typeof c.getElementsByTagNameNS!='undefined'){a=c.getElementsByTagNameNS(e,f);}else if(typeof c.selectNodes!='undefined'){if(c.ownerDocument){c.ownerDocument.setProperty('SelectionLanguage','XPath');}else{c.setProperty('SelectionLanguage','XPath');}var h='';if(e!='*'){if(f!='*'){h='namespace-uri()=\''+e+'\' and local-name()=\''+f+'\'';}else{h='namespace-uri()=\''+e+'\'';}}else{if(f!='*'){h='local-name()=\''+f+'\'';}}if(h){a=c.selectNodes('descendant-or-self::*['+h+']');}else{a=c.selectNodes('descendant-or-self::*');}}else{a=c.getElementsByTagName(f);if(j&&f=='*'){var g=[];for(var b=0;a[b];b++){if(a[b].nodeType==1){g.push(a[b]);}}a=g;}if(a&&e!='*'){var g=[];for(var b=0;a[b];b++){if(a[b].namespaceURI==e||a[b].tagUrn==e){g.push(a[b]);}}a=g;}}return a;};var l=function(a){return a.nodeType===9&&a.documentElement.nodeName!=='HTML'||!!a.ownerDocument&&a.ownerDocument.documentElement.nodeName!=='HTML';};a.expr.preFilter.TAG=function(b,e,f,g,h,c){var a=b[3];if(!c){if(k){a=a.toUpperCase();}else{a=a.toLowerCase();}}return[b[0],d(b[2]),a];};a.expr.filter.TAG=function(a,e){var b=e[1];var c=e[2];var d=a.namespaceURI?a.namespaceURI:a.tagUrn;var f=a.localName?a.localName:a.tagName;if(b=='*'||d==b||b==''&&!d){return c=='*'&&a.nodeType==1||f==c;}return false;};h('ATTR',/\[\s*((?:((?:[\w\u00c0-\uFFFF\*_-]*\|)?)((?:[\w\u00c0-\uFFFF_-]|\\.)+)))\s*(?:(\S?=)\s*(['"]*)(.*?)\5|)\s*\]/);a.expr.preFilter.ATTR=function(b,f,g,h,i,e){var c=b[3].replace(/\\/g,'');if(!e&&a.expr.attrMap[c]){b[3]=a.expr.attrMap[c];}if(b[4]=='~='){b[6]=' '+b[6]+' ';}if(!b[2]||b[2]=='|'){b[2]='';}else{b[2]=d(b[2]);}return b;};var c=function(d,c,a){var b=d+'';return d==null?c==='!=':c==='='?b===a:c==='*='?b.indexOf(a)>=0:c==='~='?(' '+b+' ').indexOf(a)>=0:!a?b&&d!==false:c==='!='?b!=a:c==='^='?b.indexOf(a)===0:c==='$='?b.substr(b.length-a.length)===a:c==='|='?b===a||b.substr(0,a.length+1)===a+'-':false;};a.expr.filter.ATTR=function(g,m){var f=m[2];var e=m[3];var k=m[4];var j=m[6];var l;if(f==''){l=a.expr.attrHandle[e]?a.expr.attrHandle[e](g):g[e]!=null?g[e]:g.getAttribute(e);return c(l,k,j);}if(f!='*'&&typeof g.getAttributeNS!='undefined'){return c(g.getAttributeNS(f,e),k,j);}var d=g.attributes;for(var b=0;d[b];b++){var h=d[b].localName;if(!h){h=d[b].nodeName;var n=h.indexOf(':');if(n>=0){h=h.substr(n+1);}}if(h==e){l=d[b].nodeValue;if(f=='*'||d[b].namespaceURI==f){if(c(l,k,j)){return true;}}if(d[b].namespaceURI===''&&d[b].prefix){if(d[b].prefix==i[f]){if(c(l,k,j)){return true;}}}}}return false;};}(jQuery));
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETCSSQueryPost.js';
TP.definePrimitive('elementMatchesCSS',function(a,b){var c;if(!TP.isElement(a)){return TP.raise(this,'TP.sig.InvalidElement',arguments);}if(TP.isEmpty(b)){return TP.raise(this,'TP.sig.InvalidString',arguments,'Invalid or empty selector');}if(TP.isValid(a.tibetGenerated)){return false;}if(TP.isTrue(TP.regex.CSS_NATIVE_CUSTOM.test(b))){return false;}c=a.mozMatchesSelector||a.webkitMatchesSelector||a.msMatchesSelector||a.matches;if(TP.isCallable(c)){return c.call(a,b);}TP.w3.Xmlns.get('prefixes').perform(function(a){TP.extern.jQuery.xmlns[a.first()]=a.last();});return TP.notEmpty(TP.extern.Sizzle.matches(b,[a]));});TP.definePrimitive('nodeEvaluateCSS',function(e,f,c){var g,a,h,d,b;TP.debug('break.query_css');g=TP.isWindow(e)?e.document:e;if(!TP.isNode(g)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isEmpty(f)){return TP.raise(this,'TP.sig.InvalidString',arguments,'Invalid or empty selector');}if(TP.isTrue(TP.regex.CSS_NATIVE_CUSTOM.test(f))){return TP.isTrue(c)?null:TP.ac();}TP.w3.Xmlns.get('prefixes').perform(function(a){TP.extern.jQuery.xmlns[a.first()]=a.last();});try{a=TP.extern.Sizzle(f,g);}catch(a){return TP.isTrue(c)?null:TP.ac();}if(a.length===0&&TP.isTrue(c)){return null;}if(a.length===1&&TP.isTrue(c)){b=a.item(0);if(TP.notValid(b.tibetGenerated)){return b;}else{return null;}}h=TP.ac();for(d=0;d<a.length;d++){b=a.item(d);if(TP.notValid(b.tibetGenerated)){h.push(b);}}return h;});TP.definePrimitive('selectorIsNative',function(a){if(TP.isEmpty(a)){return TP.raise(this,'TP.sig.InvalidString',arguments,'Invalid or empty selector');}if(TP.notValid(document.querySelectorAll)){return false;}try{document.querySelectorAll(a);return true;}catch(a){return false;}});TP.definePrimitive('windowMatchesCSSMedia',function(a,c){var b;if(!TP.isWindow(a)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(TP.notValid(a.matchMedia)){return TP.raise(this,'TP.sig.UnsupportedFeature',arguments);}if(TP.isEmpty(c)){return TP.raise(this,'TP.sig.InvalidString',arguments,'Invalid or empty query');}b=a.matchMedia(c);if(!TP.isMediaQueryList(b)){return null;}return b.matches;});TP.definePrimitive('windowQueryCSSMedia',function(b,c,d){var a;if(!TP.isWindow(b)){return TP.raise(this,'TP.sig.InvalidWindow',arguments);}if(TP.notValid(b.matchMedia)){return TP.raise(this,'TP.sig.UnsupportedFeature',arguments);}if(TP.isEmpty(c)){return TP.raise(this,'TP.sig.InvalidString',arguments,'Invalid or empty query');}a=b.matchMedia(c);if(!TP.isMediaQueryList(a)){return null;}if(TP.isCallable(d)){a.addListener(d);}return a;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETHTTPPrimitivesPre.js';
TP.definePrimitive('httpDidSucceed',function(b){var a;try{a=b.status;if(a>=200&&a<=207||a===304){return true;}if(a===0&&(b.responseXML||b.responseText)){return true;}}catch(a){TP.ifError()?TP.error(TP.ec(a,'HTTP status error.'),TP.IO_LOG,arguments):0;}return false;});TP.definePrimitive('httpDidRedirect',function(b){var a;try{a=b.status;if(a>=300&&a<=307){return a!==304;}}catch(a){TP.ifError()?TP.error(TP.ec(a,'HTTP redirect error.'),TP.IO_LOG,arguments):0;}return false;});TP.definePrimitive('httpEncode',function(k,t,s,j,r){var a,q,h,l,b,d,m,p,c,n,e,f,i,g,o;if(TP.notValid(k)){return k;}if(TP.isString(k)){if(!TP.isNode(a=TP.nodeFromString(k,null,false))){return k;}if(TP.isTextNode(a)){return k;}}else{a=k;}if(TP.canInvoke(a,'getNativeNode')){a=a.getNativeNode();}q=TP.ifInvalid(t,TP.URL_ENCODED);h=TP.ifInvalid(r,TP.UTF8);l=TP.ifInvalid(s,'&');switch(q){case TP.JSON_ENCODED:if(TP.isNode(a)){return TP.xml2json(a);}else{return TP.js2json(a);}break;case TP.URL_ENCODED:b=TP.ac();if(TP.isNode(a)){d=TP.nodeGetElementsByTagName(a,'*');d.unshift(a);e=d.getSize();for(c=0;c<e;c++){f=d.at(c);if(TP.notEmpty(f)){if(TP.notEmpty(i=TP.nodeGetTextContent(f))){b.push(TP.join(TP.elementGetLocalName(f),'=',encodeURIComponent(i)));}}}}else{d=TP.keys(a);e=d.getSize();for(c=0;c<e;c++){if(TP.notEmpty(i=a.at(d.at(c)))){b.push(TP.join(d.at(c),'=',encodeURIComponent(i)));}else{b.push(d.at(c));}}}return TP.ifEmpty(b.join(l),null);case TP.XML_ENCODED:if(TP.isNode(a)){return TP.nodeAsString(a);}return TP.nodeAsString(TP.js2xml(a));case TP.XMLRPC_ENCODED:return TP.nodeAsString(TP.js2xmlrpc(a));case TP.FIELD_ENCODED:b=TP.ac();if(TP.isNode(a)){d=TP.nodeGetElementsByTagName(a,'*');d.unshift(a);e=d.getSize();for(c=0;c<e;c++){f=d.at(c);if(TP.notEmpty(f)){if(TP.notEmpty(i=TP.nodeGetTextContent(f))){b.push('<input type="hidden" name="',f.tagName,'" value="',i.replace(/\"/g,'&quot;'),'" />\n');}}}}else{d=TP.keys(a);e=d.getSize();for(c=0;c<e;c++){m=a.at(d.at(c));if(TP.isArray(m)){p=m.getSize();for(n=0;n<p;n++){b.push('<input type="hidden" name="',d.at(c),'" value="',TP.str(a.at(d.at(c)).at(n)).replace(/\"/g,'&quot;'),'" />\n');}}else{b.push('<input type="hidden" name="',d.at(c),'" value="',TP.str(m).replace(/\"/g,'&quot;'),'" />\n');}}}return TP.ifEmpty(b.join(''),null);case TP.MP_RELATED_ENCODED:b=TP.ac();g=TP.genID('part');b.push(TP.join('Content-Type: ',TP.MP_RELATED_ENCODED,'; boundary=',g));if(TP.isArray(a)){b.push(TP.join('; type=',a.first().atIfInvalid('mimetype',TP.PLAIN_TEXT_ENCODED)));}else if(TP.isNode(a)){b.push(TP.join('; type=',TP.ifInvalid(j,TP.XML_ENCODED),'; charset=',h));}else{b.push(TP.join('; type=',TP.ifInvalid(j,TP.PLAIN_TEXT_ENCODED),'; charset=',h));}b.push('--'+g);if(TP.isArray(a)){a.perform(function(d,i){var a,c,e,f;if(TP.notValid(a=d.at('body'))){return;}a=TP.unwrap(a);c=d.atIfInvalid('mimetype',j);if(TP.isEmpty(c)){if(TP.isNode(a)){c=TP.XML_ENCODED;}else{c=TP.PLAIN_TEXT_ENCODED;}}e=d.atIfInvalid('encoding',h);if(TP.notEmpty(c)){b.push(TP.join('Content-Type: ',c,'; charset=',e));}f=d.atIfInvalid('separator',l);b.push('Content-ID: '+i);if(TP.notTrue(d.at('noencode'))){a=TP.httpEncode(a,c,f,null,e);}b.push('',a);b.push('--'+g);});}else if(TP.isNode(a)){b.push(TP.join('Content-Type: ',TP.ifInvalid(j,TP.XML_ENCODED),'; charset=',h),'Content-ID: 0');o=TP.httpEncode(a,TP.ifInvalid(j,TP.XML_ENCODED),l,null,h);b.push(o);b.push('--'+g);}else{d=TP.keys(a);e=d.getSize();for(c=0;c<e;c++){if(TP.notEmpty(j)){b.push(TP.join('Content-Type: ',j,'; charset=',h,' '));}b.push('Content-ID: '+d.at(c));o=TP.str(a.at(d.at(c)));b.push(o);b.push('--'+g);}}b.atPut(b.getSize()-1,b.last()+'--\r\n');return b.join('\r\n');case TP.MP_FORMDATA_ENCODED:b=TP.ac();g=TP.genID('part');b.push(TP.join('Content-Type: ',TP.MP_FORMDATA_ENCODED,'; boundary=',g));b.push('--'+g);if(TP.isNode(a)){d=TP.nodeGetElementsByTagName(a,'*');d.unshift(a);e=d.getSize();for(c=0;c<e;c++){f=d.at(c);if(TP.notEmpty(f)){if(TP.nodeGetChildElements(f).getSize()>0){continue;}if(TP.notEmpty(i=TP.nodeGetTextContent(f))){b.push(TP.join('Content-disposition: form-data','; name="',TP.elementGetLocalName(f),'"','\r\n','Content-Type: ',TP.PLAIN_TEXT_ENCODED,'; charset=',h),i,'--'+g);}}}}else{d=TP.keys(a);e=d.getSize();for(c=0;c<e;c++){b.push(TP.join('Content-disposition: form-data','; name="',d.at(c),'"','\r\n','Content-Type: ',TP.PLAIN_TEXT_ENCODED,'; charset=',h),TP.str(a.at(d.at(c))),'--'+g);}}b.atPut(b.getSize()-1,b.last()+'--\r\n');return b.join('\r\n');default:return TP.str(a);}return a;});TP.definePrimitive('httpEncodeRequestBody',function(a){var b,c,d,e,f;b=a.at('body');if(TP.notValid(b)){return;}if(TP.isTrue(a.at('noencode'))){return b;}c=a.at('mimetype');d=a.at('separator');e=a.at('mediatype');f=a.at('encoding');return TP.httpEncode(b,c,d,e,f);});TP.definePrimitive('httpError',function(c,e,g,f){var a,b,d;a=TP.ifInvalid(f,TP.request());a.atPutIfAbsent('uri',c);b=TP.ifInvalid(e,'HTTPException');d=a.atIfInvalid('object',new Error(TP.ifEmpty(a.at('message'),b)));a.atPut('message','HTTP request exception.');TP.ifError()?TP.error(a,TP.IO_LOG,arguments):0;if(!TP.sys.shouldThrowExceptions()){TP.raise(c,b,arguments,a);}else{throw d;}return;});TP.definePrimitive('httpGetDefaultHeaders',function(){return TP.hc('Pragma','no-cache','Cache-Control',TP.ac('no-cache','no-store'),'Accept',TP.ac(TP.JS_TEXT_ENCODED,TP.JSON_ENCODED,TP.JSON_TEXT_ENCODED,TP.XML_ENCODED,TP.XML_TEXT_ENCODED,TP.XHTML_ENCODED,TP.HTML_TEXT_ENCODED,'*/*'));});TP.definePrimitive('httpSetHeaders',function(o,p,h){var b,a,f,m,g,j,d,e,c,i,n,l,k;b=TP.ifInvalid(p,TP.request());a=TP.ifKeyInvalid(b,'headers',TP.httpGetDefaultHeaders());b.atPut('headers',a);n=b.at('finalbody');l=b.at('uri');if(TP.notDefined(b.at('mimetype'))){b.atPut('mimetype',TP.ietf.Mime.guessMIMEType(n,l,TP.URL_ENCODED));}if(TP.boot.isUA('GECKO')){if(TP.isDefined(f=a.at('Pragma'))){if(f==='no-cache'){a.removeKey('Pragma');}else if(TP.isArray(f)){f.remove('no-cache');}}}else if(TP.notDefined(a.at('Pragma'))){a.atPut('Pragma','no-cache');}if(TP.notDefined(a.at('Cache-Control'))){a.atPut('Cache-Control',TP.ac('no-cache','no-store'));}if(TP.notDefined(a.at('Content-Type'))){a.atPut('Content-Type',b.at('mimetype'));}if(TP.notDefined(a.at('X-Requested-With'))){if(TP.uriNeedsPrivileges(o)&&TP.sys.cfg('tibet.simple_cors_only')){}else{a.atPut('X-Requested-With','XMLHttpRequest');}}if(b.at('auth')===TP.HTTP_BASIC){if(TP.notDefined(a.at('Authentication'))&&TP.isDefined(b.at('username'))&&TP.isDefined(b.at('password'))){m=TP.btoa(TP.join(b.at('username'),':',b.at('password')));a.atPut('Authorization','Basic '+m);}}if(TP.notDefined(a.at('X-HTTP-Method-Override'))){if(b.at('verb')===TP.HTTP_POST&&TP.notEmpty(k=b.at('method'))){a.atPut('X-HTTP-Method-Override',k);}}g=TP.keys(a);j=g.getSize();for(d=0;d<j;d++){e=g.at(d);c=a.at(e);if(TP.isArray(c)){if(TP.boot.isUA('WEBKIT')){h.setRequestHeader(e,c.join(', '));}else{for(i=0;i<c.length;i++){h.setRequestHeader(e,c.at(d));}}}else{h.setRequestHeader(e,c);}}return TP.str(a);});TP.definePrimitive('$httpTimeout',function(f,g,e){var a,d,b,c;TP.httpAbort(e);a=TP.request(g);a.atPut('xhr',e);a.atPut('direction',TP.RECV);a.atPut('object',new Error('Timeout'));a.atPut('message','HTTP request failed: Timeout');TP.httpError(f,'HTTPSendException',arguments,a);if(TP.notValid(d=TP.sys.getTypeByName('TP.sig.HTTPResponse',false))){if(TP.notValid(d=TP.sys.getTypeByName('TP.sig.Response',false))){return;}}b=d.construct(a);c=a.getRequestID();b.setSignalName('TP.sig.IOTimeout');b.fire(c);b.setSignalName('TP.sig.IOFailed');b.fire(c);b.setSignalName('TP.sig.IOCompleted');b.fire(c);return;});TP.definePrimitive('$httpWrapup',function(i,j,c){var a,d,h,f,g,b,e;TP.debug('break.http_wrapup');a=TP.request(j);d=TP.ifInvalid(i,a.at('uri'));h=a.atIfInvalid('redirect',true);if(h&&TP.httpDidRedirect(c)){d=c.getResponseHeader('Location');f=a.at('async');if(TP.isTrue(f)){a.atPut('async',false);}try{c=TP.httpCall(d,a);}catch(a){}finally{a.atPut('async',f);}}a.atPut('xhr',c);if(TP.notValid(g=TP.sys.getTypeByName('TP.sig.HTTPResponse',false))){if(TP.notValid(g=TP.sys.getTypeByName('TP.sig.Response',false))){return;}}b=g.construct(a);e=a.getRequestID();if(!TP.httpDidSucceed(c)){TP.httpError(d,'HTTPException',arguments,a);b.setSignalName('TP.sig.IOFailed');b.fire(e);}else{b.setSignalName('TP.sig.IOSucceeded');b.fire(e);}b.setSignalName('TP.sig.IOCompleted');b.fire(e);return;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETHTTPPrimitivesBase.js';

TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETHTTPPrimitivesPlatform.js';
TP.definePrimitive('$httpObtainSecurityInfo',TP.hc('test','gecko','true',function(c){var b,a;a=TP.ac();b=TP.executePrivileged(TP.ACCESS_XDOMAIN_XMLHTTP,'This TIBET-based application would like to read XMLHttpRequest security information','This TIBET-based application cannot read XMLHttpRequest security information',false,function(){var f,b,d,e,h,g;try{f=c.channel;b=Components.interfaces;if(!(f instanceof b.nsIChannel)){return;}d=f.securityInfo;if(d instanceof b.nsITransportSecurityInfo){d.QueryInterface(b.nsITransportSecurityInfo);a.push('Security state: ');if((d.securityState&b.nsIWebProgressListener.STATE_IS_SECURE)===b.nsIWebProgressListener.STATE_IS_SECURE){a.push('secure\n');}else if((d.securityState&b.nsIWebProgressListener.STATE_IS_INSECURE)===b.nsIWebProgressListener.STATE_IS_INSECURE){a.push('insecure\n');}else if((d.securityState&b.nsIWebProgressListener.STATE_IS_BROKEN)===b.nsIWebProgressListener.STATE_IS_BROKEN){a.push('unknown\n');}a.push('\tSecurity description: ',d.shortSecurityDescription,'\n');a.push('\tSecurity error message: ',d.errorMessage,'\n');}else{a.push('\tNo security info available for this channel\n');}if(d instanceof b.nsISSLStatusProvider){e=d.QueryInterface(b.nsISSLStatusProvider).SSLStatus.QueryInterface(b.nsISSLStatus).serverCert;a.push('\nCertificate Status:\n');h=e.verifyForUsage(b.nsIX509Cert.CERT_USAGE_SSLServer);a.push('\tVerification: ');switch(h){case b.nsIX509Cert.VERIFIED_OK:a.push('OK');break;case b.nsIX509Cert.NOT_VERIFIED_UNKNOWN:a.push('not verfied/unknown');break;case b.nsIX509Cert.CERT_REVOKED:a.push('revoked');break;case b.nsIX509Cert.CERT_EXPIRED:a.push('expired');break;case b.nsIX509Cert.CERT_NOT_TRUSTED:a.push('not trusted');break;case b.nsIX509Cert.ISSUER_NOT_TRUSTED:a.push('issuer not trusted');break;case b.nsIX509Cert.ISSUER_UNKNOWN:a.push('issuer unknown');break;case b.nsIX509Cert.INVALID_CA:a.push('invalid CA');break;default:a.push('unexpected failure');break;}a.push('\n');a.push('\tCommon name (CN) = ',e.commonName,'\n');a.push('\tOrganisation = ',e.organization,'\n');a.push('\tIssuer = ',e.issuerOrganization,'\n');a.push('\tSHA1 fingerprint = ',e.sha1Fingerprint,'\n');g=e.validity.QueryInterface(b.nsIX509CertValidity);a.push('\tValid from ',g.notBeforeGMT,'\n');a.push('\tValid until ',g.notAfterGMT,'\n');}}catch(b){a.push(TP.str(b));}});if(b){return a.join('');}return null;},TP.DEFAULT,function(a){return;}));TP.definePrimitive('httpCall',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(d,n){var a,c,g,m,h,l,f,b,j,k,o,i,e;a=TP.ifInvalid(n,TP.request());c=d||a.at('uri');if(TP.isEmpty(c)){return TP.httpError(d,'TP.sig.InvalidURI',arguments,a);}if(!TP.isKindOf(c,String)){return TP.httpError(c,'TP.sig.InvalidParameter',arguments,a);}c=c.getLocation();a.addIfAbsent('uri',c);if(TP.notEmpty(g=a.at('uriparams'))){g=TP.httpEncode(g,TP.URL_ENCODED);if(TP.notEmpty(g)){c=TP.uriJoinQuery(c,g);}}a.atPut('finaluri',c);a.addIfAbsent('verb',TP.HTTP_GET);m=a.at('verb');a.addIfAbsent('async',true);h=a.at('async');l=a.at('body');if(TP.isValid(l)){f=TP.httpEncodeRequestBody(a);a.atPut('finalbody',f);if(TP.isNode(l)){a.atIfInvalid('bodyWantsXMLDeclaration',false);}}try{b=TP.httpCreate(c);a.atPut('xhr',b);if(j===TP.NONE){j=null;}if(k===TP.NONE){k=null;}b.open(m,c,h,j,k);}catch(b){a.atPut('object',b);a.atPut('message',TP.str(b));return TP.httpError(d,'HTTPException',arguments,a);}try{o=TP.httpSetHeaders(c,a,b);}catch(b){a.atPut('object',b);a.atPut('message',TP.str(b));return TP.httpError(d,'HTTPHeaderException',arguments,a);}if(h){i=TP.schedule(TP.hc('step',function(){TP.$httpTimeout(d,a,b);return true;},'delay',TP.ifInvalid(a.at('timeout'),TP.sys.cfg('http.timeout'))));b.onreadystatechange=function(){if(b.readyState!==4){return;}i.kill(true);a.atPut('direction',TP.RECV);a.atPut('message','HTTP request completed.');TP.ifInfo(TP.sys.shouldLogIO())?TP.sys.logIO(a,TP.INFO,arguments):0;TP.$httpWrapup(d,a,b);};}try{a.atPut('direction',TP.SEND);a.atPut('message','HTTP request initiated.');TP.ifInfo(TP.sys.shouldLogIO())?TP.sys.logIO(a,TP.INFO,arguments):0;if(TP.isString(f)){f=''+f;}try{b.send(f);}catch(a){e=TP.tostr(a);if(TP.isString(e)&&/0x80004005/.test(e)){if(TP.uriNeedsPrivileges(d)){e='The URL needs privileges and'+' couldn\'t obtain them. Bad'+' CORS request?';}else if(b.status===0&&TP.isEmpty(e=TP.$httpObtainSecurityInfo(b))){e='XHR status is 0 and there'+' was no security info.'+' URL missing domain or bad'+' certificate?';}TP.ifWarn()?TP.warn(e,TP.LOG,arguments):0;}else{throw a;}}if(TP.notTrue(h)){a.atPut('direction',TP.RECV);a.atPut('message','HTTP request completed.');TP.ifInfo(TP.sys.shouldLogIO())?TP.sys.logIO(a,TP.INFO,arguments):0;TP.$httpWrapup(d,a,b);}}catch(b){if(TP.isValid(i)){i.kill(true);}a.atPut('direction',TP.RECV);a.atPut('object',b);a.atPut('message','HTTP request failed: '+TP.str(b));return TP.httpError(d,'HTTPSendException',arguments,a);}if(TP.notValid(b)){a.atPut('message','The server may have refused the '+'connection. Is the URI a valid '+'target?');return TP.httpError(d,'HTTPException',arguments,a);}return b;},'trident',function(d,m){var a,b,f,l,h,i,e,j,k,c,n,g;a=TP.ifInvalid(m,TP.request());b=d||a.at('uri');if(TP.isEmpty(b)){return TP.httpError(d,'TP.sig.InvalidURI',arguments,a);}if(!TP.isKindOf(b,String)){return TP.httpError(b,'TP.sig.InvalidParameter',arguments,a);}b=b.getLocation();a.addIfAbsent('uri',b);if(TP.notEmpty(f=a.at('uriparams'))){f=TP.httpEncode(f,TP.URL_ENCODED);if(TP.notEmpty(f)){b=TP.uriJoinQuery(b,f);}}a.atPut('finaluri',b);a.addIfAbsent('verb',TP.HTTP_GET);l=a.at('verb');a.addIfAbsent('async',true);h=a.at('async');i=a.at('body');if(TP.isValid(i)){e=TP.httpEncodeRequestBody(a);a.atPut('finalbody',e);if(TP.isNode(i)){a.atIfInvalid('bodyWantsXMLDeclaration',false);}}try{c=TP.httpCreate(b);a.atPut('xhr',c);if(j===TP.NONE){j=null;}if(k===TP.NONE){k=null;}c.open(l,b,h,j,k);}catch(b){a.atPut('object',b);a.atPut('message',TP.str(b));return TP.httpError(d,'HTTPException',arguments,a);}try{n=TP.httpSetHeaders(b,a,c);}catch(b){a.atPut('object',b);a.atPut('message',TP.str(b));return TP.httpError(d,'HTTPHeaderException',arguments,a);}if(h){g=TP.schedule(TP.hc('step',function(){TP.$httpTimeout(d,a,c);return true;},'delay',TP.ifInvalid(a.at('timeout'),TP.sys.cfg('http.timeout'))));c.onreadystatechange=function(){if(c.readyState!==4){return;}g.kill(true);a.atPut('direction',TP.RECV);a.atPut('message','HTTP request completed.');TP.ifInfo(TP.sys.shouldLogIO())?TP.sys.logIO(a,TP.INFO,arguments):0;TP.$httpWrapup(d,a,c);};}try{a.atPut('direction',TP.SEND);a.atPut('message','HTTP request initiated.');TP.ifInfo(TP.sys.shouldLogIO())?TP.sys.logIO(a,TP.INFO,arguments):0;if(TP.isString(e)){e=''+e;}try{c.send(e);}catch(a){throw a;}if(TP.notTrue(h)){a.atPut('direction',TP.RECV);a.atPut('message','HTTP request completed.');TP.ifInfo(TP.sys.shouldLogIO())?TP.sys.logIO(a,TP.INFO,arguments):0;TP.$httpWrapup(d,a,c);}}catch(b){if(TP.isValid(g)){g.kill(true);}a.atPut('direction',TP.RECV);a.atPut('object',b);a.atPut('message','HTTP request failed: '+TP.str(b));return TP.httpError(d,'HTTPSendException',arguments,a);}return c;},'webkit',function(d,m){var a,b,f,l,h,i,e,j,k,c,n,g;a=TP.ifInvalid(m,TP.request());b=d||a.at('uri');if(TP.isEmpty(b)){return TP.httpError(d,'TP.sig.InvalidURI',arguments,a);}if(!TP.isKindOf(b,String)){return TP.httpError(b,'TP.sig.InvalidParameter',arguments,a);}if(TP.sys.isHTTPBased()&&TP.uriNeedsPrivileges(d)){a.atPut('message','Permission not available to '+'make cross-domain HTTP call');return TP.httpError(d,'TP.sig.PrivilegeViolation',arguments,a);}b=b.getLocation();a.addIfAbsent('uri',b);if(TP.notEmpty(f=a.at('uriparams'))){f=TP.httpEncode(f,TP.URL_ENCODED);if(TP.notEmpty(f)){b=TP.uriJoinQuery(b,f);}}a.atPut('finaluri',b);a.addIfAbsent('verb',TP.HTTP_GET);l=a.at('verb');a.addIfAbsent('async',true);h=a.at('async');i=a.at('body');if(TP.isValid(i)){e=TP.httpEncodeRequestBody(a);a.atPut('finalbody',e);if(TP.isNode(i)){a.atIfInvalid('bodyWantsXMLDeclaration',false);}}try{c=TP.httpCreate(b);a.atPut('xhr',c);if(j===TP.NONE){j=null;}if(k===TP.NONE){k=null;}c.open(l,b,h,j,k);}catch(b){a.atPut('object',b);a.atPut('message',TP.str(b));return TP.httpError(d,'HTTPException',arguments,a);}try{n=TP.httpSetHeaders(b,a,c);}catch(b){a.atPut('object',b);a.atPut('message',TP.str(b));return TP.httpError(d,'HTTPHeaderException',arguments,a);}if(h){g=TP.schedule(TP.hc('step',function(){TP.$httpTimeout(d,a,c);return true;},'delay',TP.ifInvalid(a.at('timeout'),TP.sys.cfg('http.timeout'))));c.onreadystatechange=function(){if(c.readyState!==4){return;}g.kill(true);a.atPut('direction',TP.RECV);a.atPut('message','HTTP request completed.');TP.ifInfo(TP.sys.shouldLogIO())?TP.sys.logIO(a,TP.INFO,arguments):0;TP.$httpWrapup(d,a,c);};}try{a.atPut('direction',TP.SEND);a.atPut('message','HTTP request initiated.');TP.ifInfo(TP.sys.shouldLogIO())?TP.sys.logIO(a,TP.INFO,arguments):0;if(TP.isString(e)){e=''+e;}c.send(e);if(TP.notTrue(h)){a.atPut('direction',TP.RECV);a.atPut('message','HTTP request completed.');TP.ifInfo(TP.sys.shouldLogIO())?TP.sys.logIO(a,TP.INFO,arguments):0;TP.$httpWrapup(d,a,c);}}catch(b){if(TP.isValid(g)){g.kill(true);}a.atPut('direction',TP.RECV);a.atPut('object',b);a.atPut('message','HTTP request failed: '+TP.str(b));return TP.httpError(d,'HTTPSendException',arguments,a);}return c;}));TP.definePrimitive('httpCreate',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(b,e){var a,d,c;a=new XMLHttpRequest();if(TP.notValid(a)){return TP.httpError(b,'HTTPCreateException',arguments,TP.hc('message','Unable to instantiate XHR object.'));}if(TP.isValid(b)&&TP.isValid(d=TP.sys.require('TP.core.URI'))){c=TP.uc(b);c.$set('lastCommObj',a);}if(TP.uriResultType(b)!==TP.DOM){a.overrideMimeType(TP.PLAIN_TEXT_ENCODED);}else{a.overrideMimeType(TP.XML_ENCODED);}return a;},'trident',function(c,g){var a,f,e,d,b;d=TP.IE_XMLHTTP_VERSIONS;for(b=0;b<d.getSize();b++){try{a=new ActiveXObject(d[b]);break;}catch(a){}}if(TP.notValid(a)){return TP.httpError(c,'HTTPCreateException',arguments,TP.hc('message','Unable to instantiate XHR object.'));}if(TP.isValid(c)&&TP.isValid(f=TP.sys.require('TP.core.URI'))){e=TP.uc(c);e.$set('lastCommObj',a);}return a;},'webkit',function(b,e){var a,d,c;a=new XMLHttpRequest();if(TP.notValid(a)){return TP.httpError(b,'HTTPCreateException',arguments,TP.hc('message','Unable to instantiate XHR object.'));}if(TP.isValid(b)&&TP.isValid(d=TP.sys.require('TP.core.URI'))){c=TP.uc(b);c.$set('lastCommObj',a);}if(TP.uriResultType(b)!==TP.DOM){a.overrideMimeType(TP.PLAIN_TEXT_ENCODED);}return a;}));
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETHTTPPrimitivesPost.js';
TP.definePrimitive('httpAbort',function(a){if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}a.onreadystatechange=TP.RETURN_NULL;a.abort();return a;});TP.definePrimitive('httpDelete',function(b,c){var a;a=TP.ifInvalid(c,TP.request());a.atPutIfAbsent('redirect',false);return TP.$httpSend(TP.HTTP_DELETE,b,a);});TP.definePrimitive('httpGet',function(d,e){var b,a,c;b=TP.ifInvalid(e,TP.request());a=b.at('headers');if(TP.notValid(a)){a=TP.hc('Content-Type',TP.URL_ENCODED);b.atPutIfAbsent('headers',a);}else{if(TP.notEmpty(c=a.at('Content-Type'))){if(c!==TP.URL_ENCODED){TP.ifWarn()?TP.warn('Content-Type supplied to GET call.'+' Forcing to be '+TP.URL_ENCODED+'.',TP.IO_LOG,arguments):0;}}a.atPut('Content-Type',TP.URL_ENCODED);}return TP.$httpQuery(TP.HTTP_GET,d,b);});TP.definePrimitive('httpHead',function(a,b){return TP.$httpQuery(TP.HTTP_HEAD,a,b);});TP.definePrimitive('httpOptions',function(a,b){return TP.$httpQuery(TP.HTTP_OPTIONS,a,b);});TP.definePrimitive('httpPost',function(a,b){return TP.$httpSend(TP.HTTP_POST,a,b);});TP.definePrimitive('httpPut',function(a,b){return TP.$httpSend(TP.HTTP_PUT,a,b);});TP.definePrimitive('httpTrace',function(a,b){return TP.$httpQuery(TP.HTTP_TRACE,a,b);});TP.definePrimitive('$httpQuery',function(d,b,e){var a,c;a=TP.ifInvalid(e,TP.request());a.atPut('uri',b);a.atPut('verb',d);if(TP.isEmpty(b)){return TP.httpError(b,'TP.sig.InvalidURI',arguments,a);}try{c=TP.httpCall(b,a);}catch(c){a.atPut('object',c);a.atPut('message',TP.str(c));return TP.httpError(b,TP.ifKeyInvalid(a,'exceptionType','HTTPException'),arguments,a);}return c;});TP.definePrimitive('$httpSend',function(e,b,f){var a,c,d;a=TP.ifInvalid(f,TP.request());a.atPut('uri',b);a.atPut('verb',e);if(TP.isEmpty(b)){return TP.httpError(b,'TP.sig.InvalidURI',arguments,a);}c=TP.hc(a.at('headers'));a.atPut('headers',c);try{d=TP.httpCall(b,a);}catch(c){a.atPut('object',c);a.atPut('message',TP.str(c));return TP.httpError(b,TP.ifKeyInvalid(a,'exceptionType','HTTPException'),arguments,a);}return d;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETWebSocketPrimitives.js';
TP.definePrimitive('webSocketAbort',function(a){if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}a.onmessage=TP.RETURN_NULL;a.close();return a;});TP.definePrimitive('webSocketCall',function(e,h){var a,b,f,c,d,g;a=TP.ifInvalid(h,TP.request());b=e||a.at('uri');if(TP.isEmpty(b)){return TP.webSocketError(e,'TP.sig.InvalidURI',arguments,a);}b=TP.uc(b);if(TP.notValid(d=b.get('webSocketObj'))){return TP.webSocketError(e,'TP.sig.InvalidWebSocket',arguments,a);}b=b.getLocation();a.addIfAbsent('uri',b);a.atPut('finaluri',b);f=a.at('body');if(TP.isValid(f)){if(TP.isNode(f)){c=TP.nodeAsString(f,a.atIfInvalid('bodyWantsXMLDeclaration',false));}else{c=TP.str(f);}a.atPut('finalbody',c);}g=TP.schedule(TP.hc('step',function(){TP.$websocketTimeout(e,a,d);return true;},'delay',TP.ifInvalid(a.at('timeout'),TP.sys.cfg('websocket.timeout'))));d.onmessage=function(b){g.kill(true);TP.ifInfo(TP.sys.shouldLogIO())?TP.sys.logIO(TP.hc('direction',TP.RECV,'message','WebSocket request completed.'),TP.INFO,arguments):0;d.responseData=b.data;TP.$webSocketWrapup(e,a,d);};try{TP.ifInfo(TP.sys.shouldLogIO())?TP.sys.logIO(TP.hc('direction',TP.SEND,'message','WebSocket request initiated.'),TP.INFO,arguments):0;if(TP.isString(c)){c=''+c;}d.send(c);}catch(b){if(TP.isValid(g)){g.kill(true);}a.atPut('direction',TP.RECV);a.atPut('object',b);a.atPut('message','WebSocket request failed: '+TP.str(b));return TP.webSocketError(e,'WebSocketSendException',arguments,a);}return d;});TP.definePrimitive('webSocketClose',function(a,e){var b,c,d;b=TP.uc(a);c=TP.ifInvalid(e,TP.request());if(TP.isEmpty(b)){return TP.webSocketError(a,'TP.sig.InvalidURI',arguments,c);}if(TP.notValid(d=b.get('webSocketObj'))){return TP.webSocketError(a,'TP.sig.InvalidWebSocket',arguments,c);}d.close();return d;});TP.definePrimitive('webSocketCreate',function(b,d){var c,a;c=TP.uc(b);if(TP.isValid(a=c.get('webSocketObj'))){if(a.readyState!==WebSocket.OPEN&&TP.isCallable(d)){a.socketOpenCallback=d;}return a;}a=new WebSocket(c.getLocation());if(TP.isCallable(d)){a.socketOpenCallback=d;}a.onopen=function(e){var d;if(TP.isURI(b)&&TP.isType(d=TP.sys.require('TP.core.URI'))){c=TP.uc(b);c.set('webSocketObj',a);}if(TP.isCallable(a.socketOpenCallback)){a.socketOpenCallback(a);}return;};a.onclose=function(a){TP.ifInfo()?TP.info('The socket for: '+b+' just closed',TP.LOG,arguments):0;TP.uc(b).set('webSocketObj',null);return;};a.onerror=function(g){var e,d,f;TP.ifInfo()?TP.info('The socket for: '+b+' had an error',TP.LOG,arguments):0;TP.webSocketError(b,'WebSocketException',arguments,TP.hc('message','WebSocket error','object',TP.ec(g),'wsObj',a));var c=null;c.getResponse().set('responseData',null);c.getResponse().set('statusCode',TP.FAILURE);c.getResponse().set('statusText',TP.sc(TP.str(g)));if(TP.notValid(e=TP.sys.getTypeByName('TP.sig.WebSocketResponse',false))){if(TP.notValid(e=TP.sys.getTypeByName('TP.sig.Response',false))){return;}}d=e.construct(c);f=c.getRequestID();d.setSignalName('TP.sig.IOFailed');d.fire(f);d.setSignalName('TP.sig.IOCompleted');d.fire(f);return;};if(TP.notValid(a)){return TP.webSocketError(b,'WebSocketCreateException',arguments,TP.hc('message','Unable to instantiate WebSocket object.'));}return a;});TP.definePrimitive('webSocketError',function(b,g,h,f){var a,c,d,e;a=TP.ifInvalid(f,TP.request());a.atPutIfAbsent('uri',b);c=f.at('wsObj');a.atPut('wsObj',c);c.status=TP.FAILURE;d=TP.ifInvalid(g,'WebSocketException');e=a.atIfInvalid('object',new Error(TP.ifEmpty(a.at('message'),d)));a.atPut('message','WebSocket request exception.');TP.ifError()?TP.error(a,TP.IO_LOG,arguments):0;if(TP.$DEBUG){TP.ifError()?TP.error(TP.hc('object',e,'message','WebSocket request exception.'),TP.IO_LOG,arguments):0;}TP.raise(b,d,arguments,a);if(!TP.sys.shouldThrowExceptions()){throw e;}TP.uc(b).set('webSocketObj',null);return;});TP.definePrimitive('$webSocketTimeout',function(f,g,d){var a,e,b,c;TP.webSocketAbort(d);a=TP.request(g);a.atPut('wsObj',d);d.status=TP.FAILURE;a.atPut('direction',TP.RECV);a.atPut('object',new Error('Timeout'));a.atPut('message','WebSocket request failed: Timeout');TP.webSocketError(f,'WebSocketSendException',arguments,a);if(TP.notValid(e=TP.sys.getTypeByName('TP.sig.WebSocketResponse',false))){if(TP.notValid(e=TP.sys.getTypeByName('TP.sig.Response',false))){return;}}b=e.construct(a);c=a.getRequestID();b.setSignalName('TP.sig.IOTimeout');b.fire(c);b.setSignalName('TP.sig.IOFailed');b.fire(c);b.setSignalName('TP.sig.IOCompleted');b.fire(c);return;});TP.definePrimitive('$webSocketWrapup',function(f,g,c){var a,h,d,b,e;TP.debug('break.websocket_wrapup');a=TP.request(g);h=TP.ifInvalid(f,a.at('uri'));a.atPut('wsObj',c);c.status=TP.SUCCESS;a.getResponse().set('responseData',c.responseData);a.getResponse().set('statusCode',TP.SUCCESS);a.getResponse().set('statusText',TP.sc('Ok'));if(TP.notValid(d=TP.sys.getTypeByName('TP.sig.WebSocketResponse',false))){if(TP.notValid(d=TP.sys.getTypeByName('TP.sig.Response',false))){return;}}b=d.construct(a);e=a.getRequestID();b.setSignalName('TP.sig.IOSucceeded');b.fire(e);b.setSignalName('TP.sig.IOCompleted');b.fire(e);return;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETURIPrimitivesPre.js';
TP.definePrimitive('uriCollapsePath',function(c){var a,d,b;if(!TP.isString(c)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}a=c.replace(/\\/g,'/');if(a!==c){d=true;}if(!TP.regex.HAS_PATH_OFFSET.test(a)){return c;}while(TP.regex.HAS_PATH_OFFSET.test(a)){b=a.strip(TP.regex.REMOVE_PATH_OFFSET);if(b===a){break;}a=b;}while(TP.regex.HAS_PATH_NOOP.test(a)){b=a.strip(TP.regex.REMOVE_PATH_NOOP);if(b===a){break;}a=b;}if(d){a=a.replace(/\//g,'\\');}return a;});TP.definePrimitive('uriCollectionPath',function(b){var a,c,d;if(!TP.isString(b)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}a=b;if(/\\/.test(b)){d='\\';}else{d='/';}c=a.lastIndexOf(d);if(c!==TP.NOT_FOUND){a=a.slice(0,c);}return a;});TP.definePrimitive('uriExpandPath',function(e){var a,d,f,b,c;TP.debug('break.uri_virtual');if(TP.isEmpty(e)){return'';}if(e==='/'){return TP.sys.getLaunchRoot();}a=TP.str(e);if(a.indexOf('/')===0){return TP.sys.getLaunchRoot()+a;}c=a.replace('tibet:///~','~');if(c.indexOf('~')!==0){return c;}a=c;if(a==='~'){return TP.sys.getAppHead();}else if(a==='~app'){return TP.sys.getAppRoot();}else if(a==='~lib'){return TP.sys.getLibRoot();}else if(a.indexOf('~/')===0){a=TP.uriJoinPaths(TP.sys.getAppHead(),a.slice(2));}else if(a.indexOf('~app/')===0){a=TP.uriJoinPaths(TP.sys.getAppRoot(),a.slice(5));}else if(a.indexOf('~lib/')===0){a=TP.uriJoinPaths(TP.sys.getLibRoot(),a.slice(5));}else{d=a.match(/~([^\/]*)\/(.*)/);if(TP.notValid(d)){d=a.match(/~([^\/]*)/);}if(d){f=d.at(1);if(TP.isString(b=TP.sys.cfg('path.'+f))){if(b.indexOf('/')===0){b=b.slice(1);}if(b.last()==='/'){b=b.slice(0,-1);}a=c.replace('~'+f,b);}}}if(a!==c&&a.indexOf('~')===0){return TP.boot.$uriExpandPath(a);}return a;});TP.definePrimitive('uriGetXPointerData',function(j,f,l){var a,g,i,h,c,d,e,b,k;if(!TP.isString(j)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}if(TP.notValid(f)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isNode(f)){c=f;}else if(TP.canInvoke(f,'getNativeNode')){c=f.getNativeNode();}else{return TP.raise(this,'TP.sig.InvalidNode',arguments);}h=TP.ifInvalid(l,true);g=j.asString().split('#');switch(g.getSize()){case 1:if(h){a=TP.ac(TP.nodeCloneNode(c,true));}else{a=TP.ac(c);}d=a.collect(function(a){if(TP.isDocument(a)){return a.documentElement;}return a;});return d;case 2:e=g.at(1);break;default:g.shift();e=g.join('#');break;}if(TP.notValid(i=e.match(TP.regex.XPOINTER))){if(e==='document'){if(TP.isDocument(c)){a=c.documentElement;}}else{a=TP.nodeGetElementById(c,e,true);}a=TP.ac(a);}else{b=i.at(2);if(TP.notEmpty(b)){if(TP.notEmpty(k=e.match(TP.regex.ID_POINTER))){b=k.at(1).unquoted();a=TP.nodeGetElementById(c,b,true);a=TP.ac(a);}else{b=b.unquoted();if(TP.regex.XPATH_HAS_ID.test(b)){d=b.match(TP.regex.XPATH_HAS_ID);b=b.replace(d.first(),'*[@id="'+d.last().unquoted()+'"]');}a=TP.nodeEvaluateXPath(c,b,TP.NODESET);}}else{return TP.ac();}}if(TP.isEmpty(a)){return a;}if(h){d=a.collect(function(a){return TP.nodeCloneNode(a,true);});return d;}else{return a;}});TP.definePrimitive('uriInLocalFormat',function(b){var a;if(!TP.isString(b)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}if(TP.boot.isWin()&&(TP.regex.WINDOWS_PATH.test(b)||TP.regex.UNC_PATH.test(b))||TP.regex.ROOT_PATH.test(b)){return unescape(b);}a=TP.uriExpandPath(b);if(a.indexOf('file:')!==0){return unescape(b);}a=unescape(TP.uriMinusFileScheme(a));if(!TP.boot.isWin()){return a;}a=a.replace(/\//g,'\\');if(TP.regex.WINDOWS_PATH.test(a)||TP.regex.UNC_PATH.test(a)){return a;}return unescape(TP.uriMinusFileScheme(b));});TP.definePrimitive('uriInWebFormat',function(a,c){var b;if(TP.isEmpty(a)){return a;}if(TP.regex.HAS_SCHEME.test(a)&&!TP.regex.TIBET_SCHEME.test(a)){return a;}if(TP.regex.WINDOWS_PATH.test(a)||TP.regex.UNC_PATH.test(a)){b=a.replace(/\\\\/g,'/').replace(/\\/g,'/');return TP.uriPlusFileScheme(b.unquoted());}b=TP.uriExpandPath(a);if(b!==a){return b;}return TP.uriPlusFileScheme(TP.uriWithRoot(a,c));});TP.definePrimitive('uriIsAbsolute',function(b){var a;if(TP.isEmpty(b)){return false;}a=TP.uriExpandPath(b);if(TP.regex.VIRTUAL_URI_PREFIX.test(a)||TP.regex.HAS_SCHEME.test(a)){return true;}if(TP.boot.isWin()){return TP.regex.WINDOWS_PATH.test(a)||TP.regex.UNC_PATH.test(a);}else{return a.first()==='/';}});TP.definePrimitive('uriIsVirtual',function(a){if(TP.isEmpty(a)){return false;}return a.indexOf('~')===0||a.indexOf('tibet:')===0||a.indexOf('urn:')===0;});TP.definePrimitive('uriJoinPaths',function(d,e){var f,g,a,b,c;TP.debug('break.uri_resolve');if(arguments.length>2){c=arguments[0];for(f=1;f<arguments.length;f++){c=TP.uriJoinPaths(c,arguments[f]);}return c;}if(TP.isEmpty(d)){return e;}if(TP.isEmpty(e)){return d;}if(TP.uriIsAbsolute(e)){return e;}if(d.indexOf('about:blank')===0){a=d.slice('about:blank'.getSize());}else{a=d;}if(a.indexOf('~')===0){c=TP.uriExpandPath(a);if(c!==d){return TP.uriJoinPaths(c,e);}}b=e;if(b.indexOf('/Volumes')===0){if(a.indexOf(b)!==TP.NOT_FOUND){return a;}if(b.indexOf(a)!==TP.NOT_FOUND){return b;}if(a.indexOf(TP.uriPlusFileScheme(b))){return a;}if(b.indexOf(TP.uriPlusFileScheme(a))!==TP.NOT_FOUND){return b;}if(TP.uriPlusFileScheme(a).indexOf(b)!==TP.NOT_FOUND){return TP.uriPlusFileScheme(a);}if(TP.uriPlusFileScheme(b).indexOf(a)!==TP.NOT_FOUND){return TP.uriPlusFileScheme(b);}return TP.uriPlusFileScheme(b);}if(b.indexOf('./')===0){b=b.slice(1);}if(a.charAt(a.getSize()-1)==='/'){if(a.lastIndexOf('//')===a.getSize()-2){a=a.slice(0,a.getSize()-2);}else{a=a.slice(0,a.getSize()-1);}}while(b.indexOf('../')===0){b=b.slice(3,b.getSize());a=a.slice(0,a.lastIndexOf('/'));}if(b.charAt(0)!=='/'){g=a+'/'+b;}else{g=a+b;}return g;});TP.definePrimitive('uriJoinQuery',function(d,b){var a,e,c,f,g;if(!TP.isString(d)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}if(TP.isEmpty(b)){return d;}a=d;e=TP.isString(b)?b:b.asQueryString();c='';if(TP.regex.URI_FRAGMENT.test(a)){f=a.split('#');a=f.first();c=f.last();}g=/\?/.test(a)?'&':'?';if(TP.notEmpty(c)){return a+g+e+'#'+c;}else{return a+g+e;}});TP.definePrimitive('uriMinusFileScheme',function(b){var a;if(!TP.isString(b)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}if(b.toLowerCase().indexOf('file:')!==0){return b;}a=b.slice('file://'.length);if(TP.boot.isWin()&&/^\/\w:/.test(a)){a=a.slice(1);}return a;});TP.definePrimitive('uriNeedsPrivileges',function(a){if(!TP.isString(a)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}return a.indexOf(TP.sys.getLaunchRoot())!==0;});TP.definePrimitive('uriPlusFileScheme',function(a){var c,b;if(!TP.isString(a)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}if(a.toLowerCase().indexOf('file:')===0){return a;}c='file://';if(TP.boot.isWin()&&/^\w:/.test(a)){c=c+'/';}b=c+a;if(/file:\/\/\/\//.test(b)){b=b.replace(/file:\/\//,'file:');}return b;});TP.definePrimitive('uriRelativeToPath',function(g,j,l){var i,b,a,e,c,h,f,d,k;TP.debug('break.uri_resolve');if(TP.isEmpty(g)){return;}if(TP.isEmpty(j)){return g;}if(g===j){return'.';}b=TP.uriCollapsePath(TP.uriExpandPath(g));a=TP.uriCollapsePath(TP.uriExpandPath(j));if(b.length>1&&b.lastIndexOf('/')===b.length-1){b=b.slice(0,-1);}if(TP.isTrue(l)){if((f=a.lastIndexOf('/'))!==TP.NOT_FOUND){if(a.lastIndexOf('/')===a.length-1){a=a.slice(0,-1);a=a.slice(0,a.lastIndexOf('/'));}else{a=a.slice(0,a.lastIndexOf('/'));}}else{if(TP.regex.FILE_PATH.test(g)){return'.'+b.slice(b.lastIndexOf('/'));}else{return'.';}}}else if(TP.isFalse(l)){if(a.lastIndexOf('/')===a.length-1){a=a.slice(0,-1);}}else{if(a.lastIndexOf('/')===a.length-1){i=false;a=a.slice(0,-1);}else{if(TP.regex.FILE_PATH.test(a)){i=true;a=a.slice(0,a.lastIndexOf('/'));}else{i=false;}}}if(TP.isEmpty(b)){return;}if(TP.isEmpty(a)){return b;}if(b===a){return'.';}if(a.indexOf(b)!==TP.NOT_FOUND){c=a.strip(b);if(c.indexOf('/')===0){c=c.slice(1);}c=c.split('/');for(d=0;d<c.length;d++){c[d]='..';}return c.join('/');}if((c=b.replace(a,'.'))!==b){if(c.indexOf('./')===0){return c;}}if(b.indexOf('.')===0){if(i){if(b.indexOf('./')===0){return'../'+b.slice(2);}else{return'../'+b;}}return b;}if((f=a.indexOf(b))!==TP.NOT_FOUND){k=a.slice(f).strip(b);h=k.split('/').length;e='';for(d=0;d<h;d++){e=e+'../';}return e+b;}h=0;f=a.lastIndexOf('/');while(f!==-1){a=a.slice(0,f);if((c=b.replace(a,'..'))!==b){if(c.indexOf('../')===0){e='';for(d=0;d<h;d++){e=e+'../';}return e+c;}}h++;f=a.lastIndexOf('/');}return b;});TP.definePrimitive('uriResolvePaths',function(e,d,h){var f,b,a,c,g;if(TP.isEmpty(d)){if(TP.isEmpty(e)){return decodeURI(window.location.toString());}else{a=TP.str(e);if(TP.uriIsAbsolute(a)){return TP.regex.VIRTUAL_URI_PREFIX.test(a)?'tibet:///'+a:a;}if(a.indexOf('//')===0){b=TP.sys.getScheme();return b.last()===':'?b+a:b+':'+a;}else if(a.indexOf('/')===0){return TP.uriJoinPaths(TP.sys.getLaunchRoot(),a.slice(1));}return TP.uriJoinPaths(TP.sys.getAppRoot(),a);}}else{if(TP.uriIsAbsolute(d)){return TP.regex.VIRTUAL_URI_PREFIX.test(d)?'tibet:///'+d:d;}c=TP.str(d);if(c.indexOf('//')===0){b=TP.sys.getScheme();return b.last()===':'?b+c:b+':'+c;}else if(c.indexOf('/')===0){return TP.uriJoinPaths(TP.sys.getLaunchRoot(),c.slice(1));}if(TP.isEmpty(e)){return TP.uriJoinPaths(TP.sys.getAppRoot(),c);}else{a=TP.str(e);if(a.indexOf('~')===0){if(TP.isType(g=TP.sys.getTypeByName('TP.core.TIBETURL'))){if(TP.isValid(f=g.construct('tibet:///'+a))){if(TP.isURI(f=f.getPrimaryURI())){a=f.getLocation();}}}else{a=TP.uriExpandPath(a);}if(TP.isEmpty(a)||a.indexOf('~')===0){return TP.raise(this,'TP.sig.InvalidURI',arguments,'First URI must resolve to absolute path.');}}else if(a.indexOf('//')===0){b=TP.sys.getScheme();a=b.last()===':'?b+a:b+':'+a;}else if(a.indexOf('/')===0){a=TP.uriJoinPaths(TP.sys.getLaunchRoot(),a.slice(1));}c=TP.uriRelativeToPath(c,a,h);return TP.uriJoinPaths(a,c);}}return;});TP.definePrimitive('uriResolveVirtualPath',function(e,k){var f,b,a,g,c,i,d,j,h;TP.debug('break.uri_virtual');if(!TP.isString(e)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}f=e;if(!TP.regex.TIBET_URI.test(e)){return e;}g='';if(f.indexOf('tibet:')===0){b=f.match(TP.regex.TIBET_URI_SPLITTER);if(TP.isArray(b)){a=b.at(5);if(TP.isEmpty(a)){return e;}g=TP.ifInvalid(b.at(6),'');}else{return e;}}else{a=f;}if(a==='~app'){return TP.sys.getAppRoot();}else if(a==='~lib'){return TP.sys.getLibRoot();}else if(a==='~'){return TP.sys.getAppHead();}else if(a==='/'){return TP.sys.getLaunchRoot();}else if(a.indexOf('~app/')===0){c=a.match(/~app\/(.*)/);a=TP.uriJoinPaths(TP.sys.getAppRoot(),c.last());}else if(a.indexOf('~lib/')===0){c=a.match(/~lib\/(.*)/);a=TP.uriJoinPaths(TP.sys.getLibRoot(),c.last());}else if(a.indexOf('~/')===0){c=a.match(/~\/(.*)/);a=TP.uriJoinPaths(TP.sys.getAppHead(),c.last());}else if(a.indexOf('~')===0){c=a.match(/~([^\/]*)\/(.*)/);if(TP.notValid(c)){c=a.match(/~([^\/]*)/);if(TP.notValid(c)){return a+g;}}i=c.at(1);if(TP.isString(d=TP.sys.cfg('path.'+i))){if(d.indexOf('/')===0){d=d.slice(1);}if(d.last()==='/'){d=d.slice(0,-1);}a=e.replace('~'+i,d);if(a!==e){return TP.uriResolveVirtualPath(a);}}else if(TP.isType(j=TP.sys.getTypeByName(i))){d=TP.objectGetLoadCollectionPath(j);a=e.replace('~'+i,d);if(a!==e){return TP.uriResolveVirtualPath(a);}}}else if(a.indexOf('javascript:')===0){if(TP.isArray(b)){h=TP.ifInvalid(b.at(3),'');}else{h='';}if(a.indexOf('javascript:'+h)!==0&&h!==TP.gid(window).strip(/tibet:\/\//)){a=a.replace('javascript:','javascript:'+h+'.');}}if(TP.notTrue(k)&&f.indexOf('tibet:')===0){b=f.match(TP.regex.TIBET_URI_SPLITTER);if(TP.isArray(b)&&TP.notEmpty(b.at(3))){return'tibet:'+b.at(1)+'/'+b.at(2)+'/'+b.at(3)+'/'+a+g;}}return a+g;});TP.definePrimitive('uriResult',function(a,c,d){var b,e;if(TP.isEmpty(a)){return null;}if(c===TP.TEXT){return a;}try{e=TP.htmlEntitiesToXmlEntities(a);b=TP.documentFromString(e,null,d);}catch(b){if(TP.notFalse(d)){TP.raise(this,'TP.sig.DOMParseException',arguments,TP.ec(b,TP.join('Unable to parse: ',a)));}if(c!==TP.DOM){return a;}return null;}if(TP.isDocument(b)&&b.childNodes.length>0){return b;}if(c!==TP.DOM){return a;}return null;});TP.definePrimitive('uriResultType',function(a,b){if(!TP.isString(a)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}if(!TP.isRegExp(TP.regex.XML_EXTENSIONS)){TP.regex.XML_EXTENSIONS=TP.regExpConstruct(TP.XML_EXTENSIONS,'\\.','$');}if(TP.isRegExp(TP.regex.XML_EXTENSIONS)){if(TP.regex.XML_EXTENSIONS.test(a)){return TP.DOM;}}else if(/\.xml$|\.xhtml$|\.tsh$|\.xsl$|\.xsd$/.test(a)){return TP.DOM;}if(/\.js$|\.css$|\.html$|\.txt$|\.json$/.test(a)){return TP.TEXT;}return b;});TP.definePrimitive('uriExtension',function(c,e){var b,a,d;if(!TP.isString(c)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}b=TP.uriName(c);d=TP.ifInvalid(e,'.');a=b.lastIndexOf(d);if(a===TP.NOT_FOUND||a===0){return'';}else{return b.slice(a+1);}});TP.definePrimitive('uriName',function(a){var b,c;if(!TP.isString(a)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}if(/\\/.test(a)){b='\\';}else{b='/';}c=a.lastIndexOf(b);if(c!==TP.NOT_FOUND){return a.slice(c+1);}return a;});TP.sys.defineMethod('getAppHead',function(){return TP.boot.$getAppHead();});TP.sys.defineMethod('getAppRoot',function(){return TP.boot.$getAppRoot();});TP.sys.defineMethod('getLibRoot',function(){return TP.boot.$getLibRoot();});TP.definePrimitive('uriWithRoot',function(a,d){var c,b;if(!TP.isString(a)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}if(TP.uriIsAbsolute(a)){b=TP.uriResolvePaths(a);}else{c=TP.ifInvalid(d,TP.sys.getLaunchRoot());b=TP.uriResolvePaths(c,a);}return TP.uriExpandPath(b);});TP.sys.defineMethod('fileWithRoot',TP.uriWithRoot.copy());TP.definePrimitive('uriTempFileName',function(f,g,h){var a,b,c,d,e;a=TP.uriInWebFormat(TP.ifEmpty(f,TP.sys.cfg('path.app_tmp')));b=TP.ifInvalid(g,'');c=TP.ifInvalid(h,'tmp');try{d=TP.OID_PREFIX;TP.OID_PREFIX='_';e=TP.uriJoinPaths(a,TP.join(TP.genID(b),'.',c));}catch(a){}finally{TP.OID_PREFIX=d;}return e;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETURIPrimitivesBase.js';

TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETURIPrimitivesPlatform.js';
TP.definePrimitive('$fileIsDirectory',TP.hc('test','trident','true',function(f,i){var d,b,a,e,c,g,h;if(!TP.isString(f)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}d=TP.uriExpandPath(f);c=TP.request(i);if(TP.regex.HTTP_SCHEME.test(d.toLowerCase())){a=TP.sc('Local directory checks not supported for HTTP URI ',d);TP.raise(this,'TP.sig.UnsupportedFeature',arguments,a);c.fail(TP.FAILURE,a);return false;}b=TP.uriInLocalFormat(d);g=TP.executePrivileged(TP.HOST_FILE_ACCESS,TP.sc('This TIBET-based application would like to check for existence: ',b),TP.sc('This TIBET-based application cannot check for existence: ',b),false,function(){h=new ActiveXObject('Scripting.FileSystemObject');});if(g){e=h.FolderExists(b);c.complete(e);return e;}else{a=TP.sc('Unable to access ',b,' msg: Couldn\'t create "Scripting.FileSystemObject"');TP.raise(this,'TP.sig.URIException',arguments,a);c.fail(TP.FAILURE,a);return false;}c.complete(false);return false;},TP.DEFAULT,function(a,b){return;}));TP.definePrimitive('$fileDelete',TP.hc('test',TP.boot.getBrowser,'firefox',function(e,g){var a,f,d,b,c;if(!TP.isString(e)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}a=TP.uriExpandPath(e);c=TP.request(g);f=TP.ifKeyInvalid(c,'reportErrors',false);if(TP.regex.HTTP_SCHEME.test(a.toLowerCase())){d=TP.sc('Local file deletion not supported for HTTP URI ',a);TP.raise(this,'TP.sig.InvalidOperation',arguments,d);c.fail(TP.FAILURE,d);return false;}b=false;TP.executePrivileged(TP.HOST_FILE_DELETE,TP.sc('This TIBET-based application would like to delete file: ',a),TP.sc('This TIBET-based application cannot delete file: ',a),false,function(){var d,g,h,e;d=TP.uriInLocalFormat(a);try{g=new Components.Constructor('@mozilla.org/file/local;1','nsILocalFile','initWithPath');h=new g(d);h.remove(false);}catch(a){e=TP.sc('Unable to delete ',d);if(f){TP.raise(this,'TP.sig.URIException',arguments,TP.ec(a,e));}b=false;c.fail(TP.FAILURE,e);return;}b=true;c.complete(b);return;});return b;},'ie',function(e,h){var d,i,b,a,c,f,g;if(!TP.isString(e)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}d=TP.uriExpandPath(e);c=TP.request(h);i=TP.ifKeyInvalid(c,'reportErrors',false);if(TP.regex.HTTP_SCHEME.test(d.toLowerCase())){a=TP.sc('Local file deletion not supported for HTTP URI ',d);TP.raise(this,'TP.sig.InvalidOperation',arguments,a);c.fail(TP.FAILURE,a);return false;}b=TP.uriInLocalFormat(d);f=TP.executePrivileged(TP.HOST_FILE_DELETE,TP.sc('This TIBET-based application would like to delete file: ',b),TP.sc('This TIBET-based application cannot delete file: ',b),false,function(){g=new ActiveXObject('Scripting.FileSystemObject');});if(f){g.deleteFile(b);}else{a=TP.sc('Unable to delete ',b,' msg: Couldn\'t create "Scripting.FileSystemObject"');TP.raise(this,'TP.sig.URIException',arguments,a);c.fail(TP.FAILURE,a);return false;}c.complete(true);return true;},'safari',function(c,b){var a;a=TP.request(b);TP.raise(this,'TP.sig.UnsupportedOperation',arguments);a.fail(TP.FAILURE,'Unsupported operation.');return false;},'chrome',function(c,b){var a;a=TP.request(b);TP.raise(this,'TP.sig.UnsupportedOperation',arguments);a.fail(TP.FAILURE,'Unsupported operation.');return false;}));TP.definePrimitive('$fileExists',TP.hc('test',TP.boot.getBrowser,'firefox',function(d,e){var c,b,a;if(!TP.isString(d)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}c=TP.uriExpandPath(d);a=TP.request(e);try{b=TP.httpCreate(c);if(TP.canInvoke(a,'atPut')){a.atPut('xhr',b);}b.open(TP.HTTP_GET,c,false);b.send(null);}catch(b){a.fail(TP.FAILURE,TP.str(b));return false;}a.complete(true);return true;},'ie',function(h,j){var d,a,c,b,e,i,f,g;if(!TP.isString(h)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}d=TP.uriExpandPath(h);a=TP.request(j);try{if(d.last()!=='/'){b=d;try{e=TP.httpCreate(d);if(TP.canInvoke(a,'atPut')){a.atPut('xhr',e);}e.open(TP.HTTP_GET,d,false);e.send(null);}catch(b){if(/cannot locate/.test(TP.str(b))){a.complete(false);return false;}if(/System error: -2146697211/.test(TP.str(b))&&(e.status===2||e.status===3)){a.complete(false);return false;}}a.complete(true);return true;}else{b=TP.uriInLocalFormat(d);i=TP.executePrivileged(TP.HOST_FILE_ACCESS,TP.sc('This TIBET-based application would like to check for existence of: ',b),TP.sc('This TIBET-based application cannot check for existence of: ',b),false,function(){g=new ActiveXObject('Scripting.FileSystemObject');});if(i){if(TP.$fileIsDirectory(b,a)){f=g.FolderExists(b);}else{f=g.FileExists(b);}a.complete(f);return f;}else{c=TP.sc('Unable to access: ',b);TP.raise(this,'TP.sig.URIException',arguments,c);a.fail(TP.FAILURE,c);}}}catch(d){c=TP.sc('Unable to access: ',b);TP.raise(this,'TP.sig.URIException',arguments,c);a.fail(TP.FAILURE,c);}return false;},'safari',function(d,e){var c,a,b;if(!TP.isString(d)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}c=TP.uriExpandPath(d);a=TP.request(e);try{b=TP.httpCreate(c);if(TP.canInvoke(a,'atPut')){a.atPut('xhr',b);}b.open(TP.HTTP_GET,c,false);b.send(null);}catch(b){a.fail(TP.FAILURE,TP.str(b));return false;}if(b.status===404){a.complete(false);return false;}if(TP.boot.isWin()&&b.status===-1100){a.complete(false);return false;}if(TP.boot.isMac()&&(b.status===-1100||b.status===400)){a.complete(false);return false;}if(TP.boot.isWin()&&b.status===1789378560){a.complete(false);return false;}a.complete(true);return true;},'chrome',function(d,e){var c,a,b;if(!TP.isString(d)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}c=TP.uriExpandPath(d);a=TP.request(e);try{b=TP.httpCreate(c);if(TP.canInvoke(a,'atPut')){a.atPut('xhr',b);}b.open(TP.HTTP_GET,c,false);b.send(null);}catch(b){a.fail(TP.FAILURE,TP.str(b));return false;}if(b.status===0&&b.responseText===''){a.complete(false);return false;}a.complete(true);return true;}));TP.definePrimitive('$fileLoad',TP.hc('test',TP.boot.getBrowser,'firefox',function(n,q){var c,a,j,h,p,d,b,l,i,m,g,f,o,e,k;if(!TP.isString(n)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}a=TP.uriExpandPath(n);if(/#/.test(a)){a=a.slice(0,a.indexOf('#'));}c=TP.request(q);h=TP.ifKeyInvalid(c,'resultType',null);h=TP.uriResultType(a,h);p=TP.ifKeyInvalid(c,'shouldReport',false);if(TP.sys.cfg('boot.moz_xpcom')){try{TP.ifInfo(TP.sys.cfg('log.privilege_requests'))?TP.info('Privilege request at TP.$fileLoad',TP.LOG,arguments):0;netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');}catch(d){b=TP.sc('PrivilegeError. url: ',a);TP.raise(this,'TP.sig.PrivilegeViolation',arguments,TP.ec(d,b));c.fail(TP.FAILURE,b);return;}try{l=new Components.Constructor('@mozilla.org/file/local;1','nsILocalFile','initWithPath');i=Components.classes['@mozilla.org/network/io-service;1'].getService(Components.interfaces.nsIIOService);m=new Components.Constructor('@mozilla.org/scriptableinputstream;1','nsIScriptableInputStream');}catch(d){b=TP.sc('FileComponentError. url: ',a);TP.raise(this,'TP.sig.IOException',arguments,TP.ec(d,b));c.fail(TP.FAILURE,b);return;}f=TP.uriMinusFileScheme(TP.uriInLocalFormat(a));f=unescape(f);try{g=new l(f);if(g.exists()){o=i.newChannelFromURI(i.newFileURI(g));e=new m();e.init(o.open());j=e.read(g.fileSize);e.close();}}catch(d){b=TP.sc('AccessViolation. url: ',a);TP.raise(this,'TP.sig.PrivilegeViolation',arguments,TP.ec(d,b));c.fail(TP.FAILURE,b);return;}}else{try{d=TP.httpCreate(a);if(TP.canInvoke(c,'atPut')){c.atPut('xhr',d);}d.open(TP.HTTP_GET,a,false);d.send(null);j=d.responseText;}catch(d){b=TP.sc('Unable to locate: ',a);TP.ifInfo()?TP.info(b,TP.LOG,arguments):0;c.fail(TP.FAILURE,b);return null;}}k=TP.uriResult(j,h,p);c.complete(k);return k;},'ie',function(l,n){var c,a,f,k,b,e,g,d,m,h,i,j;if(!TP.isString(l)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}b=TP.uriExpandPath(l);if(/#/.test(b)){b=b.slice(0,b.indexOf('#'));}c=TP.request(n);f=TP.ifKeyInvalid(c,'resultType',null);f=TP.uriResultType(b,f);k=TP.ifKeyInvalid(c,'shouldReport',false);try{e=TP.httpCreate(b);if(TP.canInvoke(c,'atPut')){c.atPut('xhr',e);}e.open(TP.HTTP_GET,b,false);e.send(null);g=e.responseText;}catch(f){if(/cannot locate/.test(TP.str(f))){a=TP.sc('Unable to locate: ',b);TP.ifInfo()?TP.info(a,TP.LOG,arguments):0;c.fail(TP.FAILURE,a);return;}if(/System error: -2146697211/.test(TP.str(f))&&(e.status===2||e.status===3)){a=TP.sc('Unable to locate: ',b);TP.ifInfo()?TP.info(a,TP.LOG,arguments):0;c.fail(TP.FAILURE,a);return;}d=TP.uriInLocalFormat(b);m=TP.executePrivileged(TP.HOST_FILE_ACCESS,TP.sc('This TIBET-based application would like to check for existence of: ',d),TP.sc('This TIBET-based application cannot check for existence of: ',d),false,function(){i=new ActiveXObject('Scripting.FileSystemObject');});if(m){try{h=i.OpenTextFile(d,TP.IE_READ);g=h.ReadAll();h.Close();}catch(b){try{if(!i.FileExists(d)){a=TP.sc('Unable to locate: ',d);TP.ifInfo()?TP.info(a,TP.LOG,arguments):0;c.fail(TP.FAILURE,a);return;}}catch(a){}a=TP.sc('Unable to access: ',d);TP.raise(this,'TP.sig.URIException',arguments,TP.ec(b,a));c.fail(TP.FAILURE,a);return;}}else{a=TP.sc('Unable to access: ',d);TP.raise(this,'TP.sig.URIException',arguments,TP.ec(f,a));c.fail(TP.FAILURE,a);return;}}j=TP.uriResult(g,f,k);c.complete(j);return j;},'safari',function(g,j){var b,c,a,h,e,i,d,f;if(!TP.isString(g)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}b=TP.uriExpandPath(g);if(/#/.test(b)){b=b.slice(0,b.indexOf('#'));}c=TP.request(j);e=TP.ifKeyInvalid(c,'resultType',null);e=TP.uriResultType(b,e);i=TP.ifKeyInvalid(c,'shouldReport',false);try{d=TP.httpCreate(b);if(TP.canInvoke(c,'atPut')){c.atPut('xhr',d);}d.open(TP.HTTP_GET,b,false);d.send(null);h=d.responseText;}catch(d){a=TP.sc('Unable to locate: ',b);TP.ifInfo()?TP.info(a,TP.LOG,arguments):0;c.fail(TP.FAILURE,a);return;}if(d.status===404){a=TP.sc('Unable to locate: ',b);TP.ifInfo()?TP.info(a,TP.LOG,arguments):0;c.fail(TP.FAILURE,a);return;}if(TP.boot.isWin()&&d.status===-1100){a=TP.sc('Unable to locate: ',b);TP.ifInfo()?TP.info(a,TP.LOG,arguments):0;c.fail(TP.FAILURE,a);return;}if(TP.boot.isMac()&&(d.status===-1100||d.status===400)){a=TP.sc('Unable to locate: ',b);TP.ifInfo()?TP.info(a,TP.LOG,arguments):0;c.fail(TP.FAILURE,a);return;}if(TP.boot.isWin()&&d.status===1789378560){a=TP.sc('Unable to locate: ',b);TP.ifInfo()?TP.info(a,TP.LOG,arguments):0;c.fail(TP.FAILURE,a);return;}f=TP.uriResult(h,e,i);c.complete(f);return f;},'chrome',function(h,j){var a,b,d,g,e,i,c,f;if(!TP.isString(h)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}a=TP.uriExpandPath(h);if(/#/.test(a)){a=a.slice(0,a.indexOf('#'));}b=TP.request(j);e=TP.ifKeyInvalid(b,'resultType',null);e=TP.uriResultType(a,e);i=TP.ifKeyInvalid(b,'shouldReport',false);try{c=TP.httpCreate(a);if(TP.canInvoke(b,'atPut')){b.atPut('xhr',c);}c.open(TP.HTTP_GET,a,false);c.send(null);g=c.responseText;}catch(c){d=TP.sc('Unable to locate: ',a);TP.ifInfo()?TP.info(d,TP.LOG,arguments):0;b.fail(TP.FAILURE,d);return;}if(c.status===0&&c.responseText===''){d=TP.sc('Unable to locate: ',a);TP.ifInfo()?TP.info(d,TP.LOG,arguments):0;b.fail(TP.FAILURE,d);return;}f=TP.uriResult(g,e,i);b.complete(f);return f;}));TP.definePrimitive('$fileSave',TP.hc('test',TP.boot.getBrowser,'firefox',function(h,j){var c,e,b,i,f,d,g,a;if(!TP.isString(h)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}c=TP.uriExpandPath(h);e=TP.uriInLocalFormat(h);b=TP.request(j);i=TP.ifKeyInvalid(b,'append',false);f=i?TP.APPEND:TP.WRITE;g=TP.ifKeyInvalid(b,'permissions',420);a=false;TP.executePrivileged(TP.HOST_FILE_SAVE,TP.sc('This TIBET-based application would like to save file: ',c),TP.sc('This TIBET-based application cannot save file: ',c),false,function(){var l,h,m,j,n,k,i;try{l=new Components.Constructor('@mozilla.org/file/local;1','nsILocalFile','initWithPath');h=Components.classes['@mozilla.org/network/file-output-stream;1'].createInstance(Components.interfaces.nsIFileOutputStream);}catch(d){i=TP.sc('Unable to get component(s) for: ',c);TP.raise(this,'TP.sig.URIException',arguments,TP.ec(d,i));a=false;b.fail(TP.FAILURE,i);return a;}try{j=new l(e);m=TP.ifKeyInvalid(b,'backup',true);if(m&&j.exists()){try{n=TP.$fileLoad(c);TP.$fileSave(c+'~',TP.request('body',n,'backup',false));}catch(d){i=TP.sc('Terminated save.',' Unable to create backup copy of: ',c);TP.raise(this,'TP.sig.URIException',arguments,TP.ec(d,i));a=false;b.fail(TP.FAILURE,i);return a;}}d=TP.ifKeyInvalid(b,'body','');if(f===TP.WRITE){k=TP.MOZ_FILE_CREATE|TP.MOZ_FILE_TRUNCATE|TP.MOZ_FILE_WRONLY;h.init(j,k,g,null);h.write(d,d.getSize());h.flush();h.close();a=true;b.complete(a);return a;}else if(f===TP.APPEND){if(j.exists()){k=TP.MOZ_FILE_APPEND|TP.MOZ_FILE_SYNC|TP.MOZ_FILE_RDWR;h.init(j,k,g,null);h.write(d,d.getSize());h.flush();h.close();a=true;b.complete(a);return a;}else{k=TP.MOZ_FILE_CREATE|TP.MOZ_FILE_TRUNCATE|TP.MOZ_FILE_WRONLY;h.init(j,k,g,null);h.write(d,d.getSize());h.flush();h.close();a=true;b.complete(a);return a;}}else{i=TP.sc('Invalid file save mode ',f,' for ',e);TP.raise(this,'InvalidMode',arguments,i);b.fail(TP.FAILURE,i);}}catch(a){i=TP.sc('Unable to access: ',e);TP.raise(this,'AccessViolation',arguments,TP.ec(a,i));b.fail(TP.FAILURE,i);}a=false;return a;});return a;},'ie',function(j,o){var d,b,a,g,l,n,c,k,e,h,f,m,i;if(!TP.isString(j)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}d=TP.uriExpandPath(j);a=TP.uriInLocalFormat(j);b=TP.request(o);l=TP.ifKeyInvalid(b,'append',false);g=l?TP.APPEND:TP.WRITE;n=TP.executePrivileged(TP.HOST_FILE_SAVE,TP.sc('This TIBET-based application would like to save file: ',d),TP.sc('This TIBET-based application cannot save file: ',d),false,function(){c=new ActiveXObject('Scripting.FileSystemObject');});if(n){k=TP.ifKeyInvalid(b,'backup',true);if(k&&c.FileExists(a)){try{m=TP.$fileLoad(d);TP.$fileSave(d+'~',TP.request('body',m,'backup',false));}catch(a){e=TP.sc('Terminated save.',' Unable to create backup copy of: ',d);TP.raise(this,'TP.sig.URIException',arguments,TP.ec(a,e));b.fail(TP.FAILURE,e);return false;}}i=TP.ifKeyInvalid(b,'body','');if(g===TP.WRITE){if(!c.FileExists(a)){c.CreateTextFile(a);}h=c.GetFile(a);f=h.OpenAsTextStream(TP.IE_WRITE);f.Write(i);f.Close();b.complete(true);return true;}else if(g===TP.APPEND){if(!c.FileExists(a)){c.CreateTextFile(a);}h=c.GetFile(a);f=h.OpenAsTextStream(TP.IE_APPEND);f.Write(i);f.Close();b.complete(true);return true;}else{e=TP.sc('Invalid file save mode ',g,'for ',a);TP.raise(this,'InvalidMode',arguments,e);b.fail(TP.FAILURE,e);}}return false;},'safari',function(c,b){var a;a=TP.request(b);TP.raise(this,'TP.sig.UnsupportedOperation',arguments);a.fail(TP.FAILURE,'Unsupported operation.');return false;},'chrome',function(c,b){var a;a=TP.request(b);TP.raise(this,'TP.sig.UnsupportedOperation',arguments);a.fail(TP.FAILURE,'Unsupported operation.');return false;}));TP.definePrimitive('$fileExecute',TP.hc('test',TP.boot.getBrowser,'firefox',function(i,m){var a,h,f,b,l,j,k,e,d,c,g;if(!TP.isString(i)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}a=TP.request(m);h=a.at('shellFlags');f=a.at('commandName');b=a.at('commandArgs');l=a.at('stdIn');j=a.at('stdOut');k=a.at('stdErr');e=a.atIfInvalid('async',false);if(!TP.isString(f)){g=TP.sc('Must supply a commandName to execute.');TP.raise(this,'TP.sig.InvalidParameter',arguments,g);a.fail(TP.FAILURE,g);return TP.ac(TP.FAILURE,null,g);}if(TP.boot.isWin()){d=TP.uriInLocalFormat(TP.ifInvalid(i,''));}else{d=TP.uriInLocalFormat(TP.ifInvalid(i,TP.sys.cfg('os.comspec_path')));}if(/ /.test(d)){if(TP.boot.isWin()){d='"'+d+'"';}else{d=d.replace(/ /g,'\\ ');}}TP.executePrivileged(TP.HOST_CMD_EXEC,TP.sc('This TIBET-based application would like to execute '+'the following command on the host system: ',f,' ',b),TP.sc('This TIBET-based application cannot execute the '+'following command on the host system: ',f,' ',b),false,function(){var u,s,x,o,w,H,v,q,g,i,p,m,n,t,C,K,G,I,y,D,r,B,A,z,F,J,E;if(TP.boot.isWin()){u=TP.ifInvalid(h,'');}else{u=TP.ifInvalid(h,TP.sys.cfg('os.comspec_flags'));}if(TP.isString(u)){u=u.split(' ');}s=TP.uriInLocalFormat(f);if(/ /.test(s)){if(TP.boot.isWin()){s='"'+s+'"';}else{s=s.replace(/ /g,'\\ ');}}if(TP.isString(b)){x=b;}else if(TP.isArray(b)){x=b.join(' ');}else if(TP.isKindOf(b,TP.lang.Hash)){x=b.asArray().flatten().join(' ');}else{x='';}if(TP.notEmpty(p=TP.ifInvalid(l,''))){p=TP.uriInLocalFormat(p);if(/ /.test(p)){if(TP.boot.isWin()){p='"'+p+'"';}else{p=p.replace(/ /g,'\\ ');}}}m=TP.uriInLocalFormat(TP.ifInvalid(k,TP.uriTempFileName()));if(/ /.test(m)){if(TP.boot.isWin()){m='"'+m+'"';}else{m=m.replace(/ /g,'\\ ');}}n=TP.uriInLocalFormat(TP.ifInvalid(j,TP.uriTempFileName()));if(/ /.test(n)){if(TP.boot.isWin()){n='"'+n+'"';}else{n=n.replace(/ /g,'\\ ');}}v=TP.ac(d,u,s,x);if(TP.notEmpty(p)){v.push(TP.sys.cfg('os.comspec_redirect_in')+p);}if(TP.notEmpty(n)){v.push(TP.sys.cfg('os.comspec_redirect_out')+n);}if(TP.notEmpty(m)){v.push(TP.sys.cfg('os.comspec_redirect_err')+m);}w=v.join(' ').trim();H=TP.boot.isWin()?'bat':'sh';g=TP.uriExpandPath(TP.uriTempFileName(null,null,H));g=TP.uriInLocalFormat(g);if(TP.boot.isWin()){q=TP.join('@echo off\n',w);if(e){i=TP.join(g,'.done');if(/ /.test(i)){i=TP.join('"',i,'"');}q=TP.join(q,'\necho "',g,' done." >',i);}q=TP.join(q,'\nexit /B\n');}else{q=TP.join('#!',TP.sys.cfg('os.comspec_path'),'\n',w);if(e){i=TP.join(g,'.done');if(/ /.test(i)){i=TP.join('"',i,'"');}q=TP.join(q,'\ntouch ',i);}}if(/ /.test(g)){if(TP.boot.isWin()){g=TP.join('"',g,'"');}else{g=g.replace(/ /g,'\\ ');}}TP.$fileSave(TP.uriInWebFormat(g),TP.hc('body',q,'permissions',493,'backup',false));w=g;D=function(){try{if(!TP.$$DEBUG){setTimeout(function(){TP.$fileDelete(TP.uriInWebFormat(g));},10);if(TP.notEmpty(i)){setTimeout(function(){TP.$fileDelete(TP.uriInWebFormat(i));},10);}if(TP.isEmpty(j)){setTimeout(function(){TP.$fileDelete(TP.uriInWebFormat(n));},10);}if(TP.isEmpty(k)){setTimeout(function(){TP.$fileDelete(TP.uriInWebFormat(m));},10);}}}catch(a){}};try{A='@mozilla.org/file/local;1';z=Components.interfaces.nsILocalFile;F=Components.classes[A].createInstance(z);F.initWithPath(TP.uriInLocalFormat(TP.sys.cfg('os.comspec_path')));}catch(b){o=TP.sc('Unable to init shell file: ',TP.uriInLocalFormat(TP.sys.cfg('os.comspec_path')));TP.raise(this,'InvalidShell',arguments,TP.ec(b,o));a.fail(TP.FAILURE,o);c=TP.ac(TP.FAILURE,null,o);return c;}try{A='@mozilla.org/process/util;1';z=Components.interfaces.nsIProcess;C=Components.classes[A].createInstance(z);C.init(F);}catch(a){o=TP.sc('Unable to init process for: ',TP.uriInLocalFormat(TP.sys.cfg('os.comspec_path')));TP.raise(this,'ProcessException',arguments,TP.ec(a,o));c=TP.ac(TP.FAILURE,null,o);return c;}r=TP.sig.Response.construct(a);r.setSignalName('TP.sig.IOCompleted');B=a.getID();r.atPut('cmdFile',TP.uriInWebFormat(g));r.atPut('outFile',TP.uriInWebFormat(n));r.atPut('errFile',TP.uriInWebFormat(m));if(e){c=r;y=function(){if(TP.$fileExists(TP.uriInWebFormat(i))){try{a.complete();r.fire(B);}catch(a){}finally{D();}return;}if(y.$$count++<TP.sys.cfg('os.exec_interval')){setTimeout(y,TP.sys.cfg('os.exec_delay'));}};y.$$count=0;setTimeout(y,10);}J={};E=TP.sys.cfg('os.comspec_flags').copy().add(g.unquoted());try{TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.trace(TP.join('Launching ',TP.uriInLocalFormat(TP.sys.cfg('os.comspec_path')),' ',TP.sys.cfg('os.comspec_flags').join(' '),' for command line: ',w),TP.TRACE,arguments):0;K=C.run(!e,E,E.getSize(),J);if(TP.notTrue(e)){t=TP.uriInWebFormat(n);TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.trace('outFile: '+t,TP.LOG,arguments):0;G=TP.$fileLoad(t);t=TP.uriInWebFormat(m);TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.trace('errFile: '+t,TP.LOG,arguments):0;I=TP.$fileLoad(t);}}catch(b){o=TP.str(b);TP.raise(this,'ExecutionException',arguments,TP.ec(b));a.fail(TP.FAILURE,o);c=TP.ac(TP.FAILURE,null,o);}finally{if(TP.notTrue(e)){c=TP.ac(K,G,I);a.complete(c);r.fire(B);D();}}});return c;},'ie',function(F,H){var a,D,t,c,E,w,v,j,i,m,B,o,p,q,l,b,g,f,e,d,s,r,k,x,A,G,C,n,y,h,z,u;if(!TP.isString(F)){return TP.raise(this,'TP.sig.InvalidURI',arguments);}a=TP.request(H);D=a.at('shellFlags');t=a.at('commandName');c=a.at('commandArgs');E=a.at('stdIn');w=a.at('stdOut');v=a.at('stdErr');j=a.atIfInvalid('async',false);if(!TP.isString(t)){i=TP.sc('Must supply a command to execute.');TP.raise(this,'TP.sig.InvalidParameter',arguments,i);a.fail(TP.FAILURE,i);return TP.ac(TP.FAILURE,null,i);}m=TP.uriInLocalFormat(TP.ifInvalid(F,''));if(/ /.test(m)){m='"'+m+'"';}B=TP.executePrivileged(TP.HOST_CMD_EXEC,TP.sc('This TIBET-based application would like to execute '+'the following command on the host system: ',t,' ',c),TP.sc('This TIBET-based application cannot execute the '+'following command on the host system: ',t,' ',c),false,function(){x=new ActiveXObject('WScript.Shell');});if(B){o=TP.ifInvalid(D,'');if(TP.isString(o)){o=o.split(' ');}p=TP.uriInLocalFormat(t);if(/ /.test(p)){p='"'+p+'"';}if(TP.isString(c)){q=c;}else if(TP.isArray(c)){q=c.join(' ');}else if(TP.isKindOf(c,TP.lang.Hash)){q=c.asArray().flatten().join(' ');}else{q='';}if(TP.notEmpty(f=TP.ifInvalid(E,''))){f=TP.uriInLocalFormat(f);if(/ /.test(f)){f='"'+f+'"';}}e=TP.uriInLocalFormat(TP.ifInvalid(v,TP.uriTempFileName()));if(/ /.test(e)){e='"'+e+'"';}d=TP.uriInLocalFormat(TP.ifInvalid(w,TP.uriTempFileName()));if(/ /.test(d)){d='"'+d+'"';}s=TP.ac(m,o,p,q);if(TP.notEmpty(f)){s.push(TP.sys.cfg('os.comspec_redirect_in')+f);}if(TP.notEmpty(d)){s.push(TP.sys.cfg('os.comspec_redirect_out')+d);}if(TP.notEmpty(e)){s.push(TP.sys.cfg('os.comspec_redirect_err')+e);}r=s.join(' ').trim();b=TP.uriExpandPath(TP.uriTempFileName(null,null,'bat'));b=TP.uriInLocalFormat(b);l=TP.join('@echo off\n',r);if(j){g=TP.join(b,'.done');if(/ /.test(g)){g=TP.join('"',g,'"');}l=TP.join(l,'\necho "',b,' done." >',g);}l=TP.join(l,'\nexit /B\n');if(/ /.test(b)){b=TP.join('"',b,'"');}TP.$fileSave(TP.uriInWebFormat(b),TP.request('body',l,'backup',false));r=b;y=function(){try{if(!TP.$$DEBUG){setTimeout(function(){TP.$fileDelete(TP.uriInWebFormat(b));},10);if(TP.notEmpty(g)){setTimeout(function(){TP.$fileDelete(TP.uriInWebFormat(g));},10);}if(TP.isEmpty(w)){setTimeout(function(){TP.$fileDelete(TP.uriInWebFormat(d));},10);}if(TP.isEmpty(v)){setTimeout(function(){TP.$fileDelete(TP.uriInWebFormat(e));},10);}}}catch(a){}};try{TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.trace(r,TP.LOG,arguments):0;h=TP.sig.Response.construct(a);h.setSignalName('TP.sig.IOCompleted');z=a.getID();h.atPut('cmdFile',TP.uriInWebFormat(b));h.atPut('outFile',TP.uriInWebFormat(d));h.atPut('errFile',TP.uriInWebFormat(e));if(j){u=h;n=function(){if(TP.$fileExists(TP.uriInWebFormat(g))){try{a.complete();h.fire(z);}catch(a){}finally{y();}return;}if(n.$$count++<TP.sys.cfg('os.exec_interval')){setTimeout(n,TP.sys.cfg('os.exec_delay'));}};n.$$count=0;setTimeout(n,10);}A=x.Run(r,0,!j);x=null;if(TP.notTrue(j)){k=TP.uriInWebFormat(d);TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.trace('outFile: '+k,TP.LOG,arguments):0;G=TP.$fileLoad(k);k=TP.uriInWebFormat(e);TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.trace('errFile: '+k,TP.LOG,arguments):0;C=TP.$fileLoad(k);}}catch(b){i=TP.str(b);TP.raise(this,'ExecutionException',arguments,TP.ec(b));a.fail(TP.FAILURE,i);u=TP.ac(TP.FAILURE,null,i);}finally{if(TP.notTrue(j)){u=TP.ac(A,G,C);a.complete(u);h.fire(z);y();}}}return u;},'safari',function(c,b){var a;a=TP.request(b);TP.raise(this,'TP.sig.UnsupportedOperation',arguments);a.fail(TP.FAILURE,'Unsupported operation.');return false;},'chrome',function(c,b){var a;a=TP.request(b);TP.raise(this,'TP.sig.UnsupportedOperation',arguments);a.fail(TP.FAILURE,'Unsupported operation.');return false;}));
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETURIPrimitivesPost.js';

TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETXSLTPrimitivesBase.js';

TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETXSLTPrimitivesPlatform.js';
TP.runConditionalFunction(TP.hc('test','gecko','true',function(){TP.MOZ_XSLT_ERROR_CODES=TP.hc('0x80600001','XSLT parse exception '+'(NS_ERROR_XSLT_PARSE_FAILURE)','0x80600002','XPath parse failure exception '+'(NS_ERROR_XPATH_PARSE_FAILURE)','0x80600003','XSLT already set exception '+'(NS_ERROR_XSLT_ALREADY_SET)','0x80600004','XSLT execution failure exception. Missing include or'+' import? '+'(NS_ERROR_XSLT_EXECUTION_FAILURE)','0x80600005','XPath unknown function exception '+'(NS_ERROR_XPATH_UNKNOWN_FUNCTION)','0x80600006','XSLT bad recursion exception '+'(NS_ERROR_XSLT_BAD_RECURSION)','0x80600007','XSLT bad value exception '+'(NS_ERROR_XSLT_BAD_VALUE)','0x80600008','XSLT nodeset expected exception '+'(NS_ERROR_XSLT_NODESET_EXPECTED)','0x80600009','XSLT aborted exception '+'(NS_ERROR_XSLT_ABORTED)','0x8060000a','XSLT network error exception '+'(NS_ERROR_XSLT_NETWORK_ERROR)','0x8060000b','XSLT wrong MIME type exception '+'(NS_ERROR_XSLT_WRONG_MIME_TYPE)','0x8060000c','XSLT load recursion exception '+'(NS_ERROR_XSLT_LOAD_RECURSION)','0x8060000d','XPath bad argument count exception '+'(NS_ERROR_XPATH_BAD_ARGUMENT_COUNT)','0x8060000e','XPath bad extension function exception '+'(NS_ERROR_XPATH_BAD_EXTENSION_FUNCTION)','0x8060000f','XPath parenthesis expected exception '+'(NS_ERROR_XPATH_PAREN_EXPECTED)','0x80600010','XPath invalid axis exception '+'(NS_ERROR_XPATH_INVALID_AXIS)','0x80600011','XPath no node type test exception '+'(NS_ERROR_XPATH_NO_NODE_TYPE_TEST)','0x80600012','XPath bracket expected exception '+'(NS_ERROR_XPATH_BRACKET_EXPECTED)','0x80600013','XPath invalid variable name exception '+'(NS_ERROR_XPATH_INVALID_VAR_NAME)','0x80600014','XPath unexpected end exception '+'(NS_ERROR_XPATH_UNEXPECTED_END)','0x80600015','XPath operator expected exception '+'(NS_ERROR_XPATH_OPERATOR_EXPECTED)','0x80600016','XPath unclosed literal exception '+'(NS_ERROR_XPATH_UNCLOSED_LITERAL)','0x80600017','XPath bad colon exception '+'(NS_ERROR_XPATH_BAD_COLON)','0x80600018','XPath bad bang exception '+'(NS_ERROR_XPATH_BAD_BANG)','0x80600019','XPath illegal character exception '+'(NS_ERROR_XPATH_ILLEGAL_CHAR)','0x8060001a','XPath binary expected exception '+'(NS_ERROR_XPATH_BINARY_EXPECTED)','0x8060001b','XSLT loading error. Check file paths. '+'(NS_ERROR_XSLT_LOAD_BLOCKED_ERROR)','0x8060001c','XPath invalid expression evaluated exception '+'(NS_ERROR_XPATH_INVALID_EXPRESSION_EVALUATED)','0x8060001d','XPath unbalanced curly brace exception '+'(NS_ERROR_XSLT_UNBALANCED_CURLY_BRACE)','0x8060001e','XSLT bad node name exception '+'(NS_ERROR_XSLT_BAD_NODE_NAME)','0x80004005','XSLT error. Missing or misnamed parameter or'+' variable?','0x804b000a','URI error. Malformed URI.');TP.regex.ERROR=TP.rc('Component returned failure code: (\\w+)');return;}));TP.definePrimitive('$documentEscapeContent',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(e,f){var b,g,c,h,i,a,d;g=f.getSize();for(b=0;b<g;b++){i=f[b];d=TP.nodeGetElementsByTagName(e,i);h=d.getSize();for(c=0;c<h;c++){a=d.at(c);if(TP.isTextNode(a.firstChild)){TP.nodeReplaceChild(a,e.createCDATASection(a.firstChild.nodeValue),a.firstChild);}}}return;},'trident',function(a,b){return;},'webkit',function(e,f){var b,g,c,h,i,a,d;g=f.getSize();for(b=0;b<g;b++){i=f.at(b);d=TP.nodeGetElementsByTagName(e,i);h=d.getSize();for(c=0;c<h;c++){a=d.at(c);if(TP.isTextNode(a.firstChild)){TP.nodeReplaceChild(a,e.createCDATASection(a.firstChild.nodeValue),a.firstChild);}}}}));TP.definePrimitive('$fixupNamespacedAttributesPre',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(g){var d,c,e,a,f,b;d=TP.nodeGetElementsByTagName(g,'*');e=d.getSize();for(c=0;c<e;c++){a=d.at(c);f=a.attributes.length;for(b=0;b<f;b++){if(TP.nodeGetNSURI(a.attributes[b])===TP.w3.Xmlns.XMLNS){TP.elementSetAttribute(a,'tibet_XSLTNSHack__'+TP.attributeGetLocalName(a.attributes[b]),a.attributes[b].value);}}}return;},'trident',function(a){return;},'webkit',function(g){var d,c,e,a,f,b;d=TP.nodeGetElementsByTagName(g,'*');e=d.getSize();for(c=0;c<e;c++){a=d.at(c);f=a.attributes.length;for(b=0;b<f;b++){if(TP.nodeGetNSURI(a.attributes[b])===TP.w3.Xmlns.XMLNS){TP.elementSetAttribute(a,'tibet_XSLTNSHack__'+TP.attributeGetLocalName(a.attributes[b]),a.attributes[b].value);}}}return;}));TP.definePrimitive('$fixupNamespacedAttributesPost',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(h,g){var c,d,e,a,f,b;c=TP.nodeEvaluateXPath(h,'//@*[starts-with(local-name(),"tibet_XSLTNSHack")]',TP.NODESET);f=c.getSize();for(a=0;a<f;a++){b=c.at(a);d=TP.attributeGetOwnerElement(b);d.removeAttributeNode(b);}if(TP.notValid(g.documentElement)){return;}c=TP.nodeEvaluateXPath(g,'//@*[starts-with(local-name(),"tibet_XSLTNSHack")]',TP.NODESET);f=c.getSize();for(a=0;a<f;a++){b=c.at(a);d=TP.attributeGetOwnerElement(b);e=b.name.split('__').at(1);if(e!=='xmlns'){e='xmlns:'+e;}d.setAttributeNS(TP.w3.Xmlns.XMLNS,e,b.value);d.removeAttributeNode(b);}return;},'trident',function(a,b){return;},'webkit',function(h,g){var c,d,e,a,f,b;c=TP.nodeEvaluateXPath(h,'//@*[starts-with(local-name(),"tibet_XSLTNSHack")]',TP.NODESET);f=c.getSize();for(a=0;a<f;a++){b=c.at(a);d=TP.attributeGetOwnerElement(b);d.removeAttributeNode(b);}if(TP.notValid(g.documentElement)){return;}c=TP.nodeEvaluateXPath(g,'//@*[starts-with(local-name(),"tibet_XSLTNSHack")]',TP.NODESET);f=c.getSize();for(a=0;a<f;a++){b=c.at(a);d=TP.attributeGetOwnerElement(b);e=b.name.split('__').at(1);if(e!=='xmlns'){e='xmlns:'+e;}d.setAttributeNS(TP.w3.Xmlns.XMLNS,e,b.value);d.removeAttributeNode(b);}return;}));TP.definePrimitive('documentTransformNode',TP.hc('test',TP.boot.getBrowserUI,'gecko',function(f,n,g){var v,u,m,c,a,h,s,l,q,d,r,j,t,i,b,e,k,o,p;TP.debug('break.node_xslt');if(!TP.isXMLDocument(f)){return TP.raise(this,'TP.sig.InvalidXMLDocument',arguments);}m=TP.isXMLDocument(n);if(!m){try{c=TP.documentFromNode(TP.nodeCloneNode(n,true));}catch(a){return TP.raise(this,'TP.sig.InvalidXMLDocument',arguments,TP.ec(a));}}else{c=n;}if(TP.nodeGetNSURI(c.documentElement)===TP.w3.Xmlns.XSLT){j=true;}else{j=TP.ifKeyInvalid(g,'xmlns:fixup',true);}u='0';if(TP.notEmpty(v=TP.elementGetAttribute(f.documentElement,'tibet:src',true))){if(TP.notEmpty(g)){u=TP.hash(g);}}if(TP.notValid(h)){try{h=new XSLTProcessor();if(TP.notEmpty(g)){l=TP.ac();g.perform(function(a){var b,c;b=a.first();c=TP.ifInvalid(a.last(),'');h.setParameter(null,b,c);});}s=TP.doc(TP.nodeAsString(f,true,false));h.importStylesheet(s);}catch(a){b=TP.str(a).match(TP.regex.ERROR);if(TP.isArray(b)&&b.getSize()>1&&TP.isString(e=TP.MOZ_XSLT_ERROR_CODES.at(b.at(1)))){if(TP.notEmpty(k=TP.elementGetAttribute(f.documentElement,'tibet:src',true))){e+=' in: '+k;}TP.ifWarn()?TP.warn(e,TP.TRANSFORM_LOG,arguments):0;}TP.raise(this,'TP.sig.XSLTException',arguments,TP.ec(a));return;}}try{if(j){TP.$fixupNamespacedAttributesPre(c);}c=TP.$nodeEscapeCSSConstructs(c);a=h.transformToDocument(c);if(!TP.isXMLDocument(a)||TP.notValid(a.documentElement)){TP.raise(this,'TP.sig.XSLTException',arguments,'Unable to produce valid XML document.');return;}if(j){TP.$fixupNamespacedAttributesPost(c,a);}if(TP.notEmpty(t=TP.nodeGetElementsByTagName(f,'xsl:output'))){if(TP.notEmpty(i=TP.elementGetAttribute(t.at(0),'cdata-section-elements'))){i=i.split(' ');TP.$documentEscapeContent(a,i);}}TP.$documentEscapeContent(a,TP.ac('script','style','html:script','html:style','tibet_style'));if(TP.isArray(l)){q=l.getSize();for(d=0;d<q;d++){r=l.at(d);TP.nodeDetach(r.firstChild);}}}catch(a){b=TP.str(a).match(TP.regex.ERROR);if(TP.isArray(b)&&b.getSize()>1&&TP.isString(e=TP.MOZ_XSLT_ERROR_CODES.at(b.at(1)))){if(TP.notEmpty(k=TP.elementGetAttribute(f.documentElement,'tibet:src',true))){e+=' in: '+k;}TP.ifWarn()?TP.warn(e,TP.TRANSFORM_LOG,arguments):0;}TP.raise(this,'TP.sig.XSLTException',arguments,TP.ec(a));return;}if(!TP.isDocument(a)||TP.notValid(a.documentElement)){return;}if(TP.isEmpty(a.documentElement.prefix)){p=false;o=a.documentElement.attributes;for(d=0;d<o.length;d++){if(TP.attributeGetLocalName(o[d])==='xmlns'){p=true;break;}}if(!p){a.documentElement.setAttributeNS(TP.w3.Xmlns.XMLNS,'xmlns',TP.nodeGetNSURI(a.documentElement));}}if(!m){return a.documentElement;}return a;},'trident',function(d,m,h){var k,b,c,n,l,g,e,f,i,a,j;TP.debug('break.node_xslt');if(!TP.isXMLDocument(d)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(TP.notEmpty(k=TP.nodeGetElementsByTagName(d,'xsl:output'))){b=k.first();TP.elementSetAttributeInNS(d.documentElement,'xmlns:html',TP.w3.Xmlns.XHTML,TP.w3.Xmlns.XMLNS);if(TP.elementHasAttribute(b,'cdata-section-elements')){TP.elementSetAttribute(b,'cdata-section-elements',TP.elementGetAttribute(b,'cdata-section-elements')+'script style tibet_style '+'html:script html:style html:tibet_style');}else{TP.elementSetAttribute(b,'cdata-section-elements','script style tibet_style '+'html:script html:style html:tibet_style');}}else{b=TP.documentCreateElement(d,'output',TP.w3.Xmlns.XSLT);TP.elementSetAttribute(b,'cdata-section-elements','script style html:script html:style tibet_style');b=TP.nodeAppendChild(d.documentElement,b);}TP.elementAddNamespace(d.documentElement,'html',TP.w3.Xmlns.XHTML);c=m;l='0';if(TP.notEmpty(n=TP.elementGetAttribute(d.documentElement,'tibet:src',true))){if(TP.notEmpty(h)){l=TP.hash(h);}}if(TP.notValid(a)){g=TP.IE_THREADED_DOM_VERSIONS;for(e=0;e<g.getSize();e++){try{f=new ActiveXObject(g.at(e));break;}catch(a){}}if(TP.notValid(f)){return TP.raise(this,'TP.sig.InvalidParameter',arguments,'Unable to create a free threaded XSL document.');}if(TP.$msxml>=6){f.setProperty('AllowDocumentFunction',true);f.setProperty('AllowXsltScript',true);}f.resolveExternals=true;f.loadXML(d.documentElement.xml);g=TP.IE_XSL_TEMPLATE_VERSIONS;for(e=0;e<g.getSize();e++){try{i=new ActiveXObject(g.at(e));break;}catch(a){}}if(TP.notValid(i)){return TP.raise(this,'TP.sig.InvalidParameter',arguments,'Unable to create a XSL DOM Template.');}i.stylesheet=f;try{a=i.createProcessor();a.addObject(self,'urn:ecma:262-3');}catch(a){return TP.raise(this,'TP.sig.XSLTException',arguments,TP.ec(a));}}try{c=TP.$nodeEscapeCSSConstructs(c);a.input=c;if(TP.notEmpty(h)){h.perform(function(c){var b;b=c.last();if(!TP.isNode(b)){if(TP.canInvoke(b,'asString')){a.addParameter(c.first(),b.asString());}else if(TP.canInvoke(b,'valueOf')){a.addParameter(c.first(),b.valueOf());}else{a.addParameter(c.first(),b);}}else{a.addParameter(c.first(),b);}});}a.transform();}catch(a){return TP.raise(this,'TP.sig.XSLTException',arguments,TP.ec(a));}j=a.output;c=TP.documentFromString(j,null,true);if(!TP.isXMLDocument(c)||TP.notValid(c.documentElement)){TP.raise(this,'TP.sig.XSLTException',arguments,'Unable to produce valid XML document.');return;}if(!TP.isXMLDocument(m)){return c.documentElement;}return c;},'webkit',function(g,l,e){var s,p,k,c,a,f,d,j,o,b,q,h,r,i,m,n;TP.debug('break.node_xslt');if(!TP.isXMLDocument(g)){return TP.raise(this,'TP.sig.InvalidXMLDocument',arguments);}k=TP.isXMLDocument(l);if(!k){try{c=TP.documentFromNode(TP.nodeCloneNode(l,true));}catch(a){return TP.raise(this,'TP.sig.InvalidXMLDocument',arguments,TP.ec(a));}}else{c=l;}if(TP.nodeGetNSURI(c.documentElement)===TP.w3.Xmlns.XSLT){h=true;}else{h=TP.ifKeyInvalid(e,'xmlns:fixup',true);}p='0';if(TP.notEmpty(s=TP.elementGetAttribute(g.documentElement,'tibet:src',true))){if(TP.notEmpty(e)){p=TP.hash(e);}}if(TP.notValid(f)){try{f=new XSLTProcessor();if(TP.notEmpty(e)){j=TP.ac();d=TP.nodeCloneNode(g,true);e.perform(function(g){var b,c,e,a;b=g.first();c=TP.ifInvalid(g.last(),'');if(TP.isNode(c)){if(TP.isElement(e=TP.nodeEvaluateXPath(d,'//xsl:param[@name="'+b+'"]',TP.FIRST_NODE))){a=TP.documentCreateElement(d,'xsl:variable',TP.w3.Xmlns.XSLT);TP.elementSetAttribute(a,'name',b);a=TP.nodeReplaceChild(e.parentNode,a,e);TP.nodeAppendChild(a,c,false);}}else{f.setParameter(null,b,c);}});}else{d=g;}f.importStylesheet(d);}catch(a){TP.raise(this,'TP.sig.XSLTException',arguments,TP.ec(a));return;}}try{if(h){TP.$fixupNamespacedAttributesPre(c);}c=TP.$nodeEscapeCSSConstructs(c);a=f.transformToDocument(c);if(!TP.isXMLDocument(a)||TP.notValid(a.documentElement)){TP.raise(this,'TP.sig.XSLTException',arguments,'Unable to produce valid XML document.');return;}if(h){TP.$fixupNamespacedAttributesPost(c,a);}if(TP.notEmpty(r=TP.nodeGetElementsByTagName(g,'xsl:output'))){if(TP.notEmpty(i=TP.elementGetAttribute(r.at(0),'cdata-section-elements'))){i=i.split(' ');TP.$documentEscapeContent(a,i);}}TP.$documentEscapeContent(a,TP.ac('script','style','html:script','html:style','tibet_style'));if(TP.isArray(j)){o=j.getSize();for(b=0;b<o;b++){q=j.at(b);TP.nodeDetach(q.firstChild);}}}catch(a){TP.raise(this,'TP.sig.XSLTException',arguments,TP.ec(a));return;}if(!TP.isDocument(a)||TP.notValid(a.documentElement)){return;}if(TP.isEmpty(a.documentElement.prefix)){n=false;m=a.documentElement.attributes;for(b=0;b<m.length;b++){if(TP.attributeGetLocalName(m[b])==='xmlns'){n=true;break;}}if(!n){a.documentElement.setAttributeNS(TP.w3.Xmlns.XMLNS,'xmlns',TP.nodeGetNSURI(a.documentElement));}}if(!k){return a.documentElement;}return a;}));
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETXSLTPrimitivesPost.js';
TP.definePrimitive('uriTransformFile',function(a,b,g){var c,d,e,f;if(TP.notValid(c=TP.uc(a))){this.raise('TP.sig.InvalidURI',arguments,a);return;}d=c.getNativeNode(TP.hc('async',false));if(TP.notValid(e=TP.uc(b))){this.raise('TP.sig.InvalidURI',arguments,b);return;}f=e.getNativeNode(TP.hc('async',false));return TP.documentTransformFile(d,f,g);});TP.definePrimitive('uriTransformNode',function(a,d,e){var b,c;if(TP.notValid(b=TP.uc(a))){this.raise('TP.sig.InvalidURI',arguments,a);return;}c=b.getNativeNode(TP.hc('async',false));return TP.documentTransformNode(c,d,e);});TP.definePrimitive('documentTransformFile',function(d,a,e){var b,c;if(TP.notValid(b=TP.uc(a))){this.raise('TP.sig.InvalidURI',arguments,a);return;}c=b.getNativeNode(TP.hc('async',false));return TP.documentTransformNode(d,c,e);});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETContentPrimitives.js';
TP.regex.JSON_ISODATE=/^(\d{4})-?(\d{2})?-?(\d{2})?(T(\d{2})(:(\d{2})(:(\d{2})(\.(\d{1,3}))?)?)?)?(Z)?([\+\-]\d{2}:\d{2})?$/;TP.regex.JSON_ERRMSG=/^JSONP call error: /;TP.definePrimitive('getJSONPIFrame',function(){var a,c,b;a=TP.sys.getWindowById(TP.sys.cfg('tibet.uibuffer'));if(TP.notValid(a)){a=window;}c=TP.sys.cfg('tibet.jsonp_frame')||'JSONP';if(!TP.isElement(b=TP.nodeGetElementById(a.document,c))){b=TP.documentCreateIFrameElement(a.document,null,c);TP.elementSetAttribute(b,'style','display: none');}return b;});TP.definePrimitive('isJSONString',function(a){var b;if(TP.isEmpty(a)){return false;}b=a;try{JSON.parse(b);return true;}catch(a){return false;}});TP.definePrimitive('json2js',function(e,g,h){var c,f,a,d,b;c=e;f=TP.ifInvalid(g,true);try{if(!f){return JSON.parse(c);}a=JSON.parse(c,function(d,a){var c,b;if(TP.isString(a)&&TP.regex.JSON_ISODATE.test(a)){return TP.dc(a);}if(TP.isMemberOf(a,Object)){return TP.hc(a);}if(TP.isMemberOf(a,Array)){c=TP.ac();for(b=0;b<a.length;b++){c.push(a[b]);}return c;}return a;});if(TP.isMemberOf(a,Object)){return TP.hc(a);}if(TP.isMemberOf(a,Array)){d=TP.ac();for(b=0;b<a.length;b++){d.push(a[b]);}return d;}return a;}catch(a){if(TP.notFalse(h)){return TP.raise(this,'TP.sig.InvalidJSON',arguments,TP.ec(a,e));}return;}});TP.definePrimitive('js2json',function(a){var c,b;if(TP.isMemberOf(a,TP.lang.Hash)){b=a.asObject();}else{b=a;}try{c=JSON.stringify(b,function(b,a){if(TP.regex.INTERNAL_SLOT.test(b)){return;}if(TP.isMemberOf(a,TP.lang.Hash)){return a.asObject();}if(TP.isString(a)||TP.isNumber(a)||TP.isMemberOf(a,Object)||TP.isArray(a)||TP.isBoolean(a)||TP.isNull(a)){return a;}return TP.json(a);});}catch(a){return TP.raise(this,'TP.sig.JSONSerializationException',arguments,TP.ec(a));}return c;});TP.definePrimitive('js2xml',function(b,c){var a;a=TP.jsonml2xml(b);if(TP.notValid(a)){TP.raise(this,'TP.sig.InvalidXML',arguments,'Unable to convert object '+TP.id(b)+'to XML.');}return a;});TP.definePrimitive('xml2js',function(a){var b;if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isDocument(a)){b=a.documentElement;}else if(TP.isElement(a)||TP.isFragment(a)){b=a;}else if(TP.isAttributeNode(a)){return TP.hc(a.name,a.value);}else if(TP.isPINode(a)){return TP.hc('target',a.target,'data',a.data);}else{return TP.nodeGetTextContent(a);}if(TP.isElement(b)||TP.isFragment(b)){if(TP.elementGetLocalName(b)==='struct'){return TP.core.XMLRPCNode.objectFromNode(b);}return TP.xml2jsonml(b);}return null;});TP.definePrimitive('json2xml',function(b){var a;a=TP.json2js(b);if(TP.notEmpty(a)){return TP.js2xml(a);}return null;});TP.definePrimitive('xml2json',function(b){var a;a=TP.xml2js(b);if(TP.notEmpty(a)){return TP.js2json(a);}return null;});TP.definePrimitive('jsonml2xml',function(a,c){var b;try{b=TP.extern.JsonML.toXML(a);}catch(b){if(TP.notFalse(c)){return TP.raise(this,'TP.sig.InvalidJSON',arguments,TP.ec(b,a));}return;}return b;});TP.definePrimitive('xml2jsonml',function(b){var c,a;if(!TP.isNode(b)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}if(TP.isXMLDocument(a=b)){a=a.documentElement;}c=TP.extern.JsonML.fromXML(a);return c;});TP.definePrimitive('js2xmlrpc',function(a){if(TP.notValid(a)){return;}if(TP.isWindow(a)){return;}if(a===TP.core.Browser){return;}if(TP.isHTMLDocument(a)){return;}if(TP.isType(a)){return;}if(TP.canInvoke(a,'asTP_core_XMLRPCNode')){return a.asTP_core_XMLRPCNode();}return TP.core.XMLRPCNode.from(a);});TP.definePrimitive('json2xmlrpc',function(a,b){return TP.js2xmlrpc(TP.json2js(a));});TP.definePrimitive('jsonpCall',function(k,j,o,n,m,l){var d,h,b,i,f,a,c,e,g;if(!TP.isDocument(d=m)){h=TP.getJSONPIFrame();d=TP.elementGetIFrameDocument(h);}if(!TP.isHTMLDocument(d)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}b=TP.nodeGetWindow(d);f=TP.isCallable(j)?j:TP.RETURN_THIS;b.onerror=function(d,e,g){var c;c=TP.join('JSONP call error: ',d,' from: ',e);if(TP.notFalse(l)){TP.raise(this,'TP.sig.JSONException',arguments,c);f(c);}b[a]=null;};if(TP.notValid(a=o)){a='jsoncallback_'+TP.lid(f).replace(/\$/g,'_');}b[a]=function(d){var c;c=TP.json2js(TP.js2json(d));f(c);b[a]=null;};i=TP.ifInvalid(n,'callback');c=k.asString();if(/\?/.test(c)){c+='&';}else{c+='?';}c+=i+'='+a;e=TP.documentCreateScriptElement(d,c,function(){TP.nodeDetach(e);(function(){if(TP.isCallable(b[a])){b[a]=null;}}.fork(TP.sys.cfg('jsonp.delay')));});try{g=TP.documentEnsureHeadElement(d);if(TP.isElement(g)){e=TP.nodeAppendChild(g,e,false);}}catch(a){TP.raise(this,'TP.sig.JSONException',arguments,TP.ec(a));f(TP.join('JSONP call error: ',TP.str(a)));}return e;});var JsonML=TP.extern.JsonML||{};TP.extern.JsonML=JsonML;(function(a,b){'use strict';var e=Array.isArray||function(a){return a instanceof Array;};var c=function(a){if(!a){if(b.createDocumentFragment){return b.createDocumentFragment();}a='';}else if(a.charAt(0)==='!'){return b.createComment(a==='!'?'':a.substr(1)+' ');}return b.createElement(a);};var l=function(c,b){for(var a in b){if(b.hasOwnProperty(a)){c.setAttribute(a,b[a]);}}return c;};var f=function(a,b){if(b){if(a.nodeType===8){if(b.nodeType===3){a.nodeValue+=b.nodeValue;}}else if(a.canHaveChildren!==false){a.appendChild(b);}}};var i=function(a){return b.createTextNode('['+a+']');};a.onerror=null;var m=function(c,b,g){for(var a=1;a<b.length;a++){if(e(b[a])||'string'===typeof b[a]){f(c,d(b[a],g));}else if('object'===typeof b[a]&&b[a]!==null&&c.nodeType===1){c=l(c,b[a]);}}return c;};var d=a.toXML=function(g,h){try{if(!g){return null;}if('string'===typeof g){return b.createTextNode(g);}if(!e(g)||'string'!==typeof g[0]){throw new SyntaxError('invalid JsonML');}var n=g[0];if(!n){var j=c('');for(var k=1;k<g.length;k++){f(j,d(g[k],h));}if(j.childNodes.length===1){return j.firstChild;}return j;}var l=m(c(n),g,h);return l&&'function'===typeof h?h(l):l;}catch(c){try{var o='function'===typeof a.onerror?a.onerror:i;return o(c,g,h);}catch(a){return b.createTextNode('['+a+']');}}};a.toXMLText=function(a,b){return j(d(a,b));};var k=function(c,e,f){if(c.hasChildNodes()){for(var b=0,d=c.childNodes.length;b<d;b++){var a=c.childNodes[b];a=g(a,e);if(a){f.push(a);}}return true;}return false;};var g=a.fromXML=function(a,c){if(!a||!a.nodeType){return a=null;}var d,b;switch(a.nodeType){case 1:case 9:case 11:b=[a.tagName||''];var e=a.attributes,g={},h=false;for(d=0;e&&d<e.length;d++){if(e[d].specified){if('string'===typeof e[d].value){g[e[d].name]=e[d].value;}h=true;}}if(h){b.push(g);}k(a,c,b);if('function'===typeof c){b=c(b,a);}a=null;return b;case 3:case 4:var i=String(a.nodeValue);a=null;return i;case 10:b=['!'];var f=['DOCTYPE',(a.name||'html').toLowerCase()];if(a.publicId){f.push('PUBLIC','"'+a.publicId+'"');}if(a.systemId){f.push('"'+a.systemId+'"');}b.push(f.join(' '));if('function'===typeof c){b=c(b,a);}a=null;return b;case 8:if((a.nodeValue||'').indexOf('DOCTYPE')!==0){a=null;return null;}b=['!',a.nodeValue];if('function'===typeof c){b=c(b,a);}a=null;return b;default:if(window.console){window.console.log('nodeType '+a.nodeType+' skipped.');}return a=null;}};var h=a.parseXML=function(a){if(!a||typeof a!=='string'){return null;}if(window.DOMParser){return new DOMParser().parseFromString(a,'application/xml');}if(window.ActiveXObject){var b=new ActiveXObject('Microsoft.XMLDOM');b.async='false';b.loadXML(a);return b;}return null;};a.fromXMLText=function(b,c){var a=h(b);a=a&&(a.ownerDocument||a).documentElement;return g(a,c);};var j=a.renderXML=function(a){if(!a){return null;}if(window.XMLSerializer){return new window.XMLSerializer().serializeToString(a);}if(a.xml){return a.xml;}if(a.outerHTML){return a.outerHTML;}var b=c('div');b.appendChild(a);var d=b.innerHTML;b.removeChild(a);return d;};a.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return!!b&&b.nodeName!=='HTML';};b=h('<xml/>')||b;}(JsonML,document));
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETImportExport.js';
TP.sys.defineMethod('getURIXML',function(e){var a,d,b,c;if(TP.isTrue(e)){TP.sys.$uriXML=null;}if(TP.isNode(a=TP.sys.$uriXML)){return TP.isEmpty(a)?null:a;}d=TP.sys.shouldLogRaise();TP.sys.shouldLogRaise(false);try{if(TP.notEmpty(b=TP.sys.cfg('tibet.uris'))){try{b=TP.uriExpandPath(b);if(TP.isURI(c=TP.uc(b))){a=TP.$fileLoad(c.getLocation(),TP.hc('resultType',TP.DOM));}}catch(a){}}if(TP.notValid(a)){try{b=TP.uriExpandPath(TP.sys.cfg('tibet.uri_file'));if(TP.isURI(c=TP.uc(b))){a=TP.$fileLoad(c.getLocation(),TP.hc('resultType',TP.DOM));}}catch(a){}if(TP.notValid(a)){a=TP.documentFromString('<xcat:catalog xmlns:xcat="'+'urn:oasis:names:tc:entity:xmlns:xml:catalog'+'"></xcat:catalog>');}}TP.sys.$uriXML=a;}catch(a){}finally{TP.sys.shouldLogRaise(d);}return a;});TP.sys.defineMethod('getURIXMLString',function(a){var b,c;if(TP.isTrue(a)){TP.sys.$uriSTR=null;}if(TP.isString(b=TP.sys.$uriSTR)){return b;}try{c=TP.sys.getURIXML(a);TP.sys.$uriSTR=TP.nodeAsString(c);}catch(a){}return TP.sys.$uriSTR;});TP.sys.defineMethod('initializeXMLCatalog',function(c){var e,f,g,d,b,a;e=TP.isDocument(c)?c.documentElement:c;if(TP.elementGetAttribute(e,'tibet:phase',true)==='Finalize'){return c;}f=TP.nodeGetElementsByTagName(c,'*');g=f.getSize();for(d=0;d<g;d++){b=f[d];if(TP.notEmpty(a=TP.elementGetAttribute(b,'name'))){if(TP.regex.TIBET_URI.test(a)){TP.elementSetAttribute(b,'name',TP.uriExpandPath(a),true);}}if(TP.notEmpty(a=TP.elementGetAttribute(b,'uri'))){if(TP.regex.TIBET_URI.test(a)){TP.elementSetAttribute(b,'uri',TP.uriExpandPath(a),true);}}if(TP.notEmpty(a=TP.elementGetAttribute(b,'tibet:localuri',true))){if(TP.regex.TIBET_URI.test(a)){TP.elementSetAttribute(b,'tibet:localuri',TP.uriExpandPath(a),true);}}if(TP.notEmpty(a=TP.elementGetAttribute(b,'catalog'))){if(TP.regex.TIBET_URI.test(a)){TP.elementSetAttribute(b,'catalog',TP.uriExpandPath(a),true);}}}TP.elementSetAttribute(e,'tibet:phase','Finalize',true);return c;});TP.sys.defineMethod('getLoadedScripts',function(){var b,d,e,a,c;d=TP.ac();b=document.getElementsByTagName('script');e=b.length;for(a=0;a<e;a++){c=b[a].getAttribute('src')||b[a].getAttribute('source');if(TP.notEmpty(c)&&c!=='inline'){d.push(TP.uriJoinPaths('~app/',c));}}return d.compact();});TP.sys.defineMethod('getPackageScripts',function(f){var d,b,e,a,c;d=TP.uriExpandPath(TP.str(f));c=TP.ac();b=document.getElementsByTagName('script');e=b.length;for(a=0;a<e;a++){if(b[a].getAttribute(TP.LOAD_PACKAGE)===d){c.push(b[a].getAttribute('src')||b[a].getAttribute('source'));}}return c.compact();});TP.sys.defineMethod('getPackageTypes',function(c){var a,b;a=this.getPackageScripts(c);b=this.getCustomTypes().getValues();return b.select(function(b){return a.contains(TP.objectGetLoadPath(b));});});TP.sys.defineMethod('getScriptTypes',function(c){var a,b;a=TP.uriExpandPath(TP.str(c));b=this.getCustomTypes().getValues();return b.select(function(b){return TP.objectGetLoadPath(b)===a;});});TP.sys.defineMethod('importPackage',function(a,b,f,g,h){var d,e,c;d=TP.ifInvalid(h,true);e=TP.ifInvalid(g,false);if(!TP.isString(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.regex.VIRTUAL_URI_PREFIX.test(a)){c=TP.uriExpandPath(a);}else if(!TP.regex.HAS_COLON.test(a)){c=TP.uriExpandPath('~lib_cfg/'+a+'.xml');}else{c=a;}if(!e){if(TP.sys.hasPackage(c,b)){TP.ifInfo()?TP.info('Skipping package: '+a+' target: '+(TP.notValid(b)?'default':b)+' import. '+'Target \''+b+'\' already imported.',TP.LOG,arguments):0;return 0;}}TP.ifInfo()?TP.info('Importing package: '+a+' target: '+(TP.notValid(b)?'default':b)+' from file: '+c,TP.LOG,arguments):0;return TP.boot.$importPackage(c,b,f,d);});TP.sys.defineMethod('importNamespace',function(c,d){var a,b;b=TP.ifEmpty(d,'TNS');a=TP.w3.Xmlns.get('info').at(c).at('prefix');return TP.sys.importPackage(b,a);});TP.sys.defineMethod('importScript',function(b,c){var a;a=TP.uc(b);if(TP.notValid(a)){return this.raise('TP.sig.InvalidURI',arguments);}if(TP.uriIsAbsolute(a.getLocation())){a=a.rewrite();}return TP.boot.$uriImport(a.getLocation(),TP.ifKeyInvalid(c,'callback',null),true,false);});TP.sys.defineMethod('importType',function(a,e,f){var b,c,d,g;TP.debug('break.require');b=TP.ifInvalid(e,false);c=TP.ifInvalid(f,false);if(!TP.isString(a)){if(TP.isType(a)){return a;}return this.raise('TP.sig.InvalidParameter',arguments);}if(!TP.isTypeName(a)){return;}if(TP.isType(d=TP.sys.getTypeByName(a,!c))){if(!b){return d;}else{g=TP.sys.getMetadata('types');}}return null;});TP.sys.require=TP.sys.importType;
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETPrimitivesShortcuts.js';
TP.definePrimitive('context',function(g){var f,e,a,c,b,d;f=arguments.length;for(e=0;e<f;e++){a=TP.unwrap(arguments[e]);if(TP.isString(a)){b=TP.sys.getWindowById(a);if(TP.notValid(b)){b=TP.sys.getWindowById(a,TP.sys.getUICanvas(true));}if(TP.isWindow(b)){c=TP.doc(b);if(TP.isDocument(c)){return c;}}}else if(TP.isElement(a)){return a;}else if(TP.isNode(a)||TP.isWindow(a)){c=TP.doc(a);if(TP.isDocument(c)){return c;}}}if(TP.notValid(d)){d=TP.isWindow(b)?b:TP.sys.getWindowById(TP.sys.getUICanvasName());}if(TP.isWindow(d)){d=d.document;}return d;});TP.definePrimitive('idcall',function(c,e,j,k){var d,f,g,i,h,a,b;if(TP.notValid(e)){e=TP.sys.getWindowById(TP.sys.getUICanvasName());}d=TP.isString(e)?TP.byId(e,TP.context(j)):TP.elem(e);f=TP.args(arguments,3);if(TP.isArray(d)){g=TP.ac();i=d.getSize();for(h=0;h<i;h++){a=d.at(h);if(TP.isElement(a)){b=TP.wrap(a);if(TP.canInvoke(b,c)){g.push(b[c].apply(b,f));}else if(TP.canInvoke(a,c)){g.push(a[c].apply(a,f));}}}return g;}else if(TP.isElement(d)){b=TP.wrap(d);if(TP.canInvoke(b,c)){return b[c].apply(b,f);}else if(TP.canInvoke(a,c)){return a[c].apply(a,f);}}return d;});TP.definePrimitive('tpcall',function(f,c,i,j){var a,b,e,h,d,g;if(TP.notValid(c)){c=TP.sys.getWindowById(TP.sys.getUICanvasName());}a=TP.isString(c)?TP.byId(c,TP.context(i)):TP.elem(c);b=TP.args(arguments,3);b.unshift(null);if(TP.isArray(a)){e=TP.ac();h=a.getSize();for(d=0;d<h;d++){g=a.at(d);if(TP.isElement(g)){if(TP.canInvoke(TP,f)){b[0]=g;e.push(TP[f].apply(TP,b));}else{break;}}}return e;}else if(TP.isValid(a)){b[0]=a;return TP[f].apply(TP,b);}return a;});TP.definePrimitive('$',function(a,d){var c,b;if(TP.notValid(a)){return TP.raise(this,'TP.sig.InvalidParameter',arguments);}if(!TP.isString(a)){return TP.wrap(a);}if(TP.isEmpty(a)){return null;}if(TP.isURI(a)){return TP.uc(a).getResource(TP.hc('async',false));}if(TP.regex.IS_ELEM_MARKUP.test(a)){return TP.wrap(TP.elem(a));}c=TP.context(d);if(TP.isEmpty(b=TP.nodeEvaluatePath(c,a,null,true))){if(TP.XML_IDREF.test(a)){b=TP.nodeGetElementById(TP.nodeGetDocument(c),a);}}b=TP.wrap(b);return b;});TP.definePrimitive('byContent',function(a,b,c){return TP.todo();});TP.definePrimitive('byCSS',function(a,c,d){var b;if(TP.notValid(a)){return TP.raise(TP.byCSS,'TP.sig.InvalidString',arguments,'Empty CSS expression not allowed.');}b=TP.context(c);return TP.nodeEvaluateCSS(b,a,d);});TP.definePrimitive('byId',function(a,h){var b,d,e,f,g,c;if(TP.notValid(a)){return TP.raise(TP.byId,'TP.sig.InvalidID',arguments,'Empty ID not allowed.');}if(TP.isNode(a)){return a;}if(TP.isWindow(a)){return a.document;}if(TP.isNodeList(a)){if(TP.isArray(a)){return a;}return TP.ac(a);}if(TP.regex.HAS_PERIOD.test(a)){TP.raise(TP.byId,'TP.sig.InvalidID',arguments,'Path-style IDs not allowed.');return;}b=TP.str(a);d=TP.context(h,TP.byId.$$context);e=TP.isString(b)?b.split(' '):b;f=e.getSize();if(f>1){g=TP.ac();for(c=0;c<f;c++){g.atPut(c,TP.nodeGetElementById(d,e.at(c)));}return g.compact();}else{return TP.nodeGetElementById(d,b,true);}});TP.definePrimitive('byJS',function(a,b,c){return TP.todo();});TP.definePrimitive('byOID',function(g,h){var a,c,d,e,f,b;a=TP.str(g);c=TP.context(h,TP.byOID.$$context);d=TP.isString(a)?a.split(' '):a;e=d.getSize();if(e>1){f=TP.ac();for(b=0;b<e;b++){f.atPut(b,TP.sys.getObjectById(d.at(b),false,c));}return f.compact();}else{return TP.sys.getObjectById(a,false,c);}});TP.definePrimitive('byPath',function(a,c,d){var b;if(TP.notValid(a)){return TP.raise(TP.byPath,'TP.sig.InvalidString',arguments,'Empty path expression not allowed.');}b=TP.context(c);return TP.nodeEvaluatePath(b,a,null,d);});TP.definePrimitive('addAttr',function(a,b,c,d,e){return TP.tpcall('elementAddAttributeValue',a,e,b,c,d);});TP.definePrimitive('getAttr',function(a,b,c,d){return TP.tpcall('elementGetAttribute',a,d,b,c);});TP.definePrimitive('hasAttr',function(a,b,c,d){return TP.tpcall('elementHasAttribute',a,d,b,c);});TP.definePrimitive('removeAttr',function(a,b,c,d){return TP.tpcall('elementRemoveAttribute',a,d,b,c);});TP.definePrimitive('replaceAttr',function(a,b,c,d,e,f){return TP.tpcall('elementReplaceAttributeValue',a,f,b,c,d,e);});TP.definePrimitive('setAttr',function(a,b,c,d,e){return TP.tpcall('elementSetAttribute',a,e,b,c,d);});TP.definePrimitive('toggleAttr',function(a,b,c){var d;d=TP.bc(TP.getAttr(a,c,b));if(d){return TP.tpcall('elementSetAttribute',a,c,b,'false');}else{return TP.tpcall('elementSetAttribute',a,c,b,'true');}});TP.definePrimitive('addClass',function(a,b,c){return TP.tpcall('elementAddClass',a,c,b);});TP.definePrimitive('getClass',function(a,b){return TP.tpcall('elementGetClass',a,b);});TP.definePrimitive('hasClass',function(a,b,c){return TP.tpcall('elementHasClass',a,c,b);});TP.definePrimitive('removeClass',function(a,b,c){return TP.tpcall('elementRemoveClass',a,c,b);});TP.definePrimitive('replaceClass',function(a,b,c,d){return TP.tpcall('elementReplaceClass',a,d,b,c);});TP.definePrimitive('setClass',function(a,b,c){return TP.tpcall('elementSetClass',a,c,b);});TP.definePrimitive('toggleClass',function(a,b,c){if(TP.hasClass(a,c,b)){return TP.tpcall('elementRemoveClass',a,c,b);}else{return TP.tpcall('elementAddClass',a,c,b);}});TP.definePrimitive('addContent',function(a,b,c,d){return TP.idcall('addContent',a,d,b,c);});TP.definePrimitive('getContent',function(a,b){return TP.idcall('getContent',a,b);});TP.definePrimitive('insertContent',function(a,b,c,d,e){return TP.idcall('insertContent',a,e,b,c,d);});TP.definePrimitive('removeContent',function(a,b){return TP.idcall('empty',a,b);});TP.definePrimitive('setContent',function(a,b,c,d){return TP.idcall('setContent',a,d,b,c);});TP.definePrimitive('removeElem',function(e,f){var a,d,c,b;a=TP.byId(e,TP.context(f));if(TP.isArray(a)){d=a.length;for(c=0;c<d;c++){b=a[c].parentNode;if(TP.isElement(b)){return TP.nodeRemoveChild(b,a[c]);}}}else{b=a.parentNode;if(TP.isElement(b)){return TP.nodeRemoveChild(b,a);}}});TP.definePrimitive('replaceElem',function(f,g,d){var a,b,e,c;a=TP.byId(f,TP.context(d));b=TP.byId(g,TP.context(d));if(TP.isArray(b)){return TP.raise(this,'TP.sig.InvalidParameter',arguments,'New element must be single ID or element');}if(TP.isArray(a)){e=a.length;for(c=0;c<e;c++){return TP.elementReplaceWith(a[c],TP.nodeCloneNode(b));}}else{return TP.elementReplaceWith(a,b);}});TP.definePrimitive('addStyle',function(a,b,c,d){return TP.tpcall('elementAddStyle',a,d,b,c);});TP.definePrimitive('getStyle',function(a,b,c){return TP.tpcall('elementGetStyle',a,c,b);});TP.definePrimitive('hasStyle',function(a,b,c){return TP.tpcall('elementHasStyle',a,c,b);});TP.definePrimitive('preserveStyle',function(a,b){return TP.tpcall('elementPreserveStyle',a,b);});TP.definePrimitive('removeStyle',function(a,b,c){return TP.tpcall('elementRemoveStyle',a,c,b);});TP.definePrimitive('replaceStyle',function(a,b,c,d,e){return TP.tpcall('elementReplaceStyle',a,e,b,c,d);});TP.definePrimitive('restoreStyle',function(a,b){return TP.tpcall('elementRestoreStyle',a,b);});TP.definePrimitive('setStyle',function(a,b,c,d){return TP.tpcall('elementSetStyle',a,d,b,c);});TP.definePrimitive('animate',function(a,d,e,f){var b,c;if(TP.isString(a)){b=TP.byId(a,TP.context(f));}else{b=a;}c=TP.core.CSSPropertyTransition.transition(b,d,e);return c;});TP.definePrimitive('effect',function(h,a,l,m){var e,k,j,c,f,d,i,g,b;e=a.asStartUpper()+'Effect';if(TP.notValid(k=e.asType())){e='TP.core.'+a.asStartUpper()+'Effect';if(TP.notValid(k=e.asType())){TP.raise(TP.effect,'TP.sig.InvalidType',arguments,e);return;}}if(TP.isValid(l)){j=TP.core.Job.splitParams(l);c=j.first();f=j.last();}else{c=TP.hc();f=TP.hc();}if(TP.isCallable(d=c.at('compute'))&&!TP.isCallable(d)){d=TP.core.Job[d];if(!TP.isCallable(d)){TP.raise(TP.effect,'TP.sig.InvalidFunction',arguments,c.at('compute'));return;}c.atPut('compute',d);}if(TP.isString(h)){b=TP.byId(h,TP.context(m));}else{b=h;}f.atPut('target',b);if(!TP.isArray(b)){b=TP.ac(b);}i=k.construct(c,f);g=i.get('transitionJob');g.set('post',function(g,d){var b,e,f;if(TP.isEmpty(b=d.at('target'))){return;}if(TP.isCallable(e=c.at('post'))){e(g,d);}if(TP.isArray(b)){b.perform(function(b){if(TP.isValid(b['effect_'+a])){b['effect_'+a]=null;}});f=TP.documentGetBody(TP.nodeGetDocument(b.first())).offsetHeight;}else{if(TP.isValid(b['effect_'+a])){b['effect_'+a]=null;}f=TP.documentGetBody(TP.nodeGetDocument(b)).offsetHeight;}});b.perform(function(e){var d,f,b,c;if(TP.isValid(d=e['effect_'+a])&&!d.didComplete()){if(TP.isValid(f=d.$get('parameters'))&&TP.isArray(b=f.at('target'))&&b.length>1){for(c=0;c<b.length;c++){if(b[c]===e){b.splice(c,1);break;}}}else{d.shutdown();}}e['effect_'+a]=g;});i.start(f);return g;});TP.definePrimitive('arm',function(i,a,l,k,j){var g,h,e,f,d,c,b;if(TP.isEmpty(a)){TP.raise(this,'TP.sig.InvalidParameter',arguments,'Must supply a Signal.');return;}g=TP.ifInvalid(i,TP.ANY);h=TP.context(j);e=/ /.test(a)?a.split(' '):TP.isArray(a)?a:TP.ac(a);f=e.getSize();for(d=0;d<f;d++){c=e.at(d);if(TP.isString(c)){b=TP.sys.require(c);}else{b=c;}if(TP.canInvoke(b,'arm')){b.arm(g,l,k,h);}}return;});TP.definePrimitive('button',function(a){return TP.eventGetButton(a);});TP.definePrimitive('coord',function(a,c){var b;if(TP.isEvent(a)){return TP.eventGetPageXY(a);}if(TP.isArray(a)){return a;}if(TP.isKindOf(a,TP.lang.Hash)||TP.isKindOf(a,TP.core.Point)){return TP.ac(a.at('x'),a.at('y'));}b=TP.isString(a)?TP.byId(a,TP.context(c)):TP.elem(a);if(TP.isElement(b)){return TP.elementGetPageXY(b);}return null;});TP.definePrimitive('disarm',function(i,a,k,j){var f,h,e,g,d,c,b;if(TP.isEmpty(a)){TP.raise(this,'TP.sig.InvalidParameter',arguments,'Must supply a Signal.');return;}f=TP.ifInvalid(i,TP.ANY);h=TP.context(j);e=/ /.test(a)?a.split(' '):TP.isArray(a)?a:TP.ac(a);g=e.getSize();for(d=0;d<g;d++){c=e.at(d);if(TP.isString(c)){b=TP.sys.require(c);}else{b=c;}if(TP.canInvoke(b,'disarm')){b.disarm(f,k,h);}}return;});TP.definePrimitive('event',function(a){return TP.eventNormalize(a||window.event);});TP.definePrimitive('keyname',function(a){return TP.core.Keyboard.getEventVirtualKey(a);});TP.definePrimitive('domkeysigname',function(a){return TP.core.Keyboard.getDOMSignalName(a);});TP.definePrimitive('wheel',function(a){return TP.eventGetWheelDelta(a);});TP.definePrimitive('compact',function(a,b){if(TP.canInvoke(a,'compact')){return a.compact(b);}return a;});TP.definePrimitive('elemget',function(f,g,h){var c,a,d,e,b;c=g||'value';a=TP.byId(f,h);if(TP.isArray(a)){d=TP.ac();e=a.getSize();for(b=0;b<e;b++){d.push(TP.val(a.at(b),c));}return d;}else{return TP.val(a,c);}});TP.definePrimitive('elemset',function(g,h,d,i){var b,a,f,e,c;b=h||'value';a=TP.byId(g,i);if(TP.isArray(a)){f=a.getSize();for(e=0;e<f;e++){c=TP.wrap(a.at(e));if(TP.canInvoke(c,'set')){c.set(b,d);}else if(TP.canInvoke(c,'atPut')){c.atPut(b,d);}else if(!TP.isXMLNode(c)){try{c[b]=d;}catch(a){}}else{}}}else{a=TP.wrap(a);if(TP.canInvoke(a,'set')){a.set(b,d);}else if(TP.canInvoke(a,'atPut')){a.atPut(b,d);}else if(!TP.isXMLNode(a)){try{a[b]=d;}catch(a){}}else{}}return a;});TP.definePrimitive('focus',function(a,b){return TP.idcall('focus',a,b);});TP.definePrimitive('reset',function(a,b){return TP.idcall('reset',a,b);});TP.definePrimitive('select',function(a,b){return TP.idcall('select',a,b);});TP.definePrimitive('submit',function(a,b){return TP.idcall('submit',a,b);});TP.definePrimitive('dump',function(a){var e,c,d,b,f;if(a===null){return'null';}else if(a===undefined){return'undefined';}if(TP.isXHR(a)){return TP.tname(a)+' :: '+a.status+' : '+a.responseText;}if(TP.isNode(a)){return TP.tname(a)+' :: '+TP.nodeAsString(a);}if(TP.isError(a)){return TP.tname(a)+' :: '+TP.errorAsString(a);}if(TP.isString(a)){return a;}if(!TP.isMutable(a)){return TP.objectToString(a);}if(TP.isWindow(a)){return TP.tname(a)+' :: '+TP.windowAsString(a);}if(TP.isEvent(a)){return TP.tname(a)+' :: '+TP.eventAsString(a);}if(TP.isNodeList(a)){c=TP.ac();d=a.length;for(b=0;b<d;b++){c.push(TP.str(a[b]));}return TP.tname(a)+' :: '+'['+c.join(', ')+']';}if(TP.isNamedNodeMap(a)){c=TP.ac();d=a.length;for(b=0;b<d;b++){c.push(TP.name(a.item(b))+': '+TP.val(a.item(b)));}return TP.tname(a)+' :: '+'{'+c.join(', ')+'}';}if(TP.isStyleSheet(a)){f=TP.styleSheetGetStyleRules(a,false);c=TP.ac();d=f.length;for(b=0;b<d;b++){c.push(f[b].cssText);}return TP.tname(a)+' :: '+c.join(' ');}if(TP.isStyleRule(a)){return TP.tname(a)+' :: '+a.cssText;}if(TP.isStyleDeclaration(a)){return TP.tname(a)+' :: '+a.cssText;}if(TP.canInvoke(a,'asDumpString')){e=a.asDumpString();if(TP.regex.NATIVE_CODE.test(e)){e=TP.tname(a);}return e;}return TP.src(a);});TP.definePrimitive('inspect',function(a){var b;b=TP.wrap(a);if(b!==a){if(TP.canInvoke(a,'asInspectString')){return a.asInspectString();}}if(TP.canInvoke(a,'asInspectString')){return a.asInspectString();}return TP.src(a);});TP.definePrimitive('link',function(f,c,g,h){var a,b,d,e;a=TP.uri(f);if(TP.isString(c)){b=TP.trim(c);}else if(TP.isKindOf(a,TP.core.URN)){b=a.getName();}else{b=a.getLocation();}e=TP.stringAsHTMLAttribute(g).quoted('"');d=TP.join('<a href="#" ','title=',e,' ','onclick="TP.shell(','\'',h||':edit ',a.getLocation(),'\'',', false, false, false, null); return false;">',b,'</a>');return d;});TP.definePrimitive('pretty',function(a){var f,e,c,d,b,g;if(a===null){return'<dl class="pretty Null"><dt/><dd>null</dd></dl>';}else if(a===undefined){return'<dl class="pretty Undefined"><dt/><dd>undefined</dd></dl>';}if(TP.isXHR(a)){try{f=a.status;}catch(a){f='none';}return'<dl class="pretty '+TP.escapeTypeName(TP.tname(a))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+TP.tname(a)+'</dd>'+'<dt class="pretty key">Status</dt>'+'<dd class="pretty value">'+f+'</dd>'+'<dt class="pretty key">Response text</dt>'+'<dd class="pretty value">'+TP.str(a.responseText).asEscapedXML()+'</dd>'+'</dl>';}if(TP.isNode(a)){return'<dl class="pretty '+TP.escapeTypeName(TP.tname(a))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+TP.tname(a)+'</dd>'+'<dt class="pretty key">Content</dt>'+'<dd class="pretty value">'+TP.nodeAsString(a).asEscapedXML()+'</dd>'+'</dl>';}if(TP.isError(a)){return'<dl class="pretty '+TP.escapeTypeName(TP.tname(a))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+TP.tname(a)+'</dd>'+'<dt class="pretty key">Message</dt>'+'<dd class="pretty value">'+TP.str(a.message)+'</dd>'+'</dl>';}if(TP.isString(a)||TP.isNumber(a)||TP.isBoolean(a)){return a.asPrettyString();}if(!TP.isMutable(a)){return TP.objectToString(a);}if(TP.isWindow(a)){return TP.windowAsPrettyString(a);}if(TP.isEvent(a)){return TP.eventAsPrettyString(a);}if(TP.isNodeList(a)){c=TP.ac();d=a.length;for(b=0;b<d;b++){c.push('<dt class="pretty key">',b,'</dt>','<dd class="pretty value">',TP.nodeAsString(a[b]).asEscapedXML(),'</dd>');}return'<dl class="pretty '+TP.escapeTypeName(TP.tname(a))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+TP.tname(a)+'</dd>'+c.join('')+'</dl>';}if(TP.isNamedNodeMap(a)){c=TP.ac();d=a.length;for(b=0;b<d;b++){c.push('<dt class="pretty key">',TP.name(a.item(b)),'</dt>','<dd class="pretty value">',TP.val(a.item(b)),'</dd>');}return'<dl class="pretty '+TP.escapeTypeName(TP.tname(a))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+TP.tname(a)+'</dd>'+c.join('')+'</dl>';}if(TP.isStyleSheet(a)){g=TP.styleSheetGetStyleRules(a,false);c=TP.ac();d=g.length;for(b=0;b<d;b++){c.push('<dt class="pretty key">',b,'</dt>','<dd class="pretty value">',g[b].cssText,'</dd>');}return'<dl class="pretty '+TP.escapeTypeName(TP.tname(a))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+TP.tname(a)+'</dd>'+c.join('')+'</dl>';}if(TP.isStyleRule(a)){return'<dl class="pretty '+TP.escapeTypeName(TP.tname(a))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+TP.tname(a)+'</dd>'+'<dt class="pretty key">Content</dt>'+'<dd class="pretty value">'+a.cssText+'</dd>'+'</dl>';}if(TP.isStyleDeclaration(a)){return'<dl class="pretty '+TP.escapeTypeName(TP.tname(a))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+TP.tname(a)+'</dd>'+'<dt class="pretty key">Content</dt>'+'<dd class="pretty value">'+a.cssText+'</dd>'+'</dl>';}if(TP.canInvoke(a,'asPrettyString')){e=a.asPrettyString();if(TP.regex.NATIVE_CODE.test(e)){e=TP.tname(a);}return e;}return TP.htmlstr(a);});TP.definePrimitive('print',function(a){var b;b=TP.wrap(a);if(b!==a){if(TP.canInvoke(a,'asPrintString')){return a.asPrintString();}}if(TP.canInvoke(a,'asPrintString')){return a.asPrintString();}return TP.htmlstr(a);});TP.definePrimitive('recursion',function(a){var b;b=TP.wrap(a);if(b!==a){if(TP.canInvoke(a,'asRecursionString')){return a.asRecursionString();}}if(TP.canInvoke(a,'asRecursionString')){return a.asRecursionString();}return TP.dump(a);});TP.definePrimitive('reflect',function(c,h,f,g,d){var e,a,b;if(TP.notValid(c)){return TP.ac();}if(TP.canInvoke(c,'getInterface')){e=TP.isTrue(g)?'known_':'';e+=TP.isString(f)?f+'_':'';e+=h||'methods';a=c.getInterface(e);}else{a=TP.ac();for(b in c){if(TP.regex.INTERNAL_SLOT.test(b)){continue;}if(TP.notTrue(g)&&TP.regex.PRIVATE_SLOT.test(b)){continue;}if(!TP.isGlobal(b,true)){a.push(b);}}}a.sort();if(TP.isFunction(d)){return a.select(d);}else if(TP.isValid(d)){return a.grep(d);}return a;});TP.definePrimitive('contains',function(a,b){if(TP.notValid(a)){return false;}if(TP.canInvoke(a,'contains')){return a.contains(b);}return false;});TP.definePrimitive('chain',function(c,d){var b,a;if(TP.isNode(c)){return TP.nodeSelectChain(c,d);}b=TP.ac();if(TP.isEmpty(d)){return b;}a=c;while(TP.isValid(a)){a=TP.val(a,d);if(TP.notValid(a)){break;}b.push(a);}return b;});TP.definePrimitive('go2',function(a,e,f){var b,c,d;if(TP.notValid(a)){TP.raise(TP.go2,'TP.sig.InvalidURI',arguments);return false;}if(TP.notValid(b=f)){b=TP.ifInvalid(TP.sys.getWindowById(TP.sys.getUICanvasName()),window);}c=TP.sys.getTypeByName('TP.core.Window');if(TP.notValid(d=c.construct(TP.gid(b)))){TP.raise(TP.go2,'TP.sig.InvalidWindow',arguments);return false;}TP.sys.logLink(a,TP.INFO,arguments);d.setContent(TP.uc(a),e);return false;});TP.definePrimitive('handle',function(c,a,e,f){var d,b;b=TP.ifEmpty(e,'handle');d=TP.ifInvalid(f,false);if(!TP.canInvoke(c,b)){TP.ifWarn(!d&&TP.sys.shouldLogSignals())?TP.warn(TP.boot.$annotate(c,'Direct '+b+' invocation failed.'),TP.SIGNAL_LOG,arguments):0;return;}if(TP.notValid(a)){TP.ifWarn(!d&&TP.sys.shouldLogSignals())?TP.warn(TP.join('Direct ',b,' invocation failed. ','No signal name or instance provided.'),TP.SIGNAL_LOG,arguments):0;return;}if(a.isIgnoring(c)||a.isIgnoring(c[b])){return;}$signal_stack.push(a);$signal=a;try{return c[b](a);}catch(a){TP.ifError()?TP.error(TP.ec(a,'Handler invocation error.'),TP.LOG,arguments):0;}finally{$signal=$signal_stack.pop();}return;});TP.definePrimitive('xhr',function(c){var a,b;TP.sys.require('TP.core.RESTService');a=TP.lang.Hash.construct.apply(TP.lang.Hash,arguments);b=TP.sys.require('TP.sig.RESTRequest').construct(a);return b;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETHousekeeping.js';
TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('tibet_boot.js');TP.boot.defineMethod('$$importAsync',TP.boot.$$importAsync);TP.sys.defineMethod('hasLoaded',TP.sys.hasLoaded);TP.sys.defineMethod('hasKernel',TP.sys.hasKernel);TP.sys.defineMethod('hasInitialized',TP.sys.hasInitialized);TP.sys.defineMethod('hasStarted',TP.sys.hasStarted);TP.boot.defineMethod('$$getprop',TP.boot.$$getprop);TP.boot.defineMethod('$$setprop',TP.boot.$$setprop);TP.sys.defineMethod('cfg',TP.sys.cfg);TP.sys.defineMethod('getcfg',TP.sys.getcfg);TP.sys.defineMethod('setcfg',TP.sys.setcfg);TP.sys.defineMethod('env',TP.sys.env);TP.boot.defineMethod('$getenv',TP.boot.$getenv);TP.boot.defineMethod('$$setenv',TP.boot.$$setenv);TP.sys.defineMethod('hasFeature',TP.sys.hasFeature);TP.sys.defineMethod('hasPackage',TP.sys.hasPackage);TP.sys.defineMethod('defineGlobal',TP.sys.defineGlobal);TP.boot.defineMethod('$alert',TP.boot.$alert);TP.boot.defineMethod('$prompt',TP.boot.$prompt);TP.boot.defineMethod('$confirm',TP.boot.$confirm);TP.boot.defineMethod('$notify',TP.boot.$notify);TP.boot.defineMethod('$stderr',TP.boot.$stderr);TP.boot.defineMethod('$stdin',TP.boot.$stdin);TP.boot.defineMethod('$stdout',TP.boot.$stdout);TP.boot.defineMethod('$raise',TP.boot.$raise);TP.boot.defineMethod('isMac',TP.boot.isMac);TP.boot.defineMethod('isNix',TP.boot.isNix);TP.boot.defineMethod('isWin',TP.boot.isWin);TP.boot.defineMethod('isUA',TP.boot.isUA);if(TP.boot.isUA('IE')){TP.boot.defineMethod('isMSXML',TP.boot.isMSXML);}TP.boot.defineMethod('isSupported',TP.boot.isSupported);TP.sys.defineMethod('isHTTPBased',TP.sys.isHTTPBased);TP.sys.defineMethod('getLaunchRoot',TP.sys.getLaunchRoot);TP.sys.defineMethod('getHost',TP.sys.getHost);TP.sys.defineMethod('getPathname',TP.sys.getPathname);TP.sys.defineMethod('getPort',TP.sys.getPort);TP.sys.defineMethod('getScheme',TP.sys.getScheme);TP.boot.defineMethod('$httpCreate',TP.boot.$httpCreate);TP.boot.defineMethod('$httpError',TP.boot.$httpError);TP.boot.defineMethod('$httpCall',TP.boot.$httpCall);TP.boot.defineMethod('$uriCollapsePath',TP.boot.$uriCollapsePath);TP.boot.defineMethod('$uriExpandPath',TP.boot.$uriExpandPath);TP.boot.defineMethod('$uriInLocalFormat',TP.boot.$uriInLocalFormat);TP.boot.defineMethod('$uriJoinPaths',TP.boot.$uriJoinPaths);TP.boot.defineMethod('$uriMinusFileScheme',TP.boot.$uriMinusFileScheme);TP.boot.defineMethod('$uriPlusFileScheme',TP.boot.$uriPlusFileScheme);TP.boot.defineMethod('$uriRelativeToPath',TP.boot.$uriRelativeToPath);TP.boot.defineMethod('$uriResult',TP.boot.$uriResult);TP.boot.defineMethod('$uriResultType',TP.boot.$uriResultType);TP.boot.defineMethod('$uriWithRoot',TP.boot.$uriWithRoot);TP.boot.defineMethod('$uriLocation',TP.boot.$uriLocation);TP.boot.defineMethod('$uriLocationFile',TP.boot.$uriLocationFile);TP.boot.defineMethod('$uriLocationHttp',TP.boot.$uriLocationHttp);TP.boot.defineMethod('$uriLastModified',TP.boot.$uriLastModified);TP.boot.defineMethod('$uriLastModifiedIEFile',TP.boot.$uriLastModifiedIEFile);TP.boot.defineMethod('$uriLastModifiedMozFile',TP.boot.$uriLastModifiedMozFile);TP.boot.defineMethod('$uriLastModifiedHttp',TP.boot.$uriLastModifiedHttp);TP.boot.defineMethod('$uriCurrent',TP.boot.$uriCurrent);TP.boot.defineMethod('$uriExists',TP.boot.$uriExists);TP.boot.defineMethod('$uriExistsFile',TP.boot.$uriExistsFile);TP.boot.defineMethod('$uriExistsHttp',TP.boot.$uriExistsHttp);TP.boot.defineMethod('$uriLoad',TP.boot.$uriLoad);TP.boot.defineMethod('$uriLoadCommonFile',TP.boot.$uriLoadCommonFile);TP.boot.defineMethod('$uriLoadIEFile',TP.boot.$uriLoadIEFile);TP.boot.defineMethod('$uriLoadMozFile',TP.boot.$uriLoadMozFile);TP.boot.defineMethod('$uriLoadCommonHttp',TP.boot.$uriLoadCommonHttp);TP.boot.defineMethod('$sourceImport',TP.boot.$sourceImport);TP.boot.defineMethod('$uriImport',TP.boot.$uriImport);TP.boot.defineMethod('$uriSave',TP.boot.$uriSave);TP.boot.defineMethod('$uriSaveIEFile',TP.boot.$uriSaveIEFile);TP.boot.defineMethod('$uriSaveMozFile',TP.boot.$uriSaveMozFile);TP.boot.defineMethod('$uriSaveWebkitFile',TP.boot.$uriSaveWebkitFile);TP.boot.defineMethod('$uriSaveHttp',TP.boot.$uriSaveHttp);TP.boot.defineMethod('$escapeStorageName',TP.boot.$escapeStorageName);TP.boot.defineMethod('$initializeLocalStorage',TP.boot.$initializeLocalStorage);TP.boot.defineMethod('$setupDOMStorage',TP.boot.$setupDOMStorage);TP.boot.defineMethod('$documentCreate',TP.boot.$documentCreate);TP.boot.defineMethod('$documentCreateIE',TP.boot.$documentCreateIE);TP.boot.defineMethod('$nodeAppendChild',TP.boot.$nodeAppendChild);TP.boot.defineMethod('$nodeInsertBefore',TP.boot.$nodeInsertBefore);TP.boot.defineMethod('$nodeReplaceChild',TP.boot.$nodeReplaceChild);TP.boot.defineMethod('$documentFromString',TP.boot.$documentFromString);TP.boot.defineMethod('$documentFromStringCommon',TP.boot.$documentFromStringCommon);TP.boot.defineMethod('$documentFromStringIE',TP.boot.$documentFromStringIE);TP.boot.defineMethod('$nodeAsString',TP.boot.$nodeAsString);TP.boot.defineMethod('$nodeAsStringCommon',TP.boot.$nodeAsStringCommon);TP.boot.defineMethod('$nodeAsStringIE',TP.boot.$nodeAsStringIE);TP.sys.defineMethod('getWindowById',TP.sys.getWindowById);TP.definePrimitive('windowIsInstrumented',TP.windowIsInstrumented);TP.boot.defineMethod('$elementAddClass',TP.boot.$elementAddClass);TP.boot.defineMethod('$elementSetInnerContent',TP.boot.$elementSetInnerContent);TP.boot.defineMethod('$dump',TP.boot.$dump);TP.boot.defineMethod('$trim',TP.boot.$trim);TP.boot.defineMethod('$currentDocumentLocation',TP.boot.$currentDocumentLocation);TP.boot.defineMethod('$annotate',TP.boot.$annotate);TP.boot.defineMethod('$ec',TP.boot.$ec);TP.boot.defineMethod('$join',TP.boot.$join);TP.boot.defineMethod('$str',TP.boot.$str);TP.sys.defineMethod('getBootLog',TP.sys.getBootLog);TP.boot.defineMethod('log',TP.boot.log);TP.boot.defineMethod('$releaseUIElements',TP.boot.$releaseUIElements);TP.boot.defineMethod('$getProgressBarElement',TP.boot.$getProgressBarElement);TP.boot.defineMethod('$setStage',TP.boot.$setStage);TP.boot.defineMethod('$getAppRoot',TP.boot.$getAppRoot);TP.boot.defineMethod('$getLibRoot',TP.boot.$getLibRoot);TP.boot.defineMethod('$getRootPath',TP.boot.$getRootPath);TP.boot.defineMethod('$setAppRoot',TP.boot.$setAppRoot);TP.boot.defineMethod('$setLibRoot',TP.boot.$setLibRoot);TP.boot.defineMethod('$configureEnvironment',TP.boot.$configureEnvironment);TP.boot.defineMethod('$configureLocalCache',TP.boot.$configureLocalCache);TP.boot.defineMethod('$configureVersionedCache',TP.boot.$configureVersionedCache);TP.boot.defineMethod('$ifUnlessPassed',TP.boot.$ifUnlessPassed);TP.boot.defineMethod('$getElementCount',TP.boot.$getElementCount);TP.boot.defineMethod('$uniqueNodeList',TP.boot.$uniqueNodeList);TP.boot.defineMethod('$importApplication',TP.boot.$importApplication);TP.boot.defineMethod('$importComponents',TP.boot.$importComponents);TP.sys.defineMethod('showBootLog',TP.sys.showBootLog);TP.boot.defineMethod('boot',TP.boot.boot);TP.boot.defineMethod('$config',TP.boot.$config);TP.boot.defineMethod('launch',TP.boot.launch);TP.boot.defineMethod('main',TP.boot.main);TP.defineGlobalMethod('$$getNextWindow',$$getNextWindow);TP.defineGlobalMethod('$$findTIBET',$$findTIBET);TP.defineGlobalMethod('$$init',$$init);TP.sys.defineGlobal('$$checked',null);TP.sys.defineGlobal('$$TIBET',null);TP.sys.defineGlobal('$$tibet',null);TP.sys.defineGlobal('$$autoboot',null);TP.sys.defineGlobal('$$phasetwo',null);TP.boot.defineMethod('$isElement',TP.boot.$isElement);TP.boot.defineMethod('$isEmpty',TP.boot.$isEmpty);TP.boot.defineMethod('$isEvent',TP.boot.$isEvent);TP.boot.defineMethod('$isTrue',TP.boot.$isTrue);TP.boot.defineMethod('$isValid',TP.boot.$isValid);TP.boot.defineMethod('$isWindow',TP.boot.$isWindow);TP.boot.defineMethod('$notValid',TP.boot.$notValid);TP.boot.defineMethod('$formatCookieSource',TP.boot.$formatCookieSource);TP.boot.defineMethod('getCookie',TP.boot.getCookie);TP.boot.defineMethod('setCookie',TP.boot.setCookie);TP.boot.defineMethod('$byId',TP.boot.$byId);TP.boot.defineMethod('hideContent',TP.boot.hideContent);TP.boot.defineMethod('hideUICanvas',TP.boot.hideUICanvas);TP.boot.defineMethod('hideUIRoot',TP.boot.hideUIRoot);TP.boot.defineMethod('launchApp',TP.boot.launchApp);TP.boot.defineMethod('showBootLog',TP.boot.showBootLog);TP.boot.defineMethod('showContent',TP.boot.showContent);TP.boot.defineMethod('showUICanvas',TP.boot.showUICanvas);TP.boot.defineMethod('showUIRoot',TP.boot.showUIRoot);TP.boot.defineMethod('startGUI',TP.boot.startGUI);TP.boot.defineMethod('autoBoot',TP.boot.autoBoot);TP.boot.defineMethod('initializeCanvas',TP.boot.initializeCanvas);TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETGlobals.js');TP.sys.defineMethod('defineGlobal',TP.sys.defineGlobal);TP.sys.defineMethod('getGlobals',TP.sys.getGlobals);TP.definePrimitive('LOG_ARGS',TP.LOG_ARGS);TP.definePrimitive('NOTIFY_ARGS',TP.NOTIFY_ARGS);TP.definePrimitive('TEST_HANDLER',TP.TEST_HANDLER);TP.definePrimitive('RETURN_NULL',TP.RETURN_NULL);TP.definePrimitive('RETURN_THIS',TP.RETURN_THIS);TP.definePrimitive('RETURN_TRUE',TP.RETURN_TRUE);TP.definePrimitive('RETURN_FALSE',TP.RETURN_FALSE);TP.definePrimitive('RETURN_ARG0',TP.RETURN_ARG0);TP.definePrimitive('RETURN_ARGS',TP.RETURN_ARGS);TP.definePrimitive('RETURN_FIRST',TP.RETURN_FIRST);TP.definePrimitive('RETURN_LAST',TP.RETURN_LAST);TP.definePrimitive('RETURN_EMPTY',TP.RETURN_EMPTY);TP.definePrimitive('RETURN_SPACE',TP.RETURN_SPACE);TP.definePrimitive('RETURN_ORIG',TP.RETURN_ORIG);TP.definePrimitive('RETURN_NEW',TP.RETURN_NEW);TP.definePrimitive('RETURN_TOSTRING',TP.RETURN_TOSTRING);TP.definePrimitive('CASE_INSENSITIVE_SORT',TP.CASE_INSENSITIVE_SORT);TP.definePrimitive('NATURAL_ORDER_SORT',TP.NATURAL_ORDER_SORT);TP.definePrimitive('COMPARE_SORT',TP.COMPARE_SORT);TP.definePrimitive('DELETION_SORT',TP.DELETION_SORT);TP.definePrimitive('DOCUMENT_ORDER_SORT',TP.DOCUMENT_ORDER_SORT);TP.definePrimitive('EQUALITY_SORT',TP.EQUALITY_SORT);TP.definePrimitive('FIRST_ITEM_SORT',TP.FIRST_ITEM_SORT);TP.definePrimitive('IDENTITY_SORT',TP.IDENTITY_SORT);TP.definePrimitive('NUMERIC_SORT',TP.NUMERIC_SORT);TP.definePrimitive('SECOND_ITEM_SORT',TP.SECOND_ITEM_SORT);TP.definePrimitive('SUBTYPE_SORT',TP.SUBTYPE_SORT);TP.definePrimitive('UNICODE_SORT',TP.UNICODE_SORT);TP.definePrimitive('ELEMENT_SORT',TP.ELEMENT_SORT);TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETVersion.js');TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETPrimitivesPre.js');TP.definePrimitive('objectSetLoadNode',TP.objectSetLoadNode);TP.sys.defineGlobal(TP.ID,null);TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETPrimitivesBase.js');if(TP.boot.isUA('GECKO')){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETPrimitivesGecko.js');}else if(TP.boot.isUA('IE')){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETPrimitivesIE.js');}else if(TP.boot.isUA('WEBKIT')){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETPrimitivesWebkit.js');}TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETPrimitivesPost.js');TP.sys.defineGlobal('$$globalID',null);TP.boot.defineMethod('$configurePluginEnvironment',TP.boot.$configurePluginEnvironment);TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDOMPrimitivesPre.js');TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDOMPrimitivesBase.js');if(TP.boot.isUA('GECKO')){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDOMPrimitivesGecko.js');}else if(TP.boot.isUA('IE')){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDOMPrimitivesIE.js');}else if(TP.boot.isUA('WEBKIT')){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDOMPrimitivesWebkit.js');}TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDOMPrimitivesPost.js');TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDevicePrimitivesPre.js');TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDevicePrimitivesBase.js');if(TP.boot.isUA('GECKO')){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDevicePrimitivesGecko.js');}else if(TP.boot.isUA('IE')){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDevicePrimitivesIE.js');}else if(TP.boot.isUA('WEBKIT')){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDevicePrimitivesWebkit.js');}TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDevicePrimitivesPost.js');TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDHTMLPrimitivesPre.js');TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDHTMLPrimitivesBase.js');if(TP.boot.isUA('GECKO')){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDHTMLPrimitivesGecko.js');}else if(TP.boot.isUA('IE')){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDHTMLPrimitivesIE.js');}else if(TP.boot.isUA('WEBKIT')){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDHTMLPrimitivesWebkit.js');}TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETDHTMLPrimitivesPost.js');TP.sys.defineGlobal('$$instrumented',null);TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETGraphicsPrimitivesPre.js');TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETGraphicsPrimitivesBase.js');if(TP.boot.isUA('IE',8,TP.UP)){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETGraphicsPrimitivesIE.js');}if(TP.boot.isUA('IE')){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETStringPrimitivesIE.js');}TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETStringPrimitivesPost.js');TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETCSSPrimitivesPre.js');TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETCSSPrimitivesBase.js');if(TP.boot.isUA('GECKO')){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETCSSPrimitivesGecko.js');}else if(TP.boot.isUA('IE',8,TP.UP)){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETCSSPrimitivesIE.js');}else if(TP.boot.isUA('WEBKIT')){TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETCSSPrimitivesWebkit.js');}TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETCSSPrimitivesPost.js');TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETEncapsulation.js');TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETRegistration.js');TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETFoundation.js');TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETImportExport.js');TP.boot[TP.LOAD_NODE]=TP.uriGetLoadNode('TIBETPrimitivesShortcuts.js');TP.boot[TP.LOAD_NODE]=TP.BUILTIN_LOAD_NODE;Array.Type.defineMethod('isArray',Array.isArray);Array.Inst.defineMethod('concat',TP.ArrayProto.concat);Array.Inst.defineMethod('every',TP.ArrayProto.every);Array.Inst.defineMethod('filter',TP.ArrayProto.filter);Array.Inst.defineMethod('forEach',TP.ArrayProto.forEach);Array.Inst.defineMethod('indexOf',TP.ArrayProto.indexOf);Array.Inst.defineMethod('join',TP.ArrayProto.join);Array.Inst.defineMethod('lastIndexOf',TP.ArrayProto.lastIndexOf);Array.Inst.defineMethod('map',TP.ArrayProto.map);Array.Inst.defineMethod('pop',TP.ArrayProto.pop);Array.Inst.defineMethod('push',TP.ArrayProto.push);Array.Inst.defineMethod('reduce',TP.ArrayProto.reduce);Array.Inst.defineMethod('reduceRight',TP.ArrayProto.reduceRight);Array.Inst.defineMethod('reverse',TP.ArrayProto.reverse);Array.Inst.defineMethod('shift',TP.ArrayProto.shift);Array.Inst.defineMethod('slice',TP.ArrayProto.slice);Array.Inst.defineMethod('some',TP.ArrayProto.some);Array.Inst.defineMethod('sort',TP.ArrayProto.sort);Array.Inst.defineMethod('splice',TP.ArrayProto.splice);Array.Inst.defineMethod('toLocaleString',TP.ArrayProto.toLocaleString);Array.Inst.defineMethod('toString',TP.ArrayProto.toString);Array.Inst.defineMethod('unshift',TP.ArrayProto.unshift);Boolean.Inst.defineMethod('toString',TP.BooleanProto.toString);Boolean.Inst.defineMethod('valueOf',TP.BooleanProto.valueOf);Date.Type.defineMethod('now',Date.now);Date.Type.defineMethod('parse',Date.parse);Date.Type.defineMethod('UTC',Date.UTC);Date.Inst.defineMethod('getDate',TP.DateProto.getDate);Date.Inst.defineMethod('getDay',TP.DateProto.getDay);Date.Inst.defineMethod('getFullYear',TP.DateProto.getFullYear);Date.Inst.defineMethod('getHours',TP.DateProto.getHours);Date.Inst.defineMethod('getMilliseconds',TP.DateProto.getMilliseconds);Date.Inst.defineMethod('getMinutes',TP.DateProto.getMinutes);Date.Inst.defineMethod('getMonth',TP.DateProto.getMonth);Date.Inst.defineMethod('getSeconds',TP.DateProto.getSeconds);Date.Inst.defineMethod('getTime',TP.DateProto.getTime);Date.Inst.defineMethod('getTimezoneOffset',TP.DateProto.getTimezoneOffset);Date.Inst.defineMethod('getUTCDate',TP.DateProto.getUTCDate);Date.Inst.defineMethod('getUTCDay',TP.DateProto.getUTCDay);Date.Inst.defineMethod('getUTCFullYear',TP.DateProto.getUTCFullYear);Date.Inst.defineMethod('getUTCHours',TP.DateProto.getUTCHours);Date.Inst.defineMethod('getUTCMilliseconds',TP.DateProto.getUTCMilliseconds);Date.Inst.defineMethod('getUTCMinutes',TP.DateProto.getUTCMinutes);Date.Inst.defineMethod('getUTCMonth',TP.DateProto.getUTCMonth);Date.Inst.defineMethod('getUTCSeconds',TP.DateProto.getUTCSeconds);Date.Inst.defineMethod('getYear',TP.DateProto.getYear);Date.Inst.defineMethod('setDate',TP.DateProto.setDate);Date.Inst.defineMethod('setFullYear',TP.DateProto.setFullYear);Date.Inst.defineMethod('setHours',TP.DateProto.setHours);Date.Inst.defineMethod('setMilliseconds',TP.DateProto.setMilliseconds);Date.Inst.defineMethod('setMinutes',TP.DateProto.setMinutes);Date.Inst.defineMethod('setMonth',TP.DateProto.setMonth);Date.Inst.defineMethod('setSeconds',TP.DateProto.setSeconds);Date.Inst.defineMethod('setTime',TP.DateProto.setTime);Date.Inst.defineMethod('setUTCDate',TP.DateProto.setUTCDate);Date.Inst.defineMethod('setUTCFullYear',TP.DateProto.setUTCFullYear);Date.Inst.defineMethod('setUTCHours',TP.DateProto.setUTCHours);Date.Inst.defineMethod('setUTCMilliseconds',TP.DateProto.setUTCMilliseconds);Date.Inst.defineMethod('setUTCMinutes',TP.DateProto.setUTCMinutes);Date.Inst.defineMethod('setUTCMonth',TP.DateProto.setUTCMonth);Date.Inst.defineMethod('setUTCSeconds',TP.DateProto.setUTCSeconds);Date.Inst.defineMethod('setYear',TP.DateProto.setYear);Date.Inst.defineMethod('toDateString',TP.DateProto.toDateString);Date.Inst.defineMethod('toGMTString',TP.DateProto.toGMTString);Date.Inst.defineMethod('toISOString',TP.DateProto.toISOString);Date.Inst.defineMethod('toJSON',TP.DateProto.toJSON);Date.Inst.defineMethod('toLocaleDateString',TP.DateProto.toLocaleDateString);Date.Inst.defineMethod('toLocaleString',TP.DateProto.toLocaleString);Date.Inst.defineMethod('toLocaleTimeString',TP.DateProto.toLocaleTimeString);Date.Inst.defineMethod('toString',TP.DateProto.toString);Date.Inst.defineMethod('toTimeString',TP.DateProto.toTimeString);Date.Inst.defineMethod('toUTCString',TP.DateProto.toUTCString);Date.Inst.defineMethod('valueOf',TP.DateProto.valueOf);Function.Inst.defineMethod('apply',TP.FunctionProto.apply);Function.Inst.defineMethod('call',TP.FunctionProto.call);Function.Inst.defineMethod('toString',TP.FunctionProto.toString);Number.Inst.defineMethod('toExponential',TP.NumberProto.toExponential);Number.Inst.defineMethod('toFixed',TP.NumberProto.toFixed);Number.Inst.defineMethod('toLocaleString',TP.NumberProto.toLocaleString);Number.Inst.defineMethod('toPrecision',TP.NumberProto.toPrecision);Number.Inst.defineMethod('toString',TP.NumberProto.toString);Number.Inst.defineMethod('valueOf',TP.NumberProto.valueOf);Object.Type.defineMethod('create',Object.create);Object.Type.defineMethod('defineProperty',Object.defineProperty);Object.Type.defineMethod('defineProperties',Object.defineProperties);Object.Type.defineMethod('freeze',Object.freeze);Object.Type.defineMethod('getOwnPropertyDescriptor',Object.getOwnPropertyDescriptor);Object.Type.defineMethod('getOwnPropertyNames',Object.getOwnPropertyNames);Object.Type.defineMethod('getPrototypeOf',Object.getPrototypeOf);Object.Type.defineMethod('isExtensible',Object.isExtensible);Object.Type.defineMethod('isFrozen',Object.isFrozen);Object.Type.defineMethod('isSealed',Object.isSealed);Object.Type.defineMethod('keys',Object.keys);Object.Type.defineMethod('preventExtensions',Object.preventExtensions);Object.Type.defineMethod('seal',Object.seal);TP.defineMethod(TP.ObjectProto,'hasOwnProperty',TP.ObjectProto.hasOwnProperty,TP.INST_TRACK,false,'Object.Inst.hasOwnProperty',Object);TP.defineMethod(TP.ObjectProto,'isPrototypeOf',TP.ObjectProto.isPrototypeOf,TP.INST_TRACK,false,'Object.Inst.isPrototypeOf',Object);TP.defineMethod(TP.ObjectProto,'propertyIsEnumerable',TP.ObjectProto.propertyIsEnumerable,TP.INST_TRACK,false,'Object.Inst.propertIsEnumerable',Object);TP.defineMethod(TP.ObjectProto,'toLocaleString',TP.ObjectProto.toLocaleString,TP.INST_TRACK,false,'Object.Inst.toLocaleString',Object);TP.defineMethod(TP.ObjectProto,'toString',TP.ObjectProto.toString,TP.INST_TRACK,false,'Object.Inst.toString',Object);TP.defineMethod(TP.ObjectProto,'valueOf',TP.ObjectProto.valueOf,TP.INST_TRACK,false,'Object.Inst.valueOf',Object);RegExp.Inst.defineMethod('exec',TP.RegExpProto.exec);RegExp.Inst.defineMethod('test',TP.RegExpProto.test);RegExp.Inst.defineMethod('toString',TP.RegExpProto.toString);String.Type.defineMethod('fromCharCode',String.fromCharCode);String.Inst.defineMethod('anchor',TP.StringProto.anchor);String.Inst.defineMethod('big',TP.StringProto.big);String.Inst.defineMethod('blink',TP.StringProto.blink);String.Inst.defineMethod('bold',TP.StringProto.bold);String.Inst.defineMethod('fixed',TP.StringProto.fixed);String.Inst.defineMethod('fontcolor',TP.StringProto.fontcolor);String.Inst.defineMethod('fontsize',TP.StringProto.fontsize);String.Inst.defineMethod('italics',TP.StringProto.italics);String.Inst.defineMethod('link',TP.StringProto.link);String.Inst.defineMethod('small',TP.StringProto.small);String.Inst.defineMethod('strike',TP.StringProto.strike);String.Inst.defineMethod('sub',TP.StringProto.sub);String.Inst.defineMethod('sup',TP.StringProto.sup);String.Inst.defineMethod('charAt',TP.StringProto.charAt);String.Inst.defineMethod('charCodeAt',TP.StringProto.charCodeAt);String.Inst.defineMethod('concat',TP.StringProto.concat);String.Inst.defineMethod('indexOf',TP.StringProto.indexOf);String.Inst.defineMethod('lastIndexOf',TP.StringProto.lastIndexOf);String.Inst.defineMethod('localeCompare',TP.StringProto.localeCompare);String.Inst.defineMethod('match',TP.StringProto.match);String.Inst.defineMethod('replace',TP.StringProto.replace);String.Inst.defineMethod('search',TP.StringProto.search);String.Inst.defineMethod('slice',TP.StringProto.slice);String.Inst.defineMethod('split',TP.StringProto.split);String.Inst.defineMethod('substring',TP.StringProto.substring);String.Inst.defineMethod('substr',TP.StringProto.substr);String.Inst.defineMethod('toLocaleLowerCase',TP.StringProto.toLocaleLowerCase);String.Inst.defineMethod('toLocaleUpperCase',TP.StringProto.toLocaleUpperCase);String.Inst.defineMethod('toLowerCase',TP.StringProto.toLowerCase);String.Inst.defineMethod('toString',TP.StringProto.toString);String.Inst.defineMethod('toUpperCase',TP.StringProto.toUpperCase);String.Inst.defineMethod('trim',TP.StringProto.trim);String.Inst.defineMethod('valueOf',TP.StringProto.valueOf);
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETLocalization.js';
TP.sys.defineAttribute('locale');TP.sys.defineMethod('getLocale',function(){var a;a=this.$get('locale');if(TP.notValid(a)){return TP.core.Locale;}return a;});TP.sys.defineMethod('setLocale',function(b){var c,a;if(TP.isEmpty(b)){c=TP.sys.env('tibet.xmllang','en-us').toLowerCase();a=TP.core.Locale.getLocaleById(c);if(TP.notValid(a)){a=TP.core.Locale;}}else{if(TP.isString(b)){a=TP.core.Locale.getLocaleById(b);}else if(TP.canInvoke(b,'localizeString')){a=b;}else{this.raise('TP.sig.InvalidParameter',arguments);a=TP.core.Locale;}}this.$set('locale',a);return this;});TP.defineCommonMethod('localize',function(c,d,e){var a,b;TP.debug('break.locale_localize');a=TP.ifInvalid(c,TP.sys.getLocale());if(TP.isString(a)){b=TP.core.Locale.getLocaleById(a);}else{b=a;}if(TP.notValid(b)){TP.ifWarn()?TP.warn('Couldn\'t find locale for: '+a,TP.LOG,arguments):0;return this;}return b.localize(this,d,e);});TP.lang.Object.defineSubtype('core:Locale');TP.core.Locale.Type.defineAttribute('langCode','');TP.core.Locale.Type.defineAttribute('countryCode','');TP.core.Locale.Type.defineAttribute('falseStrings',TP.ac('0','','n','N','no','No','NO','f','F','false','False','FALSE'));TP.core.Locale.Type.defineAttribute('trueStrings',TP.ac('1','y','Y','yes','Yes','YES','t','T','true','True','TRUE'));TP.core.Locale.Type.defineAttribute('longMonthNames',TP.ac('January','February','March','April','May','June','July','August','September','October','November','December'));TP.core.Locale.Type.defineAttribute('longWeekdayNames',TP.ac('Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'));TP.core.Locale.Type.defineAttribute('shortMonthNames',TP.ac('Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'));TP.core.Locale.Type.defineAttribute('shortWeekdayNames',TP.ac('Sun','Mon','Tue','Wed','Thu','Fri','Sat'));TP.core.Locale.Type.defineAttribute('dateFormat','%{yyyy}-%{mm}-%{dd}T%{hhi}:%{mmn}:%{ss}Z');TP.core.Locale.Type.defineAttribute('numberFormat','#{#,###}');TP.core.Locale.Type.defineAttribute('thousandsMatcher',/,/g);TP.core.Locale.Type.defineAttribute('thousandsSeparator',',');TP.core.Locale.Type.defineAttribute('decimalPoint','.');TP.core.Locale.Type.defineAttribute('thousandsGroupSize',3);TP.core.Locale.Type.defineAttribute('langID');TP.core.Locale.Type.defineAttribute('stringXML');TP.core.Locale.Type.defineAttribute('stringSTR');TP.core.Locale.Type.defineAttribute('locales',TP.hc());TP.core.Locale.Type.defineMethod('getISOKey',function(){var a,b;if(TP.notEmpty(a=this.get('langID'))){return a;}if(TP.notEmpty(b=this.$get('countryCode'))){a=TP.join(this.get('langCode'),'-',b);}else{a=this.get('langCode');}this.$set('langID',a);return a;});TP.core.Locale.Type.defineMethod('getLocaleById',function(b){var a;if(TP.isType(a=this.get('locales').at(b))){return a;}if(TP.isType(a=TP.sys.require(b.strip('-').toUpperCase()+'Locale'))){TP.core.Locale.registerLocale(a);return a;}if(TP.isType(a=this.get('locales').at(b.split('-').first()))){return a;}if(TP.isType(a=TP.sys.require(b.split('-').first().toUpperCase()+'Locale'))){TP.core.Locale.registerLocale(a);return a;}return;});TP.core.Locale.Type.defineMethod('registerLocale',function(a,c){var b;if(!TP.isSubtypeOf(a,TP.core.Locale)){return this.raise('TP.sig.InvalidLocale',arguments,a);}b=TP.ifInvalid(c,a.getISOKey());TP.core.Locale.get('locales').atPut(b,a);return this;});TP.core.Locale.Type.defineMethod('localize',function(a,c,b){var d,e;TP.debug('break.locale_localize');d=TP.tname(a);switch(d){case'String':return this.localizeString(a,c,b);case'Boolean':return this.localizeBoolean(a,c,b);case'Number':return this.localizeNumber(a,c,b);case'Date':return this.localizeDate(a,c,b);default:e='localize'+d;if(TP.canInvoke(this,e)){return this.fname(a,b);}break;}return a;});TP.core.Locale.Type.defineMethod('localizeBoolean',function(b,c,d){var a;a=b?'true':'false';return this.localizeString(a,c,d);});TP.core.Locale.Type.defineMethod('getFalseStrings',function(){return this.$get('falseStrings');});TP.core.Locale.Type.defineMethod('getTrueStrings',function(){return this.$get('trueStrings');});TP.core.Locale.Type.defineMethod('localizeDate',function(a,c,d){var b;if(TP.notEmpty(b=this.getDateFormat())){return b.transformDate(a);}return a;});TP.core.Locale.Type.defineMethod('getDateFormat',function(){return this.$get('dateFormat');});TP.core.Locale.Type.defineMethod('getLongMonthNames',function(){return this.$get('longMonthNames');});TP.core.Locale.Type.defineMethod('getLongWeekdayNames',function(){return this.$get('longWeekdayNames');});TP.core.Locale.Type.defineMethod('getShortMonthNames',function(){return this.$get('shortMonthNames');});TP.core.Locale.Type.defineMethod('getShortWeekdayNames',function(){return this.$get('shortWeekdayNames');});TP.core.Locale.Type.defineMethod('localizeNumber',function(a,c,d){var b;if(TP.notEmpty(b=this.getNumberFormat())){return b.transformNumber(a);}return a;});TP.core.Locale.Type.defineMethod('getNumberFormat',function(){return this.$get('numberFormat');});TP.core.Locale.Type.defineMethod('getThousandsMatcher',function(){return this.$get('thousandsMatcher');});TP.core.Locale.Type.defineMethod('getThousandsSeparator',function(){return this.$get('thousandsSeparator');});TP.core.Locale.Type.defineMethod('getDecimalPoint',function(){return this.$get('decimalPoint');});TP.core.Locale.Type.defineMethod('getThousandsGroupSize',function(){return this.$get('thousandsGroupSize');});TP.core.Locale.Type.defineMethod('localizeString',function(b,l,k){var a,e,h,g,i,c,f,j,d;if(TP.isEmpty(b)){return b;}a=TP.ifInvalid(l,TP.sys.getSourceLanguage());if(!TP.isString(a)){a=a.getISOKey();}e=this.getISOKey();if(!a||!e||a===e){return b;}h=this.$getStringXMLString(k);if(TP.notValid(h)){return b;}g=b.asString();try{if(TP.notTrue(TP.rc(g).test(h))){return b;}}catch(a){}i=this.getStringXML();c=TP.join('//*[local-name() = "tuv" and @xml:lang = "',a.toLowerCase(),'"]/*[local-name() = "seg" and text() = ',g.quoted('"'),']');f=TP.nodeEvaluateXPath(i,c,TP.FIRST_NODE,false);if(TP.notValid(f)){if(TP.regex.HAS_HYPHEN.test(a)){c=TP.join('//*[local-name() = "tuv" and @xml:lang = "',a.split('-').first().toLowerCase(),'"]/*[local-name() = "seg" and text() = ',g.quoted('"'),']');f=TP.nodeEvaluateXPath(i,c,TP.FIRST_NODE,false);if(TP.notValid(f)){return b;}}else{return b;}}j=f.parentNode.parentNode;c=TP.join('string(./*[local-name() = "tuv" and @xml:lang = "',e.toLowerCase(),'"]/*[local-name() = "seg"]/text())');d=TP.nodeEvaluateXPath(j,c,TP.FIRST_NODE,false);if(TP.notEmpty(d)){return d;}if(TP.regex.HAS_HYPHEN.test(e)){c=TP.join('string(./*[local-name() = "tuv" and @xml:lang = "',e.split('-').first().toLowerCase(),'"]/*[local-name() = "seg"]/text())');d=TP.nodeEvaluateXPath(j,c,TP.FIRST_NODE,false);}if(TP.notEmpty(d)){return d;}return b;});TP.core.Locale.Type.defineMethod('$getStringXMLString',function(b){var a,c;if(TP.isTrue(b)){this.$set('stringSTR',null);}if(TP.notValid(a=this.$get('stringSTR'))){if(TP.notValid(c=this.getStringXML(b))){a='';this.$set('stringSTR',a);}else{a=TP.nodeAsString(c);this.$set('stringSTR',a);}}return a;});TP.core.Locale.Type.defineMethod('getStringXML',function(f){var a,c,d,e,b;if(TP.isTrue(f)){this.$set('stringXML',null);}if(TP.isNode(a=this.$get('stringXML'))){return a;}c=TP.sys.shouldLogRaise();TP.sys.shouldLogRaise(false);try{try{if(TP.notEmpty(d=TP.sys.cfg('tibet.strings'))){e=d.split('.');b=TP.uc(e.join('_'+this.getISOKey().toLowerCase().replace('-','_')+'.'));if(TP.isURI(b)){a=b.getNativeNode(TP.hc('async',false));}}}catch(a){}if(TP.notValid(a)){b=TP.uc(TP.sys.cfg('tibet.string_file'));if(TP.isURI(b)){a=b.getNativeNode(TP.hc('async',false));}}}catch(a){}finally{if(TP.notValid(a)){a=TP.documentFromString('<tmx xmlns="'+TP.w3.Xmlns.TMX+'"></tmx>');}this.$set('stringXML',a);TP.sys.shouldLogRaise(c);}return a;});TP.core.Locale.Type.defineMethod('parseBoolean',function(b,c){var a;TP.debug('break.locale_parse');a=this.localizeString(b,c);return!this.getFalseStrings().containsString(a);});TP.core.Locale.Type.defineMethod('parseDate',function(a,b){TP.debug('break.locale_parse');return new Date(a);});TP.core.Locale.Type.defineMethod('parseNumber',function(c,d){var a,b;TP.debug('break.locale_parse');a=c;b=this.getThousandsSeparator();a=a.strip(b,'');b=this.getDecimalPoint();a=a.replace(b,'.');return new Number(a);});TP.core.Locale.Type.defineMethod('parseString',function(a,b){TP.debug('break.locale_parse');return this.localizeString(a,b);});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETFormatting.js';
TP.defineMetaInstMethod('asHTMLNode',function(a){return TP.stringAsHTMLNode(this.asHTMLString(),a);});TP.defineMetaInstMethod('asHTMLString',function(){var a,c,e,b,d;if(this.$$format_asHTMLString){return TP.recursion(this);}try{this.$$format_asHTMLString=true;}catch(a){}a=TP.ac();c=this.getKeys();e=c.getSize();a.push('<span class="Object ',TP.escapeTypeName(TP.tname(this)),'">');for(b=0;b<e;b++){d=c.at(b);a.push('<span data-name="',d,'">',TP.htmlstr(this.at(d)),'</span>');}a.push('</span>');try{delete this.$$format_asHTMLString;}catch(a){}return a.join('');});TP.defineMetaInstMethod('asStorageString',function(){return this.asJSONSource();});TP.defineMetaInstMethod('asXHTMLNode',function(){return TP.nodeFromString(this.asXHTMLString());});TP.defineMetaInstMethod('asXHTMLString',function(){return this.asString();});TP.defineMetaInstMethod('asXMLNode',function(a){return TP.nodeFromString(this.asXMLString());});TP.defineMetaInstMethod('asXMLString',function(f){var c,d,e,a,b;if(this.$$format_asXMLString){return TP.recursion(this);}try{this.$$format_asXMLString=true;}catch(a){}c=TP.ac();d=this.getKeys(f);e=d.getSize();for(a=0;a<e;a++){b=d.at(a);c.push('<',b,'>',TP.xmlstr(this.at(b)),'</',b,'>');}try{delete this.$$format_asXMLString;}catch(a){}return c.join('');});Array.Inst.defineMethod('asDumpString',function(){var a,c,b;this.$sortIfNeeded();if(this.$$format_asDumpString){return TP.recursion(this);}this.$$format_asDumpString=true;a=this.$get('delimiter');if(!TP.isString(a)){if(!TP.isString(a=a.get('join'))){a='';}}try{c=this.collect(function(a,b){return TP.dump(a);});b='['+c.join(a)+']';}catch(a){b=this.toString();}delete this.$$format_asDumpString;return b;});Array.Inst.defineMethod('asHTMLString',function(){var a,c,b;if(this.$$format_asHTMLString){return TP.recursion(this);}this.$$format_asHTMLString=true;a=TP.ac();c=this.getSize();a.push('<span class="Array">');for(b=0;b<c;b++){a.push('<span data-name="',b,'">',TP.htmlstr(this.at(b)),'</span>');}a.push('</span>');delete this.$$format_asHTMLString;return a.join('');});Array.Inst.defineMethod('asPrettyString',function(){var b,a,d,c;this.$sortIfNeeded();if(this.$$format_asPrettyString){return TP.recursion(this);}this.$$format_asPrettyString=true;try{b=TP.ac();d=this.getSize();for(a=0;a<d;a++){b.push(TP.join('<dt class="pretty key">',a,'</dt>','<dd class="pretty value">',TP.pretty(this.at(a)),'</dd>'));}c='<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+b.join('')+'</dl>';}catch(a){c=this.toString();}delete this.$$format_asPrettyString;return c;});Array.Inst.defineMethod('asXMLString',function(){var b,c,a;if(this.$$format_asXMLString){return TP.recursion(this);}this.$$format_asXMLString=true;b=TP.ac();c=this.getSize();for(a=0;a<c;a++){b.push('<item index="',a,'">',TP.xmlstr(this.at(a)),'</item>');}delete this.$$format_asXMLString;return b.join('');});Boolean.Inst.defineMethod('asHTMLString',function(){return TP.str(this);});Boolean.Inst.defineMethod('asPrettyString',function(){return'<dl class="pretty Boolean"><dt/><dd>'+TP.str(this)+'</dd></dl>';});Boolean.Inst.defineMethod('asXMLString',function(){return TP.str(this);});Date.Inst.defineMethod('asDumpString',function(){return this.toISOString();});Date.Inst.defineMethod('asHTMLString',function(){return TP.str(this);});Date.Inst.defineMethod('asJSONSource',function(){return this.toISOString().quoted('"');});Date.Inst.defineMethod('asPrettyString',function(){return'<dl class="pretty Date"><dt/><dd>'+TP.str(this)+'</dd></dl>';});Date.Inst.defineMethod('asXMLString',function(){return TP.str(this);});Function.Inst.defineMethod('asDumpString',function(){if(TP.isNativeType(this)){return this.getName();}return TP.objectToString(this);});Function.Inst.defineMethod('asHTMLString',function(){if(TP.isNativeType(this)){return'<span class="NativeType">'+this.getName()+'</span>';}return TP.str(this);});Function.Inst.defineMethod('asJSONSource',function(e,b){var c,a,d;if(TP.isNativeType(this)){c=this!==Object?'"Object"':'""';return'{"type":"NativeType",'+'"data":{"name":'+this.getName().quoted('"')+','+'"supertypes":['+c+']}}';}if(TP.isType(this)){return TP.join(this.getSupertype().getName(),'.defineSubtype(\'',this.getNamespacePrefix(),':',this.getLocalName(),'\');');}d=TP.notDefined(b)?TP.sys.cfg('stack.descent_max'):Math.max(0,b);if(d===0){a='(function () {})';}else{a=TP.join('(',this.toString().tokenizeWhitespace().replace('{ }','{}'),')');}return a;});Function.Inst.defineMethod('asPrettyString',function(){if(TP.isNativeType(this)){return'<dl class="pretty NativeType">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+'NativeType.&lt;'+TP.name(this)+'&gt;'+'</dd>'+'<dt/>'+'<dd class="pretty value">'+this.getName()+'</dd>'+'</dl>';}return'<dl class="pretty Function"><dt/><dd>'+TP.objectToString(this)+'</dd></dl>';});Function.Inst.defineMethod('asXMLString',function(){if(TP.isNativeType(this)){return'<type>'+this.getName()+'</type>';}return TP.str(this);});Number.Inst.defineMethod('asHTMLString',function(){return TP.str(this);});Number.Inst.defineMethod('asPrettyString',function(){return'<dl class="pretty Number"><dt/><dd>'+TP.str(this)+'</dd></dl>';});Number.Inst.defineMethod('asXMLString',function(){return TP.str(this);});RegExp.Inst.defineMethod('asDumpString',function(){return this.toString();});RegExp.Inst.defineMethod('asHTMLString',function(){return TP.str(this);});RegExp.Inst.defineMethod('asJSONSource',function(){return this.toString().quoted('"');});RegExp.Inst.defineMethod('asPrettyString',function(){return'<dl class="pretty RegExp"><dt/><dd>'+this.toString()+'</dd></dl>';});RegExp.Inst.defineMethod('asXMLString',function(){return TP.str(this);});String.Inst.defineMethod('asHTMLString',function(){var a;a=this.toString();if(TP.regex.IS_ELEM_MARKUP.test(a)){return a;}return TP.htmlLiteralsToEntities(a);});String.Inst.defineMethod('asPrettyString',function(){var a;a=this.toString();if(TP.regex.CONTAINS_ELEM_MARKUP.test(a)){a=a.asEscapedXML();}return'<dl class="pretty String"><dt/><dd>'+a+'</dd></dl>';});String.Inst.defineMethod('asXMLString',function(){var a;a=this.toString();if(TP.regex.IS_ELEM_MARKUP.test(a)){return a;}return TP.xmlLiteralsToEntities(TP.htmlEntitiesToXmlEntities(a));});TP.lang.RootObject.Type.defineMethod('asDumpString',function(){return this.getName();});TP.lang.RootObject.Type.defineMethod('asHTMLString',function(){return'<span class="TP.lang.RootObject">'+this.getName()+'</span>';});TP.lang.RootObject.Type.defineMethod('asJSONSource',function(){var a;a=this.getSupertypeNames().collect(function(a){return a.quoted('"');});return'{"type":"TP.lang.RootObject",'+'"data":{"name":'+this.getName().quoted('"')+','+'"supertypes":['+a.join(',')+']}}';});TP.lang.RootObject.Type.defineMethod('asPrettyString',function(){return'<dl class="pretty TP.lang.RootObject">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+'TP.lang.RootObject.&lt;'+TP.name(this)+'&gt;'+'</dd>'+'<dt/>'+'<dd class="pretty value">'+this.getName()+'</dd>'+'</dl>';});TP.lang.RootObject.Type.defineMethod('asXMLString',function(){return'<type>'+this.getName()+'</type>';});TP.lang.Object.Inst.defineMethod('asDumpString',function(){var c,b,e,a,d;if(this.$$format_asDumpString){return TP.recursion(this);}this.$$format_asDumpString=true;c=TP.ac();try{b=TP.keys(this);e=b.getSize();for(a=0;a<e;a++){c.push(TP.join(b.at(a),' => ',TP.dump(this.get(b.at(a)))));}d=TP.tname(this)+' :: '+'('+c.join(', ')+')';}catch(a){d=this.toString();}delete this.$$format_asDumpString;return d;});TP.lang.Object.Inst.defineMethod('asHTMLString',function(){var c,b,e,a,d;if(this.$$format_asHTMLString){return TP.recursion(this);}this.$$format_asHTMLString=true;c=TP.ac();try{b=TP.keys(this);e=b.getSize();for(a=0;a<e;a++){c.push(TP.join('<span data-name="',b.at(a),'">',TP.htmlstr(this.get(b.at(a))),'</span>'));}d='<span class="TP_lang_Object '+TP.escapeTypeName(TP.tname(this))+'">'+c.join('')+'</span>';}catch(a){d=this.toString();}delete this.$$format_asHTMLString;return d;});TP.lang.Object.Inst.defineMethod('asJSONSource',function(){var c,b,e,a,d;if(this.$$format_asJSONSource){return TP.recursion(this);}this.$$format_asJSONSource=true;c=TP.ac();try{b=TP.keys(this);e=b.getSize();for(a=0;a<e;a++){c.push(TP.join(b.at(a).quoted('"'),':',TP.json(this.get(b.at(a)))));}d='{"type":"'+TP.tname(this)+'",'+'"data":{'+c.join(',')+'}}';}catch(a){d=this.toString();}delete this.$$format_asJSONSource;return d;});TP.lang.Object.Inst.defineMethod('asPrettyString',function(){var c,b,e,a,d;if(this.$$format_asPrettyString){return TP.recursion(this);}this.$$format_asPrettyString=true;c=TP.ac();try{b=TP.keys(this);e=b.getSize();for(a=0;a<e;a++){c.push(TP.join('<dt class="pretty key">',b.at(a),'</dt>','<dd class="pretty value">',TP.pretty(this.at(b.at(a))),'</dd>'));}d='<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+c.join('')+'</dl>';}catch(a){d=this.toString();}delete this.$$format_asPrettyString;return d;});TP.lang.Object.Inst.defineMethod('asXMLString',function(){var c,b,e,a,d;if(this.$$format_asXMLString){return TP.recursion(this);}this.$$format_asXMLString=true;c=TP.ac();try{b=TP.keys(this);e=b.getSize();for(a=0;a<e;a++){c.push(TP.join('<',b.at(a),'>',TP.xmlstr(this.get(b.at(a))),'</',b.at(a),'>'));}d='<instance type="'+TP.tname(this)+'">'+c.join('')+'</instance>';}catch(a){d=this.toString();}delete this.$$format_asXMLString;return d;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETCalendaring.js';
TP.lang.Object.defineSubtype('iso:ISO8601');TP.iso.ISO8601.Type.defineConstant('ISO_DATE_REGEX',/^(\d{4})-?(\d{2})?-?(\d{2})?(T(\d{2})(:(\d{2})(:(\d{2})(\.(\d{1,3}))?)?)?)?(Z)?([\+\-]\d{2}:\d{2})?$/);TP.iso.ISO8601.Type.defineConstant('ISO_TZ_REGEX',/([\+\-])(\d{2}):(\d{2})/);TP.iso.ISO8601.Type.defineConstant('FORMATS',TP.hc());TP.iso.ISO8601.FORMATS.atPut('YYYY','%{yyyy}');TP.iso.ISO8601.FORMATS.atPut('YYYYMM','%{yyyy}%{mm}');TP.iso.ISO8601.FORMATS.atPut('YYYYMMDD','%{yyyy}%{mm}%{dd}');TP.iso.ISO8601.FORMATS.atPut('YYYY-MM','%{yyyy}-%{mm}');TP.iso.ISO8601.FORMATS.atPut('YYYY-MM-DD','%{yyyy}-%{mm}-%{dd}');TP.iso.ISO8601.FORMATS.atPut('YYYYWWW','%{yyyy}W%{ww}');TP.iso.ISO8601.FORMATS.atPut('YYYYWWWD','%{yyyy}W%{ww}%{dw}');TP.iso.ISO8601.FORMATS.atPut('YYYY-WWW','%{yyyy}-W%{ww}');TP.iso.ISO8601.FORMATS.atPut('YYYY-WWWD','%{yyyy}-W%{ww}%{dw}');TP.iso.ISO8601.FORMATS.atPut('YYYY-WWW-D','%{yyyy}-W%{ww}-%{dw}');TP.iso.ISO8601.FORMATS.atPut('YYYYDDD','%{yyyy}%{dy}');TP.iso.ISO8601.FORMATS.atPut('YYYY-DDD','%{yyyy}-%{dy}');TP.iso.ISO8601.FORMATS.atPut('HH','%{hhi}');TP.iso.ISO8601.FORMATS.atPut('HHZ','%{hhi}Z');TP.iso.ISO8601.FORMATS.atPut('HH+','%{hhi}+');TP.iso.ISO8601.FORMATS.atPut('HHMM','%{hhi}%{mmn}');TP.iso.ISO8601.FORMATS.atPut('HHMMZ','%{hhi}%{mmn}Z');TP.iso.ISO8601.FORMATS.atPut('HHMM+','%{hhi}%{mmn}+');TP.iso.ISO8601.FORMATS.atPut('HHMMSS','%{hhi}%{mmn}%{ss}');TP.iso.ISO8601.FORMATS.atPut('HHMMSSZ','%{hhi}%{mmn}%{ss}Z');TP.iso.ISO8601.FORMATS.atPut('HHMMSS+','%{hhi}%{mmn}%{ss}+');TP.iso.ISO8601.FORMATS.atPut('HH:MM','%{hhi}:%{mmn}');TP.iso.ISO8601.FORMATS.atPut('HH:MMZ','%{hhi}:%{mmn}Z');TP.iso.ISO8601.FORMATS.atPut('HH:MM+','%{hhi}:%{mmn}+');TP.iso.ISO8601.FORMATS.atPut('HH:MM:SS','%{hhi}:%{mmn}:%{ss}');TP.iso.ISO8601.FORMATS.atPut('HH:MM:SSZ','%{hhi}:%{mmn}:%{ss}Z');TP.iso.ISO8601.FORMATS.atPut('HH:MM:SS+','%{hhi}:%{mmn}:%{ss}+');TP.iso.ISO8601.FORMATS.atPut('YYYY-MM-DDTHH:MM:SS','%{yyyy}-%{mm}-%{dd}T%{hhi}:%{mmn}:%{ss}');TP.iso.ISO8601.FORMATS.atPut('YYYY-MM-DDTHH:MM:SSZ','%{yyyy}-%{mm}-%{dd}T%{hhi}:%{mmn}:%{ss}Z');TP.iso.ISO8601.FORMATS.atPut('YYYY-MM-DDTHH:MM:SS+','%{yyyy}-%{mm}-%{dd}T%{hhi}:%{mmn}:%{ss}+');TP.iso.ISO8601.FORMATS.atPut('YYYYMMDDTHH:MM:SS','%{yyyy}%{mm}%{dd}T%{hhi}:%{mmn}:%{ss}');TP.iso.ISO8601.FORMATS.atPut('YYYYMMDDTHH:MM:SSZ','%{yyyy}%{mm}%{dd}T%{hhi}:%{mmn}:%{ss}Z');TP.iso.ISO8601.FORMATS.atPut('YYYYMMDDTHH:MM:SS+','%{yyyy}%{mm}%{dd}T%{hhi}:%{mmn}:%{ss}+');TP.iso.ISO8601.FORMATS.atPut('YYYYMMDDTHHMMSS','%{yyyy}%{mm}%{dd}T%{hhi}%{mmn}%{ss}');TP.iso.ISO8601.FORMATS.atPut('YYYYMMDDTHHMMSSZ','%{yyyy}%{mm}%{dd}T%{hhi}%{mmn}%{ss}Z');TP.iso.ISO8601.FORMATS.atPut('YYYYMMDDTHHMMSS+','%{yyyy}%{mm}%{dd}T%{hhi}%{mmn}%{ss}+');TP.iso.ISO8601.FORMATS.atPut('YYYY-WWW-DTHH:MM:SS','%{yyyy}-W%{ww}-%{dw}T%{hhi}:%{mmn}:%{ss}');TP.iso.ISO8601.FORMATS.atPut('YYYY-WWW-DTHH:MM:SSZ','%{yyyy}-W%{ww}-%{dw}T%{hhi}:%{mmn}:%{ss}Z');TP.iso.ISO8601.FORMATS.atPut('YYYY-WWW-DTHH:MM:SS+','%{yyyy}-W%{ww}-%{dw}T%{hhi}:%{mmn}:%{ss}+');TP.iso.ISO8601.FORMATS.atPut('YYYYWWWDTHHMMSS','%{yyyy}W%{ww}%{dw}T%{hhi}%{mmn}%{ss}');TP.iso.ISO8601.FORMATS.atPut('YYYYWWWDTHHMMSSZ','%{yyyy}W%{ww}%{dw}T%{hhi}%{mmn}%{ss}Z');TP.iso.ISO8601.FORMATS.atPut('YYYYWWWDTHHMMSS+','%{yyyy}W%{ww}%{dw}T%{hhi}%{mmn}%{ss}+');TP.iso.ISO8601.FORMATS.atPut('YYYY-DDDTHH:MM:SS','%{yyyy}-%{dy}T%{hhi}:%{mmn}:%{ss}');TP.iso.ISO8601.FORMATS.atPut('YYYY-DDDTHH:MM:SSZ','%{yyyy}-%{dy}T%{hhi}:%{mmn}:%{ss}Z');TP.iso.ISO8601.FORMATS.atPut('YYYY-DDDTHH:MM:SS+','%{yyyy}-%{dy}T%{hhi}:%{mmn}:%{ss}+');TP.iso.ISO8601.FORMATS.atPut('YYYYDDDTHHMMSS','%{yyyy}%{dy}T%{hhi}%{mmn}%{ss}');TP.iso.ISO8601.FORMATS.atPut('YYYYDDDTHHMMSSZ','%{yyyy}%{dy}T%{hhi}%{mmn}%{ss}Z');TP.iso.ISO8601.FORMATS.atPut('YYYYDDDTHHMMSS+','%{yyyy}%{dy}T%{hhi}%{mmn}%{ss}+');TP.iso.ISO8601.FORMATS.atPut('XMLRPC','%{yyyy}%{mm}%{dd}T%{hhi}:%{mmn}:%{ss}');TP.iso.ISO8601.FORMATS.atPut('TIMESTAMP','%{yyyy}%{mm}%{dd}T%{hhi}%{mmn}%{ss}.%{fff}');Date.addParser(TP.iso.ISO8601);TP.iso.ISO8601.Type.defineMethod('fromDate',function(a,b){if(!TP.isDate(a)){return this.raise('TP.sig.InvalidParameter',arguments,a);}if(TP.isEmpty(b)){return'YYYY-MM-DDTHH:MM:SSZ'.transformDate(a);}return b.transformDate(a);});TP.iso.ISO8601.Type.defineMethod('fromString',function(b,c){var a;a=Date.fromString(b,c);if(TP.isDate(a)){return this.fromDate(a);}return null;});TP.iso.ISO8601.Type.defineMethod('parse',function(j){var g,c,d,e,a,b,i,f,k,h;if(!TP.isString(j)){return null;}g=j.split('T');c=g.at(0);d=g.at(1);if(TP.notValid(d)&&/[Z\:\+\-]/.test(c)){d=c;c=null;}if(TP.isString(d)&&TP.regex.HAS_TIMEZONE.test(d)){e=true;}else{e=false;}if(TP.isString(c)){c=c.strip(/\-/g);if(/W/.test(c)){if(TP.isEmpty(a=c.match(/^(\d{4})W(\d{2})(\d{1})?$/))){return null;}b=e?Date.constructUTCDayOne(a.at(1)):Date.constructDayOne(a.at(1));b.setISOWeek(a.at(2));if(TP.isString(a.at(3))){if(a.at(3)!==1){i=e?b.getUTCDayOfWeek():b.getDayOfWeek();f=TP.join('P',a.at(3)-i,'D');b=b.addDuration(f);}}}else if(c.getSize()===7){if(TP.notValid(a=c.match(/^(\d{4})(\d{3})$/))){return null;}b=e?Date.constructUTCDayOne(a.at(1)):Date.constructDayOne(a.at(1));f=TP.join('P',a.at(2)-1,'D');b=b.addDuration(f);}else{if(TP.notValid(a=c.match(/^(\d{4})(\d{2})?(\d{2})?$/))){return null;}if(e){b=Date.constructUTCDayOne(a.at(1));TP.isString(a.at(2))?b.setUTCMonth(a.at(2)-1):null;TP.isString(a.at(3))?b.setUTCDate(a.at(3)):null;}else{b=Date.constructDayOne(a.at(1));TP.isString(a.at(2))?b.setMonth(a.at(2)-1):null;TP.isString(a.at(3))?b.setDate(a.at(3)):null;}}}if(TP.isString(d)){if(TP.notValid(b)){b=e?Date.todayUTC():Date.today();}d=d.strip(/:/g);k=/^(\d{2})(\d{2})?(\d{2})?(\.(\d*))?/;if(TP.notValid(a=d.match(k))){return;}if(e){TP.isString(a.at(1))?b.setUTCHours(a.at(1)):null;TP.isString(a.at(2))?b.setUTCMinutes(a.at(2)):null;TP.isString(a.at(3))?b.setUTCSeconds(a.at(3)):null;TP.isString(a.at(5))?b.setUTCMilliseconds(a.at(5)):null;}else{TP.isString(a.at(1))?b.setHours(a.at(1)):null;TP.isString(a.at(2))?b.setMinutes(a.at(2)):null;TP.isString(a.at(3))?b.setSeconds(a.at(3)):null;TP.isString(a.at(5))?b.setMilliseconds(a.at(5)):null;}if(e){if(/Z/.test(d)){return b;}else{h=/[\+\-](\d{2})(\d{2})$/;if(TP.notValid(a=d.match(h))){return null;}if(/\+/.test(d)){b=b.addDuration(TP.join('PT',a.at(1),'H',a.at(2),'M'));}else{b=b.subtractDuration(TP.join('PT',a.at(1),'H',a.at(2),'M'));}}}}return b;});TP.iso.ISO8601.Type.defineMethod('validate',function(a){return TP.isDate(this.parse(a));});TP.lang.Object.defineSubtype('core:TimeZone');TP.core.TimeZone.Type.defineConstant('ZONE_REGEX',/^([Z\+\-])([0-9]{2})*[:]*([0-9]{2})*$/);TP.core.TimeZone.Type.defineConstant('ZONE_INDEX',1);TP.core.TimeZone.Type.defineConstant('ZONE_HOUR_INDEX',2);TP.core.TimeZone.Type.defineConstant('ZONE_MINUTE_INDEX',3);TP.core.TimeZone.Type.defineMethod('validate',function(e){var f,a,c,b,d;if(!TP.isString(e)){return false;}if(TP.isEmpty(e)){return true;}f=e;a=f.match(this.get('ZONE_REGEX'));if(TP.notValid(a)){return false;}c=a.at(this.get('ZONE_INDEX'));b=a.at(this.get('ZONE_HOUR_INDEX'));d=a.at(this.get('ZONE_MINUTE_INDEX'));if(c==='Z'){if(TP.isString(b)||TP.isString(d)){return false;}}else if(c==='+'||c==='-'){if(TP.notValid(b)||TP.notValid(d)){return false;}if(parseInt(b,10)>14){return false;}if(parseInt(b,10)===14&&parseInt(d,10)!==0){return false;}}return true;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETNativeTypes.js';
TP.defineCommonMethod('asEscapedHTML',function(){return TP.htmlLiteralsToEntities(TP.str(this));});TP.defineCommonMethod('asEscapedXML',function(){return TP.xmlLiteralsToEntities(TP.htmlEntitiesToXmlEntities(TP.str(this)));});Boolean.Type.defineMethod('parseString',function(a,b){return TP.sys.getLocale().parseBoolean(a,b);});if(new Date().getYear()>1900){Date.Inst.defineMethod('getYear',function(){return this.getFullYear()-1900;});Date.Inst.defineMethod('setYear',function(a){return this.setFullYear(a+1900);});}Date.Type.defineConstant('DURATION_REGEX',TP.rc('^([-])*P([0-9]+Y)*([0-9]+M)*([0-9]+D)*([T])*([0-9]+H)*([0-9]+M)*([0-9]+(\\u002e[0-9]+)*S)*$'));Date.Type.defineConstant('DURATION_MINUS_INDEX',1);Date.Type.defineConstant('DURATION_YEAR_INDEX',2);Date.Type.defineConstant('DURATION_MONTH_INDEX',3);Date.Type.defineConstant('DURATION_DAY_INDEX',4);Date.Type.defineConstant('DURATION_T_INDEX',5);Date.Type.defineConstant('DURATION_HOUR_INDEX',6);Date.Type.defineConstant('DURATION_MINUTE_INDEX',7);Date.Type.defineConstant('DURATION_SECOND_INDEX',8);Date.Type.defineConstant('DURATION_TIME_INDEX',9);Date.Type.defineConstant('SPERMIN',60);Date.Type.defineConstant('SPERHOUR',3600);Date.Type.defineConstant('SPERDAY',86400);Date.Type.defineConstant('MSPERMIN',60000);Date.Type.defineConstant('MSPERHOUR',3600000);Date.Type.defineConstant('MSPERDAY',86400000);Date.Type.defineConstant('THIS_YEAR',TP.dc().getFullYear());Date.Type.defineConstant('DAYS_PER_MONTH',TP.ac(31,28,31,30,31,30,31,31,30,31,30,31));Date.Type.defineConstant('LONG_WEEKDAY_NAMES',TP.ac('Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'));Date.Type.defineConstant('SHORT_WEEKDAY_NAMES',TP.ac('Sun','Mon','Tue','Wed','Thu','Fri','Sat'));Date.Type.defineConstant('LONG_MONTH_NAMES',TP.ac('January','February','March','April','May','June','July','August','September','October','November','December'));Date.Type.defineConstant('SHORT_MONTH_NAMES',TP.ac('Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'));Date.Type.defineConstant('LOCALTIME_TOKENS',TP.hc('d',function(a){return a.getDayOfMonth();},'dd',function(a){return'#{00}'.transformNumber(a.getDayOfMonth());},'ddd',function(a){return a.getShortDayName();},'dddd',function(a){return a.getDayName();},'dw',function(a){return a.getISODayOfWeek();},'dy',function(a){return'#{000}'.transformNumber(a.getDayOfYear());},'ww',function(a){return'#{00}'.transformNumber(a.getISOWeek());},'m',function(a){return a.getISOMonth();},'mm',function(a){return'#{00}'.transformNumber(a.getISOMonth());},'mmm',function(a){return a.getShortMonthName();},'mmmm',function(a){return a.getMonthName();},'yy',function(a){return a.getFullYear().asString().slice(2);},'yyyy',function(a){return a.getFullYear();},'h',function(b){var a=b.getHours();if(a>12){a-=12;}return a;},'hi',function(b){var a=b.getHours();return a;},'hh',function(b){var a=b.getHours();if(a>12){a-=12;}return'#{00}'.transformNumber(a);},'hhi',function(b){var a=b.getHours();return'#{00}'.transformNumber(a);},'mn',function(a){return a.getMinutes();},'mmn',function(a){return'#{00}'.transformNumber(a.getMinutes());},'s',function(a){return a.getSeconds();},'ss',function(a){return'#{00}'.transformNumber(a.getSeconds());},'f',function(a){return'#{0}'.transformNumber(a.getMilliseconds());},'ff',function(a){return'#{00}'.transformNumber(a.getMilliseconds());},'fff',function(a){return'#{000}'.transformNumber(a.getMilliseconds());},'ffff',function(a){return'#{0000}'.transformNumber(a.getMilliseconds());},'fffff',function(a){return'#{00000}'.transformNumber(a.getMilliseconds());},'ffffff',function(a){return'#{000000}'.transformNumber(a.getMilliseconds());},'fffffff',function(a){return'#{0000000}'.transformNumber(a.getMilliseconds());},'ffffffff',function(a){return'#{00000000}'.transformNumber(a.getMilliseconds());},'fffffffff',function(a){return'#{000000000}'.transformNumber(a.getMilliseconds());},'AMPM',function(a){if(a.getHours()>12){return'PM';}return'AM';},'ampm',function(a){if(a.getHours()>12){return'pm';}return'am';},'AP',function(a){if(a.getHours()>12){return'P';}return'A';},'ap',function(a){if(a.getHours()>12){return'p';}return'a';}));Date.Type.defineConstant('UTC_TOKENS',TP.hc('d',function(a){return a.getUTCDayOfMonth();},'dd',function(a){return'#{00}'.transformNumber(a.getUTCDayOfMonth());},'ddd',function(a){return a.getUTCShortDayName();},'dddd',function(a){return a.getUTCDayName();},'dw',function(a){return a.getUTCISODay();},'dy',function(a){return'#{000}'.transformNumber(a.getUTCDayOfYear());},'ww',function(a){return'#{00}'.transformNumber(a.getUTCISOWeek());},'m',function(a){return a.getUTCISOMonth();},'mm',function(a){return'#{00}'.transformNumber(a.getUTCISOMonth());},'mmm',function(a){return a.getUTCShortMonthName();},'mmmm',function(a){return a.getUTCMonthName();},'yy',function(a){return a.getUTCFullYear().asString().slice(2);},'yyyy',function(a){return a.getUTCFullYear();},'h',function(b){var a=b.getUTCHours();if(a>12){a-=12;}return a;},'hi',function(b){var a=b.getUTCHours();return a;},'hh',function(b){var a=b.getUTCHours();if(a>12){a-=12;}return'#{00}'.transformNumber(a);},'hhi',function(b){var a=b.getUTCHours();return'#{00}'.transformNumber(a);},'mn',function(a){return a.getUTCMinutes();},'mmn',function(a){return'#{00}'.transformNumber(a.getUTCMinutes());},'s',function(a){return a.getUTCSeconds();},'ss',function(a){return'#{00}'.transformNumber(a.getUTCSeconds());},'f',function(a){return'#{0}'.transformNumber(a.getUTCMilliseconds());},'ff',function(a){return'#{00}'.transformNumber(a.getUTCMilliseconds());},'fff',function(a){return'#{000}'.transformNumber(a.getUTCMilliseconds());},'ffff',function(a){return'#{0000}'.transformNumber(a.getUTCMilliseconds());},'fffff',function(a){return'#{00000}'.transformNumber(a.getUTCMilliseconds());},'ffffff',function(a){return'#{000000}'.transformNumber(a.getUTCMilliseconds());},'fffffff',function(a){return'#{0000000}'.transformNumber(a.getUTCMilliseconds());},'ffffffff',function(a){return'#{00000000}'.transformNumber(a.getUTCMilliseconds());},'fffffffff',function(a){return'#{000000000}'.transformNumber(a.getUTCMilliseconds());},'AMPM',function(a){if(a.getUTCHours()>12){return'PM';}return'AM';},'ampm',function(a){if(a.getUTCHours()>12){return'pm';}return'am';},'AP',function(a){if(a.getUTCHours()>12){return'P';}return'A';},'ap',function(a){if(a.getUTCHours()>12){return'p';}return'a';}));Date.Type.defineConstant('FORMATS',TP.hc('MMDDYY','%{mm}%{dd}%{yy}','MMDDYYYY','%{mm}%{dd}%{yyyy}','MM-DD-YY','%{mm}-%{dd}-%{yy}','MM-DD-YYYY','%{mm}-%{dd}-%{yyyy}','HH:MM ampm','%{hh}:%{mn}%{ampm}','HH:MM AP','%{hh}:%{mn} %{AP}','HH:MM ap','%{hh}:%{mn} %{ap}','HTTP_FORMAT','%{ddd}, %{d} %{mmm} %{yyyy} %{hhi}:%{mmn}:%{ss}'));Date.Type.defineAttribute('thisYearStartDSTDate');Date.Type.defineAttribute('thisYearEndDSTDate');Date.Type.defineMethod('addDurations',function(d,e){var a,b,c;if(TP.notValid(a=Date.getSecondsInDuration(d))){return this.raise('TP.sig.InvalidParameter',arguments,'First duration not a valid duration string.');}if(TP.notValid(b=Date.getSecondsInDuration(e))){return this.raise('TP.sig.InvalidParameter',arguments,'Second duration not a valid duration string.');}c=a+b;return Date.normalizeDuration('PT'+c+'S');});Date.Type.defineMethod('normalizeDuration',function(f){var a,b,g,c,d,e,h;if(TP.notValid(a=Date.getMonthsInDuration(f))){return this.raise('TP.sig.InvalidDuration',arguments);}b=parseInt(a/12,10);a-=b*12;g=a;a=Date.getSecondsInDuration(f);c=parseInt(a/Date.SPERDAY,10);a-=c*Date.SPERDAY;d=parseInt(a/Date.SPERHOUR,10);a-=d*Date.SPERHOUR;e=parseInt(a/Date.SPERMIN,10);a-=e*Date.SPERMIN;h=a;return TP.join('P',b,'Y',g,'M',c,'DT',d,'H',e,'M',h,'S');});Date.Type.defineMethod('constructAtEpoch',function(){var a;a=this.construct();a.setTime(0);return a;});Date.Type.defineMethod('constructDayOne',function(a){return TP.dc(TP.join('01 Jan ',a,' 00:00:00'));});Date.Type.defineMethod('constructUTCDayOne',function(a){return TP.dc(TP.join('01 Jan ',a,' 00:00:00 GMT'));});Date.Type.defineMethod('daysInFebruary',function(a){if(this.isLeapYear(a)){return 29;}return 28;});Date.Type.defineMethod('daysInMonth',function(c,d){var a,b;a=TP.ifInvalid(c,TP.dc().getISOMonth());if(a===2){b=TP.ifInvalid(d,TP.dc().getFullYear());return this.daysInFebruary(b);}return this.DAYS_PER_MONTH.at(a-1);});Date.Type.defineMethod('daysInYear',function(a){if(this.isLeapYear(a)){return 366;}return 365;});Date.Type.defineMethod('fromDate',function(a){return a;});Date.Type.defineMethod('fromString',function(a,b){if(!TP.sys.hasKernel()){return new Date(a);}return new Date(this.parse(a,b));});Date.Type.defineMethod('getDSTEndDate',function(a){var b,c;if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=31-((a*5/4).floor()+1)%7;c=TP.dc(a,9,b,2);return c;});Date.Type.defineMethod('getDSTStartDate',function(a){var b,c;if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=(2+6*a-(a/4).floor())%7+1;c=TP.dc(a,3,b,2);return c;});Date.Type.defineMethod('getMillisecondsInDuration',function(e){var c,b,d,a;if(!TP.isString(e)){return this.raise('TP.sig.InvalidDuration',arguments);}d=e;if(!Date.DURATION_REGEX.test(d)){return this.raise('TP.sig.InvalidDuration',arguments);}c=d.match(Date.DURATION_REGEX);a=0;if(TP.notEmpty(b=c.at(Date.DURATION_DAY_INDEX))){a+=parseInt(b.slice(0,-1),10)*86400;}if(TP.notEmpty(b=c.at(Date.DURATION_HOUR_INDEX))){a+=parseInt(b.slice(0,-1),10)*3600;}if(TP.notEmpty(b=c.at(Date.DURATION_MINUTE_INDEX))){a+=parseInt(b.slice(0,-1),10)*60;}a=a*1000;if(TP.notEmpty(b=c.at(Date.DURATION_SECOND_INDEX))){a+=parseInt(parseFloat(b.slice(0,-1))*1000,10);}if(TP.notEmpty(c.at(Date.DURATION_MINUS_INDEX))){return 0-a;}return a;});Date.Type.defineMethod('getMonthsInDuration',function(e){var b,c,d,a;if(!TP.isString(e)){return this.raise('TP.sig.InvalidDuration',arguments);}d=e;if(!Date.DURATION_REGEX.test(d)){return this.raise('TP.sig.InvalidDuration',arguments);}b=d.match(Date.DURATION_REGEX);a=0;if(TP.notEmpty(c=b.at(Date.DURATION_YEAR_INDEX))){a+=parseInt(c.slice(0,-1),10)*12;}if(TP.notEmpty(c=b.at(Date.DURATION_MONTH_INDEX))){a+=parseInt(c.slice(0,-1),10);}if(TP.notEmpty(b.at(Date.DURATION_MINUS_INDEX))){return 0-a;}return a;});Date.Type.defineMethod('getSecondsInDuration',function(e){var c,a,d,b;if(!TP.isString(e)){return this.raise('TP.sig.InvalidDuration',arguments);}d=e;if(!Date.DURATION_REGEX.test(d)){return this.raise('TP.sig.InvalidDuration',arguments);}c=d.match(Date.DURATION_REGEX);b=0;if(TP.notEmpty(a=c.at(Date.DURATION_DAY_INDEX))){b+=parseInt(a.slice(0,-1),10)*86400;}if(TP.notEmpty(a=c.at(Date.DURATION_HOUR_INDEX))){b+=parseInt(a.slice(0,-1),10)*3600;}if(TP.notEmpty(a=c.at(Date.DURATION_MINUTE_INDEX))){b+=parseInt(a.slice(0,-1),10)*60;}if(TP.notEmpty(a=c.at(Date.DURATION_SECOND_INDEX))){b+=parseInt(a.slice(0,-1),10);}if(TP.notEmpty(c.at(Date.DURATION_MINUS_INDEX))){return 0-b;}return b;});Date.Type.defineMethod('isLeapYear',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(a%400===0){return true;}if(a%4!==0){return false;}if(a%100===0){return false;}return true;});Date.Type.defineMethod('today',function(){var a;a=TP.dc();a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);return a;});Date.Type.defineMethod('todayUTC',function(){var a;a=TP.dc();a.setUTCHours(0);a.setUTCMinutes(0);a.setUTCSeconds(0);a.setUTCMilliseconds(0);return a;});Date.Inst.defineMethod('add',function(a){if(TP.isNumber(a)){return TP.dc(this.getTime()+a);}else if(TP.isString(a)){return this.addDuration(a);}return this.raise('TP.sig.InvalidParameter',arguments);});Date.Inst.defineMethod('addDuration',function(b){var a,c,d;c=Date.getMonthsInDuration(b);a=TP.dc(this.getTime());a.setUTCMonth(a.getUTCMonth()+c);d=Date.getSecondsInDuration(b);return TP.dc(a.getTime()+d*1000);});Date.Inst.defineMethod('formatHTTPDate',function(){var a;a=TP.join('HTTP_FORMAT'.transformDate(this),' ',this.getISOTimezone().strip(/[+:]/g));return a;});Date.Inst.defineMethod('getDayName',function(){return TP.sys.getLocale().localizeString(Date.LONG_WEEKDAY_NAMES.at(this.getDay()));});Date.Inst.defineMethod('getDayOfMonth',function(){return this.getDate();});Date.Inst.defineMethod('getDayOfWeek',function(){return this.getDay();});Date.Inst.defineMethod('getDayOfYear',function(){return this.getDaysBetween(TP.dc('01 Jan '+this.getISOYear()))+1;});Date.Inst.defineMethod('getDaysBetween',function(a){if(!TP.isDate(a)){return this.raise('TP.sig.InvalidParameter',arguments);}return((a.getTime()-this.getTime())/Date.MSPERDAY).round().abs();});Date.Inst.defineMethod('getDaysExpired',function(){var a,c,b;c=this.getMonth();a=this.getDate();for(b=0;b<c;b++){a+=Date.DAYS_PER_MONTH[b];}if(Date.isLeapYear(this.getFullYear())&&c>1){a+=1;}return a;});Date.Inst.defineMethod('getDaysLeft',function(){return this.getDaysInYear()-this.getDaysExpired();});Date.Inst.defineMethod('getDaysInYear',function(){if(Date.isLeapYear(this.getFullYear())){return 366;}return 365;});Date.Inst.defineMethod('getDaysOfMonth',function(){var b,c,a;b=TP.ac();c=Date.daysInMonth(this.getISOMonth(),this.getFullYear());for(a=0;a<c;a++){b.add(TP.dc(this.getFullYear(),this.getMonth(),a+1));}return b;});Date.Inst.defineMethod('getDaysOfWeek',function(){var a,c,d,e,b;d=this.getDay();e=d*Date.MSPERDAY;c=this.getTime();b=c-e;a=TP.ac();a.add(b);a.add(b+1*Date.MSPERDAY);a.add(b+2*Date.MSPERDAY);a.add(b+3*Date.MSPERDAY);a.add(b+4*Date.MSPERDAY);a.add(b+5*Date.MSPERDAY);a.add(b+6*Date.MSPERDAY);a.convert(function(a){return TP.dc(a);});return a;});Date.Inst.defineMethod('getISODay',function(){var a;a=this.getDay();return a===0?7:a;});Date.Inst.defineMethod('getISOMonth',function(){return this.getMonth()+1;});Date.Inst.defineMethod('getISOTime',function(a){var b;if(TP.notEmpty(a)){if(/%/.test(a)){b=a;}else{b=TP.iso.ISO8601.FORMATS.at(a);if(TP.notValid(b)){return this.raise('TP.sig.InvalidFormat',arguments,a);}}}else{b=TP.iso.ISO8601.FORMATS.at('HH:MM:SS');}return this.as('TP.iso.ISO8601',b);});Date.Inst.defineMethod('getISOTimezone',function(){var c,a,d,b,e;c=this.getTimezoneOffset();a=c/60;if(a===0){return'Z';}d=c%60;if(d===0){b='00';}else{b='#{0#}'.transformNumber(d);}e='#{0#}'.transformNumber(a);if(a.isNegative()){return TP.join('+',e,':',b);}return TP.join('-',e,':',b);});Date.Inst.defineMethod('getISOWeek',function(){var a,b,c,d,e;a=this.getJulianDay().round();b=(a+31741-a%7)%146097%36524%1461;c=(b/1460).floor();d=(b-c)%365+c;e=(d/7).floor()+1;return e;});Date.Inst.defineMethod('getISOYear',function(){return this.getFullYear();});Date.Inst.defineMethod('getJulianDay',function(){var a,b,c,d,e,f,g,h,i;a=this.getMonth()+1;b=this.getFullYear();c=this.getDate();d=this.getHours();e=this.getMinutes();f=this.getSeconds();g=this.getTimezoneOffset();h=d+(e+g)/60+f/3600;if(a<=2){a=a+12;b=b-1;}i=(365.25*b).floor()+(30.6001*(a+1)).floor()-15+1720996.5+c+h/24;return i;});Date.Inst.defineMethod('getMonthName',function(){return TP.sys.getLocale().localizeString(Date.LONG_MONTH_NAMES.at(this.getMonth()));});Date.Inst.defineMethod('getShortDayName',function(){return TP.sys.getLocale().localizeString(Date.SHORT_WEEKDAY_NAMES.at(this.getDay()));});Date.Inst.defineMethod('getShortMonthName',function(){return TP.sys.getLocale().localizeString(Date.SHORT_MONTH_NAMES.at(this.getMonth()));});Date.Inst.defineMethod('getStartOfMonth',function(){var b,c,a;a=Date.today();b=a.getTime();c=(a.getDate()-1)*Date.MSPERDAY;return b-c;});Date.Inst.defineMethod('getStartOfWeek',function(){var b,c,a;a=Date.today();b=a.getTime();c=a.getDay()*Date.MSPERDAY;return b-c;});Date.Inst.defineMethod('getUTCDayName',function(){return TP.sys.getLocale().localizeString(Date.LONG_WEEKDAY_NAMES.at(this.getUTCDay()));});Date.Inst.defineMethod('getUTCDayOfMonth',function(){return this.getUTCDate();});Date.Inst.defineMethod('getUTCDayOfWeek',function(){return this.getUTCDay();});Date.Inst.defineMethod('getUTCDayOfYear',function(){return this.getDaysBetween(TP.dc('01 Jan '+this.getUTCISOYear()))+1;});Date.Inst.defineMethod('getUTCDaysExpired',function(){var a,c,b;c=this.getUTCMonth();a=this.getUTCDate();for(b=0;b<c;b++){a+=Date.DAYS_PER_MONTH[b];}if(Date.isLeapYear(this.getUTCFullYear())&&c>1){a+=1;}return a;});Date.Inst.defineMethod('getUTCDaysLeft',function(){return this.getUTCDaysInYear()-this.getUTCDaysExpired();});Date.Inst.defineMethod('getUTCDaysInYear',function(){if(Date.isLeapYear(this.getUTCFullYear())){return 366;}return 365;});Date.Inst.defineMethod('getUTCDaysOfMonth',function(){var b,c,a;b=TP.ac();c=Date.daysInMonth(this.getUTCISOMonth(),this.getUTCFullYear());for(a=0;a<c;a++){b.add(TP.dc(this.getUTCFullYear(),this.getUTCISOMonth(),a+1));}return b;});Date.Inst.defineMethod('getUTCDaysOfWeek',function(){var a,c,d,e,b;d=this.getUTCDay();e=d*Date.MSPERDAY;c=this.getTime();b=c-e;a=TP.ac();a.add(b);a.add(b+1*Date.MSPERDAY);a.add(b+2*Date.MSPERDAY);a.add(b+3*Date.MSPERDAY);a.add(b+4*Date.MSPERDAY);a.add(b+5*Date.MSPERDAY);a.add(b+6*Date.MSPERDAY);a.convert(function(a){return TP.dc(a);});return a;});Date.Inst.defineMethod('getUTCISODay',function(){var a;a=this.getUTCDay();return a===0?7:a;});Date.Inst.defineMethod('getUTCISOMonth',function(){return this.getUTCMonth()+1;});Date.Inst.defineMethod('getUTCISOTime',function(b){var a;if(TP.notEmpty(b)){if(/%/.test(b)){a=b;}else{a=TP.iso.ISO8601.FORMATS.at(b);}if(TP.notValid(a)||!/[Z\+]$/.test(a)){return this.raise('TP.sig.InvalidFormat',arguments,b);}}else{a=TP.iso.ISO8601.FORMATS.at('HH:MM:SSZ');}return this.as('TP.iso.ISO8601',a);});Date.Inst.defineMethod('getUTCISOTimezone',function(){return'Z';});Date.Inst.defineMethod('getUTCISOWeek',function(){var a,b,c,d,e;a=this.getUTCJulianDay().round();b=(a+31741-a%7)%146097%36524%1461;c=(b/1460).floor();d=(b-c)%365+c;e=(d/7).floor()+1;return e;});Date.Inst.defineMethod('getUTCISOYear',function(){return this.getUTCFullYear();});Date.Inst.defineMethod('getUTCJulianDay',function(){var a,b,c,d,e,f,g,h,i;a=this.getUTCMonth()+1;b=this.getUTCFullYear();c=this.getUTCDate();d=this.getUTCHours();e=this.getUTCMinutes();f=this.getUTCSeconds();g=this.getUTCTimezoneOffset();h=d+(e+g)/60+f/3600;if(a<=2){a=a+12;b=b-1;}i=(365.25*b).floor()+(30.6001*(a+1)).floor()-15+1720996.5+c+h/24;return i;});Date.Inst.defineMethod('getUTCMonthName',function(){return TP.sys.getLocale().localizeString(Date.LONG_MONTH_NAMES.at(this.getUTCMonth()));});Date.Inst.defineMethod('getUTCShortDayName',function(){return TP.sys.getLocale().localizeString(Date.SHORT_WEEKDAY_NAMES.at(this.getUTCDay()));});Date.Inst.defineMethod('getUTCShortMonthName',function(){return TP.sys.getLocale().localizeString(Date.SHORT_MONTH_NAMES.at(this.getUTCMonth()));});Date.Inst.defineMethod('getUTCStartOfMonth',function(){var a,b,c;a=Date.todayUTC();b=a.getTime();c=(a.getUTCDate()-1)*Date.MSPERDAY;return b-c;});Date.Inst.defineMethod('getUTCStartOfWeek',function(){var a,b,c;a=Date.todayUTC();b=a.getTime();c=a.getUTCDay()*Date.MSPERDAY;return b-c;});Date.Inst.defineMethod('getUTCWeek',function(){var a,b,c;a=TP.dc('01 Jan '+this.getUTCFullYear());a.setUTCHours(0);a.setUTCMinutes(0);a.setUTCSeconds(0);a.setUTCMilliseconds(0);b=a.subtractDuration(TP.join('P',a.getUTCDay(),'D'));c=this.getDaysBetween(b);return(c/7).floor().integer()+1;});Date.Inst.defineMethod('getWeek',function(){var a,b,c;a=TP.dc('01 Jan '+this.getFullYear());a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);b=a.subtractDuration(TP.join('P',a.getDay(),'D'));c=this.getDaysBetween(b);return(c/7).floor().integer()+1;});Date.Inst.defineMethod('isBefore',function(b){var a;if(!TP.isDate(a=TP.dc(b))){return this.raise('TP.sig.InvalidDate',arguments);}return this.getTime()<a.getTime();});Date.Inst.defineMethod('isDSTDate',function(){var f,a,b,c,d,e;f=this.getFullYear();if(f===Date.THIS_YEAR){if(TP.notValid(a=Date.get('thisYearStartDSTDate'))){Date.set('thisYearStartDSTDate',a=Date.getDSTStartDate(Date.THIS_YEAR));}if(TP.notValid(b=Date.get('thisYearEndDSTDate'))){Date.set('thisYearEndDSTDate',b=Date.getDSTEndDate(Date.THIS_YEAR));}c=a.getTime();d=b.getTime();}else{c=Date.getDSTStartDate(this.getFullYear()).getTime();d=Date.getDSTEndDate(this.getFullYear()).getTime();}e=this.getTime();if(e>=c&&e<=d){return true;}else{return false;}});Date.Inst.defineMethod('isUTCDSTDate',function(){var f,a,b,c,d,e;f=this.getUTCFullYear();if(f===Date.THIS_YEAR){if(TP.notValid(a=Date.get('thisYearStartDSTDate'))){Date.set('thisYearStartDSTDate',a=Date.getDSTStartDate(Date.THIS_YEAR));}if(TP.notValid(b=Date.get('thisYearEndDSTDate'))){Date.set('thisYearEndDSTDate',b=Date.getDSTEndDate(Date.THIS_YEAR));}c=a.getTime();d=b.getTime();}else{c=Date.getDSTStartDate(this.getUTCFullYear()).getTime();d=Date.getDSTEndDate(this.getUTCFullYear()).getTime();}e=this.getTime();if(e>=c&&e<=d){return true;}else{return false;}});Date.Inst.defineMethod('isSameDay',function(a){if(!TP.isDate(a)){return this.raise('TP.sig.InvalidParameter',arguments);}return this.getUTCFullYear()===a.getUTCFullYear()&&this.getUTCMonth()===a.getUTCMonth()&&this.getUTCDate()===a.getUTCDate();});Date.Inst.defineMethod('isSameMonth',function(a){if(!TP.isDate(a)){return this.raise('TP.sig.InvalidParameter',arguments);}return this.getUTCFullYear()===a.getUTCFullYear()&&this.getUTCMonth()===a.getUTCMonth();});Date.Inst.defineMethod('isSameWeek',function(a){if(!TP.isDate(a)){return this.raise('TP.sig.InvalidParameter',arguments);}return a.getTime()>=this.getUTCStartOfWeek()&&a.getTime()<=this.getUTCStartOfWeek()+Date.MSPERDAY*7;});Date.Inst.defineMethod('isSameYear',function(a){if(!TP.isDate(a)){return this.raise('TP.sig.InvalidParameter',arguments);}return this.getUTCFullYear()===a.getUTCFullYear();});Date.Type.defineMethod('parseString',function(a,b){return TP.sys.getLocale().parseDate(a,b);});Date.Inst.defineMethod('setISOWeek',function(d){var a,f,e,b,c;a=this.getISOWeek();if(a===d){return;}f=Date.getSecondsInDuration(TP.join('P',((d-a)*7).abs(),'D'));e=f*1000;b=this.getTime();if(a>d){c=b-e;}else{c=b+e;}this.setTime(c);this.changed('time',TP.UPDATE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,c));return this;});Date.Inst.defineMethod('setUTCISOWeek',function(d){var a,f,e,b,c;a=this.getUTCISOWeek();if(a===d){return;}f=Date.getSecondsInDuration(TP.join('P',((d-a)*7).abs(),'D'));e=f*1000;b=this.getTime();if(a>d){c=b-e;}else{c=b+e;}this.setTime(c);this.changed('time',TP.UPDATE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,c));return this;});Date.Inst.defineMethod('setUTCWeek',function(d){var a,f,e,b,c;a=this.getUTCWeek();if(a===d){return;}f=Date.getSecondsInDuration(TP.join('P',((d-a)*7).abs(),'D'));e=f*1000;b=this.getTime();if(a>d){c=b-e;}else{c=b+e;}this.setTime(c);this.changed('time',TP.UPDATE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,c));return this;});Date.Inst.defineMethod('setWeek',function(d){var a,f,e,b,c;a=this.getWeek();if(a===d){return;}f=Date.getSecondsInDuration(TP.join('P',((d-a)*7).abs(),'D'));e=f*1000;b=this.getTime();if(a>d){c=b-e;}else{c=b+e;}this.setTime(c);this.changed('time',TP.UPDATE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,c));return this;});Date.Inst.defineMethod('subtract',function(a){if(TP.isNumber(a)){return TP.dc(this.getTime()-a);}else if(TP.isString(a)){return this.subtractDuration(a);}return this.raise('TP.sig.InvalidParameter',arguments);});Date.Inst.defineMethod('subtractDate',function(a){return TP.dc(this.getTime()-a.getTime());});Date.Inst.defineMethod('subtractDuration',function(b){var a,c,d;c=Date.getMonthsInDuration(b);a=TP.dc(this.getTime());a.setUTCMonth(a.getUTCMonth()-c);d=Date.getSecondsInDuration(b);return TP.dc(a.getTime()-d*1000);});Number.Type.defineConstant('E',Math.E);Number.Type.defineConstant('LN10',Math.LN10);Number.Type.defineConstant('LN2',Math.LN2);Number.Type.defineConstant('LOG10E',Math.LOG10E);Number.Type.defineConstant('LOG2E',Math.LOG2E);Number.Type.defineConstant('PI',Math.PI);Number.Type.defineConstant('SQRT1_2',Math.SQRT1_2);Number.Type.defineConstant('SQRT2',Math.SQRT2);Number.Type.defineConstant('TWO_PI',Math.PI*2);Number.Type.defineConstant('QUARTER_PI',Math.PI/4);Number.Type.defineConstant('EIGHTH_PI',Math.PI/8);Number.Type.defineMethod('getDecimalPoint',function(){return TP.sys.getLocale().getDecimalPoint();});Number.Type.defineMethod('getThousandsGroupSize',function(){return TP.sys.getLocale().getThousandsGroupSize();});Number.Type.defineMethod('getThousandsMatcher',function(){return TP.sys.getLocale().getThousandsMatcher();});Number.Type.defineMethod('getThousandsSeparator',function(){return TP.sys.getLocale().getThousandsSeparator();});Number.Type.defineMethod('random',function(){return Math.random();});Number.Type.defineMethod('randomInt',function(c,e){var b,d,a;if(!TP.isNumber(c)||!TP.isNumber(e)){return this.raise('TP.sig.InvalidParameter',arguments);}b=e-c+1;d=Math.random();for(a=0;a<=b-1;a++){if(d>=a/b&&d<(a+1)/b){return a+c;}}});Number.Type.defineMethod('validate',function(a){return!TP.isNaN(parseFloat(a));});Number.Inst.defineMethod('abs',function(){return Math.abs(this);});Number.Inst.defineMethod('acos',function(){return Math.acos(this);});Number.Inst.defineMethod('acosD',function(){return Math.acos(this*(180/Math.PI));});Number.Inst.defineMethod('almostEquals',function(b,c){var a;a=TP.ifInvalid(c,0);if(this-b<=a){return true;}return false;});Number.Inst.defineMethod('angleDifference',function(b){var a;a=b.standardizeAngle()-this.standardizeAngle();if(a>180){a-=360;}else if(a<=-180){a+=360;}return a;});Number.Inst.defineMethod('angleDx',function(a,b){return b*a.degreesToRadians().cos();});Number.Inst.defineMethod('angleDy',function(a,b){return b*a.degreesToRadians().sin();});Number.Inst.defineMethod('asColor',function(){var a;if(this>255){return this.raise('TP.sig.InvalidRange',arguments);}if(this<16){a='0'+this.toString(16);}else{a=this.toString(16);}return a;});Number.Inst.defineMethod('asDuration',function(){var a,b;a='PT';b=(this+0)/1000;if(b<1&&b.toString().charAt(0)!=='0'){a+='0';}a+=b+'S';return a;});Number.Inst.defineMethod('asHex',function(){var a;if(this>255){return this.raise('TP.sig.InvalidRange',arguments);}a='0x';if(this<16){a+='0'+this.toString(16);}else{a+=this.toString(16);}return a;});Number.Inst.defineMethod('asin',function(){return Math.asin(this);});Number.Inst.defineMethod('asinD',function(){return Math.asin(this*(180/Math.PI));});Number.Inst.defineMethod('atan',function(){return Math.atan(this);});Number.Inst.defineMethod('atanD',function(){return Math.atan(this*(180/Math.PI));});Number.Inst.defineMethod('atan2',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidParameter',arguments);}return Math.atan2(this,a);});Number.Inst.defineMethod('atan2D',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidParameter',arguments);}return Math.atan2(this,a)*(180/Math.PI);});Number.Inst.defineMethod('ceil',function(){return Math.ceil(this);});Number.Inst.defineMethod('cos',function(){return Math.cos(this);});Number.Inst.defineMethod('cosD',function(){return Math.cos(this*(Math.PI/180));});Number.Inst.defineMethod('degreesToRadians',function(){return this*Math.PI/180;});Number.Inst.defineMethod('exp',function(){return Math.exp(this);});Number.Inst.defineMethod('factorial',function(){var b,a;if(this<0){return 0;}b=1;for(a=1;a<=this;a++){b*=a;}return b;});Number.Inst.defineMethod('floor',function(){return Math.floor(this);});Number.Inst.defineMethod('fraction',function(d){var a,b,c;a=this.toString();if(!TP.regex.HAS_PERIOD.test(a)){return 0;}b=TP.ifInvalid(d,Number.POSITIVE_INFINITY);c='0.'+a.split('.').last().slice(0,b);return parseFloat(c);});Number.Inst.defineMethod('integer',function(){if(this<0){return this.ceil();}else{return this.floor();}});Number.Inst.defineMethod('isBetween',function(a,b){if(!TP.isNumber(a)||!TP.isNumber(b)){return this.raise('TP.sig.InvalidParameter',arguments);}return this>a&&this<b;});Number.Inst.defineMethod('isBetweenInclusive',function(a,b){if(!TP.isNumber(a)||!TP.isNumber(b)){return this.raise('TP.sig.InvalidParameter',arguments);}return this>=a&&this<=b;});Number.Inst.defineMethod('isEven',function(){return this%2===0;});Number.Inst.defineMethod('isNegative',function(){return this<0;});Number.Inst.defineMethod('isOdd',function(){return this%2===1;});Number.Inst.defineMethod('isPositive',function(){return this>=0;});Number.Inst.defineMethod('log2',function(){return Math.LOG2E*Math.log(this);});Number.Inst.defineMethod('log10',function(){return Math.LOG10E*Math.log(this);});Number.Inst.defineMethod('log',function(){return Math.log(this);});Number.Inst.defineMethod('max',function(){var a,b,c;a=this;for(b=0;b<arguments.length;b++){c=arguments[b];if(!TP.isNumber(c)){return this.raise('TP.sig.InvalidParameter',c);}a=Math.max(a,c);}return a;});Number.Inst.defineMethod('min',function(){var a,b,c;a=this;for(b=0;b<arguments.length;b++){c=arguments[b];if(!TP.isNumber(c)){return this.raise('TP.sig.InvalidParameter',c);}a=Math.min(a,c);}return a;});Number.Inst.defineMethod('minMax',function(a,b){if(!TP.isNumber(a)||!TP.isNumber(b)){return this.raise('TP.sig.InvalidParameter',arguments);}return Math.max(Math.min(this,b),a);});Number.Inst.defineMethod('modulo',function(b){var a;a=this%b;return a*b<0?a+b:a;});Number.Type.defineMethod('parseString',function(a,b){return TP.sys.getLocale().parseNumber(a,b);});Number.Inst.defineMethod('pow',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidParameter',arguments);}return Math.pow(this,a);});Number.Inst.defineMethod('radiansToDegrees',function(){return this*180/Math.PI;});Number.Inst.defineMethod('round',function(b){var a;if(TP.isNumber(b)){a=Math.pow(10,b);return Math.round(this*a)/a;}return Math.round(this);});Number.Inst.defineMethod('sin',function(){return Math.sin(this);});Number.Inst.defineMethod('sinD',function(){return Math.sin(this*(Math.PI/180));});Number.Inst.defineMethod('sqrt',function(){return Math.sqrt(this);});Number.Inst.defineMethod('standardizeAngle',function(){return this.modulo(360);});Number.Inst.defineMethod('tan',function(){return Math.tan(this);});Number.Inst.defineMethod('tanD',function(){return Math.tan(this*(Math.PI/180));});Number.Inst.defineMethod('quoted',function(a){return this.asString().quoted(a);});RegExp.Type.defineMethod('escapeMetachars',function(a){return TP.regExpEscape(a);});RegExp.Inst.defineMethod('match',function(b){var a;a=TP.str(b);if(TP.isString(a)){return a.match(this);}return;});String.Type.defineAttribute('$allHashMarker',TP.rc('[^?0]+','g'));String.Type.defineMethod('getRegisteredSubstitutions',function(){if(TP.notValid(this.$substitutions)){this.$substitutions=new TP.PHash();}return this.$substitutions;});String.Type.defineMethod('getSubstitution',function(a){return this.getRegisteredSubstitutions().at(a);});String.Type.defineMethod('parseString',function(a,b){return TP.sys.getLocale().parseString(a,b);});String.Type.defineMethod('registerSubstitution',function(c,a,d,e,f){var b;b=this.getRegisteredSubstitutions();b.atPut(c,TP.hc('dataSymbol',d,'matcher',e,'handler',f));if(TP.isString(String.$subsReStr)){String.$subsReStr=String.$subsReStr.slice(0,-1)+'|'+a+')';}else{String.$subsReStr='('+a+')';}String.$subsRe=TP.rc(String.$subsReStr);return this;});String.Inst.defineAttribute('delimiter','');String.Inst.defineMethod('add',function(d){var b,c,a;b=arguments.length;if(b>1){c=TP.ac();for(a=0;a<b;a++){c.push(arguments[a]);}return this.toString()+c.join('');}return this.toString()+TP.str(arguments[0]);});String.Inst.defineMethod('asHash',function(){var a;a=TP.lang.Hash.fromString(this.asString());if(TP.notValid(a)){return TP.hc(this.asString(),null);}});String.Inst.defineMethod('asHashedNumber',function(){return this.split('').reduce(function(b,c){var a;a=(b<<5)-b+c.charCodeAt(0);return a&a;},0);});String.Inst.defineMethod('asLowerCase',TP.StringProto.toLowerCase);String.Inst.defineMethod('asQueryString',function(){return encodeURIComponent(this);});String.Inst.defineMethod('asUnicodeLiteral',function(){var c,d,b,a;c=this.toString();d='';for(b=0;b<c.length;b++){a=c.charCodeAt(b).toString(16).toUpperCase();while(a.length<4){a='0'+a;}a='\\u'+a;d+=a;}return d;});String.Inst.defineMethod('asUpperCase',TP.StringProto.toUpperCase);String.Inst.defineMethod('charToLowerCase',function(a){return this.slice(0,a)+this.charAt(a).toLowerCase()+this.slice(a+1);});String.Inst.defineMethod('charToUpperCase',function(a){return this.slice(0,a)+this.charAt(a).toUpperCase()+this.slice(a+1);});String.Inst.defineMethod('chop',function(a){if(this.endsWith(a)){return this.slice(0,0-a.getSize());}return this.toString();});String.Inst.defineMethod('chunkToWidth',function(c){var a,b;b=TP.ac();a=0;while(a<this.getSize()){b.add(this.substr(a,c));a+=c;}return b;});String.Inst.defineMethod('collapseWhitespace',function(){var a,b;a=this.replace(/\u0020\u0020/g,' ');b=/\u0020\u0020/;while(b.test(a)){a=a.replace(/\u0020\u0020/g,' ');}a=a.trim();return a;});String.Inst.defineMethod('compact',function(h){var g,a,d,b,f,e,c;if(this.length<2){return this.toString();}g=h||TP.regex.WHITESPACE;a=this.split('');d=a.at(0);b=1;f=a.getSize();for(e=1;e<f;e++){c=a.at(e);if(d!==c){a[b]=c;d=c;b++;}else if(!g.test(c)){a[b]=c;d=c;b++;}}if(b<f){a.length=b;}return a.join('');});String.Inst.defineMethod('endsWith',function(a){var b;if(TP.isEmpty(a)){return false;}if((b=this.lastIndexOf(a))===TP.NOT_FOUND){return false;}return b===this.length-a.length;});String.Inst.defineMethod('escapeWhitespace',function(){var a;a=this.replace(/\\/g,'\\\\');a=a.replace(/\n/g,'\\n');a=a.replace(/\r/g,'\\r');a=a.replace(/\t/g,'\\t');return a;});String.Inst.defineMethod('getContent',function(){return this.toString();});String.Inst.defineMethod('getLocation',function(){return this.toString();});String.Inst.defineMethod('isSourceString',function(){if(this.getSize()<5){return false;}if(this.first()==='{'&&this.last()==='}'){return this.containsString(':');}if(this.first()==='['&&this.last()===']'){return this.containsString(',');}return false;});String.Inst.defineMethod('hasFragment',function(){return TP.regex.URI_FRAGMENT.test(this);});String.Inst.defineMethod('multiReplace',function(b){var a;a=this.toString();TP.keys(b).perform(function(c){a=a.replace(TP.rc(c,'g'),b.at(c));});return a;});String.Inst.defineMethod('overlayCharacters',function(h,i){var c,d,a,e,b,f,g;c=TP.ifInvalid(i,'@');d=this.toString();a=0;e=TP.rc(c+'{1}','g');b=h.asString();f=b.getSize();g=d.replace(e,function(d){var c;c=b.at(a);a++;if(a===f){a=0;}return c;});return g;});String.Inst.defineMethod('overlayFloat',function(f){var b,c,d,g,a,h,e;b=this.split('.');if(b.getSize()>2){this.raise('TP.sig.InvalidNumericTemplate',arguments);return this;}c=f.integer();if(TP.notEmpty(d=b.at(1))){g=d.getSize();}if(b.getSize()===2){a=f.round(g).fraction(g);if(TP.isEmpty(d)){if(a!==0){if(parseInt(a.asString().split('.').at(1).at(0),10)>4){c++;}}e='';}else{if(a!==0){e=d.overlayInteger(a.asString().split('.').at(1),TP.RIGHT);}else{e=d.overlayInteger(0,TP.RIGHT);}}h=b.at(0).overlayInteger(c,TP.LEFT);if(TP.isEmpty(h)&&TP.isEmpty(e)){return'';}return h+Number.getDecimalPoint()+e;}a=f.fraction(1);if(a!==0){if(parseInt(a.asString().split('.').at(1).at(0),10)>4){c++;}}return b.at(0).overlayInteger(c,TP.LEFT);});String.Inst.defineMethod('overlayInteger',function(h,l){var g,i,f,d,e,b,c,k,j,a;if(TP.isEmpty(this)){return'';}String.$allHashMarker.lastIndex=0;if(parseInt(h,10)===0&&String.$allHashMarker.test(this)){return'';}j=TP.ifInvalid(l,TP.LEFT);i=false;d=this;e=d.getSize();if(j===TP.LEFT){g=parseInt(h,10).abs();b=g.toString();f=Number.getThousandsMatcher();f.lastIndex=0;if(f.test(d)){f.lastIndex=0;d=d.strip(f);e=d.getSize();i=true;}if(b.getSize()>=e){if(i){return b.overlayThousands();}return b;}if(g!==0){a=b;c=e-a.getSize()-1;}else{a='';c=e-1;}for(;c>=0;c--){if(d.at(c)==='#'){continue;}else if(d.at(c)==='0'){a='0'+a;}else if(d.at(c)==='?'){a=' '+a;}}if(i){return a.overlayThousands();}return a;}if(j===TP.RIGHT){g=parseInt(h,10).abs();b=h.asString();f=Number.getThousandsMatcher();f.lastIndex=0;if(f.test(b)){this.raise('TP.sig.InvalidNumericTemplate',arguments);return this;}if(b.getSize()===e){return b;}if(b.getSize()>e){a=b.slice(0,0-(e-1));if(parseInt(b.at(e),10)>4){k=parseInt(b.at(e-1),10);a=b.slice(0,e-1);a+=k+1;}return a;}if(g!==0){a=b;c=b.getSize();}else{a='';c=0;}for(;c<e;c++){if(d.at(c)==='#'){continue;}else if(d.at(c)==='0'){a+='0';}else if(d.at(c)==='?'){a+=' ';}}return a;}return null;});String.Inst.defineMethod('overlayThousands',function(){var c,h,a,i,b,e,g,f,d;c=Number.getThousandsGroupSize();h=Number.getThousandsSeparator();a='';i=this.getSize()-c;for(b=i;b>=0;b=b-c){a=h+this.slice(b,b+c)+a;}a=this.slice(0,b+c)+a;e=a.lastIndexOf(' ');if(e!==-1){g=Number.getThousandsMatcher();g.lastIndex=0;f=a.slice(0,e+1);f=f.strip(g);d=a.slice(e+1);if(d.indexOf(',')===0){d=d.slice(1);}a=f+d;}else{if(this.getSize()%c===0){a=a.slice(1);}}return a;});String.Inst.defineMethod('processTP_sig_Request',function(a){var b,c,d,e;if(TP.isValid(b=TP.core.Node.from(this))){c=b.getDocumentElement();return TP.process(c,a);}if(TP.isValid(a)){d=TP.ifKeyInvalid(a,'dataSource',a);e=TP.ifKeyInvalid(a,'keySource',null);}return this.substitute(d,e);});String.Inst.defineMethod('quoted',function(c){var a,b;a=c||'\'';if(this.first()===a&&this.last()===a&&this.length>1){return this.toString();}b=this.escapeWhitespace();b=b.replace(TP.rc(a,'g'),'\\'+a);return a+b+a;});String.Inst.defineMethod('replaceBetweenDelimiters',function(i,k,j){var a,d,e,g,h,c,b,f;a=i.toString();a=a.slice(1,a.getSize()-1);d=k.toString();d=d.slice(1,d.getSize()-1);e=TP.rc(a+'(((.|\\n)(?!'+a+'))+?)'+d,'g');h=0;c=TP.ac();b=0;g=this;while(TP.isArray(f=e.exec(g))){h=f.index;c.push(g.slice(b,h));b=e.lastIndex;c.push(j(f.at(0),f.at(1)));e.lastIndex=b;}c.push(g.slice(b));return c.join('');});String.Inst.defineMethod('replaceWhitespace',function(b){var a;a=TP.ifInvalid(b,' ');return this.replace(/[\u0009\u000A\u000D]/g,a);});String.Inst.defineMethod('setDelimiter',function(b){var a;a=TP.ifInvalid(b,'');if(this.$get('delimiter')!==a){this.$set('delimiter',a);}return this.toString();});String.Inst.defineMethod('sliceFrom',function(c,e,f){var a,b,d;a=this.toString();b=f===true?this.lastIndexOf(c):this.indexOf(c);if(b===TP.NOT_FOUND){return a;}d=c.getSize();return e===true?a.slice(b):a.slice(b+d);});String.Inst.defineMethod('sliceTo',function(a,d,e){var b,c;b=this.toString();c=e===true?this.lastIndexOf(a):this.indexOf(a);if(c===TP.NOT_FOUND){return b;}return b.slice(0,c)+(d===true)?a:'';});String.Inst.defineMethod('splitAtIndex',function(b){var a;a=TP.ac();a.add(this.slice(0,b));a.add(this.slice(b));return a;});String.Inst.defineMethod('splitToWidth',function(r,u,m,t,s){var h,a,l,e,i,k,b,n,o,j,f,g,d,c,q,p;g=TP.ifInvalid(r,80);if(this.getSize()<=g){return this;}f=TP.ifInvalid(s,'##MARK##');l=TP.ifInvalid(t,'\n');if(TP.notTrue(m)){q='((.){0,'+g+'}[ \\t\\n]|(.){'+g+'})';p=TP.rc(q,'g');return this.replace(p,'$1'+l);}if(TP.isTrue(m)){c=TP.ac();if(/\"([^\"])*<br([^\"])*\"/.test(this)||/\'([^\'])*<br([^\'])*\'/.test(this)){c.add(this);}else if(/<br.?>/.test(this)){c.add(this.split(/<br.?>/));}else{c.add(this);}}if(TP.isTrue(m)){for(h=0;h<c.length;h++){k=c[h].replace(/</g,f+'<');k=k.replace(/>/g,'>'+f);b=k.split(f);for(a=0;a<b.length;a+=2){if(TP.notEmpty(b.at(a))){n=b.at(a).splitToWidth(g,false,false,f);o=n.split(f);b.atPut(a,o);}}b=b.flatten();d=TP.ac();d[0]='';i=0;for(a=0;a<b.length;a++){e=b.at(a);if(TP.notEmpty(e)){if(e.first()==='<'&&e.last()==='>'){d[d.length-1]+=e;}else{j=e.replace(/\&.+?\;/g,' ').getSize();if(i+j<=g){i+=j;d[d.length-1]+=e;}else{i=j;d.push(e);}}}}c[h]=d.join(l);}return c.join(l);}});String.Inst.defineMethod('stripComments',function(m,o){var e,n,b,c,g,f,j,k,l,a,i,d,h;e=this.toString();n=e.length;l=1;c=TP.ac();b='';g=false;f=false;j=false;k=false;for(d=0;d<n;d+=l){a=e.charAt(d);l=1;if(j){if(a==='\n'){j=false;c.push(a);}b=a;if(m===false){c.push(a);}continue;}else if(k){if(b==='*'&&a==='/'){k=false;}b=a;if(o===false){c.push(a);}continue;}switch(a){case'\'':if(g){if(b!=='\\'){g=false;}else{i=d-1;h=0;while(e.charAt(i)==='\\'){h++;i--;}if(h%2===0){g=false;}}}else if(!f&&b!=='\\'){g=true;}c.push(a);break;case'"':if(f){if(b!=='\\'){f=false;}else{i=d-1;h=0;while(e.charAt(i)==='\\'){h++;i--;}if(h%2===0){f=false;}}}else if(!g&&b!=='\\'){f=true;}c.push(a);break;case'/':if(g||f){c.push(a);break;}if(b==='/'){j=true;b=a;break;}if(e.charAt(d+1)==='*'||e.charAt(d+1)==='/'){if(e.charAt(d-1)==='\\'){b=null;}else if(o!==false&&e.charAt(d+1)==='*'){b=a;break;}else if(m!==false&&e.charAt(d+1)==='/'){b=a;break;}}c.push(a);break;case'*':if(g||f){b=a;c.push(a);break;}if(b==='/'){k=true;b=a;break;}c.push(a);break;default:c.push(a);break;}b=a;}return c.join('');});String.Inst.defineMethod('stripEnclosingQuotes',function(){return this.replace(TP.regex.QUOTED_CONTENT,'$2');});String.Inst.defineMethod('stripExternalBodyContent',function(){var a;a=this.toString();TP.regex.HTML_IMG_ELEM.lastIndex=0;a=a.strip(TP.regex.HTML_IMG_ELEM);return a;});String.Inst.defineMethod('stripExternalHeadContent',function(){var a;a=this.toString();TP.regex.HTML_SCRIPT_ELEM.lastIndex=0;a=a.strip(TP.regex.HTML_SCRIPT_ELEM);TP.regex.HTML_CSS_LINK_ELEM.lastIndex=0;a=a.strip(TP.regex.HTML_CSS_LINK_ELEM);TP.regex.HTML_CSS_STYLE_ELEM.lastIndex=0;a=a.strip(TP.regex.HTML_CSS_STYLE_ELEM);return a;});String.Inst.defineMethod('stripTags',function(){return this.strip(/<\/?[^>]+>/gi);});String.Inst.defineMethod('stripWhitespace',function(){return this.strip(/\s/g);});String.Inst.defineMethod('substitute',function(c,d,e){var a,f,g,h,b;TP.debug('break.content_substitute');if(TP.notValid(String.$subsRe)||!String.$subsRe.test(this)){return this;}f=TP.ifInvalid(c,'');g=TP.ifInvalid(d,TP.hc());a=this.toString();if(TP.isRegExp(String.$subsRe)){while(TP.isArray(b=a.match(String.$subsRe))){h=this.getType().getSubstitution(b[1]).at('dataSymbol');a=a.substituteFor(b[1],f,g,e);}}return a.substitute(c,d,e);});String.Inst.defineMethod('substituteFor',function(j,l,k,i){var c,a,g,e,b,d,f,h;c=this.getType().getSubstitution(j);if(TP.notValid(c)){return this;}a=TP.ifInvalid(l,'');g=TP.ifInvalid(k,TP.hc());e=this;b=TP.ac();d=0;while(TP.isArray(f=c.at('matcher').exec(e))){b.push(RegExp.leftContext);e=RegExp.rightContext;if(TP.isArray(a)){h=d-(d/a.getSize()).integer()*a.getSize();b.push(c.at('handler')(f.first(),a.at(h),g,i));d++;}else{b.push(c.at('handler')(f.first(),a,g,i));}}b.push(e);return b.join('');});String.registerSubstitution('@{','@\\{','@',TP.rc('@\\{(.+?)\\}'),function(a,c,d){var b;b=a.slice(2,a.getSize()-1);return b.overlayCharacters(c,'@');});String.registerSubstitution('%{','%\\{','%',TP.rc('%\\{(.+?)\\}'),function(a,c,e){var d,b;d=a.slice(2,a.getSize()-1);b=TP.val(e,d);if(TP.notValid(b)){TP.debug('break.formatter');TP.ifWarn()?TP.warn('Format handler not found for: '+a,TP.LOG,arguments):0;return c;}return b.getValue(c);});String.registerSubstitution('#{','#\\{','#',TP.rc('#\\{(.+?)\\}'),function(a,c,d){var b;b=a.slice(2,a.getSize()-1);return b.overlayFloat(c);});String.Inst.defineMethod('tabsToSpaces',function(c){var a,b;b=TP.ifInvalid(c,4);a=' '.times(b);return this.replace(/\t/g,a);});String.Inst.defineMethod('tokenizeWhitespace',function(){return this.replaceWhitespace().collapseWhitespace();});String.Inst.defineMethod('trimLeft',function(b){var a;a=0;if(this.indexOf(b)!==TP.NOT_FOUND){a=this.indexOf(b)+1;}return this.slice(a);});String.Inst.defineMethod('trimRight',function(b){var a;a=this.getSize();if(this.lastIndexOf(b)!==TP.NOT_FOUND){a=this.lastIndexOf(b);}return this.slice(0,a);});String.Inst.defineMethod('truncate',function(a,c){var d,b;d=TP.ifInvalid(a,TP.DEFAULT_STRLEN);b=TP.ifInvalid(c,'...');if(this.getSize()<=a){return this.toString();}return this.substr(0,a-b.getSize())+b;});String.Inst.defineMethod('unicodeEscaped',function(){var a,c,b;b=TP.ac();c=this.getSize();for(a=0;a<c;a++){b.push('\\u',this.charCodeAt(a).asHex().split('x').last().pad(4,'0'));}return b.join('');});String.Inst.defineMethod('unquoted',function(a){var c,b,d;if(TP.notEmpty(a)){c=a.length;if(this.first(c)===a&&this.last(c)===a){b=this.slice(c,this.getSize()-c);d=TP.rc('\\'+a,'g');return b.replace(d,a);}return this.toString();}if(this.first()==='"'&&this.last()==='"'){b=this.slice(1,this.getSize()-1);return b.replace(/\\"/g,'"');}if(this.first()==='\''&&this.last()==='\''){b=this.slice(1,this.getSize()-1);return b.replace(/\\'/g,'\'');}return this.toString();});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETCollections.js';
TP.api.CollectionAPI=TP.ac('add','addAll','addAllIfAbsent','addIfAbsent','addItem','addWithCount','asArray','asHash','asIterator','asRange','asString','collapse','collect','collectGet','collectInvoke','compact','conform','contains','containsAll','containsAny','containsString','convert','countOf','detect','detectInvoke','detectMax','detectMin','difference','disjunction','empty','flatten','getItems','getIterator','getIteratorType','getSize','getValues','grep','groupBy','injectInto','intersection','isSortedCollection','merge','partition','perform','performInvoke','performSet','performUntil','performWhile','performWith','reject','remove','removeAll','replace','replaceAll','select','union','unique');TP.api.IndexedCollectionAPI=TP.ac('addAt','addAllAt','at','atAll','atAllIfAbsent','atAllPut','atIfInvalid','atIfNull','atIfUndefined','atPut','atPutIfAbsent','containsKey','containsValue','detectKeyAt','getKeys','getKVPairs','getPairs','getPosition','getPositions','grepKeys','performOver','removeAt','removeAtAll','removeKey','removeKeys','transpose');TP.api.OrderedCollectionAPI=TP.ac('addAfter','addAllAfter','addAllBefore','addAllFirst','addAllLast','addBefore','addFirst','addLast','after','before','first','getLastPosition','last','orderedBy','removeFirst','removeLast','replaceFirst','replaceLast','reverse');TP.api.OrderedPairAPI=TP.ac('getPair','first','last');TP.sys.SortedCollectionAPI=TP.ac('getSortFunction','setSortFunction','sort');TP.api.IterationAPI=TP.ac('at','atAll','getKeys','getSize');Array.Inst.defineMethod('equalAs',function(i){var a,g,e,f,b,c,d,h;if(TP.isEmpty(this)){return false;}a=this.first();if(TP.notValid(a)){g=this.detect(function(a){return TP.isValid(a);},1);return TP.isValid(g);}b=TP.ifInvalid(i,a.getType());if(TP.canInvoke(a,'as')){e=a.as(b);}else{e=b.from(a);}f=true;h=this.length;for(c=0;c<h;c++){d=this[c];if(TP.canInvoke(d,'as')){a=d.as(b);}else{a=b.from(d);}if(a!=e){f=false;return TP.BREAK;}}return f;});Array.Inst.defineMethod('$$isCollection',function(){return true;});Array.Inst.defineMethod('vslice',function(g,k,j){var d,e,c,b,a,f,i,h;if(TP.isString(g)){if(TP.isEmpty(d=g.split(':'))){return null;}b=d.at(0).slice(1).asNumber();if(d.getSize()>2){a=d.at(1).asNumber();c=d.at(2).slice(0,d.at(2).getSize()-1).asNumber();}else{a=d.at(1).slice(0,d.at(1).getSize()-1).asNumber();}}else{b=g;a=k;c=j;}if(TP.notValid(c)||TP.isNaN(c=c.asNumber())){c=1;}if(TP.notValid(b)||TP.isNaN(b=b.asNumber())){if(c.isNegative()){b=this.getSize()-1;}else{b=0;}}f=false;if(TP.notValid(a)||TP.isNaN(a=a.asNumber())){f=true;if(c.isNegative()){a=0;}else{a=this.getSize()-1;}}e=this.getSize();if(b.isNegative()){b=(e+b).max(0);}else{b=b.min(e);}if(a.isNegative()){a=(e+a).max(0);}else{a=a.min(e);}if(!f){if(c.isPositive()){a-=1;}else{a+=1;}}if(b>a&&!c.isNegative()){i=a;a=b;b=i;}h=TP.core.Range.construct(b,a,c);return h;});Array.Inst.defineMethod('truncate',function(c){var a,b;a=parseInt(c,10);b=this.length;if(!TP.isNumber(a)){return this;}a=a.max(0);if(a>this.getSize()){return this;}this.length=a;if(b!==a){this.changed('length',TP.DELETE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,this.length));}return this;});Array.Inst.defineMethod('add',function(b){var a;if(arguments.length>0){a=this.length;this.push.apply(this,arguments);this.changed('length',TP.INSERT,TP.hc(TP.OLDVAL,a,TP.NEWVAL,this.length));}return this;});Array.Inst.defineMethod('addAll',function(a){var c,b;b=this.length;if(TP.isArray(a)){this.push.apply(this,a);}else{if(!TP.canInvoke(a,'perform')){return this.raise('TP.sig.InvalidCollection',arguments);}c=this;a.perform(function(a){c.push(a);});}if(this.length!==b){this.changed('length',TP.INSERT,TP.hc(TP.OLDVAL,b,TP.NEWVAL,this.length));}return this;});Array.Inst.defineMethod('addAllIfAbsent',function(a){return TP.todo();});Array.Inst.defineMethod('addIfAbsent',function(a,b){if(this.contains(a,b)){return this;}return this.add(a);});Array.Inst.defineMethod('addItem',function(a){if(TP.isPair(a)&&TP.isNumber(a.first())){this.atPut(a.first(),a.last());}else{this.add(a);}return this;});Array.Inst.defineMethod('addWithCount',function(e,c){var b,a,d;if(TP.notValid(c)){return;}a=parseInt(c,10);if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidParameter',arguments);}d=this.length;for(b=0;b<a;b++){this.push(e);}if(a>1){this.changed('length',TP.INSERT,TP.hc(TP.OLDVAL,d,TP.NEWVAL,this.length));}return this;});Array.Inst.defineMethod('asArray',function(){return this;});Array.Inst.defineMethod('asHash',function(){var b,c,a;b=TP.hc();c=this.length;for(a=0;a<c;a++){b.atPut(a,this[a]);}return b;});Array.Inst.defineMethod('asTP_lang_Hash',Array.getInstPrototype().asHash);Array.Inst.defineMethod('asIterator',function(a){this.$sortIfNeeded();return this.getIteratorType().construct(this,a);});Array.Inst.defineMethod('asRange',function(){var a;if(TP.notValid(a=TP.sys.require('TP.core.Range'))){return this.raise('TP.sig.TypeNotFound',arguments);}return a.construct(1,this.length);});Array.Inst.defineMethod('collapse',function(){if(this.getSize()===1){return this.at(0);}return this;});Array.Inst.defineMethod('containsAll',function(b,e){var a,c,d;if(TP.isArray(b)){if(TP.isEmpty(b)){return false;}a=b.copy();}else{if(!TP.canInvoke(b,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}a=b.asArray();if(TP.isEmpty(a)){return false;}}c=this.copy();if(e===TP.IDENTITY){c.sort(TP.IDENTITY_SORT);a.sort(TP.IDENTITY_SORT);}else{c.sort(TP.EQUALITY_SORT);a.sort(TP.EQUALITY_SORT);}d=a.detect(function(a,b){return!c.contains(a);});return TP.notValid(d);});Array.Inst.defineMethod('containsAny',function(b,e){var a,c,d;if(TP.isArray(b)){if(TP.isEmpty(b)){return false;}a=b.copy();}else{if(!TP.canInvoke(b,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}a=b.asArray();if(TP.isEmpty(a)){return false;}}c=this.copy();if(e===TP.IDENTITY){c.sort(TP.IDENTITY_SORT);a.sort(TP.IDENTITY_SORT);}else{c.sort(TP.EQUALITY_SORT);a.sort(TP.EQUALITY_SORT);}d=a.detect(function(a,b){return c.contains(a);});return TP.isValid(d);});Array.Inst.defineMethod('countOf',function(a,b){return this.select(function(c,d){switch(b){case TP.IDENTITY:return TP.identical(c,a);default:return TP.equal(c,a);}}).getSize();});Array.Inst.defineMethod('difference',function(a,c){var b;if(!TP.canInvoke(a,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}b=a.asArray();return this.select(function(a,c){return!b.contains(a);});});Array.Inst.defineMethod('disjunction',function(b,d){var c,a;c=this;a=this.difference(b);a=b.injectInto(a,function(a,b,d){if(!c.contains(a)){b.push(a);}return b;});return a;});Array.Inst.defineMethod('empty',function(){var a;a=this.length;this.length=0;this.changed('length',TP.DELETE,TP.hc(TP.OLDVAL,a,TP.NEWVAL,this.length));return this;});Array.Inst.defineMethod('flatten',function(){var a,d,b,c;a=TP.ac();d=this.length;for(b=0;b<d;b++){c=this[b];if(TP.isArray(c)){a.addAll(c.flatten());}else{a.push(c);}}return a;});Array.Inst.defineMethod('getIterator',function(){if(TP.notValid(this.$get('iterator'))){this.$set('iterator',this.asIterator());}return this.$get('iterator');});Array.Inst.defineMethod('getIteratorType',function(){var a;if(TP.notValid(a=TP.sys.getTypeByName('TP.core.Iterator'))){return this.raise('TP.sig.TypeNotFound',arguments);}return a;});Array.Inst.defineMethod('intersection',function(a,b){if(!TP.canInvoke(a,'contains')){return this.raise('TP.sig.InvalidCollection',arguments);}return this.select(function(c){return a.contains(c,b);});});Array.Inst.defineMethod('isSortedCollection',function(){return TP.isCallable(this.getSortFunction());});Array.Inst.defineMethod('merge',function(){var b,c,a,d;b=TP.args(arguments);b.unshift(this);c=TP.ac();d=this.length;for(a=0;a<d;a++){c.push(b.collectGet(a));}return c;});Array.Inst.defineMethod('remove',function(e,g){var d,b,a,c,f;if(TP.notValid(e)){return 0;}a=0;b=this.length;for(d=0;d<b;d++){c=this[d];switch(g){case TP.IDENTITY:if(!TP.identical(c,e)){this[a]=c;a++;}break;default:if(!TP.equal(c,e)){this[a]=c;a++;}break;}}f=0;if(a<b){f=b-a;this.length=a;this.changed('length',TP.DELETE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,this.length));}return f;});Array.Inst.defineMethod('removeAll',function(a,g){var b,c,d,e,f;if(TP.isArray(a)){b=a;}else{if(!TP.canInvoke(a,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}b=a.asArray();}if(TP.isEmpty(b)){return 0;}c=0;d=this;e=this.shouldSignalChange();this.shouldSignalChange(false);f=this.length;try{b.perform(function(a,b){c+=d.remove(a);});}catch(a){}finally{this.shouldSignalChange(e);}if(c>0){this.changed('length',TP.DELETE,TP.hc(TP.OLDVAL,f,TP.NEWVAL,this.length));}return c;});Array.Inst.defineMethod('replace',function(b,c,f){var d,a,e;d=this.shouldSignalChange();this.shouldSignalChange(false);a=0;e=this.length;try{this.convert(function(d,e){switch(f){case TP.IDENTITY:if(TP.identical(d,b)){a++;return c;}break;default:if(TP.equal(d,b)){a++;return c;}break;}return d;});}catch(a){}finally{this.shouldSignalChange(d);}if(a>0){this.changed('length',TP.UPDATE,TP.hc(TP.OLDVAL,e,TP.NEWVAL,this.length));}return a;});Array.Inst.defineMethod('replaceAll',function(a,g,h){var b,c,d,e,f;if(TP.isArray(a)){b=a;}else{if(!TP.canInvoke(a,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}b=a.asArray();}if(TP.isEmpty(b)){return 0;}c=0;d=this;e=this.length;f=this.shouldSignalChange();this.shouldSignalChange(false);try{b.perform(function(a,b){c+=d.replace(a,g);});}catch(a){}finally{this.shouldSignalChange(f);}if(c>0){this.changed('length',TP.UPDATE,TP.hc(TP.OLDVAL,e,TP.NEWVAL,this.length));}return c;});Array.Inst.defineMethod('union',function(b){var a;if(!TP.canInvoke(b,'injectInto')){return this.raise('TP.sig.InvalidCollection',arguments);}a=this.copy();a=b.injectInto(a,function(b,a,c){a.push(b);return a;});return a;});Array.Inst.defineMethod('addAt',function(b,d){var a,c;a=parseInt(d,10);if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidIndex',arguments);}a=a>0?a:this.normalizeIndex(a);c=this.length;if(this.length<a){this[a]=b;}else{this.splice(a,0,b);}this.changed('length',TP.INSERT,TP.hc(TP.OLDVAL,c,TP.NEWVAL,this.length));return this;});Array.Inst.defineMethod('addAllAt',function(b,f){var d,a,e,c;a=parseInt(f,10);if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidIndex',arguments);}if(TP.isArray(b)){d=b;}else{if(!TP.canInvoke(b,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}d=b.asArray();}c=TP.ac();a=a>0?a:this.normalizeIndex(a);e=this.length;if(this.length<a){this[a]='$$BOGON$$';c.push(a,1);}else{c.push(a,0);}this.splice.apply(this,c.addAll(d));this.changed('length',TP.INSERT,TP.hc(TP.OLDVAL,e,TP.NEWVAL,this.length));return this;});Array.Inst.defineMethod('atAll',function(a){var b,c,d;if(TP.isArray(a)){b=a;}else{if(!TP.canInvoke(a,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}b=a.asArray();}this.$sortIfNeeded();d=this;c=TP.ac();b.perform(function(a,b){c.push(d.at(a));});return c;});Array.Inst.defineMethod('atAllIfAbsent',function(a){return TP.todo();});Array.Inst.defineMethod('atAllPut',function(a,e){var b,c,d,f;if(TP.isArray(a)){b=a;}else{if(!TP.canInvoke(a,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}b=a.asArray();}this.$sortIfNeeded();c=0;d=this;f=this.length;b.perform(function(a,b){if(!TP.equal(d.at(a),e)){c++;d.atPut(a,e);}});if(c>0){this.changed('length',TP.UPDATE,TP.hc(TP.OLDVAL,f,TP.NEWVAL,this.length));}return this;});Array.Inst.defineMethod('atIfInvalid',function(c,a){var b;if(TP.isValid(b=this.at(c))){return b;}else if(TP.isCallable(a)){return a();}else{return a;}});Array.Inst.defineMethod('atIfNull',function(c,a){var b;if(TP.notNull(b=this.at(c))){return b;}else if(TP.isCallable(a)){return a();}else{return a;}});Array.Inst.defineMethod('atIfUndefined',function(c,a){var b;if(TP.isDefined(b=this.at(c))){return b;}else if(TP.isCallable(a)){return a();}else{return a;}});Array.Inst.defineMethod('atPutIfAbsent',function(a,b){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.notDefined(this[a])){this.atPut(a,b);}return this.at(a);});Array.Inst.defineMethod('detectKeyAt',function(b,c){var a;a=TP.ifInvalid(c,0);return this.detect(function(c){if(!TP.isArray(c)){return;}return TP.isValid(b.match(c.at(a)));});});Array.Inst.defineMethod('getPosition',function(b,c,d){var a;a=TP.NOT_FOUND;this.detect(function(c,e){switch(d){case TP.IDENTITY:if(TP.identical(c,b)){a=e;return true;}break;default:if(TP.equal(c,b)){a=e;return true;}break;}},c);return a;});Array.Inst.defineMethod('getPositions',function(b,d,e){var a,c;c=TP.ifInvalid(this.normalizeIndex(d),0);this.$sortIfNeeded();a=TP.ac();this.perform(function(f,d){if(d<c){return;}switch(e){case TP.IDENTITY:if(TP.identical(f,b)){a.push(d);}break;default:if(TP.equal(f,b)){a.push(d);}break;}});return a;});Array.Inst.defineMethod('removeAt',function(c){var a,b;a=parseInt(c,10);if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidIndex',arguments);}this.$sortIfNeeded();a=a>0?a:this.normalizeIndex(a);b=this.length;this.splice(a,1);this.changed('length',TP.DELETE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,this.length));return this;});Array.Inst.defineMethod('removeAtAll',function(b){var a,c,d,e;c=0;d=this;if(TP.isArray(b)){a=b.copy();}else{if(!TP.canInvoke(b,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}a=b.asArray();}if(TP.isEmpty(a)){return this;}a.sort();e=this.length;a.perform(function(a){d.splice(d.normalizeIndex(a)-c,1);c++;});if(c>0){this.changed('length',TP.DELETE,TP.hc(TP.OLDVAL,e,TP.NEWVAL,this.length));}return this;});Array.Inst.defineMethod('transpose',function(){var a,b;a=this.getItems();b=a.shift();return b.merge.apply(b,a);});Array.Inst.defineMethod('addAfter',function(b,c,d){var a;a=this.getPosition(c,0,d);if(a===TP.NOT_FOUND){return this.raise('TP.sig.NotFound',arguments);}return this.addAt(b,a+1);});Array.Inst.defineMethod('addAllAfter',function(b,c,d){var a;a=this.getPosition(c,0,d);if(a===TP.NOT_FOUND){return this.raise('TP.sig.NotFound',arguments);}return this.addAllAt(b,a+1);});Array.Inst.defineMethod('addAllBefore',function(b,c,d){var a;a=this.getPosition(c,0,d);if(a===TP.NOT_FOUND){return this.raise('TP.sig.NotFound',arguments);}return this.addAllAt(b,a);});Array.Inst.defineMethod('addAllFirst',function(a){return this.addAllAt(a,0);});Array.Inst.defineMethod('addAllLast',function(a){return this.addAllAt(a,this.length);});Array.Inst.defineMethod('addBefore',function(b,c,d){var a;a=this.getPosition(c,0,d);if(a===TP.NOT_FOUND){return this.raise('TP.sig.NotFound',arguments);}return this.addAt(b,a);});Array.Inst.defineMethod('addFirst',function(b){var a;if(arguments.length>0){a=this.length;this.unshift.apply(this,arguments);this.changed('length',TP.INSERT,TP.hc(TP.OLDVAL,a,TP.NEWVAL,this.length));}});Array.Inst.defineMethod('addLast',function(b){var a;if(arguments.length>0){a=this.length;this.push.apply(this,arguments);this.changed('length',TP.INSERT,TP.hc(TP.OLDVAL,a,TP.NEWVAL,this.length));}return this;});Array.Inst.defineMethod('after',function(b,c,d){var a;a=this.getPosition(b,0,c);if(a===TP.NOT_FOUND){return;}return this.at(a+1);});Array.Inst.defineMethod('before',function(b,c,d){var a;a=this.getPosition(b,0,c);if(a===TP.NOT_FOUND||a===0){return;}return this.at(a-1);});Array.Inst.defineMethod('getLastPosition',function(b,d,c){var a;a=TP.NOT_FOUND;this.perform(function(d,e){switch(c){case TP.IDENTITY:if(TP.identical(d,b)){a=e;return TP.BREAK;}break;default:if(TP.equal(d,b)){a=e;return TP.BREAK;}break;}},null,true);return a;});Array.Inst.defineMethod('removeFirst',function(c,d){var a,b;a=this.getPosition(c,0,d);if(a!==TP.NOT_FOUND){b=this.length;this.splice(a,1);this.changed('length',TP.DELETE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,this.length));}return this;});Array.Inst.defineMethod('removeLast',function(c,d){var a,b;a=this.length;if(TP.notValid(c)){this.length=this.length-1;this.changed('value',TP.DELETE,TP.hc(TP.OLDVAL,a,TP.NEWVAL,this.length));}else{b=this.getLastPosition(c,this.getSize(),d);if(b!==TP.NOT_FOUND){this.splice(b,1);this.changed('value',TP.DELETE,TP.hc(TP.OLDVAL,a,TP.NEWVAL,this.length));}}return this;});Array.Inst.defineMethod('replaceFirst',function(b,c,d){var a;a=this.getPosition(b,0,d);if(a===TP.NOT_FOUND){return this;}this.atPut(a,c);return this;});Array.Inst.defineMethod('replaceLast',function(b,c,d){var a;a=this.getLastPosition(b,d);if(a===TP.NOT_FOUND){return this;}this.atPut(a,c);return this;});Array.Inst.defineMethod('getSortFunction',function(){return this.sortFunction;});Array.Inst.defineMethod('isSorted',function(){return!this.$needsSort;});Array.Inst.defineMethod('setSortFunction',function(a){if(TP.identical(a,this.sortFunction)){return this;}this.sortFunction=a;this.$firstSort=true;this.changed('order',TP.SORTED);return this;});Array.Inst.defineMethod('avg',function(){return this.sum()/this.getSize();});Array.Inst.defineMethod('max',function(){return this.detectMax(TP.RETURN_ARG0);});Array.Inst.defineMethod('min',function(){return this.detectMin(TP.RETURN_ARG0);});Array.Inst.defineMethod('sum',function(){var a;a=0;a=this.injectInto(a,function(c,b,d){var a;a=parseInt(c,10);if(TP.isNumber(a)){return b+a;}return b;});return a;});Array.Inst.defineMethod('times',function(c,d){var a,b;if(c<2){return TP.isFalse(d)?this.copy():this;}if(TP.isFalse(d)){b=this;a=this.copy();}else{b=this.copy();a=this;}(c-1).perform(function(){a.addAll(b);});return a;});TP.defineCommonMethod('collapse',function(){return this;});TP.defineCommonMethod('asHash',function(){var a;a=TP.hc();this.perform(function(b,c){a.atPut(b.first(),b.last(),false);});return a;});TP.defineCommonMethod('removeKey',function(b){var a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments);}a=this.at(b);if(TP.notDefined(a)){return;}if(TP.isMethod(a)){return this.raise('TP.sig.InvalidOperation',arguments,'Attempt to replace/remove method: '+a);}delete this[b];this.changed('value',TP.DELETE);return this;});TP.defineCommonMethod('removeKeys',function(c){var b,a;if(TP.notValid(c)){return this.raise('TP.sig.InvalidParameter',arguments);}b=false;a=this;c.perform(function(d){var c;c=a.at(d);if(TP.notDefined(c)){return;}if(TP.isMethod(c)){a.raise('TP.sig.InvalidOperation',arguments,'Attempt to replace/remove method: '+c);return TP.BREAK;}b=true;delete a[d];});if(b){this.changed('value',TP.DELETE);}return this;});TP.backstop(['asIterator'],TP.NumberProto);Number.Inst.defineMethod('asRange',function(c,d){var a,b;b=TP.ifInvalid(this.normalizeIndex(c),0);a=TP.ifInvalid(d,1);return b.to(this).by(a);});Number.Inst.defineMethod('getItems',function(){return this.asRange();});Number.Inst.defineMethod('getPosition',function(a){return this.toString().getPosition(a);});Number.Inst.defineMethod('times',function(a){var b;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=parseInt(a,10);if(TP.isNumber(b)){return this*b;}if(TP.isCallable(a)){return this.perform(a);}if(TP.canInvoke(a,'times')){return a.times(this);}return this;});Number.Inst.defineMethod('to',function(b){var a;if(TP.notValid(a=TP.sys.require('TP.core.Range'))){return this.raise('TP.sig.TypeNotFound',arguments);}return a.construct(this,b);});String.Inst.defineMethod('$$isPair',function(){return false;});String.Inst.defineMethod('asHash',function(){return TP.hc('value',this.toString());});String.Inst.defineMethod('asIterator',function(a){return TP.todo();});String.Inst.defineMethod('asRange',function(){return TP.todo();});String.Inst.defineMethod('collapse',function(){if(this.getSize()===1){return this.charAt(0);}return this;});String.Inst.defineMethod('contains',function(a){return this.indexOf(a)!==TP.NOT_FOUND;});String.Inst.defineMethod('containsAll',function(a){var b,c,d;if(TP.isArray(a)){b=a;}else{if(!TP.canInvoke(a,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}b=a.asArray();}if(TP.isEmpty(b)){return false;}d=this;c=b.detect(function(a,b){return TP.notTrue(d.contains(a));});return TP.notValid(c);});String.Inst.defineMethod('containsAny',function(a){var b,c,d;if(TP.isArray(a)){b=a;}else{if(!TP.canInvoke(a,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}b=a.asArray();}if(TP.isEmpty(b)){return false;}d=this;c=b.detect(function(a,b){return d.contains(a);});return TP.isValid(c);});String.Inst.defineMethod('containsString',function(a){return this.indexOf(a)!==TP.NOT_FOUND;});String.Inst.defineMethod('countOf',function(a,b){return this.getPositions(a).getSize();});String.Inst.defineMethod('detect',function(c,d){var a,b;b=TP.ifInvalid(this.normalizeIndex(d),0);a=undefined;this.perform(function(d,e){if(e<b){return;}if(c(d,e)){a=d;return TP.BREAK;}});return a;});String.Inst.defineMethod('difference',function(a,b){return TP.todo();});String.Inst.defineMethod('disjunction',function(a,b){return TP.todo();});String.Inst.defineMethod('getIterator',function(){if(TP.notValid(this.$get('iterator'))){this.$set('iterator',this.asIterator());}return this.$get('iterator');});String.Inst.defineMethod('getIteratorType',function(){var a;if(TP.notValid(a=TP.sys.getTypeByName('TP.core.Iterator'))){return this.raise('TP.sig.TypeNotFound',arguments);}return a;});String.Inst.defineMethod('intersection',function(a,b){if(!TP.canInvoke(a,'contains')){return this.raise('TP.sig.InvalidCollection',arguments);}return this.select(function(c){return a.contains(c,b);});});String.Inst.defineMethod('isSortedCollection',function(){return false;});String.Inst.defineMethod('union',function(a){return TP.todo();});String.Inst.defineMethod('atAll',function(a){return this.split('').atAll(a);});String.Inst.defineMethod('atAllIfAbsent',function(a){return TP.todo();});String.Inst.defineMethod('atIfInvalid',function(c,a){var b;if(TP.isValid(b=this.at(c))){return b;}else if(TP.isCallable(a)){return a();}else{return a;}});String.Inst.defineMethod('atIfNull',function(c,a){var b;if(TP.notNull(b=this.at(c))){return b;}else if(TP.isCallable(a)){return a();}else{return a;}});String.Inst.defineMethod('atIfUndefined',function(c,a){var b;if(TP.isDefined(b=this.at(c))){return b;}else if(TP.isCallable(a)){return a();}else{return a;}});String.Inst.defineMethod('detectKeyAt',function(b,c){var a;a=TP.ifInvalid(c,0);return this.detect(function(c){if(!TP.isArray(c)){return;}return TP.isValid(b.match(c.at(a)));});});String.Inst.defineMethod('getPosition',function(a,b){return this.indexOf(a,b);});String.Inst.defineMethod('getPositions',function(c,d){var b,a;b=TP.ac();a=this.indexOf(c,d);while(a!==TP.NOT_FOUND){b.add(a);a=this.indexOf(c,a+1);}return b;});String.Inst.defineMethod('after',function(b){var a;a=this.indexOf(b);if(a===TP.NOT_FOUND){return;}return this.slice(a+b.getSize(),this.getSize());});String.Inst.defineMethod('before',function(b){var a;a=this.indexOf(b);if(a===TP.NOT_FOUND){return;}return this.slice(0,a);});String.Inst.defineMethod('getLastPosition',function(a,b,c){return this.lastIndexOf(a,b);});TP.lang.Object.defineSubtype('lang:Hash');TP.lang.Hash.Type.defineConstant('STYLE_STRING_PARSER',function(b){var a;TP.regex.STYLE_STRING.lastIndex=0;if(TP.regex.STYLE_STRING.test(b)){a=TP.hc();TP.regex.STYLE_STRING.performWith(function(d,b,c,e,f){if(b=b.strip(';').asDOMName()){a.atPut(b,c);}},b);}else{return null;}return a;});TP.lang.Hash.addParser(TP.lang.Hash.STYLE_STRING_PARSER);TP.lang.Hash.Type.defineConstant('ATTRIBUTE_STRING_PARSER',function(b){var a;TP.regex.ATTRIBUTE_STRING.lastIndex=0;if(TP.regex.ATTRIBUTE_STRING.test(b)){a=TP.hc();TP.regex.ATTRIBUTE_STRING.performWith(function(d,b,e,c,f,g){if(TP.notEmpty(b)){a.atPut(b,c);}},b);}else{return null;}return a;});TP.lang.Hash.addParser(TP.lang.Hash.ATTRIBUTE_STRING_PARSER);TP.lang.Hash.Type.defineConstant('URI_STRING_PARSER',function(c){var b,d,e,f,a,g,h;b=TP.hc();if(TP.notEmpty(TP.regex.URI_STRICT.exec(c).at(1))){d=TP.regex.URI_STRICT;}else if(TP.notEmpty(TP.regex.URI_LOOSE.exec(c).at(1))){d=TP.regex.URI_LOOSE;}else{return null;}e=d.exec(c);f=TP.ac('source','scheme','authority','userInfo','user','password','host','port','relative','path','directory','file','query','fragment');for(a=0;a<f.getSize();a++){b.atPut(f.at(a),TP.notEmpty(e.at(a))?e.at(a):'');}if(TP.notEmpty(g=b.at('query'))){h=TP.lang.Hash.fromString(g);b.atPut('queryDict',h);}return b;});TP.lang.Hash.addParser(TP.lang.Hash.URI_STRING_PARSER);TP.lang.Hash.Type.defineConstant('QUERY_STRING_PARSER',function(b){var a;a=TP.hc();TP.regex.URI_QUERY.lastIndex=0;if(!TP.regex.URI_QUERY.test(b)){return null;}TP.regex.URI_QUERY.lastIndex=0;b.replace(TP.regex.URI_QUERY,function(d,b,c){if(TP.notEmpty(b)){a.atPut(b,decodeURIComponent(c));}});return a;});TP.lang.Hash.addParser(TP.lang.Hash.QUERY_STRING_PARSER);TP.definePrimitive('hc',function(){var c,b,a,g,d,e,f;c=TP.lang.Hash.construct();switch(arguments.length){case 0:break;case 1:b=arguments[0];if(TP.notValid(b)){return c;}else if(TP.isArray(b)){if(TP.isPair(b[0])){for(a=0;a<b.length;a++){g=b[a];c.atPut(g[0],g[1],false);}}else{for(a=0;a<b.length;a+=2){c.atPut(b[a],b[a+1],false);}}}else if(TP.isString(b)){return TP.lang.Hash.fromString(b);}else if(TP.isElement(b)){d=b.attributes;e=d.length;for(a=0;a<e;a++){c.atPut(d[a].name,d[a].value);}}else if(TP.isKindOf(b,TP.lang.Hash)){return b;}else{f=TP.$getOwnKeys(b);e=f.getSize();for(a=0;a<e;a++){c.atPut(f.at(a),b[f.at(a)],false);}}break;default:for(a=0;a<arguments.length;a+=2){c.atPut(arguments[a],arguments[a+1],false);}break;}return c;});TP.lang.Hash.Inst.defineAttribute('$$hash');TP.lang.Hash.Inst.defineAttribute('delimiter',', ');TP.lang.Hash.Type.defineMethod('fromObject',function(a){return this.construct(a);});TP.lang.Hash.Inst.defineMethod('init',function(){var g,b,a,c,d,e,f;this.callNextMethod();this.$set(TP.ID,TP.genID('TP.lang.Hash'));g=TP.constructOrphanObject();this.$set('$$hash',g);switch(arguments.length){case 0:break;case 1:b=arguments[0];if(TP.isArray(b)){if(TP.isPair(b[0])){for(a=0;a<b.length;a++){c=b[a];this.atPut(c[0],TP.notDefined(c[1])?null:c[1],false);}}else{for(a=0;a<b.length;a+=2){this.atPut(b[a],TP.notDefined(b[a+1])?null:b[a+1],false);}}}else if(TP.isString(b)){return TP.lang.Hash.fromString(b);}else if(TP.isElement(b)){d=b.attributes;f=d.length;for(a=0;a<f;a++){this.atPut(d[a].name,d[a].value);}}else if(TP.isKindOf(b,TP.lang.Hash)){return b;}else{e=TP.$getOwnKeys(b);f=e.getSize();for(a=0;a<f;a++){this.atPut(e.at(a),b[e.at(a)],false);}}break;default:for(a=0;a<arguments.length;a+=2){this.atPut(arguments[a],TP.notDefined(arguments[a+1])?null:arguments[a+1],false);}break;}return this;});TP.lang.Hash.Inst.defineMethod('addAllKeys',function(c){var f,d,g,a,e,b;if(!TP.canInvoke(c,'getKeys')){this.raise('TP.sig.InvalidCollection',arguments);return;}f=TP.isArray(c)?c:c.getKeys();d=this.$get('$$hash');g=this.getKeys();e=f.getSize();for(a=0;a<e;a++){b=f[a];if(TP.notDefined(d[b])||!TP.owns(d,b)){g.push(b);d[b]=a;}}if(e>0){this.changed('keys',TP.INSERT,TP.hc(TP.OLDVAL,e,TP.NEWVAL,g.getSize()));}return this;});TP.lang.Hash.Inst.defineMethod('asAttributeString',function(){return TP.attributeStringFromHash(this);});TP.lang.Hash.Inst.defineMethod('asDumpString',function(){var a,d,c,f,b,e;if(this.$$format_asDumpString){return TP.recursion(this);}this.$$format_asDumpString=true;a=this.$get('delimiter');if(!TP.isString(a)){if(!TP.isString(a=a.get('join'))){a='';}}d=TP.ac();try{c=TP.keys(this);f=c.getSize();for(b=0;b<f;b++){d.push(TP.join(c.at(b),' => ',TP.dump(this.at(c.at(b)))));}e=TP.tname(this)+' :: '+'('+d.join(a)+')';}catch(a){e=this.toString();}delete this.$$format_asDumpString;return e;});TP.lang.Hash.Inst.defineMethod('asHTMLString',function(){var c,b,e,a,d;if(this.$$format_asHTMLString){return TP.recursion(this);}this.$$format_asHTMLString=true;c=TP.ac();try{b=TP.keys(this);e=b.getSize();for(a=0;a<e;a++){c.push(TP.join('<span data-name="',b.at(a),'">',TP.htmlstr(this.at(b.at(a))),'</span>'));}d='<span class="TP_lang_Hash">'+c.join('')+'</span>';}catch(a){d=this.toString();}delete this.$$format_asHTMLString;return d;});TP.lang.Hash.Inst.defineMethod('asJSONSource',function(){var c,b,e,a,d;if(this.$$format_asJSONSource){return TP.recursion(this);}this.$$format_asJSONSource=true;c=TP.ac();try{b=TP.keys(this);e=b.getSize();for(a=0;a<e;a++){c.push(TP.join(b.at(a).quoted('"'),':',TP.json(this.at(b.at(a)))));}d='{'+c.join(',')+'}';}catch(a){d=this.toString();}delete this.$$format_asJSONSource;return d;});TP.lang.Hash.Inst.defineMethod('asObject',function(){var b,d,c,a;if(this.conversion_asObject){return TP.recursion(this);}this.conversion_asObject=true;b=TP.keys(this);d=b.getSize();c={};for(a=0;a<d;a++){c[b[a]]=this.at(b[a]);}this.conversion_asObject=false;return c;});TP.lang.Hash.Inst.defineMethod('asPrettyString',function(){var c,b,e,a,d;if(this.$$format_asPrettyString){return TP.recursion(this);}this.$$format_asPrettyString=true;c=TP.ac();try{b=TP.keys(this);e=b.getSize();for(a=0;a<e;a++){c.push(TP.join('<dt class="pretty key">',b.at(a),'</dt>','<dd class="pretty value">',TP.pretty(this.at(b.at(a))),'</dd>'));}d='<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+c.join('')+'</dl>';}catch(a){d=this.toString();}delete this.$$format_asPrettyString;return d;});TP.lang.Hash.Inst.defineMethod('asQueryString',function(d){var b,a,c;if(!TP.isString(b=d)){b='&';}a=TP.ac();c=function(d,e,f){a.push(d.first(),'=',encodeURIComponent(d.last()));if(!c.atEnd()){a.push(b);}};this.injectInto(a,c);return a.join('');});TP.lang.Hash.Inst.defineMethod('asSource',function(){var b,d,c,a;if(this.$$format_asSource){return TP.recursion(this);}this.$$format_asSource=true;b=TP.keys(this);d=b.getSize();c=TP.ac();for(a=0;a<d;a++){c.push(TP.join(TP.src(b[a]),', ',TP.src(this.at(b[a]))));}delete this.$$format_asSource;return TP.join('TP.hc(',c.join(', '),')');});TP.lang.Hash.Inst.defineMethod('asStyleString',function(){return TP.styleStringFromHash(this);});TP.lang.Hash.Inst.defineMethod('asXMLString',function(){var c,b,e,a,d;if(this.$$format_asXMLString){return TP.recursion(this);}this.$$format_asXMLString=true;c=TP.ac();try{b=TP.keys(this);e=b.getSize();for(a=0;a<e;a++){c.push(TP.join('<',b.at(a),'>',TP.xmlstr(this.at(b.at(a))),'</',b.at(a),'>'));}d='<instance type="'+TP.tname(this)+'">'+c.join('')+'</instance>';}catch(a){d=this.toString();}delete this.$$format_asXMLString;return d;});TP.lang.Hash.Inst.defineMethod('atAllPutKeys',function(){this.convert(function(a,b){return a.first();});return this;});TP.lang.Hash.Inst.defineMethod('copy',function(g,i){var h,d,e,a,f,b,c;h=TP.ifInvalid(i,true);d=this.getType().construct();if(!h){e=TP.ifInvalid(g,TP.UNIQUE);if(TP.isString(e)){a=this.getLocalInterface(e);}else if(TP.isArray(e)){a=e;}else{return d;}f=a.getSize();for(b=0;b<f;b++){c=a.at(b);d.$set(c,this.at(c),false);}}else{if(!TP.isArray(a=g)){a=TP.keys(this);}f=a.getSize();for(b=0;b<f;b++){c=a.at(b);d.atPut(c,this.at(c),false);}}return d;});TP.lang.Hash.Inst.defineMethod('get',function(a){var b,d,c,e;if(!TP.isString(a)&&a.isAccessPath()){b=a;}else if(TP.regex.NON_SIMPLE_PATH.test(a)){b=TP.apc(a);}if(TP.notValid(b)){c='get'+a.asStartUpper();if(TP.canInvoke(this,c)){switch(arguments.length){case 1:return this[c]();default:d=TP.args(arguments,1);return this[c].apply(this,d);}}c='is'+a.asStartUpper();if(TP.isMethod(this[c])){return this[c]();}if(TP.isDefined(e=this.at(a))){return e;}}if(TP.isValid(b)||TP.isValid(b=this.getAccessPathFor(a,'value'))){d=TP.args(arguments);d.atPut(0,this);return b.executeGet.apply(b,d);}return this.getProperty(a);});TP.lang.Hash.Inst.defineMethod('getParameters',function(){return this;});TP.lang.Hash.Inst.defineMethod('hasKey',function(a){return TP.FunctionProto.hasOwnProperty.call(this.$get('$$hash'),a);});TP.lang.Hash.Inst.defineMethod('$$isPair',function(){return false;});TP.lang.Hash.Inst.defineMethod('populate',function(i,f,m,n){var e,h,c,b,a,j,k,g,d,l,o;e=TP.keys(i);h=e.getSize();for(c=0;c<h;c++){b=e.at(c);if(TP.isDefined(o=this.at(b))&&TP.notFalse(n)){continue;}a=i.at(b);j=TP.isArray(a)?a.first():b;k=TP.isArray(a)?a.last():a;g=TP.canInvoke(f,'at')?'at':'get';if(TP.canInvoke(f,g)){d=f[g](j);if(TP.isValid(d)&&TP.notTrue(m)){this.atPut(b,d);continue;}}l=TP.prompt(k,d);this.atPut(b,l);}return this;});TP.lang.Hash.Inst.defineMethod('$removeInternalKey',function(b){var a;a=this.$get('$$hash');if(!TP.owns(a,b)){return;}delete a[b];return this;});TP.lang.Hash.Inst.defineMethod('removeValue',function(e,f){var a,c,d,b;a=this.getPositions(e,f);if(a.getSize()<1){return this;}c=false;d=a.getSize();for(b=0;b<d;b++){this.$removeInternalKey(a.at(b));c=true;}if(c){this.changed('value',TP.DELETE);}return this;});TP.lang.Hash.Inst.defineMethod('replaceKey',function(a,b,e){var c,d;if(TP.isEmpty(a)||TP.isEmpty(b)){return this.raise('TP.sig.InvalidKey',arguments);}if(TP.equal(a,b)){return;}c=this.at(a);d=this.shouldSignalChange();this.shouldSignalChange(false);try{this.removeKey(a);this.atPut(b,c);}catch(a){}finally{this.shouldSignalChange(d);}this.changed('keys',TP.UPDATE,TP.hc(TP.OLDVAL,a,TP.NEWVAL,b));return this;});TP.lang.Hash.Inst.defineMethod('replaceValue',function(b,c,e){var a,d;a=0;d=this.shouldSignalChange();this.shouldSignalChange(false);try{this.convert(function(d,f){switch(e){case TP.IDENTITY:if(TP.identical(d.last(),b)){a++;return c;}break;default:if(TP.equal(d.last(),b)){a++;return c;}break;}return d.last();});}catch(a){}finally{this.shouldSignalChange(d);}if(a>0){this.changed('values',TP.UPDATE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,c));}return a;});TP.lang.Hash.Inst.defineMethod('set',function(a,e,h){var b,c,d,f,g;if(TP.isEmpty(a)){return this.raise('TP.sig.InvalidKey',arguments);}if(!TP.isString(a)&&a.isAccessPath()){b=a;}else if(TP.regex.NON_SIMPLE_PATH.test(a)){b=TP.apc(a);}if(TP.notValid(b)){c='set'+a.asStartUpper();if(TP.canInvoke(this,c)){switch(arguments.length){case 1:return this[c]();default:d=TP.args(arguments,1);return this[c].apply(this,d);}}if(TP.isBoolean(e)){c='is'+a.asStartUpper();if(TP.isMethod(this[c])){return this[c](e);}}}if(TP.isValid(b)||TP.isValid(b=this.getAccessPathFor(a,'value'))){d=TP.args(arguments);d.atPut(0,this);return b.executeSet.apply(b,d);}if(TP.notValid(f=h)){f=this.shouldSignalChange();}if(f){g=this.shouldSignalChange();this.shouldSignalChange(f);this.atPut(a,e);this.shouldSignalChange(g);}else{this.atPut(a,e);}return this;});TP.lang.Hash.Inst.defineMethod('setDelimiter',function(b){var a;a=TP.ifInvalid(b,', ');if(this.$get('delimiter')!==a){this.$set('delimiter',a);}return this;});TP.lang.Hash.Inst.defineMethod('shift',function(){var a;a=this.first();this.remove(a);return a;});TP.lang.Hash.Inst.defineMethod('add',function(){var c,a,d,b,e,f;c=0;switch(arguments.length){case 0:return this;case 1:b=arguments[0];if(TP.isArray(b)){if(TP.isPair(b[0])){for(a=0;a<b.length;a++){d=b[a];this.atPut(d[0],TP.notDefined(d[1])?null:d[1],false);c++;}}else{for(a=0;a<b.length;a+=2){this.atPut(b[a],TP.notDefined(b[a+1])?null:b[a+1],false);c++;}}}else{e=TP.$getOwnKeys(b);f=e.getSize();for(a=0;a<f;a++){this.atPut(e.at(a),b[e.at(a)],false);c++;}}break;case 2:this.atPut(arguments[0],arguments[1],false);c++;break;default:for(a=0;a<arguments.length;a+=2){this.atPut(arguments[a],TP.notDefined(arguments[a+1])?null:arguments[a+1],false);c++;}break;}if(c>0){this.changed('value',TP.INSERT);}return this;});TP.lang.Hash.Inst.defineMethod('addAll',function(a,d){var b,c;if(TP.isArray(a)&&!TP.isCallable(d)){return this.add(a);}if(!TP.canInvoke(a,'perform')){return this.raise('TP.sig.InvalidCollection',arguments);}b=this;c=0;if(!TP.isCallable(d)){a.perform(function(a,d){b.atPut(a.first(),a.last(),false);c++;});}else{a.perform(function(a,g){var e,f;e=b.at(a.first());if(TP.isDefined(e)){f=d(a.first(),e,a.last());if(f!==e){b.atPut(a.first(),f,false);c++;}}else{b.atPut(a.first(),a.last(),false);c++;}});}if(c>0){this.changed('value',TP.INSERT);}return this;});TP.lang.Hash.Inst.defineMethod('addAllIfAbsent',function(b){var a;a=this;return this.addAll(b,function(b,c,d){if(a.containsKey(b)){return c;}return d;});});TP.lang.Hash.Inst.defineMethod('addIfAbsent',function(b,f,g){var c,e,a,d;if(TP.isString(b)){a=b;d=f;}else if(TP.isPair(b)){a=b.first();d=b.last();}else{this.raise('TP.sig.InvalidParameter',arguments,'Invalid key or item.');return;}if(TP.notDefined(this.at(a))){this.atPut(a,d);}if(TP.notDefined(g)){return this.at(a);}e=arguments.length-2;for(c=2;c<e;c+=2){a=arguments[c];d=arguments[c+1];if(TP.notDefined(this.at(a))){this.atPut(a,d);}}return this.at(a);});TP.lang.Hash.Inst.defineMethod('addItem',function(a){if(!TP.isPair(a)){return this.raise('InvalidPair',arguments);}this.atPut(a.first(),a.last());return this;});TP.lang.Hash.Inst.defineMethod('addWithCount',function(c,b){var a;if(TP.notValid(b)){return;}a=parseInt(b,10);if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(a<1){return;}return this.addItem(c);});TP.lang.Hash.Inst.defineMethod('asArray',function(){return this.getPairs();});TP.lang.Hash.Inst.defineMethod('asHash',function(){return this;});TP.lang.Hash.Inst.defineMethod('asIterator',function(a){return this.getIteratorType().construct(this,a);});TP.lang.Hash.Inst.defineMethod('asRange',function(){return TP.todo();});TP.lang.Hash.Inst.defineMethod('asString',function(h){var f,a,d,c,g,b,e;f=TP.ifInvalid(h,true);if(!f){return TP.objectToString(this);}if(this.$$format_asString){return TP.recursion(this);}this.$$format_asString=true;a=this.$get('delimiter');if(!TP.isString(a)){if(!TP.isString(a=a.get('join'))){a='';}}d=TP.ac();try{c=TP.keys(this);g=c.getSize();for(b=0;b<g;b++){d.push(TP.join(c.at(b),' => ',TP.str(this.at(c.at(b)),false)));}e=d.join(a);}catch(a){e=this.toString();}delete this.$$format_asString;return e;});TP.lang.Hash.Inst.defineMethod('collapse',function(){return this;});TP.lang.Hash.Inst.defineMethod('compact',function(f){var a,b,c,d,e;b=f||function(a){return TP.notValid(a.last());};a=this.select(function(a,c){return b(a);});c=this.shouldSignalChange();this.shouldSignalChange(false);d=this.getSize();e=this;a.perform(function(a){e.removeKey(a.first());});this.shouldSignalChange(c);if(a.getSize()>0){this.changed('length',TP.DELETE,TP.hc(TP.OLDVAL,d,TP.NEWVAL,this.getSize()));}return this;});TP.lang.Hash.Inst.defineMethod('conform',function(a,c){var b;if(TP.isFalse(c)){return TP.hc(this.select(function(b){return TP.canInvoke(b,a);}));}b=this;this.perform(function(c,d){if(!TP.canInvoke(c.last(),a)){b.atPut(d,null,false);}});return this.compact();});TP.lang.Hash.Inst.defineMethod('contains',function(a,d){var b,c;if(TP.isString(a)){return this.containsKey(a);}if(!TP.isPair(a)){return this.raise('InvalidPair',arguments);}c=TP.ifInvalid(d,TP.EQUALITY);if(TP.notDefined(b=this.at(a.first()))){return false;}if(c===TP.EQUALITY){return TP.equal(b,a.last());}else{return TP.identical(b,a.last());}return false;});TP.lang.Hash.Inst.defineMethod('containsAll',function(a,e){var b,c,d;if(TP.isArray(a)){b=a;}else{if(!TP.canInvoke(a,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}b=a.asArray();}if(TP.isEmpty(b)){return false;}c=true;d=this;b.perform(function(a,b){if(!d.contains(a,e)){c=false;return TP.BREAK;}});return c;});TP.lang.Hash.Inst.defineMethod('containsAny',function(a,e){var b,c,d;if(TP.isArray(a)){b=a;}else{if(!TP.canInvoke(a,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}b=a.asArray();}if(TP.isEmpty(b)){return false;}c=false;d=this;b.perform(function(a,b){if(d.contains(a,e)){c=true;return TP.BREAK;}});return c;});TP.lang.Hash.Inst.defineMethod('containsString',function(a){return this.containsValue(a);});TP.lang.Hash.Inst.defineMethod('convert',function(c){var a,b;b=this.shouldSignalChange();this.shouldSignalChange(false);a=this;this.perform(function(b,d){a.atPut(b.first(),c(b,d));});this.shouldSignalChange(b);this.changed('value',TP.UPDATE);return this;});TP.lang.Hash.Inst.defineMethod('countOf',function(a,b){return this.contains(a,b)?1:0;});TP.lang.Hash.Inst.defineMethod('detect',function(b){var a;this.perform(function(c,d){if(b(c,d)){a=c;return TP.BREAK;}});return a;});TP.lang.Hash.Inst.defineMethod('difference',function(a,c){var b;if(TP.isArray(a)){b=a;}else{if(!TP.canInvoke(a,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}b=a.asArray();}return b.difference(this.getItems());});TP.lang.Hash.Inst.defineMethod('disjunction',function(a,c){var b;if(TP.isArray(a)){b=a;}else{if(!TP.canInvoke(a,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}b=a.asArray();}return b.disjunction(this.getItems());});TP.lang.Hash.Inst.defineMethod('empty',function(){var d,a,c,b;d=this.$get('$$hash');a=this.getKeys();c=a.getSize();for(b=0;b<c;b++){delete d[a[b]];}a.empty();this.changed('length',TP.DELETE,TP.hc(TP.OLDVAL,c,TP.NEWVAL,0));return this;});TP.lang.Hash.Inst.defineMethod('getIterator',function(){if(TP.notValid(this.$get('iterator'))){this.$set('iterator',this.asIterator());}return this.$get('iterator');});TP.lang.Hash.Inst.defineMethod('getIteratorType',function(){var a;if(TP.notValid(a=TP.sys.getTypeByName('TP.core.Iterator'))){return this.raise('TP.sig.TypeNotFound',arguments);}return a;});TP.lang.Hash.Inst.defineMethod('getSize',function(){return this.getKeys().getSize();});TP.lang.Hash.Inst.defineMethod('getValues',function(){var b,c,d,a;b=TP.ac();c=TP.keys(this);if(TP.notNull(d=this.$get('$$hash'))){for(a=0;a<c.length;a++){b.push(d[c[a]]);}}return b;});TP.lang.Hash.Inst.defineMethod('intersection',function(a,c){var b;if(TP.isArray(a)){b=a;}else{if(!TP.canInvoke(a,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}b=a.asArray();}return b.intersection(this.getItems()).asHash();});TP.lang.Hash.Inst.defineMethod('$$isCollection',function(){return true;});TP.lang.Hash.Inst.defineMethod('isSortedCollection',function(){return TP.isCallable(this.getSortFunction());});TP.lang.Hash.Inst.defineMethod('merge',function(i){var b,e,g,c,f,d,h,a;b=TP.args(arguments);b.unshift(this);e=TP.hc();g=b.getSize();for(c=0;c<g;c++){f=b.at(c);d=f.getKeys();h=d.getSize();for(a=0;a<h;a++){e.atPut(d.at(a),f.at(d.at(a)));}}return e;});TP.lang.Hash.Inst.defineMethod('remove',function(b,c){var a;a=this.contains(b,c)?1:0;if(a>0){this.removeKey(b.first());}return a;});TP.lang.Hash.Inst.defineMethod('removeAll',function(a,g){var c,b,d,e,f;if(TP.isArray(a)){c=a;}else{if(!TP.canInvoke(a,'asArray')){this.raise('TP.sig.InvalidCollection',arguments);return 0;}c=a.asArray();}b=0;d=this;e=this.getSize();f=this.shouldSignalChange();try{c.perform(function(a,c){d.shouldSignalChange(false);b+=d.remove(a);});}catch(a){}finally{this.shouldSignalChange(f);}if(b>0){this.changed('value',TP.DELETE,TP.hc(TP.OLDVAL,e,TP.NEWVAL,this.getSize()));}return b;});TP.lang.Hash.Inst.defineMethod('replace',function(a,b,d){var c;if(!TP.isPair(a)||!TP.isPair(b)){this.raise('InvalidPair',arguments);return 0;}if(!this.contains(a,d)){return 0;}c=this.shouldSignalChange();this.shouldSignalChange(false);try{this.remove(a);this.add(b);this.changed('value',TP.UPDATE);}catch(a){}finally{this.shouldSignalChange(c);}return 1;});TP.lang.Hash.Inst.defineMethod('replaceAll',function(a,f,g){var c,b,d,e;if(TP.isArray(a)){c=a;}else{if(!TP.canInvoke(a,'asArray')){return this.raise('TP.sig.InvalidCollection',arguments);}c=a.asArray();}b=0;d=this;e=this.shouldSignalChange();try{c.perform(function(a,c){d.shouldSignalChange(false);b+=d.replace(a,f);});}catch(a){}finally{this.shouldSignalChange(e);}if(b>0){this.changed('value',TP.UPDATE);}return b;});TP.lang.Hash.Inst.defineMethod('transpose',function(){var a;a=TP.hc();return this.injectInto(a,function(a,b,d){var c;if(TP.isValid(c=a.last())){b.atPut(c,a.first());}return b;});});TP.lang.Hash.Inst.defineMethod('union',function(a,d){var c,b,e;if(!TP.canInvoke(a,'getKeys')){return this.raise('TP.sig.InvalidCollection',arguments,'Collection must support getKeys for union operation.');}b=this.copy();if(TP.isCallable(d)){c=this.getKeys().intersection(a.getKeys());if(TP.notEmpty(c)){e=this;c.convert(function(b){return TP.ac(b,d(b,e.at(b),a.at(b)));});b.addAll(a);b.addAll(c);return b;}}return b.addAll(a);});TP.lang.Hash.Inst.defineMethod('unique',function(a){return this;});TP.lang.Hash.Inst.defineMethod('addAt',function(b,a){if(TP.notValid(a)){return this.raise('TP.sig.InvalidIndex',arguments);}return this.atPut(a,b);});TP.lang.Hash.Inst.defineMethod('addAllAt',function(a,b){return this.addAt(a,b);});TP.lang.Hash.Inst.defineMethod('at',function(b){var a;a=this.$get('$$hash');if(!a||!TP.FunctionProto.hasOwnProperty.call(a,b)){return;}return a[b];});TP.lang.Hash.Inst.defineMethod('atAll',function(b){var a,c;if(!TP.canInvoke(b,'perform')){return this.raise('TP.sig.InvalidCollection',arguments,'Collection must support perform for atAll operation.');}a=TP.ac();c=this;b.perform(function(b,d){a.push(c.at(b));return;});return a;});TP.lang.Hash.Inst.defineMethod('atAllIfAbsent',function(a){return TP.todo();});TP.lang.Hash.Inst.defineMethod('atAllPut',function(c,d){var a,b;if(!TP.canInvoke(c,'perform')){return this.raise('TP.sig.InvalidCollection',arguments,'Collection must support perform for atAll operation.');}a=0;b=this;c.perform(function(c,e){if(!TP.equal(b.at(c),d)){b.atPut(c,d,false);a++;}return;});if(a>0){this.changed('value',TP.UPDATE);}return this;});TP.lang.Hash.Inst.defineMethod('atIfInvalid',function(c,a){var b;if(TP.isValid(b=this.at(c))){return b;}else if(TP.isCallable(a)){return a();}else{return a;}});TP.lang.Hash.Inst.defineMethod('atIfNull',function(c,a){var b;if(TP.notNull(b=this.at(c))){return b;}else if(TP.isCallable(a)){return a();}else{return a;}});TP.lang.Hash.Inst.defineMethod('atIfUndefined',function(c,a){var b;if(TP.isDefined(b=this.at(c))){return b;}else if(TP.isCallable(a)){return a();}else{return a;}});TP.lang.Hash.Inst.defineMethod('atPath',function(g){var b,c,d,a,e,f;if(!/\./.test(g)){return;}b=this;c=g.split('.');d=c.getSize();for(a=0;a<d;a++){e=c.at(a);if(a===d-1){return b.at(e);}else{f=b.at(e);if(!TP.isKindOf(f,TP.lang.Hash)){return null;}b=f;}}return null;});TP.lang.Hash.Inst.defineMethod('atPathPut',function(g,j){var b,i,f,a,h,e,c,k,d;if(!/\./.test(g)){return;}b=this;i=g.split('.');f=this.shouldSignalChange();this.shouldSignalChange(false);a=null;h=i.getSize();for(e=0;e<h;e++){c=i.at(e);if(e===h-1){if(TP.notValid(a)&&f){if(TP.notDefined(k=b.at(c))){a=TP.INSERT;}else{if(!TP.equal(k,j)){a=TP.UPDATE;}}}b.atPut(c,j);}else{d=b.at(c);if(!TP.isKindOf(d,TP.lang.Hash)){d=TP.hc();b.atPut(c,d);a=TP.INSERT;}b=d;}}this.shouldSignalChange(f);if(TP.isValid(a)){this.changed(g,a);}return this;});TP.lang.Hash.Inst.defineMethod('atPut',function(a,d){var b,i,e,c,f,g,h;b=this.$get('$$hash');i=this.getKeys();e=this.shouldSignalChange();c=null;if(TP.notDefined(d)){this.$removeInternalKey(a);c=TP.DELETE;}else{if(TP.notDefined(b[a])||!TP.owns(b,a)){i.push(a);b[a]=d;c=TP.INSERT;}else{if(e){f=b[a];if(!TP.equal(f,d)){b[a]=d;if(TP.notValid(c)){c=TP.UPDATE;}}}else{b[a]=d;return this;}}}if(TP.isValid(c)&&e){g=TP.hc();h=g.$get('$$hash');h[TP.OLDVAL]=f;h[TP.NEWVAL]=d;this.changed(a,c,g);}return this;});TP.lang.Hash.Inst.defineMethod('atPutIfAbsent',function(a,b){return this.addIfAbsent(a,b);});TP.lang.Hash.Inst.defineMethod('containsKey',function(a){return TP.isDefined(this.at(a));});TP.lang.Hash.Inst.defineMethod('detectKeyAt',function(a,b){return TP.todo();});TP.lang.Hash.Inst.defineMethod('getKeys',function(c){var a,b;a=Object.keys(this.$get('$$hash'));return TP.isCallable(b=this.getSortFunction())?a.sort(b):a;});TP.lang.Hash.Inst.defineMethod('getPosition',function(b,c){var a;a=this.detect(function(a,d){switch(c){case TP.IDENTITY:return TP.identical(a.last(),b);default:return TP.equal(a.last(),b);}return false;});if(TP.isValid(a)){return a.first();}return;});TP.lang.Hash.Inst.defineMethod('getPositions',function(a,c){var b;b=this.select(function(b,d){switch(c){case TP.IDENTITY:return TP.identical(b.last(),a);default:return TP.equal(b.last(),a);}return false;});return b.collect(function(a){return a.first();});});TP.lang.Hash.Inst.defineMethod('removeAt',function(a){return this.removeKey(a);});TP.lang.Hash.Inst.defineMethod('removeAtAll',function(c){var b,a,d;if(!TP.canInvoke(c,'perform')){return this.raise('TP.sig.InvalidCollection',arguments,'Collection must support perform for atAll operation.');}b=0;a=this;d=this.shouldSignalChange();try{c.perform(function(c,d){if(TP.isDefined(a.at(c))){a.shouldSignalChange(false);a.removeKey(c);b++;}return;});}catch(a){}finally{this.shouldSignalChange(d);}if(b>0){this.changed('value',TP.DELETE);}return this;});TP.lang.Hash.Inst.defineMethod('removeKey',function(a){if(TP.isEmpty(a)){return this.raise('TP.sig.InvalidParameter',arguments,'Empty key provided.');}if(TP.isDefined(this.at(a))){this.$removeInternalKey(a);this.changed(a,TP.DELETE);}return this;});TP.lang.Hash.Inst.defineMethod('removeKeys',function(b){var c,d,a;if(!TP.isArray(b)){return this.raise('TP.sig.InvalidParameter',arguments,'Invalid key array provided.');}c=false;d=b.getSize();for(a=0;a<d;a++){if(TP.isDefined(this.at(b.at(a)))){this.$removeInternalKey(b.at(a));c=true;}}if(c){this.changed('value',TP.DELETE);}return this;});TP.lang.Hash.Inst.defineMethod('transpose',function(){return TP.todo();});TP.lang.Hash.Inst.defineMethod('getSortFunction',function(){return this.sortFunction;});TP.lang.Hash.Inst.defineMethod('setSortFunction',function(a){if(TP.identical(a,this.sortFunction)){return this;}this.sortFunction=a;this.changed('order',TP.SORTED);return this;});TP.lang.Hash.Inst.defineMethod('sort',function(b){var a;a=b||this.getSortFunction();if(TP.isCallable(a)){TP.keys(this).sort(a);}else{TP.keys(this).sort();}this.changed('order',TP.SORTED);return this;});TP.lang.Hash.Inst.defineMethod('canResolveDNU',function(c,a,d,e){var b;if(TP.regex.GETTER.test(a)){b=a.replace(TP.regex.GETTER,function(b,a){return a.toLowerCase();});return TP.isDefined(this.at(b));}return false;});TP.lang.Hash.Inst.defineMethod('resolveDNU',function(c,b,d,e){var a;a=b.replace(TP.regex.GETTER,function(b,a){return a.toLowerCase();});return this.at(a);});TP.lang.Object.defineSubtype('core:Range');TP.core.Range.Inst.defineAttribute('start');TP.core.Range.Inst.defineAttribute('end');TP.core.Range.Inst.defineAttribute('step');TP.core.Range.Inst.defineAttribute('keys');TP.core.Range.Inst.defineMethod('init',function(c,d,e){var a,b;this.callNextMethod();if(TP.notValid(c)||TP.isNaN(a=c.asNumber())){a=0;}if(TP.notValid(d)||TP.isNaN(b=d.asNumber())){b=TP.MAX_DOUBLE;}this.set('start',a);this.set('end',b);if(a>b){this.set('step',TP.ifInvalid(e,-1));}else{this.set('step',TP.ifInvalid(e,1));}return this;});TP.core.Range.Inst.defineMethod('asArray',function(){var a;a=TP.ac();this.perform(function(b){a.push(b);});return a;});TP.core.Range.Inst.defineMethod('at',function(b){var a;if(TP.notValid(a=this.get('keys'))){return null;}return a.at(b);});TP.core.Range.Inst.defineMethod('by',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidParameter',arguments);}this.empty();this.set('step',a);return this;});TP.core.Range.Inst.defineMethod('empty',function(a){this.$set('keys',null);return this;});TP.core.Range.Inst.defineMethod('getKeys',function(){var b,c,d,e,a;if(TP.notValid(b=this.$get('keys'))){b=TP.ac();c=this.get('step');d=this.get('start');e=this.get('end');if(c.isPositive()){for(a=d;a<=e;a=a+c){b.push(a);}}else{for(a=d;a>=e;a=a+c){b.push(a);}}this.set('keys',b);}return b;});TP.core.Range.Inst.defineMethod('perform',function(b){var d,e,f,c,g,a;d=0;e=this.get('step');f=this.get('start');c=this.get('end');g=true;if(c-f>TP.sys.cfg('perform.instrument_max')){g=TP.regex.PERFORM_INSTRUMENT.test(b.toString());}if(e.isPositive()){for(a=f;a<=c;a=a+e){if(g){b.atStart(a===0?true:false);b.atEnd(a===c?true:false);}if(b(a,d)===TP.BREAK){break;}d++;}}else{for(a=f;a>=c;a=a+e){if(g){b.atStart(a===0?true:false);b.atEnd(a===c?true:false);}if(b(a,d)===TP.BREAK){break;}d++;}}return this;});TP.core.Range.Inst.defineMethod('performUntil',function(c,j){var i,e,b,f,g,d,h,a;i=TP.RETURN_FALSE;e=j;if(!TP.isCallable(e)){e=i;}b=0;f=this.get('step');g=this.get('start');d=this.get('end');h=true;if(d-g>TP.sys.cfg('perform.instrument_max')){h=TP.regex.PERFORM_INSTRUMENT.test(c.toString());}if(f.isPositive()){for(a=g;a<=d;a=a+f){if(h){c.atStart(a===0?true:false);c.atEnd(a===d?true:false);}c(a,b);if(e(a,b)){break;}b++;}}else{for(a=g;a>=d;a=a+f){if(h){c.atStart(a===0?true:false);c.atEnd(a===d?true:false);}c(a,b);if(e(a,b)){break;}b++;}}return this;});TP.core.Range.Inst.defineMethod('performWhile',function(b,h){var c,e,f,d,g,a;c=0;e=this.get('step');f=this.get('start');d=this.get('end');g=true;if(d-f>TP.sys.cfg('perform.instrument_max')){g=TP.regex.PERFORM_INSTRUMENT.test(b.toString());}if(e.isPositive()){for(a=f;a<=d;a=a+e){if(g){b.atStart(a===0?true:false);b.atEnd(a===d?true:false);}if(TP.notTrue(h(a,c))){break;}b(a,c);c++;}}else{for(a=f;a>=d;a=a+e){if(TP.notTrue(h(a,c))){break;}if(g){b.atStart(a===0?true:false);b.atEnd(a===d?true:false);}b(a,c);c++;}}return this;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETURITypes.js';
TP.lang.Object.defineSubtype('core:URI');TP.core.URI.isAbstract(true);TP.core.URI.addTraitsFrom(TP.core.SyncAsync);TP.core.URI.executeTraitResolution();TP.core.URI.Type.defineConstant('SCHEME');TP.core.URI.Type.defineAttribute('uriCatalog');TP.core.URI.set('supportedModes',TP.core.SyncAsync.SYNCHRONOUS);TP.core.URI.set('mode',TP.core.SyncAsync.SYNCHRONOUS);TP.core.URI.Type.defineAttribute('instances',TP.ifInvalid(TP.core.URI.$get('instances'),TP.hc()));TP.core.URI.Type.defineAttribute('schemeHandlers',TP.ifInvalid(TP.core.URI.$get('schemeHandlers'),TP.hc()));TP.core.URI.Type.defineMethod('construct',function(c,h){var a,e,f,b,d,g;TP.debug('break.uri_construct');if(h){if(TP.isValid(b=this.callNextMethod(c))){TP.core.URI.registerInstance(b);}return b;}if(!TP.isString(c)){if(TP.isKindOf(c,TP.core.URI)){return c;}else{return;}}if(TP.isBlank(c)){return;}a=TP.regex.HAS_BACKSLASH.test(c)?TP.uriInWebFormat(c):c;if(a.indexOf('#')===0){a='tibet://uicanvas/'+a;}if(!TP.regex.URI_LIKELY.test(a)||TP.regex.REGEX_LITERAL_STRING.test(a)){return;}if(!TP.regex.TIBET_VIRTUAL_URI_PREFIX.test(a)){a=TP.uriCollapsePath(a);}e=TP.sys.shouldLogRaise();TP.sys.shouldLogRaise(false);try{if(TP.regex.TIBET_URI.test(a)){f=TP.uriResolveVirtualPath(a);if(TP.isURI(b=TP.core.URI.getInstanceById(f))){return b;}b=TP.core.TIBETURL.construct(a,true);}else{if(TP.isURI(b=TP.core.URI.getInstanceById(a))){return b;}a=TP.uriWithRoot(a);d=this.getConcreteType(a);if(TP.isType(d)){b=d.construct(a,true);}else{return this.raise('TP.sig.NoConcreteType',arguments,'Unable to locate concrete type for URI: '+a);}}}catch(b){g=TP.ec(b,TP.join(TP.sc('URI construct produced error for: '),a));return this.raise('TP.sig.URIException',arguments,g);}finally{TP.sys.shouldLogRaise(e);}return b;});TP.definePrimitive('uc',function(a){return TP.core.URI.construct(a);});TP.definePrimitive('uri',function(a){var b,c,d;if(TP.isString(a)&&TP.regex.URI_LIKELY.test(a)&&!TP.regex.REGEX_LITERAL_STRING.test(a)){b=TP.core.URI.construct(a);if(TP.isURI(b)){return b;}}else if(TP.isKindOf(a,TP.core.URI)){return a;}if(TP.isMutable(a)){c=TP.gid(a,true);}else{c=TP.val(a);}d=TP.core.URI.construct(TP.TIBET_URN_PREFIX+c);d.setResource(a);return d;});TP.core.URI.Type.defineMethod('fromDocument',function(a){var b,c;if(!TP.isDocument(a)){this.raise('TP.sig.InvalidDocument',arguments);return;}b=a.documentElement;if(TP.isElement(b)){c=TP.elementGetAttribute(b,'tibet:src',true);if(TP.notEmpty(c)){return this.construct(c+'#document');}}return this.construct(a.location+'#document');});TP.core.URI.Type.defineMethod('fromString',function(a){return this.construct(a);});TP.core.URI.Type.defineMethod('fromTP_core_URI',function(a){return a;});TP.core.URI.Type.defineMethod('fromWindow',function(a){if(!TP.isWindow(a)){this.raise('TP.sig.InvalidWindow',arguments);return;}return this.construct(''+a.location);});TP.core.URI.Type.defineMethod('getConcreteType',function(b){var a;a=this.$get('schemeHandlers').at(b.slice(0,b.indexOf(':')));if(TP.owns(a,'getConcreteType')){return a.getConcreteType(b);}return a;});TP.core.URI.Type.defineMethod('registerForScheme',function(b){var a;if(!TP.isString(b)){return this.raise('TP.sig.InvalidParameter',arguments,'Scheme is empty or null.');}a=b.strip(':');TP.core.URI.$get('schemeHandlers').atPut(a,this);if(TP.notValid(TP.boot.$uriSchemes[a])){TP.boot.$uriSchemes[a]=a;TP.regex.URI_LIKELY=TP.rc(TP.join('^~|^/|^\\.\\/|^\\.\\.\\/','|^',TP.keys(TP.boot.$uriSchemes).join(':|^'),':','|^(?:\\w+):(?:.*)\\/'));}return;});TP.core.URI.Type.defineMethod('getInstanceById',function(a){return TP.core.URI.$get('instances').at(a);});TP.core.URI.Type.defineMethod('registerInstance',function(a){var b;if(!TP.canInvoke(a,'getID')){return this.raise('TP.sig.InvalidURI',arguments);}b=this.$get('instances');b.atPut(a.getLocation(),a);return this;});TP.core.URI.Type.defineMethod('removeInstance',function(a){var b;if(!TP.canInvoke(a,'getID')){return this.raise('TP.sig.InvalidURI',arguments);}b=this.$get('instances');b.removeKey(a.getLocation());return this;});TP.core.URI.Type.defineMethod('$getDefaultHandler',function(c,d){var a,b;a=TP.sys.cfg('uri.handler');if(TP.isEmpty(a)){this.raise('TP.sig.InvalidConfiguration',arguments,'uri.handler has no type name specified.');return TP.core.URIHandler;}b=TP.sys.require(a);if(TP.notValid(b)){this.raise('TP.sig.TypeNotFound',arguments,a);return TP.core.URIHandler;}return b;});TP.core.URI.Type.defineMethod('$getURICatalog',function(o,t,l){var a,j,s,q,e,n,r,g,b,k,h,m,c,d,p,f,i;TP.debug('break.uri_catalog');a=this.$get('uriCatalog')||t;if(TP.isURI(o)){j=TP.uriExpandPath(o.asString()).split('#').at(0);if(TP.isValid(a)){if(TP.isValid(s=a.at(j))){return s;}else{if(TP.isURI(q=TP.uc(j))){e=q.getNativeNode(TP.request('no_rewrite',true,'shouldReport',false,'async',false));}if(TP.notValid(e)){this.raise('TP.sig.InvalidXML',arguments,'Catalog files must be valid XML.');return;}}}else{a=TP.core.URI.$getURICatalog();if(TP.isValid(a)){return TP.core.URI.$getURICatalog(o);}else{this.raise('TP.sig.InvalidCatalog',arguments,'Unable to create top-level URI catalog.');return;}}}else{if(TP.isValid(a)){return a;}a=TP.hc();this.$set('uriCatalog',a);e=TP.sys.getURIXML();if(TP.notValid(e)){return a;}}n=TP.nodeGetElementsByTagName(e,'*');r=n.getSize();for(g=0;g<r;g++){b=n.at(g);switch(TP.elementGetLocalName(b)){case'uri':k=TP.uriExpandPath(b.getAttribute('name'));h=a.at(k)||TP.hc();m=h.at('mappings')||TP.ac();c=TP.elementGetAttributes(b);d=TP.core.URI.$getURIProfileKey(c,true);m.push(TP.ac(d,c,l));h.atPut('mappings',m);a.atPut(k,h);break;case'rewriteURI':p=a.at('rewrites')||TP.ac();c=TP.elementGetAttributes(b);d=TP.core.URI.$getURIProfileKey(c,true);p.push(TP.ac(d,c,l));a.atPut('rewrites',p);break;case'delegateURI':f=b.getAttribute('catalog');if(TP.notEmpty(f)){TP.core.URI.$getURICatalog(f,a,b.getAttribute('tibet:uriMatchString')||b.getAttribute('uriStartString'));}c=TP.elementGetAttributes(b);if(!c.hasKey('catalog')){i=a.at('delegations')||TP.ac();d=TP.core.URI.$getURIProfileKey(c,true);i.push(TP.ac(d,c,l));a.atPut('delegations',i);}break;case'nextCatalog':f=b.getAttribute('catalog');TP.core.URI.$getURICatalog(f,a);break;default:break;}}return a;});TP.core.URI.Type.defineMethod('$getURIEntry',function(k){var i,n,f,e,c,j,g,a,b,d,h,l,m;TP.debug('break.uri_entry');i=this.$getURICatalog();n=TP.isString(k)?TP.uc(k):k;f=TP.uriExpandPath(n.asString()).split('#').at(0);e=i.at(f)||TP.hc();if(TP.isTrue(e.get('$complete'))){return e;}if(TP.isArray(c=e.at('mappings'))){j=0;g=c.getSize();for(a=0;a<g;a++){b=c.at(a).at(0);d=TP.rc(b);c.at(a).atPut(0,d);if(TP.notEmpty(b=c.at(a).at(2))){d=TP.rc(TP.regExpEscape(b));if(!d.test(f)){c.atPut(a,null);j++;}}}if(j>0){c.compact();}}if(TP.isArray(c=i.at('delegations'))){g=c.getSize();for(a=0;a<g;a++){if(TP.notEmpty(b=c.at(a).at(2))){d=TP.rc(TP.regExpEscape(b));if(!d.test(f)){continue;}}h=c.at(a).at(1);if(TP.notEmpty(b=h.at('uriStartString'))){if(f.indexOf(b)!==0){continue;}}else if(TP.notEmpty(b=h.at('tibet:uriMatchString'))){if(TP.notValid(d=TP.rc(b))){TP.ifWarn()?TP.warn('Invalid RegExp source: '+b+' in URI catalog.',TP.LOG,arguments):0;continue;}if(!d.test(f)){continue;}}l=e.at('delegations')||TP.ac();l.push(c.at(a));e.atPut('delegations',l);}}if(TP.isArray(c=i.at('rewrites'))){g=c.getSize();for(a=0;a<g;a++){if(TP.notEmpty(b=c.at(a).at(2))){d=TP.rc(TP.regExpEscape(b));if(!d.test(f)){continue;}}h=c.at(a).at(1);if(TP.notEmpty(b=h.at('uriStartString'))){if(f.indexOf(b)!==0){continue;}}else if(TP.notEmpty(b=h.at('tibet:uriMatchString'))){if(TP.notValid(d=TP.rc(b))){TP.ifWarn()?TP.warn('Invalid RegExp source: '+b+' in URI catalog.',TP.LOG,arguments):0;continue;}if(!d.test(f)){continue;}}m=e.at('rewrites')||TP.ac();m.push(c.at(a));e.atPut('rewrites',m);}}e.set('$complete',true);i.atPut(f,e);return e;});TP.core.URI.Type.defineMethod('$getURIMapForKey',function(j,g,h){var d,c,f,a,b,e,i;TP.debug('break.uri_map');d=TP.hc();g.atPut(h,d);if(TP.isArray(c=g.at('mappings'))){f=c.getSize();for(a=0;a<f;a++){if(c.at(a).at(0).test(h)){d.atPut('mapping',c.at(a).at(1));break;}}}if(TP.isArray(c=g.at('rewrites'))){f=c.getSize();for(a=0;a<f;a++){if(c.at(a).at(0).test(h)){b=c.at(a).at(1);if(TP.notEmpty(e=b.at('uriStartString'))){if(j.indexOf(e)===0){d.atPut('rewrite',b);break;}}else if(TP.notEmpty(e=b.at('tibet:uriMatchString'))){if(TP.isRegExp(i=TP.rc(e))){if(i.test(j)){d.atPut('rewrite',b);break;}}}}}}if(TP.isArray(c=g.at('delegations'))){f=c.getSize();for(a=0;a<f;a++){if(c.at(a).at(0).test(h)){b=c.at(a).at(1);if(TP.isEmpty(b.at('tibet:urihandler'))&&TP.isEmpty(b.at('tibet:contenthandler'))&&TP.isEmpty(b.at('tibet:uricontroller'))){continue;}if(TP.notEmpty(e=b.at('uriStartString'))){if(j.indexOf(e)===0){d.atPut('delegate',b);break;}}else if(TP.notEmpty(e=b.at('tibet:uriMatchString'))){if(TP.isRegExp(i=TP.rc(e))){if(i.test(j)){d.atPut('delegate',b);break;}}}}}}return d;});TP.core.URI.Type.defineMethod('$getURIProfile',function(g){var a,b,c,d,e,f;TP.debug('break.uri_profile');a=TP.sys.cfg('tibet.uriprofile');if(TP.isValid(a)&&TP.notTrue(g)){return a;}a=TP.hc();a.atPut('xml:lang',TP.sys.getTargetLanguage());a.atPut('tibet:browser',TP.sys.env('tibet.browser'));a.atPut('tibet:browserUI',TP.sys.env('tibet.browserUI'));a.atPut('tibet:env',TP.sys.getProfile());a.atPut('tibet:state',TP.sys.getState());a.atPut('tibet:offline',TP.str(TP.sys.isOffline()));if(TP.isValid(b=TP.sys.getEffectiveUser())){c=b.getPrimaryUnit();a.atPut('tibet:unit',TP.notValid(c)?'ANY':c.getID());d=b.getPrimaryRole();a.atPut('tibet:role',TP.notValid(d)?'ANY':d.getID());e=b.getID();a.atPut('tibet:user',TP.notValid(b)?'ANY':e.getID());}else{a.atPut('tibet:unit','ANY');a.atPut('tibet:role','ANY');a.atPut('tibet:user','ANY');}f=TP.core.URI.$getURIProfileKey(a,false);a.atPut('key',f);TP.sys.setcfg('tibet.uriprofile',a);return a;});TP.core.URI.Type.defineMethod('$getURIProfileKey',function(n,o){var b,d,g,k,l,m,j,h,i,c,f,a,e;TP.debug('break.uri_profile');b=n||TP.core.URI.$getURIProfile();d=TP.isTrue(o);if(TP.isValid(g=b.at('key'))){return g;}k=b.atIfInvalid('tibet:browser',d?'([^_]+)':TP.sys.env('tibet.browser'));l=b.atIfInvalid('tibet:browserUI',d?'([^_]+)':TP.sys.env('tibet.browserUI'));m=TP.str(b.atIfInvalid('tibet:offline',d?'([^_]+)':TP.sys.isOffline()));j='ANY';h=b.atIfInvalid('tibet:state',d?'([^_]+)':TP.sys.getState());h=TP.isEmpty(h)?'ANY':h;i=b.atIfInvalid('xml:lang',d?'([^_]+)':TP.sys.getTargetLanguage());i=TP.isEmpty(i)?'ANY':i;if(TP.isEmpty(c=b.at('tibet:unit'))){if(TP.isEmpty(c=TP.sys.cfg('tibet.uriprofile.unit'))){if(TP.isValid(f=TP.sys.getEffectiveUser())){c=f.getPrimaryUnit();c=TP.notValid(c)?'':c.getID();TP.sys.setcfg('tibet.uriprofile.unit',c);}}c=TP.isEmpty(c)&&d?'([^_]+)':c;}if(TP.isEmpty(a=b.at('tibet:role'))){if(TP.isEmpty(a=TP.sys.cfg('tibet.uriprofile.role'))){if(TP.isValid(f=TP.sys.getEffectiveUser())){a=f.getPrimaryRole();a=TP.notValid(a)?'':a.getID();TP.sys.setcfg('tibet.uriprofile.role',a);}}a=TP.isEmpty(a)&&d?'([^_]+)':a;}if(TP.isEmpty(e=b.at('tibet:user'))){if(TP.isEmpty(e=TP.sys.cfg('tibet.uriprofile.user'))){if(TP.isValid(f=TP.sys.getEffectiveUser())){e=f.getID();TP.sys.setcfg('tibet.uriprofile.user',e);}}e=TP.isEmpty(e)&&d?'([^_]+)':e;}g=TP.ac(k,l,m,j,h,i,c,a,e).join('_');b.atPut('key',g);return g;});TP.core.URI.Type.defineMethod('rewrite',function(c,d){var a,b;TP.debug('break.uri_rewrite');a=TP.sys.cfg('uri.rewriter');b=TP.sys.require(a);if(TP.canInvoke(b,'rewrite')){return b.rewrite(c,d);}else{TP.ifWarn()?TP.warn('URI rewriter: '+a+' does not support rewrite(); using default.',TP.IO_LOG,arguments):0;return TP.core.URIRewriter.rewrite(c,d);}});TP.core.URI.Type.defineMethod('route',function(c,d){var a,b;TP.debug('break.uri_route');a=TP.sys.cfg('uri.router');b=TP.sys.require(a);if(TP.canInvoke(b,'route')){return b.route(c,d);}else{TP.ifWarn()?TP.warn('URI router: '+a+' does not support route(); using default.',TP.IO_LOG,arguments):0;return TP.core.URIRouter.route(c,d);}});TP.core.URI.Inst.defineAttribute('uri');TP.core.URI.Inst.defineAttribute('decoded');TP.core.URI.Inst.defineAttribute('primaryHref');TP.core.URI.Inst.defineAttribute('primaryURI');TP.core.URI.Inst.defineAttribute('fragment');TP.core.URI.Inst.defineAttribute('httpBased');TP.core.URI.Inst.defineAttribute('resource');TP.core.URI.Inst.defineAttribute('resourceCache');TP.core.URI.Inst.defineAttribute('uriNodes');TP.core.URI.Inst.defineAttribute('uriRegex');TP.core.URI.Inst.defineAttribute('scheme');TP.core.URI.Inst.defineAttribute('schemeSpecificPart');TP.core.URI.Inst.defineAttribute('headers');TP.core.URI.Inst.defineAttribute('lastUpdated',null);TP.core.URI.Inst.defineAttribute('expired',false);TP.core.URI.Inst.defineAttribute('found',null);TP.core.URI.Inst.defineAttribute('$dirty',false);TP.core.URI.Inst.defineAttribute('$loaded',false);TP.core.URI.Inst.defineAttribute('$mapped',null);TP.core.URI.Inst.defineAttribute('defaultMIMEType');TP.core.URI.Inst.defineAttribute('computedMIMEType');TP.core.URI.Inst.defineAttribute('controller');TP.core.URI.Inst.defineMethod('init',function(a){var b,c,d;this.callNextMethod();b=a.indexOf(':');this.$set('uri',a);this.$set('scheme',a.slice(0,b));c=a.slice(b+1);this.$set('schemeSpecificPart',c);d=this.$parseSchemeSpecificPart(c);this.$initURIComponents(d);return this;});TP.core.URI.Inst.defineMethod('addResource',function(a,c,d){var b;if(TP.canInvoke(a,'addContent')){b=a.addContent(c);}else if(TP.canInvoke(a,'add')){b=a.add(c);}else{b=this.setResource(TP.str(a)+TP.str(c));}d.complete(b);return b;});TP.core.URI.Inst.defineMethod('$initURIComponents',function(a){return this;});TP.core.URI.Inst.defineMethod('$parseSchemeSpecificPart',function(a){var b,c;TP.debug('break.uri_parse');if(TP.isEmpty(a)){return;}if(a.indexOf('#')!==TP.NOT_FOUND){b=a.slice(0,a.indexOf('#'));this.$set('primaryHref',TP.join(this.$get('scheme'),':',b));if(TP.notEmpty(c=a.slice(a.indexOf('#')+1))){this.$set('fragment',c);}}else{this.$set('primaryHref',TP.join(this.$get('scheme'),':',a));}return;});TP.core.URI.Inst.defineMethod('constructRequest',function(a){return TP.request(a);});TP.core.URI.Inst.defineMethod('constructSubRequest',function(b){var a,c;if(TP.canInvoke(b,'getPayload')){c=b.getPayload();if(TP.isValid(c)){a=TP.sig.Request.construct(c.copy());}else{a=TP.sig.Request.construct();}}else{a=TP.sig.Request.construct(b);}return a;});TP.core.URI.Inst.defineMethod('asDumpString',function(){var a;if(this.$$format_asDumpString){return TP.recursion(this);}this.$$format_asDumpString=true;try{a=TP.tname(this)+' :: '+'('+TP.str(this.getLocation())+')';}catch(b){a=this.toString();}delete this.$$format_asDumpString;return a;});TP.core.URI.Inst.defineMethod('asHTMLString',function(){return'<span class="TP_core_URI '+TP.escapeTypeName(TP.tname(this))+'">'+TP.htmlstr(this.asString())+'</span>';});TP.core.URI.Inst.defineMethod('asJSONSource',function(){return'{"type":'+TP.tname(this).quoted('"')+','+'"data":'+this.asString().quoted('"')+'}';});TP.core.URI.Inst.defineMethod('asPrettyString',function(){return'<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'"><dt/><dd>'+TP.pretty(this.asString())+'</dd></dl>';});TP.core.URI.Inst.defineMethod('asString',function(a){return TP.str(this.getLocation());});TP.core.URI.Inst.defineMethod('asSource',function(){return'TP.uc(\''+this.getLocation()+'\')';});TP.core.URI.Inst.defineMethod('asXMLString',function(){return'<instance type="'+TP.tname(this)+'">'+TP.xmlstr(this.asString())+'</instance>';});TP.core.URI.Inst.defineMethod('asTP_core_URI',function(){return this;});TP.core.URI.Inst.defineMethod('clearCaches',function(){var a;this.$clearCaches();if((a=this.getPrimaryURI())!==this){a.clearCaches();}return this;});TP.core.URI.Inst.defineMethod('$clearCaches',function(){var a;TP.ifTrace()?TP.sys.logTransform('Clearing content cache for: '+this.getID(),TP.TRACE,arguments):0;if(TP.isValid(a=this.get('resource'))){this.ignore(a,'Change');}this.$set('resource',null);this.set('headers',null);this.$set('expired',false);this.set('$dirty',false);this.set('$loaded',false);return this;});TP.core.URI.Inst.defineMethod('empty',function(){var a;if((a=this.getPrimaryURI())!==this){a.empty();}this.set('resource',null);this.set('$dirty',true);this.set('$loaded',true);return this;});TP.core.URI.Inst.defineMethod('equalTo',function(a){var b;if(TP.isString(a)){b=TP.uc(a);if(TP.notValid(b)){return false;}}else if(TP.canInvoke(a,'getLocation')){b=a;}else{return false;}return this.getLocation().equalTo(b.getLocation());});TP.core.URI.Inst.defineMethod('expire',function(b){var a;if((a=this.getPrimaryURI())!==this){a.expire(b);return a.isExpired();}this.$set('expired',TP.ifInvalid(b,true));return this.isExpired();});TP.core.URI.Inst.defineMethod('getContent',function(a){return this.$requestContent(a,'getResource','$getResultContent');});TP.core.URI.Inst.defineMethod('getContentNode',function(b){var a;a=this.constructRequest(b);a.atPut('resultType',TP.DOM);return this.getContent(a);});TP.core.URI.Inst.defineMethod('getContentText',function(b){var a;a=this.constructRequest(b);a.atPut('resultType',TP.TEXT);return this.getContent(a);});TP.core.URI.Inst.defineMethod('getController',function(i){var a,c,f,g,h,b,d,e;if(TP.notValid(a=this.$get('controller'))){if(!TP.isType(c=TP.sys.getTypeByName(i))){c=TP.core.URIController;if(TP.notFalse(this.isMappedURI())){f=TP.core.URI.$getURIEntry(this);g=TP.core.URI.$getURIProfileKey(null,false);if(TP.notValid(b=f.at(g))){h=TP.uriExpandPath(this.asString()).split('#').at(0);b=TP.core.URI.$getURIMapForKey(h,f,g);}if(TP.isValid(b)){if(TP.isValid(d=b.at('mapping'))){e=TP.sys.getTypeByName(d.at('tibet:uricontroller'));}else if(TP.isValid(d=b.at('delegate'))){e=TP.sys.getTypeByName(d.at('tibet:uricontroller'));}}if(TP.isType(e)){c=e;}}}a=c.construct();this.set('controller',a);a.set('uri',this);}return a;});TP.core.URI.Inst.defineMethod('$getDefaultHandler',function(a){return this.getType().$getDefaultHandler(this,a);});TP.core.URI.Inst.defineMethod('$getFilteredResult',function(b,d,c){var a;TP.debug('break.uri_filter');if(TP.isValid(b)){switch(d){case TP.DOM:if(TP.notFalse(c)){a=TP.collapse(b);if(TP.isValid(a)){a=TP.node(a,null,false);}}else{a=TP.node(b,null,false);}return a;case TP.TEXT:if(TP.notFalse(c)){a=TP.collapse(b);if(TP.isValid(a)){a=TP.str(a);}else{a='';}}else{a=TP.str(b);}return a;case TP.BEST:if(TP.notFalse(c)){a=TP.collapse(b);if(TP.isValid(a)){a=TP.node(a,null,false);}if(TP.notValid(a=TP.node(TP.collapse(b),null,false))){a=TP.str(TP.collapse(b));}}else{if(TP.notValid(a=TP.node(b,null,false))){a=TP.str(b);}}return a;case TP.WRAP:if(TP.isString(b)){if(TP.notValid(a=TP.tpnode(b,null,false))||TP.isTextNode(a)){if(TP.notValid(a=TP.json2js(b,null,false))){if(TP.notValid(a=TP.parse('Date',b))){a=b;}}}if(TP.notFalse(c)){a=TP.collapse(a);}}else if(TP.isNode(b)){a=b;if(TP.notFalse(c)){a=TP.collapse(a);}a=TP.tpnode(a);}else{a=b;if(TP.notFalse(c)){a=TP.collapse(a);}a=TP.wrap(a);if(TP.notValid(a)){a=b;if(TP.notFalse(c)){a=TP.collapse(a);}}}return a;default:return b;}}return null;});TP.core.URI.Inst.defineMethod('getFragment',function(){return this.$get('fragment');});TP.core.URI.Inst.defineMethod('getHeader',function(b){var a;a=this.$get('headers');if(TP.isEmpty(a)){return;}return a.at(b);});TP.core.URI.Inst.defineMethod('getID',function(){var a;if(TP.owns(this,TP.ID)){return this.$get(TP.ID);}a=this.getLocation();this.$set(TP.ID,a);return a;});TP.core.URI.Inst.defineMethod('getLastUpdateDate',function(){var b,a;if(TP.notEmpty(a=this.$get('lastUpdated'))){return a;}b=this.getHeader('Date');if(TP.notEmpty(b)){a=Date.from(b);}else{TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.trace(this.getID()+' has no Last-Updated information',TP.LOG,arguments):0;return;}TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.trace(this.getID()+' returning cached Last-Updated: '+a,TP.LOG,arguments):0;this.$set('lastUpdated',a);return a;});TP.core.URI.Inst.defineMethod('getLocalPath',function(){return TP.uriInLocalFormat(this.getLocation());});TP.core.URI.Inst.defineMethod('getLocation',function(){var a;if(TP.notValid(a=this.$get('decoded'))){a=decodeURI(this.$get('uri'));this.$set('decoded',a);}return a;});TP.core.URI.Inst.defineMethod('getName',function(){return this.$getOID();});TP.core.URI.Inst.defineMethod('getNativeObject',function(){return this.getLocation();});TP.core.URI.Inst.defineMethod('getPrimaryHref',function(){var a;if(TP.notEmpty(a=this.$get('primaryHref'))){return a;}a=this.getLocation();if(this.hasFragment()){a=a.split('#').at(0);}this.$set('primaryHref',a);return a;});TP.core.URI.Inst.defineMethod('$getPrimaryResource',function(a,b){return TP.override();});TP.core.URI.Inst.defineMethod('getPrimaryURI',function(){var a;if(TP.isURI(a=this.$get('primaryURI'))){return a;}a=this;if(this.hasFragment()){a=TP.uc(this.getPrimaryHref());}this.$set('primaryURI',a);return a;});TP.core.URI.Inst.defineMethod('getResource',function(a){if(this.isPrimaryURI()||!this.hasFragment()){return this.$getPrimaryResource(a,true);}return this.$requestContent(a,'$getPrimaryResource','$getResultFragment');});TP.core.URI.Inst.defineMethod('getResourceNode',function(b){var a;a=this.constructRequest(b);a.atPut('resultType',TP.DOM);return this.getResource(a);});TP.core.URI.Inst.defineMethod('getResourceText',function(b){var a;a=this.constructRequest(b);a.atPut('resultType',TP.TEXT);return this.getResource(a);});TP.core.URI.Inst.defineMethod('$getResultContent',function(d,b,e){var a,c;TP.debug('break.uri_content');a=TP.isCollection(b)?TP.collapse(b):b;a=TP.isNode(a)?TP.wrap(a):a;c=TP.ifKeyInvalid(d,'resultType',null);a=this.$getFilteredResult(a,c);return a;});TP.core.URI.Inst.defineMethod('$getResultFragment',function(e,c,f){var d,a,b;TP.debug('break.uri_fragment');d=TP.ifKeyInvalid(e,'resultType',null);a=this.getFragment();if(TP.notEmpty(a)){a=a.indexOf('#')===0?a:'#'+a;b=TP.isCollection(c)?TP.collapse(c):c;b=TP.isNode(b)?TP.wrap(b):b;if(TP.regex.DOCUMENT_ID.test(a)||TP.regex.BARENAME.test(a)){a=a;}else if(TP.regex.ANY_POINTER.test(a)){a=TP.apc(a);}b=TP.canInvoke(b,'get')?b.get(a):undefined;b=TP.wrap(TP.collapse(b));}else{b=c;}b=this.$getFilteredResult(b,d);return b;});TP.core.URI.Inst.defineMethod('getScheme',function(){return this.$get('scheme')||this.getType().get('SCHEME');});TP.core.URI.Inst.defineMethod('getSize',function(){return this.asString().getSize();});TP.core.URI.Inst.defineMethod('getSubURIs',function(){var a,b,c;if(this.hasFragment()){return null;}a=this.getType().get('instances');b=TP.rc('^'+this.getLocation()+'#');c=a.getKeys().select(function(a){return b.test(a);});return c.collect(function(b){return a.at(b);});});TP.core.URI.Inst.defineMethod('getURI',function(){return this;});TP.core.URI.Inst.defineMethod('getWebPath',function(){return TP.uriInWebFormat(this.getLocation());});TP.core.URI.Inst.defineMethod('handleChange',function(f){var b,d,a,g,e,c;b=this.getResource();if(TP.notEmpty(d=f.at(TP.CHANGE_PATHS))){a=this.getSubURIs();if(TP.notEmpty(a)){g=TP.ac();e=TP.ac();c=this;d.perform(function(j){var i,g,d,k,f,h;i=j.first().asString();g=j.last();for(d=0;d<a.getSize();d++){k=TP.regex.ANY_POINTER.match(a.at(d).getFragment()).at(1);if(k===i){for(f=0;f<g.getSize();f++){e.push(i);h=TP.hc('aspect',i,'address',g.at(f).at('address'),'action',g.at(f).at('action'),'target',b);switch(g.at(f).at('action')){case TP.CREATE:case TP.DELETE:a.at(d).signal('TP.sig.StructureChange',arguments,h);c.signal('TP.sig.StructureChange',arguments,h);break;case TP.UPDATE:a.at(d).signal('TP.sig.ValueChange',arguments,h);c.signal('TP.sig.ValueChange',arguments,h);break;}}}}});}else{this.changed('value',TP.UPDATE,TP.hc('target',b));}}else{this.changed('value',TP.UPDATE,TP.hc('target',b));}return this;});TP.core.URI.Inst.defineMethod('hasFragment',function(){return TP.notEmpty(this.getFragment());});TP.core.URI.Inst.defineMethod('$flag',function(a,b){var c,d;if(!TP.isString(a)){this.raise('TP.sig.InvalidParameter',arguments);return;}if((c=this.getPrimaryURI())!==this){d='is'+a.asTitleCase();if(TP.canInvoke(c,d)){return c[d](b);}else{this.raise('TP.sig.InvalidFunction',arguments);return;}}if(TP.isBoolean(b)){this.$set('$'+a,b);}return this.$get('$'+a);});TP.core.URI.Inst.defineMethod('isDirty',function(a){return this.$flag('dirty',a);});TP.core.URI.Inst.defineMethod('isExpired',function(a){return this.$flag('expired',a);});TP.core.URI.Inst.defineMethod('isHTTPBased',function(){var a;a=this.$get('httpBased');if(TP.notValid(a)){a=TP.regex.HTTP_SCHEME.test(this.getLocation());this.$set('httpBased',a);}return a;});TP.core.URI.Inst.defineMethod('isLoaded',function(a){return this.$flag('loaded',a);});TP.core.URI.Inst.defineMethod('isMappedURI',function(a){if(TP.isDefined(a)){this.$set('$mapped',a);}return this.$get('$mapped');});TP.core.URI.Inst.defineMethod('isPrimaryURI',function(){return!this.hasFragment();});TP.core.URI.Inst.defineMethod('$requestContent',function(a,h,g,f,i){var c,j,k,e,b,d;TP.debug('break.uri_content');if(!TP.canInvoke(this,h)){this.raise('TP.sig.InvalidParameter',arguments,'Must supply content accessor function name.');return;}c=this.getFragment();if(TP.notEmpty(c)){c=c.indexOf('#')===0?c:'#'+c;}j=TP.ifKeyInvalid(a,'resultType',null);k=TP.ifKeyInvalid(a,'refresh',null);e=this.rewriteRequestMode(a);b=this.constructSubRequest(a);d=this;b.defineMethod('completeJob',function(e){var c;c=e;if(TP.canInvoke(d,g)){c=d[g](a,e,i);}b.set('result',c);if(TP.canInvoke(a,'complete')){a.complete(c);}});b.defineMethod('failJob',function(b,c){if(TP.canInvoke(d,f)){d[f](b,c);}if(TP.canInvoke(a,'fail')){a.fail(b,c);}});this[h](b);e=this.rewriteRequestMode(b);if(e){if(TP.canInvoke(a,'constructResponse')){return a.constructResponse();}else{return b.constructResponse();}}return b.get('result');});TP.core.URI.Inst.defineMethod('rewrite',function(a){if(TP.isFalse(this.isMappedURI())){return this;}return this.getType().rewrite(this,a);});TP.core.URI.Inst.defineMethod('route',function(a){if(TP.isFalse(this.isMappedURI())){return this.$getDefaultHandler(a);}return this.getType().route(this,a);});TP.core.URI.Inst.defineMethod('setContent',function(a,b){return this.$requestContent(b,'getResource','$setResultContent',null,a);});TP.core.URI.Inst.defineMethod('setLastUpdateDate',function(c){var a,b;a=TP.ifInvalid(c,this.getHeader('Date'));a=TP.dc(a);this.$set('lastUpdated',a,false);b=this.$get('headers');if(TP.notValid(b)){b=TP.hc();this.$set('headers',b,false);}this.get('headers').atPut('Date',a.toUTCString());return a;});TP.core.URI.Inst.defineMethod('$setPrimaryResource',function(b,e){var c,d,a;TP.debug('break.uri_resource');if((c=this.getPrimaryURI())!==this){return c.$setPrimaryResource(b,e);}a=TP.wrap(b);if(TP.canInvoke(a,['addTIBETSrc','addXMLBase','$set'])){a.$set('uri',this,false);a.addTIBETSrc(this);a.addXMLBase();}if(this.isLoaded()){d=TP.wrap(this.$get('resource'));this.ignore(d,'Change');}this.$set('resource',a);this.observe(a,'Change');this.isDirty(true);this.isLoaded(true);this.expire(false);return this;});TP.core.URI.Inst.defineMethod('setResource',function(a,b){if(this.isPrimaryURI()||!this.hasFragment()){return this.$setPrimaryResource(a,b);}return this.$requestContent(b,'$getPrimaryResource','$setResultFragment',null,a);});TP.core.URI.Inst.defineMethod('$setResultContent',function(d,b,c){var a;TP.debug('break.uri_content');if(TP.isKindOf(b,'TP.sig.Response')){a=b.getResult();}else{a=b;}a=TP.isCollection(a)?TP.collapse(a):a;a=TP.isNode(a)?TP.wrap(a):a;if(TP.canInvoke(a,'set')){a.set('content',c);}else{this.raise('TP.sig.InvalidResource',arguments,'Unable to modify target resource.');}return a;});TP.core.URI.Inst.defineMethod('$setResultFragment',function(e,c,d){var a,b;TP.debug('break.uri_fragment');a=this.getFragment();if(TP.notEmpty(a)){a=a.indexOf('#')===0?a:'#'+a;b=TP.isCollection(c)?TP.collapse(c):c;b=TP.isNode(b)?TP.wrap(b):b;if(TP.regex.DOCUMENT_ID.test(a)||TP.regex.BARENAME.test(a)){a=a;}else if(TP.regex.ANY_POINTER.test(a)){a=TP.apc(a,true);}if(TP.canInvoke(b,'set')){b.set(a,d);}else{this.raise('TP.sig.InvalidResource',arguments,'Unable to modify target resource.');}}else{this.raise('TP.sig.InvalidFragment',arguments);}return b;});TP.core.URI.Inst.defineMethod('transform',function(d,a){var b,c;TP.debug('break.uri_transform');b=this.constructSubRequest(a);b.defineMethod('completeJob',function(f){var e,c;if(TP.isDefined(f)){c=f.collapse();e=TP.wrap(c);}if(TP.canInvoke(e,'transform')){c=e.transform(d,a);b.set('result',c);}if(TP.canInvoke(a,'complete')){if(TP.isValid(c)){a.complete(c);}else{a.complete();}}});b.defineMethod('failJob',function(b,c){if(TP.canInvoke(a,'fail')){a.fail(b,c);}});this.getResource(b);c=this.rewriteRequestMode(b);if(c){if(TP.canInvoke(a,'constructResponse')){return a.constructResponse();}else{return b.constructResponse();}}return b.get('result');});TP.core.URI.Inst.defineMethod('updateHeaders',function(b){var a,c,j,f,d,i,h,e,k,g;TP.debug('break.uri_headers');a=this.$get('headers');if(TP.isKindOf(b,TP.lang.Hash)){if(TP.isValid(a)){a.addAll(b);}else{a=b.copy();}}else if(TP.isValid(b)){if(TP.isString(b)){c=b;}else if(TP.isXHR(b)){c=TP.ifEmpty(b.getAllResponseHeaders(),'');}else if(TP.canInvoke(b,'at')){if(TP.isXHR(j=b.at('xhr'))){c=TP.ifEmpty(j.getAllResponseHeaders(),'');}}if(TP.notEmpty(c)){a=TP.ifInvalid(a,TP.hc());f=c.split('\n');i=f.getSize();for(d=0;d<i;d++){h=f.at(d).split(':');e=h.shift();k=h.join(':');if(TP.notEmpty(e)){a.atPut(e,k);}}}}a=TP.ifInvalid(a,TP.hc());if(TP.notValid(a.at('Date'))){g=TP.dc();this.$set('lastUpdated',g,false);a.atPut('Date',g.toUTCString());}this.$set('headers',a,false);return this;});TP.core.URI.defineSubtype('URN');TP.core.URN.isAbstract(true);TP.core.URN.Type.defineConstant('URN_REGEX',TP.rc('urn:([a-zA-Z0-9]+):(\\S+)'));TP.core.URN.Type.defineConstant('URN_NSS_REGEX',TP.rc('^([a-zA-Z0-9]+):(\\S+)'));TP.core.URN.Type.defineConstant('SCHEME','urn');TP.core.URN.Type.defineAttribute('supportedModes',TP.core.SyncAsync.SYNCHRONOUS);TP.core.URN.Type.defineAttribute('mode',TP.core.SyncAsync.SYNCHRONOUS);TP.core.URN.Type.defineAttribute('nidHandlers',TP.hc());TP.core.URN.registerForScheme('urn');TP.core.URN.Type.defineMethod('getConcreteType',function(d){var a,c,b;a=d.split(':');if(a.at(0)!=='urn'){return;}c=a.at(1);b=TP.core.URN.$get('nidHandlers').at(c);if(TP.isType(b)){return b;}return;});TP.core.URN.Type.defineMethod('registerForNID',function(a){var b;if(!TP.isString(a)){return this.raise('TP.sig.InvalidParameter',arguments,'Scheme is empty or null.');}b=a.strip(':');TP.core.URN.$get('nidHandlers').atPut(b,this);return;});TP.core.URN.Inst.defineAttribute('nid');TP.core.URN.Inst.defineAttribute('nss');TP.core.URN.Inst.defineAttribute('name');TP.core.URN.Inst.defineMethod('$initURIComponents',function(a){if(TP.canInvoke(a,'at')){this.$set('nid',a.at('nid'));this.$set('nss',a.at('nss'));}return this;});TP.core.URN.Inst.defineMethod('$parseSchemeSpecificPart',function(c){var a,b;TP.debug('break.uri_parse');this.callNextMethod();a=TP.core.URN.URN_NSS_REGEX.exec(c);if(TP.isArray(a)){b=TP.hc('nid',a.at(1),'nss',a.at(2));}return b;});TP.core.URN.Inst.defineMethod('$getPrimaryResource',function(b,e){var f,c,g,d,a,h,i;TP.debug('break.uri_resource');if((f=this.getPrimaryURI())!==this){a=f.$getPrimaryResource(TP.request('async',false),e);}else{c=this.rewriteRequestMode(b);if(c){d=this.constructRequest(b);}g=TP.ifKeyInvalid(b,'refresh',null);a=this.$get('resource');if(TP.notValid(a)||g){a=this.$resolveName(this.getName());}if(TP.isValid(a)){this.isLoaded(true);}}if(TP.isTrue(e)&&TP.isValid(a)){h=TP.ifKeyInvalid(b,'resultType',null);a=this.$getFilteredResult(a,h,false);}if(c){i=d.constructResponse(a);d.complete(a);return i;}if(TP.canInvoke(b,'complete')){b.complete(a);}return a;});TP.core.URN.Inst.defineMethod('getName',function(){var b,a;if(TP.notEmpty(a=this.$get('name'))){return a;}b=this.getLocation();a=b.split(':').slice(2).join(':').split('#').first();this.$set('name',a);return a;});TP.core.URN.Inst.defineMethod('$resolveName',function(a){return TP.override();});TP.core.URN.Inst.defineMethod('load',function(d){var a,b,c;TP.debug('break.uri_load');a=this.constructRequest(d);b=this.rewrite(a);a.atPut('route','load');c=TP.core.URIHandler;return c.load(b,a);});TP.core.URN.Inst.defineMethod('nuke',function(d){var a,b,c;TP.debug('break.uri_nuke');a=this.constructRequest(d);b=this.rewrite(a);a.atPut('route','nuke');c=TP.core.URIHandler;return c.nuke(b,a);});TP.core.URN.Inst.defineMethod('save',function(d){var a,b,c;TP.debug('break.uri_save');a=this.constructRequest(d);b=this.rewrite(a);a.atPut('route','save');c=TP.core.URIHandler;return c.save(b,a);});TP.core.URN.defineSubtype('TIBETURN');TP.core.TIBETURN.registerForNID('tibet');TP.core.TIBETURN.Inst.defineMethod('$resolveName',function(c){var a,b;a=c||this.getName();if(TP.regex.TIBET_URN.test(a)){a=a.slice(TP.TIBET_URN_PREFIX.length);}b=this.$get('resource');if(TP.notValid(b)){b=TP.sys.getTypeByName(a);if(!TP.isType(b)&&TP.sys.$globals.hasKey(a)){try{b=TP.global[a];}catch(a){}}}return b;});TP.core.TIBETURN.Inst.defineMethod('$setPrimaryResource',function(a,d){var b,e,c;TP.debug('break.uri_resource');if((b=this.getPrimaryURI())!==this){return b.$setPrimaryResource(a,d);}c=a[TP.ID]!==a.$$oid;if(!c){if(TP.canInvoke(a,'setID')){a.setID(this.getName());}}if(this.isLoaded()){e=this.$get('resource');this.ignore(a,'Change');}this.$set('resource',a);this.observe(a,'Change');this.isDirty(true);this.isLoaded(true);this.expire(false);return this;});TP.core.URI.defineSubtype('URL');TP.core.URL.isAbstract(true);TP.core.URL.Type.defineConstant('SCHEME',null);TP.core.URL.Inst.defineAttribute('path');TP.core.URL.Inst.defineAttribute('lastRequest');TP.core.URL.Inst.defineAttribute('lastCommObj');TP.core.URL.Inst.defineMethod('asURL',function(){return this;});TP.core.URL.Inst.defineMethod('getExtension',function(a){if(this.hasFragment()){return TP.uriExtension(this.getPrimaryHref(),a);}return TP.uriExtension(this.getLocation(),a);});TP.core.URL.Inst.defineMethod('getMIMEType',function(){var e,a,d,b,c;TP.debug('break.uri_mime');if((e=this.getPrimaryURI())!==this){return e.getMIMEType();}if(TP.notEmpty(a=this.get('computedMIMEType'))){return a;}if(this.isLoaded()){d=this.$get('resource');if(this.hasFragment()&&TP.canInvoke(d,'get')){b=this.getFragment();if(TP.isKindOf(d,TP.core.Node)){b=b.startsWith('#')?b:'#'+b;}c=d.get(b);}else{c=d;}if(TP.canInvoke(c,'getContentMIMEType')){a=c.getContentMIMEType(c);if(TP.isString(a)){this.$set('computedMIMEType',a);return a;}}}a=TP.ietf.Mime.guessMIMEType(c,this.getLocation(),this.get('defaultMIMEType'));if(TP.isString(a)){return a;}return this.get('defaultMIMEType');});TP.core.URL.Inst.defineMethod('getNativeNode',function(b){var a,c,d;a=this.constructSubRequest(b);d=this;a.defineMethod('completeJob',function(e){var c;c=TP.isValid(e)?TP.node(e):e;a.set('result',c);d.set('resource',c);if(TP.canInvoke(b,'complete')){b.complete(c);}});a.defineMethod('failJob',function(a,c){if(TP.canInvoke(b,'fail')){b.fail(a,c);}});this.getResourceNode(a);c=this.rewriteRequestMode(a);if(c){if(TP.canInvoke(b,'constructResponse')){return b.constructResponse();}else{return a.constructResponse();}}return a.get('result');});TP.core.URL.Inst.defineMethod('getPath',function(){var a,b;if(TP.notValid(a=this.$get('path'))){if(TP.notValid(b=this.getLocation())){return'';}a=this.$getPath(b);this.$set('path',a,false);}return a;});TP.core.URL.Inst.defineMethod('$getPath',function(b){var a;a=b.slice(b.indexOf(':')+1);a=a.chop('//');return a;});TP.core.URL.Inst.defineMethod('getRelativePath',function(a,b){return TP.uriRelativeToPath(this.getLocation(),a,b);});TP.core.URL.Inst.defineMethod('$getPrimaryResource',function(b,g){var h,a,e,d,f,c,i;TP.debug('break.uri_resource');if((h=this.getPrimaryURI())!==this){return h.$getPrimaryResource(b,g);}a=this.constructSubRequest(b);if(!this.isLoaded()||TP.notValid(e=a.at('refresh'))){e=!this.isLoaded();}d=this.rewriteRequestMode(a);a.atPut('async',d);f=this;a.defineMethod('completeJob',function(d){var e,c;c=d;if(TP.isTrue(g)&&TP.isValid(d)){e=TP.ifKeyInvalid(b,'resultType',null);c=f.$getFilteredResult(d,e,false);a.set('result',c);}f.set('resource',c);if(TP.canInvoke(b,'complete')){b.complete(c);}});a.defineMethod('failJob',function(a,c){if(TP.canInvoke(b,'fail')){b.fail(a,c);}});if(e){a.atPut('refresh',true);c=this.load(a);d=this.rewriteRequestMode(a);}else{i=this.$get('resource');a.complete(i);}if(d){if(TP.notValid(c)){if(TP.canInvoke(b,'constructResponse')){c=b.constructResponse();}else{c=a.constructResponse();}}return c;}return a.get('result');});TP.core.URL.Inst.defineMethod('updateResourceCache',function(h){var f,a,b,c,m,o,n,k,g,i,l,d,e,j;TP.debug('break.uri_cache');if(TP.notValid(h)){return this.raise('TP.sig.InvalidParameter',arguments,'No request object.');}if(TP.isFalse(h.at('refreshContent'))){return this.$get('resource');}f=this.getHeader('Content-Type');if(TP.isString(f)){f=f.split(';').first().trim();}this.set('defaultMIMEType',f,false);l=this.$get('resource');a=h.getResult();if(TP.isArray(a)&&a.getSize()===2){b=a.first();c=a.last();}else if(TP.isNode(a)){c=a;}else if(TP.isXHR(a)){b=a.responseText;try{c=a.responseXML;if(c.childNodes.length===0){c=null;}}catch(b){c=TP.node(a.responseText);}}else{b=a;}d=h.at('contentHandler');if(TP.notValid(d)){if(TP.notFalse(this.isMappedURI())){n=TP.core.URI.$getURIEntry(this);k=TP.core.URI.$getURIProfileKey(null,false);if(TP.notValid(g=n.at(k))){o=TP.uriExpandPath(this.asString()).split('#').at(0);g=TP.core.URI.$getURIMapForKey(o,n,k);}if(TP.isValid(g)){if(TP.isValid(i=g.at('mapping'))){d=i.at('tibet:contenthandler');}else if(TP.isValid(i=g.at('delegate'))){d=i.at('tibet:contenthandler');}}}if(TP.notValid(d)){j=this.getMIMEType();d=TP.ietf.Mime.getConcreteType(j);}else{d=TP.sys.require(d);}}if(TP.isType(d)){e=TP.sys.require(d);if(TP.canInvoke(e,'constructContentObject')){a=e.constructContentObject(this,c||b);if(TP.notValid(a)){return this.raise('',arguments,'Content handler failed to produce output.');}else{this.$set('resource',a,false);}}else{return this.raise('TP.sig.InvalidParameter',arguments,'Content handler API not supported.');}}else if(TP.isNode(c)){a=c;}else if(TP.isString(b)){j=this.getMIMEType();e=TP.ietf.Mime.getConcreteType(j);if(TP.canInvoke(e,'constructContentObject')){a=e.constructContentObject(this,b);if(TP.isValid(a)){this.$set('resource',a,false);}}else{a=b;}}else if(TP.isKindOf(b,'TP.lang.Hash')){m=b.at('type');if(TP.isString(m)&&TP.isType(e=TP.sys.getTypeByName(m))&&TP.canInvoke(e,'constructContentObject')){a=e.constructContentObject(this,b);if(TP.isValid(a)){this.$set('resource',a,false);}}}else{a=TP.ifInvalid(c,b);}if(TP.canInvoke(a,'getNativeNode')){this.$set('resource',a,false);}else if(TP.canInvoke(l,'setNativeNode')&&TP.isNode(a)){TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.sys.logIO('Refreshing current node container.',TP.TRACE,arguments):0;l.setNativeNode(a);}else if(TP.isNode(a)){TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.sys.logIO('Creating new node container.',TP.TRACE,arguments):0;a=TP.core.Node.construct(a);a.set('uri',this);this.$set('resource',a,false);}else{this.$set('resource',a,false);}this.expire(false);return this.$get('resource');});TP.core.URL.Inst.defineMethod('hasReachedPhase',function(b,c){var a;if(!this.isLoaded()){return false;}a=this.getResource(TP.hc('refresh',false,'async',false));if(TP.canInvoke(a,'hasReachedPhase')){return a.hasReachedPhase(b,c);}return false;});TP.core.URL.Inst.defineMethod('processTP_sig_Request',function(a){var c,b,f,d,e;TP.debug('break.uri_process');c=this.constructSubRequest(a);c.atPutIfAbsent('targetPhase','Finalize');b=this.constructSubRequest(a);f=this.getFragment();d=this;b.defineMethod('completeJob',function(g){var e,f;e=TP.tpnode(g);if(TP.canInvoke(e,'transform')){d.$setPrimaryResource(e);f=TP.process(e,c);if(c.didFail()){a.fail(c.getFaultCode(),c.getFaultText());b.fail(c.getFaultCode(),c.getFaultText());return;}b.set('result',f);d.set('resource',f);}if(TP.canInvoke(a,'complete')){a.complete(f);}});b.defineMethod('failJob',function(b,c){if(TP.canInvoke(a,'fail')){a.fail(b,c);}});this.getResource(b);e=this.rewriteRequestMode(b);if(e){if(TP.canInvoke(a,'constructResponse')){return a.constructResponse();}else{return b.constructResponse();}}return b.get('result');});TP.core.URL.Inst.defineMethod('load',function(d){var a,b,c;TP.debug('break.uri_load');TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.sys.logIO('Loading content data for ID: '+TP.ifInvalid(this.getLocation(),'FROM_SOURCE'),TP.TRACE,arguments):0;a=this.constructRequest(d);b=this.rewrite(a);this.$set('resource',null,false);a.atPut('route','load');c=b.route(this,a);return c.load(b,a);});TP.core.URL.Inst.defineMethod('nuke',function(d){var a,b,c;TP.debug('break.uri_nuke');a=this.constructRequest(d);b=this.rewrite(a);a.atPut('route','nuke');c=b.route(this,a);return c.nuke(b,a);});TP.core.URL.Inst.defineMethod('save',function(d){var a,b,c;TP.debug('break.uri_save');a=this.constructRequest(d);b=this.rewrite(a);a.atPut('route','save');c=b.route(this,a);return c.save(b,a);});TP.core.URL.defineSubtype('ChromeExtURL');TP.core.ChromeExtURL.Type.defineConstant('SCHEME','chrome-extension');TP.core.ChromeExtURL.registerForScheme('chrome-extension');TP.core.ChromeExtURL.Type.defineMethod('$getDefaultHandler',function(a,b){return TP.core.FileURLHandler;});TP.core.ChromeExtURL.Inst.defineMethod('$parseSchemeSpecificPart',function(a){this.callNextMethod();return TP.lang.Hash.URI_STRING_PARSER('chrome-extension:'+a);});TP.core.URL.defineSubtype('HTTPURL');TP.core.HTTPURL.Type.defineConstant('SCHEME','http');TP.core.HTTPURL.Type.defineAttribute('supportedModes',TP.core.SyncAsync.DUAL_MODE);TP.core.HTTPURL.Type.defineAttribute('mode',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.HTTPURL.registerForScheme('http');TP.core.HTTPURL.registerForScheme('https');TP.core.HTTPURL.Type.defineMethod('$getDefaultHandler',function(a,b){return TP.core.HTTPURLHandler;});TP.core.HTTPURL.Inst.defineAttribute('location');TP.core.HTTPURL.Inst.defineAttribute('user');TP.core.HTTPURL.Inst.defineAttribute('password');TP.core.HTTPURL.Inst.defineAttribute('host');TP.core.HTTPURL.Inst.defineAttribute('port');TP.core.HTTPURL.Inst.defineAttribute('query');TP.core.HTTPURL.Inst.defineAttribute('queryDict');TP.core.HTTPURL.Inst.defineMethod('$initURIComponents',function(a){this.callNextMethod();this.set('user',a.at('user'));this.set('password',a.at('password'));this.set('host',a.at('host'));this.set('port',a.at('port'));this.set('path',a.at('path'));this.set('query',a.at('query'));this.set('queryDict',a.at('queryDict'));return this;});TP.core.HTTPURL.Inst.defineMethod('$parseSchemeSpecificPart',function(a){this.callNextMethod();return TP.lang.Hash.URI_STRING_PARSER('http:'+a);});TP.core.HTTPURL.Inst.defineMethod('httpDelete',function(a){return TP.httpDelete(this.asString(),a);});TP.core.HTTPURL.Inst.defineMethod('httpGet',function(a){return TP.httpGet(this.asString(),a);});TP.core.HTTPURL.Inst.defineMethod('httpHead',function(a){return TP.httpHead(this.asString(),a);});TP.core.HTTPURL.Inst.defineMethod('httpOptions',function(a){return TP.httpOptions(this.asString(),a);});TP.core.HTTPURL.Inst.defineMethod('httpPost',function(a){return TP.httpPost(this.asString(),a);});TP.core.HTTPURL.Inst.defineMethod('httpPut',function(a){return TP.httpPut(this.asString(),a);});TP.core.HTTPURL.Inst.defineMethod('httpTrace',function(a){return TP.httpTrace(this.asString(),a);});TP.core.URL.defineSubtype('FileURL');TP.core.FileURL.Type.defineConstant('SCHEME','file');TP.core.FileURL.Type.defineAttribute('supportedModes',TP.core.SyncAsync.SYNCHRONOUS);TP.core.FileURL.Type.defineAttribute('mode',TP.core.SyncAsync.SYNCHRONOUS);TP.core.FileURL.registerForScheme('file');TP.core.FileURL.Type.defineMethod('$getDefaultHandler',function(a,b){return TP.core.FileURLHandler;});TP.core.FileURL.Inst.defineMethod('$initURIComponents',function(b){var a;this.callNextMethod();if(TP.notEmpty(a=b.at('path'))&&a.startsWith('/')){a=a.slice(1);}this.set('path',a);this.asString();return this;});TP.core.FileURL.Inst.defineMethod('$parseSchemeSpecificPart',function(a){this.callNextMethod();return TP.lang.Hash.URI_STRING_PARSER('file:'+a);});TP.core.FileURL.Inst.defineMethod('$getPath',function(a){var b;if(TP.boot.isWin()){b=a.slice(a.indexOf(':///')+4);}else{b=a.slice(a.indexOf('://')+3);}return b;});TP.core.URI.defineSubtype('JSURI');TP.core.JSURI.Type.defineConstant('JSURI_REGEX',TP.rc('javascript:\\s*'));TP.core.JSURI.Type.defineConstant('SCHEME','javascript');TP.core.JSURI.Type.defineAttribute('supportedModes',TP.core.SyncAsync.SYNCHRONOUS);TP.core.JSURI.Type.defineAttribute('mode',TP.core.SyncAsync.SYNCHRONOUS);TP.core.JSURI.Inst.defineAttribute('jsSource');TP.core.JSURI.registerForScheme('javascript');TP.core.JSURI.Type.defineMethod('constructContentObject',function(b,a){return a;});TP.core.JSURI.Inst.defineMethod('$getPath',function(a){return'';});TP.core.JSURI.Type.defineMethod('validate',function(aString){try{eval(aString);return true;}catch(a){return false;}});TP.core.JSURI.Inst.defineMethod('isPrimaryURI',function(){return true;});TP.core.JSURI.Inst.defineMethod('$parseSchemeSpecificPart',function(a){TP.debug('break.uri_parse');this.$set('primaryHref',this.$get('scheme')+':'+a);this.$set('jsSource',a.strip(TP.core.JSURI.JSURI_REGEX));return;});TP.core.JSURI.Inst.defineMethod('$getPrimaryResource',function(aRequest,filterResult){var request,async,str,$$result,result,msg,resultType,response;TP.debug('break.uri_resource');request=this.constructRequest(aRequest);async=this.rewriteRequestMode(request);str=this.get('jsSource');try{eval('$$result = '+str);result=$$result;}catch(a){msg=TP.sc('Error acquiring resource via: ')+str;request.fail(TP.FAILURE,msg);result=TP.ec(a,msg);}if(TP.isTrue(filterResult)&&TP.isValid(result)){resultType=TP.ifKeyInvalid(aRequest,'resultType',null);result=this.$getFilteredResult(result,resultType,false);}if(async){response=request.constructResponse(result);request.complete(result);return response;}if(TP.canInvoke(aRequest,'complete')){aRequest.complete(result);}return result;});TP.core.JSURI.Inst.defineMethod('isDirty',function(a){return true;});TP.core.JSURI.Inst.defineMethod('isLoaded',function(a){return false;});TP.core.JSURI.Inst.defineMethod('load',function(d){var a,b,c;TP.debug('break.uri_load');a=this.constructRequest(d);b=this.rewrite(a);a.atPut('route','load');c=TP.core.URIHandler;return c.load(b,a);});TP.core.JSURI.Inst.defineMethod('nuke',function(d){var a,b,c;TP.debug('break.uri_nuke');a=this.constructRequest(d);b=this.rewrite(a);a.atPut('route','nuke');c=TP.core.URIHandler;return c.nuke(b,a);});TP.core.JSURI.Inst.defineMethod('save',function(d){var a,b,c;TP.debug('break.uri_save');a=this.constructRequest(d);b=this.rewrite(a);a.atPut('route','save');c=TP.core.URIHandler;return c.save(b,a);});TP.core.URL.defineSubtype('WSURL');TP.core.WSURL.Type.defineConstant('SCHEME','ws');TP.core.WSURL.Type.defineAttribute('supportedModes',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.WSURL.Type.defineAttribute('mode',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.WSURL.registerForScheme('ws');TP.core.WSURL.registerForScheme('wss');TP.core.WSURL.Inst.defineAttribute('webSocketObj');TP.core.WSURL.Inst.defineAttribute('host');TP.core.WSURL.Inst.defineAttribute('port');TP.core.WSURL.Inst.defineMethod('$initURIComponents',function(a){this.callNextMethod();this.set('host',a.at('host'));this.set('port',a.at('port'));return this;});TP.core.WSURL.Inst.defineMethod('$parseSchemeSpecificPart',function(a){this.callNextMethod();return TP.lang.Hash.URI_STRING_PARSER('ws:'+a);});TP.core.URL.defineSubtype('TIBETURL');TP.core.TIBETURL.Type.defineConstant('JID_INDEX',1);TP.core.TIBETURL.Type.defineConstant('RESOURCE_INDEX',2);TP.core.TIBETURL.Type.defineConstant('CANVAS_INDEX',3);TP.core.TIBETURL.Type.defineConstant('URL_INDEX',4);TP.core.TIBETURL.Type.defineConstant('PATH_INDEX',5);TP.core.TIBETURL.Type.defineConstant('FRAGMENT_INDEX',6);TP.core.TIBETURL.Type.defineConstant('SCHEME','tibet');TP.core.TIBETURL.registerForScheme('tibet');TP.core.TIBETURL.Inst.defineAttribute('canvasName');TP.core.TIBETURL.Inst.defineAttribute('nestedURI');TP.core.TIBETURL.Inst.defineAttribute('uriKey');TP.core.TIBETURL.Inst.defineAttribute('uriParts');TP.core.TIBETURL.Inst.defineMethod('init',function(a){if(TP.regex.TIBET_SCHEME.test(a)&&TP.regex.TIBET_URI_SPLITTER.test(a)){this.callNextMethod();}else if(TP.regex.VIRTUAL_URI_PREFIX.test(a)){this.callNextMethod('tibet:///'+a);}else{this.$set('uri',a);return this.raise('TP.sig.InvalidURI',arguments,'Invalid TIBET URL prefix or scheme: '+a);}return this;});TP.core.TIBETURL.Inst.defineMethod('$initURIComponents',function(b){var a;a=this.getID();return this;});TP.core.TIBETURL.Inst.defineMethod('$parseSchemeSpecificPart',function(a){this.callNextMethod();return;});TP.core.TIBETURL.Inst.defineMethod('asDumpString',function(){if(TP.isEmpty(this.getCanvasName())){return this.getNestedURI().asDumpString();}return this.callNextMethod();});TP.core.TIBETURL.Inst.defineMethod('asHTMLString',function(){if(TP.isEmpty(this.getCanvasName())){return this.getNestedURI().asHTMLString();}return this.callNextMethod();});TP.core.TIBETURL.Inst.defineMethod('asJSONSource',function(){if(TP.isEmpty(this.getCanvasName())){return this.getNestedURI().asJSONSource();}return this.callNextMethod();});TP.core.TIBETURL.Inst.defineMethod('asPrettyString',function(){if(TP.isEmpty(this.getCanvasName())){return this.getNestedURI().asPrettyString();}return this.callNextMethod();});TP.core.TIBETURL.Inst.defineMethod('asString',function(a){if(TP.isEmpty(this.getCanvasName())){return this.getNestedURI().asString(a);}return this.callNextMethod();});TP.core.TIBETURL.Inst.defineMethod('asXMLString',function(){if(TP.isEmpty(this.getCanvasName())){return this.getNestedURI().asXMLString();}return this.callNextMethod();});TP.core.TIBETURL.Inst.defineMethod('getCanvas',function(){var a;a=this.getCanvasName();if(TP.notEmpty(a)){return TP.sys.getWindowById(a);}return;});TP.core.TIBETURL.Inst.defineMethod('getCanvasName',function(){var b,a;b=this.$get('uriParts');a=b.at(TP.core.TIBETURL.CANVAS_INDEX);if(TP.isEmpty(a)){a='';}else if(a==='uicanvas'||a==='UICANVAS'){return TP.sys.getUICanvasName();}else if(a==='uiroot'||a==='UIROOT'){return TP.sys.getUIRootName();}return a;});TP.core.TIBETURL.Inst.defineMethod('getNestedURI',function(d){var b,c,a;if(TP.notEmpty(this.getCanvasName())){return;}if(TP.notTrue(d)){if(TP.isURI(b=this.$get('nestedURI'))){return b;}}c=this.$get('uriParts');if(TP.isEmpty(c)){a=TP.uriResolveVirtualPath(this.$get('uri'),true);c=a.match(TP.regex.TIBET_URI_SPLITTER);}a=c.at(TP.core.TIBETURL.URL_INDEX);if(TP.isEmpty(a)){return;}a=TP.uriResolveVirtualPath(a,true);if(TP.regex.SCHEME.test(a)){b=TP.uc(a);if(TP.isURI(b)){this.set('nestedURI',b);}else{TP.ifWarn()?TP.warn('Invalid URI specification: '+a,TP.LOG,arguments):0;return;}}return b;});TP.core.TIBETURL.Inst.defineMethod('getID',function(){var a,b,c,d,e;a=this.$get(TP.ID);if(TP.owns(this,TP.ID)){return a;}if(TP.regex.TIBET_SCHEME.test(a)){return a;}b=this.$get('uri');if(!TP.regex.TIBET_URI_SPLITTER.test(b)){return TP.raise(b,'TP.sig.InvalidURI',arguments,b);}this.$set('uriParts',b.match(TP.regex.TIBET_URI_SPLITTER));c=this.$get('uriParts');d=this.getCanvasName();if(TP.isEmpty(d)){b=this.getNestedURI();e=b.getLocation();}else{e=TP.ifInvalid(c.at(TP.core.TIBETURL.PATH_INDEX),'')+TP.ifInvalid(c.at(TP.core.TIBETURL.FRAGMENT_INDEX),'');}a=TP.join('tibet:',TP.ifInvalid(c.at(TP.core.TIBETURL.JID_INDEX),''),'/',TP.ifInvalid(c.at(TP.core.TIBETURL.RESOURCE_INDEX),''),'/',d,'/',e);this.$set(TP.ID,a);return a;});TP.core.TIBETURL.Inst.defineMethod('getLocation',function(){if(TP.isEmpty(this.getCanvasName())){return this.getNestedURI().getLocation();}return this.callNextMethod();});TP.core.TIBETURL.Inst.defineMethod('getPath',function(){return this.getLocation()||'';});TP.core.TIBETURL.Inst.defineMethod('$getPrimaryResource',function(m,o){var b,i,d,k,h,c,f,e,n,l,g,j,a,q,p;TP.debug('break.uri_resource');b=this.constructRequest(m);i=b.at('refresh');d=o||false;if(!this.isLoaded()||TP.notValid(i)){i=false;if(!this.isLoaded()){i=true;}k=this.$get('uriParts');h=this.getCanvasName();if(TP.notEmpty(h)){i=true;}}c=this.rewriteRequestMode(b);if(TP.notTrue(i)){a=this.$get('resource');a=this.$getResourceResult(b,a,c,d);if(TP.canInvoke(m,'complete')){m.complete(a);}if(c){if(TP.canInvoke(m,'constructResponse')){return m.constructResponse(a);}else{return TP.request().constructResponse(a);}}return a;}k=k||this.$get('uriParts');h=this.getCanvasName();e=k.at(TP.core.TIBETURL.PATH_INDEX);n=k.at(TP.core.TIBETURL.FRAGMENT_INDEX);if(TP.notValid(l=this.$get('uriKey'))){l=TP.join(TP.str(TP.isEmpty(e)),'_',TP.str(TP.isEmpty(n)));this.$set('uriKey',l,false);}if(TP.notEmpty(h)){if(!TP.isWindow(g=TP.sys.getWindowById(h))){j=TP.join(TP.sc('Unable to locate window '),h,TP.sc(' for URI: '),this.getPath());TP.ifWarn()?TP.warn(j,TP.LOG,arguments):0;b.fail(TP.FAILURE,j);return this.$getResourceResult(b,undefined,c,d);}}if(TP.notEmpty(e)){e=TP.uriExpandPath(e);}if(TP.isWindow(g)){if(TP.regex.JS_SCHEME.test(e)){try{if(TP.notEmpty(this.getCanvasName())){f=TP.uc('tibet:///javascript:'+this.getCanvasName()+'.'+e.slice(11));a=f.getResource();return this.$getResourceResult(b,a,c,d);}else{if((f=this.getPrimaryURI())!==this){return f.$getPrimaryResource(b,o);}}}catch(a){j=TP.ec(a,TP.join(TP.sc('URI access produced error for: '),this.asString()));this.raise('TP.sig.URIException',arguments,j);b.fail(TP.FAILURE,j);return this.$getResourceResult(b,undefined,c,d);}}switch(l){case'true_true':a=TP.tpwin(g);return this.$getResourceResult(b,a,c,d);case'false_false':case'false_true':if(TP.notEmpty(e)&&(f=this.getPrimaryURI())!==this){if(TP.documentGetLocation(g.document)===e||n==='#document'){a=TP.core.DocumentNode.construct(g.document);return this.$getResourceResult(b,a,c,d);}return this.$getResourceResult(b,undefined,c,d);}else{a=TP.core.DocumentNode.construct(g.document);return this.$getResourceResult(b,a,c,d);}break;case'true_false':a=TP.core.DocumentNode.construct(g.document);return this.$getResourceResult(b,a,c,d);default:break;}}else{if((f=this.getPrimaryURI())!==this){return f.$getPrimaryResource(b,o);}switch(l){case'true_true':return this.$getResourceResult(b,undefined,c,d);case'false_false':case'false_true':if((f=this.getPrimaryURI())!==this){p=f.$getPrimaryResource(b);c=this.rewriteRequestMode(b);if(c){return p;}return this.$getResourceResult(b,p,c,d);}return;case'true_false':q=TP.sys.getUICanvas();if(TP.isValid(q)){a=q.getDocument();}if(TP.isValid(a)){return this.$getResourceResult(b,a,c,d);}return;default:break;}}a=TP.objectValue(a||g||window,n||e);return this.$getResourceResult(b,a,c,d);});TP.core.TIBETURL.Inst.defineMethod('getPrimaryHref',function(){if(TP.isEmpty(this.getCanvasName())){return this.getNestedURI().getPrimaryHref();}return this.callNextMethod();});TP.core.TIBETURL.Inst.defineMethod('getPrimaryURI',function(){if(TP.isEmpty(this.getCanvasName())){return this.getNestedURI().getPrimaryURI();}return this.callNextMethod();});TP.core.TIBETURL.Inst.defineMethod('$getResourceResult',function(b,e,f,g){var a,c,d;TP.debug('break.uri_resource');a=e;if(TP.isValid(a)){if(TP.isTrue(g)){c=TP.ifKeyInvalid(b,'resultType',null);a=this.$getFilteredResult(a,c,false);}this.$set('resource',a,false);this.isLoaded(true);}if(TP.isTrue(f)){d=b.constructResponse(a);b.complete(a);return d;}else{b.complete(a);return a;}});TP.core.TIBETURL.Inst.defineMethod('httpDelete',function(a){if(this.isHTTPBased()){return TP.httpDelete(this.asString(),a);}else{this.raise('TP.sig.UnsupportedOperation',arguments,this.asString());}});TP.core.TIBETURL.Inst.defineMethod('httpGet',function(a){if(this.isHTTPBased()){return TP.httpGet(this.asString(),a);}else{this.raise('TP.sig.UnsupportedOperation',arguments,this.asString());}});TP.core.TIBETURL.Inst.defineMethod('httpHead',function(a){if(this.isHTTPBased()){return TP.httpHead(this.asString(),a);}else{this.raise('TP.sig.UnsupportedOperation',arguments,this.asString());}});TP.core.TIBETURL.Inst.defineMethod('httpOptions',function(a){if(this.isHTTPBased()){return TP.httpOptions(this.asString(),a);}else{this.raise('TP.sig.UnsupportedOperation',arguments,this.asString());}});TP.core.TIBETURL.Inst.defineMethod('httpPost',function(a){if(this.isHTTPBased()){return TP.httpPost(this.asString(),a);}else{this.raise('TP.sig.UnsupportedOperation',arguments,this.asString());}});TP.core.TIBETURL.Inst.defineMethod('httpPut',function(a){if(this.isHTTPBased()){return TP.httpPut(this.asString(),a);}else{this.raise('TP.sig.UnsupportedOperation',arguments,this.asString());}});TP.core.TIBETURL.Inst.defineMethod('httpTrace',function(a){if(this.isHTTPBased()){return TP.httpTrace(this.asString(),a);}else{this.raise('TP.sig.UnsupportedOperation',arguments,this.asString());}});TP.core.TIBETURL.Inst.defineMethod('isDirty',function(a){if(TP.isEmpty(this.getCanvasName())){return this.getNestedURI().isDirty(a);}return this.callNextMethod();});TP.core.TIBETURL.Inst.defineMethod('isLoaded',function(a){return false;});TP.core.TIBETURL.Inst.defineMethod('isPrimaryURI',function(){if(TP.isEmpty(this.getCanvasName())){return false;}return!this.hasFragment();});TP.core.TIBETURL.Inst.defineMethod('updateHeaders',function(a){if(TP.isEmpty(this.getCanvasName())){return this.getNestedURI().updateHeaders(a);}return this;});TP.core.TIBETURL.Inst.defineMethod('updateResourceCache',function(b){var a;TP.debug('break.uri_cache');if((a=this.getPrimaryURI())!==this){return a.updateResourceCache(b);}return this.$get('resource');});TP.lang.Object.defineSubtype('core:URIHandler');TP.core.URIHandler.Type.defineMethod('load',function(a,b){TP.debug('break.uri_load');return a.$getPrimaryResource(b);});TP.core.URIHandler.Type.defineMethod('nuke',function(c,d){var a,b;TP.debug('break.uri_nuke');TP.todo('Implement nuke for non-file/http/db urls.');a=c.constructRequest(d);b=a.constructResponse();a.complete(true);return b;});TP.core.URIHandler.Type.defineMethod('save',function(c,d){var a,b;TP.debug('break.uri_save');a=c.constructRequest(d);b=a.constructResponse();a.complete(true);return b;});TP.core.URIHandler.Type.defineMethod('service',function(b,a){var c;c=a.at('route');switch(c){case'delete':return this.nuke(b,a);case'get':case'select':return this.load(b,a);case'post':case'put':case'insert':case'update':return this.save(b,a);default:a.fail(TP.FAILURE,'Unknown service method: '+c);break;}return;});TP.core.URIHandler.Inst.defineMethod('deserialize',function(j){var a,h,d,c,b,f,e,k,g,i;if(TP.isNode(a=j.getPayload().at('body'))){}TP.ifTrace()?TP.sys.logIO(TP.hc('body',a,'message','De-serializing data.'),TP.TRACE,arguments):0;h=TP.ifEmpty(this.getAttribute('tsh:replace',true),'tsh:target');switch(h){case'all':TP.todo('Deserialize "all".');break;case'instance':if(TP.notEmpty(d=this.getAttribute('tsh:instance'))){c=TP.nodeGetElementById(this.getPeerXMLDocument(),d,true);if(TP.isElement(c)){b='tsh:instance'.construct(c);}}else{b=this.getBoundInstance(j);}if(TP.isValid(b)){if(TP.isNode(a)){f=TP.documentFromString(TP.nodeAsString(a));b.setInstanceDocument(f);}else{TP.ifError()?TP.error(TP.boot.$annotate(a,'Instance replacement data not XML.'),TP.IO_LOG,arguments):0;}}else{TP.ifError()?TP.error('Instance: '+d+' not found.',TP.IO_LOG,arguments):0;}break;case'none':break;case'tsh:target':e=this.getAttribute('tsh:target',true);if(TP.isEmpty(e)){return this.raise('TP.sig.InvalidParameter',arguments,this.asString());}if(TP.isValid(k=TP.sys.getObjectById(e,true))){TP.sys.registerObject(a,e,true);}else{g=TP.uc(e);if(TP.isURI(g)){if(TP.notEmpty(d=this.getAttribute('tsh:instance'))){if(TP.isValid(i=g.getResource(TP.hc('async',false)))){if(TP.canInvoke(i,'getElementById')){c=i.getElementById(d);if(TP.isElement(c)){b='tsh:instance'.construct(c);}}}if(TP.isValid(b)){if(TP.isNode(a)){f=TP.documentFromString(TP.nodeAsString(a));b.setInstanceDocument(f);}else{TP.ifError()?TP.error(TP.boot.$annotate(a,'Instance replacement'+' data not XML.'),TP.IO_LOG,arguments):0;}}else{TP.ifError()?TP.error('Specified instance '+d+' not found.',TP.IO_LOG,arguments):0;}}else{g.setContent(a);}}else{c=TP.nodeGetElementById(this.getPeerXMLDocument(),d,true);if(TP.isElement(c)){b=TP.tpnode(c);b.setContent(a);}}}break;default:if(TP.isEmpty(e=this.getAttribute(h,true))){return this.raise('TP.sig.InvalidParameter',arguments,'Missing required replace/target specification.');}}return;});TP.core.URIHandler.Inst.defineMethod('serialize',function(c){var b,a;if(TP.notValid(b=c.getPayload().at('body'))){this.raise('TP.sig.InvalidParameter',arguments,'Signal has no content.');this.dispatch('tsh-service-error',this.getNativeNode(),c.getPayload());return;}if(TP.isNode(b)){b=b.firstChild;}TP.ifTrace()?TP.sys.logIO(TP.hc('body',b,'message','Serializing data.'),TP.TRACE,arguments):0;a=TP.ifEmpty(this.getAttribute('tsh:method',true),'GET');a=a.strip('-');a=a.strip(':');a=a.toUpperCase();if(TP.isMethod(this['serializeFor'+a])){return this['serializeFor'+a](b);}this.raise('TP.sig.UnsupportedOperation',arguments,'Serialization method not found: '+a);this.dispatch('tsh-service-error',this.getNativeNode(),c.getPayload());return;});TP.core.URIHandler.Inst.defineMethod('transmit',function(a){var b,c,d,e,f,g,h,i;if(TP.notValid(b=a.getPayload())){this.raise('TP.sig.InvalidParameter',arguments,'Signal has no arguments.');this.dispatch('tsh-service-error',this.getNativeNode(),a.getPayload());return;}if(TP.notValid(c=a.getPayload().at('body'))){this.raise('TP.sig.InvalidParameter',arguments,'Signal has no content.');this.dispatch('tsh-service-error',this.getNativeNode(),a.getPayload());return;}if(TP.isNode(c)){d=TP.nodeGetTextContent(c);}else{d=TP.str(c);}e=this.getAttribute('tsh:action');TP.ifTrace()?TP.sys.logIO(TP.hc('uri',e,'verb',TP.HTTP_GET,'direction',TP.SEND,'body',d,'message','XControls service request initiated.'),TP.TRACE,arguments):0;if(TP.regex.HTTP_SCHEME.test(e.toLowerCase())){b.atPut('verb','GET');b.atPut('uriparams',d);f=TP.sig.RESTRequest.construct(b);f.set('requestor',this);g=this.getType().get('processor');return TP.handle(g,f);}else{h=TP.uc(e);i=this.signal('tsh-service-transmit-done',arguments,TP.hc('body',h.getNativeNode()));this['handletsh-service-transmit-done'](i);return;}});TP.lang.Object.defineSubtype('core:URIRewriter');TP.core.URIRewriter.Type.defineMethod('rewrite',function(a,m){var i,f,n,d,e,p,c,g,j,h,k,b,o,l;TP.debug('break.uri_rewrite');if(TP.isValid(m)&&TP.isTrue(m.at('no_rewrite'))){return a;}i=TP.core.URI.$getURIEntry(a);if(TP.isEmpty(i)){f=TP.isString(a)?TP.core.URI.construct(a):a;f.isMappedURI(false);return f;}n=TP.core.URI.$getURIProfileKey(null,false);d=TP.uriExpandPath(a.asString()).split('#').at(0);if(TP.isValid(e=i.at(n))){if(TP.isEmpty(e)){return TP.isString(a)?TP.core.URI.construct(a):a;}else if(TP.isValid(p=e.at('rewrite'))){return p;}else{}}else{e=TP.ifInvalid(TP.core.URI.$getURIMapForKey(d,i,n),TP.hc());}if(TP.isValid(c=e.at('mapping'))){g=TP.uriExpandPath(c.at('tibet:localuri'));if(TP.notEmpty(g)){TP.ifTrace(TP.$$DEBUG&&TP.$$VERBOSE)?TP.trace('Found local cache \''+g+'\' for uri: '+d,TP.LOG,arguments):0;j=c.at('tibet:duration');if(TP.notEmpty(j)){TP.ifTrace(TP.$$DEBUG&&TP.$$VERBOSE)?TP.trace('Found cache duration \''+j+'\' for uri: '+d,TP.LOG,arguments):0;h=c.at('tibet:updated');if(TP.notEmpty(h)){k=Date.from(h);k=k.addDuration(j);if(TP.dc().getTime()<k.getTime()){b=g;}else{b=TP.uriExpandPath(c.at('uri'));}}else{b=TP.uriExpandPath(c.at('uri'));}}else{h=c.at('tibet:updated');if(TP.notEmpty(h)){b=g;}else{b=TP.uriExpandPath(c.at('uri'));}}}else{b=TP.uriExpandPath(c.at('uri'));}if(TP.regex.HAS_HASH.test(d)){b=TP.join(b,'#',d.split('#').last());}if(d!==b){b=TP.core.URI.rewrite(b,m);}l=TP.core.URI.construct(b);}else if(TP.isValid(c=e.at('rewrite'))){b=TP.isString(a)?a:a.getLocation();o=b.replace(c.at('uriStartString')||c.at('tibet:uriMatchString'),c.at('rewritePrefix'));l=TP.core.URI.construct(o);}else{return TP.isString(a)?TP.core.URI.construct(a):a;}if(TP.notValid(l)){TP.ifWarn(TP.$$DEBUG&&TP.$$VERBOSE)?TP.warn('Invalid rewrite uri: '+b+'. Using '+d,TP.LOG,arguments):0;f=TP.isString(a)?TP.core.URI.construct(a):a;}else{TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.trace('Found rewrite uri \''+b+'\' for uri: '+d,TP.LOG,arguments):0;f=l;}e.atPut('rewrite',f);return f;});TP.lang.Object.defineSubtype('core:URIRouter');TP.core.URIRouter.Type.defineMethod('route',function(e,c){var d,g,j,i,b,a,h,f;TP.debug('break.uri_route');if(TP.isValid(c)&&TP.isTrue(c.at('no_rewrite'))){return e;}d=TP.isString(e)?TP.core.URI.construct(e):e;g=TP.core.URI.$getURIEntry(e);if(TP.isEmpty(g)){d.isMappedURI(false);return d.$getDefaultHandler(c);}j=TP.core.URI.$getURIProfileKey(null,false);i=TP.uriExpandPath(e.asString()).split('#').at(0);if(TP.isValid(b=g.at(j))){if(TP.isEmpty(b)){return d.$getDefaultHandler(c);}else if(TP.isValid(a=b.at('route'))){return a;}}else{b=TP.ifInvalid(TP.core.URI.$getURIMapForKey(i,g,j),TP.hc());}if(TP.isValid(h=b.at('mapping'))){a=h.at('tibet:urihandler');}else if(TP.isValid(h=b.at('delegate'))){a=h.at('tibet:urihandler');}if(TP.isEmpty(a)){TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.trace('Returning default handler type: TP.core.URIHandler',TP.LOG,arguments):0;return d.$getDefaultHandler(c);}f=TP.sys.require(a);if(TP.notValid(f)){TP.ifWarn()?TP.warn('Unable to load route handler: '+a,TP.LOG,arguments):0;TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.trace('Returning default handler type: TP.core.URIHandler',TP.LOG,arguments):0;return d.$getDefaultHandler(c);}TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.trace('Found route \''+a+'\' for uri: '+i,TP.LOG,arguments):0;b.atPut('route',f);return f;});TP.core.URIHandler.defineSubtype('FileURLHandler');TP.core.FileURLHandler.Type.defineMethod('load',function(a,b){var c,e,f,g,d;TP.debug('break.uri_load');c=a.constructSubRequest(b);if(!TP.canInvoke(TP,'$fileLoad')){this.raise('TP.sig.UnsupportedOperation',arguments);if(TP.canInvoke(b,'fail')){b.fail(TP.FAILURE,'Unsupported operation.');}return;}if(!TP.canInvoke(a,'getLocation')){this.raise('TP.sig.InvalidURI',arguments);if(TP.canInvoke(b,'fail')){b.fail(TP.FAILURE,'Invalid URI: '+a);}return;}e=a.getLocation();f=a.isLoaded();c.atPutIfAbsent('async',false);c.atPutIfAbsent('shouldReport',false);c.defineMethod('completeJob',function(e){var d;a.updateHeaders(c);d=a.updateResourceCache(c);a.isLoaded(true);a.isDirty(false);if(TP.canInvoke(b,'complete')){b.complete(d);}});c.defineMethod('failJob',function(d,e){a.updateHeaders(c);a.updateResourceCache(c);a.isLoaded(false);a.isDirty(true);if(TP.canInvoke(b,'fail')){b.fail(d,e);}});g=TP.$fileLoad(e,c);if(TP.canInvoke(b,'constructResponse')){d=b.constructResponse();}else{d=c.constructResponse();}return d;});TP.core.FileURLHandler.Type.defineMethod('nuke',function(b,a){var c,e,f,d;TP.debug('break.uri_nuke');c=b.constructSubRequest(a);if(!TP.canInvoke(TP,'$fileDelete')){this.raise('TP.sig.UnsupportedOperation',arguments);if(TP.canInvoke(a,'fail')){a.fail(TP.FAILURE,'Unsupported operation.');}return;}if(!TP.canInvoke(b,'getLocation')){this.raise('TP.sig.InvalidURI',arguments);if(TP.canInvoke(a,'fail')){a.fail(TP.FAILURE,'Invalid URI: '+b);}return;}c.defineMethod('completeJob',function(c){if(TP.isTrue(c)){b.isDirty(false);b.isLoaded(false);if(TP.canInvoke(a,'complete')){a.complete(c);}}else if(TP.canInvoke(a,'fail')){a.fail();}});c.defineMethod('failJob',function(b,c){if(TP.canInvoke(a,'fail')){a.fail(b,c);}});e=b.getLocation();f=TP.$fileDelete(e,c);if(TP.canInvoke(a,'constructResponse')){d=a.constructResponse();}else{d=c.constructResponse();}return d;});TP.core.FileURLHandler.Type.defineMethod('save',function(c,a){var b,e,f,g,d;TP.debug('break.uri_save');b=c.constructSubRequest(a);if(!TP.canInvoke(TP,'$fileSave')){this.raise('TP.sig.UnsupportedOperation',arguments);if(TP.canInvoke(a,'fail')){a.fail(TP.FAILURE,'Unsupported operation.');}return;}if(!TP.canInvoke(c,'getLocation')){this.raise('TP.sig.InvalidURI',arguments);if(TP.canInvoke(a,'fail')){a.fail(TP.FAILURE,'Invalid URI: '+c);}return;}e=c.getLocation();b.atPutIfAbsent('async',false);b.atPutIfAbsent('append',false);b.atPutIfAbsent('backup',true);b.atPutIfAbsent('refreshContent',false);f=TP.ifInvalid(c.getResource(b),'');b.atPutIfAbsent('body',TP.str(f));b.defineMethod('completeJob',function(b){if(TP.isTrue(b)){c.isDirty(false);c.isLoaded(true);if(TP.canInvoke(a,'complete')){a.complete(b);}}else if(TP.canInvoke(a,'fail')){a.fail();}});b.defineMethod('failJob',function(b,c){if(TP.canInvoke(a,'fail')){a.fail(b,c);}});g=TP.$fileSave(e,b);if(TP.canInvoke(a,'constructResponse')){d=a.constructResponse();}else{d=b.constructResponse();}return d;});TP.core.URIHandler.defineSubtype('HTTPURLHandler');TP.core.HTTPURLHandler.Type.defineMethod('load',function(c,f){var b,d,e,a;TP.debug('break.uri_load');b=c.constructRequest(f);d=b.constructResponse();if(!TP.canInvoke(c,'getLocation')){b.fail();return d;}e=c.getLocation();a=TP.sig.HTTPLoadRequest.construct(b);b.andJoinChild(a);a.atPut('uri',e);if(TP.notEmpty(a.at('body'))){a.atPutIfAbsent('verb',TP.HTTP_POST);}else{a.atPutIfAbsent('verb',TP.HTTP_GET);}TP.core.HTTPService.handle(a);b.updateRequestMode(a);return d;});TP.core.HTTPURLHandler.Type.defineMethod('nuke',function(c,g){var b,d,e,a,f;TP.debug('break.uri_nuke');b=c.constructRequest(g);d=b.constructResponse();if(!TP.canInvoke(c,'getLocation')){b.fail();return d;}e=c.getLocation();a=TP.sig.HTTPNukeRequest.construct(b);b.andJoinChild(a);a.atPut('uri',e);if(TP.isEmpty(a.at('verb'))){f=TP.ifInvalid(a.at('iswebdav'),TP.sys.cfg('http.use_webdav'));if(f){a.atPut('verb',TP.HTTP_DELETE);}else{a.atPut('verb',TP.HTTP_POST);a.atPut('method',TP.HTTP_DELETE);}}TP.core.HTTPService.handle(a);b.atPut('async',a.at('async'));return d;});TP.core.HTTPURLHandler.Type.defineMethod('save',function(c,h){var b,d,e,a,f,g;TP.debug('break.uri_save');b=c.constructRequest(h);d=b.constructResponse();if(!TP.canInvoke(c,'getLocation')){b.fail();return d;}e=c.getLocation();a=TP.sig.HTTPSaveRequest.construct(b);b.andJoinChild(a);a.atPut('refreshContent',false);if(TP.notValid(a.at('body'))){f=TP.ifInvalid(c.getResource(TP.hc('async',false)),'');a.atPut('body',f);}a.atPut('uri',e);if(TP.isEmpty(a.at('verb'))){g=TP.ifInvalid(a.at('iswebdav'),TP.sys.cfg('http.use_webdav'));if(g){if(a.at('crud')===TP.CREATE){a.atPut('verb',TP.HTTP_PUT);}else{a.atPut('verb',TP.HTTP_POST);}}else{a.atPut('verb',TP.HTTP_POST);if(a.at('crud')===TP.CREATE){a.atPut('method',TP.HTTP_PUT);}else{a.atPut('method',TP.HTTP_POST);}}}TP.core.HTTPService.handle(a);b.atPut('async',a.at('async'));return d;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETWWWTypes.js';
TP.lang.Object.defineSubtype('w3:DocType');TP.w3.DocType.Type.defineAttribute('docTypeRegistry',TP.ac());TP.w3.DocType.Inst.defineAttribute('docTypeName');TP.w3.DocType.Inst.defineAttribute('publicID');TP.w3.DocType.Inst.defineAttribute('systemID');TP.w3.DocType.Inst.defineAttribute('dtdInfo');TP.w3.DocType.Type.defineMethod('initialize',function(){TP.w3.DocType.Type.defineConstant('XHTML_10_TRANSITIONAL',TP.w3.DocType.construct('html','-//W3C//DTD XHTML 1.0 Transitional//EN','http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'));TP.w3.DocType.Type.defineConstant('XHTML_10_STRICT',TP.w3.DocType.construct('html','-//W3C//DTD XHTML 1.0 Strict//EN','http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'));TP.w3.DocType.Type.defineConstant('XHTML_10_FRAMESET',TP.w3.DocType.construct('html','-//W3C//DTD XHTML 1.0 Frameset//EN','http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd'));TP.w3.DocType.Type.defineConstant('HTML_401_TRANSITIONAL',TP.w3.DocType.construct('HTML','-//W3C//DTD HTML 4.01 Transitional//EN','http://www.w3.org/TR/html4/loose.dtd'));TP.w3.DocType.Type.defineConstant('HTML_401_STRICT',TP.w3.DocType.construct('HTML','-//W3C//DTD HTML 4.01 Strict//EN','http://www.w3.org/TR/html4/strict.dtd'));TP.w3.DocType.Type.defineConstant('HTML_401_FRAMESET',TP.w3.DocType.construct('HTML','-//W3C//DTD HTML 4.01 Frameset//EN','http://www.w3.org/TR/html4/frameset.dtd'));TP.w3.DocType.Type.defineConstant('HTML_32_FINAL',TP.w3.DocType.construct('HTML','-//W3C//DTD HTML 3.2 Final//EN',''));TP.w3.DocType.Type.defineConstant('SVG_10',TP.w3.DocType.construct('svg','-//W3C//DTD SVG 1.0//EN','http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd'));TP.w3.DocType.Type.defineConstant('MATHML_20',TP.w3.DocType.construct('math','-//W3C//DTD MathML 2.0//EN','http://www.w3.org/TR/MathML2/dtd/mathml2.dtd'));return;});TP.w3.DocType.Type.defineMethod('docTypeForInfo',function(a){var b;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=this.get('docTypeRegistry').detect(function(b){if(b.get('docTypeName').equalTo(a.at('docTypeName'))&&b.get('publicID').equalTo(a.at('publicID'))){return true;}});return b;});TP.w3.DocType.Inst.defineAttribute('str');TP.w3.DocType.Inst.defineMethod('init',function(a,b,c){this.callNextMethod();this.set('docTypeName',a);this.set('publicID',b);this.set('systemID',c);this.getType().get('docTypeRegistry').add(this);return this;});TP.w3.DocType.Inst.defineMethod('asDumpString',function(){var b,a;b=TP.join('<!DOCTYPE ',this.get('docTypeName'),' PUBLIC "',this.get('publicID'),'" "',this.get('systemID'),'">');try{a=TP.tname(this)+' :: '+'('+b+')';}catch(b){a=this.toString();}return a;});TP.w3.DocType.Inst.defineMethod('asHTMLString',function(){return'<span class="TP_w3_DocType '+TP.escapeTypeName(TP.tname(this))+'">'+'<span data-name="doctypename">'+TP.htmlstr(this.get('docTypeName'))+'</span>'+'<span data-name="publicID">'+TP.htmlstr(this.get('publicID'))+'</span>'+'<span data-name="systemID">'+TP.htmlstr(this.get('systemID'))+'</span>'+'</span>';});TP.w3.DocType.Inst.defineMethod('asJSONSource',function(){var a;try{a='{"type":'+TP.tname(this).quoted('"')+','+'"data":{'+'"DOCTYPE":"'+this.get('docTypeName')+'",'+'"PUBLIC":"'+this.get('publicID')+'",'+'"SYSTEM":"'+this.get('systemID')+'"'+'}}';}catch(b){a=this.toString();}return a;});TP.w3.DocType.Inst.defineMethod('asPrettyString',function(){return'<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+'<dt class="pretty key">DOCTYPE:</dt>'+'<dd class="pretty value">'+this.get('docTypeName')+'</dd>'+'<dt class="pretty key">PUBLIC:</dt>'+'<dd class="pretty value">'+this.get('publicID')+'</dd>'+'<dt class="pretty key">SYSTEM:</dt>'+'<dd class="pretty value">'+this.get('systemID')+'</dd>'+'</dl>';});TP.w3.DocType.Inst.defineMethod('asSource',function(){return TP.join('TP.w3.DocType.construct(\'',this.get('docTypeName'),'\',\'',this.get('publicID'),'\',\'',this.get('systemID'),'\')');});TP.w3.DocType.Inst.defineMethod('asString',function(b){var a;if(TP.notValid(a=this.$get('str'))){a=TP.join('<!DOCTYPE ',this.get('docTypeName'),' PUBLIC "',this.get('publicID'),'" "',this.get('systemID'),'">');this.$set('str',a);}return a;});TP.w3.DocType.Inst.defineMethod('asXMLString',function(){return'<instance type="'+TP.tname(this)+'">'+'<doctypename>'+TP.xmlstr(this.get('docTypeName'))+'</doctypename>'+'<publicID>'+TP.xmlstr(this.get('publicID'))+'</publicID>'+'<systemID>'+TP.xmlstr(this.get('systemID'))+'</systemID>'+'</instance>';});TP.lang.Object.defineSubtype('core:HTTP');TP.core.HTTP.Type.defineConstant('CODES',TP.hc(100,'Continue',101,'Switching Protocols',200,'OK',201,'Created',202,'Accepted',203,'Non-Authoritative Information',204,'No Content',205,'Reset Content',206,'Partial Content',300,'Multiple Choices',301,'Moved Permanently',302,'Found',303,'See Other',304,'Not Modified',305,'Use Proxy',306,'Unused',307,'Temporary Redirect',400,'Bad Request',401,'Unauthorized',402,'Payment Required',403,'Forbidden',404,'Not Found',405,'Method Not Allowed',406,'Not Acceptable',407,'Proxy Authentication Required',408,'Request Timeout',409,'Conflict',410,'Gone',411,'Length Required',412,'Precondition Failed',413,'Request Entity Too Large',414,'Request URI Too Long',415,'Unsupported Media Type',416,'Requested Range Not Satisfiable',417,'Expectation Failed',500,'Internal Server Error',501,'Not Implemented',502,'Bad Gateway',503,'Service Unavailable',504,'Gateway Timeout',505,'Version Not Supported'));TP.core.HTTP.Type.defineMethod('initialize',function(){this.CODES.perform(function(a){this.Type.defineConstant(a.last().toUpperCase().replace(' ','_','g'),a.first());}.bind(this));return;});TP.core.HTTP.Type.defineMethod('getStatusText',function(a){if(TP.notValid(a)){return;}return TP.ifInvalid(TP.core.HTTP.CODES.at(a.asNumber()),'');});TP.lang.Object.defineSubtype('ietf:Mime');TP.ietf.Mime.Type.defineConstant('PLAIN',TP.PLAIN_TEXT_ENCODED);TP.ietf.Mime.Type.defineConstant('CSV','text/csv');TP.ietf.Mime.Type.defineConstant('ICAL','text/calendar');TP.ietf.Mime.Type.defineConstant('CSS',TP.CSS_TEXT_ENCODED);TP.ietf.Mime.Type.defineConstant('HTML',TP.HTML_TEXT_ENCODED);TP.ietf.Mime.Type.defineConstant('ECMASCRIPT','text/ecmascript');TP.ietf.Mime.Type.defineConstant('JS',TP.JS_TEXT_ENCODED);TP.ietf.Mime.Type.defineConstant('JSON',TP.JSON_ENCODED);TP.ietf.Mime.Type.defineConstant('XHTML',TP.XHTML_ENCODED);TP.ietf.Mime.Type.defineConstant('TSH','text/vnd.TPI.TSH');TP.ietf.Mime.Type.defineConstant('GIF','image/gif');TP.ietf.Mime.Type.defineConstant('JPEG','image/jpeg');TP.ietf.Mime.Type.defineConstant('PNG','image/png');TP.ietf.Mime.Type.defineConstant('FLASH','application/x-shockwave-flash');TP.ietf.Mime.Type.defineConstant('SILVERLIGHT','application/x-silverlight');TP.ietf.Mime.Type.defineConstant('SMIL','application/smil+xml');TP.ietf.Mime.Type.defineConstant('SVG','application/svg+xml');TP.ietf.Mime.Type.defineConstant('XSLT','application/xslt+xml');TP.ietf.Mime.Type.defineConstant('ATOM','application/atom+xml');TP.ietf.Mime.Type.defineConstant('RDF','application/rdf+xml');TP.ietf.Mime.Type.defineConstant('RSS','application/rss+xml');TP.ietf.Mime.Type.defineConstant('SOAP',TP.SOAP_ENCODED);TP.ietf.Mime.Type.defineConstant('XMLRPC',TP.XMLRPC_ENCODED);TP.ietf.Mime.Type.defineConstant('XML',TP.XML_ENCODED);TP.ietf.Mime.Type.defineConstant('XMPP','application/xmpp+xml');TP.ietf.Mime.Type.defineConstant('$KEYS',TP.ac('mimetype','alias','handler','tpDocNodeType','extensions'));TP.ietf.Mime.Type.defineAttribute('info',TP.hc());TP.ietf.Mime.Type.defineAttribute('extensionInfo',TP.hc());TP.ietf.Mime.Type.defineMethod('initialize',function(){var a=this.get('info');a.addAll(TP.hc(TP.ietf.Mime.PLAIN,TP.hc('mimetype',TP.ietf.Mime.PLAIN,'alias','PLAIN','extensions','txt','tshtag','html:span'),TP.ietf.Mime.CSV,TP.hc('mimetype',TP.ietf.Mime.CSV,'alias','CSV','extensions','csv','tshtag','html:span'),TP.ietf.Mime.ICAL,TP.hc('mimetype',TP.ietf.Mime.ICAL,'alias','ICAL','extensions','ics','tshtag','html:span'),TP.ietf.Mime.CSS,TP.hc('mimetype',TP.ietf.Mime.CSS,'alias','CSS','extensions','css','handler','TP.core.CSSStyleSheet','tshtag','html:style'),TP.ietf.Mime.HTML,TP.hc('mimetype',TP.ietf.Mime.HTML,'alias','HTML','extensions','htm html','tshtag','html:html'),TP.ietf.Mime.ECMASCRIPT,TP.hc('mimetype',TP.ietf.Mime.ECMASCRIPT,'alias','ECMASCRIPT','handler','TP.core.JSURI','extensions','js jscript','tshtag','tsh:script'),TP.ietf.Mime.JS,TP.hc('mimetype',TP.ietf.Mime.JS,'alias','JS','extensions','js jscript','handler','TP.core.JSURI','tshtag','tsh:script'),TP.ietf.Mime.JSON,TP.hc('mimetype',TP.ietf.Mime.JSON,'alias','JSON','extensions','json','handler','TP.core.JSONContent','tshtag','tsh:script'),TP.ietf.Mime.XHTML,TP.hc('mimetype',TP.ietf.Mime.XHTML,'alias','XHTML','extensions','xht xhtml','tshtag','html:html','tpDocNodeType','TP.core.XHTMLDocumentNode'),TP.ietf.Mime.TSH,TP.hc('mimetype',TP.ietf.Mime.TSH,'alias','TSH','extensions','tsh','handler','tsh:script','tshtag','tsh:script'),TP.ietf.Mime.GIF,TP.hc('mimetype',TP.ietf.Mime.GIF,'alias','GIF','extensions','gif','handler','html:img','tshtag','html:img'),TP.ietf.Mime.JPEG,TP.hc('mimetype',TP.ietf.Mime.JPEG,'alias','JPEG','extensions','jpg jpeg','handler','html:img','tshtag','html:img'),TP.ietf.Mime.PNG,TP.hc('mimetype',TP.ietf.Mime.PNG,'alias','PNG','extensions','png','handler','html:img','tshtag','html:img'),TP.ietf.Mime.FLASH,TP.hc('mimetype',TP.ietf.Mime.FLASH,'alias','FLASH','extensions','fla swf','objectNodeType','TP.core.FlashObjectElementNode','embedNodeType','TP.core.FlashEmbedElementNode','tshtag','html:object'),TP.ietf.Mime.SILVERLIGHT,TP.hc('mimetype',TP.ietf.Mime.SILVERLIGHT,'alias','SILVERLIGHT','extensions','xaml','objectNodeType','TP.core.SilverlightObjectElementNode','embedNodeType','TP.core.SilverlightEmbedElementNode','tshtag','html:object'),TP.ietf.Mime.SMIL,TP.hc('mimetype',TP.ietf.Mime.SMIL,'alias','SMIL','extensions','smil'),TP.ietf.Mime.SVG,TP.hc('mimetype',TP.ietf.Mime.SVG,'alias','SVG','extensions','svg'),TP.ietf.Mime.XSLT,TP.hc('mimetype',TP.ietf.Mime.XSLT,'alias','XSLT','extensions','xsl xslt','tpDocNodeType','TP.core.XSLDocumentNode'),TP.ietf.Mime.ATOM,TP.hc('mimetype',TP.ietf.Mime.ATOM,'alias','ATOM','extensions','atom xml'),TP.ietf.Mime.RDF,TP.hc('mimetype',TP.ietf.Mime.RDF,'alias','RDF','extensions','rdf'),TP.ietf.Mime.RSS,TP.hc('mimetype',TP.ietf.Mime.RSS,'alias','RSS','extensions','rss xml','handler','TPRSSContent','tpDocNodeType','TP.core.RSSFeed'),TP.ietf.Mime.SOAP,TP.hc('mimetype',TP.ietf.Mime.SOAP,'alias','SOAP'),TP.ietf.Mime.XMLRPC,TP.hc('mimetype',TP.ietf.Mime.XMLRPC,'alias','XMLRPC'),TP.ietf.Mime.XML,TP.hc('mimetype',TP.ietf.Mime.XML,'alias','XML','extensions','xml','tpDocNodeType','TP.core.XMLDocumentNode'),TP.ietf.Mime.XMPP,TP.hc('mimetype',TP.ietf.Mime.XMPP,'alias','XMPP')));this.get('info').getValues().perform(function(c){var d,a,b;d=c.at('mimetype');a=c.at('extensions');if(TP.notEmpty(a)){a=a.split(' ');for(b=0;b<a.getSize();b++){this.get('extensionInfo').atPut(a.at(b),d);}}}.bind(this));return;});TP.ietf.Mime.Type.defineMethod('getAlias',function(a){var b;if(TP.isValid(b=TP.ietf.Mime.get('info').at(a))){return TP.ifInvalid(b.at('alias'),a);}return a;});TP.ietf.Mime.Type.defineMethod('getConcreteType',function(c){var b,a;if(TP.isValid(b=TP.ietf.Mime.get('info').at(c))){a=b.at('handler');if(TP.notEmpty(a)){return TP.sys.require(a);}}return;});TP.ietf.Mime.Type.defineMethod('getExtensions',function(c){var a,b;if(TP.isValid(a=TP.ietf.Mime.get('info').at(c))){if(TP.notEmpty(b=a.at('extensions'))){return b.split(' ');}}return;});TP.ietf.Mime.Type.defineMethod('getExtensionType',function(a){return TP.ifInvalid(TP.ietf.Mime.get('extensionInfo').at(a.toLowerCase()),TP.ietf.Mime.PLAIN);});TP.ietf.Mime.Type.defineMethod('guessMIMEType',function(l,b,h){var c,d,e,g,j,a,k,i,f;TP.ifTrace(TP.$DEBUG)?TP.sys.logTransform(TP.boot.$annotate(this,'Guessing MIME type for content ID: '+b),TP.TRACE,arguments):0;if(TP.isValid(c=l)){if(TP.canInvoke(c,'getNativeNode')){d=c.getNativeNode();}else if(TP.isNode(c)){d=c;}else{d=TP.node(c,null,false);}}else{c='';}if(TP.isNode(d)&&!TP.isTextNode(d)){e=TP.nodeGetBestNode(d);if(TP.isElement(e)){g=TP.nodeGetNSURI(e);if(TP.notEmpty(g)&&TP.isValid(j=TP.w3.Xmlns.get('info').at(g))){a=j.at('mimetype');TP.ifTrace(TP.$DEBUG)?TP.sys.logTransform('Returning computed MIME type '+a+' for content ID: '+b,TP.TRACE,arguments):0;return a;}k=TP.elementGetLocalName(e);i=TP.w3.Xmlns.get('info').detect(function(a){if(a.last().at('rootElement')===k){return true;}});if(TP.isValid(i)){a=i.last().at('mimetype');TP.ifTrace(TP.$DEBUG)?TP.sys.logTransform('Returning computed MIME type '+a+' for content ID: '+b,TP.TRACE,arguments):0;return a;}}if(TP.isURI(b)&&TP.isString(f=TP.uriExtension(b.asString()))){a=TP.ietf.Mime.getExtensionType(f);}if(TP.isEmpty(a)||a===TP.ietf.Mime.PLAIN){if(/xml/.test(h)){a=h;}else{a=TP.ietf.Mime.XML;}}}else{if(TP.isJSONString(c)){a=TP.ietf.Mime.JSON;}if(TP.isEmpty(a)&&TP.isURI(b)&&TP.isString(f=TP.uriExtension(b.asString()))){a=TP.ietf.Mime.getExtensionType(f);}if(TP.isEmpty(a)||a===TP.ietf.Mime.PLAIN){a=h||TP.ietf.Mime.PLAIN;}}TP.ifTrace(TP.$DEBUG)?TP.sys.logTransform('Returning computed MIME type '+a+' for content ID: '+b,TP.TRACE,arguments):0;return a;});TP.ietf.Mime.Type.defineMethod('registerMIMEInfo',function(c,e){var a,b,d;if(TP.notValid(e)){return this.raise('TP.sig.InvalidParameter',arguments,'Must provide registration data.');}a=TP.ietf.Mime.get('info').at(c);if(TP.notValid(a)){a=e;TP.ietf.Mime.get('info').atPut(c,a);}else{TP.ietf.Mime.$KEYS.perform(function(b){var c;if(TP.isValid(c=e.at(b))){a.atPut(b,c);}});}a.atPut('mimetype',c);if(TP.notEmpty(b=a.at('extensions'))){b=b.split(' ');for(d=0;d<b.getSize();d++){TP.ietf.Mime.get('extensionInfo').atPut(b.at(d),c);}}return;});TP.lang.Object.defineSubtype('w3:Xmlns');TP.w3.Xmlns.Type.defineConstant('ACL','http://www.technicalpursuit.com/2005/acl');TP.w3.Xmlns.Type.defineConstant('ACP','http://www.technicalpursuit.com/1999/acp');TP.w3.Xmlns.Type.defineConstant('BIND','http://www.technicalpursuit.com/2005/binding');TP.w3.Xmlns.Type.defineConstant('CSSML','http://www.technicalpursuit.com/2008/cssml');TP.w3.Xmlns.Type.defineConstant('DRAG','http://www.technicalpursuit.com/2005/drag');TP.w3.Xmlns.Type.defineConstant('DND','http://www.technicalpursuit.com/2005/drag-and-drop');TP.w3.Xmlns.Type.defineConstant('PCLASS','urn:tibet:pseudoclass');TP.w3.Xmlns.Type.defineConstant('SIGNALS','http://www.technicalpursuit.com/1999/signals');TP.w3.Xmlns.Type.defineConstant('TIBET','http://www.technicalpursuit.com/1999/tibet');TP.w3.Xmlns.Type.defineConstant('TSH','http://www.technicalpursuit.com/1999/tshell');TP.w3.Xmlns.Type.defineConstant('SHERPA','http://www.technicalpursuit.com/2014/sherpa');TP.w3.Xmlns.Type.defineConstant('XCONTROLS','http://www.technicalpursuit.com/2005/xcontrols');TP.w3.Xmlns.Type.defineConstant('BPEL','http://schemas.xmlsoap.org/ws/2004/03/business-process/');TP.w3.Xmlns.Type.defineConstant('KML','http://www.opengis.net/kml/2.2');TP.w3.Xmlns.Type.defineConstant('MATHML','http://www.w3.org/1998/Math/MathML');TP.w3.Xmlns.Type.defineConstant('RDF','http://www.w3.org/1999/02/22-rdf-syntax-ns#');TP.w3.Xmlns.Type.defineConstant('RSS20','http://backend.userland.com/rss2');TP.w3.Xmlns.Type.defineConstant('SMIL','http://www.w3.org/2005/SMIL21/');TP.w3.Xmlns.Type.defineConstant('SVG','http://www.w3.org/2000/svg');TP.w3.Xmlns.Type.defineConstant('TMX','http://www.lisa.org/tmx14');TP.w3.Xmlns.Type.defineConstant('VML','urn:schemas-microsoft-com:vml');TP.w3.Xmlns.Type.defineConstant('WSDL','http://schemas.xmlsoap.org/wsdl');TP.w3.Xmlns.Type.defineConstant('XFORMS','http://www.w3.org/2002/xforms');TP.w3.Xmlns.Type.defineConstant('XHTML','http://www.w3.org/1999/xhtml');TP.w3.Xmlns.Type.defineConstant('XINCLUDE','http://www.w3.org/2001/XInclude');TP.w3.Xmlns.Type.defineConstant('XLINK','http://www.w3.org/1999/xlink');TP.w3.Xmlns.Type.defineConstant('XLINKBASE','http://www.w3.org/1999/xlink/properties/linkbase');TP.w3.Xmlns.Type.defineConstant('XML','http://www.w3.org/XML/1998/namespace');TP.w3.Xmlns.Type.defineConstant('XMLNS','http://www.w3.org/2000/xmlns/');TP.w3.Xmlns.Type.defineConstant('XML_CATALOG','urn:oasis:names:tc:entity:xmlns:xml:catalog');TP.w3.Xmlns.Type.defineConstant('XML_EVENTS','http://www.w3.org/2001/xml-events');TP.w3.Xmlns.Type.defineConstant('XML_SCHEMA','http://www.w3.org/2001/XMLSchema');TP.w3.Xmlns.Type.defineConstant('XML_SCHEMA_INSTANCE','http://www.w3.org/2001/XMLSchema-instance');TP.w3.Xmlns.Type.defineConstant('XSLT','http://www.w3.org/1999/XSL/Transform');TP.w3.Xmlns.Type.defineConstant('XUL','http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul');TP.w3.Xmlns.Type.defineConstant('$KEYS',TP.ac('uri','mimetype','handler','prefix','rootElement','defaultNodeType','transforms','native'));TP.w3.Xmlns.Type.defineConstant('PROCESS_ORDER_SORT',function(c,d){var a,b;if(TP.notValid(a=TP.w3.Xmlns.get('info').at(c))||TP.notValid(a=a.at('procPriority'))){return-1;}if(TP.notValid(b=TP.w3.Xmlns.get('info').at(d))||TP.notValid(b=b.at('procPriority'))){return 1;}return b-a;});TP.w3.Xmlns.Type.defineAttribute('customNSDetectionXPath');TP.w3.Xmlns.Type.defineAttribute('customTagDetectionXPath');TP.w3.Xmlns.Type.defineAttribute('nativePrefixes');TP.w3.Xmlns.Type.defineAttribute('nativeURIs');TP.w3.Xmlns.Type.defineAttribute('nonNativePrefixes');TP.w3.Xmlns.Type.defineAttribute('nonNativeURIs');TP.w3.Xmlns.Type.defineAttribute('XMLNSDefs');TP.w3.Xmlns.Type.defineAttribute('prefixes',TP.hc());TP.w3.Xmlns.Type.defineAttribute('info',TP.hc());TP.w3.Xmlns.Type.defineMethod('initialize',function(){var a=this.get('info');a.addAll(TP.hc(TP.w3.Xmlns.ACL,TP.hc('uri',TP.w3.Xmlns.ACL,'mimetype',TP.ietf.Mime.XML,'prefix','acl','rootElement',''),TP.w3.Xmlns.ACP,TP.hc('uri',TP.w3.Xmlns.ACP,'mimetype',TP.ietf.Mime.XML,'prefix','acp','rootElement',''),TP.w3.Xmlns.BIND,TP.hc('uri',TP.w3.Xmlns.BIND,'mimetype',TP.ietf.Mime.XML,'prefix','bind','rootElement','','defaultNodeType','bind:info','procPriority',2),TP.w3.Xmlns.CSSML,TP.hc('uri',TP.w3.Xmlns.CSSML,'mimetype',TP.ietf.Mime.XML,'prefix','css','rootElement','sheet'),TP.w3.Xmlns.DRAG,TP.hc('uri',TP.w3.Xmlns.DRAG,'mimetype',TP.ietf.Mime.XML,'prefix','drag','rootElement','','defaultNodeType','drag:info'),TP.w3.Xmlns.KML,TP.hc('uri',TP.w3.Xmlns.KML,'mimetype',TP.ietf.Mime.XML,'prefix','kml','rootElement','kml'),TP.w3.Xmlns.MATHML,TP.hc('uri',TP.w3.Xmlns.MATHML,'mimetype',TP.ietf.Mime.XML,'prefix','mml','rootElement','math'),TP.w3.Xmlns.PCLASS,TP.hc('uri',TP.w3.Xmlns.PCLASS,'prefix','pclass','rootElement',''),TP.w3.Xmlns.RDF,TP.hc('uri',TP.w3.Xmlns.RDF,'mimetype',TP.ietf.Mime.RDF,'prefix','rdf','rootElement','rdf'),TP.w3.Xmlns.RSS20,TP.hc('uri',TP.w3.Xmlns.RSS20,'mimetype',TP.ietf.Mime.RSS,'prefix','rss','rootElement','rss','defaultNodeType','TP.core.RSSElement'),TP.w3.Xmlns.SIGNALS,TP.hc('uri',TP.w3.Xmlns.SIGNALS,'mimetype',TP.ietf.Mime.XML,'prefix','sig'),TP.w3.Xmlns.SVG,TP.hc('uri',TP.w3.Xmlns.SVG,'mimetype',TP.ietf.Mime.SVG,'prefix','svg','rootElement','svg'),TP.w3.Xmlns.TIBET,TP.hc('uri',TP.w3.Xmlns.TIBET,'mimetype',TP.ietf.Mime.XML,'prefix','tibet','rootElement',''),TP.w3.Xmlns.TMX,TP.hc('uri',TP.w3.Xmlns.TMX,'mimetype',TP.ietf.Mime.XML,'prefix','tmx','rootElement','tmx'),TP.w3.Xmlns.TSH,TP.hc('uri',TP.w3.Xmlns.TSH,'mimetype',TP.ietf.Mime.TSH,'prefix','tsh','rootElement','script'),TP.w3.Xmlns.SHERPA,TP.hc('uri',TP.w3.Xmlns.SHERPA,'mimetype',TP.ietf.Mime.XML,'prefix','sherpa','rootElement',''),TP.w3.Xmlns.XCONTROLS,TP.hc('uri',TP.w3.Xmlns.XCONTROLS,'mimetype',TP.ietf.Mime.XML,'prefix','xctrls','rootElement','','procPriority',3),TP.w3.Xmlns.XFORMS,TP.hc('uri',TP.w3.Xmlns.XFORMS,'mimetype',TP.ietf.Mime.XML,'prefix','xforms','rootElement','','procPriority',4),TP.w3.Xmlns.XHTML,TP.hc('uri',TP.w3.Xmlns.XHTML,'mimetype',TP.ietf.Mime.XHTML,'prefix','html','rootElement','html','procPriority',0),TP.w3.Xmlns.XINCLUDE,TP.hc('uri',TP.w3.Xmlns.XINCLUDE,'mimetype',TP.ietf.Mime.XML,'prefix','xi','rootElement',''),TP.w3.Xmlns.XLINK,TP.hc('uri',TP.w3.Xmlns.XLINK,'mimetype',TP.ietf.Mime.XML,'prefix','xlink','rootElement',''),TP.w3.Xmlns.XML,TP.hc('uri',TP.w3.Xmlns.XML,'mimetype',TP.ietf.Mime.XML,'prefix','xml','rootElement',''),TP.w3.Xmlns.XML_CATALOG,TP.hc('uri',TP.w3.Xmlns.XML_CATALOG,'mimetype',TP.ietf.Mime.XML,'prefix','cat','rootElement','cat:catalog'),TP.w3.Xmlns.XML_EVENTS,TP.hc('uri',TP.w3.Xmlns.XML_EVENTS,'mimetype',TP.ietf.Mime.XML,'prefix','ev','rootElement','','procPriority',1),TP.w3.Xmlns.XMLNS,TP.hc('uri',TP.w3.Xmlns.XMLNS,'mimetype',TP.ietf.Mime.XML,'prefix','xmlns','rootElement',''),TP.w3.Xmlns.XML_SCHEMA,TP.hc('uri',TP.w3.Xmlns.XML_SCHEMA,'mimetype',TP.ietf.Mime.XML,'prefix','xs','rootElement','schema'),TP.w3.Xmlns.XML_SCHEMA_INSTANCE,TP.hc('uri',TP.w3.Xmlns.XML_SCHEMA_INSTANCE,'mimetype',TP.ietf.Mime.XML,'prefix','xsi','rootElement',''),TP.w3.Xmlns.XSLT,TP.hc('uri',TP.w3.Xmlns.XSLT,'mimetype',TP.ietf.Mime.XSLT,'prefix','xsl','rootElement','stylesheet'),TP.w3.Xmlns.XUL,TP.hc('uri',TP.w3.Xmlns.XUL,'mimetype',TP.ietf.Mime.XUL,'prefix','xul','rootElement',''),TP.w3.Xmlns.VML,TP.hc('uri',TP.w3.Xmlns.VML,'mimetype','','prefix','v','rootElement',''),TP.w3.Xmlns.WSDL,TP.hc('uri',TP.w3.Xmlns.WSDL,'mimetype',TP.ietf.Mime.XML,'prefix','wsdl','rootElement','')));this.get('info').getValues().perform(function(a){this.get('prefixes').atPut(a.at('prefix'),a.at('uri'));}.bind(this));return;});TP.w3.Xmlns.Type.defineMethod('addNamespaceTo',function(a,b){var c;if(TP.notValid(b)){return this.raise('TP.sig.InvalidElement',arguments);}if(TP.notValid(a)){return this.raise('TP.sig.InvalidURI',arguments);}if(TP.notValid(c=this.getCanonicalPrefix(a))){return;}TP.elementAddNamespace(b,c,a);return;});TP.w3.Xmlns.Type.defineMethod('addTransform',function(c,d){var a,b;if(TP.notValid(c)){return this.raise('TP.sig.InvalidURI',arguments);}b=TP.w3.Xmlns.get('info').at(c.asString());if(TP.isValid(b)){a=b.at('transforms');if(TP.notValid(a)){a=TP.ac();b.atPut('transforms',a);}a.add(d);}return b;});TP.w3.Xmlns.Type.defineMethod('computeCustomNSDetectionXPath',function(){var a,b;if(TP.notEmpty(b=this.$get('customNSDetectionXPath'))){return b;}a=TP.ac();TP.w3.Xmlns.getNativeURIs().perform(function(b){a.push('(namespace-uri() != "',b,'") and ');});a.push('(namespace-uri() != \'\')');a=a.join('');b=TP.join('descendant-or-self::*[',a,' and not(ancestor-or-self::*/@*[name() = "tibet:opaque"])] | ','descendant-or-self::*/@*[',a,' and not(../ancestor-or-self::*/@*[name() = "tibet:opaque"])]');this.$set('customNSDetectionXPath',b);return b;});TP.w3.Xmlns.Type.defineMethod('computeCustomTagDetectionXPath',function(){var a;if(TP.notEmpty(a=this.$get('customTagDetectionXPath'))){return a;}a=TP.ac('descendant-or-self::*[');TP.w3.Xmlns.getNativeURIs().perform(function(b){a.push('(namespace-uri() != "',b,'") and ');});a.push('(namespace-uri() != \'\')',' and not(ancestor-or-self::*/@*[name() = "tibet:opaque"])]');a=a.join('');this.$set('customTagDetectionXPath',a);return a;});TP.w3.Xmlns.Type.defineMethod('getCanonicalPrefix',function(b){var a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidURI',arguments);}a=TP.w3.Xmlns.get('info').at(b.asString());if(TP.isValid(a)){return a.at('prefix');}return;});TP.w3.Xmlns.Type.defineMethod('getRootElementName',function(b){var a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidURI',arguments);}a=TP.w3.Xmlns.get('info').at(b.asString());if(TP.isValid(a)){return TP.ifInvalid(a.at('rootElement'),'');}return'';});TP.w3.Xmlns.Type.defineMethod('getMIMEType',function(b){var a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidURI',arguments);}a=TP.w3.Xmlns.get('info').at(b.asString());if(TP.isValid(a)){return a.at('mimetype');}return;});TP.w3.Xmlns.Type.defineMethod('getNativePrefixes',function(){var a;if(TP.notEmpty(a=this.$nativePrefixes)){return a;}a=TP.w3.Xmlns.get('info').collect(function(b){var a;a=b.last();if(TP.isTrue(a.at('native'))){return a.at('prefix');}return;});a=a.select(function(a){return TP.isValid(a);});this.$nativePrefixes=a;return a;});TP.w3.Xmlns.Type.defineMethod('getNativeURIs',function(){var a;if(TP.notEmpty(a=this.$nativeURIs)){return a;}a=TP.w3.Xmlns.get('info').collect(function(b){var a;a=b.last();if(TP.isTrue(a.at('native'))){return a.at('uri');}return;});a=a.select(function(a){return TP.isValid(a);});this.$nativeURIs=a;return a;});TP.w3.Xmlns.Type.defineMethod('getNonNativePrefixes',function(){var a;if(TP.notEmpty(a=this.$nonNativePrefixes)){return a;}a=TP.w3.Xmlns.get('info').collect(function(b){var a;a=b.last();if(TP.notTrue(a.at('native'))){return a.at('prefix');}return;});a=a.select(function(a){return TP.isValid(a);});this.$nonNativePrefixes=a;return a;});TP.w3.Xmlns.Type.defineMethod('getNonNativeURIs',function(){var a;if(TP.notEmpty(a=this.$nonNativeURIs)){return a;}a=TP.w3.Xmlns.get('info').collect(function(b){var a;a=b.last();if(TP.notTrue(a.at('native'))){return a.at('uri');}return;});a=a.select(function(a){return TP.isValid(a);});this.$nonNativeURIs=a;return a;});TP.w3.Xmlns.Type.defineMethod('getNSHandler',function(d){var b,a,c;if(TP.notValid(d)){return this.raise('TP.sig.InvalidURI',arguments);}b=TP.w3.Xmlns.get('info').at(d.asString());if(TP.isValid(b)){a=b.at('handler');if(TP.notEmpty(a)){if(TP.isType(a)){return a;}if(TP.isString(a)){return TP.sys.require(a);}}else{c=b.at('prefix');if(TP.notEmpty(c)){return TP.sys.require(c+':');}}}return null;});TP.w3.Xmlns.Type.defineMethod('getPrefixURI',function(a){if(TP.isEmpty(a)){this.raise('TP.sig.InvalidParameter',arguments,'Must supply a prefix.');return;}return this.get('prefixes').at(a);});TP.w3.Xmlns.Type.defineMethod('getTransforms',function(b){var a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidURI',arguments);}a=TP.w3.Xmlns.get('info').at(b.asString());if(TP.isValid(a)){return a.at('transforms');}return;});TP.w3.Xmlns.Type.defineMethod('getURIPrefix',function(a,c){var b,d;if(!TP.isNode(c)){return this.getCanonicalPrefix(a);}b=TP.nodeGetNSPrefixes(c,a);if(TP.notEmpty(b)){d=b.at(0);}return TP.ifEmpty(d,this.getCanonicalPrefix(a));});TP.w3.Xmlns.Type.defineMethod('getXMLNSDefs',function(){var a,b;if(TP.notEmpty(a=this.$get('XMLNSDefs'))){return a;}b=TP.ac();TP.w3.Xmlns.get('prefixes').perform(function(a){if(TP.notEmpty(a.first())&&TP.notEmpty(a.last())){if(a.first().startsWith('xml')){return;}b.push(' xmlns:',a.first(),'="',a.last(),'"');}});a=b.join('');a=a.slice(1);this.set('XMLNSDefs',a);return a;});TP.w3.Xmlns.Type.defineMethod('isNative',function(b){var a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidURI',arguments);}a=TP.w3.Xmlns.get('info').at(b.asString());if(TP.isValid(a)){return TP.ifEmpty(a.at('native'),false);}return false;});TP.w3.Xmlns.Type.defineMethod('registerNSInfo',function(f,c){var b,a,d,e;if(TP.notValid(f)){return this.raise('TP.sig.InvalidURI',arguments);}if(TP.notValid(c)){return this.raise('TP.sig.InvalidParameter',arguments,'Must provide registration data.');}b=f.asString();this.$set('customNSDetectionXPath',null);this.$set('customTagDetectionXPath',null);this.$set('nativePrefixes',null);this.$set('nativeURIs',null);this.$set('nonNativePrefixes',null);this.$set('nonNativeURIs',null);this.$set('XMLNSDefs',null);a=TP.w3.Xmlns.get('info').at(b);if(TP.notValid(a)){a=c;TP.w3.Xmlns.get('info').atPut(b,a);}else{TP.w3.Xmlns.$KEYS.perform(function(b){var d;if(TP.isValid(d=c.at(b))){a.atPut(b,d);}});}a.atPut('uri',b);if(TP.isValid(d=a.at('prefix'))){TP.w3.Xmlns.get('prefixes').atPut(d,b);e=d.toUpperCase();if(TP.notValid(TP.w3.Xmlns[e])){TP.w3.Xmlns.Type.defineConstant(e,b);}}return;});TP.w3.Xmlns.Type.defineMethod('unregisterNamespace',function(a){var b;if(TP.notValid(a)){return this.raise('TP.sig.InvalidURI',arguments);}b=TP.w3.Xmlns.get('info').at(a.asString());if(TP.isValid(b)){b.removeKey(a.asString());this.$set('customNSDetectionXPath',null);this.$set('customTagDetectionXPath',null);}return;});TP.lang.Object.defineSubtype('core:XMLNamespace');TP.core.XMLNamespace.Type.defineMethod('activate',function(a,b,c){return TP.override();});TP.core.XMLNamespace.Type.defineMethod('deactivate',function(a,b,c){return TP.override();});TP.core.XMLNamespace.Type.defineMethod('getTagName',function(){return this.get('nsPrefix')+':';});TP.core.XMLNamespace.defineSubtype('html:XMLNS');TP.core.XMLNamespace.defineSubtype('xi:XMLNS');TP.core.XMLNamespace.defineSubtype('xsl:XMLNS');TP.lang.Object.defineSubtype('core:Cookie');TP.core.Cookie.Type.defineMethod('cookiesEnabled',function(){var a,b,c;a=TP.genID();b=TP.genID();this.setCookie(a,b);try{c=this.getCookie(a);}catch(a){return false;}return c===b;});TP.core.Cookie.Type.defineMethod('getCookie',function(b){var a;a=document.cookie;if(a===''){return;}return this.getCookieFromText(b,a);});TP.core.Cookie.Type.defineMethod('getCookieFromText',function(d,a){var b,c,e;b=a.indexOf(d+'=');if(b===TP.NOT_FOUND){return;}c=a.indexOf(';',b+d.getSize());if(c===TP.NOT_FOUND){c=a.getSize();}e=decodeURI(a.slice(b+d.getSize()+1,c));return e;});TP.core.Cookie.Type.defineMethod('removeCookie',function(a,b,c){return this.setCookie(a,'',TP.dc().subtractDuration('P1Y'),b,c);});TP.core.Cookie.Type.defineMethod('setCookie',function(a,b,c,d,e,g){var f;if(TP.notValid(a)||TP.notValid(b)){return false;}f=TP.join(a,'=',encodeURI(b),TP.notValid(c)?'':'; expires='+c.toGMTString(),TP.notTrue(g)?'':'; secure',TP.isEmpty(e)?'':'; domain='+e,TP.isEmpty(d)?'':'; path='+d);try{document.cookie=f;}catch(a){return false;}return true;});TP.core.Cookie.Type.defineMethod('load',function(b,c,f){var a,d,e;if(TP.notValid(b)){return this.raise('TP.sig.InvalidURI',arguments);}if(TP.notValid(c)){return this.raise('TP.sig.InvalidRequest',arguments);}a=TP.request(c);d=a.constructResponse();e=this.getCookie(b.get('cname'));a.set('result',e);return d;});TP.core.Cookie.Type.defineMethod('nuke',function(a,c){var b,d;if(TP.notValid(a)){return this.raise('TP.sig.InvalidURI',arguments);}if(TP.notValid(c)){return this.raise('TP.sig.InvalidRequest',arguments);}b=TP.request(c);d=b.constructResponse();if(!this.removeCookie(a.get('cname'),a.get('path'),a.get('domain'))){b.fail();}return d;});TP.core.Cookie.Type.defineMethod('save',function(a,d){var b,e,f,c;if(TP.notValid(a)){return this.raise('TP.sig.InvalidURI',arguments);}if(TP.notValid(d)){return this.raise('TP.sig.InvalidRequest',arguments);}b=TP.request(d);e=b.constructResponse();f=TP.str(b.at('body'));b.atPut('resultType',TP.TEXT);c=TP.ifInvalid(a.get('queryDict'),TP.hc());if(!this.setCookie(a.get('cname'),f,c.at('expires'),a.get('path'),a.get('domain'),c.at('secure'))){b.fail();}return e;});TP.core.URL.defineSubtype('CookieURL');TP.core.CookieURL.Type.defineConstant('COOKIE_REGEX',TP.rc('cookie://([^/]*)/?([^?]+)\\??(\\S*)'));TP.core.CookieURL.Type.defineConstant('SCHEME','cookie');TP.core.CookieURL.Type.defineAttribute('supportedModes',TP.core.SyncAsync.SYNCHRONOUS);TP.core.CookieURL.Type.defineAttribute('mode',TP.core.SyncAsync.SYNCHRONOUS);TP.core.CookieURL.registerForScheme('cookie');TP.core.CookieURL.Inst.defineAttribute('domain');TP.core.CookieURL.Inst.defineAttribute('path');TP.core.CookieURL.Inst.defineAttribute('cname');TP.core.CookieURL.Inst.defineAttribute('queryDict');TP.core.CookieURL.Type.defineMethod('$getDefaultHandler',function(a,b){return TP.core.Cookie;});TP.core.CookieURL.Inst.defineMethod('init',function(e){var b,a,c,d;this.callNextMethod();b=this.getType().COOKIE_REGEX.exec(e);if(TP.notValid(b)){return;}this.set('domain',b.at(1));a=b.at(2);if(a.contains('/')){this.set('path','/'+a.slice(0,a.indexOf('/')));this.set('cname',a.slice(a.indexOf('/')+1));}else{this.set('path','/');this.set('cname',a);}if(TP.notEmpty(c=b.at(3))){d=TP.lang.Hash.fromString(c);this.set('queryDict',d);if(TP.isEmpty(this.get('queryDict').at('expires'))){this.get('queryDict').atPut('expires',TP.dc(TP.dc().setFullYear(TP.dc().getFullYear()+1)));}}return this;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETBrowserTypesPre.js';
TP.lang.Object.defineSubtype('core:Browser');TP.core.Browser.Type.defineConstant('DEFAULT_MIME_TYPE',TP.ietf.Mime.HTML);TP.core.Browser.Type.defineAttribute('nativeNamespacesInstalled',false);TP.core.Browser.Type.defineAttribute('nonNativeNamespacesInstalled',false);TP.core.Browser.Type.defineMethod('asDumpString',function(){return'browser';});TP.core.Browser.Type.defineMethod('asHTMLString',function(){return'browser';});TP.core.Browser.Type.defineMethod('asPrettyString',function(){return'browser';});TP.core.Browser.Type.defineMethod('asString',function(a){return'browser';});TP.core.Browser.Type.defineMethod('asXMLString',function(){return'browser';});TP.sig.Signal.defineSubtype('DocumentSignal');TP.sig.DocumentSignal.Inst.defineMethod('getWindowName',function(){return this.getPayload();});TP.sig.DocumentSignal.defineSubtype('DocumentUnloaded');TP.sig.DocumentSignal.defineSubtype('DocumentLoaded');TP.sig.DocumentSignal.defineSubtype('DocumentVisibility');TP.sig.DocumentVisibility.defineSubtype('DocumentVisible');TP.sig.DocumentVisibility.defineSubtype('DocumentInvisible');TP.sig.Signal.defineSubtype('WindowSignal');TP.sig.WindowSignal.Inst.defineMethod('getWindowName',function(){return this.getPayload();});TP.sig.WindowSignal.defineSubtype('WindowClosed');
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETBrowserTypesBase.js';
TP.core.Browser.Type.defineMethod('installNativeNamespaces',function(){if(!this.get('nativeNamespacesInstalled')){TP.w3.Xmlns.registerNSInfo(TP.w3.Xmlns.XML,TP.hc('native',true));TP.w3.Xmlns.registerNSInfo(TP.w3.Xmlns.XHTML,TP.hc('native',true));TP.w3.Xmlns.registerNSInfo(TP.w3.Xmlns.XSLT,TP.hc('native',true));TP.w3.Xmlns.registerNSInfo(TP.w3.Xmlns.TIBET,TP.hc('native',true));TP.w3.Xmlns.registerNSInfo(TP.w3.Xmlns.SVG,TP.hc('native',true));this.set('nativeNamespacesInstalled',true);}return this;});TP.core.Browser.Type.defineMethod('installNonNativeNamespaces',function(){if(!this.get('nonNativeNamespacesInstalled')){this.set('nonNativeNamespacesInstalled',true);}return this;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETBrowserTypesPost.js';

TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETUICanvasTypesPre.js';
TP.lang.Object.defineSubtype('core:UICanvas');TP.core.UICanvas.isAbstract(true);TP.core.UICanvas.Inst.defineMethod('getCanvasID',function(){return this.getGlobalID();});TP.core.UICanvas.Inst.defineMethod('getContentDocument',function(){return this.getContentWindow().getContentDocument();});TP.core.UICanvas.Inst.defineMethod('getContentNode',function(){return this.getContentWindow().getContentDocument().getNativeNode();});TP.core.UICanvas.Inst.defineMethod('getContentWindow',function(){return TP.core.Window.construct(this.getNativeContentWindow());});TP.core.UICanvas.Inst.defineMethod('getGlobalID',function(a){return TP.gid(this.getNativeContentWindow(),a);});TP.core.UICanvas.Inst.defineMethod('getLocalID',function(a){return TP.lid(this.getNativeContentWindow(),a);});TP.core.UICanvas.Inst.defineMethod('getNativeContentDocument',function(){return TP.override();});TP.core.UICanvas.Inst.defineMethod('getNativeContentWindow',function(){return TP.nodeGetWindow(this.getNativeContentDocument());});TP.core.UICanvas.Inst.defineMethod('canResolveDNU',function(d,b,e,f){var a,c;if(TP.isEmpty(b)){return false;}a=this.getContentWindow();if(a===this){a=this.getNativeContentWindow();}if(TP.canInvoke(a,b)){return true;}if(TP.canInvoke(a,'canResolveDNU')){return a.canResolveDNU(d,b,e,f);}c=this.getContentDocument();if(TP.canInvoke(c,b)){return true;}if(TP.canInvoke(c,'canResolveDNU')){return c.canResolveDNU(d,b,e,f);}return this.callNextMethod();});TP.core.UICanvas.Inst.defineMethod('resolveDNU',function(e,c,b,f){var a,d;if(TP.notValid(a=this.getContentWindow())){return this.raise('TP.sig.InvalidCanvas',arguments);}if(a===this){if(TP.notValid(a=this.getNativeContentWindow())){return this.raise('TP.sig.InvalidCanvas',arguments);}}try{if(!TP.isCallable(d=a[c])){return a.resolveDNU(e,c,b,f);}}catch(a){}if(TP.notValid(b)||b.length===0){return a.func();}return d.apply(a,b);});TP.core.UICanvas.Inst.defineMethod('getContentMIMEType',function(){return this.getContentDocument().getContentMIMEType();});TP.core.UICanvas.Inst.defineMethod('setContent',function(a,b){this.getContentDocument().setContent(a,b);return;});TP.lang.Object.defineSubtype('core:Window');TP.core.Window.addTraitsFrom(TP.core.UICanvas);TP.core.Window.Inst.resolveTraits(TP.ac('canResolveDNU','resolveDNU'),TP.core.UICanvas);TP.definePrimitive('tpwin',function(a){var b;if(TP.notValid(a)){return TP.core.Window.construct();}else if(TP.isWindow(a)){return TP.core.Window.construct(a);}else if(TP.isElement(a)&&(a.tagName.toLowerCase()==='iframe'||a.tagName.toLowerCase()==='object')){return TP.core.Window.construct(TP.elementGetIFrameWindow(a));}else if(TP.isKindOf(a,TP.core.Window)){return a;}else if(TP.isNode(a)){if(TP.notValid(b=TP.nodeGetWindow(a))){return;}return TP.core.Window.construct(b);}else if(TP.isKindOf(a,TP.core.Node)){return a.getWindow();}return;});TP.core.Window.Type.defineAttribute('$defaultWindowSpec');TP.core.Window.Type.defineAttribute('windowRegistry',TP.hc());TP.core.Window.Type.defineAttribute('$isDocumentWriting');TP.core.Window.Type.defineAttribute('$queries',TP.hc());TP.core.Window.Type.defineAttribute('$mqEntries',TP.hc());TP.core.Window.Type.defineAttribute('$geoWatch');TP.core.Window.Type.defineMethod('addObserver',function(g,l,n,m){var d,a,k,c,h,e,b,i,j,f;d=this.get('$queries');if(TP.notValid(g)||TP.notValid(l)){return this.raise('TP.sig.InvalidParameter',arguments);}a=TP.str(g);if(!/@media |@geo/.test(a)){return this.raise('TP.sig.InvalidOrigin',arguments);}if(TP.notValid(k=d.at(a))){c=a.split(/@media |@geo/);if(c.getSize()!==2){return this.raise('TP.sig.InvalidQuery',arguments);}h=c.first();e=c.last();if(!TP.isWindow(b=TP.sys.getWindowById(h))){return this.raise('TP.sig.InvalidWindow',arguments);}if(/@geo/.test(a)){if(TP.isValid(b.navigator.geolocation)){i=b.navigator.geolocation.watchPosition(function(c){var b,d;b=c.coords;d=TP.hc('latitude',b.latitude,'longitude',b.longitude,'altitude',b.altitude,'accuracy',b.accuracy,'altitudeAccuracy',b.altitudeAccuracy,'heading',b.heading,'speed',b.speed,'timestamp',c.timestamp);TP.signal(a,'TP.sig.GeoPositionChanged',arguments,d);},function(c){var b;b='';switch(c.code){case c.PERMISSION_DENIED:b=TP.sc('This website does not have ','permission to use ','the Geolocation API');break;case c.POSITION_UNAVAILABLE:b=TP.sc('The current position could ','not be determined.');break;case c.PERMISSION_DENIED_TIMEOUT:b=TP.sc('The current position could ','not be determined ','within the specified ','timeout period.');break;}if(b===''){b=TP.sc('The position could not be ','determined due to an unknown ','error (Code: ')+c.code.toString()+').';}TP.signal(a,'TP.sig.GeoPositionError',arguments,b);});this.set('$geoWatch',i);}}else if(/@media /.test(a)){f=function(b){if(b.matches){TP.signal(a,'TP.sig.CSSMediaActive',arguments,b.media);}else{TP.signal(a,'TP.sig.CSSMediaInactive',arguments,b.media);}};j=TP.windowQueryCSSMedia(b,e,f);this.get('$mqEntries').atPut(e,TP.ac(j,f));}d.atPut(a,1);}else{d.atPut(a,k+1);}return true;});TP.core.Window.Type.defineMethod('removeObserver',function(g,i,k,l){var c,a,d,e,j,h,f,b;c=this.get('$queries');if(TP.notValid(g)||TP.notValid(i)){return this.raise('TP.sig.InvalidParameter',arguments);}a=TP.str(g);if(!/@media |@geo/.test(a)){return this.raise('TP.sig.InvalidOrigin',arguments);}if(TP.isValid(d=c.at(a))){e=a.split(/@media |@geo/);if(e.getSize()!==2){return this.raise('TP.sig.InvalidQuery',arguments);}j=e.first();if(d===1){if(/@geo/.test(a)){if(TP.isValid(h.navigator.geolocation)){h.navigator.geolocation.clearWatch(this.get('$geoWatch'));this.set('$geoWatch',null);}}else if(/@media /.test(a)){if(TP.notEmpty(f=this.get('$mqEntries'))&&TP.isValid(b=f.at(a))){if(TP.isMediaQueryList(b.first())){b.first().removeListener(b.last());}f.removeKey(a);}}c.removeKey(a);}else{c.atPut(a,d-1);}}return true;});TP.core.Window.Type.defineMethod('construct',function(a,d,e){var b,c;if(TP.notValid(a)){return TP.core.Window.open('',d,e);}if(TP.isString(a)&&TP.regex.VALID_WINDOWNAME.test(a)){b=TP.sys.getWindowById(a);}else if(!TP.isWindow(a)){if(!TP.isKindOf(a,this)){return this.raise('TP.sig.InvalidParameter',arguments);}else{return a;}}else{b=a;}c=TP.core.Window.getWindowInfo(b,'tpWindow');if(TP.isValid(c)){return c;}c=this.callNextMethod();TP.core.Window.instrument(b);TP.core.Window.registerWindow(b);TP.core.Window.setWindowInfo(b,'tpWindow',c);return c;});TP.core.Window.Type.defineMethod('closeRegisteredWindows',function(){var a,b;a=this.get('windowRegistry');b=TP.keys(a);b.perform(function(d){var b,c;c=a.at(d);b=c.at('nativeWindow');if(TP.isWindow(b)){if(b!==top&&b.parent!==top){b.close();}}});return;});TP.core.Window.Type.defineMethod('getOpenWindows',function(){var a,c,b;b=TP.ac();a=this.get('windowRegistry');c=TP.keys(a);c.perform(function(e){var c,d;d=a.at(e);c=d.at('nativeWindow');if(TP.isWindow(c)&&!c.closed){b.push(c);}});return b;});TP.core.Window.Type.defineMethod('getWindowInfo',function(d,b){var c,a;c=TP.gid(d);a=TP.core.Window.get('windowRegistry').at(c);if(TP.isValid(a)&&TP.notEmpty(b)){return a.at(b);}return a;});TP.core.Window.Type.defineMethod('getWindowSpec',function(){return this.$get('$defaultWindowSpec');});TP.core.Window.Type.defineMethod('getWindowType',function(){return this.$get('defaultWindowType').asType();});TP.core.Window.Type.defineMethod('installWindowBase',function(a){return this;});TP.core.Window.Type.defineMethod('installDocumentBase',function(a){return this;});TP.core.Window.Type.defineMethod('instrument',function(b){var a;if(TP.isWindow(b)){a=b;}else if(TP.isKindOf(b,TP.core.Window)){a=b.getNativeWindow();}else{return this.raise('TP.sig.InvalidWindow',arguments);}if(TP.notValid(a)){return this.raise('TP.sig.InvalidWindow',arguments);}if(TP.windowIsInstrumented(a)){return;}if(TP.notValid(a.opener)){a.opener=window;}a.$$tibet=window;a.TP=window.TP;a.onerror=TP.sys.onerror;TP.core.Window.installWindowBase(a);TP.core.Window.installDocumentBase(a);TP.core.Window.installWindowExtensions(a);TP.core.Window.installDocumentExtensions(a);a.$$instrumented=true;if(TP.isIFrameWindow(a)){a.name=a.frameElement.id;}TP.windowAssignCommonIds(a);TP.core.Window.registerWindow(a);return;});TP.core.Window.Type.defineMethod('open',function(f,d,g,h){var a,b,e,c;a=TP.uc(f);if(TP.notValid(a)){a=TP.uc(TP.sys.cfg('tibet.blankpage'));}a=a.getLocation();if(TP.isEmpty(d)){b=TP.getNextWindowName();}else{b=d;}if(e=TP.open('',b,g,h)){c=this.construct(e);c.setLocation(a);return c;}return null;});TP.core.Window.Type.defineMethod('registerOnloadFunction',function(e,c,f){var d,b,a;d=TP.ifInvalid(f,false);b=TP.gid(e);a=TP.core.Window.getWindowInfo(b,'loadFunctions');if(TP.notValid(a)){a=TP.ac();TP.core.Window.setWindowInfo(b,'loadFunctions',a);}if(d){a.unshift(c);}else{a.add(c);}return;});TP.core.Window.Type.defineMethod('registerWindow',function(a){var b,c,d,e;if(!TP.isWindow(a)){return this.raise('TP.sig.InvalidWindow',arguments);}b=TP.gid(a);c=TP.core.Window.getWindowInfo(b);if(TP.notEmpty(c)&&c.at('nativeWindow')===a){return this;}e=false;d=TP.core.Window.get('windowRegistry');d.perform(function(c){if(TP.notValid(c)||TP.notValid(c.last())){e=false;}else{if(c.last().at('nativeWindow')===a){d.replaceKey(c.first(),b);e=true;}}});if(e){return this;}if(TP.notEmpty(c)){c.atPut('nativeWindow',a);}else{d.atPut(b,TP.hc('nativeWindow',a));}if(TP.notValid(TP.global[b])){TP.global[b]=a;}return this;});TP.core.Window.Type.defineMethod('removeWindowInfo',function(e,c){var a,d,b;a=TP.gid(e);b=TP.core.Window.get('windowRegistry');if(TP.notValid(d=b.at(a))){return;}if(TP.isEmpty(c)){b.removeKey(a);}else{d.removeKey(c);}return;});TP.core.Window.Type.defineMethod('$setWindowContent',function(e,a,f){var c,d,b;c=TP.sys.getWindowById(e);if(TP.notValid(c)){this.raise('TP.sig.InvalidWindow',arguments,'Unable to find window: '+e);return;}if(TP.isString(a)){d=TP.uc(a);if(TP.isURI(d)){b=d.getResource(TP.hc('async',false));}else{b=a;}}else if(TP.isNode(a)){b=a;}else if(TP.isKindOf(a,TP.core.URI)){b=a.getResource(TP.hc('async',false));}else{this.raise('TP.sig.InvalidParameter',arguments);return;}TP.htmlDocumentSetContent(c.document,b,f);return;});TP.core.Window.Type.defineMethod('setWindowInfo',function(d,e,f){var b,c,a;b=TP.gid(d);c=TP.core.Window.get('windowRegistry');if(TP.notValid(a=c.at(b))){a=TP.hc();c.atPut(b,a);}a.atPut(e,f);return;});TP.core.Window.Inst.defineAttribute('$windowID');TP.core.Window.Inst.defineAttribute('contentDoc');TP.core.Window.Inst.defineAttribute('instanceData');TP.core.Window.Inst.defineMethod('init',function(b){var a;this.callNextMethod();a=TP.gid(b);this.$set('$windowID',a);this.setID(a);return this;});TP.core.Window.Inst.defineMethod('setLocation',function(a,g,d){var e,b,c,f;TP.debug('break.window_location');if(TP.notValid(a)){return this.raise('TP.sig.InvalidURI',arguments);}b=this.getNativeWindow();c=this.getNativeDocument();if(TP.isElement(TP.documentGetBody(c))){TP.elementSetAttribute(TP.documentGetBody(c),'allowUnload','true');}if(TP.isEmpty(a)){f=TP.uc(TP.sys.cfg('tibet.blankpage'));this.getNativeWindow().location=f.getLocation();return this;}if(TP.notValid(e=TP.uc(a))){return this.raise('TP.sig.InvalidURI',arguments);}if(TP.isCallable(d)){TP.core.Window.registerOnloadFunction(b,d);}TP.core.Window.registerOnloadFunction(b,function(c){var b;b=TP.nodeGetWindow(c);TP.windowSetupBackKeyHandlers(b);b.focus();TP.windowSetupFocusHandlers(b);if(TP.notFalse(g)){TP.core.History.setLocation(a);}});try{b.location=TP.uriExpandPath(e.getLocation());}catch(a){this.raise('TP.sig.InvalidWindow',arguments,'Unable to set window location.',TP.ec(a));}return this;});TP.core.Window.Inst.defineMethod('asDumpString',function(){var a;if(this.$$format_asDumpString){return TP.recursion(this);}this.$$format_asDumpString=true;try{a=TP.tname(this)+' :: '+'('+TP.dump(this.getNativeWindow())+')';}catch(b){a=this.toString();}delete this.$$format_asDumpString;return a;});TP.core.Window.Inst.defineMethod('asJSONSource',function(){var a;if(this.$$format_asJSONSource){return TP.recursion(this);}this.$$format_asJSONSource=true;try{a='{"type":'+TP.tname(this).quoted('"')+','+'"data":{'+TP.json(this.getNativeWindow())+'}}';}catch(b){a=this.toString();}delete this.$$format_asJSONSource;return a;});TP.core.Window.Inst.defineMethod('asHTMLString',function(){var a;if(this.$$format_asHTMLString){return TP.recursion(this);}this.$$format_asHTMLString=true;try{a='<span class="TP_core_Window '+TP.escapeTypeName(TP.tname(this))+'">'+TP.htmlstr(this.getNativeWindow())+'</span>';}catch(b){a=this.toString();}delete this.$$format_asHTMLString;return a;});TP.core.Window.Inst.defineMethod('asPrettyString',function(){var a;if(this.$$format_asPrettyString){return TP.recursion(this);}this.$$format_asPrettyString=true;try{a='<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+TP.pretty(this.getNativeWindow())+'</dl>';}catch(b){a=this.toString();}delete this.$$format_asPrettyString;return a;});TP.core.Window.Inst.defineMethod('asSource',function(){return TP.join('TP.core.Window.construct('+TP.src(this.getNativeWindow())+')');});TP.core.Window.Inst.defineMethod('asString',function(c){var b,a;b=TP.ifInvalid(c,true);if(!b){return TP.objectToString(this);}if(this.$$format_asString){return TP.recursion(this);}this.$$format_asString=true;try{a=TP.tname(this)+' :: '+'('+TP.str(this.getNativeWindow())+')';}catch(b){a=this.toString();}delete this.$$format_asString;return a;});TP.core.Window.Inst.defineMethod('asXMLString',function(){var a;if(this.$$format_asXMLString){return TP.recursion(this);}this.$$format_asXMLString=true;try{a='<instance type="'+TP.tname(this)+'">'+TP.xmlstr(this.getNativeWindow())+'</instance>';}catch(b){a=this.toString();}delete this.$$format_asXMLString;return a;});TP.core.Window.Inst.defineMethod('close',function(){this.getNativeWindow().close();return;});TP.core.Window.Inst.defineMethod('getCanvasID',function(){return this.$get('$windowID');});TP.core.Window.Inst.defineMethod('getContentDocument',function(){var b,a;if(TP.notValid(b=this.getNativeWindow())){return this.raise('TP.sig.InvalidWindow',arguments);}if(TP.isDocument(a=this.$get('contentDoc'))){if(a.getNativeNode()===b.document){return a;}}a=TP.core.Document.construct(b.document);this.$set('contentDoc',a,false);return a;});TP.core.Window.Inst.defineMethod('getContentWindow',function(){return this;});TP.core.Window.Inst.defineMethod('getGlobalID',function(a){return this.$get('$windowID');});TP.core.Window.Inst.defineMethod('getLocalID',function(b){var a;if(TP.notValid(a=this.getNativeWindow())){return this.raise('TP.sig.InvalidWindow',arguments);}return TP.lid(a,b);});TP.core.Window.Inst.defineMethod('getNativeContentDocument',function(){return this.getNativeDocument();});TP.core.Window.Inst.defineMethod('getNativeContentWindow',function(){return this.getNativeWindow();});TP.core.Window.Inst.defineMethod('handleDOMClose',function(a){return this.close();});TP.core.Window.Inst.defineMethod('setContent',function(e,f){var a,c,b,d;a=TP.request(f);c=a.at('loadFunc');b=this.getNativeWindow();a.atPut('loadFunc',function(a){TP.windowSetupBackKeyHandlers(b);b.focus();TP.windowSetupFocusHandlers(b);if(TP.isCallable(c)){c(a);}});d=this.getContentDocument().setContent(e,a);if(a.didFail()){if(a.at('failFunc')){a.at('failFunc')(a);}}return d;});TP.core.Window.Inst.defineMethod('attachSTDIO',function(a){var b;if(!TP.canInvoke(a,TP.ac('notify','stdin','stdout','stderr'))){return this.raise('TP.sig.InvalidProvider',arguments,'STDIO provider must implement stdin, stdout, and stderr');}b=this.getNativeWindow();b.TP.boot.$notify=function(b,c){return a.notify(b,c);};b.TP.stdin=function(b,c,d){return a.stdin(b,c,d);};b.TP.stdout=function(b,c){return a.stdout(b,c);};b.TP.stderr=function(b,c){return a.stderr(b,c);};return this;});TP.core.Window.Inst.defineMethod('back',function(){this.getNativeWindow().history.back();return;});TP.core.Window.Inst.defineMethod('blur',function(){this.getNativeWindow().blur();return;});TP.core.Window.Inst.defineMethod('constructObject',function(c,d){var a,b;b=this.getNativeWindow();a=TP.args(arguments);a.unshift(b);return TP.windowConstructObject.apply(b,a);});TP.core.Window.Inst.defineMethod('getDocument',function(){return this.getContentDocument();});TP.core.Window.Inst.defineMethod('getNativeDocument',function(){var a;if(TP.notValid(a=this.getNativeWindow())){return this.raise('TP.sig.InvalidWindow',arguments);}return a.document;});TP.core.Window.Inst.defineMethod('getNativeNode',function(){return this.getNativeDocument();});TP.core.Window.Inst.defineMethod('getNativeObject',function(){return this.getNativeWindow();});TP.core.Window.Inst.defineMethod('getNativeWindow',function(){var b,a;b=this.getGlobalID();if(TP.isWindow(a=TP.core.Window.getWindowInfo(b,'nativeWindow'))){return a;}if(TP.notValid(a=TP.sys.getWindowById(b))){return this.raise('TP.sig.InvalidWindow',arguments);}return a;});TP.core.Window.Inst.defineMethod('getProperty',function(b){var c,a;if(TP.isPrototype(this)||TP.notValid(c=this.getNativeWindow())){return this.$get(b);}try{a=c[b];}catch(a){}if(TP.notDefined(a)){a=this.$get(b);}return a;});TP.core.Window.Inst.defineMethod('getWindow',function(){return this;});TP.core.Window.Inst.defineMethod('focus',function(){this.getNativeWindow().focus();return;});TP.core.Window.Inst.defineMethod('isInstrumented',function(){return TP.windowIsInstrumented(this.getNativeWindow());});TP.core.Window.Inst.defineMethod('refresh',function(a){TP.debug('break.bind_refresh');this.getContentDocument().refresh(a);return;});TP.core.Window.Inst.defineMethod('reload',function(a){this.getNativeWindow().location.reload(a);return;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETUICanvasTypesBase.js';
TP.core.Window.Type.defineMethod('installDocumentExtensions',function(a){return this;});TP.core.Window.Type.defineMethod('installLoadUnloadHooks',function(a){var b,c,d;if(!TP.isWindow(a)){return this.raise('TP.sig.InvalidWindow',arguments);}if(TP.$$DEBUG){TP.boot.$stdout('Arming window: '+TP.gid(a)+'.',TP.TRACE);TP.boot.$stdout('Adding listeners to '+a.name+'.',TP.TRACE);}a.onerror=TP.sys.onerror;b=window;c=function(d){if(d.target!==a.document){if(TP.$$DEBUG){TP.boot.$stdout('Ignoring DOMContentLoaded from target: '+d.target+'.',TP.TRACE);}return;}if(TP.$$DEBUG){TP.boot.$stdout('DOMContentLoaded at: '+TP.str(d.target),TP.TRACE);}a.removeEventListener('DOMContentLoaded',c,false);b.TP.$$processDocumentLoaded(a);};a.addEventListener('DOMContentLoaded',c,false);d=function(c){if(c.target!==a.document){if(TP.$$DEBUG){TP.boot.$stdout('Ignoring DOMContentUnloaded from target: '+c.target+'.',TP.TRACE);}return;}if(TP.$$DEBUG){TP.boot.$stdout('DOMContentUnloaded at: '+TP.str(c.target),TP.TRACE);}a.removeEventListener('unload',d,false);b.TP.$$processDocumentUnloaded(a);},a.addEventListener('unload',d,false);return this;});TP.core.Window.Type.defineMethod('installWindowExtensions',function(a){return this;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETUICanvasTypesPost.js';

TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETStateMachineTypes.js';
TP.lang.Object.defineSubtype('core:StateObject');TP.core.StateObject.Inst.defineMethod('getNameForState',function(a){if(TP.isEmpty(a)){TP.ifWarn()?TP.warn('No state name in state object.',TP.LOG,arguments):0;}if(TP.isNumber(a)){switch(a){case TP.ACTIVE:return'Active';case TP.CANCELLED:return'Cancelled';case TP.COMPLETED:return'Completed';case TP.FAILED:return'Failed';case TP.READY:return'Ready';case TP.SUCCEEDED:return'Succeeded';default:return''+a;}}else{return a.asTitleCase();}});TP.core.StateObject.defineSubtype('StateMachine');TP.core.StateMachine.Type.defineConstant('LOG_MAX',100);TP.core.StateMachine.Inst.defineAttribute('state');TP.core.StateMachine.Inst.defineAttribute('eventSource');TP.core.StateMachine.Inst.defineAttribute('eventStream');TP.core.StateMachine.Inst.defineAttribute('stateLog');TP.core.StateMachine.Inst.defineAttribute('stateHash');TP.core.StateMachine.Inst.defineAttribute('statePrereqs');TP.core.StateMachine.Inst.defineMethod('init',function(){this.callNextMethod();this.set('stateLog',TP.ac());this.set('stateHash',TP.hc());this.set('statePrereqs',TP.hc());this.set('state',TP.READY);this.defineDefaultStates();return this;});TP.core.StateMachine.Inst.defineMethod('activate',function(a){var b;this.$get('stateLog').empty();if(TP.notEmpty(a)){if(TP.notEmpty(b=this.get('statePrereqs').at(a))){if(!b.contains(TP.READY)){this.raise('InvalidStartState',arguments,a);return;}}this.set('state',a);return;}this.set('state',TP.ACTIVE);this.activateEventStream();return;});TP.core.StateMachine.Inst.defineMethod('activateEventStream',function(){var a,b;if(TP.notEmpty(a=this.get('eventStream'))){b=TP.ifInvalid(this.get('eventSource'),TP.ANY);this.observe(b,a);}return;});TP.core.StateMachine.Inst.defineMethod('deactivate',function(c){var a,b;a=this.get('state');b=this.get('statePrereqs').at(TP.COMPLETED);if(TP.isEmpty(b)||!b.contains(a)){this.signal('TP.sig.StateTransition',arguments,TP.hc('oldState',a,'newState',TP.CANCELLED));}this.signal('TP.sig.StateTransition',arguments,TP.hc('oldState',a,'newState',TP.COMPLETED));this.deactivateEventStream();this.$set('state',TP.READY,false);return TP.COMPLETED;});TP.core.StateMachine.Inst.defineMethod('deactivateEventStream',function(){var a,b;if(TP.notEmpty(a=this.get('eventStream'))){b=TP.ifInvalid(this.get('eventSource'),TP.ANY);this.ignore(b,a);}});TP.core.StateMachine.Inst.defineMethod('defineDefaultStates',function(){return;});TP.core.StateMachine.Inst.defineMethod('defineState',function(f,c,j){var g,b,h,e,a,i,d;if(!TP.isFunction(c)){g='accept'+this.getNameForState(f);if(!TP.canInvoke(c,g)){this.raise('TP.sig.InvalidStateHandler',arguments,g+' not implemented by '+c);return;}}h=this.get('statePrereqs');b=TP.ifEmpty(j,TP.ACTIVE);h.atPut(f,b);e=this.get('stateHash');if(TP.isArray(b)){i=b.getSize();for(d=0;d<i;d++){a=e.at(b.at(d));if(TP.notValid(a)){a=TP.ac();e.atPut(b.at(d),a);}a.push(TP.ac(c,f));}}else{a=e.at(b);if(TP.notValid(a)){a=TP.ac();e.atPut(b,a);}a.push(TP.ac(c,f));}return;});TP.core.StateMachine.Inst.defineMethod('getJobState',function(){var a;a=this.get('state');switch(a){case TP.READY:case TP.ACTIVE:case TP.CANCELLED:case TP.FAILED:case TP.SUCCEEDED:case TP.COMPLETED:return a;default:return TP.ACTIVE;}});TP.core.StateMachine.Inst.defineMethod('getStateName',function(){return this.getNameForState(this.get('state'));});TP.core.StateMachine.Inst.defineMethod('handleSignal',function(a){this.updateCurrentState(a);return;});TP.core.StateMachine.Inst.defineMethod('isActive',function(){return this.get('state')!==TP.READY;});TP.core.StateMachine.Inst.defineMethod('rollbackState',function(){var a;a=TP.ifInvalid(this.get('stateLog').pop(),TP.READY);this.$set('state',a);return a;});TP.core.StateMachine.Inst.defineMethod('setState',function(b){var a;this.$set('state',b);a=this.get('stateLog');a.push(b);a.length=a.length.min(TP.core.StateMachine.LOG_MAX);return this.get('state');});TP.core.StateMachine.Inst.defineMethod('updateCurrentState',function(f){var b,a,c,d,j,h,i,g,e;b=this.get('state');a=b;c=this.get('stateHash').at(b);if(TP.isEmpty(c)){a=TP.SUCCEEDED;}else{d=0;j=c.getSize();for(h=0;h<j;h++){g=c.at(h).at(0);e=c.at(h).at(1);if(TP.isFunction(g)){if(g(f)){i=e;d++;}}else if(TP.canInvoke(g,'accept'+this.getNameForState(e))){if(g['accept'+this.getNameForState(e)](f)){i=e;d++;}}}if(d>1){a=TP.FAILED;this.raise('InvalidStateMachine',arguments,'Multiple valid states for transition from '+b);return;}else if(d===1){a=i;}}if(b!==a){this.set('state',a);this.signal('TP.sig.StateTransition',arguments,TP.hc('oldState',b,'newState',a,'trigger',f));c=this.get('stateHash').at(a);if(TP.isEmpty(c)&&a!==TP.SUCCEEDED){b=a;a=TP.SUCCEEDED;this.set('state',a);this.signal('TP.sig.StateTransition',arguments,TP.hc('oldState',b,'newState',a,'trigger',f));}if(a===TP.SUCCEEDED||a===TP.CANCELLED||a===TP.FAILED){return this.deactivate(b);}}else{this.signal('TP.sig.StateInput',arguments,TP.hc('currentState',b,'trigger',f));}return a;});TP.core.StateObject.defineSubtype('StateResponder');TP.core.StateResponder.Inst.defineAttribute('stateHandlers');TP.core.StateResponder.Inst.defineAttribute('stateMachine');TP.core.StateResponder.Inst.defineMethod('init',function(a){this.callNextMethod();if(!TP.isKindOf(a,'TP.core.StateMachine')){this.raise('TP.sig.InvalidParameter',arguments);return;}this.set('stateHandlers',TP.hc());this.set('stateMachine',a);this.defineDefaultHandlers();return this;});TP.core.StateResponder.Inst.defineMethod('activate',function(b){var a;a=this.get('stateMachine');this.observe(a,'TP.sig.StateTransition');this.observe(a,'TP.sig.StateInput');a.activate(b);return;});TP.core.StateResponder.Inst.defineMethod('deactivate',function(b){var a;a=this.get('stateMachine');a.deactivate(b);this.ignore(a,'TP.sig.StateTransition');this.ignore(a,'TP.sig.StateInput');return TP.COMPLETED;});TP.core.StateResponder.Inst.defineMethod('defineDefaultHandlers',function(){return;});TP.core.StateResponder.Inst.defineMethod('defineStateHandler',function(e,f,c,g){var d,a,b;d=this.get('stateHandlers');if(c===TP.TRANSITION){b=this.getActionName(g,c,e);}else{b=this.getActionName(e,c);}a=d.at(b);if(TP.notValid(a)){a=TP.ac();d.atPut(b,a);}a.push(f);return a.getSize();});TP.core.StateResponder.Inst.defineMethod('getActionName',function(b,c,d){var a;a=this.getNameForState(b).asStartLower();switch(c){case TP.ENTER:return a+'Enter';case TP.EXIT:return a+'Exit';case TP.INPUT:return a+'Input';case TP.TRANSITION:return a+'To'+this.getNameForState(d);default:return;}});TP.core.StateResponder.Inst.defineMethod('getActionHandlers',function(b){var a;a=this.get('stateHandlers');return a.at(b);});TP.core.StateResponder.Inst.defineMethod('getPhaseName',function(a){switch(a){case TP.ENTER:return'Enter';case TP.EXIT:return'Exit';case TP.INPUT:return'Input';default:return;}});TP.core.StateResponder.Inst.defineMethod('handleStateInput',function(b){var c,j,i,d,g,h,e,a,f;c=b.at('currentState');j=this.getNameForState(c);i=this.getActionName(c,TP.INPUT);g=b.at('trigger');if(TP.isValid(g)){d=this.getActionHandlers(this.getActionName(c,TP.INPUT));if(TP.notEmpty(d)){h=d.length;for(e=0;e<h;e++){try{a=d.at(e);if(TP.isFunction(a)){a(b);}else{f=a.getBestMethodName(arguments,g,j.asStartLower(),'',i.asStartLower());if(TP.canInvoke(a,f)){a[f](b);}}if(b.shouldStop()){return;}}catch(b){this.raise('InvalidStateHandler',arguments,TP.ec(b,TP.str(a)));}}}}else{this.invokeStateAction(this.getActionName(c,TP.INPUT),b);}return;});TP.core.StateResponder.Inst.defineMethod('handleStateTransition',function(a){var b,c;b=a.at('oldState');c=a.at('newState');this.invokeStateAction(this.getActionName(b,TP.EXIT),a);if(a.shouldPrevent()){this.get('stateMachine').rollbackState();return;}this.invokeStateAction(this.getActionName(b,TP.TRANSITION,c),a);if(a.shouldPrevent()){this.get('stateMachine').rollbackState();return;}this.invokeStateAction(this.getActionName(c,TP.ENTER),a);if(a.shouldPrevent()){this.get('stateMachine').rollbackState();return;}return;});TP.core.StateResponder.Inst.defineMethod('invokeStateAction',function(d,e){var b,f,c,a;b=this.getActionHandlers(d);if(TP.notEmpty(b)){f=b.getSize();for(c=0;c<f;c++){a=b.at(c);try{if(TP.isFunction(a)){a(e);}else if(TP.canInvoke(a,d)){a[d](e);}if(e.shouldStop()){return;}}catch(b){this.raise('InvalidStateHandler',arguments,TP.ec(b,TP.str(a)));}}}return;});TP.core.StateResponder.Inst.defineMethod('isActive',function(){return this.get('stateMachine').isActive();});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETWorkflowTypes.js';
TP.lang.Object.defineSubtype('core:Resource');TP.core.Resource.addTraitsFrom(TP.core.SyncAsync);TP.core.Resource.executeTraitResolution();TP.core.Resource.Type.defineAttribute('instances',TP.hc());TP.core.Resource.Type.defineAttribute('triggerOrigins');TP.core.Resource.Type.defineAttribute('triggerSignals');TP.core.Resource.Type.defineMethod('addResource',function(a){if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(this.getResourceById(a.get('resourceID'))){return this.raise('TP.sig.NonUniqueID',arguments);}return this.get('instances').atPut(a.get('resourceID'),a);});TP.core.Resource.Type.defineMethod('construct',function(b){var a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidResourceID',arguments);}if(TP.isValid(a=TP.core.Resource.getResourceById(b))){return a;}a=this.callNextMethod();if(TP.isValid(a)){this.get('instances').atPut(b,a);}return a;});TP.core.Resource.Type.defineMethod('getResourceById',function(a){return this.get('instances').at(a);});TP.core.Resource.Inst.defineAttribute('registered',false);TP.core.Resource.Inst.defineAttribute('requests');TP.core.Resource.Inst.defineAttribute('triggerOrigins');TP.core.Resource.Inst.defineAttribute('triggerSignals');TP.core.Resource.Inst.defineAttribute('vCard');TP.core.Resource.Type.defineAttribute('defaultedParameters');TP.core.Resource.Inst.defineMethod('init',function(a){this.callNextMethod();this.setID(a);this.$set('requests',TP.hc());return this;});TP.core.Resource.Inst.defineMethod('acceptRequest',function(a){this.addRequest(a);a.set('responder',this);a.isActive(true);return this;});TP.core.Resource.Inst.defineMethod('addRequest',function(a){this.get('requests').atPut(a.getRequestID(),a);return this;});TP.core.Resource.Inst.defineMethod('getAccessKeys',function(){var a,b;if(TP.isValid(b=this.getVCard())){a=b.getAccessKeys();}else{a=TP.ac();}return a;});TP.core.Resource.Inst.defineMethod('getPrimaryRole',function(){var a;if(TP.isValid(a=this.getVCard())){return a.getRoles().first();}return;});TP.core.Resource.Inst.defineMethod('getPrimaryUnit',function(){var a;if(TP.isValid(a=this.getVCard())){return a.getRoles().last();}return;});TP.core.Resource.Inst.defineMethod('getResourceID',function(){return this.getID();});TP.core.Resource.Inst.defineMethod('getTriggerOrigins',function(){var a;if(TP.notValid(a=this.$get('triggerOrigins'))){return this.getType().get('triggerOrigins');}return a;});TP.core.Resource.Inst.defineMethod('getTriggerSignals',function(){var a;if(TP.notValid(a=this.$get('triggerSignals'))){return this.getType().get('triggerSignals');}return a;});TP.core.Resource.Inst.defineMethod('getVCard',function(){return this.$get('vCard');});TP.core.Resource.Inst.defineMethod('handle',function(c){var a,b;if(!TP.isKindOf(c,'TP.sig.Request')){return this.callNextMethod();}a=c;if(a.isActive()||a.isCompleted()){return;}if(!this.isAvailable(a)){return;}b=this.getHandler(a,true);if(TP.isCallable(b)){try{this.acceptRequest(a);return b.apply(this,arguments);}catch(a){TP.ifError()?TP.error(TP.ec(a,'Error in handler: '+TP.str(b)),TP.LOG,arguments):0;return;}}return;});TP.core.Resource.Inst.defineMethod('handleRequest',function(a){return TP.override();});TP.core.Resource.Inst.defineMethod('hasAccessKey',function(a){return this.getAccessKeys().contains(a);});TP.core.Resource.Inst.defineMethod('isAvailable',function(a){var b;b=a.isSynchronous(this);if(b&&this.getType().isAsyncOnly()){return false;}if(!b&&this.getType().isSyncOnly()){return false;}return this.isTargeted(a)&&this.isEnabled(a);});TP.core.Resource.Inst.defineMethod('isEnabled',function(a){return true;});TP.core.Resource.Inst.defineMethod('isRegistered',function(a){if(TP.isBoolean(a)){this.$set('registered',a);}return this.$get('registered');});TP.core.Resource.Inst.defineMethod('isTargeted',function(b){var a;if(TP.isValid(a=b.get('resourceID'))){if(this.get('resourceID')!==a){return false;}}return true;});TP.core.Resource.Inst.defineMethod('populateMissingVCardData',function(g,d){var e,h,b,a,f,c;if(TP.notValid(e=this.get('vCard'))&&TP.notValid(g)){return this;}h=TP.ifInvalid(this.getType().get('defaultedParameters'),TP.hc());b=TP.sys.getEffectiveUser();f=this.getID();c=false;g.perform(function(k){var j,i,l,m,g;j=k.first();if(TP.notValid(d.at(j))){if(TP.notEmpty(g=h.at(j))){d.atPut(j,g);return;}i=k.last().at(0);l=k.last().at(1);m=k.last().at(2);if(TP.isValid(e)&&TP.notEmpty(g=e.get(i))){if(g==='{USER}'){a=b.getCredentialsFor(f);if(TP.isEmpty(g=a.at(i))){if(TP.isEmpty(g=TP.prompt(l))){g=TP.isFalse(m)?TP.NULL:null;}a.atPut(i,g);c=true;}}else if(g==='{PROMPT}'){g=TP.prompt(l);}}else{a=b.getCredentialsFor(f);if(TP.isEmpty(g=a.at(i))){if(TP.isEmpty(g=TP.prompt(l))){g=TP.isFalse(m)?TP.NULL:null;}a.atPut(i,g);c=true;}}}if(TP.isValid(g)){d.atPut(j,g);}});if(c){b.saveCredentials();}return this;});TP.core.Resource.Inst.defineMethod('register',function(){var c,a,d,b;TP.sys.registerObject(this);c=this.get('triggerOrigins')||TP.ANY;a=this.get('triggerSignals')||'TP.sig.Request';if(TP.isArray(c)){for(d=0;d<c.getSize();d++){if(TP.isArray(a)){for(b=0;b<a.getSize();b++){this.observe(c.at(d),a.at(b));}}else{this.observe(c.at(d),a);}}}else{if(TP.isArray(a)){for(b=0;b<a.getSize();b++){this.observe(c,a.at(b));}}else{this.observe(c,a);}}this.isRegistered(true);return this;});TP.core.Resource.Inst.defineMethod('removeRequest',function(a){if(!TP.canInvoke(a,'getRequestID')){return this.raise('TP.sig.InvalidRequest',arguments);}this.get('requests').removeKey(a.getRequestID());return this;});TP.core.Resource.Inst.defineMethod('setVCard',function(a){this.$set('vCard',a);TP.sys.setcfg('tibet.uriprofile',null);return this;});TP.core.Resource.Inst.defineMethod('unregister',function(){var c,a,d,b;TP.sys.unregisterObject(this);c=this.get('triggerOrigins')||TP.ANY;a=this.get('triggerSignals')||'TP.sig.Request';if(TP.isArray(c)){for(d=0;d<c.getSize();d++){if(TP.isArray(a)){for(b=0;b<a.getSize();b++){this.ignore(c.at(d),a.at(b));}}else{this.ignore(c.at(d),a);}}}else{if(TP.isArray(a)){for(b=0;b<a.getSize();b++){this.ignore(c,a.at(b));}}else{this.ignore(c,a);}}this.isRegistered(false);return this;});TP.sig.Signal.defineSubtype('WorkflowSignal');TP.sig.WorkflowSignal.addTraitsFrom(TP.core.JobStatus);TP.sig.WorkflowSignal.Type.resolveTrait('getSignalName',TP.sig.WorkflowSignal);TP.sig.WorkflowSignal.Inst.resolveTraits(TP.ac('resume','asSource','asDumpString','asHTMLString','asJSONSource','asPrettyString','asXMLString','asString','at','atPut','getSignalName','getProperty','copy','shouldLog','init','isRecyclable','recycle'),TP.sig.WorkflowSignal);TP.sig.WorkflowSignal.executeTraitResolution();TP.sig.WorkflowSignal.Type.defineAttribute('defaultPolicy',TP.INHERITANCE_FIRING);TP.sig.WorkflowSignal.Inst.defineMethod('fire',function(c,d,e){var a,b;this.stopPropagation(false);this.preventDefault(false);a=TP.ifInvalid(c,this.getRequestID());this.setOrigin(a);b=TP.ifInvalid(e,this.getType().getDefaultPolicy());this.$set('time',Date.now());TP.signal(a,this,arguments,d,b);return this;});TP.sig.WorkflowSignal.defineSubtype('Request');TP.sig.Request.Type.defineAttribute('responseType','TP.sig.Response');TP.sig.Request.Type.defineAttribute('requestTemplate');TP.definePrimitive('request',function(a){switch(arguments.length){case 0:return TP.sig.Request.construct();case 1:if(TP.isKindOf(a,'TP.sig.Request')){return a;}else if(TP.canInvoke(a,'getPayload')){return TP.sig.Request.construct(a.getPayload());}else{return TP.sig.Request.construct(a);}break;default:return TP.sig.Request.construct(TP.hc.apply(null,arguments));}});TP.sig.Request.Type.defineMethod('isSynchronous',function(){return true;});TP.sig.Request.Type.defineMethod('shouldLog',function(){return TP.sys.shouldLogRequestSignals();});TP.sig.Request.Inst.defineAttribute('resourceID');TP.sig.Request.Inst.defineAttribute('requestor');TP.sig.Request.Inst.defineAttribute('responder');TP.sig.Request.Inst.defineAttribute('response');TP.sig.Request.Inst.defineAttribute('responseName');TP.sig.Request.Inst.defineAttribute('statusCode',TP.READY);TP.sig.Request.Inst.defineAttribute('faultCode',null);TP.sig.Request.Inst.defineAttribute('faultText');TP.sig.Request.Inst.defineAttribute('threadID');TP.sig.Request.Inst.defineAttribute('childJoins');TP.sig.Request.Inst.defineAttribute('parentJoins');TP.sig.Request.Inst.defineAttribute('peerJoins');TP.delegate(TP.ac('getResult','getResultNode','getResultObject','getResultText'),TP.sig.Request.getInstPrototype(),true);TP.sig.Request.Inst.defineMethod('init',function(b,c,d){var a;this.$set('resourceID',c);this.$set('threadID',d);a=this.$initTemplate(b);return this.callNextMethod(a);});TP.sig.Request.Inst.defineMethod('$initTemplate',function(d){var e,a,f,g,b,c;e=this.getType().get('requestTemplate');if(TP.notValid(d)){if(TP.isValid(e)){a=e.copy();}else{a=TP.hc();}}else if(TP.isKindOf(d,TP.sig.Request)){a=TP.copy(d.getPayload());}else if(TP.isKindOf(d,TP.lang.Hash)){a=d;}else{a=TP.hc(d);}if(TP.isValid(e)){f=TP.keys(e);g=f.getSize();for(b=0;b<g;b++){c=f.at(b);if(TP.notDefined(a.at(c))){a.atPut(c,e.at(c));}}}if(TP.canInvoke(a,TP.ac('at','getKeys'))){f=TP.keys(a);g=f.getSize();for(b=0;b<g;b++){c=f.at(b);if(TP.regex.HANDLER_NAME.test(c)){this.defineMethod(c,a.at(c));}}}return a;});TP.sig.Request.Inst.defineMethod('asQueryString',function(){var a;a=this.at('uriparams');return TP.isValid(a)?a.asQueryString():'';});TP.sig.Request.Inst.defineMethod('configureSTDIO',function(a){var b;if(TP.isValid(a)){if(TP.isValid(b=a.at(TP.STDIO))){this.atPut(TP.STDIO,b);}if(TP.isValid(b=a.at(TP.STDIN))){this.atPut(TP.STDIN,b);}this.stdin=a.stdin?a.stdin:this.stdin;if(TP.isValid(b=a.at(TP.STDOUT))){this.atPut(TP.STDOUT,b);}this.stdout=a.stdout?a.stdout:this.stdout;if(TP.isValid(b=a.at(TP.STDERR))){this.atPut(TP.STDERR,b);}this.stderr=a.stderr?a.stderr:this.stderr;}return this;});TP.sig.Request.Inst.defineMethod('constructResponse',function(b){var a,c;if(TP.isValid(a=this.getResponse())){if(TP.isDefined(b)){a.set('result',b);}return a;}a=this.getResponseType().construct(this,b);this.$set('response',a,false);c=this.getResponseName();if(c!==a.getTypeName()){a.setSignalName(c);}return a;});TP.sig.Request.Inst.defineMethod('fire',function(a,b,c){this.$set('response',null);this.set('statusCode',TP.READY);this.set('faultCode',null);this.set('faultText',null);this.callNextMethod();return this.constructResponse();});TP.sig.Request.Inst.defineMethod('getDelegate',function(){return this.getResponse();});TP.sig.Request.Inst.defineMethod('getPromise',function(){return this.constructResponse();});TP.sig.Request.Inst.defineMethod('getRequestID',function(){return this.getID();});TP.sig.Request.Inst.defineMethod('getRequestor',function(){var a;a=this.$get('requestor');return TP.isValid(a)?a:this;});TP.sig.Request.Inst.defineMethod('getResponder',function(){return this.$get('responder');});TP.sig.Request.Inst.defineMethod('getResponse',function(){return this.$get('response');});TP.sig.Request.Inst.defineMethod('getResponseName',function(){var a;a=this.$get('responseName');return TP.ifEmpty(a,this.getResponseType().getName());});TP.sig.Request.Inst.defineMethod('getResponseType',function(){var a,b;a=this.$get('responseType')||this.getType().get('responseType');b=TP.sys.require(a);if(TP.notValid(b)){TP.ifWarn()?TP.warn('Unable to locate response type: '+a+'. Defaulting to TP.sig.Response.',TP.LOG,arguments):0;return TP.sig.Response;}return b;});TP.sig.Request.Inst.defineMethod('handle',function(b){var c,a;if(!TP.isKindOf(b,'TP.sig.Response')){return this.callNextMethod();}c=b.getRequest();if(TP.notValid(c)||c!==this){return;}a=this.getHandler(b,true);if(TP.isCallable(a)){try{return a.apply(this,arguments);}catch(b){TP.ifError()?TP.error(TP.ec(b,'Error in handler: '+TP.str(a)),TP.LOG,arguments):0;return;}}return;});TP.sig.Request.Inst.defineMethod('handleResponse',function(a){return this;});TP.sig.Request.Inst.defineMethod('isSynchronous',function(a){var b;if(TP.isValid(b=this.at('async'))){return!TP.bc(b);}if(TP.canInvoke(a,'isSynchronous')){return a.isSynchronous();}return this.getType().isSynchronous();});TP.sig.Request.Inst.defineMethod('recycle',function(){this.callNextMethod();this.reset();this.$set('response',null);return this;});TP.sig.Request.Inst.defineMethod('setRequest',function(a){this.setPayload(a);return this;});TP.sig.Request.Inst.defineMethod('setRequestID',function(a){this.setID(a);return this;});TP.sig.Request.Inst.defineMethod('setRequestor',function(a){return this.$set('requestor',a);});TP.sig.Request.Inst.defineMethod('setResponder',function(a){this.$set('responder',a,false);return this;});TP.sig.Request.Inst.defineMethod('setResponse',function(a){if(!TP.isKindOf(a,'TP.sig.Response')){return this.raise('TP.sig.InvalidParameter',arguments,'Must supply an instance of TP.sig.Response '+'or a suitable subtype.');}this.$set('response',a);return this;});TP.sig.Request.Inst.defineMethod('setResponseName',function(a){this.$set('responseName',a,false);return this;});TP.sig.Request.Inst.defineMethod('setResponseType',function(a){this.$set('responseType',a,false);return this;});TP.sig.Request.Inst.defineMethod('setResult',function(a){var b;b=this.constructResponse(a);return this;});TP.sig.Request.Inst.defineMethod('updateRequestMode',function(b){var a;if(TP.isTrue(this.at('async'))){return this;}if(TP.notTrue(a=b.at('async'))){return this;}this.atPut('async',a);return this;});TP.sig.Request.Inst.defineMethod('andJoin',function(b,d){var c,a;a=TP.ifInvalid(d,TP.SUCCEEDED);c=this.getJoins(TP.AND);c.push(TP.ac(b,a));b.$wrapupJoin(this,a);return this;});TP.sig.Request.Inst.defineMethod('andJoinChild',function(a){var b;b=this.getChildJoins(TP.AND);b.push(a);a.$wrapupJoin(this,TP.COMPLETED,true);return this;});TP.sig.Request.Inst.defineMethod('$cancelJoin',function(a,b,c){if(this.didCancel()||this.didFail()){return;}this.$set('faultCode',a.getFaultCode(),false);this.$set('faultText',a.getFaultText(),false);switch(arguments.length){case 2:return this.cancel(b);case 3:return this.cancel(b,c);default:return this.cancel();}});TP.sig.Request.Inst.defineMethod('canComplete',function(){var a,b;if(this.didComplete()){return true;}a=this.$get('childJoins');if(TP.isEmpty(a)){return true;}b=a.at(TP.OR);if(TP.notEmpty(b)){return false;}b=a.at(TP.AND);if(TP.notEmpty(b)){return false;}return true;});TP.sig.Request.Inst.defineMethod('$completeJoin',function(a,b){if(this.didCancel()||this.didFail()){return;}this.set('result',a.getResult());if(arguments.length>1){return this.complete(b);}return this.complete();});TP.sig.Request.Inst.defineMethod('$failJoin',function(a,b,c){if(this.didCancel()||this.didFail()){return;}this.$set('faultCode',a.getFaultCode(),false);this.$set('faultText',a.getFaultText(),false);switch(arguments.length){case 2:return this.fail(b);case 3:return this.fail(b,c);default:return this.fail();}});TP.sig.Request.Inst.defineMethod('getChildJoins',function(c){var a,b;a=this.$get('childJoins');if(TP.notValid(a)){a=TP.hc();this.$set('childJoins',a);}if(TP.notEmpty(c)){b=a.at(c);if(TP.notValid(b)){b=TP.ac();a.atPut(c,b);}return b;}return a;});TP.sig.Request.Inst.defineMethod('getJoins',function(c,d){var a,b;a=this.$get('peerJoins');if(TP.notValid(a)){a=TP.hc();this.$set('peerJoins',a);}if(TP.isValid(c)){b=a.at(c);if(TP.notValid(b)){b=TP.ac();a.atPut(c,b);}return b;}return a;});TP.sig.Request.Inst.defineMethod('getParentJoins',function(c){var a,b;a=this.$get('parentJoins');if(TP.notValid(a)){a=TP.hc();this.$set('parentJoins',a);}if(TP.notEmpty(c)){b=a.at(c);if(TP.notValid(b)){b=TP.ac();a.atPut(c,b);}return b;}return a;});TP.sig.Request.Inst.defineMethod('hasJoined',function(f,d){var c,e,b,a;c=TP.isTrue(d)?this.getChildJoins(TP.OR):this.getJoins(TP.OR);e=c.length;for(b=0;b<e;b++){a=c.at(b);if(d){return a.didComplete();}else{if(Math.abs(a.first().get('statusCode'))===Math.abs(a.last())){return true;}}}c=TP.isTrue(d)?this.getChildJoins(TP.AND):this.getJoins(TP.AND);e=c.length;for(b=0;b<e;b++){a=c.at(b);if(d){if(a.didFail()||a.didCancel()){return false;}}else{if(Math.abs(a.first().get('statusCode'))===Math.abs(a.last())){return false;}}}return true;});TP.sig.Request.Inst.defineMethod('joinTo',function(a,b,c){if(c===TP.AND){a.andJoin(this,b);}else{a.orJoin(this,b);}return a;});TP.sig.Request.Inst.defineMethod('orJoin',function(b,d){var c,a;a=TP.ifInvalid(d,TP.SUCCEEDED);c=this.getJoins(TP.OR);c.push(TP.ac(b,a));b.$wrapupJoin(this,a);return this;});TP.sig.Request.Inst.defineMethod('orJoinChild',function(a){var b;b=this.getChildJoins(TP.OR);b.push(a);a.$wrapupJoin(this,TP.COMPLETED,true);return this;});TP.sig.Request.Inst.defineMethod('$wrapupJoin',function(c,d,e){var a,b;a=TP.ifInvalid(d,TP.SUCCEEDED);b=TP.isTrue(e)?this.getParentJoins(a):this.getJoins(a);b.push(c);return this;});TP.sig.Request.Inst.defineMethod('cancelJob',function(b,d){var c,e,a;c=this.getChildJoins(TP.AND).addAll(this.getChildJoins(TP.OR)).unique();e=c.getSize();for(a=0;a<e;a++){c.at(a).cancel(b,d);}switch(arguments.length){case 1:return this.$wrapupJob('Cancelled',TP.CANCELLED,b);case 2:return this.$wrapupJob('Cancelled',TP.CANCELLED,b,d);default:return this.$wrapupJob('Cancelled',TP.CANCELLED);}});TP.sig.Request.Inst.defineMethod('completeJob',function(a){this.constructResponse(a);if(arguments.length>0){return this.$wrapupJob('Succeeded',TP.SUCCEEDED,a);}return this.$wrapupJob('Succeeded',TP.SUCCEEDED);});TP.sig.Request.Inst.defineMethod('failJob',function(b,d){var c,e,a;c=this.getChildJoins(TP.AND).addAll(this.getChildJoins(TP.OR)).unique();e=c.getSize();for(a=0;a<e;a++){c.at(a).cancel(b,d);}switch(arguments.length){case 1:return this.$wrapupJob('Failed',TP.FAILED,b);case 2:return this.$wrapupJob('Failed',TP.FAILED,b,d);default:return this.$wrapupJob('Failed',TP.FAILED);}});TP.sig.Request.Inst.defineMethod('$wrapupJob',function(z,v,h,x){var y,t,a,k,f,e,u,r,g,q,b,m,i,w,l,s,n,o,d,c,p,j;TP.debug('break.request_wrapup');if(TP.isValid(y=this.at('cmdStart'))){t=Date.now();this.atPut('cmdEnd',t);}a=this.constructResponse();k=this;f=this.get('responder');e=this.get('requestor');f=f===k?null:f;e=e===k?null:e;e=e===f?null:e;u=this.getRequestID();g=this.getTypeSignalNames().copy();g=g.slice(0,g.getPosition('TP.sig.Request')+1);i=g.getSize();r=TP.ac(z,'Completed');w=r.getSize();j=arguments.length;for(b=0;b<i;b++){q=g.at(b);for(m=0;m<w;m++){l=r.at(m);if(!TP.isType(s=TP.sys.getTypeByName(q))){continue;}n=s.getHandlerName(null,false)+l;o=s.getHandlerName(null,true)+l;a.setSignalName(q+l);TP.handle(k,a,n,true);TP.handle(k,a,o,true);if(a.shouldPrevent()||a.shouldStop()){break;}TP.handle(f,a,n,true);TP.handle(f,a,o,true);if(a.shouldPrevent()||a.shouldStop()){break;}TP.handle(e,a,n,true);TP.handle(e,a,o,true);if(a.shouldPrevent()||a.shouldStop()){break;}TP.signal(u,a,arguments,null,TP.FIRE_ONE);}}d=this.getJoins(TP.ifInvalid(v,this.get('statusCode')),this);if(TP.notEmpty(d)){i=d.getSize();for(b=0;b<i;b++){p=d.at(b);if(p.hasJoined(this)){if(j>2){p.atPut(TP.STDIN,TP.ac(h));}d.at(b).fire();}}}d=this.getParentJoins(TP.ifInvalid(v,this.get('statusCode'))).addAll(this.getParentJoins(TP.COMPLETED)).unique();if(TP.notEmpty(d)){i=d.getSize();for(b=0;b<i;b++){c=d.at(b);if(this.isFailing()||this.didFail()){switch(j){case 3:c.$failJoin(this,h);break;case 4:c.$failJoin(this,h,x);break;default:c.$failJoin(this);break;}}else if(this.isCancelling()||this.didCancel()){switch(j){case 3:c.$cancelJoin(this,h);break;case 4:c.$cancelJoin(this,h,x);break;default:c.$cancelJoin(this);break;}}else if(c.hasJoined(this,true)){if(j>2){c.$completeJoin(this,h);}else{c.$completeJoin(this);}}}}return this;});TP.sig.WorkflowSignal.defineSubtype('Response');TP.sig.Response.Inst.defineAttribute('request');TP.sig.Response.Inst.defineAttribute('result');TP.delegate(TP.ac('failJob','cancelJob','completeJob','getFaultCode','getFaultText','getStatusCode','getStatusText','getRequestID'),TP.sig.Response.getInstPrototype(),true);TP.sig.Response.Inst.defineMethod('init',function(b,a){this.callNextMethod(null);this.$set('request',TP.request(b),false);if(TP.isDefined(a)){this.$set('result',a,false);}return this;});TP.sig.Response.Inst.defineMethod('fire',function(f,b,g){var c,d,a,e;if(TP.isValid(b)){this.setPayload(b);}c=TP.ifInvalid(f,this.getRequestID());this.setOrigin(c);d=this.getRequest();TP.handle(d,this);if(this.shouldPrevent()||this.shouldStop()){return this;}a=g;if(TP.notValid(a)){e=this.getSignalName();if(e!==this.getTypeName()){a=TP.FIRE_ONE;}else{a=this.getType().getDefaultPolicy();}}this.$set('time',Date.now());TP.signal(c,this,arguments,b,a);return this;});TP.sig.Response.Inst.defineMethod('getDelegate',function(){return this.getRequest();});TP.sig.Response.Inst.defineMethod('getPayload',function(){var a;if(TP.notValid(a=this.callNextMethod())){return this.getRequest().getPayload();}return a;});TP.sig.Response.Inst.defineMethod('getRequest',function(){return this.$get('request');});TP.sig.Response.Inst.defineMethod('getResult',function(){return this.$get('result');});TP.sig.Response.Inst.defineMethod('getResultNode',function(){return TP.tpnode(this.getResult());});TP.sig.Response.Inst.defineMethod('getResultObject',function(){return this.getResult();});TP.sig.Response.Inst.defineMethod('getResultText',function(){return TP.str(this.getResult());});TP.sig.Response.Inst.defineMethod('setRequest',function(a){this.$set('request',a,false);return this;});TP.sig.Response.Inst.defineMethod('setResult',function(a){this.$set('result',a,false);return this;});TP.sig.Response.Inst.defineMethod('then',function(c,d){var b,a;b=this.getRequest();a=TP.request();b.defineMethod('handleRequestSucceeded',function(d){var b,e;if(TP.isCallable(c)){(function(){try{b=c(d.getResult());if(TP.isKindOf(b,TP.sig.Response)){e=b.getRequest();a.andJoinChild(e);}else{a.complete(b);}}catch(b){a.fail(TP.FAILURE,TP.sc('Promise failure: ')+TP.str(b));}}.afterUnwind());}else{a.complete(d.getResult());}});b.defineMethod('handleRequestFailed',function(b){var c,e;if(TP.isCallable(d)){(function(){try{c=d(TP.hc('faultCode',b.getFaultCode(),'faultText',b.getFaultText()));if(TP.isKindOf(c,TP.sig.Response)){e=c.getRequest();a.andJoinChild(e);}else if(TP.isDefined(c)){a.complete(c);}else{a.fail(b.getFaultCode(),b.getFaultText());}}catch(b){a.fail(TP.FAILURE,TP.sc('Promise failure: ')+TP.str(b));}}.afterUnwind());}else{a.fail(b.getFaultCode(),b.getFaultText());}});return a.getPromise();});TP.lang.Object.defineSubtype('core:PermissionGroup');TP.core.PermissionGroup.Type.defineAttribute('keyrings');TP.core.PermissionGroup.Type.defineMethod('addKeyRing',function(c){var b,a;b=TP.tibet.keyring.getInstanceById(c);if(TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments,'Key ring: \''+c+'\' not found.');}a=this.$get('keyrings');if(TP.notValid(a)){a=TP.ac();this.Type.set('keyrings',a);}a.add(b);return this;});TP.core.PermissionGroup.Type.defineMethod('getAccessKeys',function(){var a,b;a=TP.ac();b=this.get('keyrings');if(TP.notValid(b)){return TP.ac();}a=b.injectInto(a,function(b,a){a.push.apply(a,b.getAccessKeys());return a;});return a;});TP.core.PermissionGroup.defineSubtype('Role');TP.core.Role.Type.defineMethod('initialize',function(){this.addKeyRing('Guest');return;});TP.core.Role.defineSubtype('Public:Guest');TP.core.PermissionGroup.defineSubtype('Unit');TP.core.Unit.Type.defineMethod('initialize',function(){this.addKeyRing('Public');return;});TP.core.Unit.defineSubtype('Public:Public');TP.sig.Request.defineSubtype('UserRequest');TP.core.Resource.defineSubtype('User');TP.core.User.set('mode',TP.core.SyncAsync.DUAL_MODE);TP.core.User.Type.defineAttribute('triggerSignals','TP.sig.UserRequest');TP.core.User.Type.defineAttribute('effectiveUser');TP.core.User.Type.defineAttribute('realUser');TP.core.User.Type.defineMethod('construct',function(b){var a;a=this.callNextMethod();if(TP.notValid(this.$get('realUser'))){this.setRealUser(a);}return a;});TP.core.User.Type.defineMethod('$distributeEffectiveAccessKeys',function(){var a;a=TP.core.Window.getOpenWindows();a.perform(function(a){TP.windowAssignACLKeys(a,TP.ACL_EFFECTIVE);});return;});TP.core.User.Type.defineMethod('$distributeRealAccessKeys',function(){var a;a=TP.core.Window.getOpenWindows();a.perform(function(a){TP.windowAssignACLKeys(a,TP.ACL_REAL);});return;});TP.core.User.Type.defineMethod('getEffectiveAccessKeys',function(){var a,b;b=this.getEffectiveUser();if(TP.isValid(b)){a=b.getAccessKeys();}else{a=TP.ac();}return a;});TP.core.User.Type.defineMethod('getEffectiveUser',function(){var a;a=this.$get('effectiveUser');if(TP.notValid(a)){return this.getRealUser();}return a;});TP.core.User.Type.defineMethod('getInstanceById',function(b){var a;if(TP.isValid(a=this.getResourceById(b))){if(TP.isKindOf(a,this)){return a;}}return a;});TP.core.User.Type.defineMethod('getRealAccessKeys',function(){var a,b;b=this.getRealUser();if(TP.isValid(b)){a=b.getAccessKeys();}else{a=TP.ac();}return a;});TP.core.User.Type.defineMethod('getRealUser',function(){var a;if(TP.notValid(a=this.$get('realUser'))){TP.core.User.construct('demo');a=this.$get('realUser');}return a;});TP.core.User.Type.defineMethod('setEffectiveUser',function(a){if(!TP.isKindOf(a,this)){this.raise('TP.sig.InvalidUser',arguments);return;}this.$set('effectiveUser',a);TP.sys.setcfg('tibet.uriprofile',null);this.$distributeEffectiveAccessKeys();return this;});TP.core.User.Type.defineMethod('setRealUser',function(a){if(!TP.isKindOf(a,this)){this.raise('TP.sig.InvalidUser',arguments);return;}this.$set('realUser',a);TP.sys.setcfg('tibet.uriprofile',null);this.$distributeRealAccessKeys();return this;});TP.core.User.Inst.defineAttribute('remoteSubscriptions');TP.core.User.Inst.defineAttribute('credentials');TP.core.User.Inst.defineAttribute('credentialsPassword');TP.core.User.Inst.defineMethod('init',function(b){var a;this.callNextMethod();a=TP.vcard_temp.vCard.getInstanceById(b);if(TP.isValid(a)){this.setVCard(a);}this.set('remoteSubscriptions',TP.hc());this.set('credentials',TP.hc());return this;});TP.core.User.Inst.defineMethod('clearCredentialsFor',function(a){if(TP.notEmpty(this.getCredentialsFor(a))){this.get('credentials').removeKey(a);this.saveCredentials();}return this;});TP.core.User.Inst.defineMethod('getCredentialsFor',function(b){var d,a,e,c,f;if(TP.notValid(a=this.get('credentials').at(b))){if((d=this.get('credentialsPassword'))===TP.NULL){a=TP.hc();this.get('credentials').atPut(b,a);return a;}e=TP.core.LocalStorage.construct();c=e.atEncrypted(TP.CREDENTIALS_DB_NAME,d);if(TP.isEmpty(c)){a=TP.hc();}else{if(TP.isValid(f=TP.json2js(c))){a=f.at(b);}else{a=TP.hc();}}this.get('credentials').atPut(b,a);}return a;});TP.core.User.Inst.defineMethod('getCredentialsPassword',function(){var a;if(TP.isEmpty(a=this.$get('credentialsPassword'))){if(TP.isEmpty(a=TP.prompt('Please enter your credentials password'))){a=TP.NULL;}this.set('credentialsPassword',a);}return a;});TP.core.User.Inst.defineMethod('saveCredentials',function(){var b,a;if((b=this.get('credentialsPassword'))===TP.NULL){return this;}a=TP.core.LocalStorage.construct();a.atPutEncrypted(TP.CREDENTIALS_DB_NAME,this.get('credentials').asObject().asJSONSource(),this.get('credentialsPassword'));return this;});TP.core.Resource.defineSubtype('Service');TP.core.Service.Type.defineAttribute('defaultInstance');TP.core.Service.Type.defineAttribute('registered',false);TP.core.Service.Type.defineMethod('getDefaultInstance',function(d,b){var a,c;a=this.$get('defaultInstance');if(TP.notValid(a)){c=TP.ifEmpty(d,this.getLocalName()+'Default');TP.raise.$suspended=true;TP.signal.$suspended=true;try{a=this.construct(c,b);}catch(a){TP.ifWarn()?TP.warn(TP.ec(a,'Couldn\'t construct default instance: '),TP.LOG,arguments):0;if(TP.isValid(b)){if(b.shouldStop()){return b.fire();}}return;}finally{TP.raise.$suspended=false;TP.signal.$suspended=false;}if(TP.isValid(a)){this.$set('defaultInstance',a,false);a.register();}}return a;});TP.core.Service.Type.defineMethod('getInstanceById',function(b){var a;if(TP.isValid(a=this.getResourceById(b))){if(TP.isKindOf(a,this)){return a;}}return a;});TP.core.Service.Type.defineMethod('handleRequest',function(b){var c,a;c=this.getLocalName()+'Default';a=this.getDefaultInstance(c,b);this.unregister();if(TP.isValid(a)){return TP.handle(a,b);}});TP.core.Service.Type.defineMethod('isRegistered',function(a){if(TP.isBoolean(a)){this.$set('registered',a);}return this.$get('registered');});TP.core.Service.Type.defineMethod('register',function(){var a,c,d,b;a=this.get('triggerSignals');if(TP.isValid(a)){c=this.get('triggerOrigins')||TP.ANY;if(TP.isArray(c)){for(d=0;d<c.getSize();d++){if(TP.isArray(a)){for(b=0;b<a.getSize();b++){this.observe(c.at(d),a.at(b));}}else{this.observe(c.at(d),a);}}}else{if(TP.isArray(a)){for(b=0;b<a.getSize();b++){this.observe(c,a.at(b));}}else{this.observe(c,a);}}}this.isRegistered(true);return this;});TP.core.Service.Type.defineMethod('unregister',function(){var a,c,d,b;if(!this.isRegistered()){return;}a=this.get('triggerSignals');if(TP.isValid(a)){c=this.get('triggerOrigins')||TP.ANY;if(TP.isArray(c)){for(d=0;d<c.getSize();d++){if(TP.isArray(a)){for(b=0;b<a.getSize();b++){this.ignore(c.at(d),a.at(b));}}else{this.ignore(c.at(d),a);}}}else{if(TP.isArray(a)){for(b=0;b<a.getSize();b++){this.ignore(c,a.at(b));}}else{this.ignore(c,a);}}}this.isRegistered(false);return this;});TP.core.Service.Inst.defineAttribute('serviceEnabled',true);TP.core.Service.Inst.defineMethod('init',function(b,c){var a;this.callNextMethod();a=TP.vcard_temp.vCard.getInstanceById(b);if(TP.isValid(a)){this.setVCard(a);}return this;});TP.core.Service.Inst.defineMethod('clearAuthData',function(){TP.sys.getEffectiveUser().clearCredentialsFor(this.getID());return this;});TP.core.Service.Inst.defineMethod('configureAuthData',function(a){return this;});TP.core.Service.Inst.defineMethod('isEnabled',function(){return this.get('serviceEnabled');});TP.core.Service.Inst.defineMethod('register',function(){this.callNextMethod();this.getType().unregister();return this;});TP.sig.Request.defineSubtype('FunctionRequest');TP.sig.FunctionRequest.Type.defineAttribute('responseType','TP.sig.FunctionResponse');TP.sig.Response.defineSubtype('FunctionResponse');TP.core.Service.defineSubtype('FunctionService');TP.core.FunctionService.Type.defineAttribute('triggerSignals','TP.sig.FunctionRequest');TP.core.FunctionService.Type.defineAttribute('supportedModes',TP.core.SyncAsync.SYNCHRONOUS);TP.core.FunctionService.Type.defineAttribute('mode',TP.core.SyncAsync.SYNCHRONOUS);TP.core.FunctionService.register();TP.core.FunctionService.Inst.defineMethod('handleFunctionRequest',function(d){var a,b,c;a=TP.request(d);a.atPut('async',this.rewriteRequestMode(a));if(!TP.isCallable(b=a.at('handler'))){a.fail(TP.FAILURE,'Handler not callable');}else{c=b.apply(a,TP.ac(a));a.set('result',c);}return this;});Function.Inst.defineMethod('asFunctionRequest',function(){return TP.sig.FunctionRequest.construct(TP.hc('handler',this));});Function.Inst.defineMethod('fire',function(){return this.asFunctionRequest().fire();});TP.sig.Request.defineSubtype('IORequest');TP.sig.Response.defineSubtype('IOResponse');TP.core.Service.defineSubtype('IOService');TP.core.IOService.Inst.defineAttribute('$pollingJob');TP.core.IOService.Inst.defineAttribute('lastRequest');TP.core.IOService.Inst.defineAttribute('firstInterval',3000);TP.core.IOService.Inst.defineAttribute('maxInterval',60000);TP.core.IOService.Inst.defineMethod('isPolling',function(){var a;a=this.get('$pollingJob');return TP.isValid(a)&&a.isActive()&&!a.isPaused();});TP.core.IOService.Inst.defineMethod('inPollMode',function(){var a;a=this.get('$pollingJob');return TP.isValid(a);});TP.core.IOService.Inst.defineMethod('$computeInterval',function(a){if(TP.notValid(this.get('lastRequest'))){return a.get('firstInterval');}if(TP.notEmpty(this.get('lastRequest').getResponse().getResultText())){return a.get('firstInterval');}else{return a.get('maxInterval').min(a.get('lastInterval')+1000);}});TP.core.IOService.Inst.defineMethod('handleRequestFailed',function(a){if(this.inPollMode()){this.stopPolling();}return a;});TP.core.IOService.Inst.defineMethod('handleRequestSucceeded',function(b){var a;a=b.getRequest();if(this.inPollMode()){if(a!==this.get('lastRequest')){this.set('lastRequest',a);}}if(TP.isValid(a.at('poll'))){if(TP.isFalse(a.at('poll'))&&this.inPollMode()){this.stopPolling();}else if(TP.notFalse(a.at('poll')&&!this.inPollMode())){this.startPolling(a);this.set('lastRequest',a);}}return b;});TP.core.IOService.Inst.defineMethod('pausePolling',function(){if(!this.isPolling()){return this;}this.get('$pollingJob').pause();return this;});TP.core.IOService.Inst.defineMethod('$poll',function(){var a;if(TP.isValid(a=this.get('lastRequest'))){a.fire();}return true;});TP.core.IOService.Inst.defineMethod('resumePolling',function(){if(this.isPolling()){return this;}this.get('$pollingJob').resume();return this;});TP.core.IOService.Inst.defineMethod('startPolling',function(b){var c,d,a,e,f;if(this.inPollMode()){return this;}c=this.get('firstInterval');d=this.get('maxInterval');if(TP.notValid(b)){a=TP.hc('limit',TP.RETURN_FALSE,'step',this.$poll.bind(this),'interval',this.$computeInterval.bind(this),'firstInterval',c,'maxInterval',d);}else{a=TP.hc('limit',TP.RETURN_FALSE,'step',this.$poll.bind(this));if(TP.isValid(e=b.at('poll'))&&TP.isCallable(e)){a.atPut('interval',e.bind(this));}else{a.atPut('interval',this.$computeInterval.bind(this));}a.atPut('firstInterval',TP.isValid(b.at('pollFirstInterval'))?b.at('pollFirstInterval'):c);a.atPut('maxInterval',TP.isValid(b.at('pollMaxInterval'))?b.at('pollMaxInterval'):d);}f=TP.core.Job.construct(a);this.set('$pollingJob',f);f.start();return this;});TP.core.IOService.Inst.defineMethod('stopPolling',function(){if(!this.inPollMode()){return;}this.get('$pollingJob').complete();this.set('$pollingJob',null);this.set('lastRequest',null);return this;});TP.sig.IORequest.defineSubtype('URIRequest');TP.sig.URIRequest.Type.defineAttribute('responseType','TP.sig.URIResponse');TP.sig.URIRequest.Inst.defineMethod('getFinalURI',function(){return this.at('finaluri')||this.getRequestURI();});TP.sig.URIRequest.Inst.defineMethod('getRequestURI',function(){var a;a=this.get('responder');if(TP.isValid(a)){return a.getRequestURI(this);}return this.at('uri');});TP.sig.IOResponse.defineSubtype('URIResponse');TP.delegate(TP.ac('getFinalURI','getRequestURI'),TP.sig.URIResponse.getInstPrototype(),true);TP.core.IOService.defineSubtype('URIService');TP.core.URIService.Type.defineAttribute('serviceURI');TP.core.URIService.Type.defineAttribute('defaultedParameters',TP.hc('username',TP.NONE,'password',TP.NONE,'auth',TP.NONE,'iswebdav',false));TP.core.URIService.Inst.defineAttribute('serviceURI');TP.core.URIService.Inst.defineMethod('init',function(e,c){var a,b,d;this.callNextMethod(e);if(TP.isValid(c)){a=c;}else{a=TP.hc();}b=a.at('serviceURI');if(TP.isEmpty(b)){if(TP.notEmpty(d=a.at('uri'))&&TP.uriIsAbsolute(d)){b=d;}else{this.populateMissingVCardData(TP.hc('serviceURI',TP.ac('url','Enter service URI: ')),a);if(TP.isEmpty(b=a.at('serviceURI'))){c.fail(TP.FAILURE,TP.sc('Missing required URI parameter in request: ')+'serviceURI');return;}}}this.set('serviceURI',b);this.populateMissingVCardData(TP.hc('username',TP.ac('username','Enter username: '),'password',TP.ac('password','Enter password: '),'auth',TP.ac('auth','Enter authentication scheme ("BASIC" or "DIGEST"): '),'iswebdav',TP.ac('iswebdav','Should server comm use WebDAV verbs ("true or "false"): ')),a);return this;});TP.core.URIService.Inst.defineMethod('getRequestURI',function(b){var a;if(TP.notValid(a=b.at('uri'))){if(TP.notValid(a=this.get('serviceURI'))){this.raise('TP.sig.InvalidURI',arguments,'Request has no service URI.');return;}}return a;});TP.core.URIService.Inst.defineMethod('getServiceURI',function(){return this.$get('serviceURI')||this.getType().get('serviceURI');});TP.core.URIService.Inst.defineMethod('rewriteRequestURI',function(d){var b,c,a;b=d.at('uri');c=this.get('serviceURI');if(TP.notValid(b)&&TP.notValid(c)){this.raise('TP.sig.InvalidURI',arguments,'Request has no service URI.');return;}if(TP.isURI(b)){if(TP.uriIsAbsolute(b)){a=b;}else if(TP.isURI(c)){a=TP.uriJoinPaths(TP.uriCollectionPath(c),b);}else{a=b;}}else{a=c;}if(TP.uriIsAbsolute(a)){a=TP.core.URI.rewrite(a,d).getLocation();}return a;});TP.core.URIService.Inst.defineMethod('updateServiceURI',function(b){var a;if(TP.isURI(a=b.at('serviceURI'))||TP.uriIsAbsolute(a=b.at('uri'))){this.set('serviceURI',a);}return this;});TP.lang.Object.defineSubtype('core:Application');TP.core.Application.Type.defineAttribute('singleton');TP.core.Application.Type.defineMethod('initialize',function(){this.observe(TP.sys,'TP.sig.AppStart');return;});TP.core.Application.Type.defineMethod('handleAppStart',function(a){var b,c;this.ignore(a.getSignalOrigin(),a.getSignalName());b=a.at('ApplicationType');if(TP.notValid(b)){TP.ifWarn()?TP.warn('Unable to locate application controller type.'+'Defaulting to TP.core.Application.',TP.LOG,arguments):0;b=TP.sys.require('TP.core.Application');}c=b.construct('AppSingleton',null);TP.core.Application.set('singleton',c);c.start(a);return this;});TP.core.Application.Inst.defineMethod('init',function(a,b){this.callNextMethod();this.observe(TP.core.History,'TP.sig.LocationBack');this.observe(TP.core.History,'TP.sig.LocationChanged');this.observe(TP.core.History,'TP.sig.LocationNext');return this;});TP.core.Application.Inst.defineMethod('finalizeGUI',function(){if(!TP.sys.cfg('boot.tdc')){TP.boot.showUIRoot();}return this;});TP.core.Application.Inst.defineMethod('handleLocationBack',function(a){TP.ifInfo()?TP.info('Got to TP.core.Application::handleLocationBack',TP.LOG,arguments):0;return this;});TP.core.Application.Inst.defineMethod('handleLocationChanged',function(c){var a,b;TP.ifInfo()?TP.info('Got to TP.core.Application::handleLocationChanged',TP.LOG,arguments):0;if(TP.notValid(a=TP.sys.getUICanvas())){return this;}if(TP.notEmpty(b=c.getPayload())){a.setContent(TP.uc(b));}return this;});TP.core.Application.Inst.defineMethod('handleLocationNext',function(a){TP.ifInfo()?TP.info('Got to TP.core.Application::handleLocationNext',TP.LOG,arguments):0;return this;});TP.core.Application.Inst.defineMethod('start',function(c){var a,b;this.finalizeGUI();if(TP.isElement(a=c.at('ApplicationElement'))){if(TP.isWindow(b=TP.nodeGetWindow(a))){b.focus();}}this.signal('TP.sig.AppDidStart');return this;});TP.sys.defineMethod('getApplication',function(){return TP.core.Application.get('singleton');});TP.lang.Object.defineSubtype('core:History');TP.core.History.Type.defineAttribute('rootDocTitle');TP.core.History.Type.defineAttribute('historyIndex',0);TP.core.History.Type.defineAttribute('historyList',TP.ac());TP.core.History.Type.defineAttribute('addingHistory',false);TP.core.History.Type.defineMethod('initialize',function(){top.onhashchange=function(a){this.handleHashChanged(a);}.bind(this);this.get('historyList').add(TP.btoa(top.location.href));this.set('rootDocTitle',TP.documentGetTitleContent(top.document));return;});TP.core.History.Type.defineMethod('clearHistory',function(){return TP.todo();});TP.core.History.Type.defineMethod('getIndexForHash',function(b){var a;a=this.get('historyList').getPositions(b);if(TP.isEmpty(a)){return null;}if(a.getSize()===1){return a.first();}return null;});TP.core.History.Type.defineMethod('handleHashChanged',function(g){var c,a,b,e,f,d;if(TP.isTrue(this.get('addingHistory'))){this.set('addingHistory',false);return this;}if(TP.isEmpty(c=top.location.hash)){a=this.get('historyList').at(0);d=TP.atob(a);b=0;}else{if(c.startsWith('#')){a=c.slice(1);}else{a=c;}b=this.getIndexForHash(a);}if(a===this.get('historyList').at(0)){e=top.onhashchange;f=TP.documentGetTitleContent(top.document);top.onhashchange=function(){TP.documentSetTitleContent(top.document,f);top.onhashchange=e;};TP.documentSetTitleContent(top.document,this.get('rootDocTitle'));top.history.go(this.get('historyIndex'));return this;}if(a===this.get('historyList').at(this.get('historyIndex'))){return this;}if(TP.isNumber(b)){if(b<this.get('historyIndex')){this.signal('TP.sig.LocationBack',arguments,d);}else if(b>this.get('historyIndex')){this.signal('TP.sig.LocationNext',arguments,d);}this.set('historyIndex',b);}this.signal('TP.sig.LocationChanged',arguments,d);return this;});TP.core.History.Type.defineMethod('replaceLocation',function(a){return TP.todo();});TP.core.History.Type.defineMethod('setLocation',function(d){var b,c,a;if(TP.isEmpty(d)){return this.raise('TP.sig.InvalidURI',arguments);}b=TP.btoa(d.asString());if(b===this.get('historyList').at(this.get('historyIndex'))){return this;}c=this.get('historyIndex');this.set('historyList',this.get('historyList').slice(0,c+1));this.get('historyList').add(b);this.set('historyIndex',c+1);a=top.location.hash;if(a.startsWith('#')){a=a.slice(1);}if(a!==b){this.set('addingHistory',true);}return this;});TP.lang.Object.defineSubtype('core:Controller');TP.core.Controller.defineSubtype('URIController');TP.core.URIController.Inst.defineAttribute('uri');TP.core.URIController.Inst.defineAttribute('currentWindow');TP.core.URIController.Inst.defineMethod('isResponderFor',function(a,c){var b;if(TP.isTrue(c)){return false;}b=a.getType();return TP.canInvoke(this,b.getHandlerName(null,false,a))||TP.canInvoke(this,b.getHandlerName(null,true,a));});TP.core.URIController.Inst.defineMethod('getNextResponder',function(c,d){var b,a;if(TP.isIFrameWindow(b=this.get('currentWindow'))){a=b.frameElement;if(TP.isElement(a)){return TP.wrap(a).getNextResponder(c,d);}}return TP.sys.getApplication();});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETDeviceTypes.js';
TP.core.SignalSource.defineSubtype('core:Device');TP.core.Device.Type.defineConstant('REDIRECTOR',function(b){var a,c;TP.debug('break.device_redirect');a=b.getEvent();if(TP.isElement(c=TP.eventGetResolvedTarget(a))){b.fire(TP.elementGetEventIds(c),a,TP.DOM_FIRING);}});TP.core.Device.Type.defineMethod('addObserver',function(k,c,l,m){var e,i,h,b,a,g,d,j,f;TP.debug('break.device_observe');if(TP.isArray(c)){e=c;}else if(TP.isString(c)){e=c.split(' ');}else if(TP.isType(c)){e=TP.ac(c);}else{this.raise('TP.sig.InvalidParameter',arguments,'Improper signal definition.');return false;}i=e.getSize();if(TP.notEmpty(m)||k!==this&&k!==this.getName()){h=this.get('redirections');for(b=0;b<i;b++){a=e.at(b).getSignalName();g=h.at(a);if(TP.isNumber(g)&&g>1){h.atPut(a,g+1);}else{h.atPut(a,1);}}d=this.REDIRECTOR;}else{d=l;}if(TP.notValid(d)){this.raise('TP.sig.InvalidHandler',arguments);return false;}j=this.get('observers');for(b=0;b<i;b++){a=e.at(b).getSignalName();if(/__/.test(a)){this.addShortcutObserver(a,d);}else{if(TP.notValid(f=j.at(a))){f=TP.ac();j.atPut(a,f);}f.push(d);f.unique();}}return d!==l;});TP.core.Device.Type.defineMethod('addShortcutObserver',function(a,b){return;});TP.core.Device.Type.defineMethod('getDOMSignalName',function(a){return TP.DOM_SIGNAL_TYPE_MAP.at(TP.eventGetType(a));});TP.core.Device.Type.defineMethod('invokeObservers',function(b,c,a){TP.override();return a;});TP.core.Device.Type.defineMethod('removeObserver',function(k,c,l,m){var d,j,f,b,a,g,e,i,h;TP.debug('break.device_ignore');if(TP.isArray(c)){d=c;}else if(TP.isString(c)){d=c.split(' ');}else if(TP.isType(c)){d=TP.ac(c);}else{this.raise('TP.sig.InvalidParameter',arguments,'Improper signal definition.');return false;}j=d.getSize();if(TP.notEmpty(m)||k!==this&&k!==this.getName()){f=this.get('redirections');for(b=0;b<j;b++){a=d.at(b).getSignalName();g=f.at(a);if(TP.isNumber(g)&&g>1){f.atPut(a,g-1);}else{f.atPut(a,0);}}e=this.REDIRECTOR;}else{e=l;}i=this.get('observers');for(b=0;b<j;b++){a=d.at(b).getSignalName();if(/__/.test(a)){this.removeShortcutObserver(a,e);}else{if(TP.isArray(h=i.at(a))){h.remove(e,TP.IDENTITY);if(TP.isEmpty(h)){i.removeKey(a);}}}}return e!==l;});TP.core.Device.Type.defineMethod('removeShortcutObserver',function(a,b){return;});TP.core.Device.Type.defineMethod('signalObservers',function(i,c,n,j,m,l,k,o){var d,h,e,g,a,b,f;TP.debug('break.device_signal');if(i!==this&&i!==this.getName()){return true;}if(TP.isArray(c)){d=c;}else if(TP.isString(c)){d=c.split(' ');}else if(TP.isType(c)){d=TP.ac(c);}else{this.raise('TP.sig.InvalidParameter',arguments,'Improper signal definition.');return false;}h=d.getSize();for(e=0;e<h;e++){a=d.at(e);if(!TP.isKindOf(a,TP.sig.Signal)){if(TP.regex.KEY_EVENT.test(a)){if(a.indexOf('_Up')!==TP.NOT_FOUND){b='TP.sig.DOMKeyUp';}else if(a.indexOf('_Press')!==TP.NOT_FOUND){b='TP.sig.DOMKeyPress';}else{b='TP.sig.DOMKeyDown';}}else{b=a;}f=TP.isTypeName(b)?TP.sys.getTypeByName(b):TP.sys.require(b);if(TP.notValid(f)){this.raise('TP.sig.InvalidType',arguments,'Unable to find signal type: '+b);return false;}g=a;a=f.construct(j);if(TP.notValid(a)){this.raise('TP.sig.InvalidSignal',arguments,'Unable to construct signal instance: '+g);return false;}a.setSignalName(g);}this.invokeObservers(null,null,a);}return false;});TP.core.Device.defineSubtype('Keyboard');TP.core.Keyboard.Type.defineAttribute('observers',TP.hc());TP.core.Keyboard.Type.defineAttribute('redirections',TP.hc());TP.core.Keyboard.Type.defineAttribute('lastDown');TP.core.Keyboard.Type.defineAttribute('lastPress');TP.core.Keyboard.Type.defineAttribute('lastUp');TP.core.Keyboard.Type.defineAttribute('keyup');TP.core.Keyboard.Type.defineAttribute('keydown');TP.core.Keyboard.Type.defineAttribute('keypress');TP.core.Keyboard.Type.defineAttribute('modifierkeychange');TP.core.Keyboard.Type.defineAttribute('altDown',false);TP.core.Keyboard.Type.defineAttribute('ctrlDown',false);TP.core.Keyboard.Type.defineAttribute('metaDown',false);TP.core.Keyboard.Type.defineAttribute('shiftDown',false);TP.core.Keyboard.Type.defineAttribute('currentKeyboard');TP.core.Keyboard.Type.defineAttribute('mapuri');TP.core.Keyboard.Type.defineAttribute('mapxml');TP.core.Keyboard.Type.defineAttribute('downTimer');TP.core.Keyboard.Type.defineAttribute('shortcutsTimer');TP.core.Keyboard.Type.defineAttribute('shortcuts',TP.hc());TP.core.Keyboard.Type.defineAttribute('shortcutIndex',TP.core.Keyboard.shortcuts);TP.core.Keyboard.Type.defineMethod('initialize',function(){var a,b;this.$set('keyup',TP.sys.require('TP.sig.DOMKeyUp').construct(null,true));this.$set('keydown',TP.sys.require('TP.sig.DOMKeyDown').construct(null,true));this.$set('keypress',TP.sys.require('TP.sig.DOMKeyPress').construct(null,true));this.$set('modifierkeychange',TP.sys.require('TP.sig.DOMModifierKeyChange').construct(null,true));a=TP.ifInvalid(TP.sys.cfg('tibet.keyboard'),'TP.core.USAscii101Keyboard');b=TP.sys.require(a)||TP.sys.getTypeByName('TP.core.USAscii101Keyboard');if(TP.notValid(b)){TP.ifError()?TP.error('Unable to install keyboard type: '+a,TP.LOG,arguments):0;return;}this.setCurrentKeyboard(b);return;});TP.core.Keyboard.Type.defineMethod('addShortcutObserver',function(c,d){var b,a;b=this.getShortcutData(c,true);if(TP.notValid(a=b.at('handlers'))){a=TP.ac();b.atPut('handlers',a);}a.push(d);a.unique();return a;});TP.core.Keyboard.Type.defineMethod('getShortcutData',function(j,k){var d,b,i,f,h,e,c,a,g;d=this.get('shortcuts');b='';i=j.getSignalName();f=i.split('__');h=f.getSize();for(e=0;e<h;e++){c=f.at(e);b=TP.isEmpty(b)?c:b+'__'+c;a=d.at(c);if(TP.notValid(a)){if(TP.notTrue(k)){return;}a=TP.hc();g=TP.hc();a.atPut('shortcuts',g);a.atPut('name',b);a.atPut('handlers',TP.ac());d.atPut(c,a);}d=a.at('shortcuts');}return a;});TP.core.Keyboard.Type.defineMethod('loadKeymap',function(){var d,b,a,c,e;d=TP.hc('async',false);b=this.getName();a=TP.sys.cfg(b+'.xml');if(!a){a=TP.uriExpandPath('~lib_dat/'+b+'.xml');}c=TP.uc(a);if(TP.notValid(e=c.getNativeNode(d))){return this.raise('TP.sig.InvalidKeymap',arguments);}this.$set('mapuri',c);TP.core.Keyboard.$set('mapxml',e);return;});TP.core.Keyboard.Type.defineMethod('getCurrentKeyboard',function(){return TP.core.Keyboard.$get('currentKeyboard');});TP.core.Keyboard.Type.defineMethod('get',function(b){var a;a=this.$get(b);if(TP.notValid(a)&&this!==TP.core.Keyboard){a=TP.core.Keyboard.get(b);}return a;});TP.core.Keyboard.Type.defineMethod('invokeObservers',function(v,a,y){var p,o,n,b,s,t,m,l,f,x,e,h,c,i,d,q,k,u,g,w,j,r;if(!TP.sys.hasInitialized()){return;}if(TP.isElement(p=TP.eventGetResolvedTarget(a))){o='handlePeer'+TP.escapeTypeName(TP.DOM_SIGNAL_TYPE_MAP.at(TP.eventGetType(a)));n=TP.wrap(p).getType();if(TP.canInvoke(n,o)){n[o](p,a);}if(a.defaultPrevented===true){return;}}b=y;if(TP.notValid(b)){if(TP.notValid(b=this.get(v))){TP.ifWarn()?TP.warn('Event singleton not found for: '+v,TP.LOG,arguments):0;return;}b.recycle();b.setEvent(a);b.set('origin',b.get('target'));}s=this.REDIRECTOR;t=this.get('observers');m=b.getSignalNames();q=false;j=false;l=m.getSize();for(f=0;f<l;f++){d=m.at(f);b.setSignalName(d);if(TP.sys.shouldLogKeys()&&/DOMKey/.test(d)){x=TP.hc('key: ',a.$$keyCode,'keyCode: ',TP.isValid(a.keyCode)?a.keyCode:'','charCode: ',TP.isValid(a.charCode)?a.charCode:'','unicode: ',TP.isValid(a.$unicodeCharCode)?a.$unicodeCharCode:'','which: ',TP.isValid(a.which)?a.which:'','shift: ',a.shiftKey,'alt: ',a.altKey,'ctrl: ',a.ctrlKey,'meta: ',a.metaKey,'keyname: ',this.getEventVirtualKey(a),'signame: ',d,'special: ',TP.isValid(a.$special)?a.$special:false);TP.sys.logKey(x,null,arguments);}if(TP.isValid(k=this.get('shortcutIndex').at(d))){if(TP.notEmpty(e=k.at('handlers'))){u=k.at('name');h=e.getSize();if(h>0){g=b.getType().construct(b.getPayload());g.setSignalName(u);g.setOrigin(b.getOrigin());}for(c=0;c<h;c++){if(g.shouldStop()){break;}i=e.at(c);try{TP.handle(i,g);}catch(a){TP.raise(this,'TP.sig.HandlerException',arguments,TP.ec(a));}}j=true;this.set('shortcutIndex',this.get('shortcuts'));}else if(TP.notEmpty(w=k.at('shortcuts'))){q=true;TP.core.Keyboard.$set('shortcutsTimer',setTimeout(function(){TP.core.Keyboard.$set('shortcutsTimer',null);this.set('shortcutIndex',this.get('shortcuts'));}.bind(this),TP.sys.cfg('keyboard.shortcut_cancel_delay')));this.set('shortcutIndex',w);}else{j=true;this.set('shortcutIndex',this.get('shortcuts'));}}else if(f===l-1&&/Up$/.test(d)&&this.get('shortcuts')!==this.get('shortcutIndex')&&!q){if(/^(Shift|Alt|Ctrl)_Up/.test(a.$computedName)){continue;}j=true;this.set('shortcutIndex',this.get('shortcuts'));}if(j){if(TP.isNumber(r=TP.core.Keyboard.$get('shortcutsTimer'))){clearTimeout(r);TP.core.Keyboard.$set('shortcutsTimer',null);}}if(TP.notEmpty(e=t.at(d))){h=e.getSize();for(c=0;c<h;c++){if(b.shouldStop()){break;}i=e.at(c);if(i!==s){b.set('origin',this);}try{TP.handle(i,b);}catch(a){TP.raise(this,'TP.sig.HandlerException',arguments,TP.ec(a));}}}}return b;});TP.core.Keyboard.Type.defineMethod('removeShortcutObserver',function(c,d){var a,b;a=this.getShortcutData(c);if(TP.notValid(a)||TP.notValid(b=a.at('handlers'))){return;}return b.remove(d,TP.IDENTITY);});TP.core.Keyboard.Type.defineMethod('setCurrentKeyboard',function(a){TP.core.Keyboard.$set('currentKeyboard',a);a.loadKeymap();return TP.core.Keyboard.$get('currentKeyboard');});TP.core.Keyboard.Type.defineMethod('$$handleKeyEvent',function(d){var a,b,c,e;if(!TP.sys.hasInitialized()){return;}if(d.$captured){return;}d.$captured=true;a=TP.event(d);switch(TP.eventGetType(a)){case'keydown':if(TP.boot.isUA('IE')){b=TP.core.Keyboard.get('lastDown');if(TP.isEvent(b)&&TP.eventIsDuplicate(b,a)){return;}}TP.core.Keyboard.$set('lastPress',null);TP.core.Keyboard.$set('lastUp',null);c='lastDown';TP.core.Keyboard.$set(c,a);if(TP.isNumber(e=TP.core.Keyboard.$get('downTimer'))){clearTimeout(e);TP.core.Keyboard.$set('downTimer',null);}TP.core.Keyboard.getCurrentKeyboard().$$handleKeyDown(a);break;case'keypress':if(TP.boot.isUA('IE')){b=TP.core.Keyboard.get('lastPress');if(TP.isEvent(b)&&TP.eventIsDuplicate(b,a)){return;}}c='lastPress';TP.core.Keyboard.$set(c,a);TP.core.Keyboard.getCurrentKeyboard().$$handleKeyPress(a);break;case'keyup':if(TP.boot.isUA('IE')){b=TP.core.Keyboard.get('lastUp');if(TP.isEvent(b)&&TP.eventIsDuplicate(b,a)){return;}}c='lastUp';TP.core.Keyboard.$set(c,a);TP.core.Keyboard.getCurrentKeyboard().$$handleKeyUp(a);break;default:return;}if(TP.boot.isUA('IE')&&TP.core.Keyboard.get(c)===a){TP.core.Keyboard.$set(c,a.copy());}return;});TP.core.Keyboard.Type.defineMethod('$$handleKeyDown',function(a){this.$$updateModifierStates(a);this.handleKeyDown(a);return;});TP.core.Keyboard.Type.defineMethod('handleKeyDown',function(a){return TP.override();});TP.core.Keyboard.Type.defineMethod('$$handleKeyPress',function(a){this.handleKeyPress(a);return;});TP.core.Keyboard.Type.defineMethod('handleKeyPress',function(a){return TP.override();});TP.core.Keyboard.Type.defineMethod('$$handleKeyUp',function(a){this.$$updateModifierStates(a);this.handleKeyUp(a);return;});TP.core.Keyboard.Type.defineMethod('handleKeyUp',function(a){return TP.override();});TP.core.Keyboard.Type.defineMethod('$$updateModifierStates',function(c){var a,b;b=false;a=TP.eventGetAltKey(c);if(this.isAltDown()!==a){b=true;this.isAltDown(a);}a=TP.eventGetShiftKey(c);if(this.isShiftDown()!==a){b=true;this.isShiftDown(a);}a=TP.eventGetCtrlKey(c);if(this.isCtrlDown()!==a){b=true;this.isCtrlDown(a);}a=TP.eventGetMetaKey(c);if(this.isMetaDown()!==a){b=true;this.isMetaDown(a);}if(b){this.invokeObservers('modifierkeychange',c);}return;});TP.core.Keyboard.Type.defineMethod('computeFullSignalName',function(c,b,d){var a;switch(TP.eventGetType(c)){case'keyup':a=b+'_Up';break;case'keydown':a=b+'_Down';break;case'keypress':a=b+'_Press';break;}if(d&&b!=='Shift'){a='Shift_'+a;}if(TP.eventGetAltKey(c)&&b!=='Alt'){a='Alt_'+a;}if(TP.eventGetCtrlKey(c)&&b!=='Control'){a='Ctrl_'+a;}if(TP.eventGetMetaKey(c)&&b!=='Meta'){a='Meta_'+a;}return a;});TP.core.Keyboard.Type.defineMethod('getDOMSignalName',function(a){return'DOM_'+this.$getVirtualKeySignalName(a);});TP.core.Keyboard.Type.defineMethod('getEventVirtualKey',function(f){var h,j,g,a,i,c,b,e,d;if(TP.notValid(f)){this.raise('TP.sig.InvalidEvent',arguments);return;}h=TP.isEvent(f)?f:f.get('event');j=TP.eventGetType(h);if(!TP.regex.KEY_EVENT.test(j)){return;}if(TP.notValid(g=TP.core.Keyboard.get('mapxml'))){return;}a=TP.eventGetKeyCode(h);if(a!==TP.SHIFT_KEY){i=TP.eventGetShiftKey(h);}if(i){c=TP.join('//*[@id="_',a,'_shifted"]','[(@platform="',TP.$platform,'" and @browser="',TP.$browser,'")',' or (@browser="',TP.$browser,'")',' or (@platform="',TP.$platform,'")',' or .]');b=TP.nodeEvaluateXPath(g,c,TP.NODESET);if(!TP.isElement(e)){c=TP.join('//*[@id="_',a,'"]','[(@platform="',TP.$platform,'" and @browser="',TP.$browser,'")',' or (@browser="',TP.$browser,'")',' or (@platform="',TP.$platform,'")',' or .]');b=TP.nodeEvaluateXPath(g,c,TP.NODESET);}}else{c=TP.join('//*[@id="_',a,'"]','[(@platform="',TP.$platform,'" and @browser="',TP.$browser,'")',' or (@browser="',TP.$browser,'")',' or (@platform="',TP.$platform,'")',' or .]');b=TP.nodeEvaluateXPath(g,c,TP.NODESET);}if(TP.isEmpty(b)){if(TP.core.Keyboard.isPrintable(f)){d=String.fromCharCode(a);}}else{if(b.getSize()>1){b.sort(TP.KEYMAP_ELEMENT_SORT);e=b.last();}else{e=b.first();}d=TP.ifEmpty(TP.elementGetAttribute(e,'key'),TP.elementGetAttribute(e,'glyph'));}if(TP.notValid(d)){d='KeyCode'+(TP.isString(a)?a:'');}return d;});TP.core.Keyboard.Type.defineMethod('getKeyCodeForKeyNamed',function(c){var d,b,a,f,e;if(!TP.isString(c)){this.raise('TP.sig.InvalidParameter',arguments);return;}if(TP.notValid(d=TP.core.Keyboard.get('mapxml'))){return;}b=TP.join('//*[@key="',c,'"]','[(@platform="',TP.$platform,'" and @browser="',TP.$browser,'")',' or (@browser="',TP.$browser,'")',' or (@platform="',TP.$platform,'")',' or .]');if(TP.isEmpty(a=TP.nodeEvaluateXPath(d,b,TP.NODESET))){b=TP.join('//*[@glyph="',c,'"]','[(@platform="',TP.$platform,'" and @browser="',TP.$browser,'")',' or (@browser="',TP.$browser,'")',' or (@platform="',TP.$platform,'")',' or .]');if(TP.isEmpty(a=TP.nodeEvaluateXPath(d,b,TP.NODESET))){return-1;}}if(a.getSize()>1){a.sort(TP.KEYMAP_ELEMENT_SORT);e=a.last();}else{e=a.first();}if(TP.notEmpty(f=TP.elementGetAttribute(e,'id'))){return f.slice(1).asNumber();}return-1;});TP.core.Keyboard.Type.defineMethod('$getVirtualKeySignalName',function(a){var g,h,b,i,d,e,c,f;if(TP.isString(g=a.$computedName)){return g;}b=TP.eventGetKeyCode(a);if(b){if(TP.notValid(i=TP.core.Keyboard.get('mapxml'))){if(TP.core.Keyboard.isPrintable(a)){d=String.fromCharCode(b);a.$unicodeCharCode=d.asUnicodeLiteral().replace('\\u','U');}}else{if(b!==TP.SHIFT_KEY){h=TP.eventGetShiftKey(a);}if(h){e=TP.join('//*[@id="_',b,'_shifted"]','[(@platform="',TP.$platform,'" and @browser="',TP.$browser,'")',' or (@browser="',TP.$browser,'")',' or (@platform="',TP.$platform,'")',' or .]');c=TP.nodeEvaluateXPath(i,e,TP.NODESET);if(TP.isEmpty(c)){e=TP.join('//*[@id="_',b,'"]','[(@platform="',TP.$platform,'" and @browser="',TP.$browser,'")',' or (@browser="',TP.$browser,'")',' or (@platform="',TP.$platform,'")',' or .]');c=TP.nodeEvaluateXPath(i,e,TP.NODESET);}}else{e=TP.join('//*[@id="_',b,'"]','[(@platform="',TP.$platform,'" and @browser="',TP.$browser,'")',' or (@browser="',TP.$browser,'")',' or (@platform="',TP.$platform,'")',' or .]');c=TP.nodeEvaluateXPath(i,e,TP.NODESET);}if(TP.isEmpty(c)){if(TP.core.Keyboard.isPrintable(a)){d=String.fromCharCode(b);a.$unicodeCharCode=d.asUnicodeLiteral().replace('\\u','U');}}else{if(c.getSize()>1){c.sort(TP.KEYMAP_ELEMENT_SORT);f=c.last();}else{f=c.first();}if(h&&TP.elementGetAttribute(f,'id').endsWith('_shifted')){h=false;}d=TP.ifEmpty(TP.elementGetAttribute(f,'key'),TP.elementGetAttribute(f,'glyph'));a.$unicodeCharCode=TP.elementGetAttribute(f,'char');}}}if(TP.notValid(d)){d='KeyCode'+(TP.isString(b)?b:'');}g=this.computeFullSignalName(a,d,h);a.$computedName=g;return g;});TP.core.Keyboard.Type.defineMethod('isAltDown',function(a){if(TP.isBoolean(a)){this.$set('altDown',a);}return this.$get('altDown');});TP.core.Keyboard.Type.defineMethod('isCtrlDown',function(a){if(TP.isBoolean(a)){this.$set('ctrlDown',a);}return this.$get('ctrlDown');});TP.core.Keyboard.Type.defineMethod('isMetaDown',function(a){if(TP.isBoolean(a)){this.$set('metaDown',a);}return this.$get('metaDown');});TP.core.Keyboard.Type.defineMethod('isPrintable',function(a){return this.getCurrentKeyboard().isPrintable(a);});TP.core.Keyboard.Type.defineMethod('isShiftDown',function(a){if(TP.isBoolean(a)){this.$set('shiftDown',a);}return this.$get('shiftDown');});TP.core.Keyboard.defineSubtype('USAscii101Keyboard');TP.core.USAscii101Keyboard.Type.defineMethod('handleKeyDown',function(b){var c,a;c=TP.eventGetKeyCode(b);if(TP.boot.isUA('GECKO')&&TP.boot.isMac()){if(c===0){b.$notSignaled=true;return;}}if(c>=36&&c<=40){if(TP.boot.isUA('GECKO')){b.$notSignaled=true;return;}else{a=TP.core.Keyboard.get('lastDown');if(TP.notValid(a)){return;}a.$notSignaled=true;a.$special=true;a=TP.boot.isUA('IE')?a.copy():a;TP.core.Keyboard.$set('downTimer',setTimeout(function(){TP.core.Keyboard.$set('downTimer',null);a.$notSignaled=null;TP.core.Keyboard.invokeObservers('keydown',a);},10));return;}}this.invokeObservers('keydown',b);return;});TP.core.USAscii101Keyboard.Type.defineMethod('handleKeyPress',function(b){var a,d,c,e,f;if(TP.boot.isUA('GECKO')){a=TP.core.Keyboard.get('lastDown');d=b.which===0;if(d){if(TP.isEvent(a)&&a.$notSignaled){a.$special=true;a.$notSignaled=null;this.invokeObservers('keydown',a);}TP.core.Keyboard.$set('lastPress',null);return;}if((c=TP.eventGetKeyCode(a))!==0){if(TP.isNumber(c)){b.$$keyCode=c;}}e=TP.eventGetKeyCode(b);if(TP.isEvent(a)&&a.$notSignaled){a.$notSignaled=null;a.$special=null;a.$$keyCode=e;this.invokeObservers('keydown',a);}}else{if(TP.isNumber(f=TP.core.Keyboard.$get('downTimer'))){clearTimeout(f);TP.core.Keyboard.$set('downTimer',null);a=TP.core.Keyboard.get('lastDown');if(TP.isEvent(a)){a.$notSignaled=null;a.$special=null;this.invokeObservers('keydown',a);}}else{a=TP.core.Keyboard.get('lastDown');if(TP.isEvent(a)&&(c=TP.eventGetKeyCode(a))!==0){b.$$keyCode=c;}}}this.invokeObservers('keypress',b);return;});TP.core.USAscii101Keyboard.Type.defineMethod('handleKeyUp',function(b){var c,a,d,e;if(TP.boot.isUA('GECKO')){a=TP.core.Keyboard.get('lastPress')||TP.core.Keyboard.get('lastDown');if(TP.isEvent(a)){b.$special=a.$special;}c=TP.eventGetKeyCode(b);if(c===0){if(TP.isEvent(a)&&(d=TP.eventGetKeyCode(a))!==0){b.$$keyCode=d;}}}else{if(TP.isNumber(e=TP.core.Keyboard.$get('downTimer'))){clearTimeout(e);TP.core.Keyboard.$set('downTimer',null);a=TP.core.Keyboard.get('lastDown');if(TP.isEvent(a)){b.$$keyCode=a.$$keyCode;b.$special=a.$special;this.invokeObservers('keydown',a);}}else{a=TP.core.Keyboard.get('lastPress')||TP.core.Keyboard.get('lastDown');if(TP.isEvent(a)){b.$special=a.$special;}}}this.invokeObservers('keyup',b);return;});TP.core.USAscii101Keyboard.Type.defineMethod('isPrintable',function(b){var a;a=TP.eventGetKeyCode(b);if(a>=32&&a<=127&&TP.notTrue(b.$special)){return true;}return false;});TP.core.Device.defineSubtype('Mouse');TP.core.Mouse.Type.defineAttribute('hoverFunc',function(){var a,d,b,e,f,c;TP.core.Mouse.$set('hoverTimer',null);a=TP.core.Mouse.$get('lastMove');if(a===null){return;}if(TP.core.Mouse.$$isDragging(a)){TP.eventSetType(a,'draghover');TP.core.Mouse.invokeObservers('draghover',a);}else{TP.eventSetType(a,'mousehover');TP.core.Mouse.invokeObservers('mousehover',a);}d=TP.core.Mouse.$get('lastOver');b=TP.sys.cfg('mouse.hover_repeat');if(TP.isElement(e=TP.eventGetResolvedTarget(d))){if(TP.isNumber(f=TP.elementGetAttribute(e,'sig:hoverrepeat',true).asNumber())){b=f;}}c=function(){var a,d,e;a=TP.core.Mouse.$get('lastMove');if(a===null){return;}e=TP.core.Mouse.get('observers');if(!e.hasKey('TP.sig.DOMMouseHover')&&!e.hasKey('TP.sig.DOMDragHover')){return;}d=TP.eventGetWindow(a).document;if(!d.hasFocus()||!d.activeElement){return;}if(TP.core.Mouse.$$isDragging(a)){TP.eventSetType(a,'draghover');TP.core.Mouse.invokeObservers('draghover',a);}else{TP.eventSetType(a,'mousehover');TP.core.Mouse.invokeObservers('mousehover',a);}TP.core.Mouse.$set('hoverRepeatTimer',setTimeout(c,b));};TP.core.Mouse.$set('hoverRepeatTimer',setTimeout(c,b));});TP.core.Mouse.Type.defineAttribute('observers',TP.hc());TP.core.Mouse.Type.defineAttribute('redirections',TP.hc());TP.core.Mouse.Type.defineAttribute('clickTimer');TP.core.Mouse.Type.defineAttribute('hoverTimer');TP.core.Mouse.Type.defineAttribute('hoverRepeatTimer');TP.core.Mouse.Type.defineAttribute('$sentDragDown',false);TP.core.Mouse.Type.defineAttribute('leftDown',false);TP.core.Mouse.Type.defineAttribute('middleDown',false);TP.core.Mouse.Type.defineAttribute('rightDown',false);TP.core.Mouse.Type.defineAttribute('lastDown');TP.core.Mouse.Type.defineAttribute('lastMove');TP.core.Mouse.Type.defineAttribute('lastUp');TP.core.Mouse.Type.defineAttribute('lastOver');TP.core.Mouse.Type.defineAttribute('lastOut');TP.core.Mouse.Type.defineAttribute('lastClick');TP.core.Mouse.Type.defineAttribute('lastDblClick');TP.core.Mouse.Type.defineAttribute('lastContextMenu');TP.core.Mouse.Type.defineAttribute('lastMouseWheel');TP.core.Mouse.Type.defineAttribute('mousedown');TP.core.Mouse.Type.defineAttribute('mousemove');TP.core.Mouse.Type.defineAttribute('mouseup');TP.core.Mouse.Type.defineAttribute('mouseover');TP.core.Mouse.Type.defineAttribute('mouseout');TP.core.Mouse.Type.defineAttribute('click');TP.core.Mouse.Type.defineAttribute('dblclick');TP.core.Mouse.Type.defineAttribute('contextmenu');TP.core.Mouse.Type.defineAttribute('mousewheel');TP.core.Mouse.Type.defineAttribute('mousehover');TP.core.Mouse.Type.defineAttribute('dragdown');TP.core.Mouse.Type.defineAttribute('dragmove');TP.core.Mouse.Type.defineAttribute('dragup');TP.core.Mouse.Type.defineAttribute('dragover');TP.core.Mouse.Type.defineAttribute('dragout');TP.core.Mouse.Type.defineAttribute('draghover');TP.core.Mouse.Type.defineMethod('initialize',function(){this.$set('mousedown',TP.sys.require('TP.sig.DOMMouseDown').construct(null,true));this.$set('mousemove',TP.sys.require('TP.sig.DOMMouseMove').construct(null,true));this.$set('mouseup',TP.sys.require('TP.sig.DOMMouseUp').construct(null,true));this.$set('mouseover',TP.sys.require('TP.sig.DOMMouseOver').construct(null,true));this.$set('mouseout',TP.sys.require('TP.sig.DOMMouseOut').construct(null,true));this.$set('click',TP.sys.require('TP.sig.DOMClick').construct(null,true));this.$set('dblclick',TP.sys.require('TP.sig.DOMDblClick').construct(null,true));this.$set('contextmenu',TP.sys.require('TP.sig.DOMContextMenu').construct(null,true));this.$set('mousewheel',TP.sys.require('TP.sig.DOMMouseWheel').construct(null,true));this.$set('mousehover',TP.sys.require('TP.sig.DOMMouseHover').construct(null,true));this.$set('dragdown',TP.sys.require('TP.sig.DOMDragDown').construct(null,true));this.$set('dragmove',TP.sys.require('TP.sig.DOMDragMove').construct(null,true));this.$set('dragup',TP.sys.require('TP.sig.DOMDragUp').construct(null,true));this.$set('dragover',TP.sys.require('TP.sig.DOMDragOver').construct(null,true));this.$set('dragout',TP.sys.require('TP.sig.DOMDragOut').construct(null,true));this.$set('draghover',TP.sys.require('TP.sig.DOMDragHover').construct(null,true));return;});TP.core.Mouse.Type.defineMethod('invokeObservers',function(m,e,n){var l,k,j,a,h,i,d,f,b,c,g;if(!TP.sys.hasInitialized()){return;}if(TP.isElement(l=TP.eventGetResolvedTarget(e))){k='handlePeer'+TP.escapeTypeName(TP.DOM_SIGNAL_TYPE_MAP.at(TP.eventGetType(e)));j=TP.wrap(l).getType();if(TP.canInvoke(j,k)){j[k](l,e);}if(e.defaultPrevented===true){return;}}a=n;if(TP.notValid(a)){if(TP.notValid(a=this.get(m))){TP.ifWarn()?TP.warn('Event singleton not found for: '+m,TP.LOG,arguments):0;return;}a.recycle();a.setEvent(e);a.set('origin',a.get('target'));}h=this.REDIRECTOR;i=this.get('observers');if(TP.notEmpty(d=i.at(a.getSignalName()))){f=d.getSize();for(b=0;b<f;b++){if(a.shouldStop()){break;}c=d.at(b);if(c!==h){a.set('origin',this);}try{TP.handle(c,a);}catch(a){TP.raise(this,'TP.sig.HandlerException',arguments,TP.ec(a));}}}g=a.getName();if(a.getSignalName()!==g){if(TP.notEmpty(d=i.at(g))){a.setSignalName(g);f=d.getSize();for(b=0;b<f;b++){if(a.shouldStop()){break;}c=d.at(b);if(c!==h){a.set('origin',this);}try{TP.handle(c,a);}catch(a){TP.raise(this,'TP.sig.HandlerException',arguments,TP.ec(a));}}}}return a;});TP.core.Mouse.Type.defineMethod('$$handleClick',function(a){var c,b,d,e,f,g;if(TP.isNumber(TP.core.Mouse.$$clickTimer)){return;}c=this.get('lastDown');if(TP.notValid(c)){this.invokeObservers('click',a);return;}if(TP.core.Mouse.$$isDragging(a)){return;}b=TP.sys.cfg('mouse.click_delay');if(TP.isElement(d=TP.eventGetResolvedTarget(a))){if(TP.isNumber(e=TP.elementGetAttribute(d,'sig:clickdelay',true).asNumber())){b=e;}}f=this;g=TP.boot.isUA('IE')?a.copy():a;TP.core.Mouse.$$clickTimer=setTimeout(function(){f.invokeObservers('click',g);TP.core.Mouse.$$clickTimer=undefined;},b);return;});TP.core.Mouse.Type.defineMethod('$$handleContextMenu',function(b){var a;a=this.invokeObservers('contextmenu',b);if(TP.isKindOf(a,'TP.sig.Signal')){if(a.shouldPrevent()){b.preventDefault();}if(a.shouldStop()){b.stopPropagation();}}return;});TP.core.Mouse.Type.defineMethod('$$handleDblClick',function(a){if(TP.isNumber(TP.core.Mouse.$$clickTimer)){clearTimeout(TP.core.Mouse.$$clickTimer);TP.core.Mouse.$$clickTimer=undefined;}this.invokeObservers('dblclick',a);return;});TP.core.Mouse.Type.defineMethod('$$handleMouseEvent',function(c){var a,b;if(c.$captured){return;}c.$captured=true;a=TP.event(c);switch(TP.eventGetType(a)){case'mousedown':b='lastDown';TP.core.Mouse.$set(b,a);TP.core.Mouse.$$handleMouseDown(a);break;case'mousemove':b='lastMove';TP.core.Mouse.$set(b,a);TP.core.Mouse.$$handleMouseMove(a);break;case'mouseup':b='lastUp';TP.core.Mouse.$set(b,a);TP.core.Mouse.$$handleMouseUp(a);break;case'mouseover':b='lastOver';TP.core.Mouse.$set(b,a);TP.core.Mouse.$$handleMouseOver(a);break;case'mouseout':b='lastOut';TP.core.Mouse.$set(b,a);TP.core.Mouse.$$handleMouseOut(a);break;case'click':b='lastClick';TP.core.Mouse.$set(b,a);TP.core.Mouse.$$handleClick(a);break;case'dblclick':b='lastDblClick';TP.core.Mouse.$set(b,a);TP.core.Mouse.$$handleDblClick(a);break;case'contextmenu':b='lastContextMenu';TP.core.Mouse.$set(b,a);TP.core.Mouse.$$handleContextMenu(a);break;case'mousewheel':case'DOMMouseScroll':b='lastMouseWheel';TP.core.Mouse.$set(b,a);TP.core.Mouse.$$handleMouseWheel(a);break;default:return;}if(TP.boot.isUA('IE')&&TP.core.Mouse.get(b)===a){TP.core.Mouse.$set(b,a.copy());}return;});TP.core.Mouse.Type.defineMethod('$$handleMouseDown',function(a){this.$$updateButtonStates(a);this.invokeObservers('mousedown',a);return;});TP.core.Mouse.Type.defineMethod('$$handleMouseMove',function(a){var b;TP.core.Keyboard.getCurrentKeyboard().$$updateModifierStates(a);if(this.$$isDragging(a)){if(TP.notTrue(this.$get('$sentDragDown'))){b=this.get('lastDown').copy();TP.eventSetType(b,'dragdown');this.invokeObservers('dragdown',b);this.$set('$sentDragDown',true);}TP.eventSetType(a,'dragmove');this.invokeObservers('dragmove',a);}else{this.invokeObservers('mousemove',a);}return;});TP.core.Mouse.Type.defineMethod('$$handleMouseWheel',function(a){this.invokeObservers('mousewheel',a);return;});TP.core.Mouse.Type.defineMethod('$$handleMouseUp',function(a){var b;b=this.$$isDragging(a);this.$$updateButtonStates(a);if(b){TP.eventSetType(a,'dragup');this.invokeObservers('dragup',a);this.$set('$sentDragDown',false);}else{this.invokeObservers('mouseup',a);}try{clearTimeout(this.$get('hoverTimer'));clearTimeout(this.$get('hoverRepeatTimer'));}catch(a){}return;});TP.core.Mouse.Type.defineMethod('$$handleMouseOver',function(a){var b,c,d;if(TP.isElement(b=TP.eventGetResolvedTarget(a))){TP.elementSetAttribute(b,'pclass:hover','true',true);}if(this.$$isDragging(a)){TP.eventSetType(a,'dragover');this.invokeObservers('dragover',a);}else{this.invokeObservers('mouseover',a);}c=TP.sys.cfg('mouse.hover_delay');if(TP.isElement(b)){if(TP.isNumber(d=TP.elementGetAttribute(b,'sig:hoverdelay',true).asNumber())){c=d;}}TP.core.Mouse.$set('hoverTimer',setTimeout(this.$get('hoverFunc'),c));return;});TP.core.Mouse.Type.defineMethod('$$handleMouseOut',function(a){var b;if(TP.isElement(b=TP.eventGetResolvedTarget(a))){TP.elementRemoveAttribute(b,'pclass:hover',true);}if(this.$$isDragging(a)){TP.eventSetType(a,'dragout');this.invokeObservers('dragout',a);}else{this.invokeObservers('mouseout',a);}try{clearTimeout(this.$get('hoverTimer'));clearTimeout(this.$get('hoverRepeatTimer'));}catch(a){}return;});TP.core.Mouse.Type.defineMethod('$$isDragging',function(a){var b,f,c,d,e,g,h,i;if(TP.isTrue(this.$get('$sentDragDown'))){return true;}if(this.$get('leftDown')||this.$get('rightDown')||this.$get('middleDown')){b=this.get('lastDown');f=TP.computeDistance(b,a);c=TP.sys.cfg('mouse.drag_distance');d=TP.sys.cfg('mouse.drag_delay');if(TP.isElement(e=TP.eventGetResolvedTarget(a))){if(TP.isNumber(g=TP.elementGetAttribute(e,'sig:dragdistance',true).asNumber())){c=g;}if(TP.isNumber(h=TP.elementGetAttribute(e,'sig:dragdelay',true).asNumber())){d=h;}}i=TP.eventGetTime(a)-TP.eventGetTime(b);return f>=c&&i>=d;}return false;});TP.core.Mouse.Type.defineMethod('$$updateButtonStates',function(b){var c,a;c=TP.button(b);a=b.type==='mousedown'?true:false;switch(c){case TP.LEFT:this.$set('leftDown',a);break;case TP.MIDDLE:this.$set('middleDown',a);break;case TP.RIGHT:this.$set('rightDown',a);break;default:break;}return;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETSignalTypes.js';
TP.lang.Object.defineSubtype('core:Monitor');TP.core.Monitor.addTraitsFrom(TP.core.JobStatus);TP.core.Monitor.Type.defineAttribute('defaultInterval',100);TP.core.Monitor.Type.defineAttribute('defaultSignal');TP.core.Monitor.Type.defineAttribute('defaultTest');TP.core.Monitor.Type.defineAttribute('controlParameters',TP.hc('interval',TP.core.Job.ZERO_DECAY,'limit',TP.core.Job.FOREVER));TP.core.Monitor.Type.defineAttribute('stepParameters',TP.hc());TP.core.Monitor.Type.defineMethod('getDefaultSignal',function(){return this.$get('defaultSignal');});TP.core.Monitor.Type.defineMethod('getDefaultTest',function(){return this.$get('defaultTest');});TP.core.Monitor.Inst.defineAttribute('job');TP.core.Monitor.Inst.defineAttribute('targets');TP.core.Monitor.Inst.defineAttribute('test');TP.core.Monitor.Inst.defineAttribute('notifier');TP.core.Monitor.Inst.defineMethod('init',function(d,e,f){var a,b,c;this.callNextMethod();a=TP.ifInvalid(e,this.getType().getDefaultTest());if(!TP.isCallable(a)){this.raise('TP.sig.InvalidParameter',arguments,'Test must be a runnable function.');return;}this.$set('test',a);b=TP.ifInvalid(f,this.getType().getDefaultSignal());if(TP.notValid(b)){this.raise('TP.sig.InvalidParameter',arguments,'Signal must be valid signal name or type.');return;}this.$set('notifier',b);this.$set('targets',TP.ac());this.addTarget(d);c=this.constructStepFunction();this.constructJob(TP.hc('step',c));return this;});TP.core.Monitor.Inst.defineMethod('addTarget',function(d){var b,e,c,a;if(TP.isArray(d)){b=d;}else{b=TP.ac(d);}e=b.getSize();for(c=0;c<e;c++){a=b.at(c);if(!TP.isString(a)&&!TP.isCallable(a)&&!TP.isKindOf(a,TP.core.URI)){this.raise('TP.sig.InvalidParameter',arguments,'Target must be string ID, URI, or acquisition function.');continue;}this.$get('targets').add(a);}return this;});TP.core.Monitor.Inst.defineMethod('constructJob',function(b){var a;a=TP.core.Job.construct(this.getControlParameters(b));this.$set('job',a);return a;});TP.core.Monitor.Inst.defineMethod('constructStepFunction',function(){var a,c,d,b;a=this.get('targets');c=this.get('test');d=this.get('notifier');b=function(){var g,f,b,e;g=a.getSize();for(f=0;f<g;f++){b=a.at(f);if(TP.isCallable(b)){try{e=b();}catch(a){}}else if(TP.isString(b)){e=TP.sys.getObjectById(b);}else{e=b.getResource();}if(TP.notValid(e)){continue;}try{if(c(e)){TP.signal(e,d);}}catch(a){}}return;};this.$set('stepFunction',b);return b;});TP.core.Monitor.Inst.defineMethod('removeTarget',function(d){var b,e,c,a;if(TP.isArray(d)){b=d;}else{b=TP.ac(d);}e=b.getSize();for(c=0;c<e;c++){a=b.at(c);if(!TP.isString(a)&&!TP.isCallable(a)&&!TP.isKindOf(a,TP.core.URI)){this.raise('TP.sig.InvalidParameter',arguments,'Target must be string ID, URI, or acquisition function.');continue;}this.$get('targets').remove(a);}return this;});TP.core.Monitor.Inst.defineMethod('getControlParameters',function(b){var a;a=this.getType().get('controlParameters').copy();a.atPut('lastInterval',this.getType().get('defaultInterval'));if(TP.isValid(b)){a.addAll(b);}return a;});TP.core.Monitor.Inst.defineMethod('getJob',function(){return this.$get('job');});TP.core.Monitor.Inst.defineMethod('getStepParameters',function(b){var a;a=this.getType().get('stepParameters').copy();if(TP.isValid(b)){a.addAll(b);}return a;});TP.core.Monitor.Inst.defineMethod('cancel',function(a,b){this.getJob().cancel(a,b);return this;});TP.core.Monitor.Inst.defineMethod('complete',function(a){this.getJob().complete(a);return this;});TP.core.Monitor.Inst.defineMethod('fail',function(a,b,c){this.getJob().fail(a,b,c);return this;});TP.core.Monitor.Inst.defineMethod('start',function(a){this.getJob().start(this.getStepParameters(a));return this;});TP.core.Monitor.defineSubtype('ResizeMonitor');TP.core.ResizeMonitor.Type.defineAttribute('defaultSignal','TP.sig.DOMResize');TP.core.ResizeMonitor.Type.defineAttribute('defaultTest',function(f){var a,b,e,c,d;a=TP.elem(f);if(!TP.isElement(a)){return;}b=TP.elementGetAttribute(a,'tibet:old_height',true);e=TP.elementGetAttribute(a,'tibet:old_width',true);c=TP.elementGetHeight(a);d=TP.elementGetWidth(a);TP.elementSetAttribute(a,'tibet:old_height',c,true);TP.elementSetAttribute(a,'tibet:old_width',d,true);if(TP.isEmpty(b)){return false;}if(b!==c||e!==d){return true;}return false;});TP.sig.Signal.defineSubtype('ApplicationSignal');TP.sig.ApplicationSignal.shouldUseSingleton(true);TP.sig.ApplicationSignal.isSignalingRoot(true);TP.sig.ApplicationSignal.defineSubtype('AppStart');TP.sig.ApplicationSignal.defineSubtype('AppWillStart');TP.sig.ApplicationSignal.defineSubtype('AppDidStart');TP.sig.ApplicationSignal.defineSubtype('AppShutdown');TP.sig.ApplicationSignal.defineSubtype('TargetIn');TP.sig.ApplicationSignal.defineSubtype('TargetOut');TP.sig.Signal.defineSubtype('ResponderSignal');TP.sig.ResponderSignal.Type.defineAttribute('defaultPolicy',TP.RESPONDER_FIRING);TP.sig.ResponderSignal.Type.defineAttribute('bubbling',true);TP.sig.ResponderSignal.Type.defineAttribute('cancelable',true);TP.sig.ResponderSignal.Inst.defineAttribute('currentChain');TP.sig.ResponderSignal.Inst.defineMethod('getTargetResponder',function(){var a;if(!TP.isElement(a=this.getContext())){if(!TP.isElement(a=this.getTarget())){return null;}}return TP.wrap(a);});TP.sig.ResponderSignal.defineSubtype('ResponderNotificationSignal');TP.sig.ResponderNotificationSignal.Type.defineAttribute('cancelable',false);TP.sig.ResponderNotificationSignal.defineSubtype('UIDidActivate');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidDeactivate');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidAlert');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidBlur');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidBusy');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidClose');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidCollapse');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidDelete');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidDeselect');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidDuplicate');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidEndEffect');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidExpand');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidFocus');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidPopFocus');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidPushFocus');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidIdle');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidHelp');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidHide');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidHint');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidInsert');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidOpen');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidScroll');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidSelect');TP.sig.ResponderNotificationSignal.defineSubtype('UIDidShow');TP.sig.ResponderSignal.defineSubtype('ResponderInteractionSignal');TP.sig.ResponderInteractionSignal.defineSubtype('UIActivate');TP.sig.ResponderInteractionSignal.defineSubtype('UIDeactivate');TP.sig.ResponderInteractionSignal.defineSubtype('UIFocusChangeSignal');TP.sig.UIFocusChangeSignal.defineSubtype('UIBlur');TP.sig.UIFocusChangeSignal.defineSubtype('UIFocus');TP.sig.UIFocusChangeSignal.defineSubtype('UIFocusAndSelect');TP.sig.ResponderInteractionSignal.defineSubtype('UIFocusComputationSignal');TP.sig.UIFocusComputationSignal.defineSubtype('UIFocusFirst');TP.sig.UIFocusComputationSignal.defineSubtype('UIFocusLast');TP.sig.UIFocusComputationSignal.defineSubtype('UIFocusPrevious');TP.sig.UIFocusComputationSignal.defineSubtype('UIFocusNext');TP.sig.UIFocusComputationSignal.defineSubtype('UIFocusFollowing');TP.sig.UIFocusComputationSignal.defineSubtype('UIFocusPreceding');TP.sig.UIFocusComputationSignal.defineSubtype('UIFocusFirstInGroup');TP.sig.UIFocusComputationSignal.defineSubtype('UIFocusLastInGroup');TP.sig.UIFocusComputationSignal.defineSubtype('UIFocusFirstInNextGroup');TP.sig.UIFocusComputationSignal.defineSubtype('UIFocusFirstInPreviousGroup');TP.sig.ResponderInteractionSignal.defineSubtype('UIShow');TP.sig.ResponderInteractionSignal.defineSubtype('UIHide');TP.sig.ResponderInteractionSignal.defineSubtype('UIClose');TP.sig.ResponderInteractionSignal.defineSubtype('UIOpen');TP.sig.ResponderInteractionSignal.defineSubtype('UICollapse');TP.sig.ResponderInteractionSignal.defineSubtype('UIExpand');TP.sig.ResponderInteractionSignal.defineSubtype('UIBusy');TP.sig.ResponderInteractionSignal.defineSubtype('UIIdle');TP.sig.ResponderInteractionSignal.defineSubtype('UIAlert');TP.sig.ResponderInteractionSignal.defineSubtype('UIHelp');TP.sig.ResponderInteractionSignal.defineSubtype('UIHint');TP.sig.ResponderInteractionSignal.defineSubtype('UIValueChanged');TP.sig.ResponderInteractionSignal.defineSubtype('UISelect');TP.sig.ResponderInteractionSignal.defineSubtype('UIDeselect');TP.sig.ResponderInteractionSignal.defineSubtype('UIScroll');TP.sig.ResponderInteractionSignal.defineSubtype('UIInsert');TP.sig.ResponderInteractionSignal.defineSubtype('UIDelete');TP.sig.ResponderInteractionSignal.defineSubtype('UIDuplicate');TP.sig.ResponderInteractionSignal.defineSubtype('UIValid');TP.sig.ResponderInteractionSignal.defineSubtype('UIInvalid');TP.sig.ResponderInteractionSignal.defineSubtype('UIReadonly');TP.sig.ResponderInteractionSignal.defineSubtype('UIReadwrite');TP.sig.ResponderInteractionSignal.defineSubtype('UIRequired');TP.sig.ResponderInteractionSignal.defineSubtype('UIOptional');TP.sig.ResponderInteractionSignal.defineSubtype('UIEnabled');TP.sig.ResponderInteractionSignal.defineSubtype('UIDisabled');TP.sig.ResponderInteractionSignal.defineSubtype('UIInRange');TP.sig.ResponderInteractionSignal.defineSubtype('UIOutOfRange');TP.sig.Signal.defineSubtype('DOMSignal');TP.sig.DOMSignal.Type.defineAttribute('defaultPolicy',TP.DOM_FIRING);TP.sig.DOMSignal.Type.defineAttribute('bubbling',true);TP.sig.DOMSignal.Type.defineAttribute('cancelable',true);TP.sig.DOMSignal.defineSubtype('DOMInitializationSignal');TP.sig.DOMInitializationSignal.Type.defineAttribute('cancelable',false);TP.sig.DOMSignal.defineSubtype('DOMLoaded');TP.sig.DOMLoaded.defineSubtype('DOMContentLoaded');TP.sig.DOMLoaded.Type.defineMethod('shouldLog',function(){return TP.sys.shouldLogDOMLoadedSignals();});TP.sig.DOMSignal.defineSubtype('DOMInteractionSignal');TP.sig.DOMInteractionSignal.defineSubtype('DOMClose');TP.sig.DOMSignal.defineSubtype('DOMNotificationSignal');TP.sig.DOMNotificationSignal.Type.defineAttribute('cancelable',false);TP.sig.ERROR.defineSubtype('DOMException');TP.sig.DOMException.defineSubtype('ElementNotFound');TP.sig.DOMException.defineSubtype('InvalidMarkup');TP.sig.DOMException.defineSubtype('InvalidNode');TP.sig.DOMException.defineSubtype('InvalidNodeList');TP.sig.DOMException.defineSubtype('InvalidNamedNodeMap');TP.sig.InvalidNode.defineSubtype('InvalidDocument');TP.sig.InvalidNode.defineSubtype('InvalidXMLDocument');TP.sig.InvalidNode.defineSubtype('InvalidAttributeNode');TP.sig.InvalidNode.defineSubtype('InvalidElement');TP.sig.DOMException.defineSubtype('SerializationException');TP.sig.DOMException.defineSubtype('DOMParseException');TP.sig.DOMException.defineSubtype('DOMComponentException');TP.sig.DOMNotificationSignal.defineSubtype('DOMErrorIndicationSignal');TP.sig.DOMErrorIndicationSignal.Inst.defineMethod('getLevel',function(){return TP.ERROR;});TP.sig.DOMErrorIndicationSignal.defineSubtype('DOMOutputError');TP.sig.DOMErrorIndicationSignal.defineSubtype('DOMSubmitError');TP.sig.DOMErrorIndicationSignal.defineSubtype('DOMLinkException');TP.sig.DOMErrorIndicationSignal.defineSubtype('DOMLinkError');TP.sig.DOMErrorIndicationSignal.defineSubtype('DOMComputeException');TP.sig.DOMInteractionSignal.defineSubtype('DOMService');TP.sig.DOMInteractionSignal.defineSubtype('DOMServiceRequestConstruct');TP.sig.DOMInteractionSignal.defineSubtype('DOMServiceRequestConstructDone');TP.sig.DOMInteractionSignal.defineSubtype('DOMServiceResponseConstruct');TP.sig.DOMInteractionSignal.defineSubtype('DOMServiceResponseConstructDone');TP.sig.DOMNotificationSignal.defineSubtype('DOMServiceTransmitDone');TP.sig.DOMNotificationSignal.defineSubtype('DOMServiceDone');TP.sig.DOMErrorIndicationSignal.defineSubtype('DOMServiceError');TP.sig.DOMSignal.defineSubtype('DOMUISignal');TP.sig.DOMUISignal.isSignalingRoot(true);TP.sig.DOMUISignal.Type.defineAttribute('needsArming',false);TP.sig.DOMUISignal.Type.defineAttribute('armingHandler',TP.$dispatchEventToTIBET);TP.sig.DOMUISignal.Type.defineMethod('arm',function(b,e,f,g){var a,c,d;if(!this.requiresArming()){return;}a=TP.ifInvalid(g,TP.nodeGetWindow(b));a=TP.ifInvalid(a,TP.sys.getUICanvas(true));if(TP.isDocument(a)){a=TP.nodeGetWindow(a);}c=TP.ifInvalid(e,this.get('armingHandler'));d=TP.ifInvalid(f,this.get('defaultPolicy'));TP.windowArmNode(a,TP.byId(b,a),this.getSignalName(),c,d);return this;});TP.sig.DOMUISignal.Type.defineMethod('disarm',function(b,d,e){var a,c;if(!this.requiresArming()){return;}a=TP.ifInvalid(e,TP.nodeGetWindow(b));a=TP.ifInvalid(a,TP.sys.getUICanvas(true));if(TP.isDocument(a)){a=TP.nodeGetWindow(a);}c=TP.ifInvalid(d,this.get('armingHandler'));TP.windowDisarmNode(a,TP.byId(b,a),this.getSignalName(),c);return this;});TP.sig.DOMUISignal.Type.defineMethod('requiresArming',function(a){if(TP.isBoolean(a)){this.$set('needsArming',a);}return this.$get('needsArming');});TP.sig.DOMUISignal.Inst.defineMethod('init',function(a,c){var b;this.callNextMethod();if(TP.isTrue(c)&&TP.notValid(a)){return this;}if(TP.isEvent(a)){this.setEvent(TP.event(a));}else if(TP.isArray(a)){b=a.first();if(TP.isEvent(b)){this.setEvent(TP.event(b));}}if(TP.notValid(this.getEvent())){b=this.$fabricateEvent(a);this.setEvent(b);}return this;});TP.sig.DOMUISignal.Inst.defineMethod('copy',function(){var a;a=this.callNextMethod();a.event=this.getEvent().copy();return a;});TP.sig.DOMUISignal.Inst.defineMethod('$fabricateEvent',function(b){var a;a=TP.isKindOf(b,TP.lang.Hash)?b:TP.hc();a.addIfAbsent('target',null,'currentTarget',null,'relatedTarget',null,'type',this.getType().NATIVE_NAME,'timeStamp',new Date().getTime(),'clientX',0,'clientY',0,'offsetX',0,'offsetY',0,'view',null,'pageX',0,'pageY',0,'screenX',0,'screenY',0,'keyCode',0,'altKey',false,'ctrlKey',false,'shiftKey',false,'metaKey',false,'button',0,'wheelDelta',0,'charCode',0,'which',null,'returnValue',false,'cancelBubble',false);return TP.documentCreateEvent(null,a)||a;});TP.sig.DOMUISignal.Inst.defineMethod('getAltKey',function(){return TP.eventGetAltKey(this.getEvent());});TP.sig.DOMUISignal.Inst.defineMethod('getCtrlKey',function(){return TP.eventGetCtrlKey(this.getEvent());});TP.sig.DOMUISignal.Inst.defineMethod('getMetaKey',function(){return TP.eventGetMetaKey(this.getEvent());});TP.sig.DOMUISignal.Inst.defineMethod('getShiftKey',function(){return TP.eventGetShiftKey(this.getEvent());});TP.sig.DOMUISignal.Inst.defineMethod('getEvent',function(){return this.getPayload();});TP.sig.DOMUISignal.Inst.defineMethod('getEventType',function(){return TP.eventGetType(this.getEvent());});TP.sig.DOMUISignal.Inst.defineMethod('getWindow',function(){return TP.eventGetWindow(this.getEvent());});TP.sig.DOMUISignal.Inst.defineMethod('getNativeObject',function(){return this.getEvent();});TP.sig.DOMUISignal.Inst.defineMethod('getResolvedTarget',function(){return TP.eventGetResolvedTarget(this.getEvent());});TP.sig.DOMUISignal.Inst.defineMethod('getTarget',function(){return TP.eventGetTarget(this.getEvent());});TP.sig.DOMUISignal.Inst.defineMethod('setEvent',function(a){this.setPayload(a);return this;});TP.sig.DOMUISignal.Inst.defineMethod('shouldPrevent',function(c){var a,b;a=this.callNextMethod();if(TP.isEvent(b=this.getEvent())){if(TP.isTrue(c)){b.preventDefault();}}return a;});TP.sig.DOMUISignal.defineSubtype('DOMAbort');TP.sig.DOMAbort.Type.defineConstant('NATIVE_NAME','abort');TP.sig.DOMUISignal.defineSubtype('DOMBlur');TP.sig.DOMBlur.Type.defineConstant('NATIVE_NAME','blur');TP.sig.DOMBlur.Type.defineMethod('shouldLog',function(){return TP.sys.shouldLogDOMFocusSignals();});TP.sig.DOMUISignal.defineSubtype('DOMChange');TP.sig.DOMChange.Type.defineConstant('NATIVE_NAME','change');TP.sig.DOMUISignal.defineSubtype('DOMCopy');TP.sig.DOMCopy.Type.defineConstant('NATIVE_NAME','copy');TP.sig.DOMUISignal.defineSubtype('DOMCut');TP.sig.DOMCut.Type.defineConstant('NATIVE_NAME','cut');TP.sig.DOMUISignal.defineSubtype('DOMError');TP.sig.DOMError.Type.defineConstant('NATIVE_NAME','error');TP.sig.DOMUISignal.defineSubtype('DOMFocus');TP.sig.DOMFocus.Type.defineConstant('NATIVE_NAME','focus');TP.sig.DOMFocus.Type.defineMethod('shouldLog',function(){return TP.sys.shouldLogDOMFocusSignals();});TP.sig.DOMUISignal.defineSubtype('DOMLoad');TP.sig.DOMLoad.Type.defineConstant('NATIVE_NAME','load');TP.sig.DOMUISignal.defineSubtype('DOMMove');TP.sig.DOMMove.Type.defineConstant('NATIVE_NAME','move');TP.sig.DOMUISignal.defineSubtype('DOMPaste');TP.sig.DOMPaste.Type.defineConstant('NATIVE_NAME','paste');TP.sig.DOMUISignal.defineSubtype('DOMReset');TP.sig.DOMReset.Type.defineConstant('NATIVE_NAME','reset');TP.sig.DOMUISignal.defineSubtype('DOMResize');TP.sig.DOMResize.Type.defineConstant('NATIVE_NAME','resize');TP.sig.DOMUISignal.defineSubtype('DOMSubmit');TP.sig.DOMSubmit.Type.defineConstant('NATIVE_NAME','submit');TP.sig.DOMUISignal.defineSubtype('DOMUnload');TP.sig.DOMUnload.Type.defineConstant('NATIVE_NAME','unload');TP.sig.DOMUISignal.defineSubtype('DOMFocusIn');TP.sig.DOMFocusIn.Type.defineAttribute('cancelable',false);TP.sig.DOMFocusIn.Type.defineConstant('NATIVE_NAME','focusin');TP.sig.DOMFocusIn.Type.defineMethod('shouldLog',function(){return TP.sys.shouldLogDOMFocusSignals();});TP.sig.DOMUISignal.defineSubtype('DOMFocusOut');TP.sig.DOMFocusOut.Type.defineConstant('NATIVE_NAME','focusout');TP.sig.DOMFocusOut.Type.defineAttribute('cancelable',false);TP.sig.DOMFocusOut.Type.defineMethod('shouldLog',function(){return TP.sys.shouldLogDOMFocusSignals();});TP.sig.DOMUISignal.defineSubtype('DOMMouseSignal');TP.sig.DOMMouseSignal.Type.defineMethod('getSignalOwner',function(){return TP.sys.getTypeByName('TP.core.Mouse');});TP.sig.DOMMouseSignal.Inst.defineMethod('getButton',function(){return TP.eventGetButton(this.getEvent());});TP.sig.DOMMouseSignal.Inst.defineMethod('getClientX',function(){var a;a=this.getEvent();return TP.ifInvalid(a.$$clientX,a.clientX);});TP.sig.DOMMouseSignal.Inst.defineMethod('getClientY',function(){var a;a=this.getEvent();return TP.ifInvalid(a.$$clientY,a.clientY);});TP.sig.DOMMouseSignal.Inst.defineMethod('getClientPoint',function(){var b,a;b=this.getEvent();if(TP.notValid(a=b.$$clientPt)){a=TP.pc(this.getClientX(),this.getClientY());b.$$clientPt=a;}return a;});TP.sig.DOMMouseSignal.Inst.defineMethod('getOffsetX',function(){var a;a=this.getEvent();return TP.ifInvalid(a.$$offsetX,a.offsetX);});TP.sig.DOMMouseSignal.Inst.defineMethod('getOffsetY',function(){var a;a=this.getEvent();return TP.ifInvalid(a.$$offsetY,a.offsetY);});TP.sig.DOMMouseSignal.Inst.defineMethod('getOffsetPoint',function(){var b,a;b=this.getEvent();if(TP.notValid(a=b.$$offsetPt)){a=TP.pc(this.getOffsetX(),this.getOffsetY());b.$$offsetPt=a;}return a;});TP.sig.DOMMouseSignal.Inst.defineMethod('getPageX',function(){var a;a=this.getEvent();return TP.ifInvalid(a.$$pageX,a.pageX);});TP.sig.DOMMouseSignal.Inst.defineMethod('getPageY',function(){var a;a=this.getEvent();return TP.ifInvalid(a.$$pageY,a.pageY);});TP.sig.DOMMouseSignal.Inst.defineMethod('getPagePoint',function(){var b,a;b=this.getEvent();if(TP.notValid(a=b.$$pagePt)){a=TP.pc(this.getPageX(),this.getPageY());b.$$pagePt=a;}return a;});TP.sig.DOMMouseSignal.Inst.defineMethod('getScreenX',function(){var a;a=this.getEvent();return TP.ifInvalid(a.$$screenX,a.screenX);});TP.sig.DOMMouseSignal.Inst.defineMethod('getScreenY',function(){var a;a=this.getEvent();return TP.ifInvalid(a.$$screenY,a.screenY);});TP.sig.DOMMouseSignal.Inst.defineMethod('getScreenPoint',function(){var b,a;b=this.getEvent();if(TP.notValid(a=b.$$screenPt)){a=TP.pc(this.getScreenX(),this.getScreenY());b.$$screenPt=a;}return a;});TP.sig.DOMMouseSignal.Inst.defineMethod('getTransformedPoint',function(){var a,b;a=this.getEvent();if(TP.notValid(b=a.$$transPt)){b=TP.pc(TP.elementGlobalToLocalXY(TP.eventGetTarget(a),a.pageX,a.pageY));a.$$transPt=b;}return b;});TP.sig.DOMMouseSignal.defineSubtype('DOMMouseDown');TP.sig.DOMMouseDown.Type.defineConstant('NATIVE_NAME','mousedown');TP.sig.DOMMouseSignal.defineSubtype('DOMMouseEnter');TP.sig.DOMMouseEnter.Type.defineConstant('NATIVE_NAME','mouseenter');TP.sig.DOMMouseEnter.Inst.defineMethod('getRelatedTarget',function(){return TP.eventGetRelatedTarget(this.getEvent());});TP.sig.DOMMouseSignal.defineSubtype('DOMMouseLeave');TP.sig.DOMMouseLeave.Type.defineConstant('NATIVE_NAME','mouseleave');TP.sig.DOMMouseLeave.Inst.defineMethod('getRelatedTarget',function(){return TP.eventGetRelatedTarget(this.getEvent());});TP.sig.DOMMouseSignal.defineSubtype('DOMMouseUp');TP.sig.DOMMouseUp.Type.defineConstant('NATIVE_NAME','mouseup');TP.sig.DOMMouseSignal.defineSubtype('DOMClick');TP.sig.DOMClick.Type.defineConstant('NATIVE_NAME','click');TP.sig.DOMMouseSignal.defineSubtype('DOMDblClick');TP.sig.DOMDblClick.Type.defineConstant('NATIVE_NAME','dblclick');TP.sig.DOMMouseSignal.defineSubtype('DOMContextMenu');TP.sig.DOMContextMenu.Type.defineConstant('NATIVE_NAME','contextmenu');TP.sig.DOMMouseSignal.defineSubtype('DOMMouseMove');TP.sig.DOMMouseMove.Type.defineConstant('NATIVE_NAME','mousemove');TP.sig.DOMMouseSignal.defineSubtype('DOMMouseOut');TP.sig.DOMMouseOut.Type.defineConstant('NATIVE_NAME','mouseout');TP.sig.DOMMouseOut.Inst.defineMethod('getRelatedTarget',function(){return TP.eventGetRelatedTarget(this.getEvent());});TP.sig.DOMMouseSignal.defineSubtype('DOMMouseOver');TP.sig.DOMMouseOver.Type.defineConstant('NATIVE_NAME','mouseover');TP.sig.DOMMouseOver.Inst.defineMethod('getRelatedTarget',function(){return TP.eventGetRelatedTarget(this.getEvent());});TP.sig.DOMMouseOver.Inst.defineMethod('shouldPrevent',function(c){var a,b;a=this.callNextMethod();if(TP.isEvent(b=this.getEvent())){if(TP.isTrue(c)){b.preventDefault();}}return a;});TP.sig.DOMMouseSignal.defineSubtype('DOMMouseWheel');if(TP.boot.isUA('GECKO')){TP.sig.DOMMouseWheel.Type.defineConstant('NATIVE_NAME','DOMMouseScroll');}if(TP.boot.isUA('IE')||TP.boot.isUA('WEBKIT')){TP.sig.DOMMouseWheel.Type.defineConstant('NATIVE_NAME','mousewheel');}TP.sig.DOMMouseWheel.Type.defineMethod('shouldLog',function(){return false;});TP.sig.DOMMouseWheel.Inst.defineMethod('getDirection',function(){return this.getWheelDelta()>0?TP.UP:TP.DOWN;});TP.sig.DOMMouseWheel.Inst.defineMethod('getWheelDelta',function(){return TP.eventGetWheelDelta(this.getEvent());});TP.sig.DOMMouseSignal.defineSubtype('DOMMouseHover');TP.sig.DOMMouseHover.Inst.defineMethod('setEvent',function(a){this.callNextMethod();a.$$type='mousehover';return this;});TP.sig.DOMUISignal.defineSubtype('DOMKeySignal');TP.sig.DOMKeySignal.shouldUseSingleton(false);TP.sig.DOMKeySignal.Type.defineMethod('getSignalOwner',function(){return TP.sys.getTypeByName('TP.core.Keyboard');});TP.sig.DOMKeySignal.Inst.defineMethod('computeSignalName',function(){return'TP.sig.'+TP.core.Keyboard.getDOMSignalName(this.getEvent());});TP.sig.DOMKeySignal.Inst.defineMethod('getKeyCode',function(){return TP.eventGetKeyCode(this.getEvent());});TP.sig.DOMKeySignal.Inst.defineMethod('getSignalNames',function(){var a;if(TP.notEmpty(a=this.getUnicodeSignalName())){return TP.ac(this.getSignalName(),a,this.getTypeName());}return TP.ac(this.getSignalName(),this.getTypeName());});TP.sig.DOMKeySignal.Inst.defineMethod('getUnicodeSignalName',function(){var a,b,c;a=this.getEvent();if(TP.isEmpty(b=TP.eventGetUnicodeCharCode(a))){return'';}c='TP.sig.DOM_'+TP.core.Keyboard.computeFullSignalName(a,b,TP.eventGetShiftKey(a));return c;});TP.sig.DOMKeySignal.Inst.defineMethod('getVirtualKey',function(){return TP.core.Keyboard.getEventVirtualKey(this.getEvent());});TP.sig.DOMKeySignal.defineSubtype('DOMKeyDown');TP.sig.DOMKeyDown.Type.defineConstant('NATIVE_NAME','keydown');TP.sig.DOMKeySignal.defineSubtype('DOMKeyPress');TP.sig.DOMKeyPress.Type.defineConstant('NATIVE_NAME','keypress');TP.sig.DOMKeySignal.defineSubtype('DOMKeyUp');TP.sig.DOMKeyUp.Type.defineConstant('NATIVE_NAME','keyup');TP.sig.DOMKeySignal.defineSubtype('DOMModifierKeyChange');TP.sig.DOMModifierKeyChange.Inst.defineMethod('getSignalNames',function(){return TP.ac(this.getTypeName());});TP.sig.DOMModifierKeyChange.Inst.defineMethod('setEvent',function(a){this.setPayload(a);return this;});TP.sig.DOMMouseDown.defineSubtype('DOMDragDown');TP.sig.DOMMouseMove.defineSubtype('DOMDragMove');TP.sig.DOMMouseUp.defineSubtype('DOMDragUp');TP.sig.DOMMouseOver.defineSubtype('DOMDragOver');TP.sig.DOMMouseOut.defineSubtype('DOMDragOut');TP.sig.DOMMouseHover.defineSubtype('DOMDragHover');TP.sig.DOMSignal.defineSubtype('DOMDNDSignal');TP.sig.DOMDNDSignal.defineSubtype('DOMDNDInitiate');TP.sig.DOMDNDSignal.defineSubtype('DOMDNDTerminate');TP.sig.DOMDNDSignal.defineSubtype('DOMDNDWillVend');TP.sig.DOMDNDSignal.defineSubtype('DOMDNDWillAccept');TP.sig.DOMDNDSignal.defineSubtype('DOMDNDTargetOver');TP.sig.DOMDNDSignal.defineSubtype('DOMDNDTargetOut');TP.sig.DOMDNDSignal.defineSubtype('DOMDNDCancelled');TP.sig.DOMDNDSignal.defineSubtype('DOMDNDCompleted');TP.sig.DOMDNDSignal.defineSubtype('DOMDNDFailed');TP.sig.DOMDNDSignal.defineSubtype('DOMDNDSucceeded');TP.sig.Signal.defineSubtype('GeoLocationChanged');TP.sig.GeoLocationChanged.Type.defineMethod('getSignalOwner',function(){return TP.sys.getTypeByName('TP.core.Window');});TP.sig.Signal.defineSubtype('CSSMediaChanged');TP.sig.CSSMediaChanged.Type.defineMethod('getSignalOwner',function(){return TP.sys.getTypeByName('TP.core.Window');});TP.sig.CSSMediaChanged.defineSubtype('CSSMediaActive');TP.sig.CSSMediaChanged.defineSubtype('CSSMediaInactive');TP.sig.WARN.defineSubtype('Deprecated');TP.sig.WARN.defineSubtype('DoesNotUnderstand');TP.sig.WARN.defineSubtype('TODO');TP.sig.WARN.defineSubtype('UnsupportedFeature');TP.sig.ERROR.defineSubtype('MissingOverride');TP.sig.ERROR.defineSubtype('InvalidAccessMode');TP.sig.ERROR.defineSubtype('InvalidCollection');TP.sig.ERROR.defineSubtype('InvalidContext');TP.sig.ERROR.defineSubtype('InvalidDirectory');TP.sig.ERROR.defineSubtype('InvalidFrame');TP.sig.ERROR.defineSubtype('InvalidFunction');TP.sig.ERROR.defineSubtype('InvalidModel');TP.sig.ERROR.defineSubtype('InvalidNumber');TP.sig.ERROR.defineSubtype('InvalidOperation');TP.sig.ERROR.defineSubtype('InvalidOrigin');TP.sig.ERROR.defineSubtype('InvalidParameter');TP.sig.ERROR.defineSubtype('InvalidQuery');TP.sig.ERROR.defineSubtype('InvalidRequest');TP.sig.ERROR.defineSubtype('InvalidSignal');TP.sig.ERROR.defineSubtype('InvalidValue');TP.sig.ERROR.defineSubtype('InvalidName');TP.sig.ERROR.defineSubtype('InvalidURI');TP.sig.ERROR.defineSubtype('InvalidWindow');TP.sig.ERROR.defineSubtype('InvalidXML');TP.sig.ERROR.defineSubtype('AccessViolation');TP.sig.ERROR.defineSubtype('MutabilityViolation');TP.sig.ERROR.defineSubtype('PrivilegeViolation');TP.sig.ERROR.defineSubtype('MarshallingException');TP.sig.ERROR.defineSubtype('InheritanceException');TP.sig.InheritanceException.defineSubtype('TypeNotFound');TP.sig.InheritanceException.defineSubtype('InvalidType');TP.sig.InheritanceException.defineSubtype('InvalidInstantiation');TP.sig.InheritanceException.defineSubtype('InvalidOwnerRequest');TP.sig.InheritanceException.defineSubtype('InvalidTrackRequest');TP.sig.InheritanceException.defineSubtype('InvalidFunctionTrack');TP.sig.InheritanceException.defineSubtype('NoOwner');TP.sig.InheritanceException.defineSubtype('NoConcreteType');TP.sig.InheritanceException.defineSubtype('NoMetaInformation');TP.sig.InheritanceException.defineSubtype('NoNextTypeMethod');TP.sig.InheritanceException.defineSubtype('NoNextInstMethod');TP.sig.InheritanceException.defineSubtype('NoNextTypeLocalMethod');TP.sig.InheritanceException.defineSubtype('NoNextInstLocalMethod');TP.sig.InheritanceException.defineSubtype('NoNextGlobalMethod');TP.sig.ERROR.defineSubtype('CollectionException');TP.sig.CollectionException.defineSubtype('InvalidArrayOperation');TP.sig.CollectionException.defineSubtype('InvalidHashOperation');TP.sig.CollectionException.defineSubtype('InvalidStringOperation');TP.sig.CollectionException.defineSubtype('InvalidCollectionRequest');TP.sig.InvalidCollectionRequest.defineSubtype('InvalidKeyRequest');TP.sig.InvalidCollectionRequest.defineSubtype('InvalidItemRequest');TP.sig.InvalidCollectionRequest.defineSubtype('InvalidPairRequest');TP.sig.InvalidCollectionRequest.defineSubtype('InvalidValueRequest');TP.sig.CollectionException.defineSubtype('IndexException');TP.sig.IndexException.defineSubtype('InvalidIndex');TP.sig.IndexException.defineSubtype('NotFound');TP.sig.CollectionException.defineSubtype('ItemException');TP.sig.ItemException.defineSubtype('InvalidItem');TP.sig.ItemException.defineSubtype('InvalidPair');TP.sig.CollectionException.defineSubtype('KeyException');TP.sig.KeyException.defineSubtype('InvalidKey');TP.sig.KeyException.defineSubtype('DuplicateKey');TP.sig.Signal.defineSubtype('InvocationSignal');TP.sig.InvocationSignal.defineSubtype('InvokeNext');TP.sig.InvocationSignal.defineSubtype('InvokeComplete');TP.sig.ERROR.defineSubtype('InvokeFailed');TP.sig.ERROR.defineSubtype('IOException');TP.sig.IOException.defineSubtype('ConnectionFailed');TP.sig.IOException.defineSubtype('URIException');TP.sig.URIException.defineSubtype('URINotFound');TP.sig.URIException.defineSubtype('URIComponentException');TP.sig.ERROR.defineSubtype('ResourceException');TP.sig.ERROR.defineSubtype('TemplateTokenizationFailed');TP.sig.ERROR.defineSubtype('TemplateCompilationFailed');TP.sig.ERROR.defineSubtype('TransformFailed');TP.sig.Exception.defineSubtype('ServiceException');TP.sig.ServiceException.defineSubtype('ServiceUnavailable');TP.sig.ServiceException.defineSubtype('RequestNotFound');TP.sig.Signal.defineSubtype('InputNull');TP.sig.ERROR.defineSubtype('XSLTException');
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETHTTPTypes.js';
TP.sig.URIRequest.defineSubtype('HTTPRequest');TP.sig.HTTPRequest.Type.defineAttribute('responseType','TP.sig.HTTPResponse');TP.sig.HTTPRequest.Inst.defineMethod('failJob',function(e,f){var d,b,c,a;if(TP.isXHR(d=this.at('xhr'))){TP.httpAbort(d);}b=e+' '+f;this.atPut('direction',TP.RECV);this.atPut('message',TP.isEmpty(b)?'HTTP request aborted.':'HTTP request aborted: '+b);TP.ifInfo(TP.sys.shouldLogIO())?TP.sys.logIO(this,TP.INFO,arguments):0;c=this.at('finaluri');if(TP.isURI(c)){a=TP.uc(c);if(TP.isURI(a)){a.isLoaded(false);a.isDirty(true);}}return this.callNextMethod();});TP.sig.HTTPRequest.Inst.defineMethod('cancelJob',function(e,f){var d,b,c,a;if(TP.isXHR(d=this.at('xhr'))){TP.httpAbort(d);}b=e+' '+f;this.atPut('direction',TP.RECV);this.atPut('message',TP.isEmpty(b)?'HTTP request cancelled.':'HTTP request cancelled: '+b);TP.ifInfo(TP.sys.shouldLogIO())?TP.sys.logIO(this,TP.INFO,arguments):0;c=this.at('finaluri');if(TP.isURI(c)){a=TP.uc(c);if(TP.isURI(a)){a.isLoaded(false);a.isDirty(true);}}return this.callNextMethod();});TP.sig.HTTPRequest.Inst.defineMethod('completeJob',function(e){var d,c,a,b;if(TP.isXHR(d=this.at('xhr'))){c=this.at('finaluri');if(TP.isURI(c)){a=TP.uc(c);if(TP.isURI(a)){a.updateHeaders(d);b=a.updateResourceCache(this);a.isLoaded(true);a.isDirty(false);}}}b=b||e;this.set('result',b);return this.callNextMethod(b);});TP.sig.HTTPRequest.Inst.defineMethod('handleIOFailed',function(c){var b,d,a,e,g,f;b=c.getPayload();if(TP.isValid(b)){d=b.at('xhr');this.atPut('xhr',d);}try{a=d.status;this.set('faultCode',a);this.set('faultText',d.statusText);if(TP.canInvoke(b,'handle'+a)){e=true;b['handle'+a](c);}else if(TP.canInvoke(this,'handle'+a)){e=true;this['handle'+a](c);}}catch(a){}finally{if(TP.notTrue(e)){if(TP.isValid(g=this.getFaultCode())){this.fail(g,this.getFaultText());}else{f=c.getResult();if(TP.isValid(f)){this.complete(f);}else{this.complete();}}}}return this;});TP.sig.HTTPRequest.Inst.defineMethod('handleIOSucceeded',function(c){var a,d,b,e,g,f;a=c.getPayload();if(TP.isValid(a)){d=a.at('xhr');this.atPut('xhr',d);}try{b=d.status;if(TP.canInvoke(a,'handle'+b)){e=true;a['handle'+b](c);}else if(TP.canInvoke(this,'handle'+b)){e=true;this['handle'+b](c);}}catch(a){}finally{if(TP.notTrue(e)){if(TP.isValid(g=this.getFaultCode())){this.fail(g,this.getFaultText());}else{f=c.getResult();if(TP.isValid(f)){this.complete(f);}else{this.complete();}}}}return this;});TP.sig.URIResponse.defineSubtype('HTTPResponse');TP.sig.HTTPResponse.Inst.defineAttribute('responseXML');TP.sig.HTTPResponse.Inst.defineMethod('getFaultCode',function(){var a,b;a=this.getRequest().at('xhr');if(TP.isXHR(a)){if(!TP.httpDidSucceed(a)){try{b=a.status;}catch(a){b=null;}finally{return b;}}}return;});TP.sig.HTTPResponse.Inst.defineMethod('getFaultText',function(){var a;a=this.getRequest().at('xhr');if(TP.isXHR(a)){if(!TP.httpDidSucceed(a)){return a.statusText;}}return;});TP.sig.HTTPResponse.Inst.defineMethod('getNativeObject',function(){return this.getRequest().at('xhr');});TP.sig.HTTPResponse.Inst.defineMethod('getResponseHeader',function(c){var a,b;a=this.getNativeObject();if(TP.notValid(a)){return;}try{b=a.getResponseHeader(c);}catch(a){return;}return b;});TP.sig.HTTPResponse.Inst.defineMethod('getResponseHeaders',function(){var b,g,c,d,a,e,f,h;b=this.getNativeObject();if(TP.notValid(b)){return;}g=b.getAllResponseHeaders();c=TP.hc();d=g.split('\n');for(a=0;a<d.getSize();a++){e=d.at(a).split(':');f=e.shift();h=e.join(':');if(TP.notEmpty(f)){c.atPut(f,h);}}return c;});TP.sig.HTTPResponse.Inst.defineMethod('getResponseStatusCode',function(){var a;a=this.getNativeObject();if(TP.notValid(a)){return;}try{return a.status;}catch(a){}return;});TP.sig.HTTPResponse.Inst.defineMethod('getResponseStatusText',function(){var a;a=this.getNativeObject();if(TP.notValid(a)){return;}try{return a.statusText;}catch(a){}return;});TP.sig.HTTPResponse.Inst.defineMethod('getResponseText',function(){var a,b;a=this.getNativeObject();if(TP.notValid(a)){return;}try{b=a.responseText;}catch(a){}return b;});TP.sig.HTTPResponse.Inst.defineMethod('getResponseXML',function(){var a,b,c;if(TP.isNode(a=this.$get('responseXML'))){return a;}b=this.getNativeObject();if(TP.notValid(b)){return;}try{c=b.responseText;if(TP.notEmpty(c)){a=TP.documentFromString(c,null,false);}}catch(b){a=null;}if(TP.isNode(a)){this.$set('responseXML',a);}return a;});TP.sig.HTTPResponse.Inst.defineMethod('getResult',function(b){var a;switch(b){case TP.DOM:return this.getResponseXML();case TP.TEXT:return this.getResponseText();case TP.NATIVE:return this.getRequest().at('xhr');default:a=this.getResponseXML();if(TP.notValid(a)){a=this.getResponseText();}return a;}});TP.core.URIService.defineSubtype('HTTPService');TP.core.HTTPService.Type.defineAttribute('mimetype',TP.PLAIN_TEXT_ENCODED);TP.core.HTTPService.Type.defineAttribute('verb',TP.HTTP_GET);TP.core.HTTPService.Type.defineAttribute('supportedModes',TP.core.SyncAsync.DUAL_MODE);TP.core.HTTPService.Type.defineAttribute('mode',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.HTTPService.Inst.defineMethod('finalizeRequest',function(b){var a,e,c,d;a=b.at('mimetype');if(a===TP.MP_RELATED_ENCODED||a===TP.MP_FORMDATA_ENCODED){e=b.at('body');c=/--([$\w]+)--/.match(e);d=b.at('headers');if(TP.notEmpty(c.at(1))){d.atPut('Content-Type',TP.join(a,'; boundary="',c.at(1),'"'));}else{d.atPut('Content-Type',a);}}return b;});TP.core.HTTPService.Inst.defineMethod('getMIMEType',function(){return TP.ifInvalid(this.$get('mimetype'),this.getType().get('mimetype'));});TP.core.HTTPService.Inst.defineMethod('getVerb',function(){return TP.ifInvalid(this.$get('verb'),this.getType().get('verb'));});TP.core.HTTPService.Inst.defineMethod('handleHTTPRequest',function(b){var a,c,d;if(!TP.isKindOf(b,'TP.sig.HTTPRequest')){this.raise('TP.sig.InvalidRequest',arguments);return;}this.updateServiceURI(b);a=b;a.atPut('uri',this.rewriteRequestURI(a));c=a.at('uri');if(TP.notValid(c)){return a.fail(TP.FAILURE,'TP.sig.InvalidURI');}a.atPut('verb',this.rewriteRequestVerb(a));a.atPut('async',this.rewriteRequestMode(a));a.atPut('mimetype',this.rewriteRequestMIMEType(a));a.atPut('body',this.rewriteRequestBody(a));a.atPut('headers',this.rewriteRequestHeaders(a));a=this.finalizeRequest(a);d=a.constructResponse();this.performHTTPCall(a);return d;});TP.core.HTTPService.Inst.defineMethod('performHTTPCall',function(a){var b,c;b=a.at('uri');if(TP.notValid(b)){return a.fail(TP.FAILURE,'TP.sig.InvalidURI');}try{c=TP.httpCall(b,a);}catch(c){a.atPut('object',c);a.atPut('message',TP.str(c));return TP.httpError(b,TP.ifKeyInvalid(a,'exceptionType','HTTPException'),arguments,a);}return a;});TP.core.HTTPService.Inst.defineMethod('rewriteRequestBody',function(a){return TP.httpEncodeRequestBody(a);});TP.core.HTTPService.Inst.defineMethod('rewriteRequestMIMEType',function(a){return TP.ifEmpty(a.at('mimetype'),TP.ifEmpty(this.$get('mimetype'),TP.ietf.Mime.guessMIMEType(a.at('body'),a.at('uri'),this.getType().get('mimetype'))));});TP.core.HTTPService.Inst.defineMethod('rewriteRequestHeaders',function(a){var b,c;b=TP.ifInvalid(a.at('headers'),TP.hc());c=a.at('uri');if(TP.notValid(c)){return a.fail(TP.FAILURE,'TP.sig.InvalidURI');}if(TP.uriNeedsPrivileges(c)&&TP.sys.cfg('tibet.simple_cors_only')){}else{b.atPutIfAbsent('X-Request-Id',a.getRequestID());}b.atPutIfAbsent('Content-Type',a.at('mimetype'));return b;});TP.core.HTTPService.Inst.defineMethod('rewriteRequestVerb',function(a){return TP.ifEmpty(a.at('verb'),this.getVerb());});TP.sig.HTTPRequest.defineSubtype('HTTPLoadRequest');TP.sig.HTTPRequest.defineSubtype('HTTPNukeRequest');TP.sig.HTTPRequest.defineSubtype('HTTPSaveRequest');
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETWebSocketTypes.js';
TP.sig.URIRequest.defineSubtype('WebSocketRequest');TP.sig.WebSocketRequest.Type.defineAttribute('responseType','TP.sig.WebSocketResponse');TP.sig.WebSocketRequest.Inst.defineMethod('failJob',function(e,f){var d,b,c,a;if(TP.isValid(d=this.at('wsObj'))){TP.webSocketAbort(d);}b=e+' '+f;this.atPut('direction',TP.RECV);this.atPut('message',TP.isEmpty(b)?'WebSocket request aborted.':'WebSocket request aborted: '+b);TP.ifInfo(TP.sys.shouldLogIO())?TP.sys.logIO(this,TP.INFO,arguments):0;c=this.at('finaluri');if(TP.isURI(c)){a=TP.uc(c);if(TP.isURI(a)){a.isLoaded(false);a.isDirty(true);}}return this.callNextMethod();});TP.sig.WebSocketRequest.Inst.defineMethod('cancelJob',function(e,f){var d,b,c,a;if(TP.isValid(d=this.at('wsObj'))){TP.webSocketAbort(d);}b=e+' '+f;this.atPut('direction',TP.RECV);this.atPut('message',TP.isEmpty(b)?'WebSocket request cancelled.':'WebSocket request cancelled: '+b);TP.ifInfo(TP.sys.shouldLogIO())?TP.sys.logIO(this,TP.INFO,arguments):0;c=this.at('finaluri');if(TP.isURI(c)){a=TP.uc(c);if(TP.isURI(a)){a.isLoaded(false);a.isDirty(true);}}return this.callNextMethod();});TP.sig.WebSocketRequest.Inst.defineMethod('completeJob',function(d){var e,c,a,b;if(TP.isValid(e=this.at('wsObj'))){c=this.at('finaluri');if(TP.isURI(c)){a=TP.uc(c);if(TP.isURI(a)){b=a.updateResourceCache(this);a.isLoaded(true);a.isDirty(false);}}}b=b||d;this.set('result',b);return this.callNextMethod(b);});TP.sig.WebSocketRequest.Inst.defineMethod('handleIOFailed',function(d){var a,b,e,f,c;a=d.getPayload();if(TP.isValid(a)){b=a.at('wsObj');this.atPut('wsObj',b);}e=b.status;this.set('faultCode',e);if(TP.isValid(f=this.getFaultCode())){this.fail(f,this.getFaultText());}else{c=d.getResult();if(TP.isValid(c)){this.complete(c);}else{this.complete();}}return this;});TP.sig.WebSocketRequest.Inst.defineMethod('handleIOSucceeded',function(c){var a,d,b;a=c.getPayload();if(TP.isValid(a)){d=a.at('wsObj');this.atPut('wsObj',d);}b=c.getResult();if(TP.isValid(b)){this.complete(b);}else{this.complete();}return this;});TP.sig.URIResponse.defineSubtype('WebSocketResponse');TP.sig.WebSocketResponse.Inst.defineAttribute('responseData');TP.sig.WebSocketResponse.Inst.defineAttribute('statusCode');TP.sig.WebSocketResponse.Inst.defineAttribute('statusText');TP.sig.WebSocketResponse.Inst.defineMethod('getNativeObject',function(){return this.getRequest().at('wsObj');});TP.sig.WebSocketResponse.Inst.defineMethod('getResponseStatusCode',function(){return this.get('statusCode');});TP.sig.WebSocketResponse.Inst.defineMethod('getResponseStatusText',function(){return this.get('statusText');});TP.sig.WebSocketResponse.Inst.defineMethod('getResponseText',function(){var a;if(TP.isString(a=this.get('responseData'))){return a;}return;});TP.sig.WebSocketResponse.Inst.defineMethod('getResponseXML',function(){var b,a;if(TP.isNode(a=this.$get('responseXML'))){return a;}if(TP.notValid(b=this.getResponseText())){return;}if(TP.notEmpty(b)){a=TP.documentFromString(b,null,false);}if(TP.isNode(a)){this.$set('responseXML',a);}return a;});TP.sig.WebSocketResponse.Inst.defineMethod('getResult',function(b){var a;switch(b){case TP.DOM:return this.getResponseXML();case TP.TEXT:return this.getResponseText();case TP.NATIVE:return this.getRequest().at('wsObj');default:a=this.getResponseXML();if(TP.notValid(a)){a=this.getResponseText();}return a;}});TP.core.URIService.defineSubtype('WebSocketService');TP.core.WebSocketService.Type.defineAttribute('supportedModes',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.WebSocketService.Type.defineAttribute('mode',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.WebSocketService.Inst.defineMethod('finalizeRequest',function(a){return a;});TP.core.WebSocketService.Inst.defineMethod('handleWebSocketRequest',function(b){var a,c,d;if(!TP.isKindOf(b,'TP.sig.WebSocketRequest')){this.raise('TP.sig.InvalidRequest',arguments);return;}this.updateServiceURI(b);a=b;a.atPut('uri',this.rewriteRequestURI(a));c=a.at('uri');if(TP.notValid(c)){return a.fail(TP.FAILURE,'TP.sig.InvalidURI');}a.atPut('body',this.rewriteRequestBody(a));a=this.finalizeRequest(a);d=a.constructResponse();this.performWebSocketCall(a);return d;});TP.core.WebSocketService.Inst.defineMethod('performWebSocketCall',function(a){var b;b=TP.uc(a.at('uri'));if(TP.notValid(b)){return a.fail(TP.FAILURE,'TP.sig.InvalidURI');}try{if(TP.notValid(b.get('webSocketObj'))){TP.webSocketCreate(b,function(){TP.webSocketCall(b,a);});}else{TP.webSocketCall(b,a);}}catch(c){a.atPut('object',c);a.atPut('message',TP.str(c));return TP.webSocketError(b,TP.ifKeyInvalid(a,'exceptionType','WebSocketException'),arguments,a);}return a;});TP.core.WebSocketService.Inst.defineMethod('rewriteRequestBody',function(b){var a;a=b.at('body');if(TP.notValid(a)){return;}if(TP.isTrue(b.at('noencode'))){return a;}return a;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETContentTypes.js';
TP.lang.Object.Type.defineMethod('constructContentObject',function(b,a){return this.construct(a);});TP.lang.Object.defineSubtype('core:CSSStyleSheet');TP.core.CSSStyleSheet.Type.defineMethod('constructContentObject',function(a,b){return this.construct(a,b);});TP.core.CSSStyleSheet.Inst.defineAttribute('sourceURI');TP.core.CSSStyleSheet.Inst.defineAttribute('cssSheet');TP.core.CSSStyleSheet.Inst.defineMethod('init',function(a,b){this.callNextMethod();this.set('sourceURI',a);this.set('cssSheet',b);return this;});TP.lang.Object.defineSubtype('core:JSONContent');TP.core.JSONContent.Type.defineMethod('constructContentObject',function(b,a){return this.construct(a);});TP.core.JSONContent.Type.defineMethod('fromObject',function(a){return TP.js2json(a);});TP.core.JSONContent.Type.defineMethod('fromNode',function(a){return TP.xml2json(a);});TP.core.JSONContent.Type.defineMethod('fromTP_core_Node',function(a){return TP.xml2json(a.getNativeNode());});TP.core.JSONContent.Type.defineMethod('reconstitute',function(a){return TP.json2js(a);});TP.core.JSONContent.Type.defineMethod('validate',function(a){return TP.notEmpty(TP.json2js(a));});TP.core.JSONContent.Inst.defineAttribute('data');TP.core.JSONContent.Inst.defineMethod('init',function(a){var b;this.callNextMethod();if(TP.isString(a)&&TP.notEmpty(a)){b=TP.json2js(a);}else{b=a;}this.set('data',b);return this;});TP.lang.Object.defineSubtype('core:AccessPath');TP.core.AccessPath.isAbstract(true);TP.definePrimitive('apc',function(a,b){return TP.core.AccessPath.construct(a,b);});TP.core.AccessPath.Type.defineAttribute('$observedAddresses');TP.core.AccessPath.Type.defineAttribute('$executedPaths');TP.core.AccessPath.Type.defineAttribute('$changedAddresses');TP.core.AccessPath.Type.defineMethod('construct',function(a,b){if(a.isAccessPath()){return a;}return this.callNextMethod();});TP.core.AccessPath.Type.defineMethod('getConcreteType',function(b){var a;if(TP.isEmpty(a=b)){return TP.raise(this,'TP.sig.InvalidPath',arguments,'Unable to create an empty path.');}if(TP.regex.HAS_ACP.test(a)){TP.regex.ACP_NUMERIC.lastIndex=0;a=a.replace(TP.regex.ACP_NUMERIC,TP.DEFAULT);if(TP.regex.HAS_ACP.test(a)){return this.raise('TP.sig.InvalidPath',arguments);}TP.regex.ACP_NUMERIC.lastIndex=0;a=b.replace(TP.regex.ACP_NUMERIC,'0');}if(TP.regex.TIBET_POINTER.test(a)){a=TP.regex.TIBET_POINTER.match(a);if(TP.regex.TIBET_PATH.test(a.at(1))){return TP.core.ComplexTIBETPath;}else{return TP.core.SimpleTIBETPath;}}if(TP.regex.BARENAME.test(a)){return TP.core.BarenamePath;}if(TP.regex.XPOINTER.test(a)){if(TP.regex.ELEMENT_POINTER.test(a)){return TP.core.ElementPath;}else{return TP.core.XPathPath;}}if(TP.regex.XTENSION_POINTER.test(a)){return TP.core.XTensionPath;}if(TP.regex.ATTRIBUTE.test(a)){return TP.core.SimpleXMLPath;}if(TP.regex.ONLY_WORD.test(a)){return TP.core.SimpleTIBETPath;}if(TP.regex.TIBET_PATH.test(a)){return TP.core.ComplexTIBETPath;}if(TP.regex.XPATH_PATH.test(a)||TP.regex.HAS_SLASH.test(a)){return TP.core.XPathPath;}return TP.core.CSSPath;});TP.core.AccessPath.Type.defineMethod('$getExecutedPaths',function(){var a;if(TP.notValid(a=this.$get('$executedPaths'))){a=TP.hc();this.set('$executedPaths',a);}return a;});TP.core.AccessPath.Type.defineMethod('$getChangedAddresses',function(){var a;if(TP.notValid(a=this.$get('$changedAddresses'))){a=TP.ac();this.set('$changedAddresses',a);}return a;});TP.core.AccessPath.Type.defineMethod('$getObservedAddresses',function(){var a;if(TP.notValid(a=this.$get('$observedAddresses'))){a=TP.hc();this.set('$observedAddresses',a);}return a;});TP.core.AccessPath.Type.defineMethod('registerChangedAddress',function(a,b){TP.core.AccessPath.$getChangedAddresses().push(TP.hc('address',a,'action',b));return this;});TP.core.AccessPath.Type.defineMethod('registerObservedAddress',function(d,e,f){var b,c,a;b=TP.core.AccessPath.$getObservedAddresses();c=b.atPutIfAbsent(e,TP.hc());a=c.atPutIfAbsent(d,TP.ac());a.add(f);a.unique();return this;});TP.core.AccessPath.Inst.defineAttribute('srcPath');TP.core.AccessPath.Inst.defineAttribute('shouldMake');TP.core.AccessPath.Inst.defineAttribute('packageWith');TP.core.AccessPath.Inst.defineAttribute('shouldCollapse');TP.core.AccessPath.Inst.defineAttribute('extractWith');TP.core.AccessPath.Inst.defineAttribute('fallbackWith');TP.core.AccessPath.Inst.defineAttribute('$invalidatedPaths');TP.core.AccessPath.Inst.defineAttribute('$addressesToRemove');TP.core.AccessPath.Inst.defineMethod('init',function(a,b){this.callNextMethod();this.set('srcPath',a);this.set('shouldMake',false);this.set('shouldCollapse',TP.ifInvalid(b,false));this.set('$invalidatedPaths',TP.ac());this.set('$addressesToRemove',TP.ac());return this;});TP.core.AccessPath.Inst.defineMethod('asSource',function(){var a,b;a=TP.tname(this)+'.construct(\''+this.get('srcPath')+'\')';if((b=this.get('shouldMake'))===true){a+='.set(\'shouldMake\', '+b+')';}if((b=this.get('shouldCollapse'))===true){a+='.set(\'shouldCollapse\', '+b+')';}return a;});TP.core.AccessPath.Inst.defineMethod('asDumpString',function(){var b,a;b=this.$get('srcPath').asString();try{a=TP.tname(this)+' :: '+'('+b+')';}catch(b){a=this.toString();}return a;});TP.core.AccessPath.Inst.defineMethod('asHTMLString',function(){return'<span class="TP_core_AccessPath '+TP.escapeTypeName(TP.tname(this))+'">'+this.asString()+'</span>';});TP.core.AccessPath.Inst.defineMethod('asJSONSource',function(){var a;try{a='{"type":'+TP.tname(this).quoted('"')+','+'"data":'+this.$get('srcPath').asString().quoted('"')+'}';}catch(b){a=this.toString();}return a;});TP.core.AccessPath.Inst.defineMethod('asPrettyString',function(){return'<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+'<dt class="pretty key">Path:</dt>'+'<dd class="pretty value">'+this.asString()+'</dd>'+'</dl>';});TP.core.AccessPath.Inst.defineMethod('asString',function(){return this.get('srcPath');});TP.core.AccessPath.Inst.defineMethod('asXMLString',function(){return'<instance type="'+TP.tname(this)+'"'+' path="'+this.asString()+'"/>';});TP.core.AccessPath.Inst.defineMethod('isAccessPath',function(){return true;});TP.core.AccessPath.Inst.defineMethod('executeGet',function(a,b){return TP.override();});TP.core.AccessPath.Inst.defineMethod('executeSet',function(a,b,c,d){return TP.override();});TP.core.AccessPath.Inst.defineMethod('getFirstSimplePath',function(){return TP.override();});TP.core.AccessPath.Inst.defineMethod('processFinalValue',function(f,g){var a,h,c,d,b,e;if(TP.isValid(a=f)){if(h=this.get('shouldCollapse')){a=TP.collapse(a);}if(TP.isValid(c=this.get('extractWith'))){if(TP.isCollection(a)){d=TP.keys(a);d.perform(function(b){a.atPut(b,TP.val(a.at(b),c));});}else{a=TP.val(a,c);}}if(TP.isValid(b=this.get('packageWith'))){if(TP.isCallable(b)){a=b(a);}else if(TP.isType(b)){a=b.construct(a);}else if(TP.isString(b)&&TP.isType(b=b.asType())){a=b.construct(a);}}}else if(TP.isCallable(e=this.get('fallbackWith'))){a=e(g);}return a;});TP.core.AccessPath.Inst.defineMethod('updateRegistrationsAfterSignaling',function(b){var c,e,a,d;c=TP.core.AccessPath.$getObservedAddresses().at(TP.id(b));if(TP.isEmpty(c)){return this;}e=TP.core.AccessPath.$getExecutedPaths().at(TP.id(b));a=this.get('$invalidatedPaths');d=this.get('$addressesToRemove');c.removeKeys(d);e.removeAll(a);a.perform(function(a){TP.apc(a).executeGet(b);});a.empty();d.empty();return this;});TP.core.AccessPath.Inst.defineMethod('updateRegistrationsBeforeSignaling',function(f){var b,c,e,a,d;b=TP.core.AccessPath.$getObservedAddresses().at(TP.id(f));if(TP.isEmpty(b)){return this;}c=TP.keys(b);e=TP.core.AccessPath.$getChangedAddresses();a=this.get('$invalidatedPaths');d=this.get('$addressesToRemove');e.perform(function(i){var g,f,h,e;g=i.at('address');h=c.getSize();for(f=0;f<h;f++){e=c.at(f);if(!b.hasKey(e)){continue;}if(e===g){continue;}else if(e.startsWith(g)){a=a.concat(b.at(e));d.push(e);TP.core.AccessPath.registerChangedAddress(e,TP.DELETE);}}});a=a.unique();this.set('$invalidatedPaths',a);this.set('$addressesToRemove',d);return this;});TP.core.AccessPath.Inst.defineMethod('sendChangedSignal',function(a){var e,b,f,c,d;e=TP.core.AccessPath.$getObservedAddresses();b=e.at(TP.id(a));if(TP.isEmpty(b)){this.executeGet(a);b=e.at(TP.id(a));if(TP.isEmpty(b)){return this;}}else{f=TP.core.AccessPath.$getExecutedPaths().at(TP.id(a));if(TP.notValid(f)||TP.notValid(f.at(this.get('srcPath')))){this.executeGet(a);}}c=TP.core.AccessPath.$getChangedAddresses();d=TP.hc();b.perform(function(g){var h,e,a,b,i,f;h=g.first();e=g.last();for(a=0;a<c.getSize();a++){if(c.at(a).at('address')===h){for(b=0;b<e.getSize();b++){f=c.at(a);if(TP.isArray(i=d.at(e.at(b)))){i.push(f);}else{d.atPut(e.at(b),TP.ac(f));}}}}});a.changed('value',TP.UPDATE,TP.hc(TP.CHANGE_PATHS,d),true);return this;});TP.core.AccessPath.defineSubtype('SimpleTIBETPath');TP.core.SimpleTIBETPath.Type.defineAttribute('$traversalLevel');TP.core.SimpleTIBETPath.Type.defineAttribute('$prefixParts');TP.core.SimpleTIBETPath.Type.defineAttribute('$currentSource');TP.core.SimpleTIBETPath.Type.defineAttribute('$currentPath');TP.core.SimpleTIBETPath.Type.defineMethod('initialize',function(){this.Type.set('$traversalLevel',0);this.Type.set('$prefixParts',TP.ac());return;});TP.core.SimpleTIBETPath.Type.defineMethod('endChangedAddress',function(){this.get('$prefixParts').pop();return this;});TP.core.SimpleTIBETPath.Type.defineMethod('endObservedAddress',function(){this.get('$prefixParts').pop();return this;});TP.core.SimpleTIBETPath.Type.defineMethod('getChangedAddress',function(){return this.get('$prefixParts').join('.');});TP.core.SimpleTIBETPath.Type.defineMethod('startChangedAddress',function(b){var a;a=this.get('$prefixParts');a.push(b);return this;});TP.core.SimpleTIBETPath.Type.defineMethod('startObservedAddress',function(d){var a,b,c;a=this.get('$prefixParts');a.push(d);b=TP.id(TP.core.SimpleTIBETPath.get('$currentSource'));c=TP.core.SimpleTIBETPath.get('$currentPath').get('srcPath');this.registerObservedAddress(a.join('.'),b,c);return this;});TP.core.SimpleTIBETPath.Inst.defineMethod('init',function(a,c){var b;if(TP.regex.TIBET_POINTER.test(a)){b=TP.regex.TIBET_POINTER.match(a).at(1);}else{b=a;}this.callNextMethod(b,c);return this;});TP.core.SimpleTIBETPath.Inst.defineMethod('executeGet',function(a,e){var c,b,d;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.isNode(a)||TP.isKindOf(a,TP.core.Node)){return this.raise('TP.sig.InvalidPath',arguments);}this.preGetAccess(a);this.getType().startObservedAddress(this.get('srcPath'));b=this.get('srcPath');if(TP.regex.HAS_ACP.test(b)){c=TP.args(arguments,1);b=b.transform(c);}d=a.get(b);this.getType().endObservedAddress();this.postGetAccess(a);return this.processFinalValue(d,a);});TP.core.SimpleTIBETPath.Inst.defineMethod('executeSet',function(a,f,k,l){var b,c,d,h,i,j,g,e;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.isNode(a)||TP.isKindOf(a,TP.core.Node)){return this.raise('TP.sig.InvalidPath',arguments);}b=this.get('srcPath');c=this.getType();if(TP.notValid(f)){d=TP.DELETE;}else if(TP.isDefined(a.get(b))){d=TP.UPDATE;}else{d=TP.CREATE;}this.preSetAccess(a);c.startChangedAddress(b);c.registerChangedAddress(c.getChangedAddress(),d);if(TP.regex.HAS_ACP.test(b)){h=TP.args(arguments,3);b=b.transform(h);}i=a.set(b,f,false);c.endChangedAddress();this.postSetAccess(a);j=TP.core.SimpleTIBETPath.get('$traversalLevel');if(j===0){if(TP.isValid(k)){g=k;}else if(TP.isValid(a)){g=a.shouldSignalChange();}if(g){e=TP.isReferenceType(f);if(e){this.updateRegistrationsBeforeSignaling(a);}this.sendChangedSignal(a);if(e){this.updateRegistrationsAfterSignaling(a);}}TP.core.AccessPath.$getChangedAddresses().empty();}return i;});TP.core.SimpleTIBETPath.Inst.defineMethod('getFirstSimplePath',function(){return this.get('srcPath');});TP.core.SimpleTIBETPath.Inst.defineMethod('preGetAccess',function(a){var b;b=TP.core.AccessPath.$getExecutedPaths().atPutIfAbsent(TP.id(a),TP.hc());b.atPut(this.get('srcPath'),true);TP.core.SimpleTIBETPath.set('$currentSource',TP.ifInvalid(TP.core.SimpleTIBETPath.get('$currentSource'),a));TP.core.SimpleTIBETPath.set('$currentPath',TP.ifInvalid(TP.core.SimpleTIBETPath.get('$currentPath'),this));TP.core.SimpleTIBETPath.set('$traversalLevel',TP.core.SimpleTIBETPath.get('$traversalLevel')+1);return this;});TP.core.SimpleTIBETPath.Inst.defineMethod('preSetAccess',function(a){TP.core.SimpleTIBETPath.set('$traversalLevel',TP.core.SimpleTIBETPath.get('$traversalLevel')+1);return this;});TP.core.SimpleTIBETPath.Inst.defineMethod('postGetAccess',function(b){var a;a=TP.core.SimpleTIBETPath.get('$traversalLevel')-1;TP.core.SimpleTIBETPath.set('$traversalLevel',a);if(a===0){TP.core.SimpleTIBETPath.set('$currentSource',null);TP.core.SimpleTIBETPath.set('$currentPath',null);}return this;});TP.core.SimpleTIBETPath.Inst.defineMethod('postSetAccess',function(b){var a;a=TP.core.SimpleTIBETPath.get('$traversalLevel')-1;TP.core.SimpleTIBETPath.set('$traversalLevel',a);return this;});TP.core.SimpleTIBETPath.defineSubtype('ComplexTIBETPath');TP.core.ComplexTIBETPath.Inst.defineAttribute('$transformedPath');TP.core.ComplexTIBETPath.Inst.defineAttribute('$createdStructure');TP.core.ComplexTIBETPath.Inst.defineMethod('executeGet',function(a,e){var d,b,c;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.isNode(a)||TP.isKindOf(a,TP.core.Node)){return this.raise('TP.sig.InvalidPath',arguments);}this.preGetAccess(a);b=this.get('srcPath');if(TP.regex.HAS_ACP.test(b)){d=TP.args(arguments,1);b=b.transform(d);}this.set('$transformedPath',b);if(TP.isString(a)){c=this.$executeStringGet(a);}else if(TP.isArray(a)){c=this.$executeArrayGet(a);}else{c=this.$executeObjectGet(a);}this.postGetAccess(a);return this.processFinalValue(c,a);});TP.core.ComplexTIBETPath.Inst.defineMethod('executeSet',function(a,c,h,k){var b,g,e,i,f,d,j;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.isNode(a)||TP.isKindOf(a,TP.core.Node)){return this.raise('TP.sig.InvalidPath',arguments);}this.set('$createdStructure',false);this.preSetAccess(a);b=this.get('srcPath');if(TP.regex.HAS_ACP.test(b)){g=TP.args(arguments,3);b=b.transform(g);}this.set('$transformedPath',b);if(TP.isArray(a)){e=this.$executeArraySet(a,c,false);}else{e=this.$executeObjectSet(a,c,false);}this.postSetAccess(a);i=TP.core.SimpleTIBETPath.get('$traversalLevel');if(i===0){if(TP.isValid(h)){f=h;}else if(TP.isValid(a)){f=a.shouldSignalChange();}if(f){d=TP.isReferenceType(c);if(d){this.updateRegistrationsBeforeSignaling(a);}if(this.get('$createdStructure')){j=TP.core.AccessPath.$getExecutedPaths().at(TP.id(a));j.perform(function(b){TP.apc(b.first()).executeGet(a);});}this.sendChangedSignal(a);if(d){this.updateRegistrationsAfterSignaling(a);}}TP.core.AccessPath.$getChangedAddresses().empty();}this.set('$createdStructure',false);return e;});TP.core.ComplexTIBETPath.Inst.defineMethod('$executeArrayGet',function(e){var a,f,b,d,g,h,c,i;a=this.get('$transformedPath');if((f=a.indexOf('.'))!==-1){b=a.slice(0,f);a=a.slice(f+1);}else{b=a;a=null;}d=this.getType();if(/[,:]/.test(b)){c=TP.ac();if(TP.regex.HAS_COLON.test(b)){if(TP.notValid(a)){e.vslice(b).perform(function(a){d.startObservedAddress(a);c.push(e.at(a));d.endObservedAddress();});}else{e.vslice(b).perform(function(b){d.startObservedAddress(b);c.push(e.at(b).get(TP.apc(a)));d.endObservedAddress();});}}else{b=b.slice(1,b.getSize()-1);g=false;h=b.split(',').convert(function(b){var a;if(!TP.isNumber(a=b.asNumber())){g=true;}return a;});if(g){return undefined;}if(TP.notValid(a)){e.performOver(function(a,b){d.startObservedAddress(b);c.push(a);d.endObservedAddress();},h);}else{e.performOver(function(b,e){d.startObservedAddress(e);if(TP.isValid(b)){c.push(b.get(TP.apc(a)));}else{c.push(b);}d.endObservedAddress();},h);}}return c;}if(TP.notValid(c=e.get(b))){return c;}if(TP.isString(a)&&TP.canInvoke(c,'get')){d.startObservedAddress(b);i=c.get(TP.apc(a));d.endObservedAddress();return i;}else{return c;}return;});TP.core.ComplexTIBETPath.Inst.defineMethod('$executeObjectGet',function(e){var a,f,b,d,g,c,h;a=this.get('$transformedPath');if((f=a.indexOf('.'))!==-1){b=a.slice(0,f);a=a.slice(f+1);}else{b=a;a=null;}d=this.getType();if(/,/.test(b)){b=b.slice(1,b.getSize()-1);g=b.split(',');c=TP.ac();if(TP.notValid(a)){e.performOver(function(a,b){d.startObservedAddress(b);c.push(a);d.endObservedAddress();},g);}else{e.performOver(function(b,e){d.startObservedAddress(e);if(TP.isValid(b)){c.push(b.get(TP.apc(a)));}else{c.push(b);}d.endObservedAddress();},g);}return c;}if(b!==a){if(TP.notValid(c=e.get(b))){return e.getProperty(a);}}if(TP.isString(a)&&TP.canInvoke(c,'get')){d.startObservedAddress(b);h=c.get(TP.apc(a));d.endObservedAddress();return h;}else{return c;}return;});TP.core.ComplexTIBETPath.Inst.defineMethod('$executeStringGet',function(c){var a,e,d,b,f,g;a=this.get('$transformedPath');if((e=a.indexOf('.'))!==-1){b=a.slice(0,e);a=a.slice(e+1);}else{b=a;a=null;}if(/[,:]/.test(a)){d=TP.ac();if(TP.regex.HAS_COLON.test(a)){c.asArray().vslice(a).perform(function(a){d.push(c.at(a));});}else{b=b.slice(1,b.getSize()-1);f=false;g=b.split(',').convert(function(b){var a;if(!TP.isNumber(a=b.asNumber())){f=true;}return a;});if(f){return undefined;}c.asArray().performOver(function(a){d.push(a);},g);}return d.join('');}if(TP.notValid(a)){return undefined;}return c.get(a);});TP.core.ComplexTIBETPath.Inst.defineMethod('$executeArraySet',function(b,h,l){var c,j,d,a,g,e,k,i,f;c=this.get('$transformedPath');if((j=c.indexOf('.'))!==-1){d=c.slice(0,j);c=c.slice(j+1);}else{d=c;c=null;}a=this.getType();g=this.get('shouldMake');if(/[,:]/.test(d)){if(TP.regex.HAS_COLON.test(d)){if(TP.notValid(c)){b.vslice(d).perform(function(d,e){var c;if(TP.notValid(h)){c=TP.DELETE;}else if(TP.isDefined(b.at(d))){c=TP.UPDATE;}else{c=TP.CREATE;}a.startChangedAddress(d);a.registerChangedAddress(a.getChangedAddress(),c);b.atPut(d,h);a.endChangedAddress();});}else{f=TP.apc(c).getFirstSimplePath();i=TP.isNumber(f.asNumber());b.vslice(d).perform(function(e,k){var d,j;d=b.at(e);a.startChangedAddress(e);if(g&&(TP.notValid(d)||!TP.isReferenceType(d))){if(TP.isDefined(d)){j=TP.UPDATE;}else{j=TP.CREATE;b.defineAttribute(e);}if(i){d=TP.ac();}else{d=TP.lang.Object.construct();d.defineAttribute(f);}b.atPut(e,d);a.registerChangedAddress(a.getChangedAddress(),j);this.set('$createdStructure',true);}if(TP.notValid(d)||!TP.isReferenceType(d)){a.endChangedAddress();return;}d.set(TP.apc(c).set('shouldMake',g),h,false);a.endChangedAddress();}.bind(this));}}else if(/,/.test(d)){d=d.slice(1,d.getSize()-1);k=d.split(',').convert(function(a){return a.asNumber();});if(TP.notValid(c)){b.performOver(function(e,d,f){var c;if(TP.notValid(h)){c=TP.DELETE;}else if(TP.isDefined(b.at(d))){c=TP.UPDATE;}else{c=TP.CREATE;}a.startChangedAddress(d);a.registerChangedAddress(a.getChangedAddress(),c);b.atPut(d,h);a.endChangedAddress();},k);}else{f=TP.apc(c).getFirstSimplePath();i=TP.isNumber(f.asNumber());b.performOver(function(k,e,l){var d,j;d=k;a.startChangedAddress(e);if(g&&(TP.notValid(d)||!TP.isReferenceType(d))){if(TP.isDefined(d)){j=TP.UPDATE;}else{j=TP.CREATE;b.defineAttribute(e);}if(i){d=TP.ac();}else{d=TP.lang.Object.construct();d.defineAttribute(f);}b.set(e,d,false);a.registerChangedAddress(a.getChangedAddress(),j);this.set('$createdStructure',true);}if(TP.notValid(d)||!TP.isReferenceType(d)){a.endChangedAddress();return;}d.set(TP.apc(c).set('shouldMake',g),h,false);a.endChangedAddress();}.bind(this),k);}}return b;}e=b.get(d);if(g&&(TP.notValid(e)||!TP.isReferenceType(e))){f=TP.apc(c).getFirstSimplePath();if(TP.isNumber(f.asNumber())){e=TP.ac();}else{e=TP.lang.Object.construct();e.defineAttribute(f);}b.set(TP.apc(d).set('shouldMake',g),e,false);}if(TP.notValid(e)||!TP.isReferenceType(e)){return;}if(TP.isString(c)&&TP.canInvoke(e,'set')){a.startChangedAddress(d);e.set(TP.apc(c).set('shouldMake',g),h,false);a.endChangedAddress();return b;}return;});TP.core.ComplexTIBETPath.Inst.defineMethod('$executeObjectSet',function(e,h,l){var a,i,d,b,f,c,j,k,g;a=this.get('$transformedPath');if((i=a.indexOf('.'))!==-1){d=a.slice(0,i);a=a.slice(i+1);}else{d=a;a=null;}b=this.getType();f=this.get('shouldMake');if(/,/.test(d)){d=d.slice(1,d.getSize()-1);j=d.split(',');if(TP.notValid(a)){e.performOver(function(d,c,f){var a;if(TP.notValid(h)){a=TP.DELETE;}else if(TP.isDefined(e.get(c))){a=TP.UPDATE;}else{a=TP.CREATE;}b.startChangedAddress(c);b.registerChangedAddress(b.getChangedAddress(),a);e.set(c,h,false);b.endChangedAddress();},j);}else{g=TP.apc(a).getFirstSimplePath();k=TP.isNumber(g.asNumber());e.performOver(function(j,d,l){var c,i;c=j;b.startChangedAddress(d);if(f&&(TP.notValid(c)||!TP.isReferenceType(c))){if(TP.isDefined(c)){i=TP.UPDATE;}else{i=TP.CREATE;e.defineAttribute(d);}if(k){c=TP.ac();}else{c=TP.lang.Object.construct();c.defineAttribute(g);}e.set(d,c,false);b.registerChangedAddress(b.getChangedAddress(),i);this.set('$createdStructure',true);}if(TP.notValid(c)||!TP.isReferenceType(c)){b.endChangedAddress();return;}c.set(TP.apc(a).set('shouldMake',f),h,false);b.endChangedAddress();}.bind(this),j);}return e;}c=e.get(d);if(f&&(TP.notValid(c)||!TP.isReferenceType(c))){g=TP.apc(a).getFirstSimplePath();if(TP.isNumber(g.asNumber())){c=TP.ac();}else{c=TP.lang.Object.construct();c.defineAttribute(g);}e.set(TP.apc(d).set('shouldMake',f),c,false);}if(TP.notValid(c)||!TP.isReferenceType(c)){return;}if(TP.isString(a)&&TP.canInvoke(c,'set')){b.startChangedAddress(d);c.set(TP.apc(a).set('shouldMake',f),h,false);b.endChangedAddress();return e;}return;});TP.core.ComplexTIBETPath.Inst.defineMethod('getFirstSimplePath',function(){var b,c,a;b=this.get('srcPath');c=b.split('.');a=c.first();if(/[,:]/.test(a)){a=a.slice(1,a.getSize()-1);if(TP.regex.HAS_COLON.test(a)){a=a.split(':').first();}else{a=a.split(',').first();}}return a;});TP.core.AccessPath.defineSubtype('XMLPath');TP.core.XMLPath.isAbstract(true);TP.core.XMLPath.Inst.defineAttribute('$transformedPath');TP.core.XMLPath.Inst.defineMethod('$addChangedAddressFromNode',function(a){var d,e,c,b;d=TP.nodeGetDocumentPosition(a);if(TP.isAttributeNode(a)){e=TP.attributeGetLocalName(a);c=TP.attributeGetOwnerElement(a);if(TP.notValid(b=TP.elementGetChangeAction(c,TP.ATTR+e))){b=TP.UPDATE;}}else if(TP.isElement(c=a)){if(TP.notValid(b=TP.elementGetChangeAction(c,TP.SELF))){b=TP.UPDATE;}}TP.core.AccessPath.registerChangedAddress(d,b);return this;});TP.core.XMLPath.Inst.defineMethod('executeGet',function(a,k){var h,e,i,b,c,f,d,g,j;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!TP.isNode(a)&&!TP.isKindOf(a,TP.core.Node)){return this.raise('TP.sig.InvalidPath',arguments);}e=this.get('srcPath');i=TP.core.AccessPath.$getExecutedPaths().atPutIfAbsent(TP.id(a),TP.hc());i.atPut(e,true);c=this.get('srcPath');if(TP.regex.HAS_ACP.test(c)){h=TP.args(arguments,1);c=c.transform(h);}this.set('$transformedPath',c);b=TP.unwrap(a);f=TP.nodeEvaluatePath(b,e,this.getPathType(),false);d=TP.ac();f.perform(function(a){d=d.concat(TP.nodeGetAncestorPositions(a,true));});d.unique();g=!TP.isDocument(b)?b.ownerDocument:b;j=TP.wrap(g).getID();d.perform(function(a){TP.core.AccessPath.registerObservedAddress(a,j,e);});return this.processFinalValue(f,a);});TP.core.XMLPath.Inst.defineMethod('executeSet',function(k,q,t,x){var l,v,e,c,h,r,j,w,m,a,p,f,g,i,n,d,u,o,b,s;if(TP.notValid(k)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!TP.isNode(k)&&!TP.isKindOf(k,TP.core.Node)){return this.raise('TP.sig.InvalidPath',arguments);}l=TP.unwrap(k);v=!TP.isDocument(l)?TP.wrap(l.ownerDocument):TP.wrap(l);e=TP.wrap(v);if(TP.isValid(t)){c=t;}else if(TP.isValid(e)){c=e.shouldSignalChange();}if(TP.wrap(k).shouldFlagChanges()){h=true;r=true;}else{h=c;r=false;}j=this.get('srcPath');if(TP.regex.HAS_ACP.test(j)){w=TP.args(arguments,3);j=j.transform(w);}this.set('$transformedPath',j);if(TP.notValid(a=this.$$getContentForSetOperation(l,h))){TP.ifWarn()?TP.warn(TP.boot.$annotate(this,'Unable to set value for path: '+j),TP.LOG,arguments):0;return this;}a=TP.collapse(a);m=false;if(!TP.isArray(a)){if(TP.isElement(a)){m=TP.elementGetChangeAction(a,TP.SELF)===TP.CREATE;}}else{m=TP.isValid(a.detect(function(a){if(TP.isElement(a)){return TP.elementGetChangeAction(a,TP.SELF)===TP.CREATE;}return false;}));}f=TP.isDocument(q)?TP.elem(q):q;p=TP.isNode(f);if(c){i=TP.ac();}if(TP.isNode(a)){if(TP.isNode(g=f)){g=TP.nodeCloneNode(f,true);}else{g=TP.str(f);}n=TP.wrap(a);n.setProcessedContent(g);if(TP.isElement(a)){if(c){i.push(a);TP.elementFlagChange(a,TP.SELF,TP.UPDATE,false);this.$addChangedAddressFromNode(a);}else if(h){TP.elementFlagChange(a,TP.SELF,TP.UPDATE,false);}}else if(TP.isAttributeNode(a)){if(c){d=TP.attributeGetOwnerElement(a);i.push(d);TP.elementFlagChange(d,TP.ATTR+a.name,TP.UPDATE,false);this.$addChangedAddressFromNode(a);}else if(h){TP.elementFlagChange(d,TP.ATTR+a.name,TP.UPDATE,false);}}}else if(TP.isArray(a)){u=a.getSize();for(o=0;o<u;o++){b=a.at(o);if(TP.isNode(g=f)){g=TP.nodeCloneNode(f,true);}else{g=TP.str(f);}n=TP.wrap(b);n.setProcessedContent(g);if(TP.isNode(a)){if(TP.isElement(b)){if(c){i.push(b);TP.elementFlagChange(b,TP.SELF,TP.UPDATE,false);this.$addChangedAddressFromNode(b);}else if(h){TP.elementFlagChange(b,TP.SELF,TP.UPDATE,false);}}else if(TP.isAttributeNode(b)){if(c){d=TP.attributeGetOwnerElement(b);i.push(d);TP.elementFlagChange(d,TP.ATTR+b.name,TP.UPDATE,false);this.$addChangedAddressFromNode(b);}else if(h){TP.elementFlagChange(d,TP.ATTR+b.name,TP.UPDATE,false);}}else{TP.ifWarn()?TP.warn(TP.boot.$annotate(this,'Path probably points to scalar value.'+' Unable to set value.'),TP.LOG,arguments):0;return;}}}}else{TP.ifWarn()?TP.warn(TP.boot.$annotate(this,'Path probably points to scalar value.'+' Unable to set value.'),TP.LOG,arguments):0;return;}if(c){if(p){this.updateRegistrationsBeforeSignaling(e);}if(m){if(TP.notEmpty(s=TP.core.AccessPath.$getExecutedPaths().at(e.getID()))){s.perform(function(a){TP.apc(a.first()).executeGet(e);});}}this.sendChangedSignal(e);if(p){this.updateRegistrationsAfterSignaling(e);}TP.core.AccessPath.$getChangedAddresses().empty();if(!r){i.perform(function(a){TP.elementStripChangeFlags(a);});}}return this;});TP.core.XMLPath.Inst.defineMethod('$$getContentForSetOperation',function(a,b){return TP.override();});TP.core.XMLPath.Inst.defineMethod('getPathType',function(){return null;});TP.core.XMLPath.defineSubtype('SimpleXMLPath');TP.core.SimpleXMLPath.Inst.defineMethod('$$getContentForSetOperation',function(a,b){});TP.core.XMLPath.defineSubtype('ElementPath');TP.core.ElementPath.Inst.defineMethod('$$getContentForSetOperation',function(c,d){var b,a;if(TP.notValid(b=this.get('$transformedPath'))){b=this.get('srcPath');}a=TP.nodeEvaluateElementScheme(c,b);if(!TP.isElement(a)){TP.ifWarn()?TP.warn(TP.boot.$annotate(this,'Unable to obtain content to set for path: '+b),TP.LOG,arguments):0;}else{a=TP.ac(a);}return a;});TP.core.XMLPath.defineSubtype('XTensionPath');TP.core.XTensionPath.Inst.defineMethod('$$getContentForSetOperation',function(c,d){var a,b;if(TP.notValid(a=this.get('$transformedPath'))){a=this.get('srcPath');}b=TP.nodeEvaluateXTension(c,a,false);if(TP.notValid(b)){TP.ifWarn()?TP.warn(TP.boot.$annotate(this,'Unable to obtain content to set for path: '+a),TP.LOG,arguments):0;}return b;});TP.core.XTensionPath.defineSubtype('CSSPath');TP.definePrimitive('cpc',function(){return TP.core.CSSPath.construct.apply(TP.core.CSSPath,arguments);});TP.core.CSSPath.Inst.defineMethod('getPathType',function(){return TP.CSS_PATH_TYPE;});TP.core.XMLPath.defineSubtype('BarenamePath');TP.core.BarenamePath.Inst.defineMethod('init',function(a,b){this.callNextMethod();this.set('shouldMake',true);return this;});TP.core.BarenamePath.Inst.defineMethod('$$getContentForSetOperation',function(c,d){var b,a;if(TP.notValid(b=this.get('$transformedPath'))){b=this.get('srcPath');}if(!TP.isArray(a=TP.nodeEvaluateBarename(c,b,false,this.get('shouldMake')))){a=TP.ac(a);}if(TP.notValid(a)){TP.ifWarn()?TP.warn(TP.boot.$annotate(this,'Unable to obtain content to set for path: '+b),TP.LOG,arguments):0;}return a;});TP.core.BarenamePath.Inst.defineMethod('getPathType',function(){return TP.BARENAME_PATH_TYPE;});TP.extern.XPathFunctionResolver=function(){};TP.extern.XPathNamespaceResolver=function(){};TP.extern.XPathVariableResolver=function(){};TP.core.XMLPath.defineSubtype('XPathPath');TP.definePrimitive('xpc',function(){return TP.core.XPathPath.construct.apply(TP.core.XPathPath,arguments);});TP.core.XPathPath.Type.defineConstant('NON_NATIVE_PATH_REGEX',TP.rc('\\$\\w+|\\w+:[\\w-]+\\('));TP.core.XPathPath.Type.defineAttribute('$tpParser');TP.core.XPathPath.Type.defineAttribute('$nsResolver');TP.core.XPathPath.Type.defineAttribute('$fnResolver');TP.core.XPathPath.Type.defineAttribute('$varResolver');TP.core.XPathPath.Inst.defineAttribute('isNative');TP.core.XPathPath.Inst.defineAttribute('$tpPath');TP.core.XPathPath.Inst.defineAttribute('$tpContext');TP.core.XPathPath.Type.defineMethod('canonicalizePath',function(c){var a,b;a=this.getParser();b=a.parse(c);return b.expression.toString();});TP.core.XPathPath.Type.defineMethod('getFunctionResolver',function(){var a;if(TP.notValid(a=this.$get('$fnResolver'))){this.getParser();TP.extern.XPathFunctionResolver.prototype=new TP.extern.XPathParser.FunctionResolver();TP.extern.XPathFunctionResolver.prototype.constructor=TP.extern.XPathFunctionResolver;TP.extern.XPathFunctionResolver.prototype.superclass=TP.extern.XPathParser.FunctionResolver.prototype;TP.extern.XPathFunctionResolver.prototype.getFunctionWithName=function(a,b,e){var d,c;if(TP.notEmpty(a)&&TP.notEmpty(d=TP.w3.Xmlns.getCanonicalPrefix(a))){if(TP.isType(c=(d+':').asType())){if(TP.isCallable(c[b])){return c[b];}}}return this.superclass.getFunctionWithName.bind(this)(a,b,e);};a=new TP.extern.XPathFunctionResolver();this.$set('$fnResolver',a);}return a;});TP.core.XPathPath.Type.defineMethod('getNSResolver',function(){var a;if(TP.notValid(a=this.$get('$nsResolver'))){this.getParser();TP.extern.XPathNamespaceResolver.prototype=new TP.extern.XPathParser.NamespaceResolver();TP.extern.XPathNamespaceResolver.prototype.constructor=TP.extern.XPathNamespaceResolver;TP.extern.XPathNamespaceResolver.prototype.superclass=TP.extern.XPathParser.NamespaceResolver.prototype;TP.extern.XPathNamespaceResolver.prototype.getNamespace=function(a,c){var b;if(TP.notEmpty(a)&&TP.isString(b=TP.w3.Xmlns.getPrefixURI(a))){return b;}return this.superclass.getNamespace.bind(this)(a,c);};a=new TP.extern.XPathNamespaceResolver();this.$set('$nsResolver',a);}return a;});TP.core.XPathPath.Type.defineMethod('getParser',function(){var a;if(TP.notValid(a=this.$get('$tpParser'))){if(TP.notValid(TP.extern.XPathParser)){TP.sys.importScript(TP.sys.cfg('xpath.parser_path'));}a=new TP.extern.XPathParser();this.$set('$tpParser',a);}return a;});TP.core.XPathPath.Type.defineMethod('getVariableResolver',function(){var resolver;if(TP.notValid(resolver=this.$get('$varResolver'))){this.getParser();TP.extern.XPathVariableResolver.prototype=new TP.extern.XPathParser.VariableResolver();TP.extern.XPathVariableResolver.prototype.constructor=TP.extern.XPathVariableResolver;TP.extern.XPathVariableResolver.prototype.superclass=TP.extern.XPathParser.VariableResolver.prototype;TP.extern.XPathVariableResolver.prototype.getVariableWithName=function(ns,ln,c){var $$result,newNodeSet;switch(ln){case'rowIndex':return new TP.extern.XPathParser.XNumber(100);default:eval('$$result = '+ln);if(TP.isNumber($$result)){return new TP.extern.XPathParser.XNumber($$result);}else if(TP.isBoolean($$result)){return new TP.extern.XPathParser.XBoolean($$result);}else if(TP.isNode($$result)){newNodeSet=new TP.extern.XPathParser.XNodeSet();newNodeSet.add($$result);}else{return new TP.extern.XPathParser.XString($$result.asString());}break;}return;};resolver=new TP.extern.XPathVariableResolver();this.$set('$varResolver',resolver);}return resolver;});TP.core.XPathPath.Inst.defineMethod('init',function(b,c,d){var a;if(TP.regex.XPATH_POINTER.test(b)){a=TP.regex.XPATH_POINTER.match(b).at(2);}else{a=b;}TP.regex.XPATH_DEFAULTNS.lastIndex=0;a=a.replace(TP.regex.XPATH_DEFAULTNS,'*[name()="$1"]');this.setPath(a,d);this.callNextMethod(a,c);return this;});TP.core.XPathPath.Inst.defineMethod('asReplacedString',function(b){var a;if(TP.notEmpty(a=this.$get('$tpPath'))){return a.expression.toReplacedString(b);}return this.asString();});TP.core.XPathPath.Inst.defineMethod('asSource',function(){var a,b;a='TP.core.XPathPath.construct(\''+this.get('srcPath')+'\', '+this.get('isNative')+')';if((b=this.get('shouldMake'))===true){a+='.set(\'shouldMake\', '+b+')';}if((b=this.get('shouldCollapse'))===true){a+='.set(\'shouldCollapse\', '+b+')';}return a;});TP.core.XPathPath.Inst.defineMethod('asString',function(d){var b,c,a;b=TP.ifInvalid(d,true);if(b&&TP.notEmpty(c=this.$get('$tpPath'))){a=c.expression.toString();}else{a=this.$get('srcPath');}return a;});TP.core.XPathPath.Inst.defineMethod('$$createNodesForPath',function(d,e){var a,b,c;a=this.get('isNative');b=this.get('shouldMake');this.set('isNative',false);this.set('shouldMake',true);c=this.execOnNative(d,TP.NODESET,false,e);this.set('isNative',a);this.set('shouldMake',b);return c;});TP.core.XPathPath.Inst.defineMethod('$createNonNativeParserContext',function(b){var c,a,d;if(b===this.$get('srcPath')&&TP.isValid(this.$get('$tpContext'))){return this;}c=TP.ifEmpty(b,this.$get('srcPath'));d=this.getType().getParser();this.$set('$tpPath',d.parse(c));a=new TP.extern.XPathParser.XPathContext(this.getType().getVariableResolver(),this.getType().getNSResolver(),this.getType().getFunctionResolver());a.shouldCreateNodes=false;this.$set('$tpContext',a);return this;});TP.core.XPathPath.Inst.defineMethod('exec',function(a,b,c,d){return this.execOnNative(a.getNativeNode(),b,c,TP.ifInvalid(d,a.shouldFlagChanges()));});TP.core.XPathPath.Inst.defineMethod('execOnNative',function(d,f,g,h){var e,c,b,a;e=TP.ifEmpty(h,false);if(TP.notValid(c=this.get('$transformedPath'))){c=this.get('srcPath');}if(this.isNativePath()&&TP.isXMLDocument(TP.nodeGetDocument(d))&&!e){return TP.nodeEvaluateXPath(d,c,f,g);}if(TP.notValid(b=this.$get('$tpContext'))){this.$createNonNativeParserContext(c);b=this.$get('$tpContext');}b.expressionContextNode=d;b.shouldFlagNodes=e;b.logErrors=TP.ifInvalid(g,true);a=this.$get('$tpPath').evaluate(b);switch(a.constructor){case TP.extern.XPathParser.XString:return a.stringValue();case TP.extern.XPathParser.XNumber:return a.numberValue();case TP.extern.XPathParser.XBoolean:return a.booleanValue();default:if(f===TP.FIRST_NODE){return a.first();}else{return a.toArray();}}});TP.core.XPathPath.Inst.defineMethod('execRemove',function(e){var a,f,g,c,h,d,b;a=e.getNativeNode();if(TP.notValid(f=this.get('$transformedPath'))){f=this.get('srcPath');}g=this.get('shouldMake');this.set('shouldMake',false);this.set('isNative',false);c=this.execOnNative(a,TP.NODESET,false);this.set('shouldMake',g);if(TP.notValid(c)||c.getSize()===0){return this;}h=c.getSize();for(d=0;d<h;d++){a=c[d];if(a.nodeType===Node.ATTRIBUTE_NODE){b=TP.attributeGetOwnerElement(a);if(e.shouldFlagChanges()){TP.elementFlagChange(b,TP.ATTR+a.name,TP.DELETE);}b.removeAttributeNode(a);this.changed('@'+a.name,TP.DELETE);}else{b=a.parentNode;if(e.shouldFlagChanges()){TP.elementFlagChange(a,TP.SELF,TP.DELETE);TP.ifTrace(TP.$DEBUG)?TP.trace('Node flagged: '+TP.nodeAsString(a),TP.LOG,arguments):0;}else{TP.nodeRemoveChild(b,a);}TP.wrap(b).changed('content',TP.DELETE);}}return this;});TP.core.XPathPath.Inst.defineMethod('$$getContentForSetOperation',function(h,f){var g,c,a,b,d,e,i,j;g=this.get('shouldMake');c=this.execOnNative(h,TP.NODESET,false,f);if(TP.isEmpty(c)){if(TP.notValid(a=this.get('$transformedPath'))){a=this.get('srcPath');}if(TP.notTrue(g)){TP.ifWarn()?TP.warn(TP.boot.$annotate(this,'Unable to obtain content to set for path: '+a),TP.LOG,arguments):0;return TP.ac();}if(TP.regex.HAS_AT.test(a)){b=a;if((d=a.lastIndexOf('/'))!==TP.NOT_FOUND){b=a.slice(d+1);}if(b.charAt(0)==='@'){e=true;i=b.slice(1);}else if(b.startsWith('attribute::')){e=true;i=b.slice(11);}if(e){j=TP.xpc(a.slice(0,d));}}c=this.$$createNodesForPath(h,f);if(TP.isEmpty(c)){TP.ifWarn()?TP.warn(TP.boot.$annotate(this,'Unable to build content for path: '+a),TP.LOG,arguments):0;return TP.ac();}}return c;});TP.core.XPathPath.Inst.defineMethod('getShouldMake',function(){var a;if(TP.isValid(a=this.$get('$tpContext'))){return a.shouldCreateNodes;}return this.$get('shouldMake');});TP.core.XPathPath.Inst.defineMethod('getReferencedNodes',function(j){var b,c,e,a,g,d,i,f,h;if(TP.notValid(b=this.$get('$tpContext'))){this.$createNonNativeParserContext();b=this.$get('$tpContext');}c=this.getReferencedLocationSteps();if(c.getSize()===1){return TP.ac();}b.expressionContextNode=TP.unwrap(j);e=this.getType().getParser();a=TP.ac();g=c.getSize();for(d=0;d<g;d++){i=c.at(d);f=e.parse(i);h=f.evaluate(b);a.add(h.toArray());}a=a.flatten();return a;});TP.core.XPathPath.Inst.defineMethod('getReferencedLocationSteps',function(){var b,a;if(TP.notValid(b=this.$get('$tpContext'))){this.$createNonNativeParserContext();}a=TP.ac();this.$get('$tpPath').expression.gatherLocationPathsInto(a);return a;});TP.core.XPathPath.Inst.defineMethod('isAbsolute',function(){var a;if(TP.isValid(a=this.$get('$tpPath'))){return a.expression.locationPath.absolute;}return this.$get('srcPath').startsWith('/');});TP.core.XPathPath.Inst.defineMethod('isNativePath',function(b){var a;if(TP.isBoolean(b)){a=this.$get('srcPath');if(b){if(TP.core.XPathPath.NON_NATIVE_PATH_REGEX.test(a)){TP.ifWarn()?TP.warn('Found non-native XPath constructs in XPath: '+a+'. Forcing XPath to use non native parser.',TP.LOG,arguments):0;this.set('isNative',false);this.$createNonNativeParserContext(a);}else{this.set('isNative',true);}}else{this.set('isNative',false);this.$createNonNativeParserContext(a);}}return this.get('isNative');});TP.core.XPathPath.Inst.defineMethod('setShouldMake',function(a){var b;if(TP.isTrue(a)){this.isNativePath(false);}if(TP.isValid(b=this.$get('$tpContext'))){b.shouldCreateNodes=a;}this.$set('shouldMake',a);return this;});TP.core.XPathPath.Inst.defineMethod('setPath',function(b,c){var a;if(TP.notValid(c)){if(TP.core.XPathPath.NON_NATIVE_PATH_REGEX.test(b)){if(c){TP.ifWarn()?TP.warn('Found non-native XPath constructs in XPath: '+b+'. Forcing XPath to use non native parser.',TP.LOG,arguments):0;}a=false;}else{a=true;}}else{a=c;}this.set('isNative',a);if(a===TP.core.XPathPath.NON_NATIVE_PATH){this.$createNonNativeParserContext(b);}this.$set('srcPath',b);return this;});TP.core.JSONContent.defineSubtype('w3:DTDInfo');TP.w3.DTDInfo.Type.defineMethod('initialize',function(){var b,a;this.observe(TP.sys,'TP.sig.AppStart',function(c){this.ignore(TP.sys,c.getSignalName());(function(){b=TP.uc('~lib_lib/json/html401_strict.json');a=b.getResource(TP.hc('async',false,'contentHandler',this));if(TP.isValid(a)){TP.w3.DocType.HTML_401_STRICT.set('dtdInfo',a);}}.bind(this).fork(2000));}.bind(this));return;});TP.w3.DTDInfo.Inst.defineAttribute('elements',{'value':TP.apc('data.element',true)});TP.w3.DTDInfo.Inst.defineMethod('elementIsValidChildOf',function(c,d){var b,a;b=this.get('elements').at(d).at('contentModel').at('expanded');b.perform(function(c){var b;if(TP.isEmpty(b=c.at('orGroup'))){if(TP.isEmpty(b=c.at('sequenceGroup'))){b=c.at('andGroup');}}if(TP.isElement(b)&&TP.isArray(a=b.at('elements'))){return TP.BREAK;}});if(TP.isEmpty(a)){return false;}return a.contains(c);});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETTemplating.js';
TP.defineMetaInstMethod('transform',function(a,b){TP.debug('break.content_transform');return this.callBestMethod(arguments,a,'transform',null,'transformObject');});TP.defineCommonMethod('transformObject',function(a,b){return null;});String.Inst.defineMethod('compile',function(d,g,h,i){var c,a,e,b,f;TP.debug('break.content_templating');if(TP.isEmpty(c=this.toString())){return null;}if(TP.regex.SUBSTITUTION_STRING.test(a=d)){a=escape(a);}if(TP.notEmpty(a)&&TP.notTrue(g)){e=TP.uc(TP.TIBET_URN_PREFIX+a);if(TP.isURI(e)){if(TP.isFunction(b=e.getResource())){return b;}}}if(!TP.regex.HAS_ACP.test(c)){b=function(a){return c;};}else{try{f=TP.$templateParser.parse(c);}catch(a){return this.raise('TP.sig.TemplateTokenizationFailed',arguments,TP.ec(a,TP.sc('Tokenization failed at: ',a.line||'unknown','in template named: ',d,' with source: '+c)));}b=this.$compileTemplateTokens(f,d,i);}if(!TP.isFunction(b)){this.raise('TP.sig.InvalidTemplate',arguments,'Unable to compile string: '+c);return;}if(TP.notEmpty(a)&&TP.notFalse(h)){TP.uc(TP.TIBET_URN_PREFIX+a).setResource(b);}return b;});String.Inst.defineMethod('$compileTemplateTokens',function(l,n,m){var j,k,g,h,a,e,f,d,i,c,b;j=TP.ifInvalid(m,TP.ac());c=TP.ac();b=TP.ac();k=0;g='return TP.isNull(result) ? \'\' : result;';h=function(b,c,d){var a;if(TP.notEmpty(c)){if(d){a='TP.isFunction(arg) ? arg() : '+'(TP.format(TP.ifInvalid(arg, '+'\'{{'+b+'}}\'),'+' "'+c+'", '+'params.atPut(\'repeat\', true)))';}else{a='TP.isFunction(arg) ? arg() : '+'(TP.format(TP.ifInvalid(arg, '+'\'{{'+b+'}}\'),'+' "'+c+'", params))';}}else{a='TP.isFunction(arg) ? arg() : '+'(TP.format(TP.ifInvalid(arg, '+'\'{{'+b+'}}\'),'+' "'+'String'+'", " "))';}return a;};a={'defineUndefined':function(b){return'if (!TP.isDefined('+a.escapedIdentifier(b)+')) { return \'\'; };';},'escape':function(a){return a.replace(/'/gi,'\\\'');},'escapedIdentifier':function(a){if(!TP.regex.JS_IDENTIFIER.test(a)){return'_'+a.asHashedNumber().abs();}return a;},'guardCollection':function(b){return'!TP.isDefined('+a.escapedIdentifier(b)+') ? TP.ac() : '+b;},'getFromArgs':function(c){var e,d;if(/^\$\w+/.test(c)&&!j.contains(c)){d='params';}else{if(TP.isEmpty(d=b.last())){d='source';}}e='var '+a.escapedIdentifier(c)+' = '+'TP.wrap(TP.objectValue('+d+','+' \''+c+'\','+' true));';return e;},'guardValue':function(b){return'!TP.isDefined('+a.escapedIdentifier(b)+') ? '+'null : '+b;},'handle':function(c){var a,b;a=c;b=a.shift();if(!TP.isCallable(e[b])){return this.raise('TP.sig.TemplateCompilationFailed',arguments,TP.sc('Compilation failed.',' Unknown handler for: ',b,' with args: '+a.shift()));}return e[b].apply(this,a);},'loop':function(b,c){return b.map(a.handle).join(c||' + ');},'returnWrap':function(b){return a.wrap('return '+b);},'wrap':function(a){return'(function() {'+a+'})()';},'valueFrom':function(b,e,f){var d;if(TP.notEmpty(c)&&(c.last().contains(b)||c.last().contains(TP.ALL))){d='';}else{d=a.getFromArgs(b);}return'function() {'+d+a.defineUndefined(b)+' var arg = ('+a.escapedIdentifier(b)+');'+' var result = '+h(b,e,f)+'; '+g+'}()';}};e={'comment':function(){return a.returnWrap('\'\'');},'text':function(b){return a.returnWrap('\''+a.escape(b)+'\';');},'value':function(f){var d,b,h,e,c,g;g=false;if(TP.regex.ACP_FORMAT.test(f)){b=TP.regex.ACP_FORMAT.exec(f);b.shift();d=b.at(0).trim();if(TP.isEmpty(d)){d='value';b.atPut(0,'value');}c=b.at(1);if(c.charAt(0)==='*'){c=/\*\s*(.+)/.exec(c).at(1);g=true;}else if(TP.regex.HAS_ACP.test(h=b.at(1))){e=n+'_inline_'+k++;h.compile(e,true);b.atPut(1,e);c=e;}}else{d=f;c=null;}return a.returnWrap(a.valueFrom(d,c,g));},'html':function(b){return a.returnWrap(a.valueFrom(b));},'for':function(g,i){var e,d,h,f;if(TP.isValid(d=g.args)){e=g.data;d=d.split(',');}else{e=g;d=TP.ac('item','index');}c.push(d);h=a.guardCollection(e);f=a.getFromArgs(e);b.push(a.escapedIdentifier(d.first()));f=a.wrap(f+'return '+h+'.getValues().collect(function('+d.join(', ')+')'+'{return '+a.loop(i)+'}).join(\'\')');b.pop();c.pop();return f;},'with':function(d,e){var c;c=a.getFromArgs(d);b.push(a.escapedIdentifier(d));c=a.wrap(c+'return '+a.loop(e));b.pop();return c;},'if':function(d,g,e){var c,f;c=a.getFromArgs(d);b.push(a.escapedIdentifier(d));f=e?a.loop(e,' '):'else {return \'\'}';c=a.wrap(c+'if ('+a.escapedIdentifier(d)+')'+'{return '+a.loop(g)+'}'+f);b.pop();return c;},'else':function(b,c){return'else if ('+b+')'+'{return '+a.loop(c)+'}';}};d=a.loop(l).replace(/\n|\r/gi,'\\n');if(TP.isEmpty(d)){return null;}f=TP.ac();f.push('var params,\n','    source;\n','\n','params = TP.ifInvalid(aParamHash, TP.hc());\n','source = TP.wrap(aDataSource);\n','\n\n','try\n','{\n','return (',d,')\n','}\n','catch(e)\n','{\n','TP.ifError() ? TP.error(TP.ec(e), arguments): 0;\n','};\n');i=TP.fc('aDataSource','aParamHash',f.join(''));return i;});String.Inst.defineMethod('transform',function(c,d){var b,a,f,g,e,h;TP.debug('break.content_transform');if(TP.isEmpty(b=this.toString())){return;}if(TP.regex.HAS_ACP.test(b)){a=''+b;if(TP.regex.ESCAPED_QUOTED_CONTENT.test(a)){a=a.replace(/\\/g,'\\\\');}if(TP.isValid(d)){a=a.compile(null,false,true,d.at('sourcevars'));}else{a=a.compile(null,false,true);}if(TP.isCallable(a)){return a.transform(c,d);}else{TP.ifError()?TP.error('Unable to compile formatting template: '+b,TP.LOG,arguments):0;return;}}else if(TP.regex.SUBSTITUTION_STRING.test(b)){return this.callBestMethod(arguments,c,'transform',null,'transformObject');}else if(TP.isType(f=TP.sys.require(b))){if(TP.canInvoke(f,'transform')){return f.transform(c,d);}else{return TP.raise(this,'TP.sig.InvalidFormat',arguments,b+' does not support transform call.');}}else{if(!TP.isURI(e=b)){g=true;e=TP.TIBET_URN_PREFIX+b;}if(TP.isURI(h=TP.uc(e))){if(TP.isValid(a=h.getResource())){return a.transform(c,d);}else if(TP.notTrue(g)){TP.ifError()?TP.error('Unable to locate formatting template URN: '+e,TP.LOG,arguments):0;return;}}else if(TP.notTrue(g)){TP.ifError()?TP.error('Invalid formatting template URN: '+e,TP.LOG,arguments):0;return;}}return this.callBestMethod(arguments,c,'transform',null,'transformObject');});Function.Inst.defineMethod('transform',function(b,e){var a,k,j,d,f,h,i,g,c,l;TP.debug('break.content_transform');if(TP.notValid(b)){try{return this();}catch(a){return this.raise('TP.sig.TransformFailed',arguments,TP.ec(a,'Transform failed'));}}if(TP.isValid(e)){if(TP.canInvoke(e,'getPayload')){a=e.getPayload().copy();}else{a=e.copy();}}else{a=TP.hc();}a.atPut('$INPUT',b);if(!TP.isCollection(b)||TP.notTrue(a.at('repeat'))){try{k=this(b,a);a.atPut('$INPUT',b);return k+'';}catch(a){return this.raise('TP.sig.TransformFailed',arguments,TP.ec(a,'Transform failed'));}}a.removeKey('repeat');j=TP.isArray(b)||TP.isNodeList(b);if(j){d=b;}else if(TP.canInvoke(b,'getItems')){d=b.getItems();}else{return this.raise('TP.sig.InvalidParameter',arguments,'Argument must be a valid collection or object with items.');}f=TP.ifKeyInvalid(a,'$REPEAT_START',0);h=TP.ifKeyInvalid(a,'$REPEAT_LIMIT',Number.POSITIVE_INFINITY);i=(f+d.getSize()).min(f+h);g=TP.ac();for(c=f;c<i;c++){a.atPut('$INDEX',c);try{l=this(d.at(c),a);}catch(a){return this.raise('TP.sig.TransformFailed',arguments,TP.ec(a,'Repeating transform failed on item: '+c));}g.push(l);}a.atPut('$INPUT',b);return g.join('');});TP.$templateParser=function(){function b(a,c){function b(){this.constructor=a;}b.prototype=c.prototype;a.prototype=new b();}function a(a,b,c,d,e,f){this.message=a;this.expected=b;this.found=c;this.offset=d;this.line=e;this.column=f;this.name='SyntaxError';}b(a,Error);function c(f){var v=arguments.length>1?arguments[1]:{},c={},_={start:aF},N=aF,b3=[],d=c,aD=function(a){return['text',a.join('')];},j=void 0,w='\\{',R={type:'literal',value:'\\{',description:'"\\\\{"'},S='\\}',aE={type:'literal',value:'\\}',description:'"\\\\}"'},p={type:'any',description:'any character'},ac=function(a){return a;},au=function(a){return['value',a.join('')];},o='{{',E={type:'literal',value:'{{',description:'"{{"'},aP=/^[:\/]/,aU={type:'class',value:'[:\\/]',description:'[:\\/]'},k='}}',r={type:'literal',value:'}}',description:'"}}"'},m=function(a){return a;},ax=/^[#@%]/,aC={type:'class',value:'[#@%]',description:'[#@%]'},J='{',K={type:'literal',value:'{',description:'"{"'},L='}',M={type:'literal',value:'}',description:'"}"'},aY=function(a,b){return a+'{'+b.join('')+'}';},a4=function(a){return['command',''];},a8=function(b,a){return['command',a.join('')];},n=function(a){return a;},O='html',ao={type:'literal',value:'html',description:'"html"'},ap='=',aq={type:'literal',value:'=',description:'"="'},ar='!',as={type:'literal',value:'!',description:'"!"'},at=function(){return'comment';},q=null,av=function(a,b,c,d){if(a.command==d){if(a.command=='if'){return[a.command,a.body.join(''),b,c];}else{if(a.args){return[a.command,{args:a.args[0],data:a.body.join('')},b];}else{return[a.command,a.body.join(''),b];}}}else{throw new this.SyntaxError('No closing tag found for '+a.command+' on line: '+b4()+' at position: '+aZ());}},Q='{{:',ay={type:'literal',value:'{{:',description:'"{{:"'},y=/^[a-zA-Z0-9]/,z={type:'class',value:'[a-zA-Z0-9]',description:'[a-zA-Z0-9]'},V='{{/:',aG={type:'literal',value:'{{/:',description:'"{{/:"'},aI=function(a,b,c){return{command:a,body:c,args:b};},aO=function(a){return a;},a2='if',aR={type:'literal',value:'if',description:'"if"'},a0='for',aV={type:'literal',value:'for',description:'"for"'},a1='with',a3={type:'literal',value:'with',description:'"with"'},G='log',a5={type:'literal',value:'log',description:'"log"'},a6='(',a7={type:'literal',value:'(',description:'"("'},H=')',I={type:'literal',value:')',description:'")"'},aa=function(a){return a.join('');},ab=function(a){return a;},P='else',ad={type:'literal',value:'else',description:'"else"'},ae=function(a,b){return['else',a,b];},af=function(){return'true';},ag=function(a){return a.join('');},ah='/',ai={type:'literal',value:'/',description:'"/"'},aj=function(a){return'{{'+a.join('')+'}}';},ak=function(a){return'{{'+a.join('')+'}}';},al={type:'other',description:'whitespace'},am=/^[ \t\n\r]/,an={type:'class',value:'[ \\t\\n\\r]',description:'[ \\t\\n\\r]'},b=0,h=0,t=0,D={line:1,column:1,seenCR:false},x=0,C=[],e=0,A;if('startRule'in v){if(!(v.startRule in _)){throw new Error('Can\'t start parsing from rule "'+v.startRule+'".');}N=_[v.startRule];}function ba(){return f.substring(h,b);}function b9(){return h;}function b4(){return U(h).line;}function aZ(){return U(h).column;}function b8(a){throw W(null,[{type:'other',description:a}],h);}function bb(a){throw W(a,null,h);}function U(a){function b(a,d,e){var c,b;for(c=d;c<e;c++){b=f.charAt(c);if(b==='\n'){if(!a.seenCR){a.line++;}a.column=1;a.seenCR=false;}else if(b==='\r'||b==='\u2028'||b==='\u2029'){a.line++;a.column=1;a.seenCR=true;}else{a.column++;a.seenCR=false;}}}if(t!==a){if(t>a){t=0;D={line:1,column:1,seenCR:false};}b(D,t,a);t=a;}return D;}function g(a){if(b<x){return;}if(b>x){x=b;C=[];}C.push(a);}function W(g,b,c){function h(b){var a=1;b.sort(function(a,b){if(a.description<b.description){return-1;}else if(a.description>b.description){return 1;}else{return 0;}});while(a<b.length){if(b[a-1]===b[a]){b.splice(a,1);}else{a++;}}}function i(a,d){function g(b){function a(a){return a.charCodeAt(0).toString(16).toUpperCase();}return b.replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\x08/g,'\\b').replace(/\t/g,'\\t').replace(/\n/g,'\\n').replace(/\f/g,'\\f').replace(/\r/g,'\\r').replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(b){return'\\x0'+a(b);}).replace(/[\x10-\x1F\x80-\xFF]/g,function(b){return'\\x'+a(b);}).replace(/[\u0180-\u0FFF]/g,function(b){return'\\u0'+a(b);}).replace(/[\u1080-\uFFFF]/g,function(b){return'\\u'+a(b);});}var b=new Array(a.length),e,f,c;for(c=0;c<a.length;c++){b[c]=a[c].description;}e=a.length>1?b.slice(0,-1).join(', ')+' or '+b[a.length-1]:b[0];f=d?'"'+g(d)+'"':'end of input';return'Expected '+e+' but '+f+' found.';}var d=U(c),e=c<f.length?f.charAt(c):null;if(b!==null){h(b);}return new a(g!==null?g:i(b,e),b,e,c,d.line,d.column);}function aF(){var b,a;b=[];a=Y();if(a===c){a=Z();if(a===c){a=$();if(a===c){a=X();}}}while(a!==c){b.push(a);a=Y();if(a===c){a=Z();if(a===c){a=$();if(a===c){a=X();}}}}return b;}function X(){var f,a,e;f=b;a=[];e=aH();if(e!==c){while(e!==c){a.push(e);e=aH();}}else{a=d;}if(a!==c){h=f;a=aD(a);}f=a;return f;}function aH(){var i,k,l,a;i=b;k=b;e++;l=s();e--;if(l===c){k=j;}else{b=k;k=d;}if(k!==c){l=b;e++;a=aJ();e--;if(a===c){l=j;}else{b=l;l=d;}if(l!==c){if(f.substr(b,2)===w){a=w;b+=2;}else{a=c;if(e===0){g(R);}}if(a===c){if(f.substr(b,2)===S){a=S;b+=2;}else{a=c;if(e===0){g(aE);}}if(a===c){if(f.length>b){a=f.charAt(b);b++;}else{a=c;if(e===0){g(p);}}}}if(a!==c){h=i;k=ac(a);i=k;}else{b=i;i=d;}}else{b=i;i=d;}}else{b=i;i=d;}return i;}function Y(){var a,g,f,e;a=b;g=aJ();if(g!==c){f=[];e=aL();if(e!==c){while(e!==c){f.push(e);e=aL();}}else{f=d;}if(f!==c){e=aK();if(e!==c){h=a;g=au(f);a=g;}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}return a;}function aJ(){var a,h,i,k;a=b;if(f.substr(b,2)===o){h=o;b+=2;}else{h=c;if(e===0){g(E);}}if(h!==c){i=b;e++;if(aP.test(f.charAt(b))){k=f.charAt(b);b++;}else{k=c;if(e===0){g(aU);}}e--;if(k===c){i=j;}else{b=i;i=d;}if(i!==c){h=[h,i];a=h;}else{b=a;a=d;}}else{b=a;a=d;}return a;}function aK(){var a;if(f.substr(b,2)===k){a=k;b+=2;}else{a=c;if(e===0){g(r);}}return a;}function aL(){var i,a,k;i=b;a=B();if(a!==c){h=i;a=m(a);}i=a;if(i===c){i=b;a=b2();if(a!==c){h=i;a=m(a);}i=a;if(i===c){i=b;a=T();if(a!==c){h=i;a=m(a);}i=a;if(i===c){i=b;a=b;e++;k=aK();e--;if(k===c){a=j;}else{b=a;a=d;}if(a!==c){if(f.length>b){k=f.charAt(b);b++;}else{k=c;if(e===0){g(p);}}if(k!==c){h=i;a=m(k);i=a;}else{b=i;i=d;}}else{b=i;i=d;}if(i===c){i=b;if(f.substr(b,2)===w){a=w;b+=2;}else{a=c;if(e===0){g(R);}}if(a!==c){h=i;a=m(a);}i=a;}}}}return i;}function b2(){var a,j,l,k,i;a=b;if(ax.test(f.charAt(b))){j=f.charAt(b);b++;}else{j=c;if(e===0){g(aC);}}if(j!==c){if(f.charCodeAt(b)===123){l=J;b++;}else{l=c;if(e===0){g(K);}}if(l!==c){k=[];i=aN();if(i!==c){while(i!==c){k.push(i);i=aN();}}else{k=d;}if(k!==c){if(f.charCodeAt(b)===125){i=L;b++;}else{i=c;if(e===0){g(M);}}if(i!==c){h=a;j=aY(j,k);a=j;}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}return a;}function aN(){var a,k,i,l;a=b;k=b;e++;if(f.charCodeAt(b)===123){i=J;b++;}else{i=c;if(e===0){g(K);}}e--;if(i===c){k=j;}else{b=k;k=d;}if(k!==c){i=b;e++;if(f.charCodeAt(b)===125){l=L;b++;}else{l=c;if(e===0){g(M);}}e--;if(l===c){i=j;}else{b=i;i=d;}if(i!==c){if(f.length>b){l=f.charAt(b);b++;}else{l=c;if(e===0){g(p);}}if(l!==c){h=a;k=m(l);a=k;}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}return a;}function Z(){var a,e,k,j,m,f,g,n;a=b;e=s();if(e!==c){k=i();if(k!==c){j=aQ();if(j!==c){m=i();if(m!==c){f=l();if(f!==c){h=a;e=a4(j);a=e;}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}if(a===c){a=b;e=s();if(e!==c){k=i();if(k!==c){j=aQ();if(j!==c){m=i();if(m!==c){f=[];g=u();if(g!==c){while(g!==c){f.push(g);g=u();}}else{f=d;}if(f!==c){g=i();if(g!==c){n=l();if(n!==c){h=a;e=a8(j,f);a=e;}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}return a;}function u(){var i,a,k;i=b;a=B();if(a!==c){h=i;a=n(a);}i=a;if(i===c){i=b;a=T();if(a!==c){h=i;a=n(a);}i=a;if(i===c){i=b;a=b;e++;k=l();e--;if(k===c){a=j;}else{b=a;a=d;}if(a!==c){if(f.length>b){k=f.charAt(b);b++;}else{k=c;if(e===0){g(p);}}if(k!==c){h=i;a=n(k);i=a;}else{b=i;i=d;}}else{b=i;i=d;}}}return i;}function aQ(){var a,d;if(f.substr(b,4)===O){a=O;b+=4;}else{a=c;if(e===0){g(ao);}}if(a===c){if(f.charCodeAt(b)===61){a=ap;b++;}else{a=c;if(e===0){g(aq);}}if(a===c){a=b;if(f.charCodeAt(b)===33){d=ar;b++;}else{d=c;if(e===0){g(as);}}if(d!==c){h=a;d=at();}a=d;}}return a;}function $(){var a,i,g,e,f;a=b;i=b5();if(i!==c){g=[];e=F();if(e!==c){while(e!==c){g.push(e);e=F();}}else{g=d;}if(g===c){g=q;}if(g!==c){e=[];f=az();if(f!==c){while(f!==c){e.push(f);f=az();}}else{e=d;}if(e===c){e=q;}if(e!==c){f=a_();if(f!==c){h=a;i=av(i,g,e,f);a=i;}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}return a;}function aS(){var a,i,k,l,h;a=b;if(f.substr(b,3)===Q){i=Q;b+=3;}else{i=c;if(e===0){g(ay);}}if(i!==c){k=b;e++;l=[];if(y.test(f.charAt(b))){h=f.charAt(b);b++;}else{h=c;if(e===0){g(z);}}if(h!==c){while(h!==c){l.push(h);if(y.test(f.charAt(b))){h=f.charAt(b);b++;}else{h=c;if(e===0){g(z);}}}}else{l=d;}e--;if(l!==c){b=k;k=j;}else{k=d;}if(k!==c){i=[i,k];a=i;}else{b=a;a=d;}}else{b=a;a=d;}return a;}function aT(){var a,i,k,l,h;a=b;if(f.substr(b,4)===V){i=V;b+=4;}else{i=c;if(e===0){g(aG);}}if(i!==c){k=b;e++;l=[];if(y.test(f.charAt(b))){h=f.charAt(b);b++;}else{h=c;if(e===0){g(z);}}if(h!==c){while(h!==c){l.push(h);if(y.test(f.charAt(b))){h=f.charAt(b);b++;}else{h=c;if(e===0){g(z);}}}}else{l=d;}e--;if(l!==c){b=k;k=j;}else{k=d;}if(k!==c){i=[i,k];a=i;}else{b=a;a=d;}}else{b=a;a=d;}return a;}function s(){var a;a=aS();if(a===c){a=aT();}return a;}function l(){var a;if(f.substr(b,2)===k){a=k;b+=2;}else{a=c;if(e===0){g(r);}}return a;}function b5(){var a,k,p,m,n,e,f,j,g,o;a=b;k=aS();if(k!==c){p=i();if(p!==c){m=aX();if(m!==c){n=i();if(n!==c){e=[];f=aM();if(f!==c){while(f!==c){e.push(f);f=aM();}}else{e=d;}if(e===c){e=q;}if(e!==c){f=i();if(f!==c){j=[];g=u();if(g!==c){while(g!==c){j.push(g);g=u();}}else{j=d;}if(j!==c){g=i();if(g!==c){o=l();if(o!==c){h=a;k=aI(m,e,j);a=k;}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}return a;}function a_(){var a,e,g,f,j,k;a=b;e=aT();if(e!==c){g=i();if(g!==c){f=aX();if(f!==c){j=i();if(j!==c){k=l();if(k!==c){h=a;e=aO(f);a=e;}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}return a;}function F(){var d,a;d=b;a=$();if(a!==c){h=d;a=n(a);}d=a;if(d===c){d=b;a=Z();if(a!==c){h=d;a=n(a);}d=a;if(d===c){d=b;a=Y();if(a!==c){h=d;a=n(a);}d=a;if(d===c){d=b;a=X();if(a!==c){h=d;a=n(a);}d=a;}}}return d;}function aX(){var a;a=a$();if(a===c){a=aW();if(a===c){a=b0();if(a===c){a=b1();}}}return a;}function aW(){var a;if(f.substr(b,2)===a2){a=a2;b+=2;}else{a=c;if(e===0){g(aR);}}return a;}function a$(){var a;if(f.substr(b,3)===a0){a=a0;b+=3;}else{a=c;if(e===0){g(aV);}}return a;}function b0(){var a;if(f.substr(b,4)===a1){a=a1;b+=4;}else{a=c;if(e===0){g(a3);}}return a;}function b1(){var a;if(f.substr(b,3)===G){a=G;b+=3;}else{a=c;if(e===0){g(a5);}}return a;}function aM(){var a,k,m,l,j;a=b;if(f.charCodeAt(b)===40){k=a6;b++;}else{k=c;if(e===0){g(a7);}}if(k!==c){m=i();if(m!==c){l=[];j=aB();if(j!==c){while(j!==c){l.push(j);j=aB();}}else{l=d;}if(l!==c){if(f.charCodeAt(b)===41){j=H;b++;}else{j=c;if(e===0){g(I);}}if(j!==c){h=a;k=aa(l);a=k;}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}return a;}function aB(){var a,i,k;a=b;i=b;e++;if(f.charCodeAt(b)===41){k=H;b++;}else{k=c;if(e===0){g(I);}}e--;if(k===c){i=j;}else{b=i;i=d;}if(i!==c){if(f.length>b){k=f.charAt(b);b++;}else{k=c;if(e===0){g(p);}}if(k!==c){h=a;i=ab(k);a=i;}else{b=a;a=d;}}else{b=a;a=d;}return a;}function aA(){var a;if(f.substr(b,4)===P){a=P;b+=4;}else{a=c;if(e===0){g(ad);}}return a;}function az(){var a,f,e,g;a=b;f=b6();if(f!==c){e=[];g=F();if(g!==c){while(g!==c){e.push(g);g=F();}}else{e=d;}if(e===c){e=q;}if(e!==c){h=a;f=ae(f,e);a=f;}else{b=a;a=d;}}else{b=a;a=d;}return a;}function b6(){var a,e,j,k,m,f,g,n;a=b;e=s();if(e!==c){j=i();if(j!==c){k=aA();if(k!==c){m=i();if(m!==c){f=l();if(f!==c){h=a;e=af();a=e;}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}if(a===c){a=b;e=s();if(e!==c){j=i();if(j!==c){k=aA();if(k!==c){m=i();if(m!==c){f=[];g=u();if(g!==c){while(g!==c){f.push(g);g=u();}}else{f=d;}if(f!==c){g=i();if(g!==c){n=l();if(n!==c){h=a;e=ag(f);a=e;}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}return a;}function b7(){var a,h,k,j,m,n,o;a=b;h=s();if(h!==c){k=i();if(k!==c){if(f.charCodeAt(b)===47){j=ah;b++;}else{j=c;if(e===0){g(ai);}}if(j!==c){m=aW();if(m!==c){n=i();if(n!==c){o=l();if(o!==c){h=[h,k,j,m,n,o];a=h;}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}return a;}function T(){var a,j,l,m;a=b;if(f.substr(b,2)===o){j=o;b+=2;}else{j=c;if(e===0){g(E);}}if(j!==c){l=i();if(l===c){l=q;}if(l!==c){if(f.substr(b,2)===k){m=k;b+=2;}else{m=c;if(e===0){g(r);}}if(m!==c){h=a;j=aj(l);a=j;}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}return a;}function B(){var a,j,l,i;a=b;if(f.substr(b,2)===o){j=o;b+=2;}else{j=c;if(e===0){g(E);}}if(j!==c){l=[];i=aw();if(i!==c){while(i!==c){l.push(i);i=aw();}}else{l=d;}if(l!==c){if(f.substr(b,2)===k){i=k;b+=2;}else{i=c;if(e===0){g(r);}}if(i!==c){h=a;j=ak(l);a=j;}else{b=a;a=d;}}else{b=a;a=d;}}else{b=a;a=d;}return a;}function aw(){var a,i,l;a=T();if(a===c){a=[];i=B();if(i!==c){while(i!==c){a.push(i);i=B();}}else{a=d;}if(a===c){a=b;i=b;e++;if(f.substr(b,2)===k){l=k;b+=2;}else{l=c;if(e===0){g(r);}}e--;if(l===c){i=j;}else{b=i;i=d;}if(i!==c){if(f.length>b){l=f.charAt(b);b++;}else{l=c;if(e===0){g(p);}}if(l!==c){h=a;i=m(l);a=i;}else{b=a;a=d;}}else{b=a;a=d;}}}return a;}function i(){var b,a;e++;b=[];a=a9();while(a!==c){b.push(a);a=a9();}e--;if(b===c){a=c;if(e===0){g(al);}}return b;}function a9(){var a;if(am.test(f.charAt(b))){a=f.charAt(b);b++;}else{a=c;if(e===0){g(an);}}return a;}A=N();if(A!==c&&b===f.length){return A;}else{if(A!==c&&b<f.length){g({type:'end',description:'end of input'});}throw W(null,C,x);}}return{SyntaxError:a,parse:c};}();
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETDOMTypes.js';
TP.lang.Object.defineSubtype('core:Node');TP.core.Node.isAbstract(true);TP.core.Node.Type.defineMethod('construct',function(e,c){var a,m,g,b,n,l,k,j,d,h,f,i;TP.debug('break.node_construct');if(!TP.isNode(a=e)){if(!TP.isNode(a=this.constructNativeNode())){return;}}if(TP.isNode(a)){if(TP.isElement(a)&&(TP.notValid(a.ownerDocument)||!TP.nodeContainsNode(a.ownerDocument,a))){m=TP.createDocument();m.appendChild(a);}if(TP.isValid(c)&&(TP.isURI(c)||TP.isString(c))){if(TP.isURI(c)){g=TP.uc(c).getResource(TP.hc('async',false,'resultType',TP.WRAP));if(TP.isKindOf(g,'TP.core.DocumentNode')){g.getDocumentElement().removeAttribute('id');}else if(TP.isKindOf(g,'TP.core.ElementNode')){g.removeAttribute('id');}}else if(TP.isString(c)){g=c;}b=TP.format(a,g,arguments[2]);d=this.construct(b);return d;}}else if(TP.isURI(e)){n=TP.uc(e);if(!TP.isNode(d=n.getResource(TP.hc('async',false,'resultType',TP.WRAP)))){return;}return d.clone(true);}else if(TP.isString(e)){b=e;if(TP.regex.XML_ALL_MARKUP.test(b)){if(!TP.isNode(a=TP.nodeFromString(b))){return;}d=a;h=TP.core.Node.getConcreteType(a);}else{b=e.trim();if(b.endsWith(':')){l=b.slice(0,-1);if(TP.isEmpty(k=TP.w3.Xmlns.getPrefixURI(l))){return;}if(TP.isEmpty(j=TP.w3.Xmlns.getRootElementName(k))){return;}b=TP.join('<',b,j,'/>');if(!TP.isElement(a=TP.nodeFromString(b))){return;}d=a;}else if(TP.isType(h=TP.sys.getTypeByName(b))){d=null;}}if(!TP.isType(h)){h=this;}switch(arguments.length){case 0:case 1:return h.construct(d);case 2:return h.construct(d,c);default:i=TP.args(arguments);i.atPut(0,d);return h.construct.apply(this,i);}}else if(TP.isKindOf(e,'TP.core.Node')){return e;}else{this.raise('TP.sig.InvalidParameter',arguments);return;}if(this.isAbstract()){return this.constructViaSubtype.apply(this,arguments);}if(TP.isValid(f=a[TP.WRAPPER])){return f;}i=TP.args(arguments);i.atPut(0,a);f=this.callNextMethod.apply(this,i);if(TP.isKindOf(c,'TP.lang.Hash')&&TP.isKindOf(f,'TP.core.ElementNode')){c.perform(function(a){f.setAttribute(a.first(),a.last());});}a[TP.WRAPPER]=f;return f;});TP.core.Node.Type.defineMethod('constructNativeNode',function(){var a,b,c;if(this.isAbstract()){this.raise('TP.sig.UnsupportedOperation',arguments,'Cannot construct instance of abstract type.');return;}if(TP.notEmpty(a=this.get('template'))){if(TP.isNode(a)){return TP.nodeCloneNode(a,true);}else if(TP.isURI(a)){b=TP.uc(a);if(!TP.isNode(c=b.getResource(TP.hc('async',false,'resultType',TP.DOM)))){return;}return TP.nodeCloneNode(c,true);}else if(TP.isString(a)){return TP.elementFromString(a);}}return;});TP.core.Node.Type.defineMethod('fromNode',function(a){return this.construct(a);});TP.core.Node.Type.defineMethod('fromString',function(b,c,d){var a;if(!TP.isDocument(a=TP.documentFromString(b,c,d))){return;}return this.fromNode(a);});TP.core.Node.Type.defineMethod('fromTP_core_Node',function(a){return a;});TP.core.Node.Type.defineMethod('fromTP_sig_Signal',function(d){var c,a,b;a=d.get('listener');if(TP.notValid(a)){return this.callNextMethod();}b=TP.elementGetAttribute(a,'observer');if(TP.notValid(b)){return this.callNextMethod();}c=TP.byOID(b);return c;});TP.core.Node.Type.defineMethod('fromTP_core_URI',function(b,c){var a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidURI',arguments);}a=TP.wrap(b.getResourceNode(TP.hc('async',false)));if(TP.isKindOf(a,TP.core.Node)){return a;}return;});TP.core.Node.Type.defineMethod('getCanonicalPrefix',function(d){var a,b,c;a=TP.unwrap(d);if(TP.isDocument(a)){if(!TP.isDocument(a.documentElement)){return'';}a=a.documentElement;}if(TP.notEmpty(b=TP.nodeGetNSURI(a))){c=TP.w3.Xmlns.getCanonicalPrefix(b);}return TP.ifEmpty(c,'');});TP.core.Node.Type.defineMethod('getConcreteType',function(a){if(!TP.isNode(a)){return this.raise('TP.sig.InvalidNode',arguments,'No node provided.');}switch(a.nodeType){case Node.ELEMENT_NODE:return TP.core.ElementNode.getConcreteType(a);case Node.DOCUMENT_NODE:return TP.core.DocumentNode.getConcreteType(a);case Node.DOCUMENT_FRAGMENT_NODE:return TP.core.DocumentFragmentNode;case Node.ATTRIBUTE_NODE:return TP.core.AttributeNode;case Node.TEXT_NODE:return TP.core.TextNode;case Node.CDATA_SECTION_NODE:return TP.core.CDATASectionNode;case Node.PROCESSING_INSTRUCTION_NODE:return TP.core.ProcessingInstructionNode.getConcreteType(a);case Node.ENTITY_REFERENCE_NODE:return TP.core.EntityReferenceNode;case Node.ENTITY_NODE:return TP.core.EntityNode;case Node.COMMENT_NODE:return TP.core.CommentNode;case Node.DOCUMENT_TYPE_NODE:return TP.core.DocumentTypeNode;case Node.NOTATION_NODE:return TP.core.NotationNode;default:return this.raise('TP.sig.InvalidNode',arguments,'Unable to determine node type.');}return;});TP.core.Node.Type.defineMethod('getContentLanguage',function(c){var a,b;a=TP.unwrap(c);if(TP.isDocument(a)){if(!TP.isDocument(a.documentElement)){return'';}a=a.documentElement;}while(TP.isElement(a)){if(TP.notEmpty(b=TP.elementGetAttribute(a,'xml:lang',true))){break;}a=a.parentNode;}return TP.ifEmpty(b,TP.sys.env('tibet.xmllang','en-us')).toLowerCase();});TP.core.Node.Type.defineMethod('getContentMIMEType',function(d){var a,b,c;a=TP.unwrap(d);if(TP.isDocument(a)){return TP.core.Node.getDocumentMIMEType(a);}if(TP.notEmpty(b=TP.nodeGetNSURI(a))){c=TP.w3.Xmlns.getMIMEType(b);}return TP.ifEmpty(c,TP.ietf.Mime.XHTML);});TP.core.Node.Type.defineMethod('getDocumentMIMEType',function(h){var e,a,c,f,b,d,g;e=TP.unwrap(h);a=TP.nodeGetDocument(e);if(!TP.isDocument(a)){return this.raise('TP.sig.InvalidDocument',arguments,'Unable to determine node\'s document.');}if(!TP.isElement(c=a.documentElement)){if(TP.isXMLDocument(a)){return TP.ietf.Mime.XML;}else{return TP.ietf.Mime.PLAIN;}}if(!TP.isXMLDocument(a)){if(c.nodeName.toLowerCase()==='html'){return TP.ietf.Mime.HTML;}else{return TP.ietf.Mime.PLAIN;}}if(TP.notEmpty(f=TP.nodeGetNSURI(c))){if(TP.isValid(b=TP.w3.Xmlns.get('info').at(f))){d=b.at('mimetype');}}else{g=TP.elementGetLocalName(c);b=TP.w3.Xmlns.get('info').detect(function(a){return a.last().at('rootElement')===g;});if(TP.isValid(b)){d=b.last().at('mimetype');}}return TP.ifInvalid(d,TP.ietf.Mime.XML);});TP.core.Node.Type.defineMethod('getQueryPath',function(){return'';});TP.core.Node.Inst.defineAttribute('currentIndex');TP.core.Node.Inst.defineAttribute('changeFlagging',false);TP.core.Node.Inst.defineAttribute('dirty',false);TP.core.Node.Inst.defineAttribute('node');TP.core.Node.Inst.defineAttribute('nodes');TP.core.Node.Inst.defineAttribute('points');TP.core.Node.Inst.defineAttribute('recyclable',true);TP.core.Node.Inst.defineAttribute('phase','UNPROCESSED');TP.core.Node.Inst.defineAttribute('commitPhase','UNPROCESSED');TP.core.Node.Inst.defineAttribute('transactional',false);TP.core.Node.Inst.defineAttribute('uri');TP.core.Node.Inst.defineMethod('init',function(a,b){this.callNextMethod();if(TP.isNode(a)){this.$set('node',a,false);}else{return this.raise('TP.sig.InvalidParameter',arguments);}return this;});TP.core.Node.Inst.defineMethod('addContent',function(b,c){var a;a=TP.str(this.getContent());a+=TP.str(this.produceContentValue(b,c));this.setTextContent(a);return;});TP.core.Node.Inst.defineMethod('asDumpString',function(){var a;a=this.getNativeNode();return TP.tname(this)+' :: '+'('+TP.tname(a)+' :: '+this.asString()+')';});TP.core.Node.Inst.defineMethod('asHTMLNode',function(a){var b;b=TP.isHTMLDocument(a)?a:this.getNativeDocument();return TP.nodeAsHTMLNode(this.getNativeNode(),b);});TP.core.Node.Inst.defineMethod('asHTMLString',function(){return TP.nodeAsHTMLString(this.getNativeNode());});TP.core.Node.Inst.defineMethod('asJSONSource',function(){var a;if(this.$$format_asJSONSource){return TP.recursion(this);}this.$$format_asJSONSource=true;try{a='{"type":'+TP.tname(this).quoted('"')+','+'"data":'+TP.json(this.getNativeNode())+'}';}catch(b){a=this.toString();}delete this.$$format_asJSONSource;return a;});TP.core.Node.Inst.defineMethod('asPrettyString',function(){var a;a=this.getNativeNode();return'<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+TP.tname(a)+'</dd>'+'<dt class="pretty key">Content</dt>'+'<dd class="pretty value">'+TP.pretty(a)+'</dd>'+'</dl>';});TP.core.Node.Inst.defineMethod('asSource',function(){return'TP.tpnode(\''+this.asString()+'\')';});TP.core.Node.Inst.defineMethod('asString',function(d){var a,c,b;a=this.getNativeNode();c=TP.ifInvalid(d,true);if(!c){return TP.nodeAsString(a);}try{if(TP.isDocument(a)){b=TP.nodeAsString(a,true,false);}else{b=TP.nodeAsString(a,false,false);}}catch(a){b=this.toString();}return b;});TP.core.Node.Inst.defineMethod('asXHTMLNode',function(){return this.getNativeNode();});TP.core.Node.Inst.defineMethod('asXHTMLString',function(){return this.asString();});TP.core.Node.Inst.defineMethod('asXMLNode',function(a){var b;b=TP.isXMLDocument(a)?a:this.getNativeDocument();return TP.nodeAsXMLNode(this.getNativeNode(),b);});TP.core.Node.Inst.defineMethod('asXMLString',function(){var a;if(this.$$format_asXMLString){return TP.recursion(this);}this.$$format_asXMLString=true;try{a='<instance type="'+TP.tname(this)+'">'+TP.xmlstr(this.getNativeNode())+'</instance>';}catch(b){a=this.toString();}delete this.$$format_asXMLString;return a;});TP.core.Node.Inst.defineMethod('equalTo',function(b){var a;a=TP.unwrap(b);if(!TP.isNode(a)){return this.raise('TP.sig.InvalidNode',arguments,a);}return TP.nodeEqualsNode(this.getNativeNode(),a);});TP.core.Node.Inst.defineMethod('getAncestorPositions',function(c,a,b){return TP.nodeGetAncestorPositions(this.getNativeNode(),a,b);});TP.core.Node.Inst.defineMethod('getCanonicalPrefix',function(){return TP.core.Node.getCanonicalPrefix(this);});TP.core.Node.Inst.defineMethod('getCanvasID',function(){var a;a=this.getWindow();if(TP.isValid(a)){return a.getCanvasID();}return'';});TP.core.Node.Inst.defineMethod('getContent',function(a){return this.getTextContent();});TP.core.Node.Inst.defineMethod('getContentNode',function(a){return this.getNativeNode();});TP.core.Node.Inst.defineMethod('getContentText',function(a){return this.getTextContent();});TP.core.Node.Inst.defineMethod('getContentLanguage',function(){return TP.core.Node.getContentLanguage(this);});TP.core.Node.Inst.defineMethod('getContentLanguage',function(){return TP.core.Node.getContentLanguage(this);});TP.core.Node.Inst.defineMethod('getContentMIMEType',function(){return TP.core.Node.getContentMIMEType(this);});TP.core.Node.Inst.defineMethod('getControlElement',function(){return TP.wrap(TP.nodeGetControlElement(this.getNativeNode()));});TP.core.Node.Inst.defineMethod('getControlID',function(a){return TP.nodeGetControlID(this.getNativeNode(),a);});TP.core.Node.Inst.defineMethod('getDocument',function(){var c,a,b;c=this.getNativeNode();a=TP.nodeGetDocument(c);if(!TP.isDocument(a)){return this.raise('TP.sig.InvalidDocument',arguments,'Unable to determine node\'s document.');}b=TP.nodeGetWindow(a);if(TP.notValid(b)){return TP.core.Document.construct(a);}return TP.core.Window.construct(b).getDocument();});TP.core.Node.Inst.defineMethod('getDocumentPosition',function(a){return TP.nodeGetDocumentPosition(this.getNativeNode(),a);});TP.core.Node.Inst.defineMethod('getDocumentMIMEType',function(){return TP.core.Node.getDocumentMIMEType(this);});TP.core.Node.Inst.defineMethod('getGlobalID',function(a){return TP.gid(this.getNativeNode(),a);});TP.core.Node.Inst.defineMethod('getID',function(){return TP.gid(this.getNativeNode());});TP.core.Node.Inst.defineMethod('getLocalID',function(a){return TP.lid(this.getNativeNode(),a);});TP.core.Node.Inst.defineMethod('getLocalName',function(){return this.raise('TP.sig.InvalidOperation',arguments);});TP.core.Node.Inst.defineMethod('getLocation',function(){var a;a=this.get('uri');if(TP.isURI(a)){return TP.uc(a).getLocation();}return;});TP.core.Node.Inst.defineMethod('getOuterContent',function(a){return this.asString();});TP.core.Node.Inst.defineMethod('getMIMEType',function(){var a;if(TP.isURI(a=this.get('uri'))){return TP.uc(a).getMIMEType();}return this.getDocumentMIMEType();});TP.core.Node.Inst.defineMethod('getName',function(){return TP.name(this.getNativeNode());});TP.core.Node.Inst.defineMethod('getNativeDocument',function(){return TP.nodeGetDocument(this.getNativeNode());});TP.core.Node.Inst.defineMethod('$$getNativeNodeFast',function(){return this.$get('node');});TP.core.Node.Inst.defineMethod('$$getNativeNodeSlow',function(f,g){var d,a,e,b,c;if(TP.isValid(d=this.$get('currentIndex'))){a=this.$get('nodes').at(d);}else{if(TP.isArray(e=this.$get('nodes'))){a=e.last();}else{a=this.$get('node');}}if(this.shouldFlagChanges()){if(TP.notTrue(g)){b=TP.uc('~lib_xsl/tp_removecrud.xsl');}else if(TP.notTrue(f)){b=TP.uc('~lib_xsl/tp_removedeletes.xsl');}if(TP.isURI(b)){c=b.getNativeNode(TP.hc('async',false));if(TP.isNode(c)){return TP.documentTransformNode(c,a);}else{TP.ifError()?TP.error('Unable to load node filtering transform: \''+b.getLocation(),TP.LOG,arguments):0;}}}return a;});TP.core.Node.Inst.defineMethod('getNativeNode',function(){return this.$get('node');});TP.core.Node.Inst.defineMethod('getNativeObject',function(){return this.getNativeNode();});TP.core.Node.Inst.defineMethod('getNativeWindow',function(){return TP.nodeGetWindow(this.getNativeNode());});TP.core.Node.Inst.defineMethod('getNSPrefixes',function(a,b){return TP.nodeGetNSPrefixes(this.getNativeNode(),a,b);});TP.core.Node.Inst.defineMethod('getNSURI',function(){return TP.nodeGetNSURI(this.getNativeNode());});TP.core.Node.Inst.defineMethod('getNSURIs',function(a){return TP.nodeGetNSURIs(this.getNativeNode(),a);});TP.core.Node.Inst.defineMethod('getProperty',function(a){var c,b;if(!TP.isNode(c=this.getNativeNode())){return this.$get(a);}try{b=c[a];}catch(a){}if(TP.notValid(b)){return this.$get(a);}return b;});TP.core.Node.Inst.defineMethod('getTargetPhase',function(a,b){return TP.nodeGetTargetPhase(this.getNativeNode(),a,b);});TP.core.Node.Inst.defineMethod('getTextContent',function(){return TP.nodeGetTextContent(this.getNativeNode());});TP.core.Node.Inst.defineMethod('getValue',function(){return this.getContent();});TP.core.Node.Inst.defineMethod('getWindow',function(){var a;a=this.getNativeWindow();if(TP.isWindow(a)){a=TP.core.Window.construct(a);}return a;});TP.core.Node.Inst.defineMethod('hasReachedPhase',function(a,b){return TP.nodeHasReachedPhase(this.getNativeNode(),a,b);});TP.core.Node.Inst.defineMethod('isDirty',function(a){if(TP.isBoolean(a)){this.$set('dirty',a,false);}return this.$get('dirty');});TP.core.Node.Inst.defineMethod('isDetached',function(a){return TP.nodeIsDetached(this.getNativeNode());});TP.core.Node.Inst.defineMethod('$$isPair',function(){return false;});TP.core.Node.Inst.defineMethod('isSingleValued',function(){return true;});TP.core.Node.Inst.defineMethod('isScalarValued',function(){return true;});TP.core.Node.Inst.defineMethod('isTransactional',function(a){if(TP.isBoolean(a)){if(TP.isTrue(this.$get('transactional'))){if(!a){this.$set('nodes',null,false);this.$set('points',null,false);this.$set('currentIndex',null,false);if(TP.notTrue(this.shouldFlagChanges())){this.$set('getNativeNode',this.$$getNativeNodeFast,false);}}}else{if(a){this.$set('getNativeNode',this.$$getNativeNodeSlow,false);this.$set('transactional',a,false);this.checkpoint();}}this.$set('transactional',a,false);if(a&&!TP.sys.shouldUseContentCheckpoints()){TP.ifWarn()?TP.warn('Node transactions have been activated but '+'content is not being checkpointed.',TP.LOG,arguments):0;}}return this.$get('transactional');});TP.core.Node.Inst.defineMethod('produceContentValue',function(f,g){var a,c,d,e,b;a=f;if(this.isSingleValued()){a=this.$reduceContentValue(a,g);}if(this.isScalarValued()){if(TP.isNode(a)){c=TP.val(a);}else if(TP.isNodeList(a)){d=TP.ac();e=a.length;for(b=0;b<e;b++){d.atPut(b,TP.val(a[b]));}c=d;}else if(TP.isArray(a)){d=TP.ac();e=a.getSize();for(b=0;b<e;b++){d.atPut(b,TP.val(a.at(b)));}c=d;}else{c=TP.val(a);}}else{c=a;}return c;});TP.core.Node.Inst.defineMethod('$reduceContentValue',function(d,e){var a,b,c;if(TP.isString(d)){return d;}a=d;b=TP.ifKeyInvalid(e,'$INDEX',0);if(TP.canInvoke(a,TP.ac('at','getSize'))){c=a.getSize();if(b>c){a=a.at(c-1);}else if(b<0){a=a.at(0);}else{a=a.at(b);}}else if(TP.isNodeList(a)){c=a.length;try{if(b>c){a=a[c-1];}else if(b<0){a=a[0];}else{a=a[b];}}catch(b){a=undefined;}}return a;});TP.core.Node.Inst.defineMethod('selectChain',function(a){return TP.wrap(TP.nodeSelectChain(this.getNativeNode(),a));});TP.core.Node.Inst.defineMethod('setContent',function(b,c){var a;a=TP.str(this.produceContentValue(b,c));this.setTextContent(a);return;});TP.core.Node.Inst.defineMethod('setNativeNode',function(a,f){var e,b,c,d;if(!TP.isNode(a)){return this.raise('TP.sig.InvalidNode',arguments,a);}e=this.$$getNativeNodeFast();if(TP.isArray(b=this.get('nodes'))){c=this.get('currentIndex');if(TP.isValid(c)){b.length=c;b.add(a);this.$set('currentIndex',null,false);}else{b.atPut(b.getSize()-1,a);}}else{this.$set('node',a,false);}if(TP.notValid(d=f)){d=this.shouldSignalChange();}if(d){this.changed('content',TP.UPDATE,TP.hc(TP.OLDVAL,e,TP.NEWVAL,a));}return this;});TP.core.Node.Inst.defineMethod('setProcessedContent',function(a,b){return this.setContent(a,b);});TP.core.Node.Inst.defineMethod('setProperty',function(a,b,c){var e,d,f;if(!TP.isNode(e=this.getNativeNode())){return this.$set(a,b,c);}if(TP.isDefined(this.$get(a))){return this.$set(a,b,c);}d=this.getProperty(a);if(TP.isDefined(d)){if(typeof d===typeof b){if(d===b){return this;}}}try{e[a]=TP.ifUndefined(b,null);if(e[a]===b){if(TP.notValid(f=c)){f=this.shouldSignalChange();}if(f){this.changed(a,TP.UPDATE);}}else{this.$set(a,b,c);}}catch(d){this.$set(a,b,c);}return this;});TP.core.Node.Inst.defineMethod('setTextContent',function(b){var a;a=this.getNativeNode();TP.nodeSetTextContent(a,b.localize(this.getContentLanguage()));this.changed('value',TP.UPDATE);return this;});TP.core.Node.Inst.defineMethod('setUri',function(a){if(!TP.isURI(a)){return this.raise('TP.sig.InvalidParameter',arguments);}this.$set('uri',a.asString(),false);return this;});TP.core.Node.Inst.defineMethod('setValue',function(c,e){var a,d,b;a=this.getNativeNode();d=TP.nodeGetTextContent(a);if(c===d){return this;}a=this.getNativeNode();TP.nodeSetTextContent(a,c);if(TP.notValid(b=e)){b=this.shouldSignalChange();}if(b){this.changed('value',TP.UPDATE);}return this;});TP.core.Node.Inst.defineMethod('canResolveDNU',function(f,c,g,h){var d,a,b,e;if(!TP.isNode(d=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}if(TP.isEmpty(c)){return false;}switch(d.nodeType){case Node.ELEMENT_NODE:a='element'+c.asTitleCase();if(TP.canInvoke(TP,a)){b='TP';}break;case Node.DOCUMENT_NODE:a='document'+c.asTitleCase();if(TP.canInvoke(TP,a)){b='TP';}break;case Node.ATTRIBUTE_NODE:a='attribute'+c.asTitleCase();if(TP.canInvoke(TP,a)){b='TP';}break;default:break;}if(TP.notValid(b)){a='node'+c.asTitleCase();if(TP.canInvoke(TP,a)){b='TP';}if(TP.notValid(b)){a='object'+c.asTitleCase();if(TP.canInvoke(TP,a)){b='TP';}if(TP.notValid(b)){if(TP.canInvoke(d,c)){b='this.getNativeNode()';e=TP.isCallable(d[c].invoke);}}}}if(TP.notValid(b)){return false;}return this.$$constructDNUResolver(b,a,e);});TP.core.Node.Inst.defineMethod('$$constructDNUResolver',function(a,b,e){var c,d;if(TP.isFalse(e)){c=TP.join('function(arglist)','{','var args;','args = TP.args(arglist);','args.unshift(this.getNativeNode());','return ',a,'[',b,'].','apply(',a,', args);','}');}else{c=TP.join('function(arglist)','{','return ',a,'[',b,'].','apply(',a,', arglist);','}');}d=TP.fc(c);if(!TP.isFunction(d)){return false;}this.getType().Inst.defineMethod(b,d);return TP.canInvoke(this,b);});TP.core.Node.Inst.defineMethod('resolveDNU',function(d,a,b,e){var c;if(!TP.isNode(c=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}if(TP.isEmpty(a)){return false;}return this[a].apply(this,b);});TP.core.Node.Inst.defineMethod('evaluateXPath',function(a,b,c){return TP.xpc(a).exec(this,b,c);});TP.core.Node.Inst.defineMethod('evaluateXPathFromNode',function(b,c,d,a,e){if(!TP.isNode(a)){return this.raise('TP.sig.InvalidNode',arguments);}return TP.xpc(b).execOnNative(a,c,d,e);});TP.core.Node.Inst.defineMethod('getDelegate',function(){return this.getNativeNode();});TP.core.Node.Inst.defineMethod('back',function(b){var e,c,d,a;if(!this.isTransactional()){return this;}e=this.getNativeNode();if(TP.notValid(c=this.get('nodes'))){return this;}if(TP.notEmpty(b)){if(TP.notValid(d=this.get('points'))){return this.raise('TP.sig.InvalidCheckpoint',arguments,'No active checkpoints have been named.');}a=d.at(b);if(TP.notValid(a)){return this.raise('TP.sig.InvalidCheckpoint',arguments,'Checkpoint '+b+' not found.');}this.set('currentIndex',a.max(0));}else{a=this.get('currentIndex');if(TP.notValid(a)){a=c.getSize()-2;}else{a=a-1;}a=a.max(0);if(a!==c.getSize()-1){this.set('currentIndex',a);}}return this;});TP.core.Node.Inst.defineMethod('changed',function(a,b,c){if(TP.isEmpty(a)||a!=='currentIndex'){this.discardCheckpointNodes();}this.discardCheckpointNames();if(!TP.isNode(this.getNativeNode())){return this.callNextMethod();}return this.callNextMethod();});TP.core.Node.Inst.defineMethod('checkpoint',function(c){var d,a,e,b;if(!this.isTransactional()){return this;}d=this.getNativeNode();if(TP.notValid(a=this.get('nodes'))){a=TP.ac();this.$set('nodes',a,false);}if(TP.isNumber(e=this.get('currentIndex'))){a.length=e+1;this.discardCheckpointNames();}if(TP.notEmpty(c)){if(TP.notValid(b=this.get('points'))){b=TP.hc();this.$set('points',b,false);}b.atPut(c,a.getSize()-1);}a.add(TP.nodeCloneNode(d,true,true));this.set('currentIndex',null);return a.getSize();});TP.core.Node.Inst.defineMethod('clone',function(a,b){return TP.wrap(TP.nodeCloneNode(this.getNativeNode(),a,b));});TP.core.Node.Inst.defineMethod('commit',function(){var a;if(!this.isTransactional()){return this;}a=this.getNativeNode();this.$set('node',a,false);this.$set('nodes',null,false);this.$set('points',null,false);this.$set('currentIndex',null,false);this.$set('commitPhase',this.get('phase'));this.checkpoint();return this;});TP.core.Node.Inst.defineMethod('discardCheckpointNames',function(){var a,b;if(!this.isTransactional()){return this;}if(TP.notValid(a=this.get('nodes'))){return this;}if(TP.isEmpty(a)){this.set('points',null);}else if(TP.isArray(b=this.get('points'))){b.perform(function(b){if(b.last()>a.getSize()-1){this.removeKey(b.first());}}.bind(b));}return this;});TP.core.Node.Inst.defineMethod('discardCheckpointNodes',function(){var a,b;if(!this.isTransactional()){return this;}if(TP.notValid(b=this.get('nodes'))){return this;}if(TP.notValid(a=this.get('currentIndex'))){return this;}b.length=a+1;return this;});TP.core.Node.Inst.defineMethod('forward',function(b){var e,c,a,d;e=this.getNativeNode();if(!this.isTransactional()){return this;}if(TP.notValid(c=this.get('nodes'))){return this;}if(TP.notValid(a=this.get('currentIndex'))){return this;}if(TP.notEmpty(b)){if(TP.notValid(d=this.get('points'))){return this.raise('TP.sig.InvalidCheckpoint',arguments,'No active checkpoints have been named.');}a=d.at(b);if(TP.notValid(a)){return this.raise('TP.sig.InvalidCheckpoint',arguments,'Checkpoint '+b+' not found.');}this.set('currentIndex',a);}else{a=this.get('currentIndex')+1;if(a<c.getSize()-1){this.set('currentIndex',a);}else{this.set('currentIndex',null);}}return this;});TP.core.Node.Inst.defineMethod('hasCheckpoint',function(a){var b;if(!TP.isString(a)){return false;}if(TP.notValid(b=this.get('points'))){return false;}return TP.isValid(b.at(a));});TP.core.Node.Inst.defineMethod('rollback',function(a){var e,b,c,d;if(!this.isTransactional()){return this;}e=this.getNativeNode();if(TP.notValid(b=this.get('nodes'))){if(TP.isString(a)){return this.raise('TP.sig.InvalidRollback',arguments,'No active checkpoints have been made.');}else{return this;}}if(TP.isString(a)){if(TP.notValid(d=this.get('points'))){return this.raise('TP.sig.InvalidRollback',arguments,'No active checkpoints have been named.');}if(TP.notValid(c=d.at(a))){return this.raise('TP.sig.InvalidRollback',arguments,'Checkpoint '+a+' not found.');}b.length=c+1;if(TP.core.TSH.CACHE_PHASES.containsString(a)){this.set('phase',a);}}else{b.empty();b.add(TP.nodeCloneNode(this.$get('node'),true));this.$set('points',null,false);this.set('phase',this.get('commitPhase'));}this.$set('currentIndex',null,false);this.changed('value',TP.UPDATE);return this;});TP.core.Node.Inst.defineMethod('toEnd',function(){var a;a=this.getNativeNode();if(!this.isTransactional()){return this;}this.set('currentIndex',null);return this;});TP.core.Node.defineSubtype('core:CollectionNode');TP.core.CollectionNode.isAbstract(true);TP.core.CollectionNode.Type.defineAttribute('namespace',null);TP.core.CollectionNode.Type.defineAttribute('tagname',null);TP.core.CollectionNode.Inst.defineAttribute('preppedReps');TP.core.CollectionNode.Inst.defineMethod('addTIBETSrc',function(c,d){var b,a;b=this.getNativeNode();a=c||this.get('uri');if(TP.notValid(a)){return;}if(TP.isKindOf(a,TP.core.URI)){a=a.getLocation();}TP.documentSetLocation(b,a,d);return this;});TP.core.CollectionNode.Inst.defineMethod('addXMLBase',function(e,f,d){var a,b,c;b=this.getNativeNode();if(this.hasXMLBase()){return this;}a=e||this.get('uri');if(TP.notValid(a)){if(TP.isValid(d)){if(TP.isURI(a=d.at('uri'))){a=a.asString();}else{a='~app_xmlbase';}}else{a='~app_xmlbase';}}if(TP.isDocument(b)){b=b.documentElement;}c=TP.nodeGetDocument(b);if(TP.isEmpty(c)){return this;}b=c.documentElement;if(!TP.isElement(b)){return this;}if(TP.elementHasAttribute(b,'xml:base',true)&&TP.notTrue(f)){return this;}if(TP.uriIsAbsolute(a.getLocation())){a=TP.core.URI.rewrite(a).getLocation();}TP.elementSetAttributeInNS(b,'xml:base',TP.uriCollectionPath(a)+'/',TP.w3.Xmlns.XML);this.changed('@xml:base',TP.CREATE);return this;});TP.core.CollectionNode.Inst.defineMethod('computeAbsoluteURIFromValue',function(f){var a,c,b,d,e;if(TP.isEmpty(d=f)){return'';}a=this.getNativeNode();if(TP.isDocument(a)){c=a.baseURI;a=a.documentElement;}else{c=a.ownerDocument.baseURI;}if(!TP.isURI(b=TP.elementComputeXMLBaseFrom(a))){b=c;}if(TP.isURI(b)&&TP.isURI(d)){e=TP.uriJoinPaths(TP.uriCollectionPath(b),d);}return e;});TP.core.CollectionNode.Inst.defineMethod('getAttribute',function(b,c){var a;a=this.getNativeNode();if(TP.isDocument(a)){a=a.documentElement;}return TP.elementGetAttribute(a,b,c);});TP.core.CollectionNode.Inst.defineMethod('getAttributes',function(b,c){var a;a=this.getNativeNode();if(TP.isDocument(a)){a=a.documentElement;}return TP.elementGetAttributes(a,b,c);});TP.core.CollectionNode.Inst.defineMethod('getContent',function(c){var a,b;a=this.getNativeNode();if(!TP.isFragment(b=TP.nodeListAsFragment(a.childNodes))){return'';}return TP.wrap(b).asString();});TP.core.CollectionNode.Inst.defineMethod('getIndexInParent',function(){return TP.nodeGetIndexInParent(this.getNativeNode());});TP.core.CollectionNode.Inst.defineMethod('getTemplateName',function(){var a;a=this.getAttribute('tsh:template_name');if(TP.notEmpty(a)){a=a.startsWith(TP.TIBET_URN_PREFIX)?a:TP.TIBET_URN_PREFIX+a;return a;}return;});TP.core.CollectionNode.Inst.defineMethod('hasAttribute',function(b,c){var a;a=this.getNativeNode();if(TP.isDocument(a)){a=a.documentElement;}if(!TP.isElement(a)){return this.raise('TP.sig.InvalidOperation',arguments,this);}return TP.elementHasAttribute(a,b,c);});TP.core.CollectionNode.Inst.defineMethod('hasXMLBase',function(){var a;a=this.getNativeNode();if(TP.isDocument(a)){a=a.documentElement;}if(TP.notEmpty(TP.elementGetAttribute(a,'xml:base',true))){return true;}while(TP.isElement(a=a.parentNode)){if(TP.notEmpty(TP.elementGetAttribute(a,'xml:base',true))){return true;}}return false;});TP.core.CollectionNode.Inst.defineMethod('removeAttribute',function(b,d){var c,a;a=this.getNativeNode();if(TP.isDocument(a)){a=a.documentElement;}if(TP.regex.HAS_COLON.test(b)){c=TP.$elementGetPrefixedAttributeNode(a,b,d);}else{c=a.getAttributeNode(b);}if(TP.notValid(c)){return;}if(this.shouldFlagChanges()&&!TP.regex.TIBET_SCHEME.test(b)){TP.elementFlagChange(a,TP.ATTR+b,TP.DELETE);}TP.elementRemoveAttribute(a,b,d);this.changed('@'+b,TP.DELETE);return;});TP.core.CollectionNode.Inst.defineMethod('setAttribute',function(a,c){var b,f,d,g,e,h,i;b=this.getNativeNode();if(TP.isDocument(b)){b=b.documentElement;}d=b.getAttributeNode(a);if(TP.isAttributeNode(d)){f=d.value;if(d.value===c){return;}else{if(this.shouldFlagChanges()&&!TP.regex.TIBET_SCHEME.test(a)){TP.elementFlagChange(b,TP.ATTR+a,TP.UPDATE);}d.value=c;this.changed('@'+a,TP.UPDATE,TP.hc(TP.OLDVAL,f,TP.NEWVAL,c));return;}}if(TP.regex.NS_QUALIFIED.test(a)){g=a.match(TP.regex.NS_QUALIFIED);e=g.at(1);h=g.at(2);if(a.startsWith('xmlns')){if(a==='xmlns'){return;}TP.elementAddNamespace(b,e+':'+h,c);this.changed('@'+a,TP.CREATE);return;}if(this.shouldFlagChanges()&&!TP.regex.TIBET_SCHEME.test(a)){TP.elementFlagChange(b,TP.ATTR+a,TP.CREATE);}if(TP.notEmpty(i=TP.w3.Xmlns.getPrefixURI(e))){TP.elementSetAttributeInNS(b,e+':'+h,c,i);}else{TP.elementSetAttribute(b,a,c);}}else{if(this.shouldFlagChanges()){TP.elementFlagChange(b,TP.ATTR+a,TP.CREATE);}TP.elementSetAttribute(b,a,c);}this.changed('@'+a,TP.CREATE,TP.hc('oldValue',f,'newValue',c));return;});TP.core.CollectionNode.Inst.defineMethod('setAttributes',function(a,b){a.perform(function(a){this.setAttribute(a.first(),a.last(),b);}.bind(this));});TP.core.CollectionNode.Inst.defineMethod('setNativeNode',function(a,h){var c,e,d,b,g,f;if(!TP.isNode(a)){return this.raise('TP.sig.InvalidNode',arguments,a);}if(TP.isArray(c=this.get('nodes'))){e=this.get('currentIndex');if(TP.isNumber(e)){c.length=e;c.add(a);this.$set('currentIndex',null,false);}else{c.atPut(c.getSize()-1,a);}}else{this.$set('node',a,false);}if(TP.isDocument(a)){if(TP.isElement(d=a.documentElement)){b=TP.elementGetAttribute(d,'tibet:phase',true);}}else if(TP.isElement(a)){if(TP.isDocument(g=TP.nodeGetDocument(a))){if(TP.isElement(d=g.documentElement)){b=TP.elementGetAttribute(d,'tibet:phase',true);}}if(TP.isEmpty(b)){b=TP.elementGetAttribute(a,'tibet:phase',true);}}b=TP.ifEmpty(b,'UNPROCESSED');if(b!=='Finalize'){this.$set('preppedReps',null,false);}this.$set('phase',b,false);if(TP.notValid(f=h)){f=this.shouldSignalChange();}if(f){this.changed('content',TP.UPDATE);}return this;});TP.core.CollectionNode.Inst.defineMethod('transform',function(e,f){var c,b,a,d,g;TP.debug('break.content_transform');if(TP.notEmpty(c=this.getTemplateName())){b=TP.uc(c).getResource();if(TP.isCallable(b)){a=b.transform(e,f);TP.regex.XML_ATTR_CONTAINING_NULL.lastIndex=0;a=a.strip(TP.regex.XML_ATTR_CONTAINING_NULL);return a;}}d=this.asString();if(TP.notEmpty(d)&&TP.isCallable(b=d.compile(null,true,false))){c='template_'+TP.genID();this.setAttribute('tsh:template_name',c);g=TP.TIBET_URN_PREFIX+c;TP.uc(g).setResource(b);}if(TP.isCallable(b)){a=b.transform(e,f);TP.regex.XML_ATTR_CONTAINING_NULL.lastIndex=0;a=a.strip(TP.regex.XML_ATTR_CONTAINING_NULL);return a;}return null;});TP.core.CollectionNode.Inst.defineMethod('addContent',function(b,e,d){var a,c;if(TP.notValid(b)||b===''){return this.getNativeNode();}a=TP.request(e);a.atPutIfAbsent('targetPhase',this.getTargetPhase());if(TP.isURI(b)){a.atPutIfAbsent('uri',b);}a.atPut('target',this);a.atPut('async',false);if(TP.notEmpty(d)){c=TP.processAndExecuteWith(b,a,d);}else{c=TP.process(b,a);}return this.addProcessedContent(c,a);});TP.core.CollectionNode.Inst.defineMethod('addProcessedContent',function(f,j){var b,a,d,g,c,i,e,h;b=this.getNativeNode();if(TP.notValid(f)||f===''){return b;}d=TP.request(j);a=TP.unwrap(f);if(!TP.isKindOf(a,Node)&&!TP.isString(a)){a=TP.str(a);}g=this.getContentPrimitive(TP.APPEND);c=this;if(TP.isCallable(i=d.at('loadFunc'))){e=function(a){i(a);c.changed('content',TP.APPEND);};}else{e=function(a){c.contentAppendCallback(a);c.changed('content',TP.APPEND);};}h=g(b,a,e,TP.ifKeyInvalid(d,'awaken',true));if(this.shouldFlagChanges()){TP.elementFlagChange(b,TP.SELF,TP.APPEND);TP.ifTrace(TP.$DEBUG)?TP.trace('Node flagged: '+TP.nodeAsString(b),TP.LOG,arguments):0;}return TP.wrap(h);});TP.core.CollectionNode.Inst.defineMethod('contentAppendCallback',function(a){return;});TP.core.CollectionNode.Inst.defineMethod('contentInsertCallback',function(a){return;});TP.core.CollectionNode.Inst.defineMethod('contentReplaceCallback',function(a){return;});TP.core.CollectionNode.Inst.defineMethod('getContentPrimitive',function(a){switch(a){case TP.APPEND:return TP.nodeAddContent;case TP.INSERT:return TP.nodeInsertContent;case TP.UPDATE:return TP.nodeSetContent;default:return this.raise('TP.sig.InvalidOperation',arguments);}});TP.core.CollectionNode.Inst.defineMethod('insertContent',function(b,e,f,d){var a,c;if(TP.notValid(b)||b===''){return this.getNativeNode();}a=TP.request(f);a.atPutIfAbsent('targetPhase',this.getTargetPhase());if(TP.isURI(b)){a.atPutIfAbsent('uri',b);}a.atPut('target',this);a.atPut('async',false);if(TP.notEmpty(d)){c=TP.processAndExecuteWith(b,a,d);}else{c=TP.process(b,a);}return this.insertProcessedContent(c,e,a);});TP.core.CollectionNode.Inst.defineMethod('insertProcessedContent',function(f,k,j){var b,a,d,h,c,i,e,g;b=this.getNativeNode();if(TP.notValid(f)||f===''){return b;}d=TP.request(j);a=TP.unwrap(f);if(!TP.isKindOf(a,Node)&&!TP.isString(a)){a=TP.str(a);}h=this.getContentPrimitive(TP.INSERT);c=this;if(TP.isCallable(i=d.at('loadFunc'))){e=function(a){i(a);c.changed('content',TP.INSERT);};}else{e=function(a){c.contentInsertCallback(a);c.changed('content',TP.INSERT);};}g=h(b,a,k,e,TP.ifKeyInvalid(d,'awaken',true));if(this.shouldFlagChanges()){TP.elementFlagChange(b,TP.SELF,TP.INSERT);TP.ifTrace(TP.$DEBUG)?TP.trace('Node flagged: '+TP.nodeAsString(b),TP.LOG,arguments):0;}return TP.wrap(g);});TP.core.CollectionNode.Inst.defineMethod('isSingleValued',function(){return false;});TP.core.CollectionNode.Inst.defineMethod('isScalarValued',function(){return false;});TP.core.CollectionNode.Inst.defineMethod('reviveContent',function(a){return this;});TP.core.CollectionNode.Inst.defineMethod('setContent',function(b,e,d){var a,c;if(TP.notValid(b)){return;}else if(b===''){return this.empty();}if(!TP.isElement(c=TP.unwrap(b))&&!TP.isURI(c=TP.str(c))&&!TP.regex.CONTAINS_ELEM_MARKUP.test(c)){return this.callNextMethod();}a=TP.request(e);a.atPutIfAbsent('targetPhase',this.getTargetPhase());if(TP.isURI(b)){a.atPutIfAbsent('uri',b);}a.atPut('target',this);a.atPut('async',false);if(TP.notEmpty(d)){c=TP.processAndExecuteWith(b,a,d);}else{c=TP.process(b,a);}if(a.didFail()){return;}return this.setProcessedContent(c,a);});TP.core.CollectionNode.Inst.defineMethod('setProcessedContent',function(f,k){var b,a,c,h,d,g,j,e,i;b=this.getNativeNode();if(TP.notValid(f)){return;}else if(f===''){return this.empty();}c=TP.request(k);a=TP.unwrap(f);if(!TP.isKindOf(a,Node)&&!TP.isString(a)){a=TP.str(a);}h=this.getContentPrimitive(TP.UPDATE);d=this;g=function(a){var b,d,e;if(TP.isDocument(a)&&TP.isWindow(b=TP.nodeGetWindow(a))&&TP.gid(b)===TP.sys.getUICanvasName()){d=TP.documentGetTitleContent(a);TP.documentSetTitleContent(document,d);if(TP.notEmpty(e=c.at('uri'))){TP.core.History.setLocation(e);}}};if(TP.isCallable(j=c.at('loadFunc'))){e=function(a){j(a);g(a);d.changed('content',TP.UPDATE);};}else{e=function(a){d.contentReplaceCallback(a);g(a);d.changed('content',TP.UPDATE);};}i=h(b,a,e,TP.ifKeyInvalid(c,'awaken',true));if(this.shouldFlagChanges()){TP.elementFlagChange(b,TP.SELF,TP.UPDATE);TP.ifTrace(TP.$DEBUG)?TP.trace('Node flagged: '+TP.nodeAsString(b),TP.LOG,arguments):0;}return TP.wrap(i);});TP.core.CollectionNode.Inst.defineMethod('getAncestors',function(){return TP.wrap(TP.nodeGetAncestors(this.getNativeNode()));});TP.core.CollectionNode.Inst.defineMethod('getChildIndex',function(a){return TP.nodeGetChildIndex(this.getNativeNode(),a);});TP.core.CollectionNode.Inst.defineMethod('getChildNodes',function(){return TP.wrap(TP.nodeGetChildNodes(this.getNativeNode()));});TP.core.CollectionNode.Inst.defineMethod('getChildElementAt',function(a){return TP.wrap(TP.nodeGetChildElementAt(this.getNativeNode(),a));});TP.core.CollectionNode.Inst.defineMethod('getChildElements',function(){return TP.wrap(TP.nodeGetChildElements(this.getNativeNode()));});TP.core.CollectionNode.Inst.defineMethod('getDescendants',function(a){return TP.wrap(TP.nodeGetDescendants(this.getNativeNode(),a));});TP.core.CollectionNode.Inst.defineMethod('getDescendantsByType',function(a,b){return TP.wrap(TP.nodeGetDescendantsByType(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('getDescendantElements',function(a){return TP.wrap(TP.nodeGetDescendantElements(this.getNativeNode(),a));});TP.core.CollectionNode.Inst.defineMethod('getDescendantElementsByAttribute',function(a,b,c){return TP.wrap(TP.nodeGetDescendantElementsByAttribute(this.getNativeNode(),a,b,c));});TP.core.CollectionNode.Inst.defineMethod('getDescendantElementsByAttributePrefix',function(a,b,c){return TP.wrap(TP.nodeGetDescendantElementsByAttributePrefix(this.getNativeNode(),a,b,c));});TP.core.CollectionNode.Inst.defineMethod('getDescendantElementsByIdOrName',function(a){return TP.wrap(TP.nodeGetDescendantElementsByIdOrName(this.getNativeNode(),a));});TP.core.CollectionNode.Inst.defineMethod('getDescendantElementsByName',function(a){return TP.wrap(TP.nodeGetDescendantElementsByName(this.getNativeNode(),a));});TP.core.CollectionNode.Inst.defineMethod('getElementsByClassName',function(a){return TP.wrap(TP.nodeGetElementsByClassName(this.getNativeNode(),a));});TP.core.CollectionNode.Inst.defineMethod('getElementById',function(a,b){if(TP.isPrototype(this)){return;}return TP.wrap(TP.nodeGetElementById(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('getElementByIndex',function(a){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('getElementsBySelector',function(a){return TP.wrap(TP.nodeEvaluateCSS(this.getNativeNode(),a));});TP.core.CollectionNode.Inst.defineMethod('getElementsByTagName',function(a,b){return TP.wrap(TP.nodeGetElementsByTagName(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('getSiblings',function(){return TP.wrap(TP.nodeGetSiblings(this.getNativeNode()));});TP.core.CollectionNode.Inst.defineMethod('generateXPathTo',function(f){var b,a,d,c,e;b=this.getNativeNode();a=TP.unwrap(f);if(!TP.isNode(a)){return this.raise('TP.sig.InvalidNode',arguments,'No node provided.');}if(TP.notTrue(TP.nodeContainsNode(b,a))){return this.raise('TP.sig.InvalidNode',arguments,'Node provided not descendant of receiver.');}if(a.nodeType===Node.ATTRIBUTE_NODE){d='/@'+a.name;c=TP.attributeGetOwnerElement(a);}else{d='/'+a.tagName;c=a.parentNode;}b=this.getNativeNode();if(TP.isDocument(b)){if(TP.isEmpty(b)){return d;}e=b.documentElement.parentNode;}else{e=b;}while(TP.isNode(c)&&c!==e){d='/'+c.tagName+d;c=c.parentNode;}return d;});TP.core.CollectionNode.Inst.defineMethod('getChildTextContent',function(a,b){return TP.nodeGetChildTextContent(this.getNativeNode(),a,b);});TP.core.CollectionNode.Inst.defineMethod('setChildTextContent',function(a,b,c){TP.nodeSetChildTextContent(this.getNativeNode(),a.localize(this.getContentLanguage()),b,c);this.changed('value',TP.UPDATE);return this;});TP.core.CollectionNode.Inst.defineMethod('getFirstElementAncestorByAttribute',function(a,b){return TP.wrap(TP.nodeGetFirstElementAncestorByAttribute(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('getFirstElementAncestorByTagName',function(a,b){return TP.wrap(TP.nodeGetFirstElementAncestorByTagName(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('getFirstElementChildByAttribute',function(a,b){return TP.wrap(TP.nodeGetFirstElementChildByAttribute(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('getFirstElementChildByTagName',function(a,b){return TP.wrap(TP.nodeGetFirstElementChildByTagName(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('getFirstChildByType',function(a){return TP.wrap(TP.nodeGetFirstChildByType(this.getNativeNode(),a));});TP.core.CollectionNode.Inst.defineMethod('getFirstChildContentNode',function(){return TP.wrap(TP.nodeGetFirstChildContentNode(this.getNativeNode()));});TP.core.CollectionNode.Inst.defineMethod('getFirstChildElement',function(){return TP.wrap(TP.nodeGetFirstChildElement(this.getNativeNode()));});TP.core.CollectionNode.Inst.defineMethod('getFirstDescendantByType',function(a){return TP.wrap(TP.nodeGetFirstDescendantByType(this.getNativeNode(),a));});TP.core.CollectionNode.Inst.defineMethod('getFirstElementByAttribute',function(a,b){return TP.wrap(TP.nodeGetFirstElementByAttribute(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('getFirstElementByTagName',function(a,b){return TP.wrap(TP.nodeGetFirstElementByTagName(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('getFirstSiblingElement',function(a){return TP.wrap(TP.nodeGetFirstSiblingElement(this.getNativeNode(),a));});TP.core.CollectionNode.Inst.defineMethod('getNextNonChild',function(a){return TP.wrap(TP.nodeGetNextNonChild(this.getNativeNode(),a));});TP.core.CollectionNode.Inst.defineMethod('getTopAncestor',function(){return TP.wrap(TP.nodeGetTopAncestor(this.getNativeNode()));});TP.core.CollectionNode.Inst.defineMethod('ancestorsPerform',function(a,b){return TP.nodeAncestorsPerform(this.getNativeNode(),a,b);});TP.core.CollectionNode.Inst.defineMethod('childElementsPerform',function(a,b){return TP.nodeChildElementsPerform(this.getNativeNode(),a,b);});TP.core.CollectionNode.Inst.defineMethod('childNodesPerform',function(a,b){return TP.nodeChildNodesPerform(this.getNativeNode(),a,b);});TP.core.CollectionNode.Inst.defineMethod('descendantsPerform',function(a,b){return TP.nodeDescendantsPerform(this.getNativeNode(),a,b);});TP.core.CollectionNode.Inst.defineMethod('descendantElementsPerform',function(a,b){return TP.nodeDescendantElementsPerform(this.getNativeNode(),a,b);});TP.core.CollectionNode.Inst.defineMethod('siblingsPerform',function(a,b,c){return TP.nodeSiblingsPerform(this.getNativeNode(),a,b,c);});TP.core.CollectionNode.Inst.defineMethod('detectAncestor',function(a,b){return TP.wrap(TP.nodeDetectAncestor(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('detectChildElement',function(a,b){return TP.wrap(TP.nodeDetectChildElement(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('detectChildNode',function(a,b){return TP.wrap(TP.nodeDetectChildNode(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('detectDescendant',function(a,b){return TP.wrap(TP.nodeDetectDescendant(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('detectDescendantElement',function(a,b){return TP.wrap(TP.nodeDetectDescendantElement(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('detectSibling',function(a,b,c){return TP.wrap(TP.nodeDetectSibling(this.getNativeNode(),a,b,c));});TP.core.CollectionNode.Inst.defineMethod('selectAncestors',function(a,b){return TP.wrap(TP.nodeSelectAncestors(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('selectChildElements',function(a,b){return TP.wrap(TP.nodeSelectChildElements(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('selectChildNodes',function(a,b){return TP.wrap(TP.nodeSelectChildNodes(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('selectDescendants',function(a,b){return TP.wrap(TP.nodeSelectDescendants(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('selectDescendantElements',function(a,b){return TP.wrap(TP.nodeSelectDescendantElements(this.getNativeNode(),a,b));});TP.core.CollectionNode.Inst.defineMethod('selectSiblings',function(a,b,c){return TP.wrap(TP.nodeSelectDescendants(this.getNativeNode(),a,b,c));});TP.core.CollectionNode.Inst.defineMethod('copyChildNodesTo',function(e,f){var a,d,b,c;a=this.getNativeNode();try{b=a.childNodes.length;}catch(a){}d=TP.nodeCopyChildNodesTo(a,e,f);try{c=a.childNodes.length;if(c<b){this.changed('content',TP.DELETE);}else if(c>b){this.changed('content',TP.INSERT);}else{this.changed('content',TP.UPDATE);}}catch(a){}return TP.wrap(d);});TP.core.CollectionNode.Inst.defineMethod('moveChildNodesTo',function(e,f){var a,d,b,c;a=this.getNativeNode();try{b=a.childNodes.length;}catch(a){}d=TP.nodeMoveChildNodesTo(a,e,f);try{c=a.childNodes.length;if(c<b){this.changed('content',TP.DELETE);}else if(c>b){this.changed('content',TP.INSERT);}else{this.changed('content',TP.UPDATE);}}catch(a){}return TP.wrap(d);});TP.core.CollectionNode.Inst.defineMethod('removeChild',function(c){var b,a;b=this.getNativeNode();a=c;if(this.shouldFlagChanges()){TP.elementFlagChange(a,TP.SELF,TP.DELETE);TP.ifTrace(TP.$DEBUG)?TP.trace('Node flagged: '+TP.nodeAsString(a),TP.LOG,arguments):0;}else{TP.nodeRemoveChild(b,a);}this.changed('content',TP.DELETE);return this;});TP.core.CollectionNode.Inst.defineMethod('add',function(){var b,c,a;b=this.getNativeNode();c=this.length;for(a=0;a<arguments.length;a++){TP.nodeAddContent(b,arguments[a],null,false);}if(arguments.length>0){this.changed('length',TP.INSERT,TP.hc(TP.OLDVAL,c,TP.NEWVAL,this.length));}return this;});TP.core.CollectionNode.Inst.defineMethod('addAll',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('addAllIfAbsent',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('addIfAbsent',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('addItem',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('addWithCount',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('asArray',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('asHash',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('asIterator',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('asRange',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('collapse',function(){return this;});TP.core.CollectionNode.Inst.defineMethod('collect',function(b,c,d){var a;a=this.getNativeNode();if(TP.ifInvalid(c,false)){return TP.nodeGetDescendants(a,d).collect(b);}else{return TP.ac(a.childNodes).collect(b);}});TP.core.CollectionNode.Inst.defineMethod('collectGet',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('collectInvoke',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('compact',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('conform',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('contains',function(a,d){var b,c;b=this.getNativeNode();if(d===TP.IDENTITY){return TP.nodeContainsNode(b,TP.unwrap(a));}c=this.detect(function(b,c){return TP.equal(b,a);},true);return TP.isDefined(c);});TP.core.CollectionNode.Inst.defineMethod('containsAll',function(a,b){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('containsAny',function(a){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('containsString',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('convert',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('countOf',function(a,b){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('detect',function(b,c,d){var a;a=this.getNativeNode();if(TP.ifInvalid(c,false)){return TP.wrap(TP.nodeDetectDescendant(a,b,null,d));}else{return TP.wrap(TP.nodeDetectChildNode(a,b));}});TP.core.CollectionNode.Inst.defineMethod('detectInvoke',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('detectMax',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('detectMin',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('difference',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('disjunction',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('empty',function(){var a;a=this.getNativeNode();if(this.shouldFlagChanges()){TP.elementFlagChange(a,TP.SELF,TP.DELETE);TP.ifTrace(TP.$DEBUG)?TP.trace('Node flagged: '+TP.nodeAsString(a),TP.LOG,arguments):0;}else{TP.nodeEmptyContent(a);}this.changed('content',TP.DELETE);return this;});TP.core.CollectionNode.Inst.defineMethod('flatten',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('getItems',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('getIterator',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('getIteratorType',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('getSize',function(){var a;a=this.getNativeNode();return a.childNodes.length;});TP.core.CollectionNode.Inst.defineMethod('getValues',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('grep',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('groupBy',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('injectInto',function(b,c,d,e){var a;a=this.getNativeNode();if(TP.ifInvalid(d,false)){return TP.nodeGetDescendants(a,e).injectInto(b,c);}else{return TP.ac(a.childNodes).injectInto(b,c);}});TP.core.CollectionNode.Inst.defineMethod('intersection',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('isSortedCollection',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('merge',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('partition',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('perform',function(b,c,d){var a;a=this.getNativeNode();if(TP.ifInvalid(c,false)){TP.nodeDescendantsPerform(a,b,null,d);}else{TP.nodeChildNodesPerform(a,b);}return this;});TP.core.CollectionNode.Inst.defineMethod('performInvoke',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('performSet',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('performUntil',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('performWhile',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('reject',function(b,c,d){var a;a=this.getNativeNode();if(TP.ifInvalid(c,false)){return TP.wrap(TP.nodeGetDescendants(a,d).reject(b));}else{return TP.wrap(TP.ac(a.childNodes).reject(b));}});TP.core.CollectionNode.Inst.defineMethod('remove',function(a){var b;if(TP.isEmpty(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.regex.XPATH_PATH.test(a)){b=TP.xpc(a);b.shouldFlagChanges(this.shouldFlagChanges());return b.execRemove(this);}return this.removeAttribute(a);});TP.core.CollectionNode.Inst.defineMethod('removeAll',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('replace',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('replaceAll',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('select',function(b,c,d){var a;a=this.getNativeNode();if(TP.ifInvalid(c,false)){return TP.wrap(TP.nodeSelectDescendants(a,b,null,d));}else{return TP.wrap(TP.nodeSelectChildNodes(a,b));}});TP.core.CollectionNode.Inst.defineMethod('union',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('unique',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('addAt',function(k,d,j){var e,b,g,h,c,l,a,f,i;e=this.getNativeNode();if(!TP.isNode(k)&&!TP.isKindOf(k,'TP.core.Node')&&!TP.isNodeList(k)){return this.raise('TP.sig.InvalidParameter',arguments,'Must provide a Node or list of Nodes.');}b=TP.unwrap(k);g=TP.ifInvalid(j,TP.AFTER_END);if(TP.regex.XPATH_PATH.test(d)){c=this.evaluateXPath(d);if(TP.isEmpty(c)){return;}l=c.getSize();for(a=0;a<l;a++){if(TP.isNodeList(b)){f=b.length;for(i=0;i<f;i++){try{TP.elementInsertContent(c[a],b[i],g);}catch(a){}}}else{try{TP.elementInsertContent(c[a],b,g);}catch(a){}}}this.changed('content',TP.INSERT);return this;}else{if(!TP.isNumber(parseInt(d,10))){this.raise('TP.sig.InvalidParameter',arguments,'Index must be an XPath or a Number: '+d);return this;}if(e.childNodes.length<d||d<0){return this.raise('TP.sig.IndexOutOfRange',arguments);}if(e.childNodes.length===0&&d===0){if(TP.isNodeList(b)){f=b.length;for(a=0;a<f;a++){TP.nodeAppendChild(e,b[a]);}}else{TP.nodeAppendChild(e,b);}this.changed('content',TP.INSERT);return this;}h=e.childNodes[d];if(TP.isNodeList(b)){switch(g){case TP.BEFORE_END:case TP.BEFORE_BEGIN:f=b.length;for(a=0;a<f;a++){c=TP.elementInsertContent(h,b[a],j);}break;default:for(a=b.length-1;a>=0;a--){c=TP.elementInsertContent(h,b[a],j);}break;}}else{c=TP.elementInsertContent(h,b,j);}if(TP.isValid(c)){this.changed('content',TP.INSERT);}}return this;});TP.core.CollectionNode.Inst.defineMethod('addAllAt',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('at',function(a){return this.get(a);});TP.core.CollectionNode.Inst.defineMethod('atAll',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('atAllIfAbsent',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('atAllPut',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('atIfInvalid',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('atIfNull',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('atIfUndefined',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('atPut',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('atPutIfAbsent',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('containsKey',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('containsValue',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('detectKeyAt',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('getKeys',function(){return this.callNextMethod();});TP.core.CollectionNode.Inst.defineMethod('getKVPairs',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('getPairs',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('getPosition',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('getPositions',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('grepKeys',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('performOver',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('removeAt',function(a){var c,d,b;c=this.getNativeNode();if(TP.regex.XPATH_PATH.test(a)){d=TP.xpc(a);d.shouldFlagChanges(this.shouldFlagChanges());return d.execRemove(this);}if(!TP.isNumber(parseInt(a,10))){this.raise('TP.sig.InvalidParameter',arguments,'Index must be an XPath or a Number: '+a);return this;}if(c.childNodes.length<a||a<0){return this.raise('TP.sig.IndexOutOfRange',arguments);}b=c.childNodes[a];if(this.shouldFlagChanges()){TP.elementFlagChange(b,TP.SELF,TP.DELETE);TP.ifTrace(TP.$DEBUG)?TP.trace('Node flagged: '+TP.nodeAsString(b),TP.LOG,arguments):0;}else{TP.nodeDetach(b);}this.changed('content',TP.DELETE);return this;});TP.core.CollectionNode.Inst.defineMethod('removeAtAll',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('removeKey',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('removeKeys',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('transpose',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('addAfter',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('addAllAfter',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('addAllBefore',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('addAllFirst',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('addAllLast',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('addBefore',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('addFirst',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('addLast',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('after',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('before',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('first',function(d){var a,b,c;a=this.getNativeNode();b=TP.ac(a.childNodes);c=b.first(d);return TP.wrap(c);});TP.core.CollectionNode.Inst.defineMethod('getLastPosition',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('last',function(d){var a,b,c;a=this.getNativeNode();b=TP.ac(a.childNodes);c=b.last(d);return TP.wrap(c);});TP.core.CollectionNode.Inst.defineMethod('orderedBy',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('removeFirst',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('removeLast',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('replaceFirst',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('replaceLast',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('reverse',function(){return TP.todo();});TP.core.CollectionNode.Inst.defineMethod('awaken',function(){TP.nodeAwakenContent(this.getNativeNode());return this;});TP.core.CollectionNode.Inst.defineMethod('compile',function(c){var d,b,e,a,f;TP.debug('break.content_process');d=this.getNativeNode();if(TP.isDocument(d)){this.addTIBETSrc(this.get('uri'));this.addXMLBase(this.get('uri'),null,c);}b=TP.request(c);a=TP.nodeCloneNode(d,true);e=TP.core.TagProcessor.constructWithPhaseTypes(TP.core.TagProcessor.COMPILE_PHASES);e.processTree(a,b);if(b.didFail()){c.fail(b.getFaultCode(),b.getFaultText());return;}if(!TP.isNode(a)){return a;}else if((f=TP.core.Node.getConcreteType(a))===this.getType()){this.setNativeNode(a);}else{return f.construct(a);}return this;});TP.core.CollectionNode.Inst.defineMethod('processTP_sig_Request',function(a){return this.compile(a);});TP.core.CollectionNode.Inst.defineMethod('$escapeCSSConstructs',function(){var a,b;a=this.getNativeNode();if(TP.canInvoke(TP,'$nodeEscapeCSSConstructs')){b=TP.$nodeEscapeCSSConstructs(a);if(b!==a){this.setNativeNode(b,false);}}return;});TP.core.CollectionNode.defineSubtype('DocumentFragmentNode');TP.core.DocumentFragmentNode.Inst.defineMethod('addTIBETSrc',function(a,b){return this;});TP.core.DocumentFragmentNode.Inst.defineMethod('addXMLBase',function(a,b,c){return this;});TP.core.DocumentFragmentNode.Inst.defineMethod('asSource',function(){return'TP.tpfrag(\''+this.asString()+'\')';});TP.core.DocumentFragmentNode.Inst.defineMethod('getAttribute',function(a,b){return;});TP.core.DocumentFragmentNode.Inst.defineMethod('getAttributes',function(a,b){return;});TP.core.DocumentFragmentNode.Inst.defineMethod('getTemplateName',function(){return;});TP.core.DocumentFragmentNode.Inst.defineMethod('hasAttribute',function(a,b){return false;});TP.core.DocumentFragmentNode.Inst.defineMethod('hasXMLBase',function(){return false;});TP.core.DocumentFragmentNode.Inst.defineMethod('removeAttribute',function(a,b){return;});TP.core.DocumentFragmentNode.Inst.defineMethod('setAttribute',function(a,b){return;});TP.core.DocumentFragmentNode.Inst.defineMethod('setAttributes',function(a,b){return;});TP.core.DocumentFragmentNode.Inst.defineMethod('awaken',function(){return this;});TP.core.DocumentFragmentNode.Inst.defineMethod('compile',function(d){var e,a,f,c,g,b;TP.debug('break.content_process');e=this.getNativeNode();a=TP.request(d);f=TP.core.TagProcessor.constructWithPhaseTypes(TP.core.TagProcessor.COMPILE_PHASES);c=TP.nodeGetChildNodes(e);g=c.getSize();for(b=0;b<g;b++){f.processTree(c.at(b),a);if(a.didFail()){d.fail(a.getFaultCode(),a.getFaultText());return;}}return this;});TP.core.DocumentFragmentNode.Inst.defineMethod('generateXPathTo',function(a){return;});TP.core.CollectionNode.defineSubtype('ElementNode');TP.core.ElementNode.isAbstract(true);TP.core.ElementNode.Type.defineAttribute('uriAttrs');TP.core.ElementNode.Type.defineAttribute('template');TP.core.ElementNode.set('uriAttrs',TP.ac());TP.core.ElementNode.Type.defineMethod('constructContentObject',function(c,b){var a;if(TP.isDocument(a=b)){a=b.documentElement;}return this.construct(a);});TP.core.ElementNode.Type.defineMethod('getResourceMarkup',function(h){var a,f,b,d,e,c,g;if(TP.isEmpty(a=h)){f=TP.ac(TP.ietf.Mime.XHTML,TP.ietf.Mime.XML,TP.ietf.Mime.XSLT);f.perform(function(c){if(TP.isURI(b=this.getResourceURI(c))){a=c;return TP.BREAK;}}.bind(this));}else{b=this.getResourceURI(a);}d=b.getLocation();e=b.getResourceNode(TP.hc('async',false));if(!TP.isDocument(e)||!TP.isElement(c=e.documentElement)){return this;}if(TP.notEmpty(d)){TP.elementSetAttribute(c,'tibet:src',d,true);}if(TP.notEmpty(a)){TP.elementSetAttribute(c,'tibet:type',a,true);}g=TP.wrap(c);return g;});TP.core.ElementNode.Type.defineMethod('getResourceTypeName',function(){return this.getName();});TP.core.ElementNode.Type.defineMethod('getResourceURI',function(a,f){var b,c,d,e;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments,'Must supply a valid TP.ietf.Mime reference.');}if(TP.isEmpty(b=TP.ietf.Mime.getExtensions(a))){return;}c=this.getResourceTypeName();d=TP.ifEmpty(f,'');b.perform(function(f){var b,a;b=c+d+'.'+f+'_uri';a=TP.sys.cfg(b);if(TP.notEmpty(a)){e=a;return TP.BREAK;}});return TP.uc(e);});TP.core.ElementNode.Type.defineMethod('guessContentTypeAndLocation',function(f){var c,a,d,b,e;if(!TP.isElement(c=TP.unwrap(f))){return this;}a=TP.elementGetAttribute(c,'tibet:src',true);if(TP.isEmpty(a)){if(TP.notEmpty(d=TP.elementGetAttribute(c,'tibet:type',true))){b=this.getResourceURI(d);if(TP.isURI(b)){a=b.getLocation();}}else{e=TP.ac(TP.ietf.Mime.XHTML,TP.ietf.Mime.XML,TP.ietf.Mime.XSLT);e.perform(function(c){b=this.getResourceURI(c);if(TP.isURI(b)){a=b.getLocation();d=c;return TP.BREAK;}}.bind(this));}}if(TP.notEmpty(a)){TP.elementSetAttribute(c,'tibet:src',a,true);}if(TP.notEmpty(d)){TP.elementSetAttribute(c,'tibet:type',d,true);}return this;});TP.core.ElementNode.Type.defineMethod('fromBoolean',function(a,b){return TP.join('<',this.getTagName(),'>',TP.str(a),'</',this.getTagName(),'>');});TP.core.ElementNode.Type.defineMethod('fromDate',function(b,c){var a;if(TP.isTrue(c.at('escapeContent'))){a=TP.xmlLiteralsToEntities(TP.str(b));}else{a=TP.str(b);}return TP.join('<',this.getTagName(),'>',a,'</',this.getTagName(),'>');});TP.core.ElementNode.Type.defineMethod('fromNumber',function(a,b){return TP.join('<',this.getTagName(),'>',TP.str(a),'</',this.getTagName(),'>');});TP.core.ElementNode.Type.defineMethod('fromObject',function(e,l){var a,i,k,d,b,c,m,f,h,g,j;if(TP.notValid(e)){return this.raise('TP.sig.InvalidObject',arguments);}if(TP.notValid(l)){a=TP.hc();}else{a=l;}if(TP.isNumber(i=a.at('currentLevel'))){if(i===0){d=a;}else if(TP.notValid(k=a.at('infos'))||TP.notValid(d=k.at(i-1))){d=TP.hc();}}else{d=a;}if(TP.notValid(a.at('currentLevel'))){a.atPut('currentLevel',1);}else{a.atPut('currentLevel',a.at('currentLevel')+1);}m=this.getTagName();b=d.at('$attrInfo');if(TP.isEmpty(f=d.at('format'))){f=this.getItemTagName(e,d);}g=this.shouldAutoWrapItems(e,d);if(TP.notValid(f)){f='String';h=null;}else{h=a;}if(!g){if(TP.notValid(b)){c='';}else{if(!TP.isCallable(b)){if(TP.isString(b)){c=' '+b;}else if(TP.isValid(b)){c=' '+b.asAttributeString();}else{c='';}}else{c=' '+b(e);}}j=this.generateMarkup(e,c,f,g,h,a);}else{if(TP.notValid(b)){c='';}else{if(!TP.isCallable(b)){c=' {{$attrStr}}';if(TP.isString(b)){a.atPut('$attrStr',b);}else if(TP.isValid(b)){a.atPut('$attrStr',b.asAttributeString());}else{a.atPut('$attrStr','');}}else{c=' {{%$attrInfo}}';}}j=this.generateMarkup(e,c,f,g,h,a);}a.atPut('currentLevel',a.at('currentLevel')-1);return j;});TP.core.ElementNode.Type.defineMethod('fromString',function(b,c){var a;if(TP.isTrue(c.at('escapeContent'))){a=TP.xmlLiteralsToEntities(TP.htmlEntitiesToXMLEntities(TP.str(b)));}else{a=TP.str(b);}return TP.join('<',this.getTagName(),'>',a,'</',this.getTagName(),'>');});TP.core.ElementNode.Type.defineMethod('generateMarkup',function(d,b,c,h,i,g){var a,e,f;a=this.getTagName();if(TP.isFalse(h)){f=TP.join('<',a,b,'>',d.as(c,i),'</',a,'>');}else{if(TP.isArray(d)||TP.notTrue(g.at('repeat'))){e=TP.join('<',a,b,'>','{{%',c,'}}','</',a,'>');}else{e=TP.join('<',a,b,'>','{{0%',c,'}}','</',a,'>','<',a,b,'>','{{1%',c,'}}','</',a,'>');}f=e.transform(d,g);}return f;});TP.core.ElementNode.Type.defineMethod('getItemTagName',function(a,b){return null;});TP.core.ElementNode.Type.defineMethod('getNativeObserver',function(d){var a,b,c;a=d.get('listener');if(TP.notValid(a)){return null;}if(TP.isEmpty(b=TP.elementGetAttribute(a,'observer'))){b=TP.elementGetAttribute(a,'ev:observer',true);if(TP.isEmpty(b)){return;}}c=TP.byOID(b);if(TP.notValid(c)){return this.raise('TP.sig.InvalidHandler',arguments,'Unable to construct handler instance');}return c;});TP.core.ElementNode.Type.defineMethod('getConcreteType',function(b){var c,d,a,e,g,f,h;if(TP.isValid(a=b.tpNodeType)){return a;}if(TP.notEmpty(c=TP.elementGetAttribute(b,'tibet:nodetype',true))){d=c;if(TP.isType(a=TP.sys.require(c))){TP.isHTMLNode(b)?b.tpNodeType=a:0;return a;}}if(TP.notEmpty(c=TP.elementGetAttribute(b,'tibet:sourcetag',true))&&c!==d){d=c;if(TP.isType(a=TP.sys.require(c))){TP.isHTMLNode(b)?b.tpNodeType=a:0;return a;}if(TP.regex.NS_QUALIFIED.test(c)){if(TP.notEmpty(e=c.match(/(.*):/)[1])){if(TP.isType(a=TP.sys.require(e+':Element'))){TP.isHTMLNode(b)?b.tpNodeType=a:0;return a;}if(TP.notEmpty(g=TP.w3.Xmlns.getPrefixURI(e))){if(TP.isValid(f=TP.w3.Xmlns.get('info').at(g))){if(TP.notEmpty(h=f.at('defaultNodeType'))){if(TP.isType(a=TP.sys.require(h))){TP.isHTMLNode(b)?b.tpNodeType=a:0;return a;}}}}}}}d=c;c=TP.elementGetFullName(b,true);if(c!==d&&TP.isType(a=TP.sys.require(c))){TP.isHTMLNode(b)?b.tpNodeType=a:0;return a;}d=c;c=TP.elementGetCanonicalName(b,true);if(c!==d&&TP.isType(a=TP.sys.require(c))){TP.isHTMLNode(b)?b.tpNodeType=a:0;return a;}if(TP.notEmpty(g=TP.nodeGetNSURI(b))){if(TP.isValid(f=TP.w3.Xmlns.get('info').at(g))){if(TP.notEmpty(e=f.at('prefix'))){if(TP.isType(a=TP.sys.require(e+':Element'))){TP.isHTMLNode(b)?b.tpNodeType=a:0;return a;}}if(TP.notEmpty(h=f.at('defaultNodeType'))){if(TP.isType(a=TP.sys.require(h))){TP.isHTMLNode(b)?b.tpNodeType=a:0;return a;}}}}if(TP.isHTMLNode(b)){return TP.core.HTMLElementNode;}else{return TP.core.XMLElementNode;}});TP.core.ElementNode.Type.defineMethod('getQueryPath',function(){return this.get('nsPrefix')+'|'+this.get('localName');});TP.core.ElementNode.Type.defineMethod('getTagName',function(){return this.get('nsPrefix')+':'+this.get('localName');});TP.core.ElementNode.Type.defineMethod('handleSignal',function(b){var a;a=this.getNativeObserver(b);if(TP.notValid(a)){return this.raise('TP.sig.InvalidHandler',arguments,'Unable to obtain observer.');}return TP.handle(a,b);});TP.core.ElementNode.Type.defineMethod('isBlockLevel',function(){return false;});TP.core.ElementNode.Type.defineMethod('shouldAutoWrapItems',function(b,a){if(TP.isBoolean(a.at('autowrap'))){return a.at('autowrap');}return true;});TP.core.ElementNode.Type.defineMethod('tshExecute',function(a){return TP.CONTINUE;});TP.definePrimitive('nodeAwakenContent',function(a){var b;TP.debug('break.awaken_content');if(!TP.isNode(a)){return TP.raise(this,'TP.sig.InvalidNode',arguments);}b=TP.core.TagProcessor.constructWithPhaseTypes(TP.core.TagProcessor.ATTACH_PHASES);b.processTree(a);return;});TP.core.ElementNode.Type.defineMethod('tagAttachBinds',function(a){});TP.core.ElementNode.Type.defineMethod('tagAttachEvents',function(a){});TP.core.ElementNode.Type.defineMethod('tagUnmarshal',function(c){var a,b;if(!TP.isNode(a=c.at('node'))){return;}if(TP.isEmpty(b=this.get('uriAttrs'))){return;}b.perform(function(d){var b,c;b=TP.elementGetAttribute(a,d,true);if(TP.uriIsAbsolute(b)){c=TP.core.URI.rewrite(b).getLocation();if(c!==b){TP.elementSetAttribute(a,d,c,true);}}});TP.elementResolveXMLBase(a,b);return;});TP.core.ElementNode.Inst.defineMethod('addAttributeValue',function(a,i,c){var b,e,f,g,h,d;b=this.getNativeNode();e=TP.elementHasAttribute(b,a);f=TP.elementGetAttribute(b,a,c);g=TP.elementAddAttributeValue(b,a,i,c);h=TP.elementGetAttribute(b,a,c);d=e?TP.UPDATE:TP.CREATE;if(this.shouldFlagChanges()&&!TP.regex.TIBET_SCHEME.test(a)){TP.elementFlagChange(b,TP.ATTR+a,d);}this.changed('@'+a,d,TP.hc(TP.OLDVAL,f,TP.NEWVAL,h));return g;});TP.core.ElementNode.Inst.defineMethod('addClass',function(e){var a,b,c,d;a=this.getNativeNode();b=TP.elementGetClass(a);c=TP.elementAddClass(a,e);d=TP.elementGetClass(a);if(this.shouldFlagChanges()){TP.elementFlagChange(a,TP.ATTR+'class',TP.UPDATE);}this.changed('@class',TP.UPDATE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,d));return c;});TP.core.ElementNode.Inst.defineMethod('addObserver',function(a,b,c,d){TP.gid(this.getNativeNode(),true);return true;});TP.core.ElementNode.Inst.defineMethod('asSource',function(){return'TP.tpelem(\''+this.asString()+'\')';});TP.core.ElementNode.Inst.defineMethod('get',function(a){var b,d,c;if(TP.isEmpty(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(a==='#document'){return this.getDocument();}if(!TP.isString(a)&&a.isAccessPath()){b=a;}else if(TP.regex.NON_SIMPLE_PATH.test(a)){b=TP.apc(a);}if(TP.notValid(b)){if(TP.regex.ATTRIBUTE.test(a)&&!TP.regex.ATTRIBUTE_ALL.test(a)){return this.getAttribute(a.slice(1));}if(TP.regex.BARENAME.test(a)){return TP.wrap(TP.nodeEvaluateBarename(this.getNativeNode(),a));}c='get'+a.asStartUpper();if(TP.canInvoke(this,c)){switch(arguments.length){case 1:return this[c]();default:d=TP.args(arguments,1);return this[c].apply(this,d);}}c='is'+a.asStartUpper();if(TP.isMethod(this[c])){return this[c]();}}if(TP.isValid(b)||TP.isValid(b=this.getAccessPathFor(a,'value'))){d=TP.args(arguments);d.atPut(0,this);return TP.wrap(b.executeGet.apply(b,d));}return this.getProperty(a);});TP.core.ElementNode.Inst.defineMethod('getChangeAction',function(b){var a;a=TP.elementGetChangeAction(this.getNativeNode(true,true),b);return a;});TP.core.ElementNode.Inst.defineMethod('getID',function(){return TP.gid(this.getNativeNode(),true);});TP.core.ElementNode.Inst.defineMethod('getLocalName',function(){return TP.elementGetLocalName(this.getNativeNode());});TP.core.ElementNode.Inst.defineMethod('getTagName',function(){var a;a=this.getNativeNode();return a.tagName;});TP.core.ElementNode.Inst.defineMethod('removeClass',function(e){var a,b,c,d;a=this.getNativeNode();b=TP.elementGetClass(a);c=TP.elementRemoveClass(a,e);d=TP.elementGetClass(a);if(this.shouldFlagChanges()){TP.elementFlagChange(a,TP.ATTR+'class',TP.DELETE);}this.changed('@class',TP.UPDATE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,d));return c;});TP.core.ElementNode.Inst.defineMethod('resume',function(a){if(TP.notValid(a)){this.removeAttribute('tibet:signalingSuspend');}return TP.resume(this,a);});TP.core.ElementNode.Inst.defineMethod('set',function(a,e,f){var b,c,d;if(TP.isEmpty(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!TP.isString(a)&&a.isAccessPath()){b=a;}else if(TP.regex.NON_SIMPLE_PATH.test(a)){b=TP.apc(a);}if(TP.notValid(b)){if(TP.regex.ATTRIBUTE.test(a)&&!TP.regex.ATTRIBUTE_ALL.test(a)){return this.setAttribute(a.slice(1),e);}c='set'+a.asStartUpper();if(TP.canInvoke(this,c)){switch(arguments.length){case 1:return this[c]();default:d=TP.args(arguments,1);return this[c].apply(this,d);}}if(TP.isBoolean(e)){c='is'+a.asStartUpper();if(TP.isMethod(this[c])){return this[c](e);}}}if(TP.isValid(b)||TP.isValid(b=this.getAccessPathFor(a,'value'))){d=TP.args(arguments);d.atPut(0,this);return b.executeSet.apply(b,d);}return this.setProperty(a,e,f);});TP.core.ElementNode.Inst.defineMethod('setID',function(c){var b,d,a;b=this.getNativeNode();if(TP.notEmpty(a=TP.gid(b,false))&&a!==c){d=TP.sys.hasRegistered(this,a);TP.sys.unregisterObject(this,a);}if(TP.isEmpty(a=c)){a=TP.elemGenID(b);}TP.elementSetAttribute(b,'id',a,true);if(d){a=TP.gid(b,false);TP.sys.registerObject(this,a);}return a;});TP.core.ElementNode.Inst.defineMethod('setPhase',function(a){this.$set('phase',a);TP.elementSetAttribute(this.getNativeNode(),'tibet:phase',a,true);return this;});TP.core.ElementNode.Inst.defineMethod('setValue',function(b,c){var a;this.setContent(b);if(TP.notValid(a=c)){a=this.shouldSignalChange();}if(a){this.changed('value',TP.UPDATE);}return this;});TP.core.ElementNode.Inst.defineMethod('shouldFlagChanges',function(b){var a;a=this.$$getNativeNodeFast();if(TP.isBoolean(b)){if(TP.notTrue(b)){TP.elementRemoveAttribute(a,'tibet:shouldFlagChanges');if(!this.isTransactional()){this.$set('getNativeNode',this.$$getNativeNodeFast,false);}}else{TP.elementSetAttribute(a,'tibet:shouldFlagChanges',true);this.$set('getNativeNode',this.$$getNativeNodeSlow,false);}}return TP.elementGetAttribute(a,'tibet:shouldFlagChanges')==='true';});TP.core.ElementNode.Inst.defineMethod('shouldSignalChange',function(b){var a;a=this.$$getNativeNodeFast();if(TP.isBoolean(b)){if(TP.notTrue(b)){TP.elementRemoveAttribute(a,'tibet:shouldSignalChange');return false;}else{TP.elementSetAttribute(a,'tibet:shouldSignalChange',true);return true;}}if(TP.elementGetAttribute(a,'tibet:signalingSuspend')==='true'){return false;}return TP.elementGetAttribute(a,'tibet:shouldSignalChange')==='true';});TP.core.ElementNode.Inst.defineMethod('suspend',function(a){if(TP.notValid(a)){this.setAttribute('tibet:signalingSuspend','true');}return TP.suspend(this,a);});TP.core.ElementNode.Inst.defineMethod('dispatch',function(d,b,e,f,g,h){var a,c;if(TP.notValid(b)){a=this.getNativeNode();}else if(TP.isString(b)){c=this.getNativeDocument();a=TP.nodeGetElementById(c,b,true);if(!TP.isElement(a)){a=TP.byOID(b);if(TP.canInvoke(a,'getNativeNode')){a=a.getNativeElement();}else if(TP.canInvoke(a,'getNativeDocument')){a=a.getNativeDocument();}else{return this.raise('TP.sig.InvalidTarget',arguments,'Specified target not found: '+b);}}}else if(TP.isElement(b)){a=b;}else if(TP.canInvoke(b,'getNativeNode')){a=b.getNativeNode();}else if(TP.canInvoke(b,'getNativeDocument')){a=b.getNativeDocument();}else{return this.raise('TP.sig.InvalidParameter',arguments,'Specified target not a valid dispatch target');}return TP.dispatch(null,d,a,e,f,g,h);});TP.core.ElementNode.Inst.defineMethod('getEventIds',function(){return TP.elementGetEventIds(this.getNativeNode());});TP.core.ElementNode.Inst.defineMethod('observe',function(a,b,c,d){if(TP.isEmpty(this.getAttribute('id'))){TP.lid(this,true);}return this.callNextMethod();});TP.core.ElementNode.Inst.defineMethod('$formatValue',function(c,g){var e,a,b,d,f;TP.debug('break.bind_format');if(TP.isEmpty(b=this.getAttribute(g,true))){return c;}a=c;if(!TP.regex.MULTI_VALUED.test(b)){if(!TP.isCollection(a)){e=TP.format(a,b);a=TP.notValid(e)?a:e;return a;}else{return a.collect(function(c){var a;a=TP.format(c,b);a=TP.notValid(a)?c:a;return a;});}}b=b.split(' ');f=b.getSize();try{if(!TP.isCollection(a)){for(d=0;d<f;d++){a=TP.format(a,b.at(d));}a=TP.notValid(a)?c:a;return a;}else{a=a.collect(function(d){var c,a;a=d;for(c=0;c<f;c++){a=TP.format(a,b.at(c));}a=TP.notValid(a)?d:a;return a;});}}catch(b){TP.ifError()?TP.error(TP.ec(b,'Formatting error.'),TP.LOG,arguments):0;a=c;}return a;});TP.core.ElementNode.Inst.defineMethod('$validateValue',function(f){var c,a,b,d,e;TP.debug('break.validate');d=f;if(TP.notEmpty(a=this.getAttribute('xsi:type',true))){if(TP.isType(TP.sys.getTypeByName(a))){return a.validate(d,this);}if(TP.isType(a='xs:'.asType())){return a.validate(d,this);}return true;}if(TP.notEmpty(b=this.getAttribute('tibet:type',true))){if(/\|/.test(b)){try{b=b.split('|');for(c=0;c<b.getSize();c++){a=TP.sys.getTypeByName(b.at(c));if(TP.isType(a)){e=a.validate(d);if(e){return true;}}}}catch(a){TP.ifError()?TP.error(TP.ec(a,'Validation error.'),TP.LOG,arguments):0;return true;}}else{try{b=b.split(' ');for(c=0;c<b.getSize();c++){a=TP.sys.getTypeByName(b.at(c));if(TP.isType(a)){e=a.validate(d);if(!e){return false;}}}}catch(a){TP.ifError()?TP.error(TP.ec(a,'Validation error.'),TP.LOG,arguments):0;return true;}}}return true;});TP.core.ElementNode.defineSubtype('HTMLElementNode');TP.core.HTMLElementNode.isAbstract(true);TP.core.HTMLElementNode.Inst.defineMethod('getContentPrimitive',function(a){switch(a){case TP.APPEND:return TP.htmlElementAddContent;case TP.INSERT:return TP.htmlElementInsertContent;case TP.UPDATE:return TP.htmlElementSetContent;default:return this.raise('TP.sig.InvalidOperation',arguments);}});TP.core.ElementNode.defineSubtype('XMLElementNode');TP.core.XMLElementNode.Inst.defineMethod('getContentPrimitive',function(a){switch(a){case TP.APPEND:return TP.xmlElementAddContent;case TP.INSERT:return TP.xmlElementInsertContent;case TP.UPDATE:return TP.xmlElementSetContent;default:return this.raise('TP.sig.InvalidOperation',arguments);}});TP.core.Node.defineSubtype('AttributeNode');TP.core.AttributeNode.Inst.defineMethod('getLocalName',function(){return TP.attributeGetLocalName(this.getNativeNode());});TP.core.AttributeNode.Inst.defineMethod('getTextContent',function(){var a;a=this.getNativeNode();return a.value;});TP.core.Node.defineSubtype('TextNode');TP.core.TextNode.Inst.defineMethod('getTextContent',function(){var a;a=this.getNativeNode();return a.nodeValue;});TP.core.Node.defineSubtype('CDATASectionNode');TP.core.CDATASectionNode.Inst.defineMethod('getTextContent',function(){var a;a=this.getNativeNode();return a.nodeValue;});TP.core.Node.defineSubtype('EntityReferenceNode');TP.core.Node.defineSubtype('EntityNode');TP.core.Node.defineSubtype('ProcessingInstructionNode');TP.core.ProcessingInstructionNode.isAbstract(true);TP.core.ProcessingInstructionNode.Type.defineMethod('getConcreteType',function(c){var a,b;a=c.target;a=a.asTitleCase().strip(TP.regex.PUNCTUATION);b=TP.sys.getTypeByName('TP.core.'+a+'PINode');if(TP.isType(b)){return b;}if(TP.isHTMLNode(c)){return TP.core.HTMLProcessingInstruction;}else{return TP.core.XMLProcessingInstruction;}});TP.core.ProcessingInstructionNode.Inst.defineMethod('getTextContent',function(){var a;a=this.getNativeNode();return a.nodeValue;});TP.core.ProcessingInstructionNode.defineSubtype('TibetStylesheetPINode');TP.core.TibetStylesheetPINode.Type.defineConstant('HREF_REGEX',TP.rc('.*href=[\'"](.*)[\'"]'));TP.core.TibetStylesheetPINode.Type.defineMethod('tagInstructions',function(d){var b,h,c,a,i,e,f,g;if(!TP.isNode(b=d.at('node'))){return;}TP.ifInfo()?TP.sys.logTransform(TP.boot.$annotate(b,'XSLT finalization transform starting.'),TP.INFO,arguments):0;h=TP.nodeGetDocument(b);if(!TP.isElement(c=h.documentElement)){return TP.CONTINUE;}if(TP.elementHasAttribute(c,'tibet:src',true)){a=TP.uriCollectionPath(TP.elementGetAttribute(c,'tibet:src',true));}else if(TP.isValid(d)){if(TP.isValid(a=d.at('uri'))){a=a.asString();a=TP.uriCollectionPath(a);}else{a='~app_xsl';}}else{a='~app_xsl';}i=this.HREF_REGEX.exec(b.data).at(1);if(TP.isEmpty(i)){TP.ifError()?TP.error('Invalid stylesheet href',TP.TRANSFORM_LOG,arguments):0;return;}e=TP.uc(TP.uriResolvePaths(a,i));f=e.getResource(TP.hc('async',false,'resultType',TP.WRAP));if(!TP.canInvoke(f,'getNativeNode')){TP.ifError()?TP.error('Invalid stylesheet at: '+e.getLocation(),TP.TRANSFORM_LOG,arguments):0;return;}if(TP.isKindOf(f,'TP.core.XSLDocumentNode')){g=TP.node(TP.unwrap(f.transform(c,d)));}else{TP.ifError()?TP.error('Invalid stylesheet at '+e.getLocation(),TP.TRANSFORM_LOG,arguments):0;}if(!TP.isNode(g)){return this.raise('TP.sig.InvalidNode',arguments,'Transformation returned empty document.');}h.replaceChild(g,c);b.parentNode.removeChild(b);TP.ifInfo()?TP.sys.logTransform(TP.boot.$annotate(TP.str(g),'XSLT finalization transform complete.'),TP.INFO,arguments):0;return;});TP.core.ProcessingInstructionNode.defineSubtype('HTMLProcessingInstruction');TP.core.ProcessingInstructionNode.defineSubtype('XMLProcessingInstruction');TP.core.Node.defineSubtype('CommentNode');TP.core.CommentNode.Inst.defineMethod('getTextContent',function(){var a;a=this.getNativeNode();return a.nodeValue;});TP.core.CollectionNode.defineSubtype('DocumentNode');TP.core.DocumentNode.isAbstract(true);TP.core.DocumentNode.Type.defineMethod('getConcreteType',function(b){var e,f,c,d,a;e=TP.core.Node.getContentMIMEType(b);if(TP.isString(e)){if(TP.notEmpty(f=TP.ietf.Mime.get('info').at(e))){if(TP.notEmpty(c=f.at('tpDocNodeType'))){if(TP.isType(d=TP.sys.require(c))){return d;}}}}a=TP.core.Node.getCanonicalPrefix(b);if(TP.notEmpty(a)){a=a.toUpperCase();c=a+'DocumentNode';if(TP.isType(d=TP.sys.require(c))){return d;}}if(TP.isHTMLDocument(b)){return TP.core.HTMLDocumentNode;}else if(TP.isXHTMLDocument(b)){return TP.core.XHTMLDocumentNode;}else{return TP.core.XMLDocumentNode;}});TP.core.DocumentNode.Inst.defineMethod('addObserver',function(a,b,c,d){TP.gid(this.getNativeNode(),true);return true;});TP.core.DocumentNode.Inst.defineMethod('asSource',function(){return'TP.tpdoc(\''+this.asString()+'\')';});TP.core.DocumentNode.Inst.defineMethod('get',function(a){var b,d,c;if(TP.isEmpty(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(a==='#document'){return this;}if(!TP.isString(a)&&a.isAccessPath()){b=a;}else if(TP.regex.NON_SIMPLE_PATH.test(a)){b=TP.apc(a);}if(TP.notValid(b)){if(TP.regex.BARENAME.test(a)){return TP.wrap(TP.nodeEvaluateBarename(this.getNativeNode(),a));}c='get'+a.asStartUpper();if(TP.canInvoke(this,c)){switch(arguments.length){case 1:return this[c]();default:d=TP.args(arguments,1);return this[c].apply(this,d);}}c='is'+a.asStartUpper();if(TP.isMethod(this[c])){return this[c]();}}if(TP.isValid(b)||TP.isValid(b=this.getAccessPathFor(a,'value'))){d=TP.args(arguments);d.atPut(0,this);return TP.wrap(b.executeGet.apply(b,d));}return this.getProperty(a);});TP.core.DocumentNode.Inst.defineMethod('getDocument',function(){return this;});TP.core.DocumentNode.Inst.defineMethod('getDocumentElement',function(){return TP.wrap(this.getNativeDocument().documentElement);});TP.core.DocumentNode.Inst.defineMethod('getDocumentElementType',function(){return TP.core.ElementNode.getConcreteType(this.getNativeDocument().documentElement);});TP.core.DocumentNode.Inst.defineMethod('getID',function(){return TP.gid(this.getNativeNode(),true);});TP.core.DocumentNode.Inst.defineMethod('getLocalName',function(){return'document';});TP.core.DocumentNode.Inst.defineMethod('getLocation',function(){var a;a=TP.documentGetLocation(this.getNativeNode());if(TP.isURI(a)){return TP.uc(a).getLocation();}return;});TP.core.DocumentNode.Inst.defineMethod('getNativeDocument',function(){return this.getNativeNode();});TP.core.DocumentNode.Inst.defineMethod('getNativeDocumentElement',function(){return this.getNativeDocument().documentElement;});TP.core.DocumentNode.Inst.defineMethod('getTitle',function(){return TP.documentGetTitleContent(this.getNativeNode());});TP.core.DocumentNode.Inst.defineMethod('getValue',function(){var a;if(TP.isValid(a=this.getDocumentElement())){return a.getValue();}return this.raise('TP.sig.InvalidDocument',arguments,'No document element.');});TP.core.DocumentNode.Inst.defineMethod('setPhase',function(b){var a;this.$set('phase',b);a=this.getNativeDocument().documentElement;if(TP.isNode(a)){TP.elementSetAttribute(a,'tibet:phase',b,true);}return this;});TP.core.DocumentNode.Inst.defineMethod('setTitle',function(a){TP.documentSetTitleContent(this.getNativeNode(),a);return this;});TP.core.DocumentNode.Inst.defineMethod('setValue',function(b,c){var a;if(TP.isValid(a=this.getDocumentElement())){a.setValue(b,c);return this;}return this.raise('TP.sig.InvalidDocument',arguments,'No document element.');});TP.core.DocumentNode.Inst.defineMethod('shouldFlagChanges',function(a){return this.getDocumentElement().shouldFlagChanges(a);});TP.core.DocumentNode.Inst.defineMethod('shouldSignalChange',function(b){var a;a=this.getDocumentElement();if(TP.isValid(a)){return a.shouldSignalChange(b);}});TP.backstop(TP.ac('createElement','createTextNode','getElementsByName','createAttribute','createComment','createDocumentFragment','createCDATASection','createEntityReference','createProcessingInstruction'),TP.core.DocumentNode.getInstPrototype());TP.core.Document=TP.core.DocumentNode;TP.sys.addCustomType('TP.core.Document',TP.core.Document);TP.core.DocumentNode.defineSubtype('HTMLDocumentNode');TP.core.HTMLDocumentNode.Inst.defineMethod('close',function(){var b,a;if(!TP.isHTMLDocument(b=this.getNativeNode())){return this.raise('TP.sig.InvalidDocument',arguments);}a=this.getNativeWindow();if(TP.isWindow(a)){TP.windowAssignCommonIds(a);}b.close();if(TP.isWindow(a)){TP.core.Window.instrument(a);}return;});TP.core.HTMLDocumentNode.Inst.defineMethod('getBody',function(){var a;if(!TP.isDocument(a=this.getNativeNode())){return this.raise('TP.sig.InvalidDocument',arguments);}return TP.wrap(TP.documentGetBody(a));});TP.core.HTMLDocumentNode.Inst.defineMethod('getContentPrimitive',function(a){switch(a){case TP.APPEND:return TP.htmlDocumentAddContent;case TP.INSERT:return TP.htmlDocumentInsertContent;case TP.UPDATE:return TP.htmlDocumentSetContent;default:return this.raise('TP.sig.InvalidOperation',arguments);}});TP.core.HTMLDocumentNode.Inst.defineMethod('getHead',function(){var a;if(!TP.isDocument(a=this.getNativeNode())){return this.raise('TP.sig.InvalidDocument',arguments);}return TP.wrap(TP.documentGetHead(a));});TP.core.HTMLDocumentNode.Inst.defineMethod('getNativeWindow',function(){var a;if(!TP.isDocument(a=this.getNativeNode())){return this.raise('TP.sig.InvalidDocument',arguments);}return TP.nodeGetWindow(a);});TP.core.HTMLDocumentNode.Inst.defineMethod('handleDOMClose',function(a){this.close();TP.handle(this.getWindow(),a,'TP.sig.DOMClose');return;});TP.core.HTMLDocumentNode.Inst.defineMethod('open',function(c){var b,a;if(!TP.isHTMLDocument(b=this.getNativeNode())){return this.raise('TP.sig.InvalidDocument',arguments);}b.open(c);a=this.getNativeWindow();if(TP.isWindow(a)){TP.core.Window.instrument(a);}return this;});TP.core.HTMLDocumentNode.Inst.defineMethod('write',function(e,c){var d,b,a;if(!TP.isHTMLDocument(d=this.getNativeNode())){return this.raise('TP.sig.InvalidDocument',arguments);}if(TP.isCallable(c)){b=this.getNativeWindow();if(TP.isWindow(b)){TP.core.Window.registerOnloadFunction(b,c);}}a=e;if(/tibet_/.test(a)){try{a=a.replace(/tibet__/g,'tibet:');a=TP.$unescapeCSSConstructs(a);}catch(a){return this.raise('TP.sig.InvalidDocument',arguments,TP.ec(a,TP.join('XML-to-XHTML conversion failed. ','Was it truly XHTML?')));}}d.write(a);return this;});TP.core.HTMLDocumentNode.Inst.defineMethod('writeln',function(d,b){var c,a;if(!TP.isHTMLDocument(c=this.getNativeNode())){return this.raise('TP.sig.InvalidDocument',arguments);}if(TP.isCallable(b)){a=this.getNativeWindow();if(TP.isWindow(a)){TP.core.Window.registerOnloadFunction(a,b);}}c.writeln(d);return this;});TP.core.DocumentNode.defineSubtype('XMLDocumentNode');TP.core.XMLDocumentNode.Inst.defineMethod('getContentPrimitive',function(a){switch(a){case TP.APPEND:return TP.xmlDocumentAddContent;case TP.INSERT:return TP.xmlDocumentInsertContent;case TP.UPDATE:return TP.xmlDocumentSetContent;default:return this.raise('TP.sig.InvalidOperation',arguments);}});TP.core.XMLDocumentNode.defineSubtype('XHTMLDocumentNode');TP.core.XHTMLDocumentNode.Inst.defineMethod('getBody',function(){var a;if(!TP.isDocument(a=this.getNativeNode())){return this.raise('TP.sig.InvalidDocument',arguments);}return TP.wrap(TP.documentGetBody(a));});TP.core.XHTMLDocumentNode.Inst.defineMethod('getHead',function(){var a;if(!TP.isDocument(a=this.getNativeNode())){return this.raise('TP.sig.InvalidDocument',arguments);}return TP.wrap(TP.documentGetHead(a));});TP.core.XHTMLDocumentNode.Inst.defineMethod('getNativeWindow',function(){var a;if(!TP.isDocument(a=this.getNativeNode())){return this.raise('TP.sig.InvalidDocument',arguments);}return TP.nodeGetWindow(a);});TP.core.XHTMLDocumentNode.Inst.defineMethod('handleDOMClose',function(a){TP.handle(this.getWindow(),a,'TP.sig.DOMClose');return;});TP.core.XMLDocumentNode.defineSubtype('XSLDocumentNode');TP.core.XSLDocumentNode.Inst.defineMethod('transform',function(a,e){var d,b,c;TP.debug('break.content_transform');d=this.getNativeNode();if(TP.isNode(a)){b=a;}else if(TP.canInvoke(a,'getNativeNode')){b=a.getNativeNode();}else if(TP.isString(a)){b=TP.documentFromString(a);}else if(TP.canInvoke(a,'asXMLNode')){b=a.asXMLNode();}if(!TP.isNode(b)){return this.raise('TP.sig.InvalidNode',arguments);}c=TP.documentTransformNode(d,b,e);if(TP.isNode(c)){return TP.str(c);}return null;});TP.core.Node.defineSubtype('DocumentTypeNode');TP.core.Node.defineSubtype('NotationNode');TP.core.ElementNode.defineSubtype('ActionElementNode');TP.core.ActionElementNode.isAbstract(true);TP.core.ActionElementNode.Type.defineAttribute('requestType','TP.sig.Request');TP.core.ActionElementNode.Type.defineAttribute('requestName');TP.core.ActionElementNode.Type.defineMethod('canAct',function(h){var a,d,e,f,g,c,b;a=true;if(TP.notEmpty(d=TP.elementGetAttributeNodes(h,'acl:*'))){e=TP.sys.getRealUser().getAccessKeys();f=TP.sys.getEffectiveUser().getAccessKeys();g=d.getSize();for(c=0;c<g;c++){b=d[c];switch(b.name){case'acl:if_real':a=false;if(e.containsAny(b.value.split(' '))){a=true;}break;case'acl:if_effective':a=false;if(f.containsAny(b.value.split(' '))){a=true;}break;case'acl:unless_real':if(e.containsAny(b.value.split(' '))){a=false;}break;case'acl:unless_effective':if(f.containsAny(b.value.split(' '))){a=false;}break;}}}return a;});TP.core.ActionElementNode.Type.defineMethod('cmdAddContent',function(a){this.raise('TP.sig.InvalidSink',arguments);return;});TP.core.ActionElementNode.Type.defineMethod('cmdFilterInput',function(a){this.raise('TP.sig.InvalidFilter',arguments);return;});TP.core.ActionElementNode.Type.defineMethod('cmdGetContent',function(a){this.raise('TP.sig.InvalidSource',arguments);return;});TP.core.ActionElementNode.Type.defineMethod('cmdRunContent',function(a){var d,c,b;d=TP.ifKeyInvalid(a,'cmdInteractive',false);if(d){c=a.at('cmdNode');if(TP.notEmpty(TP.elementGetAttribute(c,'ev:event',true))){b=TP.wrap(c).asString();a.stdout(b,TP.hc('cmdBox',false,'cmdAsIs',false,'cmdAppend',true,'echoRequest',true));a.stdout(b,TP.hc('cmdBox',false,'cmdAsIs',true,'echoRequest',true));a.set('result',b);a.complete();return TP.CONTINUE;}}return this.tshExecute(a);});TP.core.ActionElementNode.Type.defineMethod('cmdSetContent',function(a){this.raise('TP.sig.InvalidSink',arguments);return;});TP.core.ActionElementNode.Type.defineMethod('cmdTransformInput',function(a){this.raise('TP.sig.InvalidTransform',arguments);return;});TP.core.ActionElementNode.Type.defineMethod('getActionInput',function(b){var c,a;if(!TP.isNode(c=b.at('cmdNode'))){return;}if(TP.notEmpty(a=b.stdin())){return a;}else{a=this.getPrimaryArgument(b);}if(TP.isValid(a)){a=TP.ac(a);}return a;});TP.core.ActionElementNode.Type.defineMethod('getActionParam',function(b,c){var a;a=b.at('cmdShell');if(TP.notValid(a)){this.raise('TP.sig.InvalidRequest',arguments,'No cmdShell in request.');return;}return a.getParam(b,c);});TP.core.ActionElementNode.Type.defineMethod('getPrimaryArgument',function(b){var c,a;if(TP.isEmpty(c=this.getPrimaryArgumentName())){return;}a=b.at('cmdShell');if(TP.isValid(a)){return a.getArgument(b,c,null,true);}return;});TP.core.ActionElementNode.Type.defineMethod('getPrimaryArgumentName',function(){return;});TP.core.ActionElementNode.Type.defineMethod('showDebug',function(g,u,t){var o,q,m,r,l,s,p,c,j,n,k,i,f,a,d,h,b,e;TP.debug('break.tsh_uri');o=g.at('cmdShell');m=TP.hc();r=g.getPayload();q=r.getKeys();p=q.getSize();for(c=0;c<p;c++){m.atPut(q.at(c),TP.xmlLiteralsToEntities(TP.str(r.at(q.at(c)))));}l=TP.hc();s=o.getArguments(g,true).getItems();p=s.getSize();for(c=0;c<p;c++){j=s.at(c);n=j.first();if(/^ARGV/.test(n)){k=j.last();for(h=0;h<k.getSize();h++){i=k.at(h).first();f=TP.hc('Original value tname',TP.tname(i),'Original value',i);if(TP.notFalse(u)){a=k.at(h).last();if(TP.notDefined(a)){a=TP.UNDEF;d='Undefined';}else if(TP.isNull(a)){a=TP.NULL;d='Null';}else{d=TP.tname(a);}f.add('Expanded value tname',d,'Expanded value',a);}if(TP.isTrue(t)){b=o.resolveObjectReference(a,g);if(TP.notDefined(b)){b=TP.UNDEF;e='Undefined';}else if(TP.isNull(b)){b=TP.NULL;e='Null';}else{e=TP.tname(b);}f.add('Resolved value tname',e,'Resolved value',b);}l.atPut(n+'['+h+']',f);}}else{i=j.last().first();f=TP.hc('Original value tname',TP.tname(i),'Original value',i);if(TP.notFalse(u)){a=j.last().last();if(TP.notDefined(a)){a=TP.UNDEF;d='Undefined';}else if(TP.isNull(a)){a=TP.NULL;d='Null';}else{d=TP.tname(a);}f.add('Expanded value tname',d,'Expanded value',a);}if(TP.isTrue(t)){b=o.resolveObjectReference(a,g);if(TP.notDefined(b)){b=TP.UNDEF;e='Undefined';}else if(TP.isNull(b)){b=TP.NULL;e='Null';}else{e=TP.tname(b);}f.add('Resolved value tname',e,'Resolved value',b);}l.atPut(n,f);}}m.atPut('ARGS:',l);g.stdout(m);g.complete();return;});TP.core.ActionElementNode.Type.defineMethod('tagCompile',function(b){var a;a=b.at('node');TP.elementAddClass(a,'tibet-action');return;});TP.core.ActionElementNode.Type.defineMethod('tshExecute',function(a){return TP.DESCEND;});TP.core.ActionElementNode.Inst.defineMethod('act',function(c){var a,b;TP.debug('break.tsh_action');if(TP.notTrue(this.getType().canAct(this.getNativeNode()))){return this;}a=this.constructActRequest(c);b=TP.core.TSH.getDefaultInstance();b.handleShellRequest(a);return;});TP.core.ActionElementNode.Inst.defineMethod('constructActRequest',function(a){return TP.sig.ShellRequest.construct(TP.hc('cmdLiteral',true,'cmdNode',this.getNativeNode(),'cmdExecute',true,'cmdPhases','Execute','cmdSilent',true,'cmdTrigger',a,TP.STDIN,TP.ac(a.get('payload'))));});TP.core.ActionElementNode.Inst.defineMethod('getActionParam',function(a,b){return this.getType().getActionParam(a,b);});TP.core.ActionElementNode.Inst.defineMethod('getRequestName',function(){return this.getType().get('requestName');});TP.core.ActionElementNode.Inst.defineMethod('getRequestType',function(){var b,a;b=this.getType().get('requestType')||'TP.sig.Request';a=TP.sys.require(b);if(TP.notValid(a)){this.raise('TP.sig.InvalidType',arguments,'Request type not found for: '+this.asString());a=TP.sig.Request;}return a;});TP.core.ActionElementNode.Inst.defineMethod('getDownstreamSegment',function(){var a;a=this.detectSibling(function(a){if(TP.isElement(a)&&TP.elementGetLocalName(a)==='cmd'){return true;}return false;},TP.NEXT);return a;});TP.core.ActionElementNode.Inst.defineMethod('getUpstreamSegment',function(){var a;a=this.detectSibling(function(a){if(TP.isElement(a)&&TP.elementGetLocalName(a)==='cmd'){return true;}return false;},TP.PREVIOUS);return a;});TP.core.ActionElementNode.Inst.defineMethod('getRedirectionType',function(){var a;a=this.getAttribute('tsh:pipe',true);if(TP.TSH_ADD_PIPES.contains(a)){return TP.ADD;}else if(TP.TSH_GET_PIPES.contains(a)){return TP.GET;}else if(TP.TSH_SET_PIPES.contains(a)){return TP.SET;}else if(TP.TSH_FILTER_PIPES.contains(a)){return TP.FILTER;}else if(TP.TSH_TRANSFORM_PIPES.contains(a)){return TP.TRANSFORM;}return TP.NONE;});TP.core.ActionElementNode.Inst.defineMethod('isLastSegment',function(){return TP.notValid(this.getDownstreamSegment());});TP.core.ActionElementNode.Inst.defineMethod('handleSignal',function(b){var a;if(this.shouldSignalChange()){a=this.signal('TP.sig.WillRun');if(a.shouldPrevent()){return;}}try{this.act(b);}catch(a){}finally{if(this.shouldSignalChange()){this.signal('TP.sig.DidRun');}}return;});TP.core.ActionElementNode.Inst.defineMethod('isOutermostAction',function(){var a,b;a=this.getNativeNode();while(TP.isElement(a=a.parentNode)&&TP.isCallable(a.getAttribute)){b=TP.elementGetAttribute(a,'tibet:sourcetag',true);if(b==='xctrls:action'||b==='ev:listener'){return false;}}return true;});TP.core.ElementNode.defineSubtype('InfoElementNode');TP.core.InfoElementNode.isAbstract(true);TP.core.InfoElementNode.Type.defineMethod('cmdAddContent',function(a){this.raise('TP.sig.InvalidSink',arguments);return;});TP.core.InfoElementNode.Type.defineMethod('cmdFilterInput',function(a){this.raise('TP.sig.InvalidFilter',arguments);return;});TP.core.InfoElementNode.Type.defineMethod('cmdGetContent',function(a){this.raise('TP.sig.InvalidSource',arguments);return;});TP.core.InfoElementNode.Type.defineMethod('cmdRunContent',function(a){var d,c,b;d=TP.ifKeyInvalid(a,'cmdInteractive',false);if(d){c=a.at('cmdNode');if(TP.notEmpty(TP.elementGetAttribute(c,'ev:event',true))){b=TP.wrap(c).asString();a.stdout(b,TP.hc('cmdBox',false,'cmdAsIs',false,'cmdAppend',true,'echoRequest',true));a.stdout(b,TP.hc('cmdBox',false,'cmdAsIs',true,'echoRequest',true));a.set('result',b);a.complete();return TP.CONTINUE;}}return this.tshExecute(a);});TP.core.InfoElementNode.Type.defineMethod('cmdSetContent',function(a){this.raise('TP.sig.InvalidSink',arguments);return;});TP.core.InfoElementNode.Type.defineMethod('cmdTransformInput',function(a){this.raise('TP.sig.InvalidTransform',arguments);return;});TP.core.InfoElementNode.Type.defineMethod('tagCompile',function(b){var a;a=b.at('node');TP.elementAddClass(a,'tibet-info');return;});TP.core.ActionElementNode.defineSubtype('PipeSegmentElementNode');TP.core.PipeSegmentElementNode.isAbstract(true);TP.core.PipeSegmentElementNode.Type.defineMethod('cmdFilterInput',function(a){this.processInput(a,'filterInput');return;});TP.core.PipeSegmentElementNode.Type.defineMethod('cmdTransformInput',function(a){this.processInput(a,'transformInput');return;});TP.core.PipeSegmentElementNode.Type.defineMethod('filterInput',function(a,b,c){this.raise('TP.sig.InvalidFilter',arguments);return false;});TP.core.PipeSegmentElementNode.Type.defineMethod('getDefaultAction',function(c){var a,b;if(!TP.isElement(a=c.at('cmdNode'))){return;}b=TP.elementGetAttribute(a,'tsh:pipe',true);if(/\?/.test(b)){return'filterInput';}return'transformInput';});TP.core.PipeSegmentElementNode.Type.defineMethod('processInput',function(a,f){var e,g,i,h,b,c,d;if(!TP.isNode(e=a.at('cmdNode'))){c='No action node.';a.fail(TP.FAILURE,c);return;}if(TP.notValid(g=this.getActionInput(a))){if(this.shouldFailOnEmptyInput()){c='No action input.';a.fail(TP.FAILURE,c);return;}else{g=TP.ac();}}i=g.getSize();for(h=0;h<i;h++){b=g.at(h);if(TP.notValid(b)){continue;}if(a.at('cmdIterate')){if(TP.isCollection(b)){switch(f){case'filterInput':d=b.select(function(b){return this.filterInput(b,e,a);}.bind(this));break;case'transformInput':d=b.collect(function(b){return this.transformInput(b,e,a);}.bind(this));break;default:c='Invalid operation: '+f;a.fail(TP.FAILURE,c);return;}}else{TP.ifWarn()?TP.warn('Splatting with non-collection content.',TP.LOG,arguments):0;d=TP.ac(this[f](b,e,a));}}else{d=this[f](b,e,a);}}if(a.didFail()){a.atPut('cmdAppend',true);a.stdout(TP.sc('Result: ')+d);}else{a.complete(d);}return;});TP.core.PipeSegmentElementNode.Type.defineMethod('shouldFailOnEmptyInput',function(){return true;});TP.core.PipeSegmentElementNode.Type.defineMethod('transformInput',function(a,b,c){this.raise('TP.sig.InvalidTransform',arguments);return;});TP.core.PipeSegmentElementNode.Type.defineMethod('tshExecute',function(a){var b;b=this.getDefaultAction(a);switch(b){case'filterInput':return this.cmdFilterInput(a);case'transformInput':return this.cmdTransformInput(a);default:return TP.CONTINUE;}});TP.core.ElementNode.defineSubtype('xsl:Element');TP.xsl.Element.isAbstract(true);TP.xsl.Element.defineSubtype('stylesheet');TP.xsl.Element.defineSubtype('import');TP.xsl['import'].set('uriAttrs',TP.ac('href'));TP.xsl.Element.defineSubtype('include');TP.xsl.include.set('uriAttrs',TP.ac('href'));TP.core.ElementNode.defineSubtype('xi:Element');TP.xi.Element.isAbstract(true);TP.xi.Element.defineSubtype('include');TP.xi.include.set('uriAttrs',TP.ac('href'));TP.xi.include.Type.defineMethod('tagIncludes',function(n){var a,i,f,c,d,k,h,b,j,e,l,g,m;if(!TP.isNode(a=n.at('node'))){return;}TP.ifInfo()?TP.sys.logTransform(TP.boot.$annotate(TP.str(a),'XInclude content inclusion starting.'),TP.INFO,arguments):0;TP.elementResolveXMLBase(a,this.get('uriAttrs'));i=false;if(TP.isEmpty(f=TP.elementGetAttribute(a,'parse'))){f='xml';}else{f=f.toLowerCase();if(f!=='xml'&&f!=='text'){this.raise('TP.sig.InvalidXInclude',arguments,'XInclude requires parse="text" or parse="xml" : '+TP.nodeAsString(a));return;}}c=TP.elementGetAttribute(a,'href');d=TP.elementGetAttribute(a,'xpointer');if(f==='text'&&TP.notEmpty(d)){this.raise('TP.sig.InvalidXInclude',arguments,'XInclude requires parse="xml" for xpointer: '+TP.nodeAsString(a));return;}if(TP.notEmpty(c)){if(/#/.test(c)){this.raise('TP.sig.InvalidXInclude',arguments,'Invalid href for XInclude: '+TP.nodeAsString(a));return;}}else{if(TP.isEmpty(d)){this.raise('TP.sig.InvalidXInclude',arguments,'XInclude requires href or xpointer value: '+TP.nodeAsString(a));return;}}if(TP.isEmpty(c)){if(/^xmlns/.test(d)){return TP.todo();}else if(TP.notEmpty(k=d.match(TP.regex.XPOINTER))){h=k.at(2).unquoted();if(TP.notEmpty(k=d.match(TP.regex.ID_POINTER))){h=k.at(1).unquoted();b=TP.nodeGetElementById(a,h,true);}else{b=TP.nodeEvaluateXPath(a,h);}}else{b=TP.nodeGetElementById(a,d,true);}}else{if(TP.notEmpty(d)){c=c+'#'+d;}j=TP.uc(c);if(!TP.isURI(j)){this.raise('TP.sig.InvalidXInclude',arguments,'Invalid href value, could not construct URI instance: '+TP.nodeAsString(a));return;}b=j.getResource(TP.hc('async',false));b=TP.unwrap(b);}if(TP.notValid(b)){i=TP.nodeGetFirstElementChildByTagName(a,'fallback');if(TP.isElement(i)){e=TP.nodeMoveChildNodesTo(i,a.parentNode,a);TP.nodeDetach(a);return e;}else{if(TP.notValid(c)){TP.ifWarn()?TP.warn('Invalid HREF attribute for XInclude.',TP.TRANSFORM_LOG,arguments):0;}else if(TP.notValid(j)){TP.ifWarn()?TP.warn('Unable to construct URI for XInclude HREF: '+c,TP.TRANSFORM_LOG,arguments):0;}else{TP.ifWarn()?TP.warn('Content not found for XInclude HREF: '+c,TP.TRANSFORM_LOG,arguments):0;}l=TP.nodeGetDocument(a).createElement('span');TP.nodeAppendChild(l,TP.nodeGetDocument(a).createTextNode('Could not retrieve content for: '+TP.xmlEntitiesToLiterals(TP.nodeAsString(a))));e=TP.nodeReplaceChild(a.parentNode,l,a);return e;}}else if(TP.isDocument(b)){if(TP.notEmpty(b)){b=TP.nodeCloneNode(b.documentElement);e=TP.nodeInsertBefore(a.parentNode,b,a);TP.nodeDetach(a);}}else if(TP.isNode(b)){b=TP.nodeCloneNode(b);e=TP.nodeInsertBefore(a.parentNode,b,a);TP.nodeDetach(a);}else if(TP.isArray(b)){for(g=0;g<b.getSize();g++){m=TP.nodeCloneNode(b.at(g));if(!TP.isNode(e)){e=TP.nodeInsertBefore(a.parentNode,m,a);}else{TP.nodeInsertBefore(a.parentNode,m,a);}}TP.nodeDetach(a);}TP.ifInfo()?TP.sys.logTransform(TP.boot.$annotate(TP.str(a),'XInclude content inclusion complete.'),TP.INFO,arguments):0;return e;});TP.lang.Object.defineSubtype('core:TemplatedNode');TP.core.TemplatedNode.isAbstract(true);TP.core.TemplatedNode.Type.defineAttribute('wantsTemplateWrapper');TP.core.TemplatedNode.Type.defineMethod('tagCompile',function(f){var a,d,e,b,c;if(!TP.isElement(a=f.at('node'))){return;}if(TP.notEmpty(d=TP.elementGetAttribute(a,'tsh:generator',true))){TP.elementRemoveAttribute(a,'tsh:generator',true);if(d===this.getTagName()){return;}}e=TP.ifInvalid(this.get('wantsTemplateWrapper'),false);if(e){b=TP.documentCreateElement(TP.nodeGetDocument(a),'tsh:template',TP.w3.Xmlns.TSH);c=TP.elementGetCanonicalName(a);TP.elementSetAttribute(b,'tsh:name',c,true);TP.elementSetAttribute(b,'tsh:generator',c,true);this.guessContentTypeAndLocation(a);TP.nodeMoveChildNodesTo(a,b);TP.elementMergeAttributes(a,b);TP.elementRemoveAttribute(a,'tibet:phase',true);}else{b=TP.unwrap(this.getResourceMarkup(TP.elementGetAttribute(a,'tibet:type',true)));}b=TP.elementReplaceWith(a,b);return b;});TP.lang.Object.defineSubtype('core:EmbeddedTemplateNode');TP.core.EmbeddedTemplateNode.isAbstract(true);TP.core.EmbeddedTemplateNode.Type.defineMethod('tagAttachDOM',function(d){var a,c,b;if(!TP.isElement(a=d.at('node'))){return;}if(TP.isEmpty(c=TP.nodeGetElementsByTagName(a,'tsh:template'))){return a;}b=TP.lid(a,true);c.perform(function(a){var c,d;if(TP.notEmpty(c=TP.elementGetAttribute(a,'tsh:name',true))){TP.uc(TP.TIBET_URN_PREFIX+c).setResource(null);}TP.elementSetAttribute(a,'tsh:generator',b,true);d=TP.tsh.template.wrapInTransformElement(a,b);TP.nodeReplaceChild(a.parentNode,d,a,false);});return;});TP.lang.Object.defineSubtype('core:XMLRPCNode');TP.core.XMLRPCNode.Type.defineConstant('NIL','<nil/>');TP.core.XMLRPCNode.Type.defineMethod('fromArray',function(g,k,j){var a,f,i,c,b,h,e,d;if(TP.isTrue(j)){a=TP.documentFromString(this.NIL).documentElement;}else{a=TP.XML_FACTORY_DOCUMENT.createTextNode('');}if(TP.notValid(g)){return a;}f=TP.XML_FACTORY_DOCUMENT.createElement('data');i=g.getSize();for(c=0;c<i;c++){b=TP.XML_FACTORY_DOCUMENT.createElement('value');if(TP.notValid(h=g.at(c))){a=TP.nodeAppendChild(b,a);}else{try{TP.nodeAppendChild(b,h.as('TP.core.XMLRPCNode'));}catch(a){if(TP.notValid(e=TP.str(a))){e='!!! SERIALIZATION ERROR !!!';}TP.nodeAppendChild(b,e.as('TP.core.XMLRPCNode'));}}TP.nodeAppendChild(f,b);}d=TP.XML_FACTORY_DOCUMENT.createElement('array');TP.nodeAppendChild(d,f);return d;});TP.core.XMLRPCNode.Type.defineMethod('fromBoolean',function(b,c,d){var a;a=TP.XML_FACTORY_DOCUMENT.createElement('boolean');TP.nodeAppendChild(a,TP.XML_FACTORY_DOCUMENT.createTextNode(b.asNumber()));return a;});TP.core.XMLRPCNode.Type.defineMethod('fromDate',function(b,c,d){var a;a=TP.XML_FACTORY_DOCUMENT.createElement('dateTime.iso8601');TP.nodeAppendChild(a,TP.XML_FACTORY_DOCUMENT.createTextNode(b.as('TP.iso.ISO8601',TP.iso.ISO8601.FORMATS.at('YYYYMMDDTHH:MM:SS'))));return a;});TP.core.XMLRPCNode.Type.defineMethod('fromNumber',function(b,c,d){var a;if(b.round()===b){a=TP.XML_FACTORY_DOCUMENT.createElement('i4');}else{a=TP.XML_FACTORY_DOCUMENT.createElement('double');}TP.nodeAppendChild(a,TP.XML_FACTORY_DOCUMENT.createTextNode(b.toString()));return a;});TP.core.XMLRPCNode.Type.defineMethod('fromObject',function(h,o,n){var e,m,i,j,g,k,c,l,f,d,b,a;if(TP.isTrue(n)){e=TP.documentFromString(this.NIL).documentElement;}else{e=TP.XML_FACTORY_DOCUMENT.createTextNode('');}if(TP.notValid(h)){return e;}m=TP.XML_FACTORY_DOCUMENT.createElement('data');i=TP.XML_FACTORY_DOCUMENT.createElement('struct');j=TP.ifInvalid(o,'unique_attributes');g=h.getKeys(j).sort();k=g.getSize();for(c=0;c<k;c++){f=TP.XML_FACTORY_DOCUMENT.createElement('member');d=TP.XML_FACTORY_DOCUMENT.createElement('name');b=g.at(c);TP.nodeAppendChild(d,TP.XML_FACTORY_DOCUMENT.createTextNode(b));d=TP.nodeAppendChild(f,d);a=TP.XML_FACTORY_DOCUMENT.createElement('value');if(TP.notValid(l=h.at(g.at(c)))){TP.nodeAppendChild(a,e);}else{try{TP.nodeAppendChild(a,l.as('TP.core.XMLRPCNode'));}catch(c){if(TP.notValid(b=TP.str(c))){b='!!! SERIALIZATION ERROR !!!';}TP.nodeAppendChild(a,b.as('TP.core.XMLRPCNode'));}}TP.nodeAppendChild(f,a);TP.nodeAppendChild(i,f);}return i;});TP.core.XMLRPCNode.Type.defineMethod('fromString',function(b,c,d){var a;a=TP.XML_FACTORY_DOCUMENT.createElement('string');TP.nodeAppendChild(a,TP.XML_FACTORY_DOCUMENT.createTextNode(TP.xmlLiteralsToEntities(TP.htmlEntitiesToXmlEntities(b.asString()))));return a;});TP.core.XMLRPCNode.Type.defineMethod('fromTP_lang_Hash',function(a,b,c){return this.fromObject(a,b,c);});TP.core.XMLRPCNode.Type.defineMethod('objectFromNodeViaXSLT',function(aNode){var doc,node,url,styleDoc,newNode,jsString,$$inst;url=TP.uc('~lib_xsl/tp_xmlrpc2js.xsl');if(TP.isURI(url)){styleDoc=url.getNativeNode();if(!TP.isXMLDocument(styleDoc)){this.raise('TP.sig.InvalidStylesheet',arguments,url.getLocation());}}else{this.raise('TP.sig.InvalidStylesheet',arguments,url.getLocation());}if(TP.isNode(aNode)){node=aNode;}else{node=aNode.getNativeNode();}if(!TP.isXMLDocument(node)){doc=TP.createDocument();TP.nodeAppendChild(doc,node);node=doc;}newNode=TP.documentTransformNode(styleDoc,node);if(!TP.isNode(newNode)){return this.raise('TP.sig.XSLTException',arguments);}jsString=TP.nodeGetTextContent(newNode.documentElement);if(TP.isEmpty(jsString)){return this.raise('InvalidTP.core.XMLRPCNode',arguments);}try{jsString=jsString.replace(/\&lt;/g,'<').replace(/\&gt;/g,'>').replace(/\&apos;/g,'\'').replace(/\&quot;/g,'"').replace(/\&nbsp;/g,' ').replace(/\&amp;/g,'&');$$inst=eval(jsString);}catch(a){return this.raise('InvalidTP.core.XMLRPCNode',arguments,TP.ec(a,TP.join('Error in: ',jsString)));}return $$inst;});TP.core.XMLRPCNode.Type.defineMethod('objectFromNode',function(g){var h,c,k,j,f,i,b,d,e,l,a;if(!TP.isNode(g)){return;}if(!TP.isElement(g)){b=g.firstChild;}else{b=g;}l=TP.elementGetLocalName(b);a=b.firstChild;switch(l){case'array':a=TP.nodeGetChildElementAt(b,0);if(TP.isNode(a)&&TP.elementGetLocalName(a)==='data'){f=TP.ac();e=TP.nodeGetChildElements(a);h=e.getSize();for(c=0;c<h;c++){d=e.at(c);if(TP.elementGetLocalName(d)==='value'){f.add(this.objectFromNode(d));}}return f;}else{return this.raise('InvalidTP.core.XMLRPCNode',arguments,b);}break;case'base64':if(TP.isNode(a)){i=TP.str(a.nodeValue);try{return TP.atob(i);}catch(a){return i;}}else{return null;}break;case'boolean':return TP.isNode(a)?a.nodeValue===1:null;case'dateTime.iso8601':return TP.isNode(a)?Date.fromString(a.nodeValue):null;case'double':case'int':case'i4':return TP.isNode(a)?TP.nc(a.nodeValue):null;case'string':return TP.isNode(a)?TP.str(TP.xmlEntitiesToLiterals(a.nodeValue)):null;case'struct':f=TP.hc();e=TP.nodeGetChildElements(b);h=e.getSize();for(c=0;c<h;c++){d=e.at(c);if(TP.elementGetLocalName(d)==='member'){k=TP.nodeGetChildElementAt(d,0);j=TP.nodeGetChildElementAt(d,1);f.atPut(k.firstChild.nodeValue,this.objectFromNode(j));}}return f;case'value':a=TP.nodeGetChildElementAt(b,0);if(TP.isNode(a)){return this.objectFromNode(a);}else{a=b.firstChild;return TP.isNode(a)?TP.str(a.nodeValue):null;}break;default:return this.raise('InvalidTP.core.XMLRPCNode',arguments,b);}});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETUIDOMTypes.js';
TP.core.ElementNode.defineSubtype('UIElementNode');TP.core.UIElementNode.isAbstract(true);TP.core.UIElementNode.Type.defineAttribute('keyBindingsURI');TP.core.UIElementNode.Type.defineAttribute('keyBindingsXML');TP.core.UIElementNode.Type.defineAttribute('$focusingTPElement');TP.core.UIElementNode.Type.defineMethod('addStylesheetTo',function(a){var c,b,d,j,g,e,i,h,f;if(!TP.isDocument(a)){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}c=TP.escapeTypeName(this.getResourceTypeName());if(TP.isElement(TP.byId(c,a))){return this;}if(TP.notValid(d=this.getResourceURI(TP.ietf.Mime.CSS))){return this;}j=TP.nodeGetElementsByTagName(TP.documentGetHead(a),'style');b=TP.documentAddLinkElement(a,d.getLocation(),j.first());TP.elementSetAttribute(b,'id',c);g=TP.byCSS('*[data-theme]',a);i=g.getSize();for(e=0;e<i;e++){h=TP.elementGetAttribute(g.at(e),'data-theme');f=c+'_'+h;if(TP.isElement(TP.byId(f,a))){continue;}if(TP.notValid(d=this.getThemeURI(TP.ietf.Mime.CSS,h))){return this;}b=TP.documentAddLinkElement(a,d.getLocation(),b.nextSibling);TP.elementSetAttribute(b,'id',f);}return this;});TP.core.UIElementNode.Type.defineMethod('getCompilationAttrs',function(b){var a;if(!TP.isElement(a=b.at('node'))){return TP.hc();}return TP.hc('class',TP.qname(a).replace(':','-')+' '+TP.elementGetAttribute(a,'class'),'tibet:phase','Compile');});TP.core.UIElementNode.Type.defineMethod('getKeyBindingsXML',function(){var a;if(TP.isXMLDocument(a=this.$get('keyBindingsXML'))){return a;}if(a!==TP.NOT_FOUND){this.loadKeyBindings();if(TP.isXMLDocument(a=this.$get('keyBindingsXML'))){return a;}}if(this!==TP.core.UIElementNode){return this.getSupertype().getKeyBindingsXML();}return null;});TP.core.UIElementNode.Type.defineMethod('getThemeURI',function(a,b){var c,d,e;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments,'Must supply a valid TP.ietf.Mime reference.');}if(TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments,'Must supply a valid theme name.');}if(TP.isEmpty(c=TP.ietf.Mime.getExtensions(a))){return;}d=this.getResourceTypeName();c.perform(function(f){var c,a;c=d+'.'+f+'_'+b+'_uri';a=TP.sys.cfg(c);if(TP.notEmpty(a)){e=a;return TP.BREAK;}});return TP.uc(e);});TP.core.UIElementNode.Type.defineMethod('handlePeerTP_sig_DOMBlur',function(a,d){var b,c;if(!TP.isElement(a)){return this.raise('TP.sig.InvalidElement',arguments);}b=TP.wrap(a);c=b.signal('TP.sig.UIBlur');if(c.shouldPrevent()){d.preventDefault();return this;}return this;});TP.core.UIElementNode.Type.defineMethod('handlePeerTP_sig_DOMFocus',function(a,d){var b,c;if(!TP.isElement(a)){return this.raise('TP.sig.InvalidElement',arguments);}b=TP.wrap(a);c=b.signal('TP.sig.UIFocus');if(c.shouldPrevent()){d.preventDefault();return this;}return this;});TP.core.UIElementNode.Type.defineMethod('handlePeerTP_sig_DOMKeyDown',function(g,b){var a,d,h,i,e,f,c;if(!TP.isElement(g)){return this.raise('TP.sig.InvalidElement',arguments);}a=TP.wrap(g);if(a.canHandleKey(b)){d=TP.domkeysigname(b);if(d==='DOM_Enter_Down'){h=a.signal('TP.sig.UIActivate');if(h.shouldPrevent()){b.preventDefault();}return this;}b.preventDefault();c=null;if(TP.isType(i=a.getType())){e=i.getKeyBindingsXML();if(TP.isXMLDocument(e)){f=TP.nodeEvaluateXPath(e,'descendant-or-self::*[@id = "'+d+'"]',TP.FIRST_NODE);if(TP.isElement(f)){c=TP.elementGetAttribute(f,'signal');if(TP.isType(TP.sys.require(c))){a.signal(c);return this;}}}}}return this;});TP.core.UIElementNode.Type.defineMethod('handlePeerTP_sig_DOMKeyUp',function(c,a){var b,d,e;if(!TP.isElement(c)){return this.raise('TP.sig.InvalidElement',arguments);}b=TP.wrap(c);if(b.canHandleKey(a)){d=TP.domkeysigname(a);if(d==='DOM_Enter_Up'){e=b.signal('TP.sig.UIDeactivate');if(e.shouldPrevent()){a.preventDefault();}}}return this;});TP.core.UIElementNode.Type.defineMethod('handlePeerTP_sig_DOMMouseDown',function(b,d){var a,c;if(!TP.isElement(b)){return this.raise('TP.sig.InvalidElement',arguments);}a=TP.wrap(b);c=a.signal('TP.sig.UIActivate');if(c.shouldPrevent()){d.preventDefault();}if(a.canFocus()){this.set('$focusingTPElement',a);}return this;});TP.core.UIElementNode.Type.defineMethod('handlePeerTP_sig_DOMMouseUp',function(a,d){var b,c;if(!TP.isElement(a)){return this.raise('TP.sig.InvalidElement',arguments);}b=TP.wrap(a);c=b.signal('TP.sig.UIDeactivate');if(c.shouldPrevent()){d.preventDefault();}return this;});TP.core.UIElementNode.Type.defineMethod('handlePeerTP_sig_DOMNodesAdded',function(e,b){var c,d,a;if(!TP.isElement(e)){return this.raise('TP.sig.InvalidElement',arguments);}c=TP.core.TagProcessor.constructWithPhaseTypes(TP.core.TagProcessor.ATTACH_PHASES);d=b.getSize();for(a=0;a<d;a++){c.processTree(b.at(a));}return this;});TP.core.UIElementNode.Type.defineMethod('handlePeerTP_sig_DOMNodesRemoved',function(e,b){var c,d,a;if(!TP.isElement(e)){return this.raise('TP.sig.InvalidElement',arguments);}c=TP.core.TagProcessor.constructWithPhaseTypes(TP.core.TagProcessor.DETACH_PHASES);d=b.getSize();for(a=0;a<d;a++){c.processTree(b.at(a));}return this;});TP.core.UIElementNode.Type.defineMethod('loadKeyBindings',function(){var a,b;if(TP.notValid(a=this.getResourceURI(TP.ietf.Mime.XML,'_keybindings'))){this.set('keyBindingsXML',TP.NOT_FOUND);return this;}if(TP.notValid(b=a.getNativeNode(TP.hc('async',false)))){return this.raise('TP.sig.InvalidKeymap',arguments);}this.set('keyBindingsURI',a);this.set('keyBindingsXML',b);return this;});TP.core.UIElementNode.Type.defineMethod('tagCompile',function(b){var a,c,d,e;if(!TP.isElement(a=b.at('node'))){return;}if(TP.notEmpty(c=a.namespaceURI)&&TP.w3.Xmlns.isNative(c)&&!TP.elementHasAttribute(a,'tibet:sourcetag',true)){return;}if(TP.isValid(d=b.at('doc'))){if(!TP.isHTMLDocument(d)){return;}}e=TP.elementBecome(a,this.isBlockLevel()?'div':'span',this.getCompilationAttrs(b));return e;});TP.core.UIElementNode.Type.defineMethod('cmdRunContent',function(a){var c,d,e,b;c=TP.ifKeyInvalid(a,'cmdInteractive',false);if(c){e=a.at('cmdShell');d=e.updateCommandNode(a);b=TP.wrap(d).asString();a.stdout(b,TP.hc('cmdBox',false,'cmdAsIs',true,'echoRequest',true));a.set('result',b);a.complete();return TP.CONTINUE;}return this.tshExecute(a);});TP.core.UIElementNode.Inst.defineMethod('act',function(a){return this;});TP.core.UIElementNode.Inst.defineMethod('acceptFocusedResponder',function(){if(TP.isKindOf(this.getType().get('$focusingTPElement'),TP.core.UIElementNode)){return false;}return true;});TP.core.UIElementNode.Inst.defineMethod('becomeFocusedResponder',function(){$focus_stack.push(this);this.signal('TP.sig.UIDidPushFocus');return this;});TP.core.UIElementNode.Inst.defineMethod('canFocus',function(){return this.hasAttribute('tabindex');});TP.core.UIElementNode.Inst.defineMethod('canHandleKey',function(d){var a,c,b;a=TP.domkeysigname(d);switch(a){case'DOM_Enter_Down':case'DOM_Enter_Up':return true;default:if(TP.isType(c=this.getType())){b=c.getKeyBindingsXML();if(TP.isXMLDocument(b)){return TP.isElement(TP.nodeEvaluateXPath(b,'descendant-or-self::*[@id = "'+a+'"]',TP.FIRST_NODE));}}}return false;});TP.core.UIElementNode.Inst.defineMethod('computeSuccessorFocusElement',function(f,o){var l,k,d,g,e,h,n,m,c,a,j,i,b;l=false;k=this.getNativeWindow();if(TP.isValid(f)){d=f.getDocument().getBody();if(TP.notEmpty(g=f.getGroupName())){e=TP.byOID(g,k);l=true;}else{e=d;}}else{d=this.getDocument().getBody();e=d;}h=o;n=e.hasAttribute('wrapWhen')&&e.getAttribute('wrapWhen')!=='false';if(!n){if(h===TP.NEXT){h=TP.FOLLOWING;}else if(h===TP.PREVIOUS){h=TP.PRECEDING;}}m=false;switch(h){case TP.FIRST:case TP.LAST:case TP.NEXT:case TP.PREVIOUS:case TP.FIRST_IN_GROUP:case TP.LAST_IN_GROUP:break;case TP.FIRST_IN_NEXT_GROUP:if(!l){if(TP.notEmpty(a=d.get('tibet:group'.asType().getQueryPath()))){c=TP.wrap(a.first());}else{c=d;}}else{j=this.getNextGroupName(g,true);c=TP.byOID(j,k);}break;case TP.FIRST_IN_PREVIOUS_GROUP:if(!l){if(TP.notEmpty(a=d.get('tibet:group'.asType().getQueryPath()))){c=TP.wrap(a.last());}else{c=d;}}else{i=this.getPreviousGroupName(g,true);c=TP.byOID(i,k);}break;case TP.FOLLOWING:if(!l){if(TP.notEmpty(a=d.get('tibet:group'.asType().getQueryPath()))){c=TP.wrap(a.first());}else{c=d;}}else{j=this.getNextGroupName(g,true);if(TP.notValid(j)||j===g){j=this.getParentGroupName(g);m=true;}c=TP.byOID(j,k);}break;case TP.PRECEDING:if(!l){if(TP.notEmpty(a=d.get('tibet:group'.asType().getQueryPath()))){c=TP.wrap(a.last());}else{c=d;}}else{i=this.getPreviousGroupName(g,true);if(TP.notValid(i)||i===g){i=this.getParentGroupName(g);m=true;}c=TP.byOID(i,k);}break;}b=null;switch(h){case TP.FIRST:if(TP.isEmpty(a=d.findFocusableElements())){return null;}b=a.first();break;case TP.LAST:if(TP.isEmpty(a=d.findFocusableElements())){return null;}b=a.last();break;case TP.NEXT:if(TP.isEmpty(a=e.findFocusableElements())){return null;}if(TP.notValid(f)||TP.notValid(b=a.after(f.getNativeNode(),TP.EQUALITY,true))){b=a.first();}break;case TP.PREVIOUS:if(TP.isEmpty(a=e.findFocusableElements())){return null;}if(TP.notValid(f)||TP.notValid(b=a.before(f.getNativeNode(),TP.EQUALITY,true))){b=a.last();}break;case TP.FIRST_IN_GROUP:if(TP.isEmpty(a=e.findFocusableElements())){return null;}b=a.first();break;case TP.LAST_IN_GROUP:if(TP.isEmpty(a=e.findFocusableElements())){return null;}b=a.last();break;case TP.FIRST_IN_NEXT_GROUP:case TP.FIRST_IN_PREVIOUS_GROUP:if(!TP.isValid(c)||TP.isEmpty(a=c.findFocusableElements())){return null;}b=a.first();break;case TP.FOLLOWING:if(TP.isEmpty(a=e.findFocusableElements(true))){return null;}if(TP.notValid(f)||TP.notValid(b=a.after(f.getNativeNode(),TP.EQUALITY,true))){if(!TP.isValid(c)||TP.isEmpty(a=c.findFocusableElements(true))){return null;}if(m){if(TP.notValid(b=a.after(e.getNativeNode(),TP.EQUALITY,true))){b=a.first();}}else{b=a.first();}}break;case TP.PRECEDING:if(TP.isEmpty(a=e.findFocusableElements(true))){return null;}if(TP.notValid(f)||TP.notValid(b=a.before(f.getNativeNode(),TP.EQUALITY,true))){if(!TP.isValid(c)||TP.isEmpty(a=c.findFocusableElements(true))){return null;}if(m){if(TP.notValid(b=a.before(e.getNativeNode(),TP.EQUALITY,true))){b=a.last();}}else{b=a.last();}}break;}if(TP.isValid(b)){return b;}return null;});TP.core.UIElementNode.Inst.defineMethod('findFocusableElements',function(c){var b,a;b='> *[tabindex], *:not(tibet|group) *[tabindex]';if(c){b+=',tibet|group';}a=TP.byCSS(b,this.getNativeNode());a=a.select(function(a){return TP.elementIsDisplayed(a);});a.sort(TP.TABINDEX_ORDER_SORT);return TP.wrap(a);});TP.core.UIElementNode.Inst.defineMethod('getComputedStyleProperty',function(a){return TP.elementGetComputedStyleProperty(this.getNativeNode(),a);});TP.core.UIElementNode.Inst.defineMethod('getDisplayValue',function(a){return TP.override();});TP.core.UIElementNode.Inst.defineMethod('getFocusContextElement',function(){var a;if(TP.isValid(a=this.getFirstElementAncestorByAttribute('tibet:focuscontext'))){return a;}else{return this.getDocument().getBody();}});TP.core.UIElementNode.Inst.defineMethod('getFocusedElement',function(c){var a,b;if(!TP.isDocument(a=this.getNativeDocument())){return TP.raise(this,'TP.sig.InvalidDocument',arguments);}if(!TP.isElement(b=TP.documentGetFocusedElement(a))){return null;}if(TP.notTrue(c)&&b===TP.documentGetBody(a)){return null;}return TP.wrap(b);});TP.core.UIElementNode.Inst.defineMethod('getHeight',function(){return TP.elementGetHeight(this.getNativeNode());});TP.core.UIElementNode.Inst.defineMethod('getGlobalPoint',function(b){var a;a=TP.elementGetGlobalXY(this.getNativeNode(),TP.BORDER_BOX,b);return TP.pc(a);});TP.core.UIElementNode.Inst.defineMethod('getGlobalRect',function(b){var a;a=TP.elementGetGlobalBox(this.getNativeNode(),TP.BORDER_BOX,b);return TP.rtc(a);});TP.core.UIElementNode.Inst.defineMethod('getGroupChainNames',function(){var b,c,d,a,e,f;b=this.getGroupName();if(TP.isEmpty(b)){return null;}c=TP.ac();d=this.getNativeWindow();a=b;while(TP.isElement(e=TP.byId(a,d))){c.push(a);f=TP.wrap(e);if(TP.notValid(a=f.getGroupName())){break;}}return c;});TP.core.UIElementNode.Inst.defineMethod('getGroupName',function(){if(!this.hasAttribute('tibet:group')){return null;}return this.getAttribute('tibet:group');});TP.core.UIElementNode.Inst.defineMethod('getNextGroupName',function(l,m){var k,e,f,h,c,g,i,j,a,b,d;if(TP.isEmpty(k=this.getGroupName())){return null;}e=TP.ifEmpty(l,k);f=TP.ifInvalid(m,false);h=this.getGroupChainNames();c=this.getNativeWindow();g=TP.byOID(e,c);if(TP.isEmpty(i=h.after(e))){if(TP.notEmpty(j=this.getDocument().getBody().get('tibet:group'.asType().getQueryPath()))){a=TP.wrap(j);if(TP.notValid(b=a.after(g,TP.EQUALITY,true))){if(f){b=a.first();}else{return null;}}}else{return null;}}else{d=TP.byOID(i,c);a=d.getMemberGroups();if(TP.notValid(b=a.after(g,TP.EQUALITY,true))){if(d.hasAttribute('wrapWhen')||f){b=a.first();}else{return null;}}}return b.getAttribute('id');});TP.core.UIElementNode.Inst.defineMethod('getNextResponder',function(g,h){var a,b,d,e,f,c;a=this.getNativeNode();b=a.parentNode;if(TP.isElement(b)&&TP.isElement(d=TP.nodeGetControlElement(b))){return TP.wrap(d);}if(TP.isValid(e=TP.elementGetURIController(a))){return e;}if(TP.isIFrameWindow(f=TP.nodeGetWindow(this.getNativeDocument()))){c=f.frameElement;if(TP.isElement(c)){return TP.wrap(c).getNextResponder(g,h);}}return TP.sys.getApplication();});TP.core.UIElementNode.Inst.defineMethod('getOffsetParent',function(){return TP.wrap(TP.elementGetOffsetParent(this.getNativeNode()));});TP.core.UIElementNode.Inst.defineMethod('getOffsetPoint',function(b){var a;a=TP.elementGetOffsetXY(this.getNativeNode(),TP.BORDER_BOX,b);return TP.pc(a);});TP.core.UIElementNode.Inst.defineMethod('getOffsetRect',function(b){var a;a=TP.elementGetOffsetBox(this.getNativeNode(),TP.BORDER_BOX,b);return TP.rtc(a);});TP.core.UIElementNode.Inst.defineMethod('getPagePoint',function(b){var a;a=TP.elementGetPageXY(this.getNativeNode(),TP.BORDER_BOX,null,b);return TP.pc(a);});TP.core.UIElementNode.Inst.defineMethod('getPageRect',function(b){var a;a=TP.elementGetPageBox(this.getNativeNode(),TP.BORDER_BOX,null,b);return TP.rtc(a);});TP.core.UIElementNode.Inst.defineMethod('getParentGroupName',function(e){var a,b,c,d;if(TP.isEmpty(a=this.getGroupName())){return null;}b=TP.ifEmpty(e,a);c=this.getGroupChainNames();if(TP.isEmpty(d=c.after(b))){return null;}return d;});TP.core.UIElementNode.Inst.defineMethod('getPreviousGroupName',function(l,m){var k,e,f,h,c,g,i,j,a,b,d;if(TP.isEmpty(k=this.getGroupName())){return null;}e=TP.ifEmpty(l,k);f=TP.ifInvalid(m,false);h=this.getGroupChainNames();c=this.getNativeWindow();g=TP.byOID(e,c);if(TP.isEmpty(i=h.after(e))){if(TP.notEmpty(j=this.getDocument().getBody().get('tibet:group'.asType().getQueryPath()))){a=TP.wrap(j);if(TP.notValid(b=a.before(g,TP.EQUALITY,true))){if(f){b=a.last();}else{return null;}}}else{return null;}}else{d=TP.byOID(i,c);a=d.getMemberGroups();if(TP.notValid(b=a.before(g,TP.EQUALITY,true))){if(d.hasAttribute('wrapWhen')||f){b=a.first();}else{return null;}}}return b.getAttribute('id');});TP.core.UIElementNode.Inst.defineMethod('getSubmitName',function(){var a;a=this.getNativeNode();return TP.elementGetAttribute(a,'id')||TP.elementGetAttribute(a,'name');});TP.core.UIElementNode.Inst.defineMethod('getWidth',function(){return TP.elementGetWidth(this.getNativeNode());});TP.core.UIElementNode.Inst.defineMethod('getWidthAndHeight',function(){return TP.ac(TP.elementGetWidth(this.getNativeNode()),TP.elementGetHeight(this.getNativeNode()));});TP.core.UIElementNode.Inst.defineMethod('hide',function(){TP.elementHide(this.getNativeNode());return this;});TP.core.UIElementNode.Inst.defineMethod('isVisible',function(){return TP.elementIsVisible(this.getNativeNode());});TP.core.UIElementNode.Inst.defineMethod('isResponderFor',function(a,d){var c,b;if(TP.isTrue(d)&&!this.shouldCaptureSignal(a)){return false;}c=this.getGlobalID();b=a.getType();return TP.canInvoke(this,b.getHandlerName(c,false,a))||TP.canInvoke(this,b.getHandlerName(c,true,a))||TP.canInvoke(this,b.getHandlerName(null,false,a))||TP.canInvoke(this,b.getHandlerName(null,true,a));});TP.core.UIElementNode.Inst.defineMethod('moveFocus',function(c){var b,a;b=this.getFocusedElement(false);if(TP.isKindOf(b,TP.core.UIElementNode)){a=this.computeSuccessorFocusElement(b,c);}else{a=this.computeSuccessorFocusElement(null,c);}if(TP.isKindOf(a,TP.core.UIElementNode)){this.getType().set('$focusingTPElement',a);a.focus();}return this;});TP.core.UIElementNode.Inst.defineMethod('removeAttribute',function(a){TP.elementRemoveAttribute(this.getNativeNode(),a,true);this.changed('@'+a,TP.DELETE);return;});TP.core.UIElementNode.Inst.defineMethod('resignFocusedResponder',function(){var b,a,d,e,c;b=this.getType().get('$focusingTPElement');this.getType().set('$focusingTPElement',null);if(TP.isEmpty($focus_stack)){return this;}d=this.getFocusContextElement();if(TP.isKindOf(b,TP.core.UIElementNode)){a=b.getFocusContextElement();}else{a=null;}if(TP.notValid(a)||a.equalTo(d.getNativeNode())){$focus_stack.pop();this.signal('TP.sig.UIDidPopFocus');return this;}e=$focus_stack.detect(function(b){return b.getFocusContextElement().equalTo(a);});if(TP.isValid(e)){$focus_stack.pop();this.signal('TP.sig.UIDidPopFocus');c=$focus_stack.pop();this.signal('TP.sig.UIDidPopFocus');this.getType().set('$focusingTPElement',c);(function(){this.getType().set('$focusingTPElement',null);c.focus();}.bind(this).afterUnwind());}return this;});TP.core.UIElementNode.Inst.defineMethod('setAttribute',function(a,c){var b,g,e,d,f,h;b=this.getNativeNode();g=TP.elementHasAttribute(b,a,true);if(TP.regex.NS_QUALIFIED.test(a)){e=a.match(TP.regex.NS_QUALIFIED);d=e.at(1);f=e.at(2);if(a.startsWith('xmlns')){if(a==='xmlns'){return;}TP.elementAddNamespace(b,d+':'+f,c);this.changed('@'+a,TP.UPDATE);return;}if(TP.notEmpty(h=TP.w3.Xmlns.getPrefixURI(d))){TP.elementSetAttributeInNS(b,d+':'+f,c,h);}else{TP.elementSetAttribute(b,a,c);}}else{TP.elementSetAttribute(b,a,c);}this.changed('attribute',g?TP.UPDATE:TP.CREATE,TP.hc(TP.OLDVAL,TP.elementGetAttribute(b,a,true),TP.NEWVAL,c));return;});TP.core.UIElementNode.Inst.defineMethod('setDisplayValue',function(a){return TP.override();});TP.core.UIElementNode.Inst.defineMethod('setGroupElement',function(a){if(TP.notValid(a)){return this.raise('TP.sig.InvalidElement',arguments,a);}this.setAttribute('tibet:group',a.getLocalID());return this;});TP.core.UIElementNode.Inst.defineMethod('setHeight',function(a){return TP.elementSetHeight(this.getNativeNode(),a);});TP.core.UIElementNode.Inst.defineMethod('setPagePosition',function(a){var b;b=TP.elementGetStyleObj(this.getNativeNode());if(TP.isKindOf(a,TP.core.Point)){b.left=a.getX()+'px';b.top=a.getY()+'px';}else if(TP.isKindOf(a,TP.lang.Hash)){b.left=a.at('x')+'px';b.top=a.at('y')+'px';}else if(TP.isArray(a)){b.left=a.at(0)+'px';b.top=a.at(1)+'px';}else{b.left=a.x+'px';b.top=a.y+'px';}return this;});TP.core.UIElementNode.Inst.defineMethod('setPagePositionAndSize',function(a){var b;b=TP.elementGetStyleObj(this.getNativeNode());if(TP.isKindOf(a,TP.core.Rect)){b.left=a.getX()+'px';b.top=a.getY()+'px';b.width=a.getWidth()+'px';b.height=a.getHeight()+'px';}else if(TP.isKindOf(a,TP.lang.Hash)){b.left=a.at('x')+'px';b.top=a.at('y')+'px';b.width=a.at('width')+'px';b.height=a.at('height')+'px';}else if(TP.isArray(a)){b.left=a.at(0)+'px';b.top=a.at(1)+'px';b.width=a.at(2)+'px';b.height=a.at(3)+'px';}else{b.left=a.x+'px';b.top=a.y+'px';b.width=a.width+'px';b.height=a.height+'px';}return this;});TP.core.UIElementNode.Inst.defineMethod('setTransform',function(a){TP.elementSetTransform(this.getNativeNode(),a);return this;});TP.core.UIElementNode.Inst.defineMethod('setWidth',function(a){return TP.elementSetWidth(this.getNativeNode(),a);});TP.core.UIElementNode.Inst.defineMethod('show',function(){TP.elementShow(this.getNativeNode());return this;});TP.core.UIElementNode.Inst.defineMethod('yieldFocusedResponder',function(a){return true;});TP.core.UIElementNode.Inst.defineMethod('toggleDisplay',function(){var a;a=this.getNativeNode();if(TP.elementIsDisplayed(a)){TP.elementHide(a);}else{TP.elementShow(a);}return this;});TP.core.UIElementNode.Inst.defineMethod('toggleVisibility',function(){var a;a=this.getNativeNode();if(TP.elementGetComputedStyleObj(a).visibility==='visible'){a.style.visibility='hidden';}else{a.style.visibility='visible';}return this;});TP.core.UIElementNode.Inst.defineMethod('addLocalTransform',function(b,c){var a;if(TP.isEmpty(a=this.getAttribute('localTransforms'))){a=TP.ac();}else{a=TP.json2js(a);}a.push(TP.hc('type',b,'args',TP.ac(arguments).slice(1)));this.setAttribute('localTransforms',TP.js2json(a));this.setTransformFromLocalTransforms();return this;});TP.core.UIElementNode.Inst.defineMethod('generateCSSValueFromTransformRecord',function(c){var b,a;if(TP.notValid(c)){return this.raise('TP.sig.InvalidParameter',arguments,'Must supply a valid transform record.');}b='';a=c.at('args');switch(c.at('type')){case TP.ROTATE:b+='rotate('+a+'deg)';break;case TP.SKEW:b+='skewX('+a.first()+'deg) '+'skewY('+a.last()+'deg)';break;case TP.SCALE:b+='scaleX('+a.first()+') '+'scaleY('+a.last()+')';break;case TP.TRANSLATE:b+='translateX('+a.first()+'px) '+'translateY('+a.last()+'px)';break;}return b;});TP.core.UIElementNode.Inst.defineMethod('getLocalTransformValue',function(e,f){var a,c,b,d;if(TP.isEmpty(a=this.getAttribute('localTransforms'))){return'';}else{a=TP.json2js(a);}c=TP.ifInvalid(f,0);b=null;if(e===TP.ANY){return this.generateCSSValueFromTransformRecord(a.at(c));}else{d=0;b=a.select(function(a){if(a.at('type')===e){if(d===c){return a;}d++;}});}if(TP.notEmpty(b)){return this.generateCSSValueFromTransformRecord(b.first());}return'';});TP.core.UIElementNode.Inst.defineMethod('removeAllLocalTransforms',function(){return this.removeLocalTransform(TP.ANY,TP.ALL);});TP.core.UIElementNode.Inst.defineMethod('removeLocalTransform',function(e,h){var d,c,a,f,b,g;if(TP.isEmpty(d=this.getAttribute('localTransforms'))){return this;}else{d=TP.json2js(d);}c=TP.ifInvalid(h,0);if(e===TP.ANY&&c===TP.ALL){a=TP.ac();}else{a=d;if(e===TP.ANY){a.splice(c,1);}else{f=0;g=a.getSize();for(b=0;b<g;b++){if(a.at(b).at('type')===e){if(c===TP.ALL){a.splice(b,1);g--;b--;}else if(c===f){a.splice(b,1);break;}f++;}}}}this.setAttribute('localTransforms',TP.js2json(a));this.setTransformFromLocalTransforms();return this;});TP.core.UIElementNode.Inst.defineMethod('rotate',function(a){this.addLocalTransform(TP.ROTATE,a);return this;});TP.core.UIElementNode.Inst.defineMethod('scale',function(a,c){var b;b=TP.ifInvalid(c,a);this.addLocalTransform(TP.SCALE,a,b);return this;});TP.core.UIElementNode.Inst.defineMethod('setLocalTransform',function(e,f,g){var a,c,b,d;if(TP.isEmpty(a=this.getAttribute('localTransforms'))){return this;}else{a=TP.json2js(a);}c=TP.ifInvalid(f,0);if(e===TP.ANY){b=TP.ac(a.at(c));}else{d=0;b=a.select(function(a){if(a.at('type')===e){if(d===c){return true;}d++;}});}if(TP.isEmpty(b)){return this;}b.first().atPut('args',TP.ac(arguments).slice(2));this.setAttribute('localTransforms',TP.js2json(a));this.setTransformFromLocalTransforms();return this;});TP.core.UIElementNode.Inst.defineMethod('setTransformFromLocalTransforms',function(){var a,b;if(!this.hasAttribute('localTransforms')){this.setTransform('');return this;}if(TP.isEmpty(a=this.getAttribute('localTransforms'))){return this;}else{a=TP.json2js(a);}b='';a.perform(function(a){b+=this.generateCSSValueFromTransformRecord(a)+' ';}.bind(this));this.setTransform(b);return this;});TP.core.UIElementNode.Inst.defineMethod('skew',function(a,c){var b;b=TP.ifInvalid(c,a);this.addLocalTransform(TP.SKEW,a,b);return this;});TP.core.UIElementNode.Inst.defineMethod('translate',function(a,c){var b;b=TP.ifInvalid(c,a);this.addLocalTransform(TP.TRANSLATE,a,b);return this;});TP.core.UIElementNode.Inst.defineMethod('$isInState',function(a,b){if(TP.isBoolean(b)){if(b){this.setAttribute(a,'true');}else{this.removeAttribute(a);}this.changed(a.slice(7),TP.UPDATE);}return this.hasAttribute(a);});TP.core.UIElementNode.Inst.defineMethod('getActive',function(){return this.$isInState('pclass:active');});TP.core.UIElementNode.Inst.defineMethod('getBusy',function(){return this.$isInState('pclass:busy');});TP.core.UIElementNode.Inst.defineMethod('getDisabled',function(){return this.hasAttribute('pclass:disabled');});TP.core.UIElementNode.Inst.defineMethod('getFocused',function(){return this.$isInState('pclass:focus');});TP.core.UIElementNode.Inst.defineMethod('getHidden',function(){return this.$isInState('pclass:hidden');});TP.core.UIElementNode.Inst.defineMethod('getInvalid',function(){return this.$isInState('pclass:invalid');});TP.core.UIElementNode.Inst.defineMethod('getOpen',function(){return this.$isInState('pclass:open');});TP.core.UIElementNode.Inst.defineMethod('getOutOfRange',function(){return this.$isInState('pclass:out-of-range');});TP.core.UIElementNode.Inst.defineMethod('getReadonly',function(){return this.$isInState('pclass:readonly');});TP.core.UIElementNode.Inst.defineMethod('getRequired',function(){return this.$isInState('pclass:required');});TP.core.UIElementNode.Inst.defineMethod('getSelected',function(){return this.$isInState('pclass:selected');});TP.core.UIElementNode.Inst.defineMethod('setActive',function(a){this.$isInState('pclass:active',a);if(TP.isTrue(a)){this.signalAfterUnwind('TP.sig.UIDidActivate');}else{this.signalAfterUnwind('TP.sig.UIDidDeactivate');}return this.$isInState('pclass:active');});TP.core.UIElementNode.Inst.defineMethod('setBusy',function(a,b){this.$isInState('pclass:busy',a);if(TP.isTrue(a)){this.displayBusy(b);this.signalAfterUnwind('TP.sig.UIDidBusy');}else{this.hideBusy();this.signalAfterUnwind('TP.sig.UIDidIdle');}return this.$isInState('pclass:busy');});TP.core.UIElementNode.Inst.defineMethod('setClosed',function(a){this.$isInState('pclass:closed',a);if(TP.isTrue(a)){this.signalAfterUnwind('TP.sig.UIDidClose');}else{this.signalAfterUnwind('TP.sig.UIDidOpen');}return this.$isInState('pclass:closed');});TP.core.UIElementNode.Inst.defineMethod('setCollapsed',function(a){this.$isInState('pclass:collapsed',a);if(TP.isTrue(a)){this.signalAfterUnwind('TP.sig.UIDidCollapse');}else{this.signalAfterUnwind('TP.sig.UIDidExpand');}return this.$isInState('pclass:collapsed');});TP.core.UIElementNode.Inst.defineMethod('setDisabled',function(b){var a;if(TP.isTrue(b)){this.setAttribute('disabled',true);this.setAttribute('pclass:disabled','true');this.setAttribute('xctrls:navindex','-1');}else{this.removeAttribute('disabled');this.removeAttribute('pclass:disabled');if(TP.notValid(a=this.get('navIndex'))){this.setAttribute('xctrls:navindex',a);}else{this.removeAttribute('xctrls:navindex');}}this.setAttribute('tabIndex',this.getAttribute('xctrls:navindex'));return this.hasAttribute('pclass:disabled');});TP.core.UIElementNode.Inst.defineMethod('setFocused',function(a){return this.$isInState('pclass:focus',a);});TP.core.UIElementNode.Inst.defineMethod('setHidden',function(a){this.$isInState('pclass:hidden',a);if(TP.isTrue(a)){this.signalAfterUnwind('TP.sig.UIDidHide');}else{this.signalAfterUnwind('TP.sig.UIDidShow');}return this.$isInState('pclass:hidden');});TP.core.UIElementNode.Inst.defineMethod('setInvalid',function(a){return this.$isInState('pclass:invalid',a);});TP.core.UIElementNode.Inst.defineMethod('setOutOfRange',function(a){return this.$isInState('pclass:out-of-range',a);});TP.core.UIElementNode.Inst.defineMethod('setReadonly',function(a){return this.$isInState('pclass:readonly',a);});TP.core.UIElementNode.Inst.defineMethod('setRequired',function(a){return this.$isInState('pclass:required',a);});TP.core.UIElementNode.Inst.defineMethod('setSelected',function(a){return this.$isInState('pclass:selected',a);});TP.core.UIElementNode.Inst.defineMethod('toggle',function(a){if(TP.isTrue(this.get(a))){this.set(a,false);}else{this.set(a,true);}return this.get(a);});TP.core.UIElementNode.Inst.defineMethod('blur',function(){var a;a=this.getNativeNode();if(TP.canInvoke(a,'blur')){a.blur();}return this;});TP.core.UIElementNode.Inst.defineMethod('focus',function(){var a;a=this.getNativeNode();if(TP.canInvoke(a,'focus')){a.focus();}return this;});TP.core.UIElementNode.Inst.defineMethod('select',function(){var a;a=this.getNativeNode();this.set('selected',true);this.set('focused',true);if(TP.canInvoke(a,'select')){a.select();}return this;});TP.core.UIElementNode.Inst.defineMethod('toggleSelectedItem',function(a,b){if(!TP.isElement(a)||!TP.isElement(b)){return this.raise('TP.sig.InvalidElement',arguments);}TP.wrap(a).set('selected',false);TP.wrap(b).set('selected',true);return this;});TP.core.UIElementNode.Inst.defineMethod('displayAlert',function(a){TP.ifInfo()?TP.info('alert: '+a,TP.LOG,arguments):0;return this;});TP.core.UIElementNode.Inst.defineMethod('displayBusy',function(a){TP.elementShowBusyMessage(this.getNativeNode(),a);return this;});TP.core.UIElementNode.Inst.defineMethod('displayHelp',function(a){TP.ifInfo()?TP.info('help: '+a,TP.LOG,arguments):0;return this;});TP.core.UIElementNode.Inst.defineMethod('displayHint',function(a){TP.ifInfo()?TP.info('hint: '+a,TP.LOG,arguments):0;return this;});TP.core.UIElementNode.Inst.defineMethod('hideAlert',function(){return this;});TP.core.UIElementNode.Inst.defineMethod('hideBusy',function(){TP.elementHideBusyMessage(this.getNativeNode());return this;});TP.core.UIElementNode.Inst.defineMethod('hideHelp',function(){return this;});TP.core.UIElementNode.Inst.defineMethod('hideHint',function(){return this;});TP.core.UIElementNode.Inst.defineMethod('handleUIFocusFirst',function(a){this.moveFocus(TP.FIRST);return;});TP.core.UIElementNode.Inst.defineMethod('handleUIFocusLast',function(a){this.moveFocus(TP.LAST);return;});TP.core.UIElementNode.Inst.defineMethod('handleUIFocusNext',function(a){this.moveFocus(TP.NEXT);return;});TP.core.UIElementNode.Inst.defineMethod('handleUIFocusPrevious',function(a){this.moveFocus(TP.PREVIOUS);return;});TP.core.UIElementNode.Inst.defineMethod('handleUIFocusFollowing',function(a){this.moveFocus(TP.FOLLOWING);return;});TP.core.UIElementNode.Inst.defineMethod('handleUIFocusPreceding',function(a){this.moveFocus(TP.PRECEDING);return;});TP.core.UIElementNode.Inst.defineMethod('handleUIFocusFirstInGroup',function(a){this.moveFocus(TP.FIRST_IN_GROUP);return;});TP.core.UIElementNode.Inst.defineMethod('handleUIFocusLastInGroup',function(a){this.moveFocus(TP.LAST_IN_GROUP);return;});TP.core.UIElementNode.Inst.defineMethod('handleUIFocusFirstInPreviousGroup',function(a){this.moveFocus(TP.FIRST_IN_PREVIOUS_GROUP);return;});TP.core.UIElementNode.Inst.defineMethod('handleUIFocusFirstInNextGroup',function(a){this.moveFocus(TP.FIRST_IN_NEXT_GROUP);return;});TP.core.UIElementNode.Inst.defineMethod('handleUIActivate',function(a){if(this.shouldPerformUIHandler(a)){this.setActive(true);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIAlert',function(a){if(this.shouldPerformUIHandler(a)){this.displayAlert(a.getPayload().at('msg'));this.signalAfterUnwind('TP.sig.UIDidAlert');}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIBlur',function(a){var b;b=this.getType().get('$focusingTPElement');if(!this.shouldPerformUIHandler(a)||!this.yieldFocusedResponder(b)){a.preventDefault();return;}this.resignFocusedResponder();this.set('focused',false);this.set('selected',false);this.signalAfterUnwind('TP.sig.UIDidBlur');return;});TP.core.UIElementNode.Inst.defineMethod('handleUIBusy',function(a){if(this.shouldPerformUIHandler(a)){this.setBusy(true,a.getPayload().at('msg'));}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIClose',function(a){if(this.shouldPerformUIHandler(a)){this.setClosed(true);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUICollapse',function(a){if(this.shouldPerformUIHandler(a)){this.setCollapsed(true);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIDeactivate',function(a){if(this.shouldPerformUIHandler(a)){this.setActive(false);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIDelete',function(a){return TP.todo();});TP.core.UIElementNode.Inst.defineMethod('handleUIDeselect',function(b){var a;if(this.shouldPerformUIHandler(b)){a=this.getNativeNode();if(TP.canInvoke(this,'setSelected')){this.setSelected(false);}else if(TP.canInvoke(a,'blur')){this.getNativeNode().blur();}this.removeAttribute('selected');this.signalAfterUnwind('TP.sig.UIDidDeselect');}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIDidBlur',function(a){if(this.shouldPerformUIHandler(a)){}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIDidFocus',function(a){if(this.shouldPerformUIHandler(a)){}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIDidPopFocus',function(a){if(this.shouldPerformUIHandler(a)){}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIDidPushFocus',function(a){if(this.shouldPerformUIHandler(a)){}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIDisabled',function(a){if(this.shouldPerformUIHandler(a)){this.setDisabled(true);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIDuplicate',function(a){return TP.todo();});TP.core.UIElementNode.Inst.defineMethod('handleUIEnabled',function(a){if(this.shouldPerformUIHandler(a)){this.setDisabled(false);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIExpand',function(a){if(this.shouldPerformUIHandler(a)){this.setCollapsed(false);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIFocus',function(a){if(!this.shouldPerformUIHandler(a)||!this.acceptFocusedResponder()){a.preventDefault();return;}this.becomeFocusedResponder();this.set('focused',true);this.signalAfterUnwind('TP.sig.UIDidFocus');return;});TP.core.UIElementNode.Inst.defineMethod('handleUIFocusAndSelect',function(a){if(this.shouldPerformUIHandler(a)){if(!this.acceptFocusedResponder()){a.preventDefault();}else{this.select();}}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIHelp',function(a){if(this.shouldPerformUIHandler(a)){this.displayHelp(a.getPayload().at('msg'));this.signalAfterUnwind('TP.sig.UIDidHelp');}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIHide',function(a){if(this.shouldPerformUIHandler(a)){this.setHidden(true);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIHint',function(a){if(this.shouldPerformUIHandler(a)){this.displayHint(a.getPayload().at('msg'));this.signalAfterUnwind('TP.sig.UIDidHint');}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIIdle',function(a){if(this.shouldPerformUIHandler(a)){this.setBusy(false);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIInRange',function(a){if(this.shouldPerformUIHandler(a)){this.setOutOfRange(false);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIInsert',function(a){return TP.todo();});TP.core.UIElementNode.Inst.defineMethod('handleUIInvalid',function(a){if(this.shouldPerformUIHandler(a)){this.setInvalid(true);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIOpen',function(a){if(this.shouldPerformUIHandler(a)){this.setClosed(false);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIOptional',function(a){if(this.shouldPerformUIHandler(a)){this.setRequired(false);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIOutOfRange',function(a){if(this.shouldPerformUIHandler(a)){this.setOutOfRange(true);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIReadonly',function(a){if(this.shouldPerformUIHandler(a)){this.setReadonly(true);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIReadwrite',function(a){if(this.shouldPerformUIHandler(a)){this.setReadonly(false);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIRequired',function(a){if(this.shouldPerformUIHandler(a)){this.setRequired(true);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIScroll',function(a){return TP.todo();});TP.core.UIElementNode.Inst.defineMethod('handleUISelect',function(b){var a;if(this.shouldPerformUIHandler(b)){a=this.getNativeNode();if(TP.canInvoke(this,'setSelected')){this.setSelected(true);}else if(TP.canInvoke(a,'focus')){a.focus();}this.setAttribute('selected','true');this.signalAfterUnwind('TP.sig.UIDidSelect');}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIShow',function(a){if(this.shouldPerformUIHandler(a)){this.setHidden(false);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIValid',function(a){if(this.shouldPerformUIHandler(a)){this.setInvalid(false);}return;});TP.core.UIElementNode.Inst.defineMethod('handleUIValueChanged',function(a){return TP.todo();});TP.core.UIElementNode.Inst.defineMethod('configureSignalFromAttributes',function(a){if(this.shouldStopSignal(a)){a.stopPropagation();}if(this.shouldPreventSignal(a)){a.preventDefault();}return this;});TP.core.UIElementNode.Inst.defineMethod('shouldCaptureSignal',function(b){var a;a=this.getNativeNode();if(TP.elementHasAttributeValue(a,'ev:event',b.getSignalName())){if(TP.elementHasAttributeValue(a,'ev:phase','capture')){return true;}}return false;});TP.core.UIElementNode.Inst.defineMethod('shouldPerformUIHandler',function(a){this.configureSignalFromAttributes(a);return!a.shouldPrevent();});TP.core.UIElementNode.Inst.defineMethod('shouldPreventSignal',function(b){var a;a=this.getNativeNode();if(TP.elementHasAttributeValue(a,'ev:event',b.getSignalName())){if(TP.elementHasAttributeValue(a,'ev:defaultAction','cancel')){return true;}}return false;});TP.core.UIElementNode.Inst.defineMethod('shouldStopSignal',function(b){var a;a=this.getNativeNode();if(TP.elementHasAttributeValue(a,'ev:event',b.getSignalName())){if(TP.elementHasAttributeValue(a,'ev:propagate','stop')){return true;}}return false;});TP.core.UIElementNode.Inst.defineMethod('signal',function(a,f,b,c,g,d,e){TP.debug('break.signal_dispatch');return this.dispatch(a,this.getNativeNode(),b,c,d,e);});TP.core.UIElementNode.Inst.defineMethod('signalAfterUnwind',function(a,f,b,c,g,d,e){TP.debug('break.signal_dispatch');(function(){return this.dispatch(a,this.getNativeNode(),b,c,d,e);}.bind(this).afterUnwind());});TP.lang.Object.defineSubtype('core.NonNativeUIElementNode');TP.core.NonNativeUIElementNode.Type.defineMethod('tagAttachStyle',function(b){var a;if(!TP.isDocument(a=b.at('doc'))){return;}this.addStylesheetTo(a);return;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.core.UIElementNode_keybindings.xml_uri', '~lib_dat/TP.core.UIElementNode_keybindings.xml');
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETDHTMLTypes.js';
TP.core.StateMachine.defineSubtype('DragMachine');TP.core.DragMachine.Inst.defineAttribute('eventStream',TP.ac('TP.sig.DOMDragDown','TP.sig.DOMDragHover','TP.sig.DOMDragMove','TP.sig.DOMDragUp'));TP.core.DragMachine.Inst.defineMethod('init',function(b){var a;this.callNextMethod();if(TP.notValid(b)){a=TP.core.Mouse;}else{a=TP.$(b);a=TP.elem(a);if(!TP.isElement(a)){return this.raise('TP.sig.InvalidParameter',arguments,'Could not resolve source to an element: '+b);}}this.set('eventSource',a);return this;});TP.core.DragMachine.Inst.defineMethod('acceptActive',function(a){return TP.isKindOf(a,'TP.sig.DOMDragUp');});TP.core.DragMachine.Inst.defineMethod('acceptDragging',function(a){return TP.isKindOf(a,'TP.sig.DOMDragDown');});TP.core.DragMachine.Inst.defineMethod('defineDefaultStates',function(){this.defineState('dragging',this,TP.ACTIVE);this.defineState(TP.ACTIVE,this,'dragging');return;});TP.core.StateResponder.defineSubtype('DragResponder');TP.core.DragResponder.Type.defineConstant('LOCK_X_TO_ELEMENT_X',function(d,f,e){var a,b,c;a=d.get('actionElement');b=TP.elementGetOffsetParent(a);c=TP.elementGetPageX(b)-TP.elementGetPageX(a);e.setX(c);return;});TP.core.DragResponder.Type.defineConstant('LOCK_Y_TO_ELEMENT_Y',function(d,f,e){var a,b,c;a=d.get('actionElement');b=TP.elementGetOffsetParent(a);c=TP.elementGetPageY(b)-TP.elementGetPageY(a);e.setY(c);return;});TP.core.DragResponder.Type.defineConstant('LOCK_X_TO_START_X',function(a,c,b){b.setX(a.get('startSignal').getPageX()-a.get('$offsetPoint').getX());return;});TP.core.DragResponder.Type.defineConstant('LOCK_Y_TO_START_Y',function(a,c,b){b.setY(a.get('startSignal').getPageY()-a.get('$offsetPoint').getY());return;});TP.core.DragResponder.Type.defineConstant('INCREMENT_X_BY',function(e,f,c){var a,b,d;d=TP.core.DragResponder.INCREMENT_X_BY;if(TP.isNumber(a=d.modifierData.at('increment'))){b=c.getX();b=((b+a)/a).floor()*a;c.setX(b);}return;});TP.core.DragResponder.Type.defineConstant('INCREMENT_Y_BY',function(e,f,c){var a,b,d;d=TP.core.DragResponder.INCREMENT_Y_BY;if(TP.isNumber(a=d.modifierData.at('increment'))){b=c.getY();b=((b+a)/a).floor()*a;c.setY(b);}return;});TP.core.DragResponder.Type.defineConstant('INCREMENT_X_AND_Y_BY',function(g,h,a){var b,c,d,e,f;f=TP.core.DragResponder.INCREMENT_X_AND_Y_BY;if(TP.isNumber(b=f.modifierData.at('incrementX'))){c=a.getX();c=((c+b)/b).floor()*b;a.setX(c);}if(TP.isNumber(d=f.modifierData.at('incrementY'))){e=a.getY();e=((e+d)/d).floor()*d;a.setY(e);}return;});TP.core.DragResponder.Type.defineConstant('CLAMP_X_TO_OFFSET_PARENT',function(e,f,c){var b,d,a;b=e.get('actionElement');d=TP.elementGetOffsetParent(b);a=c.getX();a=a.max(0);a=a.min(TP.elementGetWidth(d)-TP.elementGetWidth(b));c.setX(a);});TP.core.DragResponder.Type.defineConstant('CLAMP_Y_TO_OFFSET_PARENT',function(e,f,c){var b,d,a;b=e.get('actionElement');d=TP.elementGetOffsetParent(b);a=c.getY();a=a.max(0);a=a.min(TP.elementGetHeight(d)-TP.elementGetHeight(b));c.setY(a);});TP.core.DragResponder.Type.defineConstant('CLAMP_X_AND_Y_TO_CONTAINER',function(i,j,h){var b,d,e,f,g,c,a;a=TP.core.DragResponder.CLAMP_X_AND_Y_TO_CONTAINER;if(TP.notValid(b=a.tempData.at('maxFittedRect'))){d=i.get('actionElement');e=TP.ifInvalid(a.modifierData.at('container'),TP.elementGetOffsetParent(d));f=TP.wrap(d).getPageRect();g=TP.wrap(e).getPageRect();c=f.maxFittedPoint(g);b=TP.rtc(0,0,c.getX(),c.getY());a.tempData.atPut('maxFittedRect',b);}h.clampToRect(b);});TP.core.DragResponder.Type.defineConstant('CLAMP_X_TO_CSS_MINMAX',function(e,g,f){var d,a,b,c;d=e.get('actionElement');a=TP.elementGetStyleValuesInPixels(TP.ac('minWidth','maxWidth'));if(!TP.isNumber(b=a.at('minWidth'))){b=0;}if(!TP.isNumber(c=a.at('maxWidth'))){c=TP.elementGetContentWidth(d);}f.clampXToMinMax(b,c);return;});TP.core.DragResponder.Type.defineConstant('CLAMP_Y_TO_CSS_MINMAX',function(e,g,f){var a,b,c,d;a=e.get('actionElement');b=TP.elementGetStyleValuesInPixels(a,TP.ac('minHeight','maxHeight'));if(!TP.isNumber(c=b.at('minHeight'))){c=0;}if(!TP.isNumber(d=b.at('maxHeight'))){d=TP.elementGetContentHeight(a);}f.clampYToMinMax(c,d);return;});TP.core.DragResponder.Type.defineConstant('CLAMP_X_AND_Y_TO_RECT',function(d,e,c){var a,b;b=TP.core.DragResponder.CLAMP_X_AND_Y_TO_RECT;if(TP.notValid(a=b.tempData.at('clampData'))){return;}if(!TP.isKindOf(a,TP.core.Rect)){if(TP.isElement(a)){a=TP.wrap(a);}if(TP.isKindOf(a,TP.core.UIElementNode)){a=a.getPageRect();}else{a=TP.core.Rect.construct(a);}if(!TP.isKindOf(a,TP.core.Rect)){a=null;}b.tempData.atPut('clampData',a);}c.clampToRect(a);});TP.core.DragResponder.Inst.defineAttribute('startSignal');TP.core.DragResponder.Inst.defineAttribute('currentSignal');TP.core.DragResponder.Inst.defineAttribute('lastSignal');TP.core.DragResponder.Inst.defineAttribute('startPoint');TP.core.DragResponder.Inst.defineAttribute('currentPoint');TP.core.DragResponder.Inst.defineAttribute('targetElement');TP.core.DragResponder.Inst.defineAttribute('actionElement');TP.core.DragResponder.Inst.defineAttribute('$offsetPoint');TP.core.DragResponder.Inst.defineAttribute('actionWindow');TP.core.DragResponder.Inst.defineAttribute('$frameOffsetPoint');TP.core.DragResponder.Inst.defineAttribute('modifiers');TP.core.DragResponder.Inst.defineAttribute('dragCorner');TP.core.DragResponder.Inst.defineAttribute('insetTop',0);TP.core.DragResponder.Inst.defineAttribute('insetRight',0);TP.core.DragResponder.Inst.defineAttribute('insetBottom',0);TP.core.DragResponder.Inst.defineAttribute('insetLeft',0);TP.core.DragResponder.Inst.defineAttribute('xOffset',0);TP.core.DragResponder.Inst.defineAttribute('yOffset',0);TP.core.DragResponder.Inst.defineMethod('init',function(b,c){var a,d;this.callNextMethod(b);this.set('currentPoint',TP.pc(0,0));a=b.get('eventSource');if(a!==TP.core.Mouse){this.set('targetElement',a);}if(TP.isElement(c)){this.set('actionElement',d);}else if(TP.isElement(a)){this.set('actionElement',a);}else{this.set('actionElement',null);}this.set('modifiers',TP.ac());this.set('$frameOffsetPoint',TP.pc(0,0));return this;});TP.core.DragResponder.Inst.defineMethod('addDataModifier',function(a,b){if(!TP.isFunction(a)){return this.raise('TP.sig.InvalidFunction',arguments,'Invalid modifier function: '+a);}a.modifierData=b;this.get('modifiers').push(a);return this;});TP.core.DragResponder.Inst.defineMethod('computeOffsetPoint',function(){var h,j,d,e,i,b,c,k,f,g,a;if(!TP.isElement(h=this.get('actionElement'))){this.set('$offsetPoint',TP.pc(0,0));return this;}j=this.get('startPoint');d=j.getX();e=j.getY();i=TP.elementGetOffsetFromContainer(h);b=d-i.first();c=e-i.last();if(TP.isValid(k=this.get('dragCorner'))){f=TP.elementGetBorderInPixels(h,TP.LEFT);g=TP.elementGetBorderInPixels(h,TP.TOP);a=TP.elementGetPageBox(h,TP.CONTENT_BOX);switch(k){case TP.TOP:b+=a.at('left')+a.at('width')/2-d-f;c+=a.at('top')-e-g;break;case TP.TOP_RIGHT:b+=a.at('left')+a.at('width')-d;c+=a.at('top')-e-g;break;case TP.RIGHT:b+=a.at('left')+a.at('width')-d;c+=a.at('top')+a.at('height')/2-e-g;break;case TP.BOTTOM_RIGHT:b+=a.at('left')+a.at('width')-d;c+=a.at('top')+a.at('height')-e;break;case TP.BOTTOM:b+=a.at('left')+a.at('width')/2-d-f;c+=a.at('top')+a.at('height')-e;break;case TP.BOTTOM_LEFT:b+=a.at('left')-d-f;c+=a.at('top')+a.at('height')-e;break;case TP.LEFT:b+=a.at('left')-d-f;c+=a.at('top')+a.at('height')/2-e-g;break;case TP.TOP_LEFT:b+=a.at('left')-d-f;c+=a.at('top')-e-g;break;}}this.set('$offsetPoint',TP.pc(b,c));return this;});TP.core.DragResponder.Inst.defineMethod('defineDefaultHandlers',function(){this.defineStateHandler('dragging',this,TP.ENTER);this.defineStateHandler('dragging',this,TP.TRANSITION,TP.ACTIVE);this.defineStateHandler('dragging',this,TP.EXIT);this.defineStateHandler('dragging',this,TP.INPUT);return;});TP.core.DragResponder.Inst.defineMethod('draggingTP_sig_DOMDragHover',function(a){return;});TP.core.DragResponder.Inst.defineMethod('draggingTP_sig_DOMDragMove',function(c){var a,b;a=c.getPayload().at('trigger');if(TP.isValid(b=this.get('currentSignal'))){this.set('lastSignal',b);}this.set('currentSignal',a);return;});TP.core.DragResponder.Inst.defineMethod('draggingEnter',function(c){var a,b;a=c.getPayload().at('trigger');if(TP.isValid(a)){this.set('startSignal',a);this.set('currentSignal',a);b=a.getPagePoint();this.set('startPoint',b);this.computeOffsetPoint();this.setupDataModifiers();}return;});TP.core.DragResponder.Inst.defineMethod('draggingExit',function(a){this.deactivate();return;});TP.core.DragResponder.Inst.defineMethod('getCurrentPoint',function(e){var a,b,d,c;a=this.$get('currentPoint');b=this.get('currentSignal');a.setXY(b.getPageX()+this.get('xOffset'),b.getPageY()+this.get('yOffset'));if(this.get('actionWindow')!==(d=TP.eventGetWindow(b.getEvent()))){c=TP.pc(TP.windowComputeWindowOffsets(TP.nodeGetWindow(this.get('actionElement')),d));this.set('$frameOffsetPoint',c);this.set('actionWindow',d);}else{c=this.get('$frameOffsetPoint');}a.translateByPoint(c);if(TP.notFalse(e)){this.modifyResponderData(b,a);}return a;});TP.core.DragResponder.Inst.defineMethod('modifyResponderData',function(e,f){var c,b,a,d;if(!TP.isElement(this.get('actionElement'))){return this;}if(TP.isEmpty(c=this.get('modifiers'))){return this;}for(b=0;b<c.getSize();b++){if(TP.isCallable(a=c.at(b))){try{switch(arguments.length){case 1:a(this,e);break;case 2:a(this,e,f);break;default:d=TP.args(arguments);d.unshift(this);a.call(d);break;}}catch(b){this.raise('TP.sig.ModifierFailed',arguments,'Signal modifier function failed: '+TP.ec(b,a));}}}return this;});TP.core.DragResponder.Inst.defineMethod('setActionElement',function(b){var a;if(TP.notValid(b)){this.$set('actionElement',null);this.set('actionWindow',null);return this;}a=TP.unwrap(b);if(!TP.isElement(a)){a=TP.$(b);a=TP.elem(a);if(!TP.isElement(a)){return this.raise('TP.sig.InvalidParameter',arguments,'Could not resolve anElement to an element: '+b);}}this.$set('actionElement',a);this.set('actionWindow',TP.nodeGetWindow(a));return this;});TP.core.DragResponder.Inst.defineMethod('setupDataModifiers',function(){var a;if(!TP.isElement(this.get('actionElement'))){return this;}if(TP.isEmpty(a=this.get('modifiers'))){return this;}a.perform(function(a){a.tempData=TP.hc();});return this;});TP.core.DragResponder.Inst.defineMethod('setupFrom',function(l,o,n,m){var d,a,g,j,h,b,i,f,k,e,c;if(TP.notValid(d=m)){d=l.getAttributes();}if(TP.notEmpty(a=l.getAttribute('drag:item'))){g=TP.core.Mouse.get('lastDown');if(a==='target'){if(TP.isElement(j=TP.eventGetResolvedTarget(g))){b=j;}}else{h=o.getNativeNode();b=TP.nodeEvaluatePath(h,a,null,true);if(TP.isArray(f=b)){b=null;i=TP.eventGetClientXY(g);k=TP.elementGetElementAtPoint(h,i.first(),i.last());for(e=0;e<f.getSize();e++){if(f.at(e)===k){b=f.at(e);break;}}}}if(!TP.isElement(b)){return this.raise('TP.sig.InvalidParamter',arguments,'No elements found for drag:item path: '+a);}d.removeKey('drag:item');}else{b=n.getNativeNode();}this.set('actionElement',b);if(TP.notEmpty(a=d.at('drag:increment'))){c=TP.cssDimensionValuesFromString(a);a=TP.elementGetPixelValue(b,c.at('left'),'width');if(a!==0){this.addDataModifier(TP.core.DragResponder.INCREMENT_X_BY,TP.hc('increment',a));}a=TP.elementGetPixelValue(b,c.at('top'),'height');if(a!==0){this.addDataModifier(TP.core.DragResponder.INCREMENT_Y_BY,TP.hc('increment',a));}}if(TP.notEmpty(a=d.at('drag:corner'))){this.set('dragCorner',TP[a]);d.removeKey('drag:corner');}if(TP.notEmpty(a=d.at('drag:offset'))){c=TP.cssDimensionValuesFromString(a);this.set('xOffset',TP.elementGetPixelValue(b,c.at('left'),'width'));this.set('yOffset',TP.elementGetPixelValue(b,c.at('top'),'height'));d.removeKey('drag:offset');}if(TP.notEmpty(a=d.at('drag:insets'))){c=TP.cssDimensionValuesFromString(a);this.set('insetTop',TP.elementGetPixelValue(b,c.at('top'),'height'));this.set('insetRight',TP.elementGetPixelValue(b,c.at('right'),'width'));this.set('insetBottom',TP.elementGetPixelValue(b,c.at('bottom'),'height'));this.set('insetLeft',TP.elementGetPixelValue(b,c.at('left'),'width'));d.removeKey('drag:insets');}if(TP.notEmpty(a=d.at('drag:constraints'))){a=a.split(' ');a.perform(function(b){var a;if(TP.isCallable(a=TP.core.DragResponder[b])){this.addDataModifier(a);}}.bind(this));}return this;});TP.core.DragResponder.Inst.defineMethod('teardownDataModifiers',function(){var a;if(TP.isEmpty(a=this.get('modifiers'))){return this;}a.perform(function(a){delete a.modifierData;delete a.tempData;});a.empty();return this;});TP.core.DragResponder.defineSubtype('MoveResponder');TP.core.MoveResponder.Type.defineMethod('initialize',function(){var b,a;b=TP.core.DragMachine.construct();a=this.construct(b);a.defineMethod('draggingExit',function(a){this.callNextMethod();this.teardownDataModifiers();this.set('actionElement',null);this.set('xOffset',0);this.set('yOffset',0);this.set('dragCorner',null);return this;});a.setID('MoveService');TP.sys.registerObject(a);return;});TP.core.MoveResponder.Inst.defineAttribute('$overlayElement');TP.core.MoveResponder.Inst.defineAttribute('$computedPoint');TP.core.MoveResponder.Inst.defineMethod('draggingTP_sig_DOMDragMove',function(l){var h,f,i,j,b,k,e,a,g,c,d;this.callNextMethod();h=this.get('currentSignal');b=this.get('actionElement');if(TP.notValid(h)||!TP.isElement(b)){return;}f=this.getCurrentPoint(false);i=f.getX();j=f.getY();k=TP.elementGetBorderBox(b);e=this.get('$offsetPoint');a=this.get('$computedPoint');g=TP.elementGetStyleObj(b);c=i-e.getX();d=j-e.getY();a.setXY(c,d);this.modifyResponderData(h,a);c=a.getX();d=a.getY();g.top=d+'px';g.left=c+'px';return;});TP.core.MoveResponder.Inst.defineMethod('draggingEnter',function(l){var f,a,e,b,d,h,i,j,c,g,k;this.callNextMethod();f=this.get('startSignal');a=this.get('actionElement');if(TP.notValid(f)||!TP.isElement(a)){return;}b=TP.documentCreateElement(TP.nodeGetDocument(a),'div',TP.w3.Xmlns.XHTML);d=this.get('insetTop');h=this.get('insetRight');i=this.get('insetBottom');j=this.get('insetLeft');TP.elementSetStyle(b,TP.join('position: ','absolute;',' top: ',d+'px;',' right: ',h+'px;',' bottom: ',i+'px;',' left: ',j+'px;',' background-color: ','transparent;'));this.set('$overlayElement',b);TP.nodeAppendChild(a,b,false);c=this.get('startPoint');g=c.getX();k=c.getY();if(!TP.elementContainsPoint(b,g,k)){l.stopPropagation();TP.nodeDetach(b);this.set('actionElement',null);return;}TP.elementDisableUserSelect(a);if(TP.isElement(e=this.get('targetElement'))){TP.elementDisableUserSelect(e);}this.set('$computedPoint',TP.pc());TP.elementSetAttribute(a,'pclass:moving','true',true);return;});TP.core.MoveResponder.Inst.defineMethod('draggingExit',function(d){var a,b,c;a=this.get('actionElement');if(!TP.isElement(a)){return;}TP.elementRemoveAttribute(a,'pclass:moving',true);TP.elementEnableUserSelect(a);if(TP.isElement(c=this.get('targetElement'))){TP.elementEnableUserSelect(c);}b=this.get('$overlayElement');TP.nodeDetach(b);return this.callNextMethod();});TP.core.MoveResponder.Inst.defineMethod('setupFrom',function(b,f,c,g){var a,d,e;if(TP.notValid(a=g)){a=b.getAttributes();}if(TP.notEmpty(d=a.at('drag:container'))&&TP.isElement(e=TP.nodeEvaluatePath(c.getNativeNode(),d,null,true,true))){this.addDataModifier(TP.core.DragResponder.CLAMP_X_AND_Y_TO_CONTAINER,TP.hc('container',e));a.removeKey('drag:container');}return this.callNextMethod(b,f,c,a);});TP.core.DragResponder.defineSubtype('ResizeResponder');TP.core.ResizeResponder.Type.defineConstant('CLAMP_RECT_TO_CONTAINER',function(f,i,g){var a,b,e,h,d,c;c=TP.core.ResizeResponder.CLAMP_RECT_TO_CONTAINER;if(TP.notValid(a=c.tempData.at('containerRect'))){b=f.get('actionElement');e=TP.ifInvalid(c.modifierData.at('container'),TP.elementGetOffsetParent(b));h=TP.wrap(b).getPageRect();a=TP.wrap(e).getPageRect();a.setXY(0,0);d=TP.elementGetOffsetFromContainer(b);a.shrink(d.first(),d.last());c.tempData.atPut('containerRect',a);}g.clampToRect(a);});TP.core.ResizeResponder.Type.defineMethod('initialize',function(){var b,a;b=TP.core.DragMachine.construct();a=this.construct(b);a.defineMethod('draggingExit',function(a){this.callNextMethod();this.teardownDataModifiers();this.set('actionElement',null);this.set('xOffset',0);this.set('yOffset',0);this.set('dragCorner',null);this.set('dragSide',null);return this;});a.setID('ResizeService');TP.sys.registerObject(a);return;});TP.core.ResizeResponder.Inst.defineAttribute('$overlayElement');TP.core.ResizeResponder.Inst.defineAttribute('$computedPoint');TP.core.ResizeResponder.Inst.defineAttribute('dragSide');TP.core.ResizeResponder.Inst.defineAttribute('sideComputed');TP.core.ResizeResponder.Inst.defineAttribute('perimeterTop');TP.core.ResizeResponder.Inst.defineAttribute('perimeterRight');TP.core.ResizeResponder.Inst.defineAttribute('perimeterBottom');TP.core.ResizeResponder.Inst.defineAttribute('perimeterLeft');TP.core.ResizeResponder.Inst.defineAttribute('$parentOffsets');TP.core.ResizeResponder.Inst.defineMethod('init',function(a,b){this.callNextMethod();this.set('perimeterTop',10);this.set('perimeterRight',10);this.set('perimeterBottom',10);this.set('perimeterLeft',10);return this;});TP.core.ResizeResponder.Inst.defineMethod('computeOffsetPoint',function(){var d,q,f,e,r,c,b,m,n,a,i,h,k,l,j,g,o,s,t,p;if(!TP.isElement(d=this.get('actionElement'))){this.set('$offsetPoint',TP.pc(0,0));return this;}q=this.get('startPoint');f=q.getX();e=q.getY();r=TP.elementGetOffsetFromContainer(d);c=f-r.first();b=e-r.last();if(TP.notValid(m=this.get('dragSide'))){m=TP.elementComputeCornerUsing(d,f,e,this.get('perimeterTop'),this.get('perimeterRight'),this.get('perimeterBottom'),this.get('perimeterLeft'));this.set('dragSide',m);n=true;}else{n=false;}this.set('sideComputed',n);a=TP.elementGetPageBox(d,TP.CONTENT_BOX);if(!n){i=TP.elementGetBorderInPixels(d,TP.LEFT);h=TP.elementGetBorderInPixels(d,TP.TOP);switch(m){case TP.TOP:c+=a.at('left')+a.at('width')/2-f-i;b+=a.at('top')-e-h;break;case TP.TOP_RIGHT:c+=a.at('left')+a.at('width')-f;b+=a.at('top')-e-h;break;case TP.RIGHT:c+=a.at('left')+a.at('width')-f;b+=a.at('top')+a.at('height')/2-e-h;break;case TP.BOTTOM_RIGHT:c+=a.at('left')+a.at('width')-f;b+=a.at('top')+a.at('height')-e;break;case TP.BOTTOM:c+=a.at('left')+a.at('width')/2-f-i;b+=a.at('top')+a.at('height')-e;break;case TP.BOTTOM_LEFT:c+=a.at('left')-f-i;b+=a.at('top')+a.at('height')-e;break;case TP.LEFT:c+=a.at('left')-f-i;b+=a.at('top')+a.at('height')/2-e-h;break;case TP.TOP_LEFT:c+=a.at('left')-f-i;b+=a.at('top')-e-h;break;}}if(TP.elementGetOffsetParent(d)===TP.nodeGetDocument(d).documentElement){g=0;k=c;l=b;j=0;p=TP.ac(0,0);}else{if(!n){g=0;k=a.at('width')+TP.elementGetBorderInPixels(d,TP.RIGHT);l=a.at('height')+TP.elementGetBorderInPixels(d,TP.BOTTOM);j=0;}else{o=TP.elementGetPageXY(d,TP.BORDER_BOX,TP.documentGetBody(TP.nodeGetDocument(d)));s=TP.elementGetBorderInPixels(d,TP.LEFT)+TP.elementGetBorderInPixels(d,TP.RIGHT);t=TP.elementGetBorderInPixels(d,TP.TOP)+TP.elementGetBorderInPixels(d,TP.BOTTOM);g=e-(o.last()+t);k=f-o.first();l=e-o.last();j=f-(o.first()+s);}p=TP.elementGetPageXY(TP.elementGetOffsetParent(d),TP.CONTENT_BOX,TP.documentGetBody(TP.nodeGetDocument(d)));}this.set('$parentOffsets',p);switch(m){case TP.TOP:b=b-g;break;case TP.TOP_RIGHT:c=a.at('width')-k;b=b-g;break;case TP.RIGHT:c=a.at('width')-k;break;case TP.BOTTOM_RIGHT:c=a.at('width')-k;b=a.at('height')-l;break;case TP.BOTTOM:b=a.at('height')-l;break;case TP.BOTTOM_LEFT:c=c-j;b=a.at('height')-l;break;case TP.LEFT:c=c-j;break;case TP.TOP_LEFT:c=c-j;b=b-g;break;}this.set('$offsetPoint',TP.pc(c,b));return this;});TP.core.ResizeResponder.Inst.defineMethod('draggingTP_sig_DOMDragMove',function(r){var g,h,p,j,i,e,f,a,d,q,k,n,o,b,c,m,l;this.callNextMethod();g=this.get('currentSignal');h=this.get('actionElement');if(TP.notValid(g)||!TP.isElement(h)){return;}p=this.getCurrentPoint(false);j=p.getX();i=p.getY();e=TP.elementGetPageBox(h,TP.CONTENT_BOX);f=this.get('$offsetPoint');a=this.get('$computedPoint');d=TP.elementGetStyleObj(h);q=this.get('dragSide');k=this.get('$parentOffsets');n=TP.elementGetBorderInPixels(h,TP.LEFT)+TP.elementGetBorderInPixels(h,TP.RIGHT);o=TP.elementGetBorderInPixels(h,TP.TOP)+TP.elementGetBorderInPixels(h,TP.BOTTOM);switch(q){case TP.TOP:c=i-f.getY();a.setY(c);this.modifyResponderData(g,a);c=a.getY();d.top=c+'px';l=e.at('height')-(c-e.at('top'))-k.last()-o;d.height=l+'px';break;case TP.TOP_RIGHT:c=i-f.getY();b=j-e.at('left')+f.getX();a.setXY(b,c);this.modifyResponderData(g,a);b=a.getX();c=a.getY();d.top=c+'px';l=e.at('height')-(c-e.at('top'))-k.last()-o;d.height=l+'px';d.width=b+'px';break;case TP.RIGHT:b=j-e.at('left')+f.getX();a.setX(b);this.modifyResponderData(g,a);b=a.getX();d.width=b+'px';break;case TP.BOTTOM_RIGHT:b=j-e.at('left')+f.getX();c=i-e.at('top')+f.getY();a.setXY(b,c);this.modifyResponderData(g,a);b=a.getX();c=a.getY();d.width=b+'px';d.height=c+'px';break;case TP.BOTTOM:c=i-e.at('top')+f.getY();a.setY(c);this.modifyResponderData(g,a);c=a.getY();d.height=c+'px';break;case TP.BOTTOM_LEFT:b=j-f.getX();c=i-e.at('top')+f.getY();a.setXY(b,c);this.modifyResponderData(g,a);b=a.getX();c=a.getY();d.left=b+'px';m=e.at('width')-(b-e.at('left'))-k.first()-n;d.width=m+'px';d.height=c+'px';break;case TP.LEFT:b=j-f.getX();a.setX(b);this.modifyResponderData(g,a);b=a.getX();d.left=b+'px';m=e.at('width')-(b-e.at('left'))-k.first()-n;d.width=m+'px';break;case TP.TOP_LEFT:b=j-f.getX();c=i-f.getY();a.setXY(b,c);this.modifyResponderData(g,a);b=a.getX();c=a.getY();d.top=c+'px';l=e.at('height')-(c-e.at('top'))-k.last()-o;d.height=l+'px';d.left=b+'px';m=e.at('width')-(b-e.at('left'))-k.first()-n;d.width=m+'px';break;}return;});TP.core.ResizeResponder.Inst.defineMethod('draggingEnter',function(l){var f,a,e,b,d,h,i,j,c,g,k;this.callNextMethod();f=this.get('startSignal');a=this.get('actionElement');if(TP.notValid(f)||!TP.isElement(a)){return;}b=TP.documentCreateElement(TP.nodeGetDocument(a),'div',TP.w3.Xmlns.XHTML);d=this.get('insetTop');h=this.get('insetRight');i=this.get('insetBottom');j=this.get('insetLeft');TP.elementSetStyle(b,TP.join('position: ','absolute;',' top: ',d+'px;',' right: ',h+'px;',' bottom: ',i+'px;',' left: ',j+'px;',' background-color: ','transparent;'));this.set('$overlayElement',b);TP.nodeAppendChild(a,b,false);c=this.get('startPoint');g=c.getX();k=c.getY();if(!TP.elementContainsPoint(b,g,k)){l.stopPropagation();TP.nodeDetach(b);this.set('actionElement',null);return;}TP.elementDisableUserSelect(a);if(TP.isElement(e=this.get('targetElement'))){TP.elementDisableUserSelect(e);}this.set('$computedPoint',TP.pc());TP.elementSetAttribute(a,'pclass:resizing','true',true);return;});TP.core.ResizeResponder.Inst.defineMethod('draggingExit',function(d){var a,b,c;a=this.get('actionElement');if(!TP.isElement(a)){return;}TP.elementRemoveAttribute(a,'pclass:resizing',true);TP.elementEnableUserSelect(a);b=this.get('$overlayElement');TP.nodeDetach(b);if(TP.isElement(c=this.get('targetElement'))){TP.elementEnableUserSelect(c);}if(TP.isTrue(this.get('sideComputed'))){this.set('dragSide',null);}return this.callNextMethod();});TP.core.ResizeResponder.Inst.defineMethod('setupFrom',function(c,f,d,g){var a,b,e;if(TP.notValid(a=g)){a=c.getAttributes();}if(TP.notEmpty(b=a.at('drag:container'))&&TP.isElement(e=TP.nodeEvaluatePath(d.getNativeNode(),b,null,true,true))){this.addDataModifier(TP.core.ResizeResponder.CLAMP_RECT_TO_CONTAINER,TP.hc('container',e));a.removeKey('drag:container');}if(TP.notEmpty(b=a.at('drag:side'))){this.set('dragSide',TP[b]);a.removeKey('drag:side');}if(TP.notEmpty(b=a.at('drag:constraints'))){b=b.split(' ');b.perform(function(b){var a;if(TP.isCallable(a=TP.core.ResizeResponder[b])||TP.isCallable(a=TP.core.DragResponder[b])){this.addDataModifier(a);}}.bind(this));}return this.callNextMethod(c,f,d,a);});TP.core.MoveResponder.defineSubtype('DNDResponder');TP.core.DNDResponder.Type.defineConstant('CLAMP_X_AND_Y_TO_CONTAINER',function(h,j,i){var c,d,f,g,b,e,a;a=TP.core.DNDResponder.CLAMP_X_AND_Y_TO_CONTAINER;if(TP.notValid(c=a.tempData.at('maxFittedRect'))){d=h.get('itemElement');f=TP.ifInvalid(a.modifierData.at('container'),TP.elementGetOffsetParent(d));g=TP.wrap(d).getPageRect();b=TP.wrap(f).getPageRect();e=g.maxFittedPoint(b);c=TP.rtc(b.getX(),b.getY(),e.getX(),e.getY());a.tempData.atPut('maxFittedRect',c);}i.clampToRect(c);});TP.core.DNDResponder.Type.defineConstant('FILTER_BY_STRING_OR',function(g,e,f,h){var a,b,c,d;if(TP.isEmpty(a=f.getAttribute('dnd:accept'))){return false;}if(TP.notEmpty(b=e.getAttribute('dnd:vend'))){c=a.split(' ');d=b.split(' ');return c.containsAny(d);}return false;});TP.core.DNDResponder.Type.defineConstant('FILTER_BY_STRING_AND',function(g,e,f,h){var a,b,c,d;if(TP.isEmpty(a=f.getAttribute('dnd:accept'))){return false;}if(TP.notEmpty(b=e.getAttribute('dnd:vend'))){c=a.split(' ');d=b.split(' ');return c.containsAll(d);}return false;});TP.core.DNDResponder.Type.defineConstant('FILTER_BY_TYPE',function(h,b,c,i){var d,e,a,f,g;if(TP.isEmpty(d=c.getAttribute('dnd:accept'))){return false;}if(TP.notEmpty(e=b.getAttribute('dnd:vend'))){g=e.split(' ');a=TP.sig.DOMDNDWillVend.construct(null);g.perform(function(c){var b;if(TP.isType(b=TP.sys.getTypeByName(c))){b.handle(a);}});if(a.shouldPrevent()){return false;}a=b.signal(a);if(a.shouldPrevent()){return false;}f=d.split(' ');a=TP.sig.DOMDNDWillAccept.construct(null);f.perform(function(c){var b;if(TP.isType(b=TP.sys.getTypeByName(c))){b.handle(a);}});if(a.shouldPrevent()){return false;}a=c.signal(a);if(a.shouldPrevent()){return false;}return true;}return false;});TP.core.DNDResponder.Type.defineConstant('FILTER_BY_PATH',function(e,a,d,f){var b,c;if(!d.hasAttribute('dnd:accept')){return false;}if(TP.notEmpty(b=a.getAttribute('dnd:vend'))){if(TP.notEmpty(c=a.get(b))){return c.contains(a.getNativeNode(),TP.IDENTITY);}}return false;});TP.core.DNDResponder.Type.defineConstant('FILTER_BY_DTD',function(c,d,a,b){if(!a.hasAttribute('dnd:accept')){return false;}return TP.w3.DocType.HTML_401_STRICT.get('dtdInfo').elementIsValidChildOf(b.getTagName().toLowerCase(),a.getTagName().toLowerCase());});TP.core.DNDResponder.Type.defineMethod('initialize',function(){var b,a;b=TP.core.DragMachine.construct();a=this.construct(b);a.defineMethod('draggingExit',function(a){this.callNextMethod();this.teardownDataModifiers();this.set('actionElement',null);this.set('xOffset',0);this.set('yOffset',0);this.set('dragCorner',null);return this;});a.setID('DNDService');TP.sys.registerObject(a);return;});TP.core.DNDResponder.Inst.defineAttribute('$realActionElem');TP.core.DNDResponder.Inst.defineAttribute('itemElement');TP.core.DNDResponder.Inst.defineAttribute('itemPagePoint');TP.core.DNDResponder.Inst.defineMethod('computeOffsetPoint',function(){var i,b,c,f,g,h,j,k,d,e,l,a,m;if(!TP.isElement(f=this.get('actionElement'))){return;}i=this.get('startPoint');b=i.getX();c=i.getY();g=this.get('itemPagePoint');h=TP.elementGetOffsetParent(f);j=TP.elementGetBorderInPixels(h,TP.LEFT);k=TP.elementGetBorderInPixels(h,TP.TOP);d=b-j-g.getX();e=c-k-g.getY();if(TP.isValid(l=this.get('dragCorner'))){a=TP.elementGetPageBox(f,TP.CONTENT_BOX);switch(l){case TP.TOP:break;case TP.TOP_RIGHT:d=a.at('left')+a.at('width')-b;break;case TP.RIGHT:d=a.at('left')+a.at('width')-b;break;case TP.BOTTOM_RIGHT:d=a.at('left')+a.at('width')-b;e=a.at('top')+a.at('height')-c;break;case TP.BOTTOM:e=a.at('top')+a.at('height')-c;break;case TP.BOTTOM_LEFT:e=a.at('top')+a.at('height')-c;break;case TP.LEFT:break;case TP.TOP_LEFT:break;}}m=TP.pc(d,e);this.set('$offsetPoint',m);return this;});TP.core.DNDResponder.Inst.defineMethod('draggingEnter',function(d){var a,b,c;if(!TP.isElement(a=this.get('actionElement'))){return;}b=this.makeDragElementFrom(a);this.set('$realActionElem',a);this.set('actionElement',b);c=TP.nodeGetDescendantElementsByAttribute(TP.nodeGetDocument(a),'dnd:accept');return this.callNextMethod();});TP.core.DNDResponder.Inst.defineMethod('draggingExit',function(d){var b,a,c;if(TP.isValid(b=TP.core.UIElementNode.get('currentDNDTarget'))){a=TP.hc('dndSource',TP.core.UIElementNode.get('currentDNDSource'),'dndTarget',b);}else{a=TP.hc('dndSource',TP.core.UIElementNode.get('currentDNDSource'));}if(TP.isValid(b)&&b.willDrop()){this.signal('TP.sig.DOMDNDSucceeded',arguments,a);}else{this.signal('TP.sig.DOMDNDFailed',arguments,a);}this.signal('TP.sig.DOMDNDCompleted',arguments,a);TP.core.UIElementNode.Type.set('currentDNDSource',null);TP.core.UIElementNode.Type.set('currentDNDTarget',null);TP.core.UIElementNode.Type.set('currentDNDItem',null);this.signal('TP.sig.DOMDNDTerminate');c=this.get('actionElement');this.callNextMethod();TP.nodeDetach(c);this.set('actionElement',this.get('$realActionElem'));return;});TP.core.DNDResponder.Inst.defineMethod('handleTargetIn',function(c){var b,a;b=TP.wrap(c.at('targetRect').get('targetElement'));if(TP.isValid(a=b.getDNDTarget())&&a.isValidTarget()){TP.core.UIElementNode.Type.set('currentDNDTarget',a);a.signal('TP.sig.DOMDNDTargetOver');}return this;});TP.core.DNDResponder.Inst.defineMethod('handleTargetOut',function(b){var a;if(TP.notValid(a=TP.core.UIElementNode.get('currentDNDTarget'))){return this;}a.signal('TP.sig.DOMDNDTargetOut');TP.core.UIElementNode.Type.set('currentDNDTarget',null);return this;});TP.core.DNDResponder.Inst.defineMethod('makeDragElementFrom',function(c){var d,a,e,f,g,b;if(TP.notValid(d=TP.nodeGetDocument(c))){return;}a=TP.documentCreateElement(d,'div',TP.w3.Xmlns.XHTML);a.setAttribute('id','__dragElement__');a.setAttribute('style','position: absolute; z-index: '+TP.DRAG_DROP_TIER);a._tibetGenerated=true;TP.nodeAppendChild(TP.documentGetBody(d),a,false);TP.nodeAppendChild(a,c,false);e=this.get('itemPagePoint');a.style.left=e.getX()+'px';a.style.top=e.getY()+'px';f=TP.elementGetContentWidth(c);g=TP.elementGetContentHeight(c);TP.elementSetWidth(a,f);TP.elementSetHeight(a,g);if(TP.notValid(b=a.dragCoverElement)){b=TP.documentCreateElement(d,'div',TP.w3.Xmlns.XHTML);b.setAttribute('style','position: absolute; background-color: transparent; '+'top: -5px; right: -5px; bottom: -5px; left: -5px; ');a.dragCoverElement=b;}TP.nodeAppendChild(a,b,false);return a;});TP.core.DNDResponder.Inst.defineMethod('setupFrom',function(d,g,e,f){var a,b,c;if(TP.notValid(a=f)){a=d.getAttributes();}if(TP.notEmpty(b=a.at('drag:container'))&&TP.isElement(c=TP.nodeEvaluatePath(e.getNativeNode(),b,null,true,true))){this.addDataModifier(TP.core.DNDResponder.CLAMP_X_AND_Y_TO_CONTAINER,TP.hc('container',c));a.removeKey('drag:container');}return this;});TP.core.UIElementNode.Type.defineConstant('DRAG_CSS_PROPERTY_NAMES',TP.ac('background','backgroundAttachment','backgroundColor','backgroundImage','backgroundPosition','backgroundRepeat','border','borderBottom','borderBottomColor','borderBottomStyle','borderBottomWidth','borderCollapse','borderColor','borderLeft','borderLeftColor','borderLeftStyle','borderLeftWidth','borderRight','borderRightColor','borderRightStyle','borderRightWidth','borderSpacing','borderStyle','borderTop','borderTopColor','borderTopStyle','borderTopWidth','borderWidth','clear','clip','color','content','counterIncrement','counterReset','cssFloat','cursor','direction','display','emptyCells','font','fontFamily','fontSize','fontSizeAdjust','fontStretch','fontStyle','fontVariant','fontWeight','height','letterSpacing','lineHeight','listStyle','listStyleImage','listStylePosition','listStyleType','margin','marginBottom','marginLeft','marginRight','marginTop','maxHeight','maxWidth','minHeight','minWidth','outline','outlineColor','outlineStyle','outlineWidth','overflow','padding','paddingBottom','paddingLeft','paddingRight','paddingTop','position','quotes','size','tableLayout','textAlign','textDecoration','textIndent','textShadow','textTransform','unicodeBidi','verticalAlign','visibility','whiteSpace','width','wordSpacing'));TP.core.UIElementNode.Type.defineAttribute('currentDNDSource');TP.core.UIElementNode.Type.defineAttribute('currentDNDTarget');TP.core.UIElementNode.Type.defineAttribute('currentDNDItem');TP.core.UIElementNode.Type.defineMethod('handlePeerTP_sig_DOMDragDown',function(k,m){var a,b,c,h,f,d,j,e,l,g,i;if(!TP.isElement(k)){return this.raise('TP.sig.InvalidElement',arguments);}a=TP.wrap(k);if(a.willMove()){if(TP.isValid(h=TP.byOID('MoveService'))){b=a.getDragSource();c=b.getDragInfo();h.setupFrom(c,b,a);}h.activate();return this;}if(a.willResize()){if(TP.isValid(f=TP.byOID('ResizeService'))){b=a.getDragSource();c=b.getDragInfo();f.setupFrom(c,b,a);}f.activate();return this;}if(a.willGrab()&&TP.isValid(b=a.getDNDSource())){if(TP.isValid(d=TP.byOID('DNDService'))){j=d.signal('TP.sig.DOMDNDInitiate');if(j.shouldPrevent()){return this;}c=b.getDNDInfo();e=c.getDragItem();if(TP.isElement(l=e.getDNDRepElement())){d.setupFrom(c,b,a);d.set('actionElement',l);g=e.getNativeNode();d.set('itemElement',g);i=TP.elementGetPageXY(g);d.set('itemPagePoint',TP.pc(i));TP.core.UIElementNode.Type.set('currentDNDSource',b);TP.core.UIElementNode.Type.set('currentDNDItem',e);d.activate();}}}return this;});TP.core.UIElementNode.Inst.defineMethod('getDragInfo',function(){var a,b;if(!this.hasAttribute('drag:info')){return this;}if(TP.notEmpty(a=TP.elementGetAttribute(this.getNativeNode(),'drag:info',true))){if(TP.isElement(b=TP.nodeEvaluatePath(this.getNativeNode(),a,null,true,true))){return TP.wrap(b);}}return this;});TP.core.UIElementNode.Inst.defineMethod('getDragItem',function(){var b,d,e,a,c;if(!this.hasAttribute('drag:item')){return this;}b=this.getAttribute('drag:item');if(b==='target'){d=TP.core.Mouse.get('lastDown');if(TP.isElement(e=TP.eventGetResolvedTarget(d))){a=e;}}else{c=this.getNativeNode();if(!TP.isElement(a=TP.nodeEvaluatePath(c,b,null,true))){a=c;}}return TP.wrap(a);});TP.core.UIElementNode.Inst.defineMethod('getDragSource',function(){var a,b,c;if(this.hasAttribute('drag:mover')||this.hasAttribute('drag:resizer')){return this;}a=this.detectAncestor(function(a){return TP.elementHasAttribute(a,'drag:mover',true)||TP.elementHasAttribute(a,'drag:resizer',true);});if(TP.isValid(a)){b=a.getDragInfo();if(b.hasAttribute('drag:item')){if(TP.notEmpty(c=TP.nodeEvaluatePath(a.getNativeNode(),b.getAttribute('drag:item'),null))){if(c.contains(this.getNativeNode(),TP.IDENTITY)){return a;}}}}return this;});TP.core.UIElementNode.Inst.defineMethod('getDNDInfo',function(){var a,b;if(!this.hasAttribute('dnd:info')){return this;}if(TP.notEmpty(a=TP.elementGetAttribute(this.getNativeNode(),'dnd:info',true))){if(TP.isElement(b=TP.nodeEvaluatePath(this.getNativeNode(),a,null,true,true))){return TP.wrap(b);}}return this;});TP.core.UIElementNode.Inst.defineMethod('getDNDRepElement',function(){var a,d,b,c;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidElement',arguments);}if(TP.notEmpty(d=TP.elementGetAttribute(a,'dnd:rep',true))){if(!TP.isElement(b=TP.nodeEvaluatePath(a,d,null,true,true))){b=a;}}else{b=a;}c=TP.nodeCloneNode(b);TP.elementSetStyle(c,TP.elementGetComputedStyle(b,TP.core.UIElementNode.DRAG_CSS_PROPERTY_NAMES));TP.elementRemoveAttribute(c,'id');TP.elementShow(c);return c;});TP.core.UIElementNode.Inst.defineMethod('getDNDSource',function(){if(this.hasAttribute('dnd:vend')){return this;}return this.detectAncestor(function(a){return TP.elementHasAttribute(a,'dnd:vend',true);});});TP.core.UIElementNode.Inst.defineMethod('getDNDTarget',function(){if(this.hasAttribute('dnd:accept')){return this;}return this.detectAncestor(function(a){return TP.elementHasAttribute(a,'dnd:accept',true);});});TP.core.UIElementNode.Inst.defineMethod('isValidTarget',function(){var b,c,a,d;if(!this.hasAttribute('dnd:accept')){return false;}if(TP.notValid(b=this.getType().get('currentDNDSource'))||TP.notValid(c=this.getType().get('currentDNDItem'))){return false;}a=TP.ifEmpty(b.getAttribute('dnd:filter'),'FILTER_BY_STRING_OR');switch(a){case'or':a='FILTER_BY_STRING_OR';break;case'and':a='FILTER_BY_STRING_AND';break;case'type':a='FILTER_BY_TYPE';break;case'path':a='FILTER_BY_PATH';break;case'dtd':a='FILTER_BY_DTD';break;default:break;}if(!TP.isCallable(TP.core.DNDResponder[a])){return false;}if(TP.notValid(d=TP.byOID('DNDService'))){return false;}return TP.core.DNDResponder[a](d,b,this,c);});TP.core.UIElementNode.Inst.defineMethod('willDrop',function(){return true;});TP.core.UIElementNode.Inst.defineMethod('willGrab',function(){return true;});TP.core.UIElementNode.Inst.defineMethod('willMove',function(){var a,b,c;if(this.getDragInfo().hasAttribute('drag:mover')){return true;}a=this.detectAncestor(function(a){return TP.elementHasAttribute(a,'drag:item',true);});if(TP.isValid(a)){b=a.getDragInfo();if(!b.hasAttribute('drag:mover')){return false;}if(TP.notEmpty(c=TP.nodeEvaluatePath(a.getNativeNode(),b.getAttribute('drag:item'),null))){return c.contains(this.getNativeNode(),TP.IDENTITY);}}return false;});TP.core.UIElementNode.Inst.defineMethod('willResize',function(){var a,b,c;if(this.getDragInfo().hasAttribute('drag:resizer')){return true;}a=this.detectAncestor(function(a){return TP.elementHasAttribute(a,'drag:item',true);});if(TP.isValid(a)){b=a.getDragInfo();if(!b.hasAttribute('drag:resizer')){return false;}if(TP.notEmpty(c=TP.nodeEvaluatePath(a.getNativeNode(),b.getAttribute('drag:item'),null))){return c.contains(this.getNativeNode(),TP.IDENTITY);}}return false;});TP.core.StateResponder.defineSubtype('DragTracker');TP.core.DragTracker.Type.defineConstant('VEND_ACCEPT',function(a,b,c){});TP.core.DragTracker.Type.defineConstant('GLOBAL_CENTER',function(b){var a;if(TP.isValid(a=this.GLOBAL_RECT(b))){return a.getCenterPoint();}return;});TP.core.DragTracker.Type.defineConstant('GLOBAL_RECT',function(a){if(TP.canInvoke(a,'getGlobalRect')){return a.getGlobalRect();}else if(TP.isElement(a)){return TP.rtc(TP.elementGetGlobalBox(a));}return;});TP.core.DragTracker.Type.defineConstant('GLOBAL_X_COORDS',function(b){var a;if(TP.isValid(a=this.GLOBAL_RECT(b))){return TP.ac(a.getX(),a.getX().addToX(a.getWidth()));}return;});TP.core.DragTracker.Type.defineConstant('GLOBAL_Y_COORDS',function(b){var a;if(TP.isValid(a=this.GLOBAL_RECT(b))){return TP.ac(a.getY(),a.getY().addToY(a.getHeight()));}return;});TP.core.DragTracker.Type.defineConstant('PAGE_CENTER',function(b){var a;if(TP.isValid(a=this.PAGE_RECT(b))){return a.getCenterPoint();}return;});TP.core.DragTracker.Type.defineConstant('PAGE_RECT',function(a){if(TP.canInvoke(a,'getPageRect')){return a.getPageRect();}else if(TP.isElement(a)){return TP.rtc(TP.elementGetPageBox(a));}return;});TP.core.DragTracker.Type.defineConstant('PAGE_X_COORDS',function(b){var a;if(TP.isValid(a=this.PAGE_RECT(b))){return TP.ac(a.getX(),a.getX().addToX(a.getWidth()));}return;});TP.core.DragTracker.Type.defineConstant('PAGE_Y_COORDS',function(b){var a;if(TP.isValid(a=this.PAGE_RECT(b))){return TP.ac(a.getY(),a.getY().addToY(a.getHeight()));}return;});TP.core.DragTracker.Inst.defineAttribute('computeList');TP.core.DragTracker.Inst.defineAttribute('domainList');TP.core.DragTracker.Inst.defineAttribute('domainFunction');TP.core.DragTracker.Inst.defineAttribute('domainSpec');TP.core.DragTracker.Inst.defineAttribute('filterFunction',TP.core.DragTracker.VEND_ACCEPT);TP.core.DragTracker.Inst.defineAttribute('rangeFunction',TP.core.DragTracker.PAGE_RECT);TP.core.DragTracker.Inst.defineAttribute('testFunction',TP.core.DragTracker.VEND_ACCEPT);TP.core.DragTracker.Inst.defineAttribute('trackingSignal','TP.sig.DragTrackerResults');TP.core.DragTracker.Inst.defineMethod('init',function(e,a,b,c,d){var f;if(TP.notValid(e)){return this.raise('TP.sig.InvalidParamter',arguments,'Invalid domain specification.');}f=TP.core.DragMachine.construct();this.callNextMethod(f);this.$set('domainSpec',e);if(TP.isValid(a)){if(!TP.isFunction(a)){return this.raise('TP.sig.InvalidFunction',arguments,'Invalid filter function: '+a);}this.$set('filterFunction',a);}if(TP.isValid(b)){if(!TP.isFunction(b)){return this.raise('TP.sig.InvalidFunction',arguments,'Invalid range function: '+b);}this.$set('rangeFunction',b);}if(TP.isValid(c)){if(!TP.isFunction(c)){return this.raise('TP.sig.InvalidFunction',arguments,'Invalid test function: '+c);}this.$set('testFunction',c);}if(TP.isValid(d)){if(!TP.canInvoke(d,'getSignalName')){return this.raise('TP.sig.InvalidParameter',arguments,'trackingSignal can not provide signal name: '+d);}this.$set('trackingSignal',d.getSignalName());}this.$set('computeList',TP.ac());this.$set('domainList',TP.ac());return this;});TP.core.DragTracker.Inst.defineMethod('clearComputables',function(){var a;a=this.$get('computeList');a.length=0;return this;});TP.core.DragTracker.Inst.defineMethod('clearDomain',function(){var a;a=this.$get('domainList');a.length=0;return this;});TP.core.DragTracker.Inst.defineMethod('defineDefaultHandlers',function(){this.defineStateHandler('dragging',this,TP.ENTER);this.defineStateHandler('dragging',this,TP.TRANSITION,TP.ACTIVE);this.defineStateHandler('dragging',this,TP.EXIT);this.defineStateHandler('dragging',this,TP.INPUT);return;});TP.core.DragTracker.Inst.defineMethod('draggingEnter',function(a){this.refreshDomain();return;});TP.core.DragTracker.Inst.defineMethod('draggingExit',function(a){this.clearDomain();this.clearComputables();return;});TP.core.DragTracker.Inst.defineMethod('draggingTP_sig_DOMDragHover',function(a){return;});TP.core.DragTracker.Inst.defineMethod('draggingTP_sig_DOMDragMove',function(a){return;});TP.core.DragTracker.Inst.defineMethod('refreshComputables',function(){this.clearComputables();return this;});TP.core.DragTracker.Inst.defineMethod('refreshDomain',function(){this.clearDomain();this.refreshComputables();return this;});TP.core.DragTracker.Inst.defineMethod('setFilterFunction',function(a){if(!TP.isFunction(a)){return this.raise('TP.sig.InvalidFunction',arguments,'Invalid filter function: '+a);}this.$set('filterFunction',a);this.refreshRange();return this;});TP.core.DragTracker.Inst.defineMethod('setRangeFunction',function(a){if(!TP.isFunction(a)){return this.raise('TP.sig.InvalidFunction',arguments,'Invalid range function: '+a);}this.$set('rangeFunction',a);this.refreshComputables();return this;});TP.core.DragTracker.Inst.defineMethod('setTestFunction',function(a){if(!TP.isFunction(a)){return this.raise('TP.sig.InvalidFunction',arguments,'Invalid test function: '+a);}this.$set('testFunction',a);return this;});TP.core.DragTracker.Inst.defineMethod('setTrackingSignal',function(a){if(!TP.canInvoke(a,'getSignalName')){return this.raise('TP.sig.InvalidParameter',arguments,'trackingSignal can not provide signal name: '+a);}this.$set('trackingSignal',a.getSignalName());return this;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETGraphicsTypes.js';
TP.lang.Object.defineSubtype('core:Point');TP.definePrimitive('pc',function(a,b){return TP.core.Point.construct.apply(TP.core.Point,arguments);});TP.core.Point.Type.defineMethod('constructFromPolar',function(a,b){var c,d;c=a*b.cosD();d=a*b.sinD();return TP.core.Point.construct(c,d);});TP.core.Point.Inst.defineAttribute('data');TP.core.Point.Inst.defineMethod('init',function(c,d){var a,b;this.callNextMethod();if(TP.notEmpty(arguments)){if(arguments.length===1){a=arguments[0];if(TP.isKindOf(a,TP.core.Point)){a=a.$get('data');b={x:a.x,y:a.y};}else if(TP.isKindOf(a,TP.lang.Hash)){b={x:a.at('x')||a.at('left'),y:a.at('y')||a.at('top')};}else if(TP.isArray(a)){b={x:a.first(),y:a.last()};}else{b={x:a.x,y:a.y};}}else{b={x:c,y:d};}}else{b={x:0,y:0};}this.$set('data',b,false);return this;});TP.core.Point.Inst.defineMethod('add',function(a){var b;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=this.$get('data');b.x+=a.get('x');b.y+=a.get('y');return this;});TP.core.Point.Inst.defineMethod('addToX',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}this.$get('data').x+=a;return this;});TP.core.Point.Inst.defineMethod('addToY',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}this.$get('data').y+=a;return this;});TP.core.Point.Inst.defineMethod('asDumpString',function(){var a,c,b;a=this.$get('data');c=TP.join('(',a.x,', ',a.y,')');try{b=TP.tname(this)+' :: '+c;}catch(a){b=this.toString();}return b;});TP.core.Point.Inst.defineMethod('asHTMLString',function(){var a,b;a=this.$get('data');try{b='<span class="TP_core_Point">'+'<span data-name="x">'+a.x+'</span>'+'<span data-name="y">'+a.y+'</span>'+'</span>';}catch(a){b=this.toString();}return b;});TP.core.Point.Inst.defineMethod('asJSONSource',function(){var a;a=this.$get('data');return'{"type":'+TP.tname(this).quoted('"')+','+'"data":{'+'"x":"'+a.x+'",'+'"y":"'+a.y+'"'+'}}';});TP.core.Point.Inst.defineMethod('asPrettyString',function(){var a,b;a=this.$get('data');try{b='<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+'<dt class="pretty key">x</dt>'+'<dd class="pretty value">'+a.x+'</dd>'+'<dt class="pretty key">y</dt>'+'<dd class="pretty value">'+a.y+'</dd>'+'</dl>';}catch(a){b=this.toString();}return b;});TP.core.Point.Inst.defineMethod('asSource',function(){var a;a=this.$get('data');return TP.join('TP.pc(',a.x,', ',a.y,')');});TP.core.Point.Inst.defineMethod('asString',function(c){var a,b;a=this.$get('data');b=TP.join('(',a.x,', ',a.y,')');return b;});TP.core.Point.Inst.defineMethod('asXMLString',function(){var a,b;a=this.$get('data');try{b='<instance type="'+TP.tname(this)+'"'+' x="'+a.x+'" y="'+a.y+'"'+'/>';}catch(a){b=this.toString();}return b;});TP.core.Point.Inst.defineMethod('clampToPoint',function(c){var b,a;a=this.$get('data');b=c.$get('data');a.x=a.x.min(b.x);a.y=a.y.min(b.y);return this;});TP.core.Point.Inst.defineMethod('clampToRect',function(c){var a,b;b=this.$get('data');a=c.$get('data');b.x=b.x.max(a.x).min(a.x+a.width);b.y=b.y.max(a.y).min(a.y+a.height);return this;});TP.core.Point.Inst.defineMethod('clampXToMinMax',function(b,c){var a;if(!TP.isNumber(b)||!TP.isNumber(c)){return this.raise('TP.sig.InvalidNumber',arguments);}a=this.$get('data');a.x=a.x.max(b).min(c);return this;});TP.core.Point.Inst.defineMethod('clampYToMinMax',function(b,c){var a;if(!TP.isNumber(b)||!TP.isNumber(c)){return this.raise('TP.sig.InvalidNumber',arguments);}a=this.$get('data');a.y=a.y.max(b).min(c);return this;});TP.core.Point.Inst.defineMethod('computeMidpoint',function(a){var b;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=this.$get('data');return TP.core.Point.construct((b.x+a.get('x'))/2,(b.y+a.get('y'))/2);});TP.core.Point.Inst.defineMethod('copy',function(){return TP.core.Point.construct(this);});TP.core.Point.Inst.defineMethod('distanceBetween',function(c){var a,b,d;if(TP.notValid(c)){return this.raise('TP.sig.InvalidParameter',arguments);}a=this.$get('data');b=c.$get('data');d=((b.x-a.x).pow(2)+(b.y-a.y).pow(2)).sqrt();return d;});TP.core.Point.Inst.defineMethod('getX',function(){return this.$get('data').x;});TP.core.Point.Inst.defineMethod('getY',function(){return this.$get('data').y;});TP.core.Point.Inst.defineMethod('interpolate',function(e,a){var b,c,d;if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}b=this.$get('data');c=e.$get('data');d=function(a,b,c){return a+(b-a)*c;};return TP.core.Point.construct(d(b.x,c.x,a),d(b.y,c.y,a));});TP.core.Point.Inst.defineMethod('invert',function(){var a;a=this.$get('data');a.x*=-1;a.y*=-1;return this;});TP.core.Point.Inst.defineMethod('setX',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}this.$get('data').x=a;return this;});TP.core.Point.Inst.defineMethod('setY',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}this.$get('data').y=a;return this;});TP.core.Point.Inst.defineMethod('setXY',function(b,c){var a;if(!TP.isNumber(b)||!TP.isNumber(c)){return this.raise('TP.sig.InvalidNumber',arguments);}a=this.$get('data');a.x=b;a.y=c;return this;});TP.core.Point.Inst.defineMethod('snapToIncrement',function(b,c){var a;if(!TP.isNumber(b)||!TP.isNumber(c)){return this.raise('TP.sig.InvalidNumber',arguments);}a=this.$get('data');a.x=((a.x+b)/b).floor()*b;a.y=((a.y+c)/c).floor()*c;return this;});TP.core.Point.Inst.defineMethod('sortByDistance',function(a){var b,c;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=this.get('x');c=this.get('y');a.sort(function(d,e){var a,f;a=((d.get('x')-b).pow(2)+(d.get('y')-c).pow(2)).sqrt();a=((e.get('x')-b).pow(2)+(e.get('y')-c).pow(2)).sqrt();return a-f;});return a;});TP.core.Point.Inst.defineMethod('subtract',function(a){var b;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=this.$get('data');b.x-=a.get('x');b.y-=a.get('y');return this;});TP.core.Point.Inst.defineMethod('subtractFromX',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}this.$get('data').x-=a;return this;});TP.core.Point.Inst.defineMethod('subtractFromY',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}this.$get('data').y-=a;return this;});TP.core.Point.Inst.defineMethod('translate',function(b,c){var a;if(!TP.isNumber(b)||!TP.isNumber(c)){return this.raise('TP.sig.InvalidNumber',arguments);}a=this.$get('data');a.x+=b;a.y+=c;return this;});TP.core.Point.Inst.defineMethod('translateByPoint',function(a){var b;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=this.$get('data');b.x+=a.get('x');b.y+=a.get('y');return this;});TP.lang.Object.defineSubtype('core:Rect');TP.definePrimitive('rtc',function(a,b,c,d){return TP.core.Rect.construct.apply(TP.core.Rect,arguments);});TP.core.Rect.Inst.defineAttribute('data');TP.core.Rect.Inst.defineMethod('init',function(c,d,e,f){var a,b;this.callNextMethod();if(TP.notEmpty(arguments)){if(arguments.length===1){a=arguments[0];if(TP.isKindOf(a,TP.core.Rect)){a=a.$get('data');b={x:a.x,y:a.y,width:a.width,height:a.height};}else if(TP.isKindOf(a,TP.lang.Hash)){b={x:a.at('x')||a.at('left'),y:a.at('y')||a.at('top'),width:a.at('width'),height:a.at('height')};}else if(TP.isArray(a)){b={x:a.at(0),y:a.at(1),width:a.at(2),height:a.at(3)};}else{b={x:a.x,y:a.y,width:a.width,height:a.height};}}else if(arguments.length===2){b={x:arguments[0].$get('data').x,y:arguments[0].$get('data').y,width:arguments[1].$get('data').x,height:arguments[1].$get('data').y};}else{b={x:c,y:d,width:e,height:f};}}else{b={x:0,y:0,width:0,height:0};}this.$set('data',b,false);return this;});TP.core.Rect.Inst.defineMethod('addByPoint',function(a){var b;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=this.$get('data');b.x+=a.get('x');b.y+=a.get('y');return this;});TP.core.Rect.Inst.defineMethod('addToX',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}this.$get('data').x+=a;return this;});TP.core.Rect.Inst.defineMethod('addToY',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}this.$get('data').y+=a;return this;});TP.core.Rect.Inst.defineMethod('asDumpString',function(){var a,c,b;a=this.$get('data');c=TP.join('(',a.x,', ',a.y,', ',a.width,', ',a.height,')');try{b=TP.tname(this)+' :: '+c;}catch(a){b=this.toString();}return b;});TP.core.Rect.Inst.defineMethod('asHTMLString',function(){var a,b;a=this.$get('data');try{b='<span class="TP_core_Rect">'+'<span data-name="x">'+a.x+'</span>'+'<span data-name="y">'+a.y+'</span>'+'<span data-name="width">'+a.width+'</span>'+'<span data-name="height">'+a.height+'</span>'+'</span>';}catch(a){b=this.toString();}return b;});TP.core.Rect.Inst.defineMethod('asJSONSource',function(){var a;a=this.$get('data');return'{"type":'+TP.tname(this).quoted('"')+','+'"data":{'+'"x":"'+a.x+'",'+'"y":"'+a.y+'",'+'"width":"'+a.width+'",'+'"height":"'+a.height+'"'+'}}';});TP.core.Rect.Inst.defineMethod('asPrettyString',function(){var a,b;a=this.$get('data');try{b='<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+'<dt class="pretty key">x</dt>'+'<dd class="pretty value">'+a.x+'</dd>'+'<dt class="pretty key">y</dt>'+'<dd class="pretty value">'+a.y+'</dd>'+'<dt class="pretty key">width</dt>'+'<dd class="pretty value">'+a.width+'</dd>'+'<dt class="pretty key">height</dt>'+'<dd class="pretty value">'+a.height+'</dd>'+'</dl>';}catch(a){b=this.toString();}return b;});TP.core.Rect.Inst.defineMethod('asSource',function(){var a;a=this.$get('data');return TP.join('TP.rtc(',a.x,', ',a.y,', ',a.width,', ',a.height,')');});TP.core.Rect.Inst.defineMethod('asString',function(c){var a,b;a=this.$get('data');b=TP.join('(',a.x,', ',a.y,', ',a.width,', ',a.height,')');return b;});TP.core.Rect.Inst.defineMethod('asXMLString',function(){var a,b;a=this.$get('data');try{b='<instance type="'+TP.tname(this)+'"'+' x="'+a.x+'" y="'+a.y+'"'+' width="'+a.width+'" height="'+a.height+'"'+'/>';}catch(a){b=this.toString();}return b;});TP.core.Rect.Inst.defineMethod('clampToRect',function(c){var b,a;a=this.$get('data');b=c.$get('data');a.x=a.x.max(b.x).min(b.width-a.width);a.y=a.y.max(b.y).min(b.height-a.height);return this;});TP.core.Rect.Inst.defineMethod('closestEdgePointFromPoint',function(c){var a,d,b;if(TP.notValid(c)){return this.raise('TP.sig.InvalidParameter',arguments);}a=this.$get('data');d=this.getCompassCorner(c,8);b=this.getCenterPoint();switch(d){case TP.NORTH:return TP.pc(b.get('x'),0);case TP.NORTHEAST:return TP.pc(a.x+a.width,0);case TP.EAST:return TP.pc(a.x+a.width,b.get('y'));case TP.SOUTHEAST:return TP.pc(a.x+a.width,a.y+a.height);case TP.SOUTH:return TP.pc(b.get('x'),a.y+a.height);case TP.SOUTHWEST:return TP.pc(0,a.y+a.height);case TP.WEST:return TP.pc(0,b.get('y'));case TP.NORTHWEST:default:return TP.pc(0,0);}return null;});TP.core.Rect.Inst.defineMethod('constrainPoint',function(c){var a,b;if(TP.notValid(c)){return this.raise('TP.sig.InvalidParameter',arguments);}a=this.$get('data');b=c.$get('data');b.x=b.x.max(a.x).min(a.x+a.width);b.y=b.y.max(a.y).min(a.y+a.height);return this;});TP.core.Rect.Inst.defineMethod('containsPoint',function(c){var a,b;if(TP.notValid(c)){return this.raise('TP.sig.InvalidParameter',arguments);}a=this.$get('data');b=c.$get('data');if(b.x>=a.x&&b.y>=a.y&&b.x<=a.x+a.width&&b.y<=a.y+a.height){return true;}return false;});TP.core.Rect.Inst.defineMethod('containsRect',function(c){var a,b;if(TP.notValid(c)){return this.raise('TP.sig.InvalidParameter',arguments);}a=this.$get('data');b=c.$get('data');if(b.x>=a.x&&a.x+a.width>=b.x+b.width&&b.y>=a.y&&a.y+a.height>=b.y+b.height){return true;}return false;});TP.core.Rect.Inst.defineMethod('copy',function(){return TP.core.Rect.construct(this);});TP.core.Rect.Inst.defineMethod('difference',function(k){var g,c,a,b,d,e,i,j,h,f;g=this.intersection(k);if(TP.notValid(g)||g.$get('data').width<=0||g.$get('data').height<=0){return TP.ac(this.copy());}a=this.$get('data');b=k.$get('data');c=TP.ac();d=a.y;e=a.height;i=a.x+a.width;j=a.y+a.height;h=b.x+b.width;f=b.y+b.height;if(b.y>a.y){c.push(TP.core.Rect.construct(a.x,a.y,a.width,b.y-a.y));d=b.y;e-=b.y-a.y;}if(f<j){c.push(TP.core.Rect.construct(a.x,f,a.width,j-f));e=f-d;}if(b.x>a.x){c.push(TP.core.Rect.construct(a.x,d,b.x-a.x,e));}if(h<i){c.push(TP.core.Rect.construct(h,d,i-h,e));}return c;});TP.core.Rect.Inst.defineMethod('empty',function(){var a;a=this.$get('data');a.x=0;a.y=0;a.width=0;a.height=0;return this;});TP.core.Rect.Inst.defineMethod('getCenterPoint',function(){var a;a=this.$get('data');return TP.core.Point.construct(a.x+a.width/2,a.y+a.height/2);});TP.core.Rect.Inst.defineMethod('getCompassCorner',function(a){var b,c;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=TP.computeAngleFromEnds(this.getCenterPoint(),a);c=TP.computeCompassCorner(b,8);return c;});TP.core.Rect.Inst.defineMethod('getHeight',function(){return this.$get('data').height;});TP.core.Rect.Inst.defineMethod('getWidth',function(){return this.$get('data').width;});TP.core.Rect.Inst.defineMethod('getX',function(){return this.$get('data').x;});TP.core.Rect.Inst.defineMethod('getY',function(){return this.$get('data').y;});TP.core.Rect.Inst.defineMethod('grow',function(b,c){var a;if(!TP.isNumber(b)||!TP.isNumber(c)){return this.raise('TP.sig.InvalidNumber',arguments);}a=this.$get('data');a.width+=b;a.height+=c;return this;});TP.core.Rect.Inst.defineMethod('growByPoint',function(a){var b;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=this.$get('data');b.width+=a.get('x');b.height+=a.get('y');return this;});TP.core.Rect.Inst.defineMethod('interpolate',function(e,a){var b,c,d;if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}b=this.$get('data');c=e.$get('data');d=function(a,b,c){return a+(b-a)*c;};return TP.core.Rect.construct(d(b.x,c.x,a),d(b.y,c.y,a),d(b.width,c.width,a),d(b.height,c.height,a));});TP.core.Rect.Inst.defineMethod('intersection',function(e){var a,b,c,d,f,g;if(this.isEmpty()){return TP.core.Rect.construct(e);}if(e.isEmpty()){return TP.core.Rect.construct(this);}a=this.$get('data');b=e.$get('data');c=a.x.max(b.x);f=(a.x+a.width).min(b.x+b.width);if(c<=f){d=a.y.max(b.y);g=(a.y+a.height).min(b.y+b.height);if(d<=g){return TP.core.Rect.construct(c,d,f-c,g-d);}}return null;});TP.core.Rect.Inst.defineMethod('intersects',function(c){var a,b;a=this.$get('data');b=c.$get('data');if(a.x<=b.x+b.width&&b.x<=a.x+a.width&&a.y<=b.y+b.height&&b.y<=a.y+a.height){return true;}return false;});TP.core.Rect.Inst.defineMethod('isEmpty',function(){return this.$get('data').width<=0||this.$get('data').height<=0;});TP.core.Rect.Inst.defineMethod('isOffsetFromCenterBy',function(b,c){var d,f,g,h,e,a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments);}d=this.getCenterPoint();f=b.distanceBetween(d);g=this.closestEdgePointFromPoint(b);h=g.distanceBetween(d);e=false;if(TP.isValid(c)&&!TP.isNaN(a=c.asNumber())){if(TP.regex.PERCENTAGE.test(c)){a=a*h;}e=f>=a;}return e;});TP.core.Rect.Inst.defineMethod('maxFittedPoint',function(c){var a,b,d,e;if(TP.notValid(c)){return this.raise('TP.sig.InvalidParameter',arguments);}a=this.$get('data');b=c.$get('data');d=b.width-a.width;e=b.height-a.height;return TP.pc(d,e);});TP.core.Rect.Inst.defineMethod('union',function(e){var a,b,c,d;if(this.isEmpty()){return TP.core.Rect.construct(e);}if(e.isEmpty()){return TP.core.Rect.construct(this);}a=this.$get('data');b=e.$get('data');c=a.x.min(b.x);d=a.y.min(b.y);return TP.core.Rect.construct(c,d,(a.x+a.width-c).max(b.x+b.width-c),(a.y+a.height-d).max(b.y+b.height-d));});TP.core.Rect.Inst.defineMethod('scale',function(b,e){var a,c,d;if(!TP.isNumber(b)){return this.raise('TP.sig.InvalidNumber',arguments);}a=this.$get('data');if(TP.isNumber(e)){c=a.width*b;d=a.height*e;}else{c=a.width*b;d=a.height*b;}return TP.core.Rect.construct(a.x-(c-a.width)/2,a.y-(d-a.height)/2,c,d);});TP.core.Rect.Inst.defineMethod('setHeight',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}this.$get('data').height=a;return this;});TP.core.Rect.Inst.defineMethod('setWidth',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}this.$get('data').width=a;return this;});TP.core.Rect.Inst.defineMethod('setX',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}this.$get('data').x=a;return this;});TP.core.Rect.Inst.defineMethod('setY',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}this.$get('data').y=a;return this;});TP.core.Rect.Inst.defineMethod('setXY',function(b,c){var a;if(!TP.isNumber(b)||!TP.isNumber(c)){return this.raise('TP.sig.InvalidNumber',arguments);}a=this.$get('data');a.x=b;a.y=c;return this;});TP.core.Rect.Inst.defineMethod('shrink',function(b,c){var a;if(!TP.isNumber(b)||!TP.isNumber(c)){return this.raise('TP.sig.InvalidNumber',arguments);}a=this.$get('data');a.width-=b;a.height-=c;return this;});TP.core.Rect.Inst.defineMethod('shrinkByPoint',function(a){var b;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=this.$get('data');b.width-=a.get('x');b.height-=a.get('y');return this;});TP.core.Rect.Inst.defineMethod('subtractByPoint',function(a){var b;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=this.$get('data');b.x-=a.get('x');b.y-=a.get('y');return this;});TP.core.Rect.Inst.defineMethod('subtractFromX',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}this.$get('data').x-=a;return this;});TP.core.Rect.Inst.defineMethod('subtractFromY',function(a){if(!TP.isNumber(a)){return this.raise('TP.sig.InvalidNumber',arguments);}this.$get('data').y-=a;return this;});TP.core.Rect.Inst.defineMethod('translate',function(b,c){var a;if(!TP.isNumber(b)||!TP.isNumber(c)){return this.raise('TP.sig.InvalidNumber',arguments);}a=this.$get('data');a.x+=b;a.y+=c;return this;});TP.core.Rect.Inst.defineMethod('translateByPoint',function(a){var b;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=this.$get('data');b.x+=a.get('x');b.y+=a.get('y');return this;});TP.lang.Object.defineSubtype('core:Matrix');TP.core.Matrix.Type.defineConstant('MATRIX_REGEX',TP.rc('matrix\\s*\\(\\s*([-.\\d]+)\\s*'+'(?:,\\s*)([-.\\d]+)\\s*'+'(?:,\\s*)([-.\\d]+)\\s*'+'(?:,\\s*)([-.\\d]+)\\s*'+'(?:,\\s*)([-.\\d]+)\\s*'+'(?:,\\s*)([-.\\d]+)\\s*\\)'));TP.core.Matrix.Type.defineConstant('ROTATE_REGEX',TP.rc('rotate\\s*\\(\\s*([-.\\d]+)\\s*\\)'));TP.core.Matrix.Type.defineConstant('SCALE_REGEX',TP.rc('scale\\s*\\(\\s*([-.\\d]+)\\s*'+'(?:,\\s*)?([-.\\d]+)?\\s*\\)'));TP.core.Matrix.Type.defineConstant('SKEWX_REGEX',TP.rc('skewX\\s*\\(\\s*([-.\\d]+)\\s*\\)'));TP.core.Matrix.Type.defineConstant('SKEWY_REGEX',TP.rc('skewY\\s*\\(\\s*([-.\\d]+)\\s*\\)'));TP.core.Matrix.Type.defineConstant('TRANSLATE_REGEX',TP.rc('translate\\s*\\(\\s*([-.\\d]+)\\s*'+'(?:,\\s*)?([-.\\d]+)?\\s*\\)'));TP.core.Matrix.Type.defineConstant('STYLE_DECLVALUE_PARSER',function(b){var d,a,e,c;d=null;if(/translate/.test(b)){a=TP.core.Matrix.TRANSLATE_REGEX.match(b);e=a.at(1);c=a.at(2);if(TP.notValid(c)){c=e;}d=TP.core.Matrix.constructTranslationMatrix(parseFloat(e),parseFloat(c));}else if(/scale/.test(b)){a=TP.core.Matrix.SCALE_REGEX.match(b);e=a.at(1);c=a.at(2);if(TP.notValid(c)){c=e;}d=TP.core.Matrix.constructScalingMatrix(parseFloat(e),parseFloat(c));}else if(/rotate/.test(b)){a=TP.core.Matrix.ROTATE_REGEX.match(b);d=TP.core.Matrix.constructRotationMatrix(parseFloat(a.at(1)));}else if(/skewX/.test(b)){a=TP.core.Matrix.SKEWX_REGEX.match(b);e=a.at(1);d=TP.core.Matrix.constructSkewXMatrix(parseFloat(e));}else if(/skewY/.test(b)){a=TP.core.Matrix.SKEWY_REGEX.match(b);c=a.at(1);d=TP.core.Matrix.constructSkewYMatrix(parseFloat(c));}else if(/matrix/.test(b)){a=TP.core.Matrix.MATRIX_REGEX.match(b);if(a.getSize()<7){d=null;}else{d=TP.core.Matrix.construct({xx:parseFloat(a.at(1)),yx:parseFloat(a.at(2)),xy:parseFloat(a.at(3)),yy:parseFloat(a.at(4)),dx:parseFloat(a.at(5)),dy:parseFloat(a.at(6))});}}return d;});TP.core.Matrix.addParser(TP.core.Matrix.STYLE_DECLVALUE_PARSER);TP.core.Matrix.Type.defineMethod('cloneIdentityData',function(){var a;a={xx:1,xy:0,yx:0,yy:1,dx:0,dy:0};return a;});TP.core.Matrix.Type.defineMethod('constructIdentityMatrix',function(){return TP.core.Matrix.construct();});TP.core.Matrix.Type.defineMethod('constructFlipXMatrix',function(){var a;a=TP.core.Matrix.construct();a.$get('data').xx=-1;return a;});TP.core.Matrix.Type.defineMethod('constructFlipYMatrix',function(){var a;a=TP.core.Matrix.construct();a.$get('data').yy=-1;return a;});TP.core.Matrix.Type.defineMethod('constructFlipXYMatrix',function(){var a;a=TP.core.Matrix.construct();a.$get('data').xx=-1;a.$get('data').yy=-1;return a;});TP.core.Matrix.Type.defineMethod('constructProjectionMatrix',function(d,j){var f,c,a,g,h,e,i,b;if(TP.notValid(d)){return this.raise('TP.sig.InvalidParameter',arguments);}f=TP.core.Matrix.construct();b=f.$get('data');if(arguments.length===1){c=d.get('data').x;a=d.get('data').y;}else{c=d;a=j;}g=c*c;h=a*a;e=g+h;i=c*a/e;b.xx=g/e;b.xy=i;b.yx=i;b.yy=h/e;return f;});TP.core.Matrix.Type.defineMethod('constructReflectionMatrix',function(d,j){var f,c,a,g,h,e,i,b;if(TP.notValid(d)){return this.raise('TP.sig.InvalidParameter',arguments);}f=TP.core.Matrix.construct();b=f.$get('data');if(arguments.length===1){c=d.get('data').x;a=d.get('data').y;}else{c=d;a=j;}g=c*c;h=a*a;e=g+h;i=2*c*a/e;b.xx=2*g/e-1;b.xy=i;b.yx=i;b.yy=2*h/e-1;return f;});TP.core.Matrix.Type.defineMethod('constructRotationMatrix',function(b){var c,a,d,e;if(!TP.isNumber(b)){return this.raise('TP.sig.InvalidNumber',arguments);}c=TP.core.Matrix.construct();a=c.$get('data');d=b.sin();e=b.cos();a.xx=e;a.yy=e;a.xy=-d;a.yx=d;return c;});TP.core.Matrix.Type.defineMethod('constructScalingMatrix',function(b,c){var a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments);}a=TP.core.Matrix.construct();if(arguments.length===1){a.$get('data').xx=b.get('data').x;a.$get('data').yy=b.get('data').y;}else{a.$get('data').xx=b;a.$get('data').yy=c;}return a;});TP.core.Matrix.Type.defineMethod('constructSkewXMatrix',function(b){var a;if(!TP.isNumber(b)){return this.raise('TP.sig.InvalidNumber',arguments);}a=TP.core.Matrix.construct();a.$get('data').xy=-b.tan();return a;});TP.core.Matrix.Type.defineMethod('constructSkewYMatrix',function(b){var a;if(!TP.isNumber(b)){return this.raise('TP.sig.InvalidNumber',arguments);}a=TP.core.Matrix.construct();a.$get('data').yx=b.tan();return a;});TP.core.Matrix.Type.defineMethod('constructTranslationMatrix',function(b,c){var a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments);}a=TP.core.Matrix.construct();if(arguments.length===1){a.$get('data').dx=b.get('data').x;a.$get('data').dy=b.get('data').y;}else{a.$get('data').dx=b;a.$get('data').dy=c;}return a;});TP.core.Matrix.Type.defineMethod('fromCSSString',function(a){return this.fromArray(TP.matrixFromCSSString(a,true));});TP.core.Matrix.Type.defineMethod('fromArray',function(a){var b,c;b={'xx':a[0][0],'xy':a[0][1],'yx':a[1][0],'yy':a[1][1],'dx':a[0][2],'dy':a[1][2]};c=this.construct(b);return c;});TP.core.Matrix.Type.defineMethod('rotateAt',function(a,b){var c;if(!TP.isNumber(a)||TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments);}c=TP.core.Matrix.constructRotationMatrix(a);return c.applyTransformsUsing(b);});TP.core.Matrix.Type.defineMethod('scaleAt',function(a,b,c){var d;if(TP.notValid(a)||!TP.isNumber(b)||!TP.isNumber(c)){return this.raise('TP.sig.InvalidParameter',arguments);}d=TP.core.Matrix.constructScalingMatrix(b,c);return d.applyTransformsUsing(a);});TP.core.Matrix.Type.defineMethod('skewXAt',function(a,b){var c;if(!TP.isNumber(a)||TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments);}c=TP.core.Matrix.constructSkewXMatrix(a);return c.applyTransformsUsing(b);});TP.core.Matrix.Type.defineMethod('skewYAt',function(a,b){var c;if(!TP.isNumber(a)||TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments);}c=TP.core.Matrix.constructSkewYMatrix(a);return c.applyTransformsUsing(b);});TP.core.Matrix.Type.defineMethod('translateBy',function(a,b,c){var d;if(!TP.isNumber(a)||!TP.isNumber(b)||TP.notValid(c)){return this.raise('TP.sig.InvalidParameter',arguments);}d=TP.core.Matrix.constructTranslationMatrix(a,b);return d.applyTransformsUsing(c);});TP.core.Matrix.Inst.defineAttribute('data');TP.core.Matrix.Inst.defineMethod('init',function(f){var a,d,c,b,e;this.callNextMethod();if(TP.notEmpty(arguments)){a=arguments[0];if(TP.isKindOf(a,TP.core.Matrix)){a=a.$get('data');a={xx:a.xx,xy:a.xy,yx:a.yx,yy:a.yy,dx:a.dx,dy:a.dy};}for(d=1;d<arguments.length;d++){c=a;b=arguments[d];if(TP.isKindOf(b,TP.core.Matrix)){b=b.$get('data');}a=TP.core.Matrix.cloneIdentityData();a.xx=c.xx*b.xx+c.xy*b.yx;a.xy=c.xx*b.xy+c.xy*b.yy;a.yx=c.yx*b.xx+c.yy*b.yx;a.yy=c.yx*b.xy+c.yy*b.yy;a.dx=c.xx*b.dx+c.xy*b.dy+c.dx;a.dy=c.yx*b.dx+c.yy*b.dy+c.dy;}e=a;}else{e=TP.core.Matrix.cloneIdentityData();}this.set('data',e);return this;});TP.core.Matrix.Inst.defineMethod('add',function(c){var a,b;a=this.$get('data');b=c.$get('data');a.xx+=b.xx;a.xy+=b.xy;a.yx+=b.yx;a.yy+=b.yy;a.dx+=b.dx;a.dy+=b.dy;return this;});TP.core.Matrix.Inst.defineMethod('applyTransformsUsing',function(b){var a,c,d,e;if(TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments);}a=b.get('data');c=TP.core.Matrix.constructTranslationMatrix(a.x,a.y);d=TP.core.Matrix.constructTranslationMatrix(-a.x,-a.y);e=c.multiply(this,d);return e;});TP.core.Matrix.Inst.defineMethod('asCSSTransformString',function(){var a;a=this.$get('data');return TP.join('matrix(',a.xx,',',a.yx,',',a.xy,',',a.yy,',',a.dx,',',a.dy,')');});TP.core.Matrix.Inst.defineMethod('asDumpString',function(){var a,c,b;a=this.$get('data');c=TP.join('{','xx: ',a.xx,', xy: ',a.xy,', yx: ',a.yx,', yy: ',a.yy,', dx: ',a.dx,', dy: ',a.dy,'}');try{b=TP.tname(this)+' :: '+c;}catch(a){b=this.toString();}return b;});TP.core.Matrix.Inst.defineMethod('asHTMLString',function(){var a,b;a=this.$get('data');try{b='<span class="TP_core_Matrix">'+'<span data-name="xx">'+a.xx+'</span>'+'<span data-name="xy">'+a.xy+'</span>'+'<span data-name="yx">'+a.yx+'</span>'+'<span data-name="yy">'+a.yy+'</span>'+'<span data-name="dx">'+a.dx+'</span>'+'<span data-name="dy">'+a.dy+'</span>'+'</span>';}catch(a){b=this.toString();}return b;});TP.core.Matrix.Inst.defineMethod('asJSONSource',function(){var a;a=this.$get('data');return'{"type":'+TP.tname(this).quoted('"')+','+'"data":{'+'"xx":"'+a.xx+'",'+'"xy":"'+a.xy+'",'+'"yx":"'+a.yx+'",'+'"yy":"'+a.yy+'",'+'"dx":"'+a.dx+'",'+'"dy":"'+a.dy+'"'+'}}';});TP.core.Matrix.Inst.defineMethod('asPrettyString',function(){var a,b;a=this.$get('data');try{b='<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+'<dt class="pretty key">xx</dt>'+'<dd class="pretty value">'+a.xx+'</dd>'+'<dt class="pretty key">xy</dt>'+'<dd class="pretty value">'+a.xy+'</dd>'+'<dt class="pretty key">yx</dt>'+'<dd class="pretty value">'+a.yx+'</dd>'+'<dt class="pretty key">yy</dt>'+'<dd class="pretty value">'+a.yy+'</dd>'+'<dt class="pretty key">dx</dt>'+'<dd class="pretty value">'+a.dx+'</dd>'+'<dt class="pretty key">dy</dt>'+'<dd class="pretty value">'+a.dy+'</dd>'+'</dl>';}catch(a){b=this.toString();}return b;});TP.core.Matrix.Inst.defineMethod('asSource',function(){var a,b;a=this.$get('data');b=TP.join('{','xx: ',a.xx,', xy: ',a.xy,', yx: ',a.yx,', yy: ',a.yy,', dx: ',a.dx,', dy: ',a.dy,'}');return'TP.core.Matrix.construct('+b+')';});TP.core.Matrix.Inst.defineMethod('asString',function(c){var a,b;a=this.$get('data');b=TP.join('{','xx: ',a.xx,', xy: ',a.xy,', yx: ',a.yx,', yy: ',a.yy,', dx: ',a.dx,', dy: ',a.dy,'}');return b;});TP.core.Matrix.Inst.defineMethod('asXMLString',function(){var a,b;a=this.$get('data');try{b='<instance type="'+TP.tname(this)+'"'+' xx="'+a.xx+'" xy="'+a.xy+'"'+' yx="'+a.yx+'" yy="'+a.yy+'"'+' dx="'+a.dx+'" dy="'+a.dy+'"'+'/>';}catch(a){b=this.toString();}return b;});TP.core.Matrix.Inst.defineMethod('copy',function(){return TP.core.Matrix.construct(this);});TP.core.Matrix.Inst.defineMethod('invert',function(){var a,b;a=this.$get('data');b=a.xx*a.yy-a.xy*a.yx;a.xx=a.yy/b;a.xy=-a.xy/b;a.yx=-a.yx/b;a.yy=a.xx/b;a.dx=(a.xy*a.dy-a.yy*a.dx)/b;a.dy=(a.yx*a.dx-a.xx*a.dy)/b;return this;});TP.core.Matrix.Inst.defineMethod('multiply',function(){var c,d,a,b;c=this.$get('data');for(d=0;d<arguments.length;d++){a=c;b=arguments[d].$get('data');c=TP.core.Matrix.cloneIdentityData();c.xx=a.xx*b.xx+a.xy*b.yx;c.xy=a.xx*b.xy+a.xy*b.yy;c.yx=a.yx*b.xx+a.yy*b.yx;c.yy=a.yx*b.xy+a.yy*b.yy;c.dx=a.xx*b.dx+a.xy*b.dy+a.dx;c.dy=a.yx*b.dx+a.yy*b.dy+a.dy;}this.$set('data',c);return this;});TP.core.Matrix.Inst.defineMethod('rotate',function(b){var a,c,d;if(!TP.isNumber(b)){return this.raise('TP.sig.InvalidNumber',arguments);}a=this.$get('data');c=b.sin();d=b.cos();a.xx=d;a.yy=d;a.xy=-c;a.yx=c;return this;});TP.core.Matrix.Inst.defineMethod('scale',function(b,c){var a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments);}a=this.$get('data');if(arguments.length===1){a.xx=b.get('x');a.yy=b.get('y');}else{a.xx=b;a.yy=c;}return this;});TP.core.Matrix.Inst.defineMethod('subtract',function(c){var a,b;a=this.$get('data');b=c.$get('data');a.xx-=b.xx;a.xy-=b.xy;a.yx-=b.yx;a.yy-=b.yy;a.dx-=b.dx;a.dy-=b.dy;return this;});TP.core.Matrix.Inst.defineMethod('transformPoint',function(c){var a,b,d;if(TP.notValid(c)){return this.raise('TP.sig.InvalidParameter',arguments);}a=this.$get('data');b=c.$get('data');d=TP.core.Point.construct(a.xx*b.x+a.xy*b.y+a.dx,a.yx*b.x+a.yy*b.y+a.dy);return d;});TP.core.Matrix.Inst.defineMethod('transformRect',function(c){var a,b,d;if(TP.notValid(c)){return this.raise('TP.sig.InvalidParameter',arguments);}a=this.$get('data');b=c.$get('data');d=TP.core.Rect.construct(a.xx*b.x+a.xy*b.y+a.dx,a.yx*b.x+a.yy*b.y+a.dy,a.xx*b.width+a.xy*b.height,a.yx*b.width+a.yy*b.height);return d;});TP.core.Matrix.Inst.defineMethod('translate',function(b,c){var a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments);}a=this.$get('data');if(arguments.length===1){a.dx=b.get('x');a.dy=b.get('y');}else{a.dx=b;a.dy=c;}return this;});TP.core.Matrix.Inst.defineMethod('transpose',function(){var a,b;a=this.$get('data');b={xx:a.xx,xy:a.yx,yx:a.xy,yy:a.yy,dx:0,dy:0};this.$set('data',b);return this;});TP.lang.Object.defineSubtype('core:Color');TP.definePrimitive('cc',function(a,b,c,d){return TP.core.Color.construct.apply(TP.core.Color,arguments);});TP.core.Color.Type.defineMethod('fromString',function(b){var a;a=this.construct(b);return a;});TP.core.Color.Type.defineMethod('fromArray',function(b){var a;a=this.construct(b);return a;});TP.core.Color.Inst.defineAttribute('data');TP.core.Color.Inst.defineMethod('init',function(c,d,e,f){var a,b;this.callNextMethod();if(TP.notEmpty(arguments)){if(arguments.length<=2){a=arguments[0];if(TP.isKindOf(a,TP.core.Color)){a=a.$get('data');b={r:a.r,g:a.g,b:a.b,a:a.a};}else if(TP.isString(a)){if(TP.notValid(a=TP.convertColorStringToArray(a))){return;}b={r:a.at(0),g:a.at(1),b:a.at(2),a:TP.ifInvalid(a.at(3),1).min(1).max(0)};}else if(TP.isArray(a)){b={r:a.at(0).min(255).max(0),g:a.at(1).min(255).max(0),b:a.at(2).min(255).max(0),a:TP.ifInvalid(a.at(3),1).min(1).max(0)};}else{b={r:a.r,g:a.g,b:a.b,a:a.a};}if(arguments.length===2){b.a=arguments[1].min(1).max(0);}}else{b={r:c.min(255).max(0),g:d.min(255).max(0),b:e.min(255).max(0),a:TP.ifInvalid(f,1).min(1).max(0)};}}else{b={r:0,g:0,b:0,a:0};}this.$set('data',b,false);return this;});TP.core.Color.Inst.defineMethod('add',function(c){var a,b;a=this.$get('data');b=c.$get('data');a.r=(a.r+b.r).min(255).max(0);a.g=(a.g+b.g).min(255).max(0);a.b=(a.b+b.b).min(255).max(0);a.a=a.a+b.a;return this;});TP.core.Color.Inst.defineMethod('asArray',function(){var a;if(TP.notValid(a=this.$get('data'))){return null;}return TP.ac(a.r,a.g,a.b,a.a);});TP.core.Color.Inst.defineMethod('asDumpString',function(){var b,a;b=this.asRGBAString();try{a=TP.tname(this)+' :: '+b;}catch(b){a=this.toString();}return a;});TP.core.Color.Inst.defineMethod('asHTMLString',function(){var a,b;a=this.$get('data');try{b='<span class="TP_core_Color">'+'<span data-name="r">'+a.r+'</span>'+'<span data-name="g">'+a.g+'</span>'+'<span data-name="b">'+a.b+'</span>'+'<span data-name="a">'+a.a+'</span>'+'</span>';}catch(a){b=this.toString();}return b;});TP.core.Color.Inst.defineMethod('asJSONSource',function(){var a;a=this.$get('data');return'{"type":'+TP.tname(this).quoted('"')+','+'"data":{'+'"r":"'+a.r+'",'+'"g":"'+a.g+'",'+'"b":"'+a.b+'",'+'"a":"'+a.a+'"'+'}}';});TP.core.Color.Inst.defineMethod('asRGBString',function(){var a;if(TP.notValid(a=this.asArray())){return null;}return'rgb('+a.slice(0,3).asString()+')';});TP.core.Color.Inst.defineMethod('asRGBAString',function(){var a;if(TP.notValid(a=this.asArray())){return null;}return'rgba('+a.asString()+')';});TP.core.Color.Inst.defineMethod('asHexString',function(){return TP.convertColorStringToHex(this.asRGBString());});TP.core.Color.Inst.defineMethod('asSource',function(){return'TP.core.Color.from(\''+this.asRGBAString()+'\')';});TP.core.Color.Inst.defineMethod('asString',function(a){return this.asRGBAString();});TP.core.Color.Inst.defineMethod('asPrettyString',function(){var a,b;a=this.$get('data');try{b='<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+'<dt class="pretty key">R</dt>'+'<dd class="pretty value">'+a.r+'</dd>'+'<dt class="pretty key">G</dt>'+'<dd class="pretty value">'+a.g+'</dd>'+'<dt class="pretty key">B</dt>'+'<dd class="pretty value">'+a.b+'</dd>'+'<dt class="pretty key">A</dt>'+'<dd class="pretty value">'+a.a+'</dd>'+'</dl>';}catch(a){b=this.toString();}return b;});TP.core.Color.Inst.defineMethod('asXMLString',function(){var a,b;a=this.$get('data');try{b='<instance type="'+TP.tname(this)+'"'+' r="'+a.r+'" g="'+a.g+'"'+' b="'+a.b+'" a="'+a.a+'"'+'/>';}catch(a){b=this.toString();}return b;});TP.core.Color.Inst.defineMethod('blendToColor',function(f,b){var a,c,d,e;if(TP.notValid(b)){a=0;}else{a=b.min(1).max(0);}d=TP.convertColorStringToLongNumber(this.asHexString());e=TP.convertColorStringToLongNumber(f.asHexString());c=TP.convertLongNumberToColorString(TP.interpolateColors(d,e,a));return TP.core.Color.construct(c);});TP.core.Color.Inst.defineMethod('copy',function(){return TP.core.Color.construct(this);});TP.core.Color.Inst.defineMethod('getAlpha',function(){return this.$get('data').a;});TP.core.Color.Inst.defineMethod('getBlue',function(){return this.$get('data').b;});TP.core.Color.Inst.defineMethod('getGreen',function(){return this.$get('data').g;});TP.core.Color.Inst.defineMethod('getRed',function(){return this.$get('data').r;});TP.core.Color.Inst.defineMethod('subtract',function(c){var a,b;a=this.$get('data');b=c.$get('data');a.r=(a.r-b.r).min(255).max(0);a.g=(a.g-b.g).min(255).max(0);a.b=(a.b-b.b).min(255).max(0);a.a=a.a-b.a;return this;});TP.lang.Object.defineSubtype('core:Gradient');TP.core.Gradient.isAbstract(true);TP.core.Gradient.Type.defineConstant('GRADIENT_LINEAR_REGEX',TP.rc('gradient-linear\\(\\s*(\\d+deg\\s*,)?\\s*(.+)\\s*\\)'));TP.core.Gradient.Type.defineConstant('GRADIENT_RADIAL_REGEX',TP.rc('gradient-radial\\(\\s*(?:(\\S+? \\S+?)\\s*,){1}\\s*(.+)\\s*\\)'));TP.core.Gradient.Type.defineConstant('STYLE_DECLVALUE_PARSER',function(c){var a,d,e,f,g,h,b;a=null;if(/gradient-linear/.test(c)){f=TP.core.Gradient.GRADIENT_LINEAR_REGEX.exec(c);if(TP.notValid(f)){return null;}if(TP.isEmpty(d=f.at(2))){return null;}e=TP.core.Gradient.$extractColorsAndStops(d);a=TP.core.LinearGradient.construct.apply(TP.core.LinearGradient,e);if(TP.notEmpty(g=f.at(1))&&!TP.isNaN(g=parseFloat(g))){a.set('angle',g);}}else if(/gradient-radial/.test(c)){h=TP.core.Gradient.GRADIENT_RADIAL_REGEX.exec(c);if(TP.notValid(h)){return null;}if(TP.isEmpty(b=h.at(1))){return null;}if(TP.isEmpty(d=h.at(2))){return null;}e=TP.core.Gradient.$extractColorsAndStops(d);a=TP.core.RadialGradient.construct.apply(TP.core.RadialGradient,e);b=b.split(' ');a.set('cx',b.first());a.set('fx',b.first());a.set('cy',b.last());a.set('fy',b.last());}return a;});TP.core.Gradient.addParser(TP.core.Gradient.STYLE_DECLVALUE_PARSER);TP.core.Gradient.Type.defineMethod('$extractColorsAndStops',function(c){var b,d,a;if(!TP.isString(c)){return this.raise('TP.sig.InvalidParameter',arguments);}b=TP.ac();d=0;a=c.replace(TP.regex.CSS_COLOR_GLOBAL,function(a){b.push(a.trim());return a.replace(/(\s*)(.+)(\s*)/,'$1_'+d++ +'_$3 ');});a=a.trim();a=a.split(/,* /);a=a.collect(function(a){if(/_\d+_/.test(a)){return b.at(parseInt(a.slice(1,-1),10));}return a;});return a;});TP.core.Gradient.Type.defineMethod('constructShadowGradient',function(a,b){var c,d;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!TP.isNumber(b)){return this.raise('TP.sig.InvalidNumber',arguments);}c=(b+0.1).min(1);d=this.construct(0,TP.core.Color.construct(a,c),0.25,TP.core.Color.construct(a,b),1,TP.core.Color.construct(a,0));return d;});TP.core.Gradient.Inst.defineAttribute('colors');TP.core.Gradient.Inst.defineAttribute('stops');TP.core.Gradient.Inst.defineMethod('init',function(){var b,c,a;this.callNextMethod();b=TP.ac();c=TP.ac();if(TP.notEmpty(arguments)){for(a=0;a<arguments.length;a+=2){c.push(arguments[a]);b.push(TP.core.Color.construct(arguments[a+1]));}}this.set('colors',b);this.set('stops',c);return this;});TP.core.Gradient.Inst.defineMethod('addColorStop',function(c,a){var b;if(!TP.isString(c)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}this.get('stops').push(c);if(!TP.isKindOf(b=a,TP.core.Color)){b=TP.core.Color.construct(a);}this.get('colors').push(b);return this;});TP.core.Gradient.Inst.defineMethod('asSource',function(){return'TP.core.Gradient.from(\''+this.asString()+'\')';});TP.core.Gradient.Inst.defineMethod('copy',function(){var a;a=this.construct();a.set('colors',this.get('colors').copy());a.set('stops',this.get('stops').copy());return a;});TP.core.Gradient.Inst.defineMethod('normalizeGradientValues',function(){var c,b,d,a,e;c=this.get('colors');b=this.get('stops');d=c;if(TP.isEmpty(a=b)){e=d.getSize()-1;a=1..to(e).collect(function(a){return a/e;});a.unshift(0);}else{if(b.getSize()!==c.getSize()){return;}a=b.collect(function(a){if(/%/.test(a)){return parseFloat(a)/100;}return a;});}this.set('colors',d);this.set('stops',a);return this;});TP.core.Gradient.defineSubtype('LinearGradient');TP.core.LinearGradient.Inst.defineAttribute('angle');TP.core.LinearGradient.Inst.defineAttribute('x1');TP.core.LinearGradient.Inst.defineAttribute('y1');TP.core.LinearGradient.Inst.defineAttribute('x2');TP.core.LinearGradient.Inst.defineAttribute('y2');TP.core.LinearGradient.Inst.defineMethod('init',function(){this.callNextMethod();this.set('angle',TP.HORIZONTAL);return this;});TP.core.LinearGradient.Inst.defineMethod('asDumpString',function(){var a,c,b;a=TP.ac('gradient-linear(');if(this.get('angle')!==90){a.push(this.get('angle'),', ');}if(TP.notEmpty(this.get('stops'))){this.get('stops').performWith(function(b,c){a.push(b,' ',c.asString(),' ');},this.get('colors'));a.pop();}a.push(')');c=a.join('');try{b=TP.tname(this)+' :: '+c;}catch(a){b=this.toString();}return b;});TP.core.LinearGradient.Inst.defineMethod('asGeckoCSSString',function(){var a;a=TP.ac('-moz-linear-gradient(');a.push(this.get('angle'),'deg, ');this.get('stops').performWith(function(b,c){a.push(c.asString(),' ',b*100,'%',', ');},this.get('colors'));a.pop();a.push(')');return a.join('');});TP.core.LinearGradient.Inst.defineMethod('asHTMLString',function(){var a;try{a='<span class="TP_core_LinearGradient">'+'<span data-name="angle">'+this.get('angle')+'</span>';if(TP.notEmpty(this.get('stops'))){this.get('stops').performWith(function(b,c){a+='<span data-name="stop">'+'<span data-name="value">'+b+'</span>'+'<span data-name="color">'+TP.htmlstr(c)+'</span>'+'</span>';},this.get('colors'));}a+='</span>';}catch(b){a=this.toString();}return a;});TP.core.LinearGradient.Inst.defineMethod('asJSONSource',function(){var a;a='';if(TP.notEmpty(this.get('stops'))){this.get('stops').performWith(function(b,c){a+='{'+'"value":"'+b+'",'+'"color":'+TP.json(c)+'},';},this.get('colors'));a=a.slice(0,a.getSize()-1);}return'{"type":'+TP.tname(this).quoted('"')+','+'"data":{'+'"angle":"'+this.get('angle')+'",'+'"stops":['+a+']'+'}}';});TP.core.LinearGradient.Inst.defineMethod('asPrettyString',function(){var a;try{a='<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+'<dt class="pretty key">angle</dt>'+'<dd class="pretty value">'+this.get('angle')+'</dd>';if(TP.notEmpty(this.get('stops'))){this.get('stops').performWith(function(b,c){a+='<dt class="pretty key">stop</dt>'+'<dd class="pretty value">'+'<dl>'+'<dt class="pretty key">value</dt>'+'<dd class="pretty value">'+b+'</dd>'+'<dt class="pretty key">color</dt>'+'<dd class="pretty value">'+TP.pretty(c)+'</dd>'+'</dl>'+'</dd>';},this.get('colors'));}a+='</dl>';}catch(b){a=this.toString();}return a;});TP.core.LinearGradient.Inst.defineMethod('asString',function(c){var a,b;a=TP.ac('gradient-linear(');if(this.get('angle')!==90){a.push(this.get('angle'),', ');}if(TP.notEmpty(this.get('stops'))){this.get('stops').performWith(function(b,c){a.push(b,' ',c.asString(),' ');},this.get('colors'));a.pop();}a.push(')');b=a.join('');return b;});TP.core.LinearGradient.Inst.defineMethod('asWebkitCSSString',function(){var a;a=TP.ac('-webkit-gradient(linear ');a.push(this.get('x1'),' ',this.get('y1'),', ',this.get('x2'),' ',this.get('y2'),', ');this.get('stops').performWith(function(b,c){a.push('color-stop(',b,', ',c.asString(),')',', ');},this.get('colors'));a.pop();a.push(')');return a.join('');});TP.core.LinearGradient.Inst.defineMethod('asXMLString',function(){var a;try{a='<instance type="'+TP.tname(this)+'"'+' angle="'+this.get('angle')+'">';if(TP.notEmpty(this.get('stops'))){this.get('stops').performWith(function(b,c){a+='<stop>'+'<value>'+b+'</value>'+'<color>'+TP.xmlstr(c)+'</color>'+'</stop>';},this.get('colors'));}a+='</instance>';}catch(b){a=this.toString();}return a;});TP.core.LinearGradient.Inst.defineMethod('setAngle',function(f){var e,a,b,c,d;if(f===TP.HORIZONTAL){e=90;}else if(f===TP.VERTICAL){e=0;}else{e=f;}if(!TP.isNumber(e)){return this.raise('TP.sig.InvalidNumber',arguments);}switch(e){case 0:a='0%';b='0%';c='100%';d='0%';break;case 45:a='0%';b='0%';c='100%';d='100%';break;case 90:a='0%';b='0%';c='0%';d='100%';break;case 135:a='100%';b='0%';c='0%';d='100%';break;case 180:a='100%';b='0%';c='0%';d='0%';break;case 225:a='100%';b='100%';c='0%';d='0%';break;case 270:a='0%';b='100%';c='0%';d='0%';break;case 315:a='0%';b='100%';c='100%';d='0%';break;default:break;}this.$set('angle',e);this.set('x1',a);this.set('y1',b);this.set('x2',c);this.set('y2',d);return this;});TP.core.Gradient.defineSubtype('RadialGradient');TP.core.RadialGradient.Inst.defineAttribute('cx');TP.core.RadialGradient.Inst.defineAttribute('cy');TP.core.RadialGradient.Inst.defineAttribute('radius');TP.core.RadialGradient.Inst.defineAttribute('fx');TP.core.RadialGradient.Inst.defineAttribute('fy');TP.core.RadialGradient.Inst.defineMethod('init',function(){this.callNextMethod();this.set('cx','50%');this.set('cy','50%');this.set('radius','50%');this.set('fx','50%');this.set('fy','50%');return this;});TP.core.RadialGradient.Inst.defineMethod('asDumpString',function(){var a,c,b;a=TP.ac('gradient-radial(');a.push(this.get('cx'),' ',this.get('cy'));if(TP.notEmpty(this.get('stops'))){a.push(', ');this.get('stops').performWith(function(b,c){a.push(b,' ',c.asString(),' ');},this.get('colors'));a.pop();}a.push(')');c=a.join('');try{b=TP.tname(this)+' :: '+c;}catch(a){b=this.toString();}return b;});TP.core.RadialGradient.Inst.defineMethod('asJSONSource',function(){var a;a='';if(TP.notEmpty(this.get('stops'))){this.get('stops').performWith(function(b,c){a+='{'+'"value":"'+b+'",'+'"color":'+TP.json(c)+'},';},this.get('colors'));a=a.slice(0,a.getSize()-1);}return'{"type":'+TP.tname(this).quoted('"')+','+'"data":{'+'"cx":"'+this.get('cx')+'",'+'"cy":"'+this.get('cy')+'",'+'"stops":['+a+']'+'}}';});TP.core.RadialGradient.Inst.defineMethod('asHTMLString',function(){var a;try{a='<span class="TP_core_RadialGradient">'+'<span data-name="cx">'+this.get('cx')+'</span>'+'<span data-name="cy">'+this.get('cy')+'</span>';if(TP.notEmpty(this.get('stops'))){this.get('stops').performWith(function(b,c){a+='<span data-name="stop">'+'<span data-name="value">'+b+'</span>'+'<span data-name="color">'+TP.htmlstr(c)+'</span>'+'</span>';},this.get('colors'));}a+='</span>';}catch(b){a=this.toString();}return a;});TP.core.RadialGradient.Inst.defineMethod('asGeckoCSSString',function(){return TP.todo();});TP.core.RadialGradient.Inst.defineMethod('asPrettyString',function(){var a;try{a='<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+'<dt class="pretty key">cx</dt>'+'<dd class="pretty value">'+this.get('cx')+'</dd>'+'<dt class="pretty key">cy</dt>'+'<dd class="pretty value">'+this.get('cy')+'</dd>';if(TP.notEmpty(this.get('stops'))){this.get('stops').performWith(function(b,c){a+='<dt class="pretty key">stop</dt>'+'<dd class="pretty value">'+'<dl>'+'<dt class="pretty key">value</dt>'+'<dd class="pretty value">'+b+'</dd>'+'<dt class="pretty key">color</dt>'+'<dd class="pretty value">'+TP.pretty(c)+'</dd>'+'</dl>'+'</dd>';},this.get('colors'));}a+='</dl>';}catch(b){a=this.toString();}return a;});TP.core.RadialGradient.Inst.defineMethod('asString',function(c){var a,b;a=TP.ac('gradient-radial(');a.push(this.get('cx'),' ',this.get('cy'));if(TP.notEmpty(this.get('stops'))){a.push(', ');this.get('stops').performWith(function(b,c){a.push(b,' ',c.asString(),' ');},this.get('colors'));a.pop();}a.push(')');b=a.join('');return b;});TP.core.RadialGradient.Inst.defineMethod('asWebkitCSSString',function(){return TP.todo();});TP.core.RadialGradient.Inst.defineMethod('asXMLString',function(){var a;try{a='<instance type="'+TP.tname(this)+'"'+' cx="'+this.get('cx')+'"'+' cy="'+this.get('cy')+'">';if(TP.notEmpty(this.get('stops'))){this.get('stops').performWith(function(b,c){a+='<stop>'+'<value>'+b+'</value>'+'<color>'+TP.xmlstr(c)+'</color>'+'</stop>';},this.get('colors'));}a+='</instance>';}catch(b){a=this.toString();}return a;});TP.lang.Object.defineSubtype('core:Pattern');TP.core.Pattern.Type.defineConstant('PATTERN_REGEX',TP.rc('pattern\\(url\\((.+?)\\)\\s*,\\s*(.+?)\\s*,\\s*(.+?)\\s*,\\s*(.+?)\\s*,\\s*(.+?)\\s*\\)'));TP.core.Pattern.Type.defineConstant('STYLE_DECLVALUE_PARSER',function(h){var a,b,c,d,e,f,g;a=null;if(TP.isArray(b=TP.core.Pattern.PATTERN_REGEX.exec(h))){if(TP.notEmpty(c=b.at(1))){c=c.stripEnclosingQuotes();}d=b.at(2);e=b.at(3);f=b.at(4);g=b.at(5);if(TP.isEmpty(c)||TP.isEmpty(d)||TP.isEmpty(e)||TP.isEmpty(f)||TP.isEmpty(g)){return null;}a=TP.core.Pattern.construct();a.set('uri',TP.uc(c));a.set('x',d);a.set('y',e);a.set('width',f);a.set('height',g);}return a;});TP.core.Pattern.addParser(TP.core.Pattern.STYLE_DECLVALUE_PARSER);TP.core.Pattern.Inst.defineAttribute('uri');TP.core.Pattern.Inst.defineAttribute('x');TP.core.Pattern.Inst.defineAttribute('y');TP.core.Pattern.Inst.defineAttribute('width');TP.core.Pattern.Inst.defineAttribute('height');TP.core.Pattern.Inst.defineMethod('asDumpString',function(){var a,c,b;a=TP.ac('pattern(');a.push('url(',this.get('uri'),'), ',this.get('x'),', ',this.get('y'),', ',this.get('width'),', ',this.get('height'));a.push(')');c=a.join('');try{b=TP.tname(this)+' :: '+c;}catch(a){b=this.toString();}return b;});TP.core.Pattern.Inst.defineMethod('asHTMLString',function(){var a;try{a='<span class="TP_core_Pattern">'+'<span data-name="x">'+this.get('x')+'</span>'+'<span data-name="y">'+this.get('y')+'</span>'+'<span data-name="width">'+this.get('width')+'</span>'+'<span data-name="height">'+this.get('height')+'</span>'+'<span data-name="url">'+this.get('url')+'</span>'+'</span>';}catch(b){a=this.toString();}return a;});TP.core.Pattern.Inst.defineMethod('asJSONSource',function(){return'{"type":'+TP.tname(this).quoted('"')+','+'"data":{'+'"x":"'+this.get('x')+'",'+'"y":"'+this.get('y')+'",'+'"width":"'+this.get('width')+'",'+'"height":"'+this.get('height')+'",'+'"url":"'+this.get('uri')+'"'+'}}';});TP.core.Pattern.Inst.defineMethod('asPrettyString',function(){var b,a;b=this.$get('data');try{a='<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+'<dt class="pretty key">x</dt>'+'<dd class="pretty value">'+this.get('x')+'</dd>'+'<dt class="pretty key">y</dt>'+'<dd class="pretty value">'+this.get('y')+'</dd>'+'<dt class="pretty key">width</dt>'+'<dd class="pretty value">'+this.get('width')+'</dd>'+'<dt class="pretty key">height</dt>'+'<dd class="pretty value">'+this.get('height')+'</dd>'+'<dt class="pretty key">url</dt>'+'<dd class="pretty value">'+this.get('uri')+'</dd>'+'</dl>';}catch(b){a=this.toString();}return a;});TP.core.Pattern.Inst.defineMethod('asSource',function(){return'TP.core.Pattern.from(\''+this.asString()+'\')';});TP.core.Pattern.Inst.defineMethod('asString',function(c){var a,b;a=TP.ac('pattern(');a.push('url(',this.get('uri'),'), ',this.get('x'),', ',this.get('y'),', ',this.get('width'),', ',this.get('height'));a.push(')');b=a.join('');return b;});TP.core.Pattern.Inst.defineMethod('asXMLString',function(){var a;try{a='<instance type="'+TP.tname(this)+'"'+' x="'+this.get('x')+'" y="'+this.get('y')+'"'+' width="'+this.get('width')+'" height="'+this.get('height')+'"'+'>';a+='<url>'+TP.xmlstr(this.get('uri'))+'</url>';a+='</instance>';}catch(b){a=this.toString();}return a;});TP.core.Pattern.Inst.defineMethod('copy',function(){var a;a=TP.core.Pattern.construct();a.set('uri',TP.uc(this.get('uri')));a.set('x',this.get('x'));a.set('y',this.get('y'));a.set('width',this.get('width'));a.set('height',this.get('height'));return a;});TP.core.Pattern.Inst.defineMethod('getURI',function(){return this.$get('uri').getLocation();});TP.lang.Object.defineSubtype('core:Path');TP.core.Path.Type.defineConstant('MOVE_TO_ABS',0);TP.core.Path.Type.defineConstant('LINE_TO_ABS',1);TP.core.Path.Type.defineConstant('HORIZ_LINE_TO_ABS',2);TP.core.Path.Type.defineConstant('VERT_LINE_TO_ABS',3);TP.core.Path.Type.defineConstant('CURVE_TO_ABS',4);TP.core.Path.Type.defineConstant('SMOOTH_CURVE_TO_ABS',5);TP.core.Path.Type.defineConstant('QUAD_CURVE_TO_ABS',6);TP.core.Path.Type.defineConstant('QUAD_SMOOTH_CURVE_TO_ABS',7);TP.core.Path.Type.defineConstant('ARC_TO_ABS',8);TP.core.Path.Type.defineConstant('CLOSE_PATH_ABS',9);TP.core.Path.Type.defineConstant('MOVE_TO_REL',10);TP.core.Path.Type.defineConstant('LINE_TO_REL',11);TP.core.Path.Type.defineConstant('HORIZ_LINE_TO_REL',12);TP.core.Path.Type.defineConstant('VERT_LINE_TO_REL',13);TP.core.Path.Type.defineConstant('CURVE_TO_REL',14);TP.core.Path.Type.defineConstant('SMOOTH_CURVE_TO_REL',15);TP.core.Path.Type.defineConstant('QUAD_CURVE_TO_REL',16);TP.core.Path.Type.defineConstant('QUAD_SMOOTH_CURVE_TO_REL',17);TP.core.Path.Type.defineConstant('ARC_TO_REL',18);TP.core.Path.Type.defineConstant('CLOSE_PATH_REL',19);TP.core.Path.Type.defineConstant('SEGMENT_INFO',TP.hc());TP.core.Path.Type.defineConstant('PATH_SPLITUP_REGEX',TP.rc('.+','g'));TP.core.Path.Inst.defineAttribute('pathSegments');TP.core.Path.Inst.defineMethod('init',function(){this.set('pathSegments',TP.ac());return this;});TP.core.Path.Inst.defineMethod('addSegment',function(e,f){var a,c,d,b;if(TP.isValid(a=this.getType().at('SEGMENT_INFO').at(e))){c=a.first();d=a.last();b=this.operandsAsNumbers(f);if(b.getSize()!==d){return this;}this.get('pathSegments').push(c,b);}return this;});TP.core.Path.Inst.defineMethod('operandsAsNumbers',function(d){var c,b,a;b=TP.ac();for(c=0;c<d.getSize();c++){a=d.at(c);if(TP.isNumber(a)){b.push(a);}else if(TP.isBoolean(a)){if(a){b.push(1);}else{b.push(0);}}else if(TP.isArray(a)){b.addAll(this.operandsAsNumbers(a));}else if(a.getType()===TP.core.Point){b.push(a.get('x'),a.get('y'));}}return b;});TP.core.Path.Inst.defineMethod('deleteSegment',function(d,e){var b,c,a;if(TP.isValid(b=this.getType().at('SEGMENT_INFO').at(d))){c=b.first();a=this.getSegmentIndex(c,e);if(a>-1){this.get('pathSegments').splice(a,2);}}return this;});TP.core.Path.Inst.defineMethod('asDumpString',function(){var b,a;b=this.get('pathSegments').join(' ');try{a=TP.tname(this)+' :: '+b;}catch(b){a=this.toString();}return a;});TP.core.Path.Inst.defineMethod('asHTMLString',function(){return'<span class="TP_core_Pattern">'+TP.htmlstr(this.get('pathSegments'))+'</span>';});TP.core.Path.Inst.defineMethod('asJSONSource',function(){return'{"type":'+TP.tname(this).quoted('"')+','+'"data":{'+'"segments":'+TP.json(this.get('pathSegments'))+'}}';});TP.core.Path.Inst.defineMethod('asPrettyString',function(){return'<dl class="pretty '+TP.escapeTypeName(TP.tname(this))+'">'+'<dt>Type name</dt>'+'<dd class="pretty typename">'+this.getTypeName()+'</dd>'+'<dt class="pretty key">Segments</dt>'+'<dd class="pretty value">'+TP.pretty(this.asString())+'</dd>'+'</dl>';});TP.core.Path.Inst.defineMethod('asString',function(b){var a;a=this.get('pathSegments').join(' ');return a;});TP.core.Path.Inst.defineMethod('asXMLString',function(){return'<instance type="'+TP.tname(this)+'">'+TP.xmlstr(this.asString())+'</instance>';});TP.core.Path.Inst.defineMethod('getSegment',function(e,f){var c,d,a,b;if(TP.isValid(c=this.getType().at('SEGMENT_INFO').at(e))){d=c.first();a=this.getSegmentIndex(d,f);if(a>-1){b=this.get('pathSegments');return TP.ac(b.at(a),b.at(a+1));}}return null;});TP.core.Path.Inst.defineMethod('getSegmentIndex',function(e,f){var b,d,c,a;b=this.get('pathSegments');d=TP.ifInvalid(f,1);c=0;for(a=0;a<b.getSize();a+=2){if(b.at(a)===e){c++;if(c===d){return a;}}}return-1;});TP.core.Path.Inst.defineMethod('insertSegment',function(l,h,i,j){var a,d,e,f,b,g,c,k;if(TP.isValid(a=this.getType().at('SEGMENT_INFO').at(l))&&TP.isValid(d=this.getType().at('SEGMENT_INFO').at(i))){e=a.first();f=a.last();b=this.operandsAsNumbers(h);if(b.getSize()!==f){return this;}g=d.first();c=this.getSegmentIndex(g,j);if(c>-1){k=this.get('pathSegments');this.get('pathSegments').splice(c,0,e,b);}}return this;});TP.core.Path.Inst.defineMethod('updateSegment',function(g,h,i){var b,c,f,d,a,e;if(TP.isValid(b=this.getType().at('SEGMENT_INFO').at(g))){c=b.first();f=b.last();d=this.operandsAsNumbers(h);if(d.getSize()!==f){return this;}a=this.getSegmentIndex(c,i);if(a>-1){e=this.get('pathSegments');e.atPut(a,c);e.atPut(a+1,d);}}return this;});TP.core.Path.defineSubtype('SVGPath');TP.core.SVGPath.Type.defineConstant('SEGMENT_INFO',TP.hc(TP.core.Path.MOVE_TO_ABS,TP.ac('M',2),TP.core.Path.LINE_TO_ABS,TP.ac('L',2),TP.core.Path.HORIZ_LINE_TO_ABS,TP.ac('H',1),TP.core.Path.VERT_LINE_TO_ABS,TP.ac('V',1),TP.core.Path.CURVE_TO_ABS,TP.ac('C',6),TP.core.Path.SMOOTH_CURVE_TO_ABS,TP.ac('S',4),TP.core.Path.QUAD_CURVE_TO_ABS,TP.ac('Q',4),TP.core.Path.QUAD_SMOOTH_CURVE_TO_ABS,TP.ac('T',2),TP.core.Path.ARC_TO_ABS,TP.ac('A',7),TP.core.Path.CLOSE_PATH_ABS,TP.ac('Z',0),TP.core.Path.MOVE_TO_REL,TP.ac('m',2),TP.core.Path.LINE_TO_REL,TP.ac('l',2),TP.core.Path.HORIZ_LINE_TO_REL,TP.ac('h',1),TP.core.Path.VERT_LINE_TO_REL,TP.ac('v',1),TP.core.Path.CURVE_TO_REL,TP.ac('c',6),TP.core.Path.SMOOTH_CURVE_TO_REL,TP.ac('s',4),TP.core.Path.QUAD_CURVE_TO_REL,TP.ac('q',4),TP.core.Path.QUAD_SMOOTH_CURVE_TO_REL,TP.ac('t',2),TP.core.Path.ARC_TO_REL,TP.ac('a',7),TP.core.Path.CLOSE_PATH_REL,TP.ac('z',0)));TP.core.SVGPath.Type.defineConstant('PATH_SPLITUP_REGEX',TP.rc('([A-Za-z])|(\\d+(\\.\\d+)?)|(\\.\\d+)|(-\\d+(\\.\\d+)?)|(-\\.\\d+)','g'));TP.core.SVGPath.Type.defineConstant('PATH_PARSER',function(h){var c,b,d,a,g,e,f;c=TP.ac();b=TP.core.SVGPath.at('PATH_SPLITUP_REGEX').match(h);d=TP.rc('[MLHVCSQTAZ]','i');for(a=0;a<b.getSize();a++){if(d.test(b.at(a))){g=b.at(a);c.push(g);a++;e=TP.ac();while(a<b.getSize()){if(d.test(b.at(a))){a--;break;}e.push(parseFloat(b.at(a)));a++;}c.push(e);}}if(TP.notEmpty(c)){f=TP.core.SVGPath.construct();f.set('pathSegments',c);return f;}return null;});TP.core.SVGPath.addParser(TP.core.SVGPath.PATH_PARSER);TP.core.SVGPath.Type.defineMethod('elementGetBoundingBox',function(c){var a,b;if(TP.isEmpty(a=c.getAttribute('d'))){return TP.core.Rect.construct(-1,-1,-1,-1);}if(TP.notValid(b=TP.core.SVGPath.from(a))){return TP.core.Rect.construct(-1,-1,-1,-1);}return b.getBoundingBox();});TP.core.Path.Inst.defineMethod('$updateBBoxData',function(a,b,c){if(a.left===TP.NOT_FOUND){a.top=c;a.right=b;a.left=b;a.bottom=c;}if(a.top>c){a.top=c;}if(a.right<b){a.right=b;}if(a.bottom<c){a.bottom=c;}if(a.left>b){a.left=b;}return this;});TP.core.SVGPath.Inst.defineMethod('$updateBBoxFromSegment',function(h,c,b,f){var a,d,e,g;switch(h){case'M':case'L':case'C':case'S':case'Q':case'T':for(a=0;a<c.getSize();a+=2){this.$updateBBoxData(f,c.at(a),c.at(a+1));}b.set('x',c.at(a-2));b.set('y',c.at(a-1));b.set('absolute',true);break;case'H':for(a=0;a<c.getSize();++a){this.$updateBBoxData(f,c.at(a),b.get('y'));}b.set('x',c.at(a-1));b.set('absolute',true);break;case'V':for(a=0;a<c.getSize();++a){this.$updateBBoxData(f,b.get('x'),c.at(a));}b.set('y',c.at(a-1));b.set('absolute',true);break;case'A':for(a=0;a<c.getSize();a+=7){this.$updateBBoxData(f,c.at(a+5),c.at(a+6));}b.set('x',c.at(a-2));b.set('y',c.at(a-1));b.set('absolute',true);break;case'm':if(b.get('x')===TP.NOT_FOUND){d=c.at(0);e=c.at(1);this.$updateBBoxData(f,d,e);g=2;}else{d=b.get('x');e=b.get('y');g=0;}for(a=g;a<c.getSize();a+=2){d=d+c.at(a);e=e+c.at(a+1);this.$updateBBoxData(f,d,e);}b.set('x',d);b.set('y',e);b.set('absolute',false);break;case'l':case't':d=b.get('x');e=b.get('y');for(a=0;a<c.getSize();a+=2){d=d+c.at(a);e=e+c.at(a+1);this.$updateBBoxData(f,d,e);}b.set('x',d);b.set('y',e);b.set('absolute',false);break;case'h':d=b.get('x');e=b.get('y');for(a=0;a<c.getSize();++a){d=d+c.at(a);this.$updateBBoxData(f,d,e);}b.set('x',d);b.set('absolute',false);break;case'v':d=b.get('x');e=b.get('y');for(a=0;a<c.getSize();++a){e=e+c.at(a);this.$updateBBoxData(f,d,e);}b.set('y',e);b.set('absolute',false);break;case'c':d=b.get('x');e=b.get('y');for(a=0;a<c.getSize();a+=6){this.$updateBBoxData(f,d+c.at(a),e+c.at(a+1));this.$updateBBoxData(f,d+c.at(a+2),e+c.at(a+3));d=d+c.at(a+4);e=e+c.at(a+5);this.$updateBBoxData(f,d,e);}b.set('x',d);b.set('y',e);b.set('absolute',false);break;case's':case'q':d=b.get('x');e=b.get('y');for(a=0;a<c.getSize();a+=4){this.$updateBBoxData(f,d+c.at(a),e+c.at(a+1));d=d+c.at(a+2);e=e+c.at(a+3);this.$updateBBoxData(f,d,e);}b.set('x',d);b.set('y',e);b.set('absolute',false);break;case'a':d=b.get('x');e=b.get('y');for(a=0;a<c.getSize();a+=7){d=d+c.at(a+5);e=e+c.at(a+6);this.$updateBBoxData(f,d,e);}b.set('x',d);b.set('y',e);b.set('absolute',false);break;default:break;}return this;});TP.core.SVGPath.Inst.defineMethod('getBoundingBox',function(){var c,d,a,b;c=this.get('pathSegments');d=TP.pc(-1,-1);d.defineAttribute('absolute',false);a={top:-1,right:-1,bottom:-1,left:-1};for(b=0;b<c.getSize();b+=2){this.$updateBBoxFromSegment(c.at(b),c.at(b+1),d,a);}return TP.core.Rect.construct(a.left,a.top,a.right-a.left,a.bottom-a.top);});TP.lang.Object.defineSubtype('core:Transition');TP.core.Transition.isAbstract(true);TP.core.Transition.Inst.defineAttribute('transitionJob');TP.core.Transition.Inst.defineMethod('init',function(a,c){var b;if(TP.notValid(a)){return this;}if(TP.notValid(b=this.constructJob(a,c))){return null;}this.set('transitionJob',b);return this;});TP.core.Transition.Inst.defineMethod('clearValues',function(a){return;});TP.core.Transition.Inst.defineMethod('configure',function(a,b){TP.override();return false;});TP.core.Transition.Inst.defineMethod('constructJob',function(f,g){var a,e,b,d,c;a=TP.ifInvalid(f,TP.hc());e=TP.hc('config',this.configure.bind(this),'pre',a.at('pre'),'step',this.step.bind(this),'post',a.at('post'),'compute',TP.ifInvalid(a.at('compute'),this.get('computeFunction')),'delay',TP.ifInvalid(a.at('delay'),this.get('delay')),'interval',TP.ifInvalid(a.at('interval'),this.get('interval')),'limit',TP.ifInvalid(a.at('limit'),this.get('limit')),'count',TP.ifInvalid(a.at('count'),this.get('count')),'isAnimation',TP.ifInvalid(a.at('isAnimation'),this.get('isAnimation')));b=TP.core.Job.construct(e);if(TP.notValid(b)){return null;}if(TP.isTrue(a.at('preserve'))){d=b.get('pre');b.set('pre',function(b,a){this.preserveValues(a);if(TP.isCallable(d)){d(b,a);}}.bind(this));}if(TP.isTrue(a.at('restore'))){c=b.get('post');b.set('post',function(b,a){if(TP.isCallable(c)){c(b,a);}this.restoreValues(a);}.bind(this));}else if(TP.notTrue(a.at('freeze'))){c=b.get('post');b.set('post',function(b,a){if(TP.isCallable(c)){c(b,a);}this.clearValues(a);}.bind(this));}return b;});TP.core.Transition.Inst.defineMethod('constructJobGroup',function(){var a,b;if(TP.notValid(a=TP.core.JobGroup.construct())){return null;}b=TP.args(arguments);b.perform(function(b){a.addChild(b);});return a;});TP.core.Transition.Inst.defineMethod('getComputeFunction',function(){return TP.core.Job.LINEAR_COMPUTE;});TP.core.Transition.Inst.defineMethod('getCount',function(){return null;});TP.core.Transition.Inst.defineMethod('getDelay',function(){return null;});TP.core.Transition.Inst.defineMethod('getInterval',function(){return null;});TP.core.Transition.Inst.defineMethod('getLimit',function(){return'1000';});TP.core.Transition.Inst.defineMethod('preserveValues',function(a){return;});TP.core.Transition.Inst.defineMethod('reset',function(){this.get('transitionJob').reset();return this;});TP.core.Transition.Inst.defineMethod('restoreValues',function(a){return;});TP.core.Transition.Inst.defineMethod('start',function(b){var a;if(TP.notValid(a=this.get('transitionJob'))){return;}if(TP.isValid(b)){if(TP.notValid(b.at('target'))){return;}a.set('parameters',b);}a.start();return a;});TP.core.Transition.Inst.defineMethod('step',function(a,b){TP.override();return false;});TP.core.Transition.defineSubtype('MultiTransition');TP.core.MultiTransition.Inst.defineAttribute('transitionEntries');TP.core.MultiTransition.Inst.defineMethod('init',function(a,b){this.callNextMethod();this.set('transitionEntries',TP.ac());return this;});TP.core.MultiTransition.Inst.defineMethod('addTransitionEntry',function(a){var b;if(TP.isType(b=a.at('transition'))){a.atPut('transitionInst',b.construct());a.atPut('origParams',a.at('params').copy());this.get('transitionEntries').add(a);}return this;});TP.core.MultiTransition.Inst.defineMethod('clearValues',function(e){var b,a,c,d;b=this.get('transitionEntries');for(a=0;a<b.getSize();a++){c=b.at(a);d=c.at('params');c.at('transitionInst').clearValues(d);}return;});TP.core.MultiTransition.Inst.defineMethod('configure',function(g,h){var d,c,a,b,e,f;d=this.get('transitionEntries');for(c=0;c<d.getSize();c++){a=d.at(c);b=a.at('origParams').copy();a.atPut('params',b);a.at('transitionInst').configure(g,b);if(TP.isNumber(e=b.at('from'))&&TP.isNumber(f=b.at('to'))){b.atPut('delta',f-e);}if(TP.notValid(a.at('compute'))){a.atPut('compute',a.at('transitionInst').get('computeFunction'));}}return this;});TP.core.MultiTransition.Inst.defineMethod('preserveValues',function(e){var b,a,c,d;b=this.get('transitionEntries');for(a=0;a<b.getSize();a++){c=b.at(a);d=c.at('params');c.at('transitionInst').preserveValues(d);}return;});TP.core.MultiTransition.Inst.defineMethod('restoreValues',function(e){var b,a,c,d;b=this.get('transitionEntries');for(a=0;a<b.getSize();a++){c=b.at(a);d=c.at('params');c.at('transitionInst').restoreValues(d);}return;});TP.core.MultiTransition.Inst.defineMethod('step',function(d,f){var a,c,b,e;a=null;d.defineMethod('getStepValue',function(b){var c;c=TP.isValid(b)?b:a.at('params');return a.at('compute')(this,c);});c=this.get('transitionEntries');for(b=0;b<c.getSize();b++){a=c.at(b);e=a.at('params');a.at('transitionInst').step(d,e);}return true;});TP.core.Transition.defineSubtype('ObjectPropertyTransition');TP.core.ObjectPropertyTransition.Type.defineMethod('transition',function(j,e,o){var g,a,h,n,b,i,k,d,c,m,f,l;if(TP.notValid(e)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!TP.isArray(j)){if(!TP.isElement(j)){return this.raise('TP.sig.InvalidObject',arguments);}g=TP.ac(j);}else{g=j;}a=TP.ifInvalid(o,TP.hc());if(TP.notValid(h=a.at('targetOrigins'))){h=g.collect(function(a){return TP.gid(a);});h.isOriginSet(true);}n=h.signal('TP.sig.PropertyWillTransition',arguments,a,a.atIfInvalid('signalPolicy',TP.FIRE_ONE));if(n.shouldPrevent()){return this;}if(TP.isCallable(i=a.at('compute'))){i=TP.core.Job[i];}else{i=null;}if(TP.notValid(b=a.at('limit'))){b=TP.core.Job.FOREVER;}else if(TP.isString(b)&&!b.startsWith('PT')){b='PT'+b;}k=TP.hc('pre',a.at('pre'),'post',a.at('post'),'compute',i,'delay',a.at('delay'),'interval',a.at('interval'),'limit',b,'count',a.at('count'),'freeze',a.at('freeze'),'preserve',a.at('preserve'),'restore',a.at('restore'));d=TP.hc('target',g,'property',e);if(TP.isArray(c=a.at('values'))){if(TP.isString(c)){c=c.split(' ');}}else{c=null;}if(TP.isArray(c)){d.atPut('values',c);}else{d.atPut('from',a.at('from'));d.atPut('to',a.at('to'));d.atPut('by',a.at('by'));}k.atPut('property',e);m=this.construct(k);f=m.get('transitionJob');l=f.get('post');f.set('post',function(e,b){var d,c;if(TP.isEmpty(d=b.at('target'))){return;}if(TP.isEmpty(c=b.at('property'))){return;}d.perform(function(a){if(TP.isValid(a['transition_'+c])){a['transition_'+c]=null;}});if(TP.isCallable(l)){l(e,b);}h.signal('TP.sig.PropertyDidTransition',arguments,a);});g.perform(function(d){var c,g,a,b;if(TP.isValid(c=d['transition_'+e])&&!c.didComplete()){if(TP.isValid(g=c.$get('parameters'))&&TP.isArray(a=g.at('target'))&&a.length>1){for(b=0;b<a.length;b++){if(a[b]===d){a.splice(b,1);break;}}}else{c.shutdown();}}d['transition_'+e]=f;});m.start(d);return f;});TP.core.ObjectPropertyTransition.Inst.defineMethod('configure',function(j,a){var d,b,c,g,h,f,e,i;d=a.at('property');if(TP.isEmpty(d)){return false;}b=a.at('target');if(TP.notValid(b)){return false;}if(TP.isArray(b)){b=b.first();}if(TP.isArray(a.at('values'))){return true;}if(TP.isEmpty(c=a.at('from'))){c=b.get(d);}f=c.asNumber();if(TP.notEmpty(g=a.at('to'))){e=g.asNumber();}else if(TP.notEmpty(h=a.at('by'))){i=h.asNumber();e=f+i;}else{return false;}a.atPut('from',f);a.atPut('to',e);a.atPut('respondsToSet',TP.canInvoke(b,'set'));return true;});TP.core.ObjectPropertyTransition.Inst.defineMethod('step',function(g,e){var b,a,c,f,d;b=e.at('property');if(TP.isEmpty(b)){return false;}a=e.at('target');if(TP.notValid(a)){return false;}c=g.getStepValue();if(TP.isArray(a)){f=a.length;for(d=0;d<f;d++){if(TP.isTrue(e.at('respondsToSet'))){a[d].set(b,c);}else{a[d][b]=c;}}}else{if(TP.isTrue(e.at('respondsToSet'))){a.set(b,c);}else{a[b]=c;}}return true;});TP.core.ObjectPropertyTransition.defineSubtype('AttributeTransition');TP.core.AttributeTransition.Inst.defineMethod('configure',function(j,a){var d,b,c,g,h,f,e,i;d=a.at('property');if(TP.isEmpty(d)){return false;}b=a.at('target');if(TP.notValid(b)){return false;}if(TP.isArray(b)){b=b.first();}if(TP.isArray(a.at('values'))){return true;}if(TP.isEmpty(c=a.at('from'))){c=TP.elementGetAttribute(b,d,true);}f=c.asNumber();if(TP.notEmpty(g=a.at('to'))){e=g.asNumber();}else if(TP.notEmpty(h=a.at('by'))){i=h.asNumber();e=f+i;}else{return false;}a.atPut('from',f);a.atPut('to',e);return true;});TP.core.AttributeTransition.Inst.defineMethod('step',function(g,e){var c,a,d,f,b;c=e.at('property');if(TP.isEmpty(c)){return false;}a=e.at('target');if(TP.notValid(a)){return false;}d=g.getStepValue();if(TP.isArray(a)){f=a.length;for(b=0;b<f;b++){TP.elementSetAttribute(a[b],c,d,true);}}else{TP.elementSetAttribute(a[b],c,d,true);}return true;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETCSSTypes.js';
TP.core.ObjectPropertyTransition.defineSubtype('CSSPropertyTransition');TP.core.CSSPropertyTransition.isAbstract(true);TP.core.CSSPropertyTransition.Type.defineMethod('getConcreteType',function(b){var a;a=b.at('property');if(TP.CSS_COLOR_PROPERTIES.contains(a)){return TP.core.CSSColorTransition;}if(TP.CSS_LENGTH_PROPERTIES.contains(a)){return TP.core.CSSLengthTransition;}if(TP.CSS_UNITLESS_PROPERTIES.contains(a)){return TP.core.CSSValueTransition;}return null;});TP.core.CSSPropertyTransition.Inst.defineAttribute('styleProperty');TP.core.CSSPropertyTransition.Inst.defineAttribute('propPrefix');TP.core.CSSPropertyTransition.Inst.defineAttribute('propSuffix');TP.core.CSSPropertyTransition.Inst.defineMethod('init',function(b,c){var a;a=this.callNextMethod();if(TP.notValid(a)){return;}return this;});TP.core.CSSPropertyTransition.Inst.defineMethod('clearValues',function(c){var a,b,d;if(TP.isEmpty(a=c.at('target'))){return;}if(TP.isEmpty(b=c.atIfInvalid('property',this.get('styleProperty')))){return;}if(TP.isArray(a)){a.perform(function(a){TP.elementClearStyleProperty(a,b);});d=TP.documentGetBody(TP.nodeGetDocument(a.first())).offsetHeight;}else{TP.elementClearStyleProperty(a,b);d=TP.documentGetBody(TP.nodeGetDocument(a)).offsetHeight;}return;});TP.core.CSSPropertyTransition.Inst.defineMethod('constructWorkFunction',function(c){var b,a;b=c.$get('step');a=function(c,d){var e;TP.isCallable(b)?c.wasSuccessful=b(c,d):c.wasSuccessful=b.apply(null,arguments);if(TP.notValid(a.targetBody)){if(TP.isArray(d.at('target'))){a.targetBody=TP.documentGetBody(TP.nodeGetDocument(d.at('target').first()));}else{a.targetBody=TP.documentGetBody(TP.nodeGetDocument(d.at('target')));}}e=a.targetBody.offsetHeight;return c.wasSuccessful;};a.$realFunc=b;return a;});TP.core.CSSPropertyTransition.Inst.defineMethod('constructJob',function(c,d){var b,a;b=TP.ifInvalid(c,TP.hc());b.atPut('isAnimation',true);a=this.callNextMethod(b,d);a.set('work',this.constructWorkFunction(a));return a;});TP.core.CSSPropertyTransition.Inst.defineMethod('getComputeFunction',function(){return null;});TP.core.CSSPropertyTransition.Inst.defineMethod('preserveValues',function(c){var a,b,d;if(TP.isEmpty(a=c.at('target'))){return;}if(TP.isEmpty(b=c.atIfInvalid('property',this.get('styleProperty')))){return;}if(TP.isArray(a)){a.perform(function(a){var c;c=TP.elementGetStyleProperty(a,b);TP.elementPushStyleProperty(a,b,c);});}else{d=TP.elementGetStyleProperty(a,b);TP.elementPushStyleProperty(a,b,d);}return;});TP.core.CSSPropertyTransition.Inst.defineMethod('restoreValues',function(c){var a,b,d,e;if(TP.isEmpty(a=c.at('target'))){return;}if(TP.isEmpty(b=c.atIfInvalid('property',this.get('styleProperty')))){return;}if(TP.isArray(a)){a.perform(function(a){var c;c=TP.elementPopStyleProperty(a,b);TP.elementGetStyleObj(a)[b]=c;});e=TP.documentGetBody(TP.nodeGetDocument(a.first())).offsetHeight;}else{d=TP.elementPopStyleProperty(a,b);TP.elementGetStyleObj(a)[b]=d;e=TP.documentGetBody(TP.nodeGetDocument(a)).offsetHeight;}return;});TP.core.CSSPropertyTransition.defineSubtype('CSSValueTransition');TP.core.CSSValueTransition.Inst.defineMethod('configure',function(j,a){var c,b,d,g,h,f,e,i;c=a.atIfInvalid('property',this.get('styleProperty'));if(TP.isEmpty(c)){return false;}b=a.at('target');if(TP.notValid(b)){return false;}if(TP.isArray(b)){b=b.first();}if(TP.CSS_DISALLOW_NEGATIVE_VALUES.contains(c)){a.atPut('nonegvalues',true);}if(TP.isArray(a.at('values'))){return true;}if(TP.isEmpty(d=a.at('from'))){d=TP.elementGetComputedStyleObj(b)[c];}a.atPutIfAbsent('propPrefix',TP.ifEmpty(this.get('propPrefix'),''));a.atPutIfAbsent('propSuffix',TP.ifEmpty(this.get('propSuffix'),''));f=TP.elementGetPropertyValueAsNumber(b,c,d);if(TP.notEmpty(g=a.at('to'))){e=TP.elementGetPropertyValueAsNumber(b,c,g);}else if(TP.notEmpty(h=a.at('by'))){i=TP.elementGetPropertyValueAsNumber(b,c,h);e=f+i;}else{return false;}a.atPut('from',f);a.atPut('to',e);return true;});TP.core.CSSValueTransition.Inst.defineMethod('step',function(g,c){var d,b,a,f,e;d=c.atIfInvalid('property',this.get('styleProperty'));if(TP.isEmpty(d)){return false;}b=c.at('target');if(TP.notValid(b)){return false;}a=g.getStepValue();if(TP.notValid(c.at('values'))){if(a<0&&TP.isTrue(c.at('nonnegvalues'))){a=c.at('from')+a;}a=c.at('propPrefix')+a+c.at('propSuffix');}if(TP.isArray(b)){f=b.getSize();for(e=0;e<f;e++){if(d==='opacity'){TP.elementSetOpacity(b[e],a);}else{b[e].style[d]=a;}}}else{if(d==='opacity'){TP.elementSetOpacity(b,a);}else{TP.elementGetStyleObj(b)[d]=a;}}return true;});TP.core.CSSValueTransition.defineSubtype('CSSLengthTransition');TP.core.CSSLengthTransition.Inst.defineMethod('configure',function(k,a){var c,b,d,g,h,i,f,e,j;c=a.atIfInvalid('property',this.get('styleProperty'));if(TP.isEmpty(c)){return false;}b=a.at('target');if(TP.notValid(b)){return false;}if(TP.isArray(b)){b=b.first();}if(TP.CSS_DISALLOW_NEGATIVE_VALUES.contains(c)){a.atPut('nonegvalues',true);}if(TP.isArray(a.at('values'))){return true;}if(TP.isEmpty(d=a.at('from'))){d=TP.elementGetComputedStyleObj(b)[c];}a.atPutIfAbsent('propPrefix',TP.ifEmpty(this.get('propPrefix'),''));if(TP.isArray(g=TP.regex.CSS_UNIT.match(d))){a.atPut('propSuffix',g.at(3));}else{a.atPutIfAbsent('propSuffix',TP.ifEmpty(this.get('propSuffix'),'px'));}f=TP.elementGetPixelValue(b,d,c);if(TP.notEmpty(h=a.at('to'))){e=TP.elementGetPixelValue(b,h,c);}else if(TP.notEmpty(i=a.at('by'))){j=TP.elementGetPixelValue(b,i,c);e=f+j;}else{return false;}a.atPut('from',f);a.atPut('to',e);return true;});TP.core.CSSValueTransition.defineSubtype('CSSColorTransition');TP.core.CSSColorTransition.Inst.defineMethod('configure',function(l,a){var g,b,k,c,d,e,j,f,h,i;g=a.atIfInvalid('property',this.get('styleProperty'));if(TP.isEmpty(g)){return false;}b=a.at('target');if(TP.notValid(b)){return false;}if(TP.isArray(b)){b=b.first();}if(TP.isArray(k=a.at('values'))){j=k.collect(function(a){return TP.convertColorStringToLongNumber(a);});a.atPut('values',j);return true;}if(TP.notEmpty(c=a.at('from'))){c=c.asString();}if(TP.notEmpty(d=a.at('to'))){d=d.asString();}if(TP.notEmpty(e=a.at('by'))){e=e.asString();}if(TP.notEmpty(c)){f=TP.convertColorStringToLongNumber(c);}else{if(g==='backgroundColor'){f=TP.convertColorStringToLongNumber(TP.elementGetEffectiveBackgroundColor(b));}else{f=TP.convertColorStringToLongNumber(TP.elementGetComputedStyleObj(b)[g]);}}if(TP.notEmpty(d)){h=TP.convertColorStringToLongNumber(d);}else if(TP.notEmpty(e)){i=TP.convertColorStringToLongNumber(e);h=f+i;}else{}a.atPut('from',f);a.atPut('to',h);return true;});TP.core.CSSColorTransition.Inst.defineMethod('step',function(f,c){var d,a,b,g,h,i,j,e;d=c.atIfInvalid('property',this.get('styleProperty'));if(TP.isEmpty(d)){return false;}a=c.at('target');if(TP.notValid(a)){return false;}if(TP.notEmpty(c.at('values'))){b=TP.convertLongNumberToColorString(f.getStepValue());}else{g=c.at('from');h=c.at('to');if(TP.isNumber(i=f.getPercentComplete())){b=TP.convertLongNumberToColorString(TP.interpolateColors(g,h,i));}else{b='';}}if(TP.isArray(a)){j=a.getSize();for(e=0;e<j;e++){a[e].style[d]=b;}}else{TP.elementGetStyleObj(a)[d]=b;}return true;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETCSSTypesW3C.js';
TP.core.Gradient.Inst.defineMethod('asCanvasGradientOn',function(a){return TP.override();});TP.core.Gradient.Inst.defineMethod('asSVGGradientOn',function(a,b){return TP.override();});TP.core.Gradient.Inst.defineMethod('$setupSVGGradientElement',function(f,g,j){var c,a,d,e,b,h,i;c=TP.nodeGetDocument(f);if(TP.isElement(a=c.getElementById(g))){return a;}d=TP.nodeGetFirstElementAncestorByTagName(f,'svg');if(TP.notValid(e=TP.nodeGetFirstElementByTagName(d,'defs'))){e=TP.documentCreateElement(c,'defs',TP.w3.Xmlns.SVG);d.insertBefore(e,d.firstChild);}if(TP.notEmpty(b=g)){b=b.slice(b.indexOf('#')+1,b.lastIndexOf(')'));}if(TP.isEmpty(b)||TP.notValid(a=TP.byId(b,c))){a=TP.documentCreateElement(c,j,TP.w3.Xmlns.SVG);b=TP.lid(a,true).toLowerCase();TP.elementSetAttribute(a,'id',b);TP.elementSetAttribute(a,'gradientUnits','userSpaceOnUse');e.appendChild(a);}else{TP.nodeEmptyContent(a);}this.normalizeGradientValues();h=this.get('colors');i=this.get('stops');h.performWith(function(d,e){var b;b=TP.documentCreateElement(c,'stop',TP.w3.Xmlns.SVG);TP.elementSetAttribute(b,'offset',e.toFixed(8));TP.elementSetAttribute(b,'stop-color',d.asHexString());TP.elementSetAttribute(b,'stop-opacity',d.get('alpha'));a.appendChild(b);},i);return a;});TP.core.LinearGradient.Inst.defineMethod('asCanvasGradientOn',function(a){var g,b,c,d,e,f,h,i;if(TP.notValid(a)){return this.raise('TP.sig.InvalidElement',arguments);}if(TP.notValid(g=a.getContext('2d'))){return this.raise('TP.sig.InvalidContext',arguments,'Canvas has invalid 2D context');}if(/%/.test(b=this.get('x1'))){b=parseFloat(b)/100*a.width;}if(/%/.test(c=this.get('y1'))){c=parseFloat(c)/100*a.height;}if(/%/.test(d=this.get('x2'))){d=parseFloat(d)/100*a.width;}if(/%/.test(e=this.get('y2'))){e=parseFloat(e)/100*a.height;}f=g.createLinearGradient(b,c,d,e);this.normalizeGradientValues();i=this.get('stops');h=this.get('colors');i.performWith(function(a,b){if(TP.isNumber(a)){f.addColorStop(a,b.asRGBAString());}},h);return f;});TP.core.LinearGradient.Inst.defineMethod('asSVGGradientOn',function(b,d){var a,c;a=this.$setupSVGGradientElement(b,d,'linearGradient');TP.elementSetAttribute(a,'x1',this.get('x1'));TP.elementSetAttribute(a,'y1',this.get('y1'));TP.elementSetAttribute(a,'x2',this.get('x2'));TP.elementSetAttribute(a,'y2',this.get('y2'));c=TP.join('url(',TP.nodeGetDocument(b).URL,'#',TP.elementGetAttribute(a,'id'),')');return c;});TP.core.RadialGradient.Inst.defineMethod('asCanvasGradientOn',function(a){var f,b,c,g,d,e,h,i;if(TP.notValid(a)){return this.raise('TP.sig.InvalidElement',arguments);}if(TP.notValid(f=a.getContext('2d'))){return this.raise('TP.sig.InvalidContext',arguments,'Canvas has invalid 2D context');}if(/%/.test(b=this.get('cx'))){b=parseFloat(b)/100*a.width;}if(/%/.test(c=this.get('cy'))){c=parseFloat(c)/100*a.height;}if(/%/.test(d=this.get('radius'))){g=(a.width.pow(2)+a.height.pow(2)).sqrt()/2..sqrt();d=parseFloat(d)/100*g;}e=f.createRadialGradient(b,c,0,b,c,d);this.normalizeGradientValues();i=this.get('stops');h=this.get('colors');i.performWith(function(a,b){if(TP.isNumber(a)){e.addColorStop(a,b.asRGBAString());}},h);return e;});TP.core.RadialGradient.Inst.defineMethod('asSVGGradientOn',function(b,d){var a,c;a=this.$setupSVGGradientElement(b,d,'radialGradient');TP.elementSetAttribute(a,'cx',this.get('cx'));TP.elementSetAttribute(a,'cy',this.get('cy'));TP.elementSetAttribute(a,'r',this.get('radius'));TP.elementSetAttribute(a,'fx',this.get('fx'));TP.elementSetAttribute(a,'fy',this.get('fy'));c=TP.join('url(',TP.nodeGetDocument(b).URL,'#',TP.elementGetAttribute(a,'id'),')');return c;});TP.core.Pattern.Inst.defineMethod('asCanvasPatternOn',function(a){return TP.todo();});TP.core.Pattern.Inst.defineMethod('asSVGPatternOn',function(g,i){var d,e,f,a,b,c,h;d=TP.nodeGetDocument(g);e=TP.nodeGetFirstElementAncestorByTagName(g,'svg');if(TP.notValid(f=TP.nodeGetFirstElementByTagName(e,'defs'))){f=TP.documentCreateElement(d,'defs',TP.w3.Xmlns.SVG);e.insertBefore(f,e.firstChild);}if(TP.notEmpty(a=i)){a=a.slice(a.indexOf('#')+1,a.lastIndexOf(')'));}if(TP.isEmpty(a)||TP.notValid(b=TP.byId(a,d))){b=TP.documentCreateElement(d,'pattern',TP.w3.Xmlns.SVG);a=TP.lid(b,true).toLowerCase();TP.elementSetAttribute(b,'id',a);TP.elementSetAttribute(b,'patternUnits','userSpaceOnUse');f.appendChild(b);}if(TP.notValid(c=b.getElementsByTagName('image')[0])){c=TP.documentCreateElement(d,'image',TP.w3.Xmlns.SVG);b.appendChild(c);}TP.elementSetAttribute(c,'x',this.get('x'));TP.elementSetAttribute(c,'y',this.get('y'));TP.elementSetAttribute(c,'width',this.get('width'));TP.elementSetAttribute(c,'height',this.get('height'));TP.elementSetAttributeInNS(c,'href',this.get('uri'),TP.w3.Xmlns.XLINK);h=TP.join('url(',TP.nodeGetDocument(g).URL,'#',a,')');return h;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETWorkflowDOMTypes.js';
TP.core.ElementNode.defineSubtype('vcard_temp:vCard');TP.vcard_temp.vCard.Type.defineConstant('template',TP.elementFromString(TP.join('<vCard>','<VERSION>1.1</VERSION>','<FN>fullname</FN>','<N>name</N>','<ROLE>role;role;role</ROLE>','<ORG>','<ORGNAME>org</ORGNAME>','<ORGUNIT>unit;unit;unit</ORGUNIT>','</ORG>','</vCard>')));TP.vcard_temp.vCard.Type.defineMethod('getInstanceById',function(c){var a,b;a=this.getVCardXML();if(TP.notValid(a)){return this.raise('TP.sig.InvalidXML',arguments,'Unable to acquire vCard XML');}b=TP.nodeEvaluateXPath(a,TP.join('//$def:FN[text()="',c,'"]/..'),TP.FIRST_NODE);if(TP.notValid(b)){return;}return this.construct(b);});TP.vcard_temp.vCard.Type.defineMethod('getVCardXML',function(e){var a,d,b,c;if(TP.ifInvalid(e,false)){TP.sys.$vcardXML=null;}if(TP.isNode(a=TP.sys.$vcardXML)){return a;}d=TP.sys.shouldLogRaise();TP.sys.shouldLogRaise(false);try{try{if(TP.notEmpty(b=TP.sys.cfg('tibet.vcards'))){b=TP.uriExpandPath(b);if(TP.isURI(c=TP.uc(b))){a=TP.$fileLoad(c.getLocation(),TP.hc('resultType',TP.DOM));}}}catch(a){}try{if(TP.notValid(a)){b=TP.uriExpandPath(TP.sys.cfg('tibet.vcard_file'));if(TP.isURI(c=TP.uc(b))){a=TP.$fileLoad(c.getLocation(),TP.hc('resultType',TP.DOM));}}}catch(a){}if(TP.notValid(a)){a=TP.documentFromString('<vCards xmlns="vcard-temp"></vCards>');}TP.sys.$vcardXML=a;}catch(a){}finally{TP.sys.shouldLogRaise(d);}return a;});TP.vcard_temp.vCard.Inst.defineAttribute('version',{'value':TP.xpc('./$def:VERSION',true).set('extractWith','value')});TP.vcard_temp.vCard.Inst.defineAttribute('fullname',{'value':TP.xpc('./$def:FN',true).set('extractWith','value')});TP.vcard_temp.vCard.Inst.defineAttribute('shortname',{'value':TP.xpc('./$def:N',true).set('extractWith','value')});TP.vcard_temp.vCard.Inst.defineAttribute('jid',{'value':TP.xpc('./$def:JABBERID',true).set('extractWith','value')});TP.vcard_temp.vCard.Inst.defineAttribute('url',{'value':TP.xpc('./$def:URL',true).set('extractWith','value')});TP.vcard_temp.vCard.Inst.defineAttribute('role',{'value':TP.xpc('./$def:ROLE',true).set('extractWith','value')});TP.vcard_temp.vCard.Inst.defineAttribute('orgname',{'value':TP.xpc('./$def:ORG/$def:ORGNAME',true).set('extractWith','value')});TP.vcard_temp.vCard.Inst.defineAttribute('orgunit',{'value':TP.xpc('./$def:ORG/$def:ORGUNIT',true).set('extractWith','value')});TP.vcard_temp.vCard.Inst.defineAttribute('key',{'value':TP.xpc('./$def:KEY',true).set('extractWith','value')});TP.vcard_temp.vCard.Inst.defineAttribute('secretkey',{'value':TP.xpc('./$def:X-SECRET-KEY',true).set('extractWith','value')});TP.vcard_temp.vCard.Inst.defineAttribute('username',{'value':TP.xpc('./$def:X-USERNAME',true).set('extractWith','value')});TP.vcard_temp.vCard.Inst.defineAttribute('password',{'value':TP.xpc('./$def:X-PASSWORD',true).set('extractWith','value')});TP.vcard_temp.vCard.Inst.defineAttribute('auth',{'value':TP.xpc('./$def:X-AUTH',true).set('extractWith','value')});TP.vcard_temp.vCard.Inst.defineAttribute('iswebdav',{'value':TP.xpc('./$def:X-IS-WEBDAV',true).set('extractWith','value')});TP.vcard_temp.vCard.Inst.defineMethod('getAccessKeys',function(){var a,b,c;if(TP.notEmpty(a=this.getAttribute('keys'))){return a.split(' ');}a=TP.ac();b=this.getRoles();a=b.injectInto(a,function(b,a){a.push.apply(a,b.getAccessKeys());return a;});c=this.getUnits();a=c.injectInto(a,function(b,a){a.push.apply(a,b.getAccessKeys());return a;});return a.unique().sort();});TP.vcard_temp.vCard.Inst.defineMethod('getRoleNames',function(){var b,a,c;b=this.get('orgname');a=this.get('role');if(TP.isEmpty(a)){return TP.ac();}c=a.split(';');return c.collect(function(a){return TP.join(b,':',a);});});TP.vcard_temp.vCard.Inst.defineMethod('getRoles',function(){var a;a=this.getRoleNames();return a.collect(function(a){return TP.sys.require(a);}).compact();});TP.vcard_temp.vCard.Inst.defineMethod('getUnitNames',function(){var b,a,c;b=this.get('orgname');a=this.get('orgunit');if(TP.isEmpty(a)){return TP.ac();}c=a.split(';');return c.collect(function(a){return TP.join(b,':',a);});});TP.vcard_temp.vCard.Inst.defineMethod('getUnits',function(){var a;a=this.getUnitNames();return a.collect(function(a){return TP.sys.require(a);}).compact();});TP.core.ElementNode.defineSubtype('tibet:keyring');TP.tibet.keyring.Type.defineMethod('getInstanceById',function(c){var a,b;a=this.getKeyringXML();if(TP.notValid(a)){return this.raise('TP.sig.InvalidXML',arguments,'Unable to acquire keyring XML');}b=TP.nodeGetElementById(a,c);if(TP.notValid(b)){return;}return this.construct(b);});TP.tibet.keyring.Type.defineMethod('getKeyringXML',function(e){var a,d,b,c;if(TP.ifInvalid(e,false)){TP.sys.$keyringXML=null;}if(TP.isNode(a=TP.sys.$keyringXML)){return a;}d=TP.sys.shouldLogRaise();TP.sys.shouldLogRaise(false);try{try{if(TP.notEmpty(b=TP.sys.cfg('tibet.keyrings'))){b=TP.uriExpandPath(b);if(TP.isURI(c=TP.uc(b))){a=TP.$fileLoad(c.getLocation(),TP.hc('resultType',TP.DOM));}}}catch(a){}try{if(TP.notValid(a)){b=TP.uriExpandPath(TP.sys.cfg('tibet.keyring_file'));if(TP.isURI(c=TP.uc(b))){a=TP.$fileLoad(c.getLocation(),TP.hc('resultType',TP.DOM));}}}catch(a){}if(TP.notValid(a)){a=TP.documentFromString(TP.join('<keyrings xmlns="',TP.w3.Xmlns.TIBET,'">','</keyrings>'));}TP.sys.$keyringXML=a;}catch(a){}finally{TP.sys.shouldLogRaise(d);}return a;});TP.tibet.keyring.Inst.defineMethod('getAccessKeys',function(){var a,b,c;if(TP.notEmpty(a=this.getAttribute('keys'))){return a.split(' ');}a=TP.ac();c=this.getKeyrings();a=c.injectInto(a,function(b,a){a.push.apply(a,b.getAccessKeys());return a;});b=this.evaluateXPath('./$def:key/@id',TP.NODESET);a=b.injectInto(a,function(b,a){a.push(TP.str(b.value));return a;});a=a.unique().sort();this.setAttribute('keys',a.join(' '));return a;});TP.tibet.keyring.Inst.defineMethod('getKeyrings',function(){var a;a=this.evaluateXPath('./$def:keyring/@ref',TP.NODESET);a.convert(function(a){return TP.tibet.keyring.getInstanceById(TP.str(a.value));});return a;});TP.tibet.keyring.Inst.defineMethod('hasAccessKey',function(a){return this.getAccessKeys().contains(a);});TP.lang.Object.defineSubtype('core.TagProcessor');TP.core.TagProcessor.Type.defineConstant('ATTACH_PHASES',TP.ac('TP.core.AttachDOMPhase','TP.core.AttachEventsPhase','TP.core.AttachDataPhase','TP.core.AttachInfoPhase','TP.core.AttachBindsPhase','TP.core.AttachStylePhase'));TP.core.TagProcessor.Type.defineConstant('DETACH_PHASES',TP.ac('TP.core.DetachDOMPhase','TP.core.DetachEventsPhase','TP.core.DetachDataPhase','TP.core.DetachInfoPhase','TP.core.DetachBindsPhase','TP.core.DetachStylePhase'));TP.core.TagProcessor.Type.defineConstant('COMPILE_PHASES',TP.ac('TP.core.IncludesPhase','TP.core.InstructionsPhase','TP.core.PrecompilePhase','TP.core.CompilePhase','TP.core.TidyPhase','TP.core.UnmarshalPhase','TP.core.LocalizePhase'));TP.core.TagProcessor.Type.defineMethod('constructWithPhaseTypes',function(c){var a,b;a=c.collect(function(a){return a.construct();});b=this.construct(a);return b;});TP.core.TagProcessor.Inst.defineAttribute('phases');TP.core.TagProcessor.Inst.defineAttribute('$tagTypeDict');TP.core.TagProcessor.Inst.defineMethod('init',function(a){this.callNextMethod();this.set('phases',a);this.set('$tagTypeDict',TP.hc());return this;});TP.core.TagProcessor.Inst.defineMethod('processTree',function(b,e){var c,d,a;if(!TP.isNode(b)){return this.raise('TP.sig.InvalidNode',arguments);}TP.nodeNormalize(b);c=this.get('phases');d=c.getSize();for(a=0;a<d;a++){c.at(a).processNode(b,this,e);}return this;});TP.lang.Object.defineSubtype('core.TagProcessorPhase');TP.core.TagProcessorPhase.Inst.defineMethod('getFilteredNodes',function(c,g){var d,b,a,e,f;if(!TP.isNode(c)){return this.raise('TP.sig.InvalidNode',arguments);}if(!TP.isString(d=this.getTargetMethod())){return this.raise('TP.sig.InvalidParameter',arguments);}b=g.get('$tagTypeDict');a=TP.hc();e=this.queryForNodes(c);f=e.select(function(e){var f,c,g;if(TP.isElement(e)){c=TP.elementGetFullName(e);if(b.hasKey(c)&&a.hasKey(c)){return a.at(c);}}if(!TP.isType(f=TP.core.Node.getConcreteType(e))){return false;}g=TP.canInvoke(f,d);if(TP.isElement(e)){b.atPut(c,f);a.atPut(c,g);}return g;});return f;});TP.core.TagProcessorPhase.Inst.defineMethod('getTargetMethod',function(){return TP.override();});TP.core.TagProcessorPhase.Inst.defineMethod('processNode',function(i,g,o){var n,l,m,e,d,j,b,c,h,a,f,k;if(!TP.isNode(i)){return this.raise('TP.sig.InvalidNode',arguments);}if(!TP.isString(n=this.getTargetMethod())){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.isEmpty(l=this.getFilteredNodes(i,g))){return this;}d=TP.request(o);d.atPut('currentPhase',this);d.atPut('phases',g.get('phases'));d.atPutIfAbsent('doc',TP.nodeGetDocument(i));d.atPut('root',i);m=g.get('$tagTypeDict');e=TP.ac();j=l.getSize();for(b=0;b<j;b++){c=l.at(b);d.atPut('node',c);if(TP.isElement(c)){if(!TP.isType(h=m.at(TP.elementGetFullName(c)))){h=TP.core.Node.getConcreteType(c);}}else{h=TP.core.Node.getConcreteType(c);}a=h[n](d);if(TP.isNode(a)&&(a===c||TP.nodeEqualsNode(a,c))){continue;}if(TP.isNode(a)){e.push(a);}else if(TP.isArray(a)){e.addAll(a);}}if(TP.notEmpty(e)){f=g.get('phases');f=f.slice(0,f.indexOf(this)+1);k=TP.core.TagProcessor.construct();k.set('phases',f);j=e.getSize();for(b=0;b<j;b++){k.processTree(e.at(b));}}return this;});TP.core.TagProcessorPhase.Inst.defineMethod('queryForNodes',function(a){var b,c;if(!TP.isNode(a)||TP.isFragment(a)){return this.raise('TP.sig.InvalidNode',arguments);}b='./descendant-or-self::node()';c=TP.nodeEvaluateXPath(a,b,TP.NODESET);return c;});TP.core.TagProcessorPhase.defineSubtype('core.IncludesPhase');TP.core.IncludesPhase.Inst.defineMethod('getTargetMethod',function(){return'tagIncludes';});TP.core.IncludesPhase.Inst.defineMethod('queryForNodes',function(a){var b,c;if(!TP.isNode(a)||TP.isFragment(a)){return this.raise('TP.sig.InvalidNode',arguments);}b='descendant-or-self::*[namespace-uri() = "'+TP.w3.Xmlns.XINCLUDE+'"]';c=TP.nodeEvaluateXPath(a,b,TP.NODESET);return c;});TP.core.TagProcessorPhase.defineSubtype('core.InstructionsPhase');TP.core.InstructionsPhase.Inst.defineMethod('getTargetMethod',function(){return'tagInstructions';});TP.core.InstructionsPhase.Inst.defineMethod('queryForNodes',function(a){var b,c;if(!TP.isNode(a)||TP.isFragment(a)){return this.raise('TP.sig.InvalidNode',arguments);}b='.//processing-instruction(\'tibet-stylesheet\')';c=TP.nodeEvaluateXPath(a,b,TP.NODESET);return c;});TP.core.TagProcessorPhase.defineSubtype('core.PrecompilePhase');TP.core.PrecompilePhase.Inst.defineMethod('getTargetMethod',function(){return'tagPrecompile';});TP.core.TagProcessorPhase.defineSubtype('core.CompilePhase');TP.core.CompilePhase.Inst.defineMethod('getTargetMethod',function(){return'tagCompile';});TP.core.CompilePhase.Inst.defineMethod('queryForNodes',function(a){var b;if(!TP.isNode(a)){return this.raise('TP.sig.InvalidNode',arguments);}b=TP.nodeGetElementsByTagName(a,'*');b.unshift(a);return b;});TP.core.TagProcessorPhase.defineSubtype('core.TidyPhase');TP.core.TidyPhase.Inst.defineMethod('getTargetMethod',function(){return'tagTidy';});TP.core.TidyPhase.Inst.defineMethod('queryForNodes',function(a){var b;if(!TP.isNode(a)){return this.raise('TP.sig.InvalidNode',arguments);}b=TP.nodeGetElementsByTagName(a,'*');return b;});TP.core.TagProcessorPhase.defineSubtype('core.UnmarshalPhase');TP.core.UnmarshalPhase.Inst.defineMethod('getTargetMethod',function(){return'tagUnmarshal';});TP.core.UnmarshalPhase.Inst.defineMethod('queryForNodes',function(a){var b;if(!TP.isNode(a)){return this.raise('TP.sig.InvalidNode',arguments);}b=TP.nodeGetElementsByTagName(a,'*');return b;});TP.core.TagProcessorPhase.defineSubtype('core.LocalizePhase');TP.core.LocalizePhase.Inst.defineMethod('getTargetMethod',function(){return'tagLocalize';});TP.core.TagProcessorPhase.defineSubtype('core.MutationPhase');TP.core.MutationPhase.isAbstract(true);TP.core.MutationPhase.defineSubtype('core.AttachDOMPhase');TP.core.AttachDOMPhase.Inst.defineMethod('getTargetMethod',function(){return'tagAttachDOM';});TP.core.MutationPhase.defineSubtype('core.AttachEventsPhase');TP.core.AttachEventsPhase.Inst.defineMethod('getTargetMethod',function(){return'tagAttachEvents';});TP.core.AttachEventsPhase.Inst.defineMethod('queryForNodes',function(a){var b,c;if(!TP.isNode(a)||TP.isFragment(a)){return this.raise('TP.sig.InvalidNode',arguments);}b='descendant-or-self::*'+'['+'namespace-uri() = "'+TP.w3.Xmlns.XML_EVENTS+'"'+' or '+'@*[namespace-uri() = "'+TP.w3.Xmlns.XML_EVENTS+'"]'+']';c=TP.nodeEvaluateXPath(a,b,TP.NODESET);return c;});TP.core.MutationPhase.defineSubtype('core.AttachDataPhase');TP.core.AttachDataPhase.Inst.defineMethod('getTargetMethod',function(){return'tagAttachData';});TP.core.MutationPhase.defineSubtype('core.AttachInfoPhase');TP.core.AttachInfoPhase.Inst.defineMethod('getTargetMethod',function(){return'tagAttachInfo';});TP.core.AttachInfoPhase.Inst.defineMethod('queryForNodes',function(a){var b,c;if(!TP.isNode(a)||TP.isFragment(a)){return this.raise('TP.sig.InvalidNode',arguments);}b='descendant-or-self::*[local-name() = "info"]';c=TP.nodeEvaluateXPath(a,b,TP.NODESET);return c;});TP.core.MutationPhase.defineSubtype('core.AttachBindsPhase');TP.core.AttachBindsPhase.Inst.defineMethod('getTargetMethod',function(){return'tagAttachBinds';});TP.core.AttachBindsPhase.Inst.defineMethod('queryForNodes',function(a){var b,c;if(!TP.isNode(a)||TP.isFragment(a)){return this.raise('TP.sig.InvalidNode',arguments);}b='descendant-or-self::*'+'['+'namespace-uri() = "'+TP.w3.Xmlns.BIND+'"'+' or '+'@*[namespace-uri() = "'+TP.w3.Xmlns.BIND+'"]'+']';c=TP.nodeEvaluateXPath(a,b,TP.NODESET);return c;});TP.core.MutationPhase.defineSubtype('core.AttachStylePhase');TP.core.AttachStylePhase.Inst.defineMethod('getTargetMethod',function(){return'tagAttachStyle';});TP.core.MutationPhase.defineSubtype('core.DetachDOMPhase');TP.core.DetachDOMPhase.Inst.defineMethod('getTargetMethod',function(){return'tagDetachDOM';});TP.core.MutationPhase.defineSubtype('core.DetachEventsPhase');TP.core.DetachEventsPhase.Inst.defineMethod('getTargetMethod',function(){return'tagDetachEvents';});TP.core.DetachEventsPhase.Inst.defineMethod('queryForNodes',function(a){var b,c;if(!TP.isNode(a)||TP.isFragment(a)){return this.raise('TP.sig.InvalidNode',arguments);}b='descendant-or-self::*'+'['+'namespace-uri() = "'+TP.w3.Xmlns.XML_EVENTS+'"'+' or '+'@*[namespace-uri() = "'+TP.w3.Xmlns.XML_EVENTS+'"]'+']';c=TP.nodeEvaluateXPath(a,b,TP.NODESET);return c;});TP.core.MutationPhase.defineSubtype('core.DetachDataPhase');TP.core.DetachDataPhase.Inst.defineMethod('getTargetMethod',function(){return'tagDetachData';});TP.core.MutationPhase.defineSubtype('core.DetachInfoPhase');TP.core.DetachInfoPhase.Inst.defineMethod('getTargetMethod',function(){return'tagDetachInfo';});TP.core.DetachInfoPhase.Inst.defineMethod('queryForNodes',function(a){var b,c;if(!TP.isNode(a)||TP.isFragment(a)){return this.raise('TP.sig.InvalidNode',arguments);}b='descendant-or-self::*[local-name() = "info"]';c=TP.nodeEvaluateXPath(a,b,TP.NODESET);return c;});TP.core.MutationPhase.defineSubtype('core.DetachBindsPhase');TP.core.DetachBindsPhase.Inst.defineMethod('getTargetMethod',function(){return'tagDetachBinds';});TP.core.DetachBindsPhase.Inst.defineMethod('queryForNodes',function(a){var b,c;if(!TP.isNode(a)||TP.isFragment(a)){return this.raise('TP.sig.InvalidNode',arguments);}b='descendant-or-self::*'+'['+'namespace-uri() = "'+TP.w3.Xmlns.BIND+'"'+' or '+'@*[namespace-uri() = "'+TP.w3.Xmlns.BIND+'"]'+']';c=TP.nodeEvaluateXPath(a,b,TP.NODESET);return c;});TP.core.MutationPhase.defineSubtype('core.DetachStylePhase');TP.core.DetachStylePhase.Inst.defineMethod('getTargetMethod',function(){return'tagDetachStyle';});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETCoreTags.js';
TP.core.ElementNode.defineSubtype('ApplicationElement');TP.core.ApplicationElement.Inst.defineMethod('getApplicationType',function(){var a,b;if(TP.notEmpty(a=this.getAttribute('tibet:appctrl'))){if(TP.isType(b=TP.sys.require(a))){return b;}else{TP.ifWarn()?TP.warn('Unable to load application controller type: '+a,TP.LOG,arguments):0;}}return TP.sys.require('TP.core.Application');});TP.core.ApplicationElement.defineSubtype('tibet:app');TP.tibet.app.Type.defineMethod('tagAttachDOM',function(a){return this.callNextMethod();});TP.tibet.app.Type.defineMethod('tagCompile',function(d){var a,b,c;if(!TP.isElement(a=d.at('node'))){return;}if(TP.notEmpty(a.getAttribute('tibet:appctrl'))){return this.callNextMethod();}b=TP.sys.cfg('project.name');c=TP.xhtmlnode('<div tibet:sourcetag="tibet:app">'+'<h1 class="tag-defaulted">'+'Application type for: '+b+' not found. '+'&lt;tibet:root/&gt; defaulted to &lt;tibet:app/&gt;'+'</h1>'+'</div>');TP.elementReplaceWith(a,c);return;});TP.core.ElementNode.defineSubtype('tibet:root');TP.tibet.root.Type.defineMethod('tagCompile',function(g){var f,a,b,h,c,d,e;if(!TP.isElement(f=g.at('node'))){return;}b=TP.ac();a=TP.sys.cfg('tibet.apptag');if(TP.notEmpty(a)){b.push(a);}a=TP.sys.cfg('project.name');if(TP.notEmpty(a)){b.push(a+':app');}h=TP.sys.cfg('boot.profile');if(TP.sys.cfg('tibet.sherpa')===true){b.unshift('tibet:sherpa');}b.push('tibet:app');a=b.join();while(TP.notValid(c)&&TP.notEmpty(d=b.shift())){c=TP.sys.getTypeByName(d,false);}if(TP.notValid(c)){this.raise('TypeNotFound','Expected one of: '+a);return;}e=TP.elementBecome(f,d);TP.elementRemoveAttribute(e,'tibet:sourcetag',true);return e;});
TP.boot.$srcPath = '~lib_src/tibet/kernel/TIBETFinalization.js';
TP.sys.$extraglobals=TP.sys.$nativeglobals.difference(TP.sys.$ecmaglobals).difference(TP.sys.$systemglobals).difference(TP.sys.$windowglobals).difference(TP.sys.$globals);TP.sys.$keywords=TP.hc().addAllKeys(TP.sys.$keywords);TP.sys.$reservedwords=TP.hc().addAllKeys(TP.sys.$reservedwords);TP.sys.$globals=TP.hc().addAllKeys(TP.sys.$globals);TP.sys.$globalexcludes=TP.hc().addAllKeys(TP.sys.$globalexcludes);TP.sys.$ecmaglobals=TP.hc().addAllKeys(TP.sys.$ecmaglobals);TP.sys.$systemglobals=TP.hc().addAllKeys(TP.sys.$systemglobals);TP.sys.$nativeglobals=TP.hc().addAllKeys(TP.sys.$nativeglobals);TP.sys.$windowglobals=TP.hc().addAllKeys(TP.sys.$windowglobals);TP.sys.$extraglobals=TP.hc().addAllKeys(TP.sys.$extraglobals);TP.sys.defineMethod('defineGlobal',function(a,b,c){if(TP.isEmpty(a)){return;}TP.sys.$globals.atPut(a,null);if(TP.notValid(TP.global[a])||c){TP.global[a]=b;}return TP.global[a];});$signal_stack=TP.ac();$focus_stack=TP.ac();TP.sys.fireNextSignal();TP.sys.defineMethod('activate',function(){var c,d,a,f,b,e,g,h;if(TP.sys.hasInitialized()){return;}TP.debug('break.main');TP.boot.$setStage('initializing');TP.sys.configuration=TP.hc(TP.sys.configuration);TP.sys.environment=TP.hc(TP.sys.environment);if(TP.sys.cfg('tibet.plugins')){TP.boot.$configurePluginEnvironment();}b=TP.ac();b.push(function(){a='Initializing root canvas...';try{TP.ifTrace()?TP.trace(a,TP.LOG,arguments):0;TP.boot.$displayStatus(a);f=TP.sys.getUIRootName();if(TP.notValid(f)){throw new Error('InvalidUIRoot');}}catch(b){a='Canvas Initialization Error';TP.ifError()?TP.error(TP.ec(b,a),TP.LOG,arguments):0;TP.boot.$stderr(a,b);throw b;}});b.push(function(){var a='Initializing type proxies...';try{TP.ifTrace()?TP.trace(a,TP.LOG,arguments):0;TP.boot.$displayStatus(a);TP.sys.initializeTypeProxies();}catch(b){a='Proxy Initialization Error';TP.ifError()?TP.error(TP.ec(b,a),TP.LOG,arguments):0;TP.boot.$stderr(a,b);throw b;}});b.push(function(){var a='Initializing namespace support...';try{TP.ifTrace()?TP.trace(a,TP.LOG,arguments):0;TP.boot.$displayStatus(a);TP.core.Browser.installNativeNamespaces();TP.core.Browser.installNonNativeNamespaces();}catch(b){a='Namespace Initialization Error';TP.ifError()?TP.error(TP.ec(b,a),TP.LOG,arguments):0;TP.boot.$stderr(a,b);throw b;}});b.push(function(){var a='Initializing default locale...';try{TP.ifTrace()?TP.trace(a,TP.LOG,arguments):0;TP.boot.$displayStatus(a);if(TP.notEmpty(c=TP.sys.cfg('tibet.locale'))){d=TP.sys.require(c);if(TP.notValid(d)){a='Locale Initialization Error: '+c+' not found.';TP.boot.$stderr(a);TP.ifError()?TP.error(a,TP.LOG,arguments):0;TP.sys.setLocale();}else{TP.sys.setLocale(d);}}else{TP.sys.setLocale();}}catch(b){a='Locale Initialization Error';TP.ifError()?TP.error(TP.ec(b,a),TP.LOG,arguments):0;TP.boot.$stderr(a,b);throw b;}});h=function(b){var d,c,a;if(TP.isValid(b)){d=b.at('results');c=b.at('errors');}if(TP.isValid(c)&&c.getSize()>0){TP.boot.shouldStop('Infrastructure Initialization Failure.');TP.boot.$stderr('Initialization failure.',TP.FATAL);return;}a='TIBET Initialization complete.';TP.ifTrace()?TP.trace(a,TP.LOG,arguments):0;TP.boot.$displayStatus(a);TP.sys.hasInitialized(true);TP.boot.$setStage('rendering');TP.debug('break.rendering');TP.boot.$uitime=new Date();try{TP.computeCommonSizes();}catch(b){a='UI metrics/size computations failed.';TP.ifError()?TP.error(TP.ec(b,a),TP.LOG,arguments):0;TP.boot.$stderr(a,b);}TP.sys.loadUIRoot();};e=TP.sys.getTypeInitializers();g=function(a){var d,c;if(TP.isValid(a)){d=a.at('results');c=a.at('errors');}if(TP.isValid(c)&&c.getSize()>0){TP.boot.shouldStop('Type Initialization Failure(s).');TP.boot.$stderr('Initialization failure.',TP.FATAL);return;}b.invokeAsync(null,null,true);};g.observe(e,'TP.sig.InvokeComplete');h.observe(b,'TP.sig.InvokeComplete');try{a='Initializing TIBET types...';TP.ifTrace()?TP.trace(a,TP.LOG,arguments):0;TP.boot.$displayStatus(a);e.invokeAsync();}catch(b){a='TIBET Type Initialization Error';TP.ifError()?TP.error(TP.ec(b,a),TP.LOG,arguments):0;TP.boot.$stderr(a,b,TP.FATAL);}return;});TP.sys.defineMethod('loadUIRoot',function(){var c,b,d,e,a;c=TP.uriJoinPaths('~app_html',TP.sys.cfg('project.rootpage'));b=TP.uc(c);b=b.rewrite();if(TP.notValid(b)){TP.sys.raise('TP.sig.InvalidURI',arguments,c);TP.boot.$flushLog(true);}d=TP.sys.getUIRootName();if(TP.notValid(e=TP.sys.getWindowById(d))){TP.boot.$stderr('Canvas specification error. Cannot find window: '+d);TP.boot.$flushLog(true);return;}if(TP.boot.getUIRoot()!==TP.boot.getUIBoot()){TP.boot.hideUIRoot();}TP.elementDefaultDisplay(e.frameElement);a=TP.request();a.atPut('loadFunc',function(f){var b,e,c,d;if(TP.boot.shouldStop()){a.at('failFunc')(a);return;}b=TP.sys.require('TP.core.Application');if(TP.isElement(e=TP.documentGetBody(f))){if(TP.isElement(c=TP.nodeGetFirstChildElement(e))){d=TP.wrap(c);if(TP.canInvoke(d,'getApplicationType')){b=d.getApplicationType();}}}(function(){var a;if(TP.signal(TP.sys,'TP.sig.AppWillStart').shouldPrevent()){return;}a=function(){a.ignore(null,'TP.sig.AppDidStart');(function(){try{TP.boot.$setStage('liftoff');}finally{TP.sys.hasStarted(true);}}.afterUnwind());};a.observe(null,'TP.sig.AppDidStart');TP.signal(TP.sys,'TP.sig.AppStart',arguments,TP.hc('ApplicationType',b,'ApplicationElement',c));}.afterUnwind());});a.atPut('failFunc',function(c){var b,a;TP.boot.showUIBoot();a=c.getFaultText();b=TP.sc('UIRoot Initialization Error')+(a?': '+a+'.':'.');TP.boot.$stderr(b,TP.FATAL);});TP.wrap(e).setContent(b,a);return;});TP.sys.defineMethod('terminate',function(d){var b,c,a,e;b=TP.sys.getUICanvasName();if(TP.notValid(c=TP.sys.getWindowById(b))){TP.boot.$stderr('Canvas specification error. Cannot find window: '+b);return;}if(TP.isElement(TP.documentGetBody(c.document))){TP.elementSetAttribute(TP.documentGetBody(c.document),'allowUnload','true');}if(TP.isElement(TP.documentGetBody(window.document))){TP.elementSetAttribute(TP.documentGetBody(window.document),'allowUnload','true');}a=TP.uc(TP.ifInvalid(d,TP.sys.cfg('tibet.blankpage')));e=a.getLocation();if(e.match(/tibet:/)){TP.ifWarn()?TP.warn('Invalid termination URI provided: '+d,TP.LOG,arguments):0;a=TP.uc(TP.sys.cfg('tibet.blankpage'));}TP.core.Window.closeRegisteredWindows();TP.signal(TP.sys,'TP.sig.AppShutdown',arguments);window.location=a.getLocation();return;});TP.sys.hasKernel(true);
TP.boot.$srcPath = '~lib_src/tibet/content/TPRSSTypes.js';
TP.core.XMLDocumentNode.defineSubtype('RSSFeed');TP.core.RSSFeed.Inst.defineMethod('init',function(a,b){this.callNextMethod();if(TP.isNode(a)){this.$set('node',TP.nodeAddDefaultXMLNS(a,TP.w3.Xmlns.RSS20),false);}else{return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.isURI(b)){this.$set('uri',b.asString(),false);this.addTIBETSrc();}return this;});TP.core.RSSFeed.Inst.defineMethod('getChannelElement',function(){return this.getElementsByTagName('channel').first();});TP.core.ElementNode.defineSubtype('RSSElement');TP.core.RSSElement.isAbstract(true);TP.core.RSSElement.Type.defineMethod('getConcreteType',function(a){var b,c,d;b=TP.elementGetLocalName(a);if(b.toLowerCase()==='category'){if(TP.elementGetLocalName(a.parentNode).toLowerCase()==='channel'){return TP.core.RSSChannelCategory;}if(TP.elementGetLocalName(a.parentNode).toLowerCase()==='item'){return TP.core.RSSItemCategory;}}c='TP.core.RSS'+b.asTitleCase();if(!TP.isType(d=TP.sys.getTypeByName(c))){return TP.core.XMLElementNode;}return d;});TP.core.RSSElement.defineSubtype('RSSChannel');TP.core.RSSChannel.isAbstract(true);TP.core.RSSChannel.Type.defineAttribute('channelVersion');TP.core.RSSChannel.Type.defineMethod('canConstruct',function(a){var b,c;if(!TP.isElement(a)){return false;}b=TP.nodeGetDocument(a);if(TP.isEmpty(c=TP.nodeGetElementsByTagName(b,'rss'))){return false;}return TP.elementGetAttribute(c.first(),'version')===this.get('channelVersion');});TP.core.RSSChannel.Type.defineMethod('getConcreteType',function(a){return TP.lang.RootObject.getConcreteType.apply(this,arguments);});TP.core.RSSChannel.Inst.defineMethod('getVersion',function(){return this.getType().get('channelVersion');});TP.core.RSSChannel.Inst.defineMethod('getItems',function(){return this.getElementsByTagName('item');});TP.core.RSSChannel.defineSubtype('RSS091Channel');TP.core.RSS091Channel.set('channelVersion','0.91');TP.core.RSS091Channel.Inst.defineAttribute('title',{'value':TP.xpc('./$def:title',true).set('extractWith','value')});TP.core.RSS091Channel.Inst.defineAttribute('link',{'value':TP.xpc('./$def:link',true).set('extractWith','value')});TP.core.RSS091Channel.Inst.defineAttribute('description',{'value':TP.xpc('./$def:description',true).set('extractWith','value')});TP.core.RSS091Channel.Inst.defineAttribute('language',{'value':TP.xpc('./$def:language',true).set('extractWith','value')});TP.core.RSS091Channel.Inst.defineAttribute('copyright',{'value':TP.xpc('./$def:copyright',true).set('extractWith','value')});TP.core.RSS091Channel.Inst.defineAttribute('managingEditor',{'value':TP.xpc('./$def:managingEditor',true).set('extractWith','value')});TP.core.RSS091Channel.Inst.defineAttribute('webMaster',{'value':TP.xpc('./$def:webMaster',true).set('extractWith','value')});TP.core.RSS091Channel.Inst.defineAttribute('pubDate',{'value':TP.xpc('./$def:pubDate',true).set('extractWith','value')});TP.core.RSS091Channel.Inst.defineAttribute('lastBuildDate',{'value':TP.xpc('./$def:lastBuildDate',true).set('extractWith','value')});TP.core.RSS091Channel.Inst.defineAttribute('docs',{'value':TP.xpc('./$def:docs',true).set('extractWith','value')});TP.core.RSS091Channel.Inst.defineAttribute('rating',{'value':TP.xpc('./$def:rating',true).set('extractWith','value')});TP.core.RSS091Channel.Inst.defineAttribute('skipDays',{'value':TP.xpc('./$def:skipDays/$def:day',false).set('extractWith','value')});TP.core.RSS091Channel.Inst.defineAttribute('skipHours',{'value':TP.xpc('./$def:skipHours/$def:hour',false).set('extractWith','value')});TP.core.RSS091Channel.Inst.defineAttribute('items',{'value':TP.xpc('./$def:item',false).set('packageWith','TP.core.RSSItem')});TP.core.RSS091Channel.Inst.defineAttribute('image',{'value':TP.xpc('./$def:image',true).set('packageWith','TP.core.RSSImage')});TP.core.RSS091Channel.Inst.defineAttribute('textInput',{'value':TP.xpc('./$def:textInput',true).set('packageWith','TP.core.RSSTextInput')});TP.core.RSS091Channel.defineSubtype('RSS092Channel');TP.core.RSS092Channel.set('channelVersion','0.92');TP.core.RSS092Channel.Inst.defineAttribute('cloud',{'value':TP.xpc('./$def:cloud',true).set('packageWith','TP.core.RSSCloud')});TP.core.RSS092Channel.defineSubtype('RSS20Channel');TP.core.RSS20Channel.set('channelVersion','2.0');TP.core.RSS20Channel.Inst.defineAttribute('generator',{'value':TP.xpc('./$def:generator',true).set('extractWith','value')});TP.core.RSS20Channel.Inst.defineAttribute('ttl',{'value':TP.xpc('./$def:ttl',true).set('extractWith','value')});TP.core.RSS20Channel.Inst.defineAttribute('category',{'value':TP.xpc('./$def:category',true).set('packageWith','TP.core.RSSChannelCategory')});TP.core.RSSElement.defineSubtype('RSSChannelSubelement');TP.core.RSSChannelSubelement.Inst.defineMethod('getChannel',function(){return this.getDocument().getChannelElement();});TP.core.RSSChannelSubelement.defineSubtype('RSSChannelCategory');TP.core.RSSChannelSubelement.defineSubtype('RSSCloud');TP.core.RSSCloud.Inst.defineAttribute('domain',{'value':TP.xpc('./@domain',true).set('extractWith','value')});TP.core.RSSCloud.Inst.defineAttribute('port',{'value':TP.xpc('./@port',true).set('extractWith','value')});TP.core.RSSCloud.Inst.defineAttribute('path',{'value':TP.xpc('./@path',true).set('extractWith','value')});TP.core.RSSCloud.Inst.defineAttribute('registerProcedure',{'value':TP.xpc('./@registerProcedure',true).set('extractWith','value')});TP.core.RSSCloud.Inst.defineAttribute('protocol',{'value':TP.xpc('./@protocol',true).set('extractWith','value')});TP.core.RSSChannelSubelement.defineSubtype('RSSImage');TP.core.RSSImage.Inst.defineAttribute('title',{'value':TP.xpc('./$def:title',true).set('extractWith','value')});TP.core.RSSImage.Inst.defineAttribute('url',{'value':TP.xpc('./$def:url',true).set('extractWith','value')});TP.core.RSSImage.Inst.defineAttribute('link',{'value':TP.xpc('./$def:link',true).set('extractWith','value')});TP.core.RSSImage.Inst.defineAttribute('width',{'value':TP.xpc('./$def:width',true).set('extractWith','value')});TP.core.RSSImage.Inst.defineAttribute('height',{'value':TP.xpc('./$def:height',true).set('extractWith','value')});TP.core.RSSImage.Inst.defineAttribute('description',{'value':TP.xpc('./$def:description',true).set('extractWith','value')});TP.core.RSSChannelSubelement.defineSubtype('RSSItem');TP.core.RSSItem.isAbstract(true);TP.core.RSSItem.Type.defineAttribute('itemVersion');TP.core.RSSItem.Type.defineMethod('canConstruct',function(a){var b,c;if(TP.notValid(a)){return false;}b=TP.nodeGetDocument(a);if(TP.isEmpty(c=TP.nodeGetElementsByTagName(b,'rss'))){return false;}return TP.elementGetAttribute(c.first(),'version')===this.get('itemVersion');});TP.core.RSSItem.Type.defineMethod('getConcreteType',function(a){return TP.lang.RootObject.getConcreteType.apply(this,arguments);});TP.core.RSSItem.Inst.defineMethod('getVersion',function(){return this.getType().get('itemVersion');});TP.core.RSSItem.defineSubtype('RSS091Item');TP.core.RSS091Item.set('itemVersion','0.91');TP.core.RSS091Item.Inst.defineAttribute('title',{'value':TP.xpc('./$def:title',true).set('extractWith','value')});TP.core.RSS091Item.Inst.defineAttribute('link',{'value':TP.xpc('./$def:link',true).set('extractWith','value')});TP.core.RSS091Item.Inst.defineAttribute('description',{'value':TP.xpc('./$def:description',true).set('extractWith','value')});TP.core.RSS091Item.defineSubtype('RSS092Item');TP.core.RSS092Item.set('itemVersion','0.92');TP.core.RSS092Item.Inst.defineAttribute('category',{'value':TP.xpc('./$def:category',true).set('extractWith','value')});TP.core.RSS092Item.Inst.defineAttribute('enclosure',{'value':TP.xpc('./$def:enclosure',true).set('extractWith','value')});TP.core.RSS092Item.Inst.defineAttribute('source',{'value':TP.xpc('./$def:source',true).set('extractWith','value')});TP.core.RSS092Item.defineSubtype('RSS20Item');TP.core.RSS20Item.set('itemVersion','2.0');TP.core.RSS20Item.Inst.defineAttribute('comments',{'value':TP.xpc('./$def:comments',true).set('extractWith','value')});TP.core.RSS20Item.Inst.defineAttribute('author',{'value':TP.xpc('./$def:author',true).set('extractWith','value')});TP.core.RSS20Item.Inst.defineAttribute('pubDate',{'value':TP.xpc('./$def:pubDate',true).set('extractWith','value')});TP.core.RSS20Item.Inst.defineAttribute('guid',{'value':TP.xpc('./$def:guid',true).set('packageWith','TP.core.RSSGUID')});TP.core.RSSChannelSubelement.defineSubtype('RSSTextInput');TP.core.RSSTextInput.Inst.defineAttribute('title',{'value':TP.xpc('./$def:title',true).set('extractWith','value')});TP.core.RSSTextInput.Inst.defineAttribute('name',{'value':TP.xpc('./$def:name',true).set('extractWith','value')});TP.core.RSSTextInput.Inst.defineAttribute('link',{'value':TP.xpc('./$def:link',true).set('extractWith','value')});TP.core.RSSTextInput.Inst.defineAttribute('description',{'value':TP.xpc('./$def:description',true).set('extractWith','value')});TP.core.RSSElement.defineSubtype('RSSItemSubelement');TP.core.RSSItemSubelement.defineSubtype('RSSEnclosure');TP.core.RSSEnclosure.Inst.defineAttribute('length',{'value':TP.xpc('./@length',true).set('extractWith','value')});TP.core.RSSEnclosure.Inst.defineAttribute('enclosureType',{'value':TP.xpc('./@type',true).set('extractWith','value')});TP.core.RSSEnclosure.Inst.defineAttribute('url',{'value':TP.xpc('./@url',true).set('extractWith','value')});TP.core.RSSItemSubelement.defineSubtype('RSSGUID');TP.core.RSSGUID.Inst.defineAttribute('isPermaLink',{'value':TP.xpc('./@isPermaLink',true).set('extractWith','value')});TP.core.RSSItemSubelement.defineSubtype('RSSItemCategory');TP.core.RSSItemCategory.Inst.defineAttribute('domain',{'value':TP.xpc('./@domain',true).set('extractWith','value')});TP.core.RSSItemSubelement.defineSubtype('RSSSource');TP.core.RSSItemSubelement.Inst.defineAttribute('path',{'value':TP.xpc('./@url',true).set('extractWith','value')});
TP.boot.$srcPath = '~app/node_modules/tibet/deps/xpath-tpi.js';
!function(){a.prototype=new Object();a.prototype.constructor=a;a.superclass=Object.prototype;function a(){this.init();}a.prototype.init=function(){this.reduceActions=[];this.reduceActions[3]=function(a){return new C(a[0],a[2]);};this.reduceActions[5]=function(a){return new q(a[0],a[2]);};this.reduceActions[7]=function(a){return new y(a[0],a[2]);};this.reduceActions[8]=function(a){return new x(a[0],a[2]);};this.reduceActions[10]=function(a){return new v(a[0],a[2]);};this.reduceActions[11]=function(a){return new w(a[0],a[2]);};this.reduceActions[12]=function(a){return new B(a[0],a[2]);};this.reduceActions[13]=function(a){return new D(a[0],a[2]);};this.reduceActions[15]=function(a){return new E(a[0],a[2]);};this.reduceActions[16]=function(a){return new F(a[0],a[2]);};this.reduceActions[18]=function(a){return new r(a[0],a[2]);};this.reduceActions[19]=function(a){return new s(a[0],a[2]);};this.reduceActions[20]=function(a){return new t(a[0],a[2]);};this.reduceActions[22]=function(a){return new p(a[1]);};this.reduceActions[24]=function(a){return new u(a[0],a[2]);};this.reduceActions[25]=function(a){return new l(undefined,undefined,a[0]);};this.reduceActions[27]=function(a){a[0].locationPath=a[2];return a[0];};this.reduceActions[28]=function(a){a[0].locationPath=a[2];a[0].locationPath.steps.unshift(new b(b.DESCENDANTORSELF,new g(g.NODE,undefined),[]));return a[0];};this.reduceActions[29]=function(a){return new l(a[0],[],undefined);};this.reduceActions[30]=function(a){if(Utilities.instance_of(a[0],l)){if(a[0].filterPredicates==undefined){a[0].filterPredicates=[];}a[0].filterPredicates.push(a[1]);return a[0];}else{return new l(a[0],[a[1]],undefined);}};this.reduceActions[32]=function(a){return a[1];};this.reduceActions[33]=function(a){return new d(a[0]);};this.reduceActions[34]=function(a){return new f(a[0]);};this.reduceActions[36]=function(a){return new A(a[0],[]);};this.reduceActions[37]=function(a){return new A(a[0],a[2]);};this.reduceActions[38]=function(a){return[a[0]];};this.reduceActions[39]=function(a){a[2].unshift(a[0]);return a[2];};this.reduceActions[43]=function(a){return new G(true,[]);};this.reduceActions[44]=function(a){a[1].absolute=true;return a[1];};this.reduceActions[46]=function(a){return new G(false,[a[0]]);};this.reduceActions[47]=function(a){a[0].steps.push(a[2]);return a[0];};this.reduceActions[49]=function(a){return new b(a[0],a[1],[]);};this.reduceActions[50]=function(a){return new b(b.CHILD,a[0],[]);};this.reduceActions[51]=function(a){return new b(a[0],a[1],a[2]);};this.reduceActions[52]=function(a){return new b(b.CHILD,a[0],a[1]);};this.reduceActions[54]=function(a){return[a[0]];};this.reduceActions[55]=function(a){a[1].unshift(a[0]);return a[1];};this.reduceActions[56]=function(a){if(a[0]=='ancestor'){return b.ANCESTOR;}else if(a[0]=='ancestor-or-self'){return b.ANCESTORORSELF;}else if(a[0]=='attribute'){return b.ATTRIBUTE;}else if(a[0]=='child'){return b.CHILD;}else if(a[0]=='descendant'){return b.DESCENDANT;}else if(a[0]=='descendant-or-self'){return b.DESCENDANTORSELF;}else if(a[0]=='following'){return b.FOLLOWING;}else if(a[0]=='following-sibling'){return b.FOLLOWINGSIBLING;}else if(a[0]=='namespace'){return b.NAMESPACE;}else if(a[0]=='parent'){return b.PARENT;}else if(a[0]=='preceding'){return b.PRECEDING;}else if(a[0]=='preceding-sibling'){return b.PRECEDINGSIBLING;}else if(a[0]=='self'){return b.SELF;}return-1;};this.reduceActions[57]=function(a){return b.ATTRIBUTE;};this.reduceActions[59]=function(a){if(a[0]=='comment'){return new g(g.COMMENT,undefined);}else if(a[0]=='text'){return new g(g.TEXT,undefined);}else if(a[0]=='processing-instruction'){return new g(g.PI,undefined);}else if(a[0]=='node'){return new g(g.NODE,undefined);}return new g(-1,undefined);};this.reduceActions[60]=function(a){return new g(g.PI,a[2]);};this.reduceActions[61]=function(a){return a[1];};this.reduceActions[63]=function(a){a[1].absolute=true;a[1].steps.unshift(new b(b.DESCENDANTORSELF,new g(g.NODE,undefined),[]));return a[1];};this.reduceActions[64]=function(a){a[0].steps.push(new b(b.DESCENDANTORSELF,new g(g.NODE,undefined),[]));a[0].steps.push(a[2]);return a[0];};this.reduceActions[65]=function(a){return new b(b.SELF,new g(g.NODE,undefined),[]);};this.reduceActions[66]=function(a){return new b(b.PARENT,new g(g.NODE,undefined),[]);};this.reduceActions[67]=function(a){return new K(a[1]);};this.reduceActions[68]=function(a){return new g(g.NAMETESTANY,undefined);};this.reduceActions[69]=function(a){var b=a[0].substring(0,a[0].indexOf(':'));return new g(g.NAMETESTPREFIXANY,b);};this.reduceActions[70]=function(a){return new g(g.NAMETESTQNAME,a[0]);};};a.actionTable=[' s s        sssssssss    s ss  s  ss','                 s                  ','r  rrrrrrrrr         rrrrrrr rr  r  ','                rrrrr               ',' s s        sssssssss    s ss  s  ss','rs  rrrrrrrr s  sssssrrrrrr  rrs rs ',' s s        sssssssss    s ss  s  ss','                            s       ','                            s       ','r  rrrrrrrrr         rrrrrrr rr rr  ','r  rrrrrrrrr         rrrrrrr rr rr  ','r  rrrrrrrrr         rrrrrrr rr rr  ','r  rrrrrrrrr         rrrrrrr rr rr  ','r  rrrrrrrrr         rrrrrrr rr rr  ','  s                                 ','                            s       ',' s           s  sssss          s  s ','r  rrrrrrrrr         rrrrrrr rr  r  ','a                                   ','r       s                    rr  r  ','r      sr                    rr  r  ','r   s  rr            s       rr  r  ','r   rssrr            rss     rr  r  ','r   rrrrr            rrrss   rr  r  ','r   rrrrrsss         rrrrr   rr  r  ','r   rrrrrrrr         rrrrr   rr  r  ','r   rrrrrrrr         rrrrrs  rr  r  ','r   rrrrrrrr         rrrrrr  rr  r  ','r   rrrrrrrr         rrrrrr  rr  r  ','r  srrrrrrrr         rrrrrrs rr sr  ','r  srrrrrrrr         rrrrrrs rr  r  ','r  rrrrrrrrr         rrrrrrr rr rr  ','r  rrrrrrrrr         rrrrrrr rr rr  ','r  rrrrrrrrr         rrrrrrr rr rr  ','r   rrrrrrrr         rrrrrr  rr  r  ','r   rrrrrrrr         rrrrrr  rr  r  ','r  rrrrrrrrr         rrrrrrr rr  r  ','r  rrrrrrrrr         rrrrrrr rr  r  ','                sssss               ','r  rrrrrrrrr         rrrrrrr rr sr  ','r  rrrrrrrrr         rrrrrrr rr  r  ','r  rrrrrrrrr         rrrrrrr rr rr  ','r  rrrrrrrrr         rrrrrrr rr rr  ','                             s      ','r  srrrrrrrr         rrrrrrs rr  r  ','r   rrrrrrrr         rrrrr   rr  r  ','              s                     ','                             s      ','                rrrrr               ',' s s        sssssssss    s sss s  ss','r  srrrrrrrr         rrrrrrs rr  r  ',' s s        sssssssss    s ss  s  ss',' s s        sssssssss    s ss  s  ss',' s s        sssssssss    s ss  s  ss',' s s        sssssssss    s ss  s  ss',' s s        sssssssss    s ss  s  ss',' s s        sssssssss    s ss  s  ss',' s s        sssssssss    s ss  s  ss',' s s        sssssssss    s ss  s  ss',' s s        sssssssss    s ss  s  ss',' s s        sssssssss    s ss  s  ss',' s s        sssssssss    s ss  s  ss',' s s        sssssssss    s ss  s  ss',' s s        sssssssss    s ss  s  ss',' s s        sssssssss      ss  s  ss',' s s        sssssssss    s ss  s  ss',' s           s  sssss          s  s ',' s           s  sssss          s  s ','r  rrrrrrrrr         rrrrrrr rr rr  ',' s           s  sssss          s  s ',' s           s  sssss          s  s ','r  rrrrrrrrr         rrrrrrr rr sr  ','r  rrrrrrrrr         rrrrrrr rr sr  ','r  rrrrrrrrr         rrrrrrr rr  r  ','r  rrrrrrrrr         rrrrrrr rr rr  ','                             s      ','r  rrrrrrrrr         rrrrrrr rr rr  ','r  rrrrrrrrr         rrrrrrr rr rr  ','                             rr     ','                             s      ','                             rs     ','r      sr                    rr  r  ','r   s  rr            s       rr  r  ','r   rssrr            rss     rr  r  ','r   rssrr            rss     rr  r  ','r   rrrrr            rrrss   rr  r  ','r   rrrrr            rrrss   rr  r  ','r   rrrrr            rrrss   rr  r  ','r   rrrrr            rrrss   rr  r  ','r   rrrrrsss         rrrrr   rr  r  ','r   rrrrrsss         rrrrr   rr  r  ','r   rrrrrrrr         rrrrr   rr  r  ','r   rrrrrrrr         rrrrr   rr  r  ','r   rrrrrrrr         rrrrr   rr  r  ','r   rrrrrrrr         rrrrrr  rr  r  ','                                 r  ','                                 s  ','r  srrrrrrrr         rrrrrrs rr  r  ','r  srrrrrrrr         rrrrrrs rr  r  ','r  rrrrrrrrr         rrrrrrr rr  r  ','r  rrrrrrrrr         rrrrrrr rr  r  ','r  rrrrrrrrr         rrrrrrr rr  r  ','r  rrrrrrrrr         rrrrrrr rr  r  ','r  rrrrrrrrr         rrrrrrr rr rr  ','r  rrrrrrrrr         rrrrrrr rr rr  ',' s s        sssssssss    s ss  s  ss','r  rrrrrrrrr         rrrrrrr rr rr  ','                             r      '];a.actionTableNumber=[' 1 0        /.-,+*)(\'    & %$  #  "!','                 J                  ','a  aaaaaaaaa         aaaaaaa aa  a  ','                YYYYY               ',' 1 0        /.-,+*)(\'    & %$  #  "!','K1  KKKKKKKK .  +*)(\'KKKKKK  KK# K" ',' 1 0        /.-,+*)(\'    & %$  #  "!','                            N       ','                            O       ','e  eeeeeeeee         eeeeeee ee ee  ','f  fffffffff         fffffff ff ff  ','d  ddddddddd         ddddddd dd dd  ','B  BBBBBBBBB         BBBBBBB BB BB  ','A  AAAAAAAAA         AAAAAAA AA AA  ','  P                                 ','                            Q       ',' 1           .  +*)(\'          #  " ','b  bbbbbbbbb         bbbbbbb bb  b  ','                                    ','!       S                    !!  !  ','"      T"                    ""  "  ','$   V  $$            U       $$  $  ','&   &ZY&&            &XW     &&  &  ',')   )))))            )))\\[   ))  )  ','.   ....._^]         .....   ..  .  ','1   11111111         11111   11  1  ','5   55555555         55555`  55  5  ','7   77777777         777777  77  7  ','9   99999999         999999  99  9  ',':  c::::::::         ::::::b :: a:  ','I  fIIIIIIII         IIIIIIe II  I  ','=  =========         ======= == ==  ','?  ?????????         ??????? ?? ??  ','C  CCCCCCCCC         CCCCCCC CC CC  ','J   JJJJJJJJ         JJJJJJ  JJ  J  ','M   MMMMMMMM         MMMMMM  MM  M  ','N  NNNNNNNNN         NNNNNNN NN  N  ','P  PPPPPPPPP         PPPPPPP PP  P  ','                +*)(\'               ','R  RRRRRRRRR         RRRRRRR RR aR  ','U  UUUUUUUUU         UUUUUUU UU  U  ','Z  ZZZZZZZZZ         ZZZZZZZ ZZ ZZ  ','c  ccccccccc         ccccccc cc cc  ','                             j      ','L  fLLLLLLLL         LLLLLLe LL  L  ','6   66666666         66666   66  6  ','              k                     ','                             l      ','                XXXXX               ',' 1 0        /.-,+*)(\'    & %$m #  "!','_  f________         ______e __  _  ',' 1 0        /.-,+*)(\'    & %$  #  "!',' 1 0        /.-,+*)(\'    & %$  #  "!',' 1 0        /.-,+*)(\'    & %$  #  "!',' 1 0        /.-,+*)(\'    & %$  #  "!',' 1 0        /.-,+*)(\'    & %$  #  "!',' 1 0        /.-,+*)(\'    & %$  #  "!',' 1 0        /.-,+*)(\'    & %$  #  "!',' 1 0        /.-,+*)(\'    & %$  #  "!',' 1 0        /.-,+*)(\'    & %$  #  "!',' 1 0        /.-,+*)(\'    & %$  #  "!',' 1 0        /.-,+*)(\'    & %$  #  "!',' 1 0        /.-,+*)(\'    & %$  #  "!',' 1 0        /.-,+*)(\'    & %$  #  "!',' 1 0        /.-,+*)(\'      %$  #  "!',' 1 0        /.-,+*)(\'    & %$  #  "!',' 1           .  +*)(\'          #  " ',' 1           .  +*)(\'          #  " ','>  >>>>>>>>>         >>>>>>> >> >>  ',' 1           .  +*)(\'          #  " ',' 1           .  +*)(\'          #  " ','Q  QQQQQQQQQ         QQQQQQQ QQ aQ  ','V  VVVVVVVVV         VVVVVVV VV aV  ','T  TTTTTTTTT         TTTTTTT TT  T  ','@  @@@@@@@@@         @@@@@@@ @@ @@  ','                             \x87      ','[  [[[[[[[[[         [[[[[[[ [[ [[  ','D  DDDDDDDDD         DDDDDDD DD DD  ','                             HH     ','                             \x88      ','                             F\x89     ','#      T#                    ##  #  ','%   V  %            U       %  %  ','\'   \'ZY\'\'            \'XW     \'\'  \'  ','(   (ZY((            (XW     ((  (  ','+   +++++            +++\\[   ++  +  ','*   *****            ***\\[   **  *  ','-   -----            ---\\[   --  -  ',',   ,,,,,            ,,,\\[   ,,  ,  ','0   00000_^]         00000   00  0  ','/   /////_^]         /////   //  /  ','2   22222222         22222   22  2  ','3   33333333         33333   33  3  ','4   44444444         44444   44  4  ','8   88888888         888888  88  8  ','                                 ^  ','                                 \x8A  ',';  f;;;;;;;;         ;;;;;;e ;;  ;  ','<  f<<<<<<<<         <<<<<<e <<  <  ','O  OOOOOOOOO         OOOOOOO OO  O  ','`  `````````         ``````` ``  `  ','S  SSSSSSSSS         SSSSSSS SS  S  ','W  WWWWWWWWW         WWWWWWW WW  W  ','\\  \\\\\\\\\\\\\\\\\\         \\\\\\\\\\\\\\ \\\\ \\\\  ','E  EEEEEEEEE         EEEEEEE EE EE  ',' 1 0        /.-,+*)(\'    & %$  #  "!',']  ]]]]]]]]]         ]]]]]]] ]] ]]  ','                             G      '];a.gotoTable=['3456789:;<=>?@ AB  CDEFGH IJ ','                             ','                             ','                             ','L456789:;<=>?@ AB  CDEFGH IJ ','            M        EFGH IJ ','       N;<=>?@ AB  CDEFGH IJ ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','            S        EFGH IJ ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','              e              ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                        h  J ','              i          j   ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','o456789:;<=>?@ ABpqCDEFGH IJ ','                             ','  r6789:;<=>?@ AB  CDEFGH IJ ','   s789:;<=>?@ AB  CDEFGH IJ ','    t89:;<=>?@ AB  CDEFGH IJ ','    u89:;<=>?@ AB  CDEFGH IJ ','     v9:;<=>?@ AB  CDEFGH IJ ','     w9:;<=>?@ AB  CDEFGH IJ ','     x9:;<=>?@ AB  CDEFGH IJ ','     y9:;<=>?@ AB  CDEFGH IJ ','      z:;<=>?@ AB  CDEFGH IJ ','      {:;<=>?@ AB  CDEFGH IJ ','       |;<=>?@ AB  CDEFGH IJ ','       };<=>?@ AB  CDEFGH IJ ','       ~;<=>?@ AB  CDEFGH IJ ','         \x7F=>?@ AB  CDEFGH IJ ','\x80456789:;<=>?@ AB  CDEFGH IJ\x81','            \x82        EFGH IJ ','            \x83        EFGH IJ ','                             ','                     \x84 GH IJ ','                     \x85 GH IJ ','              i          \x86   ','              i          \x87   ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','                             ','o456789:;<=>?@ AB\x8CqCDEFGH IJ ','                             ','                             '];a.productions=[[1,1,2],[2,1,3],[3,1,4],[3,3,3,-9,4],[4,1,5],[4,3,4,-8,5],[5,1,6],[5,3,5,-22,6],[5,3,5,-5,6],[6,1,7],[6,3,6,-23,7],[6,3,6,-24,7],[6,3,6,-6,7],[6,3,6,-7,7],[7,1,8],[7,3,7,-25,8],[7,3,7,-26,8],[8,1,9],[8,3,8,-12,9],[8,3,8,-11,9],[8,3,8,-10,9],[9,1,10],[9,2,-26,9],[10,1,11],[10,3,10,-27,11],[11,1,12],[11,1,13],[11,3,13,-28,14],[11,3,13,-4,14],[13,1,15],[13,2,13,16],[15,1,17],[15,3,-29,2,-30],[15,1,-15],[15,1,-16],[15,1,18],[18,3,-13,-29,-30],[18,4,-13,-29,19,-30],[19,1,20],[19,3,20,-31,19],[20,1,2],[12,1,14],[12,1,21],[21,1,-28],[21,2,-28,14],[21,1,22],[14,1,23],[14,3,14,-28,23],[14,1,24],[23,2,25,26],[23,1,26],[23,3,25,26,27],[23,2,26,27],[23,1,28],[27,1,16],[27,2,16,27],[25,2,-14,-3],[25,1,-32],[26,1,29],[26,3,-20,-29,-30],[26,4,-21,-29,-15,-30],[16,3,-33,30,-34],[30,1,2],[22,2,-4,14],[24,3,14,-4,23],[28,1,-35],[28,1,-2],[17,2,-36,-18],[29,1,-17],[29,1,-19],[29,1,-18]];a.DOUBLEDOT=2;a.DOUBLECOLON=3;a.DOUBLESLASH=4;a.NOTEQUAL=5;a.LESSTHANOREQUAL=6;a.GREATERTHANOREQUAL=7;a.AND=8;a.OR=9;a.MOD=10;a.DIV=11;a.MULTIPLYOPERATOR=12;a.FUNCTIONNAME=13;a.AXISNAME=14;a.LITERAL=15;a.NUMBER=16;a.ASTERISKNAMETEST=17;a.QNAME=18;a.NCNAMECOLONASTERISK=19;a.NODETYPE=20;a.PROCESSINGINSTRUCTIONWITHLITERAL=21;a.EQUALS=22;a.LESSTHAN=23;a.GREATERTHAN=24;a.PLUS=25;a.MINUS=26;a.BAR=27;a.SLASH=28;a.LEFTPARENTHESIS=29;a.RIGHTPARENTHESIS=30;a.COMMA=31;a.AT=32;a.LEFTBRACKET=33;a.RIGHTBRACKET=34;a.DOT=35;a.DOLLAR=36;a.prototype.tokenize=function(l){var e=[];var g=[];var d=l+'\0';var c=0;var b=d.charAt(c++);while(1){while(b==' '||b=='\t'||b=='\r'||b=='\n'){b=d.charAt(c++);}if(b=='\0'||c>=d.length){break;}if(b=='('){e.push(a.LEFTPARENTHESIS);g.push(b);b=d.charAt(c++);continue;}if(b==')'){e.push(a.RIGHTPARENTHESIS);g.push(b);b=d.charAt(c++);continue;}if(b=='['){e.push(a.LEFTBRACKET);g.push(b);b=d.charAt(c++);continue;}if(b==']'){e.push(a.RIGHTBRACKET);g.push(b);b=d.charAt(c++);continue;}if(b=='@'){e.push(a.AT);g.push(b);b=d.charAt(c++);continue;}if(b==','){e.push(a.COMMA);g.push(b);b=d.charAt(c++);continue;}if(b=='|'){e.push(a.BAR);g.push(b);b=d.charAt(c++);continue;}if(b=='+'){e.push(a.PLUS);g.push(b);b=d.charAt(c++);continue;}if(b=='-'){e.push(a.MINUS);g.push(b);b=d.charAt(c++);continue;}if(b=='='){e.push(a.EQUALS);g.push(b);b=d.charAt(c++);continue;}if(b=='$'){e.push(a.DOLLAR);g.push(b);b=d.charAt(c++);continue;}if(b=='.'){b=d.charAt(c++);if(b=='.'){e.push(a.DOUBLEDOT);g.push('..');b=d.charAt(c++);continue;}if(b>='0'&&b<='9'){var i='.'+b;b=d.charAt(c++);while(b>='0'&&b<='9'){i+=b;b=d.charAt(c++);}e.push(a.NUMBER);g.push(i);continue;}e.push(a.DOT);g.push('.');continue;}if(b=='\''||b=='"'){var k=b;var j='';while((b=d.charAt(c++))!=k&&b!=''){j+=b;}if(b==''){throw new Error('Unclosed literal:\''+j+'\'');}e.push(a.LITERAL);g.push(j);b=d.charAt(c++);continue;}if(b>='0'&&b<='9'){var i=b;b=d.charAt(c++);while(b>='0'&&b<='9'){i+=b;b=d.charAt(c++);}if(b=='.'){if(d.charAt(c)>='0'&&d.charAt(c)<='9'){i+=b;i+=d.charAt(c++);b=d.charAt(c++);while(b>='0'&&b<='9'){i+=b;b=d.charAt(c++);}}}e.push(a.NUMBER);g.push(i);continue;}if(b=='*'){if(e.length>0){var f=e[e.length-1];if(f!=a.AT&&f!=a.DOUBLECOLON&&f!=a.LEFTPARENTHESIS&&f!=a.LEFTBRACKET&&f!=a.AND&&f!=a.OR&&f!=a.MOD&&f!=a.DIV&&f!=a.MULTIPLYOPERATOR&&f!=a.SLASH&&f!=a.DOUBLESLASH&&f!=a.BAR&&f!=a.PLUS&&f!=a.MINUS&&f!=a.EQUALS&&f!=a.NOTEQUAL&&f!=a.LESSTHAN&&f!=a.LESSTHANOREQUAL&&f!=a.GREATERTHAN&&f!=a.GREATERTHANOREQUAL){e.push(a.MULTIPLYOPERATOR);g.push(b);b=d.charAt(c++);continue;}}e.push(a.ASTERISKNAMETEST);g.push(b);b=d.charAt(c++);continue;}if(b==':'){if(d.charAt(c)==':'){e.push(a.DOUBLECOLON);g.push('::');c++;b=d.charAt(c++);continue;}}if(b=='/'){b=d.charAt(c++);if(b=='/'){e.push(a.DOUBLESLASH);g.push('//');b=d.charAt(c++);continue;}e.push(a.SLASH);g.push('/');continue;}if(b=='!'){if(d.charAt(c)=='='){e.push(a.NOTEQUAL);g.push('!=');c++;b=d.charAt(c++);continue;}}if(b=='<'){if(d.charAt(c)=='='){e.push(a.LESSTHANOREQUAL);g.push('<=');c++;b=d.charAt(c++);continue;}e.push(a.LESSTHAN);g.push('<');b=d.charAt(c++);continue;}if(b=='>'){if(d.charAt(c)=='='){e.push(a.GREATERTHANOREQUAL);g.push('>=');c++;b=d.charAt(c++);continue;}e.push(a.GREATERTHAN);g.push('>');b=d.charAt(c++);continue;}if(b=='_'||Utilities.isLetter(b.charCodeAt(0))){var h=b;b=d.charAt(c++);while(Utilities.isNCNameChar(b.charCodeAt(0))){h+=b;b=d.charAt(c++);}if(e.length>0){var f=e[e.length-1];if(f!=a.AT&&f!=a.DOUBLECOLON&&f!=a.LEFTPARENTHESIS&&f!=a.LEFTBRACKET&&f!=a.AND&&f!=a.OR&&f!=a.MOD&&f!=a.DIV&&f!=a.MULTIPLYOPERATOR&&f!=a.SLASH&&f!=a.DOUBLESLASH&&f!=a.BAR&&f!=a.PLUS&&f!=a.MINUS&&f!=a.EQUALS&&f!=a.NOTEQUAL&&f!=a.LESSTHAN&&f!=a.LESSTHANOREQUAL&&f!=a.GREATERTHAN&&f!=a.GREATERTHANOREQUAL){if(h=='and'){e.push(a.AND);g.push(h);continue;}if(h=='or'){e.push(a.OR);g.push(h);continue;}if(h=='mod'){e.push(a.MOD);g.push(h);continue;}if(h=='div'){e.push(a.DIV);g.push(h);continue;}}}if(b==':'){if(d.charAt(c)=='*'){e.push(a.NCNAMECOLONASTERISK);g.push(h+':*');c++;b=d.charAt(c++);continue;}if(d.charAt(c)=='_'||Utilities.isLetter(d.charCodeAt(c))){h+=':';b=d.charAt(c++);while(Utilities.isNCNameChar(b.charCodeAt(0))){h+=b;b=d.charAt(c++);}if(b=='('){e.push(a.FUNCTIONNAME);g.push(h);continue;}e.push(a.QNAME);g.push(h);continue;}if(d.charAt(c)==':'){e.push(a.AXISNAME);g.push(h);continue;}}if(b=='('){if(h=='comment'||h=='text'||h=='node'){e.push(a.NODETYPE);g.push(h);continue;}if(h=='processing-instruction'){if(d.charAt(c)==')'){e.push(a.NODETYPE);}else{e.push(a.PROCESSINGINSTRUCTIONWITHLITERAL);}g.push(h);continue;}e.push(a.FUNCTIONNAME);g.push(h);continue;}e.push(a.QNAME);g.push(h);continue;}throw new Error('Unexpected character '+b);}e.push(1);g.push('[EOF]');return[e,g];};a.SHIFT='s';a.REDUCE='r';a.ACCEPT='a';a.prototype.parse=function(b){var j;var k;var h=this.tokenize(b);if(h==undefined){return undefined;}j=h[0];k=h[1];var f=0;var d=[];var g=[];var e=[];var b;var c;var l;d.push(0);g.push(1);e.push('_S');c=j[f];l=k[f++];while(1){b=d[d.length-1];switch(a.actionTable[b].charAt(c-1)){case a.SHIFT:g.push(-c);e.push(l);d.push(a.actionTableNumber[b].charCodeAt(c-1)-32);c=j[f];l=k[f++];break;case a.REDUCE:var p=a.productions[a.actionTableNumber[b].charCodeAt(c-1)-32][1];var i=[];for(var m=0;m<p;m++){g.pop();i.unshift(e.pop());d.pop();}var n=d[d.length-1];g.push(a.productions[a.actionTableNumber[b].charCodeAt(c-1)-32][0]);if(this.reduceActions[a.actionTableNumber[b].charCodeAt(c-1)-32]==undefined){e.push(i[0]);}else{e.push(this.reduceActions[a.actionTableNumber[b].charCodeAt(c-1)-32](i));}d.push(a.gotoTable[n].charCodeAt(a.productions[a.actionTableNumber[b].charCodeAt(c-1)-32][0]-2)-33);break;case a.ACCEPT:return new o(e.pop());default:throw new Error('XPath parse error');}}};o.prototype=new Object();o.prototype.constructor=o;o.superclass=Object.prototype;function o(a){this.expression=a;}o.prototype.toString=function(){return this.expression.toString();};o.prototype.evaluate=function(a){a.contextNode=a.expressionContextNode;a.contextSize=1;a.contextPosition=1;a.caseInsensitive=false;if(a.contextNode!=null){var b=a.contextNode;if(b.nodeType!=9){b=b.ownerDocument;}try{a.caseInsensitive=b.implementation.hasFeature('HTML','2.0');}catch(b){a.caseInsensitive=true;}}return this.expression.evaluate(a);};o.XML_NAMESPACE_URI='http://www.w3.org/XML/1998/namespace';o.XMLNS_NAMESPACE_URI='http://www.w3.org/2000/xmlns/';k.prototype=new Object();k.prototype.constructor=k;k.superclass=Object.prototype;function k(){}k.prototype.init=function(){};k.prototype.toString=function(){return'<Expression>';};k.prototype.toReplacedString=function(a){;};k.prototype.evaluate=function(a){throw new Error('Could not evaluate expression.');};k.prototype.gatherLocationPathsInto=function(a){;};L.prototype=new k();L.prototype.constructor=L;L.superclass=k.prototype;function L(a){if(arguments.length>0){this.init(a);}}L.prototype.init=function(a){this.rhs=a;};p.prototype=new L();p.prototype.constructor=p;p.superclass=L.prototype;function p(a){if(arguments.length>0){this.init(a);}}p.prototype.init=function(a){p.superclass.init.call(this,a);};p.prototype.evaluate=function(a){return this.rhs.evaluate(a).number().negate();};p.prototype.toString=function(){return'-'+this.rhs.toString();};p.prototype.toReplacedString=function(a){return'-'+this.rhs.toReplacedString(a);};p.prototype.gatherLocationPathsInto=function(a){this.rhs.gatherLocationPathsInto(a);};j.prototype=new k();j.prototype.constructor=j;j.superclass=k.prototype;function j(a,b){if(arguments.length>0){this.init(a,b);}}j.prototype.init=function(a,b){this.lhs=a;this.rhs=b;};j.prototype.toReplacedString=function(a){return'('+this.lhs.toReplacedString(a)+' '+this.constructor.prototype.operator+' '+this.rhs.toReplacedString(a)+')';};j.prototype.gatherLocationPathsInto=function(a){this.lhs.gatherLocationPathsInto(a);this.rhs.gatherLocationPathsInto(a);};C.prototype=new j();C.prototype.constructor=C;C.prototype.operator='or';C.superclass=j.prototype;function C(a,b){if(arguments.length>0){this.init(a,b);}}C.prototype.init=function(a,b){C.superclass.init.call(this,a,b);};C.prototype.toString=function(){return'('+this.lhs.toString()+' or '+this.rhs.toString()+')';};C.prototype.evaluate=function(b){var a=this.lhs.evaluate(b).bool();if(a.booleanValue()){return a;}return this.rhs.evaluate(b).bool();};q.prototype=new j();q.prototype.constructor=q;q.prototype.operator='and';q.superclass=j.prototype;function q(a,b){if(arguments.length>0){this.init(a,b);}}q.prototype.init=function(a,b){q.superclass.init.call(this,a,b);};q.prototype.toString=function(){return'('+this.lhs.toString()+' and '+this.rhs.toString()+')';};q.prototype.evaluate=function(b){var a=this.lhs.evaluate(b).bool();if(!a.booleanValue()){return a;}return this.rhs.evaluate(b).bool();};y.prototype=new j();y.prototype.constructor=y;y.prototype.operator='=';y.superclass=j.prototype;function y(a,b){if(arguments.length>0){this.init(a,b);}}y.prototype.init=function(a,b){y.superclass.init.call(this,a,b);};y.prototype.toString=function(){return'('+this.lhs.toString()+' = '+this.rhs.toString()+')';};y.prototype.evaluate=function(a){return this.lhs.evaluate(a).equals(this.rhs.evaluate(a));};x.prototype=new j();x.prototype.constructor=x;x.prototype.operator='!=';x.superclass=j.prototype;function x(a,b){if(arguments.length>0){this.init(a,b);}}x.prototype.init=function(a,b){x.superclass.init.call(this,a,b);};x.prototype.toString=function(){return'('+this.lhs.toString()+' != '+this.rhs.toString()+')';};x.prototype.evaluate=function(a){return this.lhs.evaluate(a).notequal(this.rhs.evaluate(a));};v.prototype=new j();v.prototype.constructor=v;v.prototype.operator='<';v.superclass=j.prototype;function v(a,b){if(arguments.length>0){this.init(a,b);}}v.prototype.init=function(a,b){v.superclass.init.call(this,a,b);};v.prototype.evaluate=function(a){return this.lhs.evaluate(a).lessthan(this.rhs.evaluate(a));};v.prototype.toString=function(){return'('+this.lhs.toString()+' < '+this.rhs.toString()+')';};w.prototype=new j();w.prototype.constructor=w;w.prototype.operator='>';w.superclass=j.prototype;function w(a,b){if(arguments.length>0){this.init(a,b);}}w.prototype.init=function(a,b){w.superclass.init.call(this,a,b);};w.prototype.evaluate=function(a){return this.lhs.evaluate(a).greaterthan(this.rhs.evaluate(a));};w.prototype.toString=function(){return'('+this.lhs.toString()+' > '+this.rhs.toString()+')';};B.prototype=new j();B.prototype.constructor=B;B.prototype.operator='<=';B.superclass=j.prototype;function B(a,b){if(arguments.length>0){this.init(a,b);}}B.prototype.init=function(a,b){B.superclass.init.call(this,a,b);};B.prototype.evaluate=function(a){return this.lhs.evaluate(a).lessthanorequal(this.rhs.evaluate(a));};B.prototype.toString=function(){return'('+this.lhs.toString()+' <= '+this.rhs.toString()+')';};D.prototype=new j();D.prototype.constructor=D;D.prototype.operator='>=';D.superclass=j.prototype;function D(a,b){if(arguments.length>0){this.init(a,b);}}D.prototype.init=function(a,b){D.superclass.init.call(this,a,b);};D.prototype.evaluate=function(a){return this.lhs.evaluate(a).greaterthanorequal(this.rhs.evaluate(a));};D.prototype.toString=function(){return'('+this.lhs.toString()+' >= '+this.rhs.toString()+')';};E.prototype=new j();E.prototype.constructor=E;E.prototype.operator='+';E.superclass=j.prototype;function E(a,b){if(arguments.length>0){this.init(a,b);}}E.prototype.init=function(a,b){E.superclass.init.call(this,a,b);};E.prototype.evaluate=function(a){return this.lhs.evaluate(a).number().plus(this.rhs.evaluate(a).number());};E.prototype.toString=function(){return'('+this.lhs.toString()+' + '+this.rhs.toString()+')';};F.prototype=new j();F.prototype.constructor=F;F.prototype.operator='-';F.superclass=j.prototype;function F(a,b){if(arguments.length>0){this.init(a,b);}}F.prototype.init=function(a,b){F.superclass.init.call(this,a,b);};F.prototype.evaluate=function(a){return this.lhs.evaluate(a).number().minus(this.rhs.evaluate(a).number());};F.prototype.toString=function(){return'('+this.lhs.toString()+' - '+this.rhs.toString()+')';};r.prototype=new j();r.prototype.constructor=r;r.prototype.operator='*';r.superclass=j.prototype;function r(a,b){if(arguments.length>0){this.init(a,b);}}r.prototype.init=function(a,b){r.superclass.init.call(this,a,b);};r.prototype.evaluate=function(a){return this.lhs.evaluate(a).number().multiply(this.rhs.evaluate(a).number());};r.prototype.toString=function(){return'('+this.lhs.toString()+' * '+this.rhs.toString()+')';};s.prototype=new j();s.prototype.constructor=s;s.prototype.operator='div';s.superclass=j.prototype;function s(a,b){if(arguments.length>0){this.init(a,b);}}s.prototype.init=function(a,b){s.superclass.init.call(this,a,b);};s.prototype.evaluate=function(a){return this.lhs.evaluate(a).number().div(this.rhs.evaluate(a).number());};s.prototype.toString=function(){return'('+this.lhs.toString()+' div '+this.rhs.toString()+')';};t.prototype=new j();t.prototype.constructor=t;t.prototype.operator='mod';t.superclass=j.prototype;function t(a,b){if(arguments.length>0){this.init(a,b);}}t.prototype.init=function(a,b){t.superclass.init.call(this,a,b);};t.prototype.evaluate=function(a){return this.lhs.evaluate(a).number().mod(this.rhs.evaluate(a).number());};t.prototype.toString=function(){return'('+this.lhs.toString()+' mod '+this.rhs.toString()+')';};u.prototype=new j();u.prototype.constructor=u;u.prototype.operator='|';u.superclass=j.prototype;function u(a,b){if(arguments.length>0){this.init(a,b);}}u.prototype.init=function(a,b){u.superclass.init.call(this,a,b);};u.prototype.evaluate=function(a){return this.lhs.evaluate(a).nodeset().union(this.rhs.evaluate(a).nodeset());};u.prototype.toString=function(){return this.lhs.toString()+' | '+this.rhs.toString();};l.prototype=new k();l.prototype.constructor=l;l.superclass=k.prototype;function l(a,b,c){if(arguments.length>0){this.init(a,b,c);}}l.prototype.init=function(a,b,c){l.superclass.init.call(this);this.filter=a;this.filterPredicates=b;this.locationPath=c;};l.prototype.evaluate=function(k){var h;var d=new M();d.variableResolver=k.variableResolver;d.functionResolver=k.functionResolver;d.namespaceResolver=k.namespaceResolver;d.expressionContextNode=k.expressionContextNode;d.virtualRoot=k.virtualRoot;d.caseInsensitive=k.caseInsensitive;d.shouldCreateNodes=k.shouldCreateNodes;d.shouldFlagNodes=k.shouldFlagNodes;if(this.filter==null){h=[k.contextNode];}else{var n=this.filter.evaluate(k);if(!Utilities.instance_of(n,c)){if(this.filterPredicates!=null&&this.filterPredicates.length>0||this.locationPath!=null){throw new Error('Path expression filter must evaluate to a nodset if predicates or location path are used');}return n;}h=n.toArray();if(this.filterPredicates!=null){for(var j=0;j<this.filterPredicates.length;j++){var t=this.filterPredicates[j];var e=[];d.contextSize=h.length;for(d.contextPosition=1;d.contextPosition<=d.contextSize;d.contextPosition++){d.contextNode=h[d.contextPosition-1];if(this.predicateMatches(t,d)){e.push(d.contextNode);}}h=e;}}}if(this.locationPath!=null){if(this.locationPath.absolute){if(h[0].nodeType!=9){if(d.virtualRoot!=null){h=[d.virtualRoot];}else{if(h[0].ownerDocument==null){var i=h[0];while(i.parentNode!=null){i=i.parentNode;}h=[i];}else{h=[h[0].ownerDocument];}}}else{h=[h[0]];}}for(var u=0;u<this.locationPath.steps.length;u++){var g=this.locationPath.steps[u];var e=[];for(var j=0;j<h.length;j++){d.contextNode=h[j];switch(g.axis){case b.ANCESTOR:if(d.contextNode===d.virtualRoot){break;}var a;if(d.contextNode.nodeType==2){a=this.getOwnerElement(d.contextNode);}else{a=d.contextNode.parentNode;}while(a!=null){if(g.nodeTest.matches(a,d)){e.push(a);}if(a===d.virtualRoot){break;}a=a.parentNode;}break;case b.ANCESTORORSELF:for(var a=d.contextNode;a!=null;a=a.nodeType==2?this.getOwnerElement(a):a.parentNode){if(g.nodeTest.matches(a,d)){e.push(a);}if(a===d.virtualRoot){break;}}break;case b.ATTRIBUTE:var l=false;var v=d.contextNode.attributes;if(v!=null){for(var m=0;m<v.length;m++){var a=v.item(m);if(g.nodeTest.matches(a,d)){e.push(a);l=true;}}}if(l==false&&d.shouldCreateNodes==true){var q;if(d.shouldFlagNodes==true){TP.elementFlagChange(d.contextNode,TP.ATTR+g.nodeTest.value,TP.CREATE);}d.contextNode.setAttribute(g.nodeTest.value,'');q=d.contextNode.getAttributeNode(g.nodeTest.value);e.push(q);}break;case b.CHILD:var l=false;for(var a=d.contextNode.firstChild;a!=null;a=a.nextSibling){if(g.nodeTest.matches(a,d)){if(d.shouldFlagNodes==true){var y;y=TP.elementGetChangeAction(a,TP.SELF);if(y===TP.DELETE){if(d.shouldCreateNodes==true){TP.elementFlagChange(a,TP.SELF,TP.CREATE);e.push(a);l=true;}else{l=false;}}else{e.push(a);l=true;}}else{e.push(a);l=true;}}}if(l==false&&d.shouldCreateNodes==true){var q,w;w=d.contextNode.ownerDocument;if(TP.notValid(w)){w=d.contextNode;}q=w.createElement(g.nodeTest.value);if(d.shouldFlagNodes==true){TP.elementFlagChange(q,TP.SELF,TP.CREATE);}d.contextNode.appendChild(q);e.push(q);}break;case b.DESCENDANT:var f=[d.contextNode.firstChild];while(f.length>0){for(var a=f.pop();a!=null;){if(g.nodeTest.matches(a,d)){e.push(a);}if(a.firstChild!=null){f.push(a.nextSibling);a=a.firstChild;}else{a=a.nextSibling;}}}break;case b.DESCENDANTORSELF:if(g.nodeTest.matches(d.contextNode,d)){e.push(d.contextNode);}var f=[d.contextNode.firstChild];while(f.length>0){for(var a=f.pop();a!=null;){if(g.nodeTest.matches(a,d)){e.push(a);}if(a.firstChild!=null){f.push(a.nextSibling);a=a.firstChild;}else{a=a.nextSibling;}}}break;case b.FOLLOWING:if(d.contextNode===d.virtualRoot){break;}var f=[];if(d.contextNode.firstChild!=null){f.unshift(d.contextNode.firstChild);}else{f.unshift(d.contextNode.nextSibling);}for(var a=d.contextNode.parentNode;a!=null&&a.nodeType!=9&&a!==d.virtualRoot;a=a.parentNode){f.unshift(a.nextSibling);}do{for(var a=f.pop();a!=null;){if(g.nodeTest.matches(a,d)){e.push(a);}if(a.firstChild!=null){f.push(a.nextSibling);a=a.firstChild;}else{a=a.nextSibling;}}}while(f.length>0);break;case b.FOLLOWINGSIBLING:if(d.contextNode===d.virtualRoot){break;}for(var a=d.contextNode.nextSibling;a!=null;a=a.nextSibling){if(g.nodeTest.matches(a,d)){e.push(a);}}break;case b.NAMESPACE:var i={};if(d.contextNode.nodeType==1){i['xml']=o.XML_NAMESPACE_URI;i['xmlns']=o.XMLNS_NAMESPACE_URI;for(var a=d.contextNode;a!=null&&a.nodeType==1;a=a.parentNode){for(var m=0;m<a.attributes.length;m++){var s=a.attributes.item(m);var p=String(s.name);if(p=='xmlns'){if(i['']==undefined){i['']=s.value;}}else if(p.length>6&&p.substring(0,6)=='xmlns:'){var r=p.substring(6,p.length);if(i[r]==undefined){i[r]=s.value;}}else if(s.namespaceURI=='http://www.w3.org/2000/xmlns/'){if(i[p]==undefined){i[p]=s.value;}}}}for(var r in i){var x=new NamespaceNode(r,i[r],d.contextNode);if(g.nodeTest.matches(x,d)){e.push(x);}}}break;case b.PARENT:a=null;if(d.contextNode!==d.virtualRoot){if(d.contextNode.nodeType==2){a=this.getOwnerElement(d.contextNode);}else{a=d.contextNode.parentNode;}}if(a!=null&&g.nodeTest.matches(a,d)){e.push(a);}break;case b.PRECEDING:var f;if(d.virtualRoot!=null){f=[d.virtualRoot];}else{f=d.contextNode.nodeType==9?[d.contextNode]:[d.contextNode.ownerDocument];}a:while(f.length>0){for(var a=f.pop();a!=null;){if(a==d.contextNode){break a;}if(g.nodeTest.matches(a,d)){e.unshift(a);}if(a.firstChild!=null){f.push(a.nextSibling);a=a.firstChild;}else{a=a.nextSibling;}}}break;case b.PRECEDINGSIBLING:if(d.contextNode===d.virtualRoot){break;}for(var a=d.contextNode.previousSibling;a!=null;a=a.previousSibling){if(g.nodeTest.matches(a,d)){e.push(a);}}break;case b.SELF:if(g.nodeTest.matches(d.contextNode,d)){e.push(d.contextNode);}break;default:}}h=e;for(var j=0;j<g.predicates.length;j++){var t=g.predicates[j];var e=[];d.contextSize=h.length;for(d.contextPosition=1;d.contextPosition<=d.contextSize;d.contextPosition++){d.contextNode=h[d.contextPosition-1];if(this.predicateMatches(t,d)){e.push(d.contextNode);}else{}}h=e;}}}var n=new c();n.addArray(h);return n;};l.prototype.predicateMatches=function(c,b){var a=c.evaluate(b);if(Utilities.instance_of(a,f)){return b.contextPosition==a.numberValue();}return a.booleanValue();};l.prototype.toString=function(){if(this.filter!=undefined){var a=this.filter.toString();if(Utilities.instance_of(this.filter,d)){a='\''+a+'\'';}if(this.filterPredicates!=undefined){for(var b=0;b<this.filterPredicates.length;b++){a=a+'['+this.filterPredicates[b].toString()+']';}}if(this.locationPath!=undefined){if(!this.locationPath.absolute){a+='/';}a+=this.locationPath.toString();}return a;}return this.locationPath.toString();};l.prototype.toReplacedString=function(b){if(this.filter!=undefined){var a='';if(Utilities.instance_of(this.filter,d)){a+='\''+this.filter.toString()+'\'';}else{a+=this.filter.toReplacedString(b);}if(this.filterPredicates!=undefined){for(var c=0;c<this.filterPredicates.length;c++){a=a+'['+this.filterPredicates[c].toReplacedString(b)+']';}}if(this.locationPath!=undefined){if(!this.locationPath.absolute){a+='/';}a+=this.locationPath.toReplacedString(b);}return a;}return b(this.locationPath);};l.prototype.gatherLocationPathsInto=function(a){if(this.filter!=undefined){this.filter.gatherLocationPathsInto(a);}if(this.locationPath!=undefined){a.push(this.toString());}};l.prototype.getOwnerElement=function(a){if(a.ownerElement){return a.ownerElement;}try{if(a.selectSingleNode){return a.selectSingleNode('..');}}catch(a){}var g=a.nodeType==9?a:a.ownerDocument;var d=g.getElementsByTagName('*');for(var b=0;b<d.length;b++){var e=d.item(b);var f=e.attributes;for(var c=0;c<f.length;c++){var h=f.item(c);if(h===a){return e;}}}return null;};G.prototype=new Object();G.prototype.constructor=G;G.superclass=Object.prototype;function G(a,b){if(arguments.length>0){this.init(a,b);}}G.prototype.init=function(a,b){this.absolute=a;this.steps=b;};G.prototype.toString=function(){var a;if(this.absolute){a='/';}else{a='';}for(var b=0;b<this.steps.length;b++){if(b!=0){a+='/';}a+=this.steps[b].toString();}return a;};G.prototype.toReplacedString=function(c){var a;if(this.absolute){a='/';}else{a='';}for(var b=0;b<this.steps.length;b++){if(b!=0){a+='/';}a+=this.steps[b].toString();}return a;};b.prototype=new Object();b.prototype.constructor=b;b.superclass=Object.prototype;function b(a,b,c){if(arguments.length>0){this.init(a,b,c);}}b.prototype.init=function(a,b,c){this.axis=a;this.nodeTest=b;this.predicates=c;};b.prototype.toString=function(){var a;switch(this.axis){case b.ANCESTOR:a='ancestor';break;case b.ANCESTORORSELF:a='ancestor-or-self';break;case b.ATTRIBUTE:a='attribute';break;case b.CHILD:a='child';break;case b.DESCENDANT:a='descendant';break;case b.DESCENDANTORSELF:a='descendant-or-self';break;case b.FOLLOWING:a='following';break;case b.FOLLOWINGSIBLING:a='following-sibling';break;case b.NAMESPACE:a='namespace';break;case b.PARENT:a='parent';break;case b.PRECEDING:a='preceding';break;case b.PRECEDINGSIBLING:a='preceding-sibling';break;case b.SELF:a='self';break;}a+='::';a+=this.nodeTest.toString();for(var c=0;c<this.predicates.length;c++){a+='['+this.predicates[c].toString()+']';}return a;};b.ANCESTOR=0;b.ANCESTORORSELF=1;b.ATTRIBUTE=2;b.CHILD=3;b.DESCENDANT=4;b.DESCENDANTORSELF=5;b.FOLLOWING=6;b.FOLLOWINGSIBLING=7;b.NAMESPACE=8;b.PARENT=9;b.PRECEDING=10;b.PRECEDINGSIBLING=11;b.SELF=12;g.prototype=new Object();g.prototype.constructor=g;g.superclass=Object.prototype;function g(a,b){if(arguments.length>0){this.init(a,b);}}g.prototype.init=function(a,b){this.type=a;this.value=b;};g.prototype.toString=function(){switch(this.type){case g.NAMETESTANY:return'*';case g.NAMETESTPREFIXANY:return this.value+':*';case g.NAMETESTRESOLVEDANY:return'{'+this.value+'}*';case g.NAMETESTQNAME:return this.value;case g.NAMETESTRESOLVEDNAME:return'{'+this.namespaceURI+'}'+this.value;case g.COMMENT:return'comment()';case g.TEXT:return'text()';case g.PI:if(this.value!=undefined){return'processing-instruction("'+this.value+'")';}return'processing-instruction()';case g.NODE:return'node()';}return'<unknown nodetest type>';};g.prototype.matches=function(a,d){switch(this.type){case g.NAMETESTANY:if(a.nodeType==2||a.nodeType==1||a.nodeType==I.XPATH_NAMESPACE_NODE){return true;}return false;case g.NAMETESTPREFIXANY:if(a.nodeType==2||a.nodeType==1){var e=d.namespaceResolver.getNamespace(this.value,d.expressionContextNode);if(e==null){throw new Error('Cannot resolve QName '+this.value);}return true;}return false;case g.NAMETESTQNAME:if(a.nodeType==2||a.nodeType==1||a.nodeType==I.XPATH_NAMESPACE_NODE){var b=Utilities.resolveQName(this.value,d.namespaceResolver,d.expressionContextNode,false);if(b[0]==null){throw new Error('Cannot resolve QName '+this.value);}b[0]=String(b[0]);b[1]=String(b[1]);if(b[0]==''){b[0]=null;}var c=Utilities.resolveQName(a.nodeName,d.namespaceResolver,a,a.nodeType==1);c[0]=String(c[0]);c[1]=String(c[1]);if(c[0]==''){c[0]=null;}if(d.caseInsensitive){return b[0]==c[0]&&String(b[1]).toLowerCase()==String(c[1]).toLowerCase();}return b[0]==c[0]&&b[1]==c[1];}return false;case g.COMMENT:return a.nodeType==8;case g.TEXT:return a.nodeType==3||a.nodeType==4;case g.PI:return a.nodeType==7&&(this.value==null||a.nodeName==this.value);case g.NODE:return a.nodeType==9||a.nodeType==1||a.nodeType==2||a.nodeType==3||a.nodeType==4||a.nodeType==8||a.nodeType==7;}return false;};g.NAMETESTANY=0;g.NAMETESTPREFIXANY=1;g.NAMETESTQNAME=2;g.COMMENT=3;g.TEXT=4;g.PI=5;g.NODE=6;K.prototype=new k();K.prototype.constructor=K;K.superclass=k.prototype;function K(a){if(arguments.length>0){this.init(a);}}K.prototype.init=function(a){this.variable=a;};K.prototype.toString=function(){return'$'+this.variable;};K.prototype.evaluate=function(a){return a.variableResolver.getVariable(this.variable,a);};A.prototype=new k();A.prototype.constructor=A;A.superclass=k.prototype;function A(a,b){if(arguments.length>0){this.init(a,b);}}A.prototype.init=function(a,b){this.functionName=a;this.arguments=b;};A.prototype.toString=function(){var b=this.functionName+'(';for(var a=0;a<this.arguments.length;a++){if(a>0){b+=', ';}b+=this.arguments[a].toString();}return b+')';};A.prototype.toReplacedString=function(c){var b=this.functionName+'(';for(var a=0;a<this.arguments.length;a++){if(a>0){b+=', ';}b+=this.arguments[a].toReplacedString(c);}return b+')';};A.prototype.evaluate=function(a){var b=a.functionResolver.getFunction(this.functionName,a);if(b==undefined){throw new Error('Unknown function '+this.functionName);}var c=[a].concat(this.arguments);return b.apply(a.functionResolver.thisArg,c);};d.prototype=new k();d.prototype.constructor=d;d.superclass=k.prototype;function d(a){if(arguments.length>0){this.init(a);}}d.prototype.init=function(a){this.str=a;};d.prototype.toString=function(){return this.str;};d.prototype.evaluate=function(a){return this;};d.prototype.string=function(){return this;};d.prototype.number=function(){return new f(this.str);};d.prototype.bool=function(){return new e(this.str);};d.prototype.nodeset=function(){throw new Error('Cannot convert string to nodeset');};d.prototype.stringValue=function(){return this.str;};d.prototype.numberValue=function(){return this.number().numberValue();};d.prototype.booleanValue=function(){return this.bool().booleanValue();};d.prototype.equals=function(a){if(Utilities.instance_of(a,e)){return this.bool().equals(a);}if(Utilities.instance_of(a,f)){return this.number().equals(a);}if(Utilities.instance_of(a,c)){return a.compareWithString(this,h.equals);}return new e(this.str==a.str);};d.prototype.notequal=function(a){if(Utilities.instance_of(a,e)){return this.bool().notequal(a);}if(Utilities.instance_of(a,f)){return this.number().notequal(a);}if(Utilities.instance_of(a,c)){return a.compareWithString(this,h.notequal);}return new e(this.str!=a.str);};d.prototype.lessthan=function(a){if(Utilities.instance_of(a,c)){return a.compareWithNumber(this.number(),h.greaterthanorequal);}return this.number().lessthan(a.number());};d.prototype.greaterthan=function(a){if(Utilities.instance_of(a,c)){return a.compareWithNumber(this.number(),h.lessthanorequal);}return this.number().greaterthan(a.number());};d.prototype.lessthanorequal=function(a){if(Utilities.instance_of(a,c)){return a.compareWithNumber(this.number(),h.greaterthan);}return this.number().lessthanorequal(a.number());};d.prototype.greaterthanorequal=function(a){if(Utilities.instance_of(a,c)){return a.compareWithNumber(this.number(),h.lessthan);}return this.number().greaterthanorequal(a.number());};f.prototype=new k();f.prototype.constructor=f;f.superclass=k.prototype;function f(a){if(arguments.length>0){this.init(a);}}f.prototype.init=function(a){this.num=Number(a);};f.prototype.toString=function(){return this.num;};f.prototype.evaluate=function(a){return this;};f.prototype.string=function(){return new d(this.num);};f.prototype.number=function(){return this;};f.prototype.bool=function(){return new e(this.num);};f.prototype.nodeset=function(){throw new Error('Cannot convert number to nodeset');};f.prototype.stringValue=function(){return this.string().stringValue();};f.prototype.numberValue=function(){return this.num;};f.prototype.booleanValue=function(){return this.bool().booleanValue();};f.prototype.negate=function(){return new f(-this.num);};f.prototype.equals=function(a){if(Utilities.instance_of(a,e)){return this.bool().equals(a);}if(Utilities.instance_of(a,d)){return this.equals(a.number());}if(Utilities.instance_of(a,c)){return a.compareWithNumber(this,h.equals);}return new e(this.num==a.num);};f.prototype.notequal=function(a){if(Utilities.instance_of(a,e)){return this.bool().notequal(a);}if(Utilities.instance_of(a,d)){return this.notequal(a.number());}if(Utilities.instance_of(a,c)){return a.compareWithNumber(this,h.notequal);}return new e(this.num!=a.num);};f.prototype.lessthan=function(a){if(Utilities.instance_of(a,c)){return a.compareWithNumber(this,h.greaterthanorequal);}if(Utilities.instance_of(a,e)||Utilities.instance_of(a,d)){return this.lessthan(a.number());}return new e(this.num<a.num);};f.prototype.greaterthan=function(a){if(Utilities.instance_of(a,c)){return a.compareWithNumber(this,h.lessthanorequal);}if(Utilities.instance_of(a,e)||Utilities.instance_of(a,d)){return this.greaterthan(a.number());}return new e(this.num>a.num);};f.prototype.lessthanorequal=function(a){if(Utilities.instance_of(a,c)){return a.compareWithNumber(this,h.greaterthan);}if(Utilities.instance_of(a,e)||Utilities.instance_of(a,d)){return this.lessthanorequal(a.number());}return new e(this.num<=a.num);};f.prototype.greaterthanorequal=function(a){if(Utilities.instance_of(a,c)){return a.compareWithNumber(this,h.lessthan);}if(Utilities.instance_of(a,e)||Utilities.instance_of(a,d)){return this.greaterthanorequal(a.number());}return new e(this.num>=a.num);};f.prototype.plus=function(a){return new f(this.num+a.num);};f.prototype.minus=function(a){return new f(this.num-a.num);};f.prototype.multiply=function(a){return new f(this.num*a.num);};f.prototype.div=function(a){return new f(this.num/a.num);};f.prototype.mod=function(a){return new f(this.num%a.num);};e.prototype=new k();e.prototype.constructor=e;e.superclass=k.prototype;function e(a){if(arguments.length>0){this.init(a);}}e.prototype.init=function(a){this.b=Boolean(a);};e.prototype.toString=function(){return this.b.toString();};e.prototype.evaluate=function(a){return this;};e.prototype.string=function(){return new d(this.b);};e.prototype.number=function(){return new f(this.b);};e.prototype.bool=function(){return this;};e.prototype.nodeset=function(){throw new Error('Cannot convert boolean to nodeset');};e.prototype.stringValue=function(){return this.string().stringValue();};e.prototype.numberValue=function(){return this.num().numberValue();};e.prototype.booleanValue=function(){return this.b;};e.prototype.not=function(){return new e(!this.b);};e.prototype.equals=function(a){if(Utilities.instance_of(a,d)||Utilities.instance_of(a,f)){return this.equals(a.bool());}if(Utilities.instance_of(a,c)){return a.compareWithBoolean(this,h.equals);}return new e(this.b==a.b);};e.prototype.notequal=function(a){if(Utilities.instance_of(a,d)||Utilities.instance_of(a,f)){return this.notequal(a.bool());}if(Utilities.instance_of(a,c)){return a.compareWithBoolean(this,h.notequal);}return new e(this.b!=a.b);};e.prototype.lessthan=function(a){if(Utilities.instance_of(a,c)){return a.compareWithNumber(this.number(),h.greaterthanorequal);}return this.number().lessthan(a.number());};e.prototype.greaterthan=function(a){if(Utilities.instance_of(a,c)){return a.compareWithNumber(this.number(),h.lessthanorequal);}return this.number().greaterthan(a.number());};e.prototype.lessthanorequal=function(a){if(Utilities.instance_of(a,c)){return a.compareWithNumber(this.number(),h.greaterthan);}return this.number().lessthanorequal(a.number());};e.prototype.greaterthanorequal=function(a){if(Utilities.instance_of(a,c)){return a.compareWithNumber(this.number(),h.lessthan);}return this.number().greaterthanorequal(a.number());};n.prototype=new Object();n.prototype.constructor=n;n.superclass=Object.prototype;function n(a){this.init(a);}n.prototype.init=function(a){this.left=null;this.right=null;this.node=a;this.depth=1;};n.prototype.balance=function(){var a=this.left==null?0:this.left.depth;var b=this.right==null?0:this.right.depth;if(a>b+1){var c=this.left.left==null?0:this.left.left.depth;var d=this.left.right==null?0:this.left.right.depth;if(c<d){this.left.rotateRR();}this.rotateLL();}else if(a+1<b){var e=this.right.right==null?0:this.right.right.depth;var f=this.right.left==null?0:this.right.left.depth;if(f>e){this.right.rotateLL();}this.rotateRR();}};n.prototype.rotateLL=function(){var a=this.node;var b=this.right;this.node=this.left.node;this.right=this.left;this.left=this.left.left;this.right.left=this.right.right;this.right.right=b;this.right.node=a;this.right.updateInNewLocation();this.updateInNewLocation();};n.prototype.rotateRR=function(){var a=this.node;var b=this.left;this.node=this.right.node;this.left=this.right;this.right=this.right.right;this.left.right=this.left.left;this.left.left=b;this.left.node=a;this.left.updateInNewLocation();this.updateInNewLocation();};n.prototype.updateInNewLocation=function(){this.getDepthFromChildren();};n.prototype.getDepthFromChildren=function(){this.depth=this.node==null?0:1;if(this.left!=null){this.depth=this.left.depth+1;}if(this.right!=null&&this.depth<=this.right.depth){this.depth=this.right.depth+1;}};n.prototype.order=function(a,b){if(a===b){return 0;}var c=0;var d=0;for(var e=a;e!=null;e=e.parentNode){c++;}for(var f=b;f!=null;f=f.parentNode){d++;}if(c>d){while(c>d){a=a.parentNode;c--;}if(a==b){return 1;}}else if(d>c){while(d>c){b=b.parentNode;d--;}if(a==b){return-1;}}while(a.parentNode!=b.parentNode){a=a.parentNode;b=b.parentNode;}while(a.previousSibling!=null&&b.previousSibling!=null){a=a.previousSibling;b=b.previousSibling;}if(a.previousSibling==null){return-1;}return 1;};n.prototype.add=function(b){if(b===this.node){return false;}var c=this.order(b,this.node);var a=false;if(c==-1){if(this.left==null){this.left=new n(b);a=true;}else{a=this.left.add(b);if(a){this.balance();}}}else if(c==1){if(this.right==null){this.right=new n(b);a=true;}else{a=this.right.add(b);if(a){this.balance();}}}if(a){this.getDepthFromChildren();}return a;};c.prototype=new k();c.prototype.constructor=c;c.superclass=k.prototype;function c(){this.init();}c.prototype.init=function(){this.tree=null;this.size=0;};c.prototype.toString=function(){var a=this.first();if(a==null){return'';}return this.stringForNode(a);};c.prototype.evaluate=function(a){return this;};c.prototype.string=function(){return new d(this.toString());};c.prototype.stringValue=function(){return this.toString();};c.prototype.number=function(){return new f(this.string());};c.prototype.numberValue=function(){return Number(this.string());};c.prototype.bool=function(){return new e(this.tree!=null);};c.prototype.booleanValue=function(){return this.tree!=null;};c.prototype.nodeset=function(){return this;};c.prototype.stringForNode=function(a){if(a.nodeType==9){a=a.documentElement;}if(a.nodeType==1){return this.stringForNodeRec(a);}if(a.isNamespaceNode){return a.namespace;}return a.nodeValue;};c.prototype.stringForNodeRec=function(c){var b='';for(var a=c.firstChild;a!=null;a=a.nextSibling){if(a.nodeType==3){b+=a.nodeValue;}else if(a.nodeType==1){b+=this.stringForNodeRec(a);}}return b;};c.prototype.first=function(){var a=this.tree;if(a==null){return null;}while(a.left!=null){a=a.left;}return a.node;};c.prototype.add=function(b){if(this.tree==null){this.tree=new Object();this.tree.node=b;this.tree.left=null;this.tree.right=null;this.size=1;return;}var a=this.tree;while(1){var c=this.order(b,a.node);if(c==0){return;}if(c>0){if(a.right==null){a.right=new Object();a.right.node=b;a.right.left=null;a.right.right=null;this.size++;return;}a=a.right;}else{if(a.left==null){a.left=new Object();a.left.node=b;a.left.left=null;a.left.right=null;this.size++;return;}a=a.left;}}};c.prototype.addArray=function(b){for(var a=0;a<b.length;a++){this.add(b[a]);}};c.prototype.toArray=function(){var a=[];this.toArrayRec(this.tree,a);return a;};c.prototype.toArrayRec=function(a,b){if(a!=null){this.toArrayRec(a.left,b);b.push(a.node);this.toArrayRec(a.right,b);}};c.prototype.order=function(a,b){if(a==b){return 0;}var c=0,d=0;for(var e=a;e!=null;e=e.parentNode){c++;}for(var f=b;f!=null;f=f.parentNode){d++;}if(c>d){while(c>d){a=a.parentNode;c--;}if(a==b){return 1;}}else if(d>c){while(d>c){b=b.parentNode;d--;}if(a==b){return-1;}}while(a.parentNode!=b.parentNode){a=a.parentNode;b=b.parentNode;}while(a.previousSibling!=null&&b.previousSibling!=null){a=a.previousSibling;b=b.previousSibling;}if(a.previousSibling==null){return-1;}return 1;};c.prototype.compareWithString=function(h,i){var b=this.toArray();for(var a=0;a<b.length;a++){var f=b[a];var g=new d(this.stringForNode(f));var c=i(g,h);if(c.booleanValue()){return c;}}return new e(false);};c.prototype.compareWithNumber=function(h,i){var b=this.toArray();for(var a=0;a<b.length;a++){var d=b[a];var g=new f(this.stringForNode(d));var c=i(g,h);if(c.booleanValue()){return c;}}return new e(false);};c.prototype.compareWithBoolean=function(a,b){return b(this.bool(),a);};c.prototype.compareWithNodeSet=function(b,l){var g=this.toArray();for(var a=0;a<g.length;a++){var k=g[a];var i=new d(this.stringForNode(k));var h=b.toArray();for(var c=0;c<h.length;c++){var j=h[c];var b=new d(this.stringForNode(j));var f=l(i,b);if(f.booleanValue()){return f;}}}return new e(false);};c.prototype.equals=function(a){if(Utilities.instance_of(a,d)){return this.compareWithString(a,h.equals);}if(Utilities.instance_of(a,f)){return this.compareWithNumber(a,h.equals);}if(Utilities.instance_of(a,e)){return this.compareWithBoolean(a,h.equals);}return this.compareWithNodeSet(a,h.equals);};c.prototype.notequal=function(a){if(Utilities.instance_of(a,d)){return this.compareWithString(a,h.notequal);}if(Utilities.instance_of(a,f)){return this.compareWithNumber(a,h.notequal);}if(Utilities.instance_of(a,e)){return this.compareWithBoolean(a,h.notequal);}return this.compareWithNodeSet(a,h.notequal);};c.prototype.lessthan=function(a){if(Utilities.instance_of(a,d)){return this.compareWithNumber(a.number(),h.lessthan);}if(Utilities.instance_of(a,f)){return this.compareWithNumber(a,h.lessthan);}if(Utilities.instance_of(a,e)){return this.compareWithBoolean(a,h.lessthan);}return this.compareWithNodeSet(a,h.lessthan);};c.prototype.greaterthan=function(a){if(Utilities.instance_of(a,d)){return this.compareWithNumber(a.number(),h.greaterthan);}if(Utilities.instance_of(a,f)){return this.compareWithNumber(a,h.greaterthan);}if(Utilities.instance_of(a,e)){return this.compareWithBoolean(a,h.greaterthan);}return this.compareWithNodeSet(a,h.greaterthan);};c.prototype.lessthanorequal=function(a){if(Utilities.instance_of(a,d)){return this.compareWithNumber(a.number(),h.lessthanorequal);}if(Utilities.instance_of(a,f)){return this.compareWithNumber(a,h.lessthanorequal);}if(Utilities.instance_of(a,e)){return this.compareWithBoolean(a,h.lessthanorequal);}return this.compareWithNodeSet(a,h.lessthanorequal);};c.prototype.greaterthanorequal=function(a){if(Utilities.instance_of(a,d)){return this.compareWithNumber(a.number(),h.greaterthanorequal);}if(Utilities.instance_of(a,f)){return this.compareWithNumber(a,h.greaterthanorequal);}if(Utilities.instance_of(a,e)){return this.compareWithBoolean(a,h.greaterthanorequal);}return this.compareWithNodeSet(a,h.greaterthanorequal);};c.prototype.union=function(b){var a=new c();a.tree=this.tree;a.size=this.size;a.addArray(b.toArray());return a;};I.prototype=new Object();I.prototype.constructor=I;I.superclass=Object.prototype;function I(a,b,c){this.isXPathNamespace=true;this.ownerDocument=c.ownerDocument;this.nodeName='#namespace';this.prefix=a;this.localName=a;this.namespaceURI=b;this.nodeValue=b;this.ownerElement=c;this.nodeType=I.XPATH_NAMESPACE_NODE;}I.prototype.toString=function(){return'{ "'+this.prefix+'", "'+this.namespaceURI+'" }';};var h=new Object();h.equals=function(a,b){return a.equals(b);};h.notequal=function(a,b){return a.notequal(b);};h.lessthan=function(a,b){return a.lessthan(b);};h.greaterthan=function(a,b){return a.greaterthan(b);};h.lessthanorequal=function(a,b){return a.lessthanorequal(b);};h.greaterthanorequal=function(a,b){return a.greaterthanorequal(b);};M.prototype=new Object();M.prototype.constructor=M;M.superclass=Object.prototype;function M(a,b,c){this.variableResolver=a!=null?a:new J();this.namespaceResolver=b!=null?b:new H();this.functionResolver=c!=null?c:new z();}J.prototype=new Object();J.prototype.constructor=J;J.superclass=Object.prototype;function J(){}J.prototype.getVariable=function(c,b){var a=Utilities.splitQName(c);if(a[0]!=null){a[0]=b.namespaceResolver.getNamespace(a[0],b.expressionContextNode);if(a[0]==null){throw new Error('Cannot resolve QName '+fn);}}return this.getVariableWithName(a[0],a[1],b.expressionContextNode);};J.prototype.getVariableWithName=function(a,b,c){return null;};z.prototype=new Object();z.prototype.constructor=z;z.superclass=Object.prototype;function z(a){this.thisArg=a!=null?a:Functions;this.functions=new Object();this.addStandardFunctions();}z.prototype.addStandardFunctions=function(){this.functions['{}last']=Functions.last;this.functions['{}position']=Functions.position;this.functions['{}count']=Functions.count;this.functions['{}id']=Functions.id;this.functions['{}local-name']=Functions.localName;this.functions['{}namespace-uri']=Functions.namespaceURI;this.functions['{}name']=Functions.name;this.functions['{}string']=Functions.string;this.functions['{}concat']=Functions.concat;this.functions['{}starts-with']=Functions.startsWith;this.functions['{}contains']=Functions.contains;this.functions['{}substring-before']=Functions.substringBefore;this.functions['{}substring-after']=Functions.substringAfter;this.functions['{}substring']=Functions.substring;this.functions['{}string-length']=Functions.stringLength;this.functions['{}normalize-space']=Functions.normalizeSpace;this.functions['{}translate']=Functions.translate;this.functions['{}boolean']=Functions.boolean_;this.functions['{}not']=Functions.not;this.functions['{}true']=Functions.true_;this.functions['{}false']=Functions.false_;this.functions['{}lang']=Functions.lang;this.functions['{}number']=Functions.number;this.functions['{}sum']=Functions.sum;this.functions['{}floor']=Functions.floor;this.functions['{}ceiling']=Functions.ceiling;this.functions['{}round']=Functions.round;};z.prototype.addFunction=function(a,b,c){this.functions['{'+a+'}'+b]=c;};z.prototype.getFunction=function(c,b){var a=Utilities.resolveQName(c,b.namespaceResolver,b.contextNode,false);if(a[0]==null){throw new Error('Cannot resolve QName '+c);}return this.getFunctionWithName(a[0],a[1],b.contextNode);};z.prototype.getFunctionWithName=function(a,b,c){return this.functions['{'+a+'}'+b];};H.prototype=new Object();H.prototype.constructor=H;H.superclass=Object.prototype;function H(){}H.prototype.getNamespace=function(b,a){if(b=='xml'){return o.XML_NAMESPACE_URI;}else if(b=='xmlns'){return o.XMLNS_NAMESPACE_URI;}if(a.nodeType==9){a=a.documentElement;}else if(a.nodeType==2){a=l.prototype.getOwnerElement(a);}else if(a.nodeType!=1){a=a.parentNode;}while(a!=null&&a.nodeType==1){var d=a.attributes;for(var c=0;c<d.length;c++){var e=d.item(c);var f=e.nodeName;if(f=='xmlns'&&b==''||f=='xmlns:'+b){return String(e.nodeValue);}}a=a.parentNode;}return null;};Functions=new Object();Functions.last=function(){var a=arguments[0];if(arguments.length!=1){throw new Error('Function last expects ()');}return new f(a.contextSize);};Functions.position=function(){var a=arguments[0];if(arguments.length!=1){throw new Error('Function position expects ()');}return new f(a.contextPosition);};Functions.count=function(){var a=arguments[0];var b;if(arguments.length!=2||!Utilities.instance_of(b=arguments[1].evaluate(a),c)){throw new Error('Function count expects (node-set)');}return new f(b.size);};Functions.id=function(){var b=arguments[0];var a;if(arguments.length!=2){throw new Error('Function id expects (object)');}a=arguments[1].evaluate(b);if(Utilities.instance_of(a,c)){a=a.toArray().join(' ');}else{a=a.stringValue();}var e=a.split(/[\x0d\x0a\x09\x20]+/);var i=0;var h=new c();var f=b.contextNode.nodeType==9?b.contextNode:b.contextNode.ownerDocument;for(var d=0;d<e.length;d++){var g;if(f.getElementById){g=f.getElementById(e[d]);}else{g=Utilities.getElementById(f,e[d]);}if(g!=null){h.add(g);i++;}}return h;};Functions.localName=function(){var b=arguments[0];var a;if(arguments.length==1){a=b.contextNode;}else if(arguments.length==2){a=arguments[1].evaluate(b).first();}else{throw new Error('Function local-name expects (node-set?)');}if(a==null){return new d('');}return new d(a.localName?a.localName:a.baseName);};Functions.namespaceURI=function(){var b=arguments[0];var a;if(arguments.length==1){a=b.contextNode;}else if(arguments.length==2){a=arguments[1].evaluate(b).first();}else{throw new Error('Function namespace-uri expects (node-set?)');}if(a==null){return new d('');}return new d(a.namespaceURI);};Functions.name=function(){var b=arguments[0];var a;if(arguments.length==1){a=b.contextNode;}else if(arguments.length==2){a=arguments[1].evaluate(b).first();}else{throw new Error('Function name expects (node-set?)');}if(a==null){return new d('');}if(a.nodeType==1||a.nodeType==2){return new d(a.nodeName);}else if(a.localName==null){return new d('');}else{return new d(a.localName);}};Functions.string=function(){var a=arguments[0];if(arguments.length==1){return c.prototype.stringForNode(a.contextNode);}else if(arguments.length==2){return arguments[1].evaluate(a).string();}throw new Error('Function string expects (object?)');};Functions.concat=function(){var c=arguments[0];if(arguments.length<3){throw new Error('Function concat expects (string, string, string*)');}var b='';for(var a=1;a<arguments.length;a++){b+=arguments[a].evaluate(c).stringValue();}return new d(b);};Functions.startsWith=function(){var a=arguments[0];if(arguments.length!=3){throw new Error('Function startsWith expects (string, string)');}var c=arguments[1].evaluate(a).stringValue();var b=arguments[2].evaluate(a).stringValue();return new e(c.substring(0,b.length)==b);};Functions.contains=function(){var a=arguments[0];if(arguments.length!=3){throw new Error('Function contains expects (string, string)');}var b=arguments[1].evaluate(a).stringValue();var c=arguments[2].evaluate(a).stringValue();return new e(b.indexOf(c)!=-1);};Functions.substringBefore=function(){var a=arguments[0];if(arguments.length!=3){throw new Error('Function substring-before expects (string, string)');}var b=arguments[1].evaluate(a).stringValue();var c=arguments[2].evaluate(a).stringValue();return new d(b.substring(0,b.indexOf(c)));};Functions.substringAfter=function(){var c=arguments[0];if(arguments.length!=3){throw new Error('Function substring-after expects (string, string)');}var a=arguments[1].evaluate(c).stringValue();var b=arguments[2].evaluate(c).stringValue();if(b.length==0){return new d(a);}var e=a.indexOf(b);if(e==-1){return new d('');}return new d(a.substring(a.indexOf(b)+1));};Functions.substring=function(){var a=arguments[0];if(!(arguments.length==3||arguments.length==4)){throw new Error('Function substring expects (string, number, number?)');}var c=arguments[1].evaluate(a).stringValue();var b=Math.round(arguments[2].evaluate(a).numberValue())-1;var e=arguments.length==4?b+Math.round(arguments[3].evaluate(a).numberValue()):undefined;return new d(c.substring(b,e));};Functions.stringLength=function(){var a=arguments[0];var b;if(arguments.length==1){b=c.prototype.stringForNode(a.contextNode);}else if(arguments.length==2){b=arguments[1].evaluate(a).stringValue();}else{throw new Error('Function string-length expects (string?)');}return new f(b.length);};Functions.normalizeSpace=function(){var g=arguments[0];var b;if(arguments.length==1){b=c.prototype.stringForNode(g.contextNode);}else if(arguments.length==2){b=arguments[1].evaluate(g).stringValue();}else{throw new Error('Function normalize-space expects (string?)');}var a=0;var e=b.length-1;while(Utilities.isSpace(b.charCodeAt(e))){e--;}var f='';while(a<=e&&Utilities.isSpace(b.charCodeAt(a))){a++;}while(a<=e){if(Utilities.isSpace(b.charCodeAt(a))){f+=' ';while(a<=e&&Utilities.isSpace(b.charCodeAt(a))){a++;}}else{f+=b.charAt(a);a++;}}return new d(f);};Functions.translate=function(){var b=arguments[0];if(arguments.length!=4){throw new Error('Function translate expects (string, string, string)');}var f=arguments[1].evaluate(b).stringValue();var i=arguments[2].evaluate(b).stringValue();var g=arguments[3].evaluate(b).stringValue();var c=[];for(var a=0;a<i.length;a++){var h=i.charCodeAt(a);if(c[h]==undefined){var k=a>g.length?'':g.charAt(a);c[h]=k;}}var e='';for(var a=0;a<f.length;a++){var b=f.charCodeAt(a);var j=c[b];if(j==undefined){e+=f.charAt(a);}else{e+=j;}}return new d(e);};Functions.boolean_=function(){var a=arguments[0];if(arguments.length!=2){throw new Error('Function boolean expects (object)');}return arguments[1].evaluate(a).bool();};Functions.not=function(){var a=arguments[0];if(arguments.length!=2){throw new Error('Function not expects (object)');}return arguments[1].evaluate(a).bool().not();};Functions.true_=function(){if(arguments.length!=1){throw new Error('Function true expects ()');}return new e(true);};Functions.false_=function(){if(arguments.length!=1){throw new Error('Function false expects ()');}return new e(false);};Functions.lang=function(){var d=arguments[0];if(arguments.length!=2){throw new Error('Function lang expects (string)');}var b;for(var a=d.contextNode;a!=null&&a.nodeType!=9;a=a.parentNode){var f=a.getAttributeNS(o.XML_NAMESPACE_URI,'lang');if(f!=null){b=String(f);break;}}if(b==null){return new e(false);}var c=arguments[1].evaluate(d).stringValue();return new e(b.substring(0,c.length)==c&&(b.length==c.length||b.charAt(c.length)=='-'));};Functions.number=function(){var a=arguments[0];if(!(arguments.length==1||arguments.length==2)){throw new Error('Function number expects (object?)');}if(arguments.length==1){return new f(c.prototype.stringForNode(a.contextNode));}return arguments[1].evaluate(a).number();};Functions.sum=function(){var e=arguments[0];var a;if(arguments.length!=2||!Utilities.instance_of(a=arguments[1].evaluate(e),c)){throw new Error('Function sum expects (node-set)');}a=a.toArray();var d=0;for(var b=0;b<a.length;b++){d+=new f(c.prototype.stringForNode(a[b])).numberValue();}return new f(d);};Functions.floor=function(){var a=arguments[0];if(arguments.length!=2){throw new Error('Function floor expects (number)');}return new f(Math.floor(arguments[1].evaluate(a).numberValue()));};Functions.ceiling=function(){var a=arguments[0];if(arguments.length!=2){throw new Error('Function ceiling expects (number)');}return new f(Math.ceil(arguments[1].evaluate(a).numberValue()));};Functions.round=function(){var a=arguments[0];if(arguments.length!=2){throw new Error('Function round expects (number)');}return new f(Math.round(arguments[1].evaluate(a).numberValue()));};Utilities=new Object();Utilities.splitQName=function(a){var b=a.indexOf(':');if(b==-1){return[null,a];}return[a.substring(0,b),a.substring(b+1)];};Utilities.resolveQName=function(d,b,c,e){var a=Utilities.splitQName(d);if(a[0]!=null){a[0]=b.getNamespace(a[0],c);}else{if(e){a[0]=b.getNamespace('',c);if(a[0]==null){a[0]='';}}else{a[0]='';}}return a;};Utilities.isSpace=function(a){return a==9||a==13||a==10||a==32;};Utilities.isLetter=function(a){return a>=65&&a<=90||a>=97&&a<=122||a>=192&&a<=214||a>=216&&a<=246||a>=248&&a<=255||a>=256&&a<=305||a>=308&&a<=318||a>=321&&a<=328||a>=330&&a<=382||a>=384&&a<=451||a>=461&&a<=496||a>=500&&a<=501||a>=506&&a<=535||a>=592&&a<=680||a>=699&&a<=705||a==902||a>=904&&a<=906||a==908||a>=910&&a<=929||a>=931&&a<=974||a>=976&&a<=982||a==986||a==988||a==990||a==992||a>=994&&a<=1011||a>=1025&&a<=1036||a>=1038&&a<=1103||a>=1105&&a<=1116||a>=1118&&a<=1153||a>=1168&&a<=1220||a>=1223&&a<=1224||a>=1227&&a<=1228||a>=1232&&a<=1259||a>=1262&&a<=1269||a>=1272&&a<=1273||a>=1329&&a<=1366||a==1369||a>=1377&&a<=1414||a>=1488&&a<=1514||a>=1520&&a<=1522||a>=1569&&a<=1594||a>=1601&&a<=1610||a>=1649&&a<=1719||a>=1722&&a<=1726||a>=1728&&a<=1742||a>=1744&&a<=1747||a==1749||a>=1765&&a<=1766||a>=2309&&a<=2361||a==2365||a>=2392&&a<=2401||a>=2437&&a<=2444||a>=2447&&a<=2448||a>=2451&&a<=2472||a>=2474&&a<=2480||a==2482||a>=2486&&a<=2489||a>=2524&&a<=2525||a>=2527&&a<=2529||a>=2544&&a<=2545||a>=2565&&a<=2570||a>=2575&&a<=2576||a>=2579&&a<=2600||a>=2602&&a<=2608||a>=2610&&a<=2611||a>=2613&&a<=2614||a>=2616&&a<=2617||a>=2649&&a<=2652||a==2654||a>=2674&&a<=2676||a>=2693&&a<=2699||a==2701||a>=2703&&a<=2705||a>=2707&&a<=2728||a>=2730&&a<=2736||a>=2738&&a<=2739||a>=2741&&a<=2745||a==2749||a==2784||a>=2821&&a<=2828||a>=2831&&a<=2832||a>=2835&&a<=2856||a>=2858&&a<=2864||a>=2866&&a<=2867||a>=2870&&a<=2873||a==2877||a>=2908&&a<=2909||a>=2911&&a<=2913||a>=2949&&a<=2954||a>=2958&&a<=2960||a>=2962&&a<=2965||a>=2969&&a<=2970||a==2972||a>=2974&&a<=2975||a>=2979&&a<=2980||a>=2984&&a<=2986||a>=2990&&a<=2997||a>=2999&&a<=3001||a>=3077&&a<=3084||a>=3086&&a<=3088||a>=3090&&a<=3112||a>=3114&&a<=3123||a>=3125&&a<=3129||a>=3168&&a<=3169||a>=3205&&a<=3212||a>=3214&&a<=3216||a>=3218&&a<=3240||a>=3242&&a<=3251||a>=3253&&a<=3257||a==3294||a>=3296&&a<=3297||a>=3333&&a<=3340||a>=3342&&a<=3344||a>=3346&&a<=3368||a>=3370&&a<=3385||a>=3424&&a<=3425||a>=3585&&a<=3630||a==3632||a>=3634&&a<=3635||a>=3648&&a<=3653||a>=3713&&a<=3714||a==3716||a>=3719&&a<=3720||a==3722||a==3725||a>=3732&&a<=3735||a>=3737&&a<=3743||a>=3745&&a<=3747||a==3749||a==3751||a>=3754&&a<=3755||a>=3757&&a<=3758||a==3760||a>=3762&&a<=3763||a==3773||a>=3776&&a<=3780||a>=3904&&a<=3911||a>=3913&&a<=3945||a>=4256&&a<=4293||a>=4304&&a<=4342||a==4352||a>=4354&&a<=4355||a>=4357&&a<=4359||a==4361||a>=4363&&a<=4364||a>=4366&&a<=4370||a==4412||a==4414||a==4416||a==4428||a==4430||a==4432||a>=4436&&a<=4437||a==4441||a>=4447&&a<=4449||a==4451||a==4453||a==4455||a==4457||a>=4461&&a<=4462||a>=4466&&a<=4467||a==4469||a==4510||a==4520||a==4523||a>=4526&&a<=4527||a>=4535&&a<=4536||a==4538||a>=4540&&a<=4546||a==4587||a==4592||a==4601||a>=7680&&a<=7835||a>=7840&&a<=7929||a>=7936&&a<=7957||a>=7960&&a<=7965||a>=7968&&a<=8005||a>=8008&&a<=8013||a>=8016&&a<=8023||a==8025||a==8027||a==8029||a>=8031&&a<=8061||a>=8064&&a<=8116||a>=8118&&a<=8124||a==8126||a>=8130&&a<=8132||a>=8134&&a<=8140||a>=8144&&a<=8147||a>=8150&&a<=8155||a>=8160&&a<=8172||a>=8178&&a<=8180||a>=8182&&a<=8188||a==8486||a>=8490&&a<=8491||a==8494||a>=8576&&a<=8578||a>=12353&&a<=12436||a>=12449&&a<=12538||a>=12549&&a<=12588||a>=44032&&a<=55203||a>=19968&&a<=40869||a==12295||a>=12321&&a<=12329;};Utilities.isNCNameChar=function(a){return a>=48&&a<=57||a>=1632&&a<=1641||a>=1776&&a<=1785||a>=2406&&a<=2415||a>=2534&&a<=2543||a>=2662&&a<=2671||a>=2790&&a<=2799||a>=2918&&a<=2927||a>=3047&&a<=3055||a>=3174&&a<=3183||a>=3302&&a<=3311||a>=3430&&a<=3439||a>=3664&&a<=3673||a>=3792&&a<=3801||a>=3872&&a<=3881||a==46||a==45||a==95||Utilities.isLetter(a)||a>=768&&a<=837||a>=864&&a<=865||a>=1155&&a<=1158||a>=1425&&a<=1441||a>=1443&&a<=1465||a>=1467&&a<=1469||a==1471||a>=1473&&a<=1474||a==1476||a>=1611&&a<=1618||a==1648||a>=1750&&a<=1756||a>=1757&&a<=1759||a>=1760&&a<=1764||a>=1767&&a<=1768||a>=1770&&a<=1773||a>=2305&&a<=2307||a==2364||a>=2366&&a<=2380||a==2381||a>=2385&&a<=2388||a>=2402&&a<=2403||a>=2433&&a<=2435||a==2492||a==2494||a==2495||a>=2496&&a<=2500||a>=2503&&a<=2504||a>=2507&&a<=2509||a==2519||a>=2530&&a<=2531||a==2562||a==2620||a==2622||a==2623||a>=2624&&a<=2626||a>=2631&&a<=2632||a>=2635&&a<=2637||a>=2672&&a<=2673||a>=2689&&a<=2691||a==2748||a>=2750&&a<=2757||a>=2759&&a<=2761||a>=2763&&a<=2765||a>=2817&&a<=2819||a==2876||a>=2878&&a<=2883||a>=2887&&a<=2888||a>=2891&&a<=2893||a>=2902&&a<=2903||a>=2946&&a<=2947||a>=3006&&a<=3010||a>=3014&&a<=3016||a>=3018&&a<=3021||a==3031||a>=3073&&a<=3075||a>=3134&&a<=3140||a>=3142&&a<=3144||a>=3146&&a<=3149||a>=3157&&a<=3158||a>=3202&&a<=3203||a>=3262&&a<=3268||a>=3270&&a<=3272||a>=3274&&a<=3277||a>=3285&&a<=3286||a>=3330&&a<=3331||a>=3390&&a<=3395||a>=3398&&a<=3400||a>=3402&&a<=3405||a==3415||a==3633||a>=3636&&a<=3642||a>=3655&&a<=3662||a==3761||a>=3764&&a<=3769||a>=3771&&a<=3772||a>=3784&&a<=3789||a>=3864&&a<=3865||a==3893||a==3895||a==3897||a==3902||a==3903||a>=3953&&a<=3972||a>=3974&&a<=3979||a>=3984&&a<=3989||a==3991||a>=3993&&a<=4013||a>=4017&&a<=4023||a==4025||a>=8400&&a<=8412||a==8417||a>=12330&&a<=12335||a==12441||a==12442||a==183||a==720||a==721||a==903||a==1600||a==3654||a==3782||a==12293||a>=12337&&a<=12341||a>=12445&&a<=12446||a>=12540&&a<=12542;};Utilities.coalesceText=function(g){for(var a=g.firstChild;a!=null;a=a.nextSibling){if(a.nodeType==3||a.nodeType==4){var d=a.nodeValue;var b=a;a=a.nextSibling;while(a!=null&&(a.nodeType==3||a.nodeType==4)){d+=a.nodeValue;var e=a;a=a.nextSibling;e.parentNode.removeChild(e);}if(b.nodeType==4){var c=b.parentNode;if(b.nextSibling==null){c.removeChild(b);c.appendChild(c.ownerDocument.createTextNode(d));}else{var f=b.nextSibling;c.removeChild(b);c.insertBefore(c.ownerDocument.createTextNode(d),f);}}else{b.nodeValue=d;}if(a==null){break;}}else if(a.nodeType==1){Utilities.coalesceText(a);}}};Utilities.instance_of=function(a,b){while(a!=null){if(a.constructor===b){return true;}if(a===Object){return false;}a=a.constructor.superclass;}return false;};Utilities.getElementById=function(a,c){if(a.nodeType==1){if(a.getAttribute('id')==c||a.getAttributeNS(null,'id')==c){return a;}}for(var b=a.firstChild;b!=null;b=b.nextSibling){var d=Utilities.getElementById(b,c);if(d!=null){return d;}}return null;};m.prototype={};m.prototype.constructor=m;m.superclass=Object.prototype;function m(a,b){this.code=a;this.exception=b;}m.prototype.toString=function(){var a=this.exception?': '+this.exception.toString():'';switch(this.code){case m.INVALID_EXPRESSION_ERR:return'Invalid expression'+a;case m.TYPE_ERR:return'Type error'+a;}};m.INVALID_EXPRESSION_ERR=51;m.TYPE_ERR=52;O.prototype={};O.prototype.constructor=O;O.superclass=Object.prototype;function O(a,b,c){this.xpath=c.parse(a);this.context=new M();this.context.namespaceResolver=new N(b);}O.prototype.evaluate=function(b,c,d){this.context.expressionContextNode=b;var a=this.xpath.evaluate(this.context);return new i(a,c);};N.prototype={};N.prototype.constructor=N;N.superclass=Object.prototype;function N(a){this.xpathNSResolver=a;}N.prototype.getNamespace=function(a,b){if(this.xpathNSResolver==null){return null;}return this.xpathNSResolver.lookupNamespaceURI(a);};P.prototype={};P.prototype.constructor=P;P.superclass=Object.prototype;function P(a){this.node=a;this.namespaceResolver=new H();}P.prototype.lookupNamespaceURI=function(a){return this.namespaceResolver.getNamespace(a,this.node);};i.prototype={};i.prototype.constructor=i;i.superclass=Object.prototype;function i(a,b){if(b==i.ANY_TYPE){if(a.constructor===d){b=i.STRING_TYPE;}else if(a.constructor===f){b=i.NUMBER_TYPE;}else if(a.constructor===e){b=i.BOOLEAN_TYPE;}else if(a.constructor===c){b=i.UNORDERED_NODE_ITERATOR_TYPE;}}this.resultType=b;switch(b){case i.NUMBER_TYPE:this.numberValue=a.numberValue();return;case i.STRING_TYPE:this.stringValue=a.stringValue();return;case i.BOOLEAN_TYPE:this.booleanValue=a.booleanValue();return;case i.ANY_UNORDERED_NODE_TYPE:case i.FIRST_ORDERED_NODE_TYPE:if(a.constructor===c){this.singleNodeValue=a.first();return;}break;case i.UNORDERED_NODE_ITERATOR_TYPE:case i.ORDERED_NODE_ITERATOR_TYPE:if(a.constructor===c){this.invalidIteratorState=false;this.nodes=a.toArray();this.iteratorIndex=0;return;}break;case i.UNORDERED_NODE_SNAPSHOT_TYPE:case i.ORDERED_NODE_SNAPSHOT_TYPE:if(a.constructor===c){this.nodes=a.toArray();this.snapshotLength=this.nodes.length;return;}break;}throw new m(m.TYPE_ERR);};i.prototype.iterateNext=function(){if(this.resultType!=i.UNORDERED_NODE_ITERATOR_TYPE&&this.resultType!=i.ORDERED_NODE_ITERATOR_TYPE){throw new m(m.TYPE_ERR);}return this.nodes[this.iteratorIndex++];};i.prototype.snapshotItem=function(a){if(this.resultType!=i.UNORDERED_NODE_SNAPSHOT_TYPE&&this.resultType!=i.ORDERED_NODE_SNAPSHOT_TYPE){throw new m(m.TYPE_ERR);}return this.nodes[a];};i.ANY_TYPE=0;i.NUMBER_TYPE=1;i.STRING_TYPE=2;i.BOOLEAN_TYPE=3;i.UNORDERED_NODE_ITERATOR_TYPE=4;i.ORDERED_NODE_ITERATOR_TYPE=5;i.UNORDERED_NODE_SNAPSHOT_TYPE=6;i.ORDERED_NODE_SNAPSHOT_TYPE=7;i.ANY_UNORDERED_NODE_TYPE=8;i.FIRST_ORDERED_NODE_TYPE=9;a.FunctionResolver=z;a.VariableResolver=J;a.NamespaceResolver=H;a.XPathContext=M;a.XString=d;a.XNumber=f;a.XBoolean=e;self.XPathParser=a;}();
TP.boot.$srcPath = '';

        
        TP.extern.XPathParser = XPathParser;
        
    
TP.boot.$srcPath = '~lib_src/tibet/storage/TP.core.DeviceStorage.js';
TP.lang.Object.defineSubtype('core:DeviceStorage');TP.core.DeviceStorage.isAbstract(true);TP.core.DeviceStorage.Inst.defineMethod('at',function(a){return TP.override();});TP.core.DeviceStorage.Inst.defineMethod('atEncrypted',function(a,b){var c,d;if(!TP.isString(a)||!TP.isString(b)){return this.raise('TP.sig.InvalidString',arguments);}if(TP.isEmpty(c=this.at(a))){return null;}d=TP.decryptStorageValue(c,b);return d;});TP.core.DeviceStorage.Inst.defineMethod('atPut',function(a,b){return TP.override();});TP.core.DeviceStorage.Inst.defineMethod('atPutEncrypted',function(a,b,c){var d;if(!TP.isString(a)||!TP.isString(b)||!TP.isString(c)){return this.raise('TP.sig.InvalidString',arguments);}d=TP.encryptStorageValue(b,c);this.atPut(a,d);return this;});TP.core.DeviceStorage.Inst.defineMethod('empty',function(){return TP.override();});TP.core.DeviceStorage.Inst.defineMethod('removeKey',function(a){return TP.override();});
TP.boot.$srcPath = '~lib_src/tibet/storage/TP.core.LocalStorage.js';
TP.core.DeviceStorage.defineSubtype('LocalStorage');TP.core.LocalStorage.Type.defineMethod('canConstruct',function(){if(TP.boot.isUA('IE')&&!TP.sys.isHTTPBased()){return false;}return true;});TP.core.LocalStorage.Inst.defineMethod('at',function(a){if(TP.isDefined(this[a])){if(TP.canInvoke(this,'get')){return this.get(a);}return this[a];}if(TP.isValid(window.localStorage)){return window.localStorage.getItem(a);}return null;});TP.core.LocalStorage.Inst.defineMethod('atPut',function(a,b){if(TP.isDefined(this[a])){return this.$set(a>0?a:this.normalizeIndex(a),b);}if(TP.isValid(window.localStorage)){return window.localStorage.setItem(a,b);}return this;});TP.core.LocalStorage.Inst.defineMethod('empty',function(){if(TP.isValid(window.localStorage)){return window.localStorage.clear();}return this;});TP.core.LocalStorage.Inst.defineMethod('removeKey',function(a){if(TP.isValid(window.localStorage)){return window.localStorage.removeItem(a);}return this;});
TP.boot.$srcPath = '~lib_src/tibet/storage/localdb/TP.sig.LocalDBStorageRequest.js';
TP.sig.IORequest.defineSubtype('LocalDBStorageRequest');TP.sig.LocalDBStorageRequest.Type.defineAttribute('responseType','TP.sig.LocalDBStorageResponse');
TP.boot.$srcPath = '~lib_src/tibet/storage/localdb/TP.sig.LocalDBStorageResponse.js';
TP.sig.IOResponse.defineSubtype('LocalDBStorageResponse');
TP.boot.$srcPath = '~lib_src/tibet/storage/localdb/TP.core.LocalDBStorageService.js';
TP.core.IOService.defineSubtype('LocalDBStorageService');TP.core.LocalDBStorageService.Type.defineAttribute('triggerSignals','TP.sig.LocalDBStorageRequest');TP.core.LocalDBStorageService.Type.defineAttribute('supportedModes',TP.core.SyncAsync.SYNCHRONOUS);TP.core.LocalDBStorageService.Type.defineAttribute('mode',TP.core.SyncAsync.SYNCHRONOUS);TP.core.LocalDBStorageService.register();TP.core.LocalDBStorageService.Inst.defineMethod('handleLocalDBStorageRequest',function(g){var f,l,n,e,a,i,c,d,h,b,m,j,k;f=TP.request(g);f.atPut('async',this.rewriteRequestMode(f));if(TP.notValid(l=TP.core.LocalStorage.construct())){f.fail(TP.FAILURE,TP.sc('Cannot open local DB storage instance.'));return this;}i=false;if(TP.notValid(n=l.at(TP.LOCALSTORAGE_DB_NAME))){e=TP.hc();i=true;}else{if(TP.notValid(e=TP.json2js(n))){f.fail(TP.FAILURE,TP.sc('Local DB storage instance is corrupted.'));return this;}}c=g.at('id');d=g.at('dbName');h=g.at('body');b=null;m=function(c){var a,b;a=c.copy();b=a.at('_body');if(TP.notEmpty(j=g.at('securePW'))){b=TP.decryptStorageValue(b,j);a.atPut('_body',b);}return a;};switch(g.at('action')){case'deleteDB':if(TP.notValid(e.at(d))){f.fail(TP.FAILURE,TP.sc('Can\'t delete non-existent database named: ',d,'.'));return this;}e.removeKey(d);b=TP.hc('ok',true);i=true;break;case'deleteItem':if(TP.notValid(a=e.at(d))){f.fail(TP.FAILURE,TP.sc('Can\'t delete item in non-existent database named: ',d,'.'));return this;}if(TP.notValid(b=a.at(c))){f.fail(TP.FAILURE,TP.sc('Can\'t find item with id: ',c,' in database:',d,' to delete.'));return this;}a.removeKey(c);b=TP.hc('ok',true);i=true;break;case'retrieveItem':if(TP.isValid(a=e.at(d))){if(TP.isValid(a.at(c))){b=m(a.at(c));}}break;case'retrieveItemInfo':if(TP.isValid(a=e.at(d))){b=a.at(c);b=TP.hc('_date_created',b.at('_date_created'),'_date_modified',b.at('_date_modified'));}break;case'retrieveDBInfo':if(TP.isValid(a=e.at(d))){b=TP.hc('total_rows',a.getSize());k=TP.ac();a.perform(function(a){k.push(m(a.last()));});b.atPut('rows',k);}break;case'createItem':if(TP.notValid(a=e.at(d))){a=TP.hc();e.atPut(d,a);}if(TP.isValid(a.at(c))){f.fail(TP.FAILURE,TP.sc('Already had item with id: ',c,' in database:',d,'.'));}else{c=TP.isEmpty(c)?TP.genUUID():c;if(TP.notEmpty(j=g.at('securePW'))){h=TP.encryptStorageValue(TP.js2json(h),j);}b=TP.hc('_id',c,'_date_created',TP.dc(),'_date_modified',TP.dc(),'_body',h);a.atPut(c,b);b=TP.hc('ok',true,'_id',c);i=true;}break;case'updateItem':if(TP.notValid(a=e.at(d))){a=TP.hc();e.atPut(d,a);}if(TP.notEmpty(j=g.at('securePW'))){h=TP.encryptStorageValue(TP.js2json(h),j);}if(TP.notValid(b=a.at(c))){b=TP.hc('_id',c,'_date_created',TP.dc(),'_body',h);}else{b.atPut('_body',h);}b.atPut('_date_modified',TP.dc());a.atPut(c,b);i=true;b=TP.hc('ok',true,'_id',c);break;default:break;}if(i){l.atPut(TP.LOCALSTORAGE_DB_NAME,TP.js2json(e));}g.complete(b);return this;});
TP.boot.$srcPath = '~lib_src/tibet/storage/localdb/TP.core.LocalDBURL.js';
TP.core.URL.defineSubtype('TP.core.LocalDBURL');TP.core.LocalDBURL.Type.defineConstant('LOCALDB_REGEX',TP.rc('^localdb://([^/]+)(/([^?]+)(\\??(\\S*))?)?'));TP.core.LocalDBURL.Type.defineConstant('SCHEME','localdb');TP.core.LocalDBURL.Type.defineAttribute('supportedModes',TP.core.SyncAsync.SYNCHRONOUS);TP.core.LocalDBURL.Type.defineAttribute('mode',TP.core.SyncAsync.SYNCHRONOUS);TP.core.LocalDBURL.registerForScheme('localdb');TP.core.LocalDBURL.Inst.defineAttribute('query');TP.core.LocalDBURL.Inst.defineAttribute('queryDict');TP.core.LocalDBURL.Inst.defineAttribute('dbName');TP.core.LocalDBURL.Inst.defineAttribute('resourceID');TP.core.LocalDBURL.Inst.defineAttribute('$lastAdded');TP.core.LocalDBURL.Type.defineMethod('$getDefaultHandler',function(a,b){return TP.core.LocalDBURLHandler;});TP.core.LocalDBURL.Inst.defineMethod('init',function(c){var a,d,e,b,f;this.callNextMethod();a=this.getType().LOCALDB_REGEX.exec(c);if(TP.notValid(a)||TP.isEmpty(d=a.at(1))){return this.raise('TP.sig.InvalidURI',arguments,'Invalid local URL - no dbName: '+c);}this.set('path',TP.join(a.at(1),'/',a.at(3)));this.set('dbName',d);if(TP.notEmpty(e=a.at(3))){this.set('resourceID',e);}if(TP.notEmpty(b=a.at(5))){this.set('query',b);f=TP.lang.Hash.fromString(b);this.set('queryDict',f);}return this;});TP.core.LocalDBURL.Inst.defineMethod('addResource',function(b,a,c){this.set('$lastAdded',a);return;});TP.core.LocalDBURL.Inst.defineMethod('getContent',function(a){if(TP.isValid(a)){a.atPutIfAbsent('refresh',true);}return this.callNextMethod();});
TP.boot.$srcPath = '~lib_src/tibet/storage/localdb/TP.core.LocalDBURLHandler.js';
TP.core.URIHandler.defineSubtype('LocalDBURLHandler');TP.core.LocalDBURLHandler.Type.defineMethod('load',function(b,k){var a,e,f,c,g,h,i,j,d;TP.debug('break.uri_load');a=TP.request(k);e=a.constructResponse();if(TP.notValid(g=b.get('dbName'))){a.fail(TP.FAILURE,'No db name specified for: '+TP.str(b));return e;}c=b.get('resourceID');if(a.at('verb')===TP.HTTP_HEAD){f='retrieveItemInfo';}else if(TP.isValid(c)){if(c==='_all_docs'){f='retrieveDBInfo';}else{f='retrieveItem';}}else{a.fail(TP.FAILURE,'Can\'t compute a load action for: '+TP.str(b));return e;}if(TP.isValid(h=b.get('queryDict'))){i=h.at('securePW');}j=TP.hc('action',f,'dbName',g,'securePW',i,'id',c);d=TP.sig.LocalDBStorageRequest.construct(j);a.andJoinChild(d);d.fire();a.updateRequestMode(d);return e;});TP.core.LocalDBURLHandler.Type.defineMethod('nuke',function(c,k){var a,d,e,f,h,i,j,g,b;TP.debug('break.uri_nuke');a=TP.request(k);d=a.constructResponse();if(TP.notValid(f=c.get('dbName'))){a.fail(TP.FAILURE,'No db name specified for: '+TP.str(c));return d;}if(TP.isValid(h=c.get('resourceID'))){e='deleteItem';}else{e='deleteDB';}if(TP.isValid(i=c.get('queryDict'))){j=i.at('securePW');}g=TP.hc('action',e,'dbName',f,'securePW',j,'id',h);b=TP.sig.LocalDBStorageRequest.construct(g);a.andJoinChild(b);b.fire();a.updateRequestMode(b);return d;});TP.core.LocalDBURLHandler.Type.defineMethod('save',function(b,l){var a,c,f,g,k,i,j,h,e,d;TP.debug('break.uri_save');a=TP.request(l);c=a.constructResponse();if(TP.notValid(f=b.get('dbName'))){a.fail(TP.FAILURE,'No db name specified for: '+TP.str(b));return c;}g=b.get('resourceID');j=a.at('cmdAction');if(j===TP.ADD){}else{if(TP.isEmpty(h=b.getResource(TP.hc('refresh',false,'async',false)))){a.fail(TP.FAILURE,'No content to save for: '+TP.str(b));return c;}}if(TP.isValid(k=b.get('queryDict'))){i=k.at('securePW');}if(a.at('verb')===TP.HTTP_PUT){if(TP.notValid(g)){a.fail(TP.FAILURE,'No resource ID specified for: '+TP.str(b));return c;}e=TP.hc('action','updateItem','dbName',f,'securePW',i,'id',g,'body',h);}else{e=TP.hc('action','createItem','dbName',f,'securePW',i,'body',h);}d=TP.sig.LocalDBStorageRequest.construct(e);a.andJoinChild(d);d.fire();a.updateRequestMode(d);return c;});
TP.boot.$srcPath = '~app/node_modules/tibet/deps/pouchdb-tpi.min.js';
//    PouchDB 3.0.5
//    
//    (c) 2012-2014 Dale Harvey and the PouchDB team
//    PouchDB may be freely distributed under the Apache license, version 2.0.
//    For all details and documentation:
//    http://pouchdb.com
!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.PouchDB=e()}}(function(){var define,module,exports;return function e(t,n,r){function o(s,a){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);throw new Error("Cannot find module '"+s+"'")}var c=n[s]={exports:{}};t[s][0].call(c.exports,function(e){var n=t[s][1][e];return o(n?n:e)},c,c.exports,e,t,n,r)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<r.length;s++)o(r[s]);return o}({1:[function(e,t){"use strict";function n(e,t){for(var n=0;n<e.length;n++)if(t(e[n],n)===!0)return e[n];return!1}function r(e){return function(t,n){t||n[0].error?e(t||n[0]):e(null,n[0])}}function o(e){var t={},n=[];return u.traverseRevTree(e,function(e,r,o,i){var s=r+"-"+o;return e&&(t[s]=0),void 0!==i&&n.push({from:i,to:s}),s}),n.reverse(),n.forEach(function(e){t[e.from]=void 0===t[e.from]?1+t[e.to]:Math.min(t[e.from],1+t[e.to])}),t}function i(e,t,n){var r="limit"in t?t.keys.slice(t.skip,t.limit+t.skip):t.skip>0?t.keys.slice(t.skip):t.keys;if(t.descending&&r.reverse(),!r.length)return e._allDocs({limit:0},n);var o={offset:t.skip};return p.all(r.map(function(n){var r=a.extend(!0,{key:n,deleted:"ok"},t);return["limit","skip","keys"].forEach(function(e){delete r[e]}),new p(function(t,i){e._allDocs(r,function(e,r){return e?i(e):(o.total_rows=r.total_rows,void t(r.rows[0]||{key:n,error:"not_found"}))})})})).then(function(e){return o.rows=e,o})}function s(){var e=this;l.call(this),e.autoCompact=function(t){return e.auto_compaction&&"http"!==e.type()?function(n,r){if(n)t(n);else{var o=r.length,i=function(){o--,o||t(null,r)};if(!r.length)return t(null,r);r.forEach(function(t){t.ok&&t.id?e.compactDocument(t.id,1,i):i()})}}:t};var t,n=0,r=["change","delete","create","update"];this.on("newListener",function(o){if(~r.indexOf(o)){if(n)return void n++;n++;var i=0;t=this.changes({conflicts:!0,include_docs:!0,continuous:!0,since:"now",onChange:function(t){t.seq<=i||(i=t.seq,e.emit("change",t),t.doc._deleted?e.emit("delete",t):"1"===t.doc._rev.split("-")[0]?e.emit("create",t):e.emit("update",t))}})}}),this.on("removeListener",function(e){~r.indexOf(e)&&(n--,n||t.cancel())})}var a=e("./utils"),u=e("./merge"),c=e("./deps/errors"),l=e("events").EventEmitter,d=e("./deps/upsert"),f=e("./changes"),p=a.Promise;a.inherits(s,l),t.exports=s,s.prototype.post=a.adapterFun("post",function(e,t,n){return"function"==typeof t&&(n=t,t={}),"object"!=typeof e||Array.isArray(e)?n(c.NOT_AN_OBJECT):void this.bulkDocs({docs:[e]},t,this.autoCompact(r(n)))}),s.prototype.put=a.adapterFun("put",a.getArguments(function(e){var t,n,o,i,s=e.shift(),u="_id"in s;if("object"!=typeof s||Array.isArray(s))return(i=e.pop())(c.NOT_AN_OBJECT);for(s=a.clone(s);;)if(t=e.shift(),n=typeof t,"string"!==n||u?"string"!==n||!u||"_rev"in s?"object"===n?o=t:"function"===n&&(i=t):s._rev=t:(s._id=t,u=!0),!e.length)break;o=o||{};var l=a.invalidIdError(s._id);return l?i(l):a.isLocalId(s._id)&&"function"==typeof this._putLocal?s._deleted?this._removeLocal(s,i):this._putLocal(s,i):void this.bulkDocs({docs:[s]},o,this.autoCompact(r(i)))})),s.prototype.putAttachment=a.adapterFun("putAttachment",function(e,t,n,r,o,i){function s(e){return e._attachments=e._attachments||{},e._attachments[t]={content_type:o,data:r},a.put(e)}var a=this;return"function"==typeof o&&(i=o,o=r,r=n,n=null),"undefined"==typeof o&&(o=r,r=n,n=null),a.get(e).then(function(e){if(e._rev!==n)throw c.REV_CONFLICT;return s(e)},function(t){if(t.error===c.MISSING_DOC.error)return s({_id:e});throw t})}),s.prototype.removeAttachment=a.adapterFun("removeAttachment",function(e,t,n,r){var o=this;o.get(e,function(e,i){return e?void r(e):i._rev!==n?void r(c.REV_CONFLICT):i._attachments?(delete i._attachments[t],0===Object.keys(i._attachments).length&&delete i._attachments,void o.put(i,r)):r()})}),s.prototype.remove=a.adapterFun("remove",function(e,t,n,o){var i;"string"==typeof t?(i={_id:e,_rev:t},"function"==typeof n&&(o=n,n={})):(i=e,"function"==typeof t?(o=t,n={}):(o=n,n=t)),n=a.clone(n||{}),n.was_delete=!0;var s={_id:i._id,_rev:i._rev||n.rev};return s._deleted=!0,a.isLocalId(s._id)&&"function"==typeof this._removeLocal?this._removeLocal(i,o):void this.bulkDocs({docs:[s]},n,r(o))}),s.prototype.revsDiff=a.adapterFun("revsDiff",function(e,t,n){function r(e,t){c.has(e)||c.set(e,{missing:[]}),c.get(e).missing.push(t)}function o(t,n){var o=e[t].slice(0);u.traverseRevTree(n,function(e,n,i,s,a){var u=n+"-"+i,c=o.indexOf(u);-1!==c&&(o.splice(c,1),"available"!==a.status&&r(t,u))}),o.forEach(function(e){r(t,e)})}"function"==typeof t&&(n=t,t={}),t=a.clone(t);var i=Object.keys(e);if(!i.length)return n(null,{});var s=0,c=new a.Map;i.map(function(t){this._getRevisionTree(t,function(r,a){if(r&&404===r.status&&"missing"===r.message)c.set(t,{missing:e[t]});else{if(r)return n(r);o(t,a)}if(++s===i.length){var u={};return c.forEach(function(e,t){u[t]=e}),n(null,u)}})},this)}),s.prototype.compactDocument=a.adapterFun("compactDocument",function(e,t,n){var r=this;this._getRevisionTree(e,function(i,s){if(i)return n(i);var a=o(s),c=[],l=[];Object.keys(a).forEach(function(e){a[e]>t&&c.push(e)}),u.traverseRevTree(s,function(e,t,n,r,o){var i=t+"-"+n;"available"===o.status&&-1!==c.indexOf(i)&&(o.status="missing",l.push(i))}),r._doCompaction(e,s,l,n)})}),s.prototype.compact=a.adapterFun("compact",function(e,t){"function"==typeof e&&(t=e,e={});var n=this;this.changes({complete:function(e,r){if(e)return void t();var o=r.results.length;return o?void r.results.forEach(function(e){n.compactDocument(e.id,0,function(){o--,o||t()})}):void t()}})}),s.prototype.get=a.adapterFun("get",function(e,t,r){function o(){var n=[],o=i.length;return o?void i.forEach(function(i){s.get(e,{rev:i,revs:t.revs,attachments:t.attachments},function(e,t){n.push(e?{missing:i}:{ok:t}),o--,o||r(null,n)})}):r(null,n)}if("function"==typeof t&&(r=t,t={}),"string"!=typeof e)return r(c.INVALID_ID);if(a.isLocalId(e)&&"function"==typeof this._getLocal)return this._getLocal(e,r);var i=[],s=this;if(!t.open_revs)return this._get(e,t,function(e,o){if(t=a.clone(t),e)return r(e);var i=o.doc;if(!i)return r(new Error("no doc!"));var c=o.metadata,l=o.ctx;if(t.conflicts){var d=u.collectConflicts(c);d.length&&(i._conflicts=d)}if(t.revs||t.revs_info){var f=u.rootToLeaf(c.rev_tree),p=n(f,function(e){return-1!==e.ids.map(function(e){return e.id}).indexOf(i._rev.split("-")[1])}),h=p.ids.map(function(e){return e.id}).indexOf(i._rev.split("-")[1])+1,v=p.ids.length-h;if(p.ids.splice(h,v),p.ids.reverse(),t.revs&&(i._revisions={start:p.pos+p.ids.length-1,ids:p.ids.map(function(e){return e.id})}),t.revs_info){var m=p.pos+p.ids.length;i._revs_info=p.ids.map(function(e){return m--,{rev:m+"-"+e.id,status:e.opts.status}})}}if(t.local_seq&&(i._local_seq=o.metadata.seq),t.attachments&&i._attachments){var _=i._attachments,y=Object.keys(_).length;if(0===y)return r(null,i);Object.keys(_).forEach(function(e){this._getAttachment(_[e],{encode:!0,ctx:l},function(t,n){var o=i._attachments[e];o.data=n,delete o.stub,--y||r(null,i)})},s)}else{if(i._attachments)for(var g in i._attachments)i._attachments.hasOwnProperty(g)&&(i._attachments[g].stub=!0);r(null,i)}});if("all"===t.open_revs)this._getRevisionTree(e,function(e,t){e&&(t=[]),i=u.collectLeaves(t).map(function(e){return e.rev}),o()});else{if(!Array.isArray(t.open_revs))return r(c.error(c.UNKNOWN_ERROR,"function_clause"));i=t.open_revs;for(var l=0;l<i.length;l++){var d=i[l];if("string"!=typeof d||!/^\d+-/.test(d))return r(c.error(c.BAD_REQUEST,"Invalid rev format"))}o()}}),s.prototype.getAttachment=a.adapterFun("getAttachment",function(e,t,n,r){var o=this;n instanceof Function&&(r=n,n={}),n=a.clone(n),this._get(e,n,function(e,i){return e?r(e):i.doc._attachments&&i.doc._attachments[t]?(n.ctx=i.ctx,void o._getAttachment(i.doc._attachments[t],n,r)):r(c.MISSING_DOC)})}),s.prototype.allDocs=a.adapterFun("allDocs",function(e,t){if("function"==typeof e&&(t=e,e={}),e=a.clone(e),e.skip="undefined"!=typeof e.skip?e.skip:0,"keys"in e){if(!Array.isArray(e.keys))return t(new TypeError("options.keys must be an array"));var n=["startkey","endkey","key"].filter(function(t){return t in e})[0];if(n)return void t(c.error(c.QUERY_PARSE_ERROR,"Query parameter `"+n+"` is not compatible with multi-get"));if("http"!==this.type())return i(this,e,t)}return this._allDocs(e,t)}),s.prototype.changes=function(e,t){return"function"==typeof e&&(t=e,e={}),new f(this,e,t)},s.prototype.close=a.adapterFun("close",function(e){return this._closed=!0,this._close(e)}),s.prototype.info=a.adapterFun("info",function(e){var t=this;this._info(function(n,r){return n?e(n):(r.db_name=r.db_name||t._db_name,void e(null,r))})}),s.prototype.id=a.adapterFun("id",function(e){return this._id(e)}),s.prototype.type=function(){return"function"==typeof this._type?this._type():this.adapter},s.prototype.bulkDocs=a.adapterFun("bulkDocs",function(e,t,n){if("function"==typeof t&&(n=t,t={}),t=a.clone(t),Array.isArray(e)&&(e={docs:e}),!e||!e.docs||!Array.isArray(e.docs))return n(c.MISSING_BULK_DOCS);for(var r=0;r<e.docs.length;++r)if("object"!=typeof e.docs[r]||Array.isArray(e.docs[r]))return n(c.NOT_AN_OBJECT);return e=a.clone(e),"new_edits"in t||(t.new_edits="new_edits"in e?e.new_edits:!0),this._bulkDocs(e,t,this.autoCompact(n))}),s.prototype.registerDependentDatabase=a.adapterFun("registerDependentDatabase",function(e,t){function n(t){return t.dependentDbs=t.dependentDbs||{},t.dependentDbs[e]?!1:(t.dependentDbs[e]=!0,t)}var r=new this.constructor(e,{adapter:this._adapter});d(this,"_local/_pouch_dependentDbs",n,function(e){return e?t(e):t(null,{db:r})})})},{"./changes":6,"./deps/errors":11,"./deps/upsert":13,"./merge":18,"./utils":23,events:27}],2:[function(e,t){(function(n){"use strict";function r(e){for(var t=r.options,n=t.parser[t.strictMode?"strict":"loose"].exec(e),o={},i=14;i--;)o[t.key[i]]=n[i]||"";return o[t.q.name]={},o[t.key[12]].replace(t.q.parser,function(e,n,r){n&&(o[t.q.name][n]=r)}),o}function o(e){return/^_(design|local)/.test(e)?e:encodeURIComponent(e)}function i(e){return e._attachments&&Object.keys(e._attachments)?d.Promise.all(Object.keys(e._attachments).map(function(t){var r=e._attachments[t];if(r.data&&"string"!=typeof r.data){if(void 0===typeof n||n.browser)return new d.Promise(function(e){var t=new FileReader;t.onloadend=function(t){r.data=d.btoa(d.arrayBufferToBinaryString(t.target.result)),e()},t.readAsArrayBuffer(r.data)});r.data=r.data.toString("base64")}})):d.Promise.resolve()}function s(e,t){if(/http(s?):/.test(e)){var n=r(e);n.remote=!0,(n.user||n.password)&&(n.auth={username:n.user,password:n.password});var o=n.path.replace(/(^\/|\/$)/g,"").split("/");if(n.db=o.pop(),n.path=o.join("/"),t=t||{},t=d.clone(t),n.headers=t.headers||{},t.auth||n.auth){var i=t.auth||n.auth,s=d.btoa(i.username+":"+i.password);n.headers.Authorization="Basic "+s}return t.headers&&(n.headers=t.headers),n}return{host:"",path:"/",db:e,auth:!1}}function a(e,t){return u(e,e.db+"/"+t)}function u(e,t){if(e.remote){var n=e.path?"/":"";return e.protocol+"://"+e.host+":"+e.port+"/"+e.path+n+t}return"/"+t}function c(e,t){function n(e,t){return d.ajax(d.extend({},h,e),t)}var r=this;r.getHost=e.getHost?e.getHost:s;var c=r.getHost(e.name,e),p=a(c,"");r.getUrl=function(){return p},r.getHeaders=function(){return d.clone(c.headers)};var h=e.ajax||{};e=d.clone(e);var v=function(){n({headers:c.headers,method:"PUT",url:p},function(e){e&&401===e.status?n({headers:c.headers,method:"HEAD",url:p},function(e){e?t(e):t(null,r)}):e&&412!==e.status?t(e):t(null,r)})};e.skipSetup||n({headers:c.headers,method:"GET",url:p},function(e){e?404===e.status?v():t(e):t(null,r)}),r.type=function(){return"http"},r.id=d.adapterFun("id",function(e){n({headers:c.headers,method:"GET",url:u(c,"")},function(t,n){var r=n&&n.uuid?n.uuid+c.db:a(c,"");e(null,r)})}),r.request=d.adapterFun("request",function(e,t){e.headers=c.headers,e.url=a(c,e.url),n(e,t)}),r.compact=d.adapterFun("compact",function(e,t){"function"==typeof e&&(t=e,e={}),e=d.clone(e),n({headers:c.headers,url:a(c,"_compact"),method:"POST"},function(){function n(){r.info(function(r,o){o.compact_running?setTimeout(n,e.interval||200):t()})}"function"==typeof t&&n()})}),r._info=function(e){n({headers:c.headers,method:"GET",url:a(c,"")},function(t,n){t?e(t):(n.host=a(c,""),e(null,n))})},r.get=d.adapterFun("get",function(e,t,r){"function"==typeof t&&(r=t,t={}),t=d.clone(t),void 0===t.auto_encode&&(t.auto_encode=!0);var i=[];t.revs&&i.push("revs=true"),t.revs_info&&i.push("revs_info=true"),t.local_seq&&i.push("local_seq=true"),t.open_revs&&("all"!==t.open_revs&&(t.open_revs=JSON.stringify(t.open_revs)),i.push("open_revs="+t.open_revs)),t.attachments&&i.push("attachments=true"),t.rev&&i.push("rev="+t.rev),t.conflicts&&i.push("conflicts="+t.conflicts),i=i.join("&"),i=""===i?"":"?"+i,t.auto_encode&&(e=o(e));var s={headers:c.headers,method:"GET",url:a(c,e+i)},u=e.split("/");(u.length>1&&"_design"!==u[0]&&"_local"!==u[0]||u.length>2&&"_design"===u[0]&&"_local"!==u[0])&&(s.binary=!0),n(s,function(e,t,n){return e?r(e):void r(null,t,n)})}),r.remove=d.adapterFun("remove",function(e,t,r,i){var s;"string"==typeof t?(s={_id:e,_rev:t},"function"==typeof r&&(i=r,r={})):(s=e,"function"==typeof t?(i=t,r={}):(i=r,r=t));var u=s._rev||r.rev;n({headers:c.headers,method:"DELETE",url:a(c,o(s._id))+"?rev="+u},i)}),r.getAttachment=d.adapterFun("getAttachment",function(e,t,n,i){"function"==typeof n&&(i=n,n={}),n=d.clone(n),void 0===n.auto_encode&&(n.auto_encode=!0),n.auto_encode&&(e=o(e)),n.auto_encode=!1,r.get(e+"/"+t,n,i)}),r.removeAttachment=d.adapterFun("removeAttachment",function(e,t,r,i){n({headers:c.headers,method:"DELETE",url:a(c,o(e)+"/"+t)+"?rev="+r},i)}),r.putAttachment=d.adapterFun("putAttachment",function(e,t,r,i,s,u){"function"==typeof s&&(u=s,s=i,i=r,r=null),"undefined"==typeof s&&(s=i,i=r,r=null);var l=o(e)+"/"+t,f=a(c,l);r&&(f+="?rev="+r);var p={headers:d.clone(c.headers),method:"PUT",url:f,processData:!1,body:i,timeout:6e4};p.headers["Content-Type"]=s,n(p,u)}),r.put=d.adapterFun("put",d.getArguments(function(e){var t,r,s,u=e.shift(),l="_id"in u,p=e.pop();return"object"!=typeof u||Array.isArray(u)?p(f.NOT_AN_OBJECT):(u=d.clone(u),void i(u).then(function(){for(;;)if(t=e.shift(),r=typeof t,"string"!==r||l?"string"!==r||!l||"_rev"in u?"object"===r&&(s=d.clone(t)):u._rev=t:(u._id=t,l=!0),!e.length)break;s=s||{};var i=d.invalidIdError(u._id);if(i)throw i;var f=[];s&&"undefined"!=typeof s.new_edits&&f.push("new_edits="+s.new_edits),f=f.join("&"),""!==f&&(f="?"+f),n({headers:c.headers,method:"PUT",url:a(c,o(u._id))+f,body:u},function(e,t){return e?p(e):(t.ok=!0,void p(null,t))})})["catch"](p))})),r.post=d.adapterFun("post",function(e,t,n){return"function"==typeof t&&(n=t,t={}),t=d.clone(t),"object"!=typeof e?n(f.NOT_AN_OBJECT):("_id"in e||(e._id=d.uuid()),void r.put(e,t,function(e,t){return e?n(e):(t.ok=!0,void n(null,t))}))}),r._bulkDocs=function(e,t,r){"undefined"!=typeof t.new_edits&&(e.new_edits=t.new_edits),d.Promise.all(e.docs.map(i)).then(function(){n({headers:c.headers,method:"POST",url:a(c,"_bulk_docs"),body:e},function(e,t){return e?r(e):(t.forEach(function(e){e.ok=!0}),void r(null,t))})})["catch"](r)},r.allDocs=d.adapterFun("allDocs",function(e,t){"function"==typeof e&&(t=e,e={}),e=d.clone(e);var r,o=[],i="GET";if(e.conflicts&&o.push("conflicts=true"),e.descending&&o.push("descending=true"),e.include_docs&&o.push("include_docs=true"),e.key&&o.push("key="+encodeURIComponent(JSON.stringify(e.key))),e.startkey&&o.push("startkey="+encodeURIComponent(JSON.stringify(e.startkey))),e.endkey&&o.push("endkey="+encodeURIComponent(JSON.stringify(e.endkey))),"undefined"!=typeof e.inclusive_end&&o.push("inclusive_end="+!!e.inclusive_end),"undefined"!=typeof e.limit&&o.push("limit="+e.limit),"undefined"!=typeof e.skip&&o.push("skip="+e.skip),o=o.join("&"),""!==o&&(o="?"+o),"undefined"!=typeof e.keys){var s=2e3,u="keys="+encodeURIComponent(JSON.stringify(e.keys));u.length+o.length+1<=s?o+=(-1!==o.indexOf("?")?"&":"?")+u:(i="POST",r=JSON.stringify({keys:e.keys}))}n({headers:c.headers,method:i,url:a(c,"_all_docs"+o),body:r},t)}),r._changes=function(e){var t="batch_size"in e?e.batch_size:l;e=d.clone(e),e.timeout=e.timeout||3e4;var r={timeout:e.timeout-5e3},o="undefined"!=typeof e.limit?e.limit:!1;0===o&&(o=1);var i;i="returnDocs"in e?e.returnDocs:!0;var s=o;if(e.style&&(r.style=e.style),(e.include_docs||e.filter&&"function"==typeof e.filter)&&(r.include_docs=!0),e.continuous&&(r.feed="longpoll"),e.conflicts&&(r.conflicts=!0),e.descending&&(r.descending=!0),e.filter&&"string"==typeof e.filter&&(r.filter=e.filter,"_view"===e.filter&&e.view&&"string"==typeof e.view&&(r.view=e.view)),e.query_params&&"object"==typeof e.query_params)for(var u in e.query_params)e.query_params.hasOwnProperty(u)&&(r[u]=e.query_params[u]);var p,h,v=function(i,u){if(!e.aborted){r.since=i,e.descending?o&&(r.limit=s):r.limit=!o||s>t?t:s;var l="?"+Object.keys(r).map(function(e){return e+"="+r[e]}).join("&"),d={headers:c.headers,method:"GET",url:a(c,"_changes"+l),timeout:e.timeout};h=i,e.aborted||(p=n(d,u))}},m=10,_=0,y={results:[]},g=function(n,r){if(!e.aborted){var a=0;if(r&&r.results){a=r.results.length,y.last_seq=r.last_seq;var u={};u.query=e.query_params,r.results=r.results.filter(function(t){s--;var n=d.filterChange(e)(t);return n&&(i&&y.results.push(t),d.call(e.onChange,t)),n})}else if(n)return e.aborted=!0,void d.call(e.complete,n);r&&r.last_seq&&(h=r.last_seq);var c=o&&0>=s||r&&t>a||e.descending;if((!e.continuous||o&&0>=s)&&c)d.call(e.complete,null,y);else{n?_+=1:_=0;var l=1<<_,p=m*l,b=e.maximumWait||3e4;if(p>b)return void d.call(e.complete,n||f.UNKNOWN_ERROR);setTimeout(function(){v(h,g)},p)}}};return v(e.since||0,g),{cancel:function(){e.aborted=!0,p&&p.abort()}}},r.revsDiff=d.adapterFun("revsDiff",function(e,t,r){"function"==typeof t&&(r=t,t={}),n({headers:c.headers,method:"POST",url:a(c,"_revs_diff"),body:JSON.stringify(e)},r)}),r._close=function(e){e()},r.destroy=d.adapterFun("destroy",function(e){n({url:a(c,""),method:"DELETE",headers:c.headers},function(t,n){t?(r.emit("error",t),e(t)):(r.emit("destroyed"),e(null,n))})})}var l=25,d=e("../utils"),f=e("../deps/errors");r.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},c.destroy=d.toPromise(function(e,t,n){var r=s(e,t);t=t||{},"function"==typeof t&&(n=t,t={}),t=d.clone(t),t.headers=r.headers,t.method="DELETE",t.url=a(r,"");var o=t.ajax||{};t=d.extend({},t,o),d.ajax(t,n)}),c.valid=function(){return!0},t.exports=c}).call(this,e("/Users/nolan/workspace/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"))},{"../deps/errors":11,"../utils":23,"/Users/nolan/workspace/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":28}],3:[function(e,t){(function(n,r){"use strict";function o(e,t,n){try{e.apply(t,n)}catch(r){window.PouchDB&&window.PouchDB.emit("error",r)}}function i(){if(!y.running&&y.queue.length){y.running=!0;var e=y.queue.shift();e.action(function(t,r){o(e.callback,this,[t,r]),y.running=!1,n.nextTick(i)})}}function s(e){return function(t){var n=t.target&&t.target.error&&t.target.error.name||t.target;e(v.error(v.IDB_ERROR,n,t.type))}}function a(){var e="_pouch__checkModernIdb_"+(r.navigator&&r.navigator.appVersion),t=p.hasLocalStorage()&&r.localStorage[e];if(t)return JSON.parse(t);var n="_pouch__checkModernIdb",o=null===r.indexedDB.open(n,1).onupgradeneeded;return r.indexedDB.deleteDatabase&&r.indexedDB.deleteDatabase(n),p.hasLocalStorage()&&(r.localStorage[e]=JSON.stringify(o)),o}function u(e,t,n){var r={data:m.stringify(e)};return r.winningRev=t,r.deletedOrLocal=n?"1":"0",r.id=e.id,r}function c(e){if(!e)return null;if(!e.data)return e;var t=m.parse(e.data);return t.winningRev=e.winningRev,t.deletedOrLocal="1"===e.deletedOrLocal,t}function l(e,t){var n=this;y.queue.push({action:function(t){d(n,e,t)},callback:t}),i()}function d(e,t,o){function i(e){e.createObjectStore(b,{keyPath:"id"}).createIndex("seq","seq",{unique:!0}),e.createObjectStore(w,{autoIncrement:!0}).createIndex("_doc_id_rev","_doc_id_rev",{unique:!0}),e.createObjectStore(E,{keyPath:"digest"}),e.createObjectStore(S,{keyPath:"id",autoIncrement:!1}),e.createObjectStore(x)}function a(e,t){var n=e.currentTarget.transaction,r=n.objectStore(b);r.createIndex("deletedOrLocal","deletedOrLocal",{unique:!1}),r.openCursor().onsuccess=function(e){var o=e.target.result;if(o){var i=o.value,s=p.isDeleted(i);i.deletedOrLocal=s?"1":"0",r.put(i),o["continue"]()}else t(n)}}function d(e){e.createObjectStore(k,{keyPath:"_id"}).createIndex("_doc_id_rev","_doc_id_rev",{unique:!0})}function f(e,t){t=t||e.currentTarget.transaction;var n=t.objectStore(k),o=t.objectStore(b),i=t.objectStore(w),s=o.openCursor();s.onsuccess=function(e){var t=e.target.result;if(t){var s=t.value,a=s.id,u=p.isLocalId(a),c=h.winningRev(s);if(u){var l=a+"::"+c,d=a+"::",f=a+"::~",v=i.index("_doc_id_rev"),m=r.IDBKeyRange.bound(d,f,!1,!1),_=v.openCursor(m);_.onsuccess=function(e){if(_=e.target.result){var r=_.value;r._doc_id_rev===l&&n.put(r),i["delete"](_.primaryKey),_["continue"]()}else o["delete"](t.primaryKey),t["continue"]()}}else t["continue"]()}}}function m(e,t,n){var o="startkey"in t?t.startkey:!1,i="endkey"in t?t.endkey:!1,s="key"in t?t.key:!1,a=t.skip||0,u="number"==typeof t.limit?t.limit:-1,l=t.inclusive_end!==!1,d="descending"in t&&t.descending?"prev":null,f=!1;d&&o&&i&&(f=i,i=!1);var m=null;try{o&&i?m=r.IDBKeyRange.bound(o,i,!1,!l):o?m=d?r.IDBKeyRange.upperBound(o):r.IDBKeyRange.lowerBound(o):i?m=d?r.IDBKeyRange.lowerBound(i,!l):r.IDBKeyRange.upperBound(i,!l):s&&(m=r.IDBKeyRange.only(s))}catch(_){return"DataError"===_.name&&0===_.code?n(null,{total_rows:e,offset:t.skip,rows:[]}):n(v.error(v.IDB_ERROR,_.name,_.message))}var y=L.transaction([b,w],"readonly");y.oncomplete=function(){n(null,{total_rows:e,offset:t.skip,rows:S})};var g=y.objectStore(b),E=d?g.openCursor(m,d):g.openCursor(m),S=[];E.onsuccess=function(e){function n(e,n){var o={id:e.id,key:e.id,value:{rev:i}};if(t.include_docs){o.doc=n,o.doc._rev=i,o.doc._doc_id_rev&&delete o.doc._doc_id_rev,t.conflicts&&(o.doc._conflicts=h.collectConflicts(e));for(var s in o.doc._attachments)o.doc._attachments.hasOwnProperty(s)&&(o.doc._attachments[s].stub=!0)}var c=p.isDeleted(e,i);if("ok"===t.deleted)c&&(o.value.deleted=!0,o.doc=null),S.push(o);else if(!c&&a--<=0){if(f){if(l&&o.key<f)return;if(!l&&o.key<=f)return}if(S.push(o),0===--u)return}r["continue"]()}if(e.target.result){var r=e.target.result,o=c(r.value),i=o.winningRev||h.winningRev(o);if(t.include_docs){var s=y.objectStore(w).index("_doc_id_rev"),d=o.id+"::"+i;s.get(d).onsuccess=function(e){n(c(r.value),e.target.result)}}else n(o)}}}function y(e){if(-1!==R)return e(null,R);var t,n=L.transaction([b],"readonly"),o=n.objectStore(b).index("deletedOrLocal");o.count(r.IDBKeyRange.only("0")).onsuccess=function(e){t=e.target.result},n.onerror=s(e),n.oncomplete=function(){R=t,e(null,R)}}var g=3,b="document-store",w="by-sequence",E="attach-store",S="meta-store",k="local-store",x="detect-blob-support",q=t.name,T=null,A=null,O=!1,L=null,R=-1;e.type=function(){return"idb"},e._id=p.toPromise(function(e){e(null,A)}),e._bulkDocs=function(t,n,r){function o(e){var t=e.target.result;t.updateSeq=(t.updateSeq||0)+M,j.objectStore(S).put(t)}function i(){++P===C.length&&(j.objectStore(S).get(S).onsuccess=o)}function a(){if(C.length){var t=new p.Map;C.forEach(function(n,r){if(n._id&&p.isLocalId(n._id))return void e[n._deleted?"_removeLocal":"_putLocal"](n,{ctx:j},function(e){F[r]=e?e:{},i()});var o=n.metadata.id;t.has(o)?t.get(o).push([n,r]):t.set(o,[[n,r]])}),t.forEach(function(e,t){function n(){i(),++o<e.length&&r()}function r(){var r=e[o],i=r[0],s=r[1];B.has(t)?g(B.get(t),i,s,n):x(i,s,n)}var o=0;r()})}}function d(e){function t(){++n===C.length&&e()}if(!C.length)return e();var n=0;C.forEach(function(e){if(e._id&&p.isLocalId(e._id))return t();var n=e.metadata.id,r=j.objectStore(b).get(n);r.onsuccess=function(e){var r=c(e.target.result);r&&B.set(n,r),t()}})}function f(){var e=F.map(function(e){if(e._bulk_seq)delete e._bulk_seq;else if(!Object.keys(e).length)return{ok:!0};if(e.error)return e;var t=e.metadata,n=h.winningRev(t);return{ok:!0,id:t.id,rev:n}});l.Changes.notify(q),R=-1,r(null,e)}function m(e,t){if(e.stub)return t();if("string"==typeof e.data){var n;try{n=atob(e.data)}catch(o){var i=v.error(v.BAD_ARG,"Attachments need to be base64 encoded");return r(i)}if(T){var s=e.content_type;n=p.fixBinary(n),e.data=p.createBlob([n],{type:s})}return void p.MD5(n).then(function(n){e.digest="md5-"+n,t()})}var a=new FileReader;a.onloadend=function(){var n=p.arrayBufferToBinaryString(this.result||"");T||(e.data=btoa(n)),p.MD5(n).then(function(n){e.digest="md5-"+n,t()})},a.readAsArrayBuffer(e.data)}function _(e){function t(){n++,C.length===n&&e()}if(!C.length)return e();var n=0;C.forEach(function(e){function n(){o++,o===r.length&&t()}var r=e.data&&e.data._attachments?Object.keys(e.data._attachments):[];if(!r.length)return t();var o=0;for(var i in e.data._attachments)e.data._attachments.hasOwnProperty(i)&&m(e.data._attachments[i],n)})}function y(e,t,n,r,o){function i(e){c||(e?(c=e,r(c)):l===d.length&&a())}function s(e){l++,i(e)}function a(){function i(i){var s=e.metadata;s.seq=i.target.result,delete s.rev;var a=u(s,t,n),c=j.objectStore(b).put(a);c.onsuccess=function(){delete s.deletedOrLocal,delete s.winningRev,F[o]=e,B.set(e.metadata.id,e.metadata),p.call(r)}}M++,e.data._doc_id_rev=e.data._id+"::"+e.data._rev;var s=j.objectStore(w),a=s.index("_doc_id_rev"),c=s.put(e.data);c.onsuccess=i,c.onerror=function(t){t.preventDefault(),t.stopPropagation();var n=a.getKey(e.data._doc_id_rev);n.onsuccess=function(t){var n=s.put(e.data,t.target.result);M--,n.onsuccess=i}}}var c=null,l=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev,n&&(e.data._deleted=!0);var d=e.data._attachments?Object.keys(e.data._attachments):[];for(var f in e.data._attachments)if(e.data._attachments[f].stub)l++,i();else{var h=e.data._attachments[f].data;delete e.data._attachments[f].data;var v=e.data._attachments[f].digest;O(e,v,h,s)}d.length||a()}function g(e,t,n,r){var o=h.merge(e.rev_tree,t.metadata.rev_tree[0],1e3),i=p.isDeleted(e),s=p.isDeleted(t.metadata),a=i&&s&&I||!i&&I&&"new_leaf"!==o.conflicts;if(a)return F[n]=A(v.REV_CONFLICT,t._bulk_seq),r();t.metadata.rev_tree=o.tree;var u=h.winningRev(t.metadata);s=p.isDeleted(t.metadata,u),y(t,u,s,r,n)}function x(e,t,r){var o=h.winningRev(e.metadata),i=p.isDeleted(e.metadata,o);return"was_delete"in n&&i?(F[t]=v.MISSING_DOC,r()):void y(e,o,i,r,t)}function A(e,t){return e._bulk_seq=t,e}function O(e,t,n,r){var o=j.objectStore(E);o.get(t).onsuccess=function(i){var s=i.target.result&&i.target.result.refs||{},a=[e.metadata.id,e.metadata.rev].join("@"),u={digest:t,body:n,refs:s};u.refs[a]=!0,o.put(u).onsuccess=function(){p.call(r)}}}var I=n.new_edits,D=t.docs,C=D.map(function(e,t){if(e._id&&p.isLocalId(e._id))return e;var n=p.parseDoc(e,I);return n._bulk_seq=t,n}),N=C.filter(function(e){return e.error});if(N.length)return r(N[0]);var j,F=new Array(C.length),B=new p.Map,M=0,P=0;_(function(){var e=[b,w,E,S,k];j=L.transaction(e,"readwrite"),j.onerror=s(r),j.ontimeout=s(r),j.oncomplete=f,d(a)})},e._get=function(e,t,n){function r(){n(s,{doc:o,metadata:i,ctx:a})}var o,i,s,a;t=p.clone(t),a=t.ctx?t.ctx:L.transaction([b,w,E],"readonly"),a.objectStore(b).get(e).onsuccess=function(e){if(i=c(e.target.result),!i)return s=v.MISSING_DOC,r();if(p.isDeleted(i)&&!t.rev)return s=v.error(v.MISSING_DOC,"deleted"),r();var n=a.objectStore(w),u=t.rev||i.winningRev||h.winningRev(i),l=i.id+"::"+u;n.index("_doc_id_rev").get(l).onsuccess=function(e){return o=e.target.result,o&&o._doc_id_rev&&delete o._doc_id_rev,o?void r():(s=v.MISSING_DOC,r())}}},e._getAttachment=function(e,t,n){var r,o;t=p.clone(t),o=t.ctx?t.ctx:L.transaction([b,w,E],"readonly");var i=e.digest,s=e.content_type;o.objectStore(E).get(i).onsuccess=function(e){var o=e.target.result.body;if(t.encode)if(T){var i=new FileReader;i.onloadend=function(){var e=p.arrayBufferToBinaryString(this.result||"");r=btoa(e),n(null,r)},i.readAsArrayBuffer(o)}else r=o,n(null,r);else T?r=o||p.createBlob([""],{type:s}):(o=p.fixBinary(atob(o)),r=p.createBlob([o],{type:s})),n(null,r)}},e._allDocs=function(e,t){y(function(n,r){return n?t(n):0===e.limit?t(null,{total_rows:r,offset:e.skip,rows:[]}):void m(r,e,t)})},e._info=function(e){y(function(t,n){if(t)return e(t);if(null===L){var r=new Error("db isn't open");return r.id="idbNull",e(r)}var o=0,i=L.transaction([S],"readonly");i.objectStore(S).get(S).onsuccess=function(e){o=e.target.result&&e.target.result.updateSeq||0},i.oncomplete=function(){e(null,{doc_count:n,update_seq:o})}})},e._changes=function(t){function n(){v=L.transaction([b,w],"readonly"),v.oncomplete=i;var e;e=a?v.objectStore(w).openCursor(r.IDBKeyRange.lowerBound(t.since,!0),a):v.objectStore(w).openCursor(r.IDBKeyRange.lowerBound(t.since,!0)),e.onsuccess=o,e.onerror=onerror}function o(e){var n=e.target.result;if(n){var r=n.value;if(t.doc_ids&&-1===t.doc_ids.indexOf(r._id))return n["continue"]();var o=v.objectStore(b);o.get(r._id).onsuccess=function(e){var o=c(e.target.result);u<o.seq&&(u=o.seq);var i=o.winningRev||h.winningRev(o);if(r._rev!==i)return n["continue"]();delete r._doc_id_rev;var s=t.processChange(r,o,t);s.seq=n.key,y(s)&&(_++,f&&m.push(s),t.onChange(s)),_!==d&&n["continue"]()}}}function i(){t.continuous||t.complete(null,{results:m,last_seq:u})}if(t=p.clone(t),t.continuous){var s=q+":"+p.uuid();return l.Changes.addListener(q,s,e,t),l.Changes.notify(q),{cancel:function(){l.Changes.removeListener(q,s)}}}var a=t.descending?"prev":null,u=0;t.since=t.since&&!a?t.since:0;var d="limit"in t?t.limit:-1;0===d&&(d=1);var f;f="returnDocs"in t?t.returnDocs:!0;var v,m=[],_=0,y=p.filterChange(t);n()},e._close=function(e){return null===L?e(v.NOT_OPEN):(L.close(),delete _[q],L=null,void e())},e._getRevisionTree=function(e,t){var n=L.transaction([b],"readonly"),r=n.objectStore(b).get(e);r.onsuccess=function(e){var n=c(e.target.result);n?t(null,n.rev_tree):t(v.MISSING_DOC)}},e._doCompaction=function(e,t,n,r){var o=L.transaction([b,w],"readwrite"),i=o.objectStore(b);i.get(e).onsuccess=function(r){var i=c(r.target.result);i.rev_tree=t;var s=n.length;n.forEach(function(t){var n=o.objectStore(w).index("_doc_id_rev"),r=e+"::"+t;n.getKey(r).onsuccess=function(e){var t=e.target.result;if(t&&(o.objectStore(w)["delete"](t),s--,!s)){var n=i.winningRev||h.winningRev(i),r=i.deletedOrLocal;o.objectStore(b).put(u(i,n,r))}}})},o.oncomplete=function(){p.call(r)}},e._getLocal=function(e,t){var n=L.transaction([k],"readonly"),r=n.objectStore(k).get(e);r.onerror=s(t),r.onsuccess=function(e){var n=e.target.result;n?(delete n._doc_id_rev,t(null,n)):t(v.MISSING_DOC)}},e._putLocal=function(e,t,n){"function"==typeof t&&(n=t,t={}),delete e._revisions;var r=e._rev,o=e._id;e._rev=r?"0-"+(parseInt(r.split("-")[1],10)+1):"0-1",e._doc_id_rev=o+"::"+e._rev;var i,a=t.ctx;a||(a=L.transaction([k],"readwrite"),a.onerror=s(n),a.oncomplete=function(){i&&n(null,i)});var u,c=a.objectStore(k);if(r){var l=c.index("_doc_id_rev"),d=o+"::"+r;u=l.get(d),u.onsuccess=function(r){if(r.target.result){var o=c.put(e);o.onsuccess=function(){i={ok:!0,id:e._id,rev:e._rev},t.ctx&&n(null,i)}}else n(v.REV_CONFLICT)}}else u=c.get(o),u.onsuccess=function(r){if(r.target.result)n(v.REV_CONFLICT);
else{var o=c.put(e);o.onsuccess=function(){i={ok:!0,id:e._id,rev:e._rev},t.ctx&&n(null,i)}}}},e._removeLocal=function(e,t){var n,r=L.transaction([k],"readwrite");r.oncomplete=function(){n&&t(null,n)};var o=e._id+"::"+e._rev,i=r.objectStore(k),a=i.index("_doc_id_rev"),u=a.get(o);u.onerror=s(t),u.onsuccess=function(e){var r=e.target.result;if(r){var s=a.getKey(o);s.onsuccess=function(e){var t=e.target.result;i["delete"](t),n={ok:!0,id:r._id,rev:"0-0"}}}else t(v.MISSING_DOC)}};var I=_[q];if(I)return L=I.idb,T=I.blobSupport,A=I.instanceId,O=I.idStored,void n.nextTick(function(){o(null,e)});var D=r.indexedDB.open(q,g);"openReqList"in l||(l.openReqList={}),l.openReqList[q]=D,D.onupgradeneeded=function(e){var t=e.target.result;e.oldVersion<1&&i(t),e.oldVersion<3&&(d(t),e.oldVersion<2?a(e,function(t){f(e,t)}):f(e))},D.onsuccess=function(t){L=t.target.result,L.onversionchange=function(){L.close(),delete _[q]},L.onabort=function(){L.close(),delete _[q]};var n=L.transaction([S,x],"readwrite"),r=n.objectStore(S).get(S);r.onsuccess=function(t){var r=function(){null!==T&&O&&(_[q]={idb:L,blobSupport:T,instanceId:A,idStored:O,loaded:!0},o(null,e))},i=t.target.result||{id:S};q+"_id"in i?(A=i[q+"_id"],O=!0,r()):(A=p.uuid(),i[q+"_id"]=A,n.objectStore(S).put(i).onsuccess=function(){O=!0,r()});try{var s=p.createBlob([""],{type:"image/png"});n.objectStore(x).put(s,"key"),n.oncomplete=function(){n=L.transaction([S,x],"readwrite");var e=n.objectStore(x).get("key");e.onsuccess=function(e){var t=e.target.result,n=URL.createObjectURL(t);p.ajax({url:n,cache:!0,binary:!0},function(e,t){T=e&&405===e.status?!0:!(!t||"image/png"!==t.type),r()})}}}catch(a){T=!1,r()}}},D.onerror=s(o)}function f(e,t,n){"openReqList"in l||(l.openReqList={}),l.Changes.removeAllListeners(e),l.openReqList[e]&&l.openReqList[e].result&&l.openReqList[e].result.close();var o=r.indexedDB.deleteDatabase(e);o.onsuccess=function(){l.openReqList[e]&&(l.openReqList[e]=null),p.hasLocalStorage()&&e in r.localStorage&&delete r.localStorage[e],delete _[e],n(null,{ok:!0})},o.onerror=s(n)}var p=e("../utils"),h=e("../merge"),v=e("../deps/errors"),m=e("vuvuzela"),_={},y={running:!1,queue:[]};l.valid=function(){return r.indexedDB&&a()},l.destroy=p.toPromise(function(e,t,n){y.queue.push({action:function(n){f(e,t,n)},callback:n}),i()}),l.Changes=new p.Changes,t.exports=l}).call(this,e("/Users/nolan/workspace/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../deps/errors":11,"../merge":18,"../utils":23,"/Users/nolan/workspace/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":28,vuvuzela:57}],4:[function(e,t){t.exports=["idb","websql"]},{}],5:[function(e,t){(function(n){"use strict";function r(e){return"'"+e+"'"}function o(e,t,n,r,o){return"SELECT "+e+" FROM "+("string"==typeof t?t:t.join(" JOIN "))+(n?" ON "+n:"")+(r?" WHERE "+("string"==typeof r?r:r.join(" AND ")):"")+(o?" ORDER BY "+o:"")}function i(e){return function(t){var n=t&&t.constructor.toString().match(/function ([^\(]+)/),r=n&&n[1]||t.type,o=t.target||t.message;e(h.error(h.WSQ_ERROR,o,r))}}function s(e){return decodeURIComponent(window.escape(e))}function a(e,t){for(var n="",r="UTF-8"===t?2:4,o=0,i=e.length;i>o;o+=r){var a=e.substring(o,o+r);4===r&&(a=a.substring(2,4)+a.substring(0,2)),n+=String.fromCharCode(parseInt(a,16))}return n="UTF-8"===t?s(n):n}function u(e){return delete e._id,delete e._rev,JSON.stringify(e)}function c(e,t,n){return e=JSON.parse(e),e._id=t,e._rev=n,e}function l(e){if("size"in e)return 1e6*e.size;var t=/Android/.test(window.navigator.userAgent);return t?5e6:1}function d(e,t){function r(){f.hasLocalStorage()&&(n.localStorage["_pouch__websqldb_"+M]=!0),t(null,F)}function s(e,t){e.executeSql(T),e.executeSql("ALTER TABLE "+w+" ADD COLUMN deleted TINYINT(1) DEFAULT 0",[],function(){e.executeSql(x),e.executeSql("ALTER TABLE "+b+" ADD COLUMN local TINYINT(1) DEFAULT 0",[],function(){e.executeSql("CREATE INDEX IF NOT EXISTS 'doc-store-local-idx' ON "+b+" (local, id)");var n="SELECT "+b+".winningseq AS seq, "+b+".json AS metadata FROM "+w+" JOIN "+b+" ON "+w+".seq = "+b+".winningseq";e.executeSql(n,[],function(e,n){for(var r=[],o=[],i=0;i<n.rows.length;i++){var s=n.rows.item(i),a=s.seq,u=JSON.parse(s.metadata);f.isDeleted(u)&&r.push(a),f.isLocalId(u.id)&&o.push(u.id)}e.executeSql("UPDATE "+b+"SET local = 1 WHERE id IN ("+o.map(function(){return"?"}).join(",")+")",o,function(){e.executeSql("UPDATE "+w+" SET deleted = 1 WHERE seq IN ("+r.map(function(){return"?"}).join(",")+")",r,t)})})})})}function m(e,t){var n="CREATE TABLE IF NOT EXISTS "+S+" (id UNIQUE, rev, json)";e.executeSql(n,[],function(){var n="SELECT "+b+".id AS id, "+w+".json AS data FROM "+w+" JOIN "+b+" ON "+w+".seq = "+b+".winningseq WHERE local = 1";e.executeSql(n,[],function(e,n){function r(){if(!o.length)return t();var n=o.shift(),i=JSON.parse(n.data)._rev;e.executeSql("INSERT INTO "+S+" (id, rev, json) VALUES (?,?,?)",[n.id,i,n.data],function(e){e.executeSql("DELETE FROM "+b+" WHERE id=?",[n.id],function(e){e.executeSql("DELETE FROM "+w+" WHERE seq=?",[n.seq],function(){r()})})})}for(var o=[],i=0;i<n.rows.length;i++)o.push(n.rows.item(i));r()})})}function L(e,t){function n(n,r){function o(){if(!n.length)return t();var i=n.shift(),s=a(i.hex,r),u=s.lastIndexOf("::"),c=s.substring(0,u),l=s.substring(u+2),d="UPDATE "+w+" SET doc_id=?, rev=? WHERE doc_id_rev=?";e.executeSql(d,[c,l,s],function(){o()})}o()}var r="ALTER TABLE "+w+" ADD COLUMN doc_id";e.executeSql(r,[],function(e){var t="ALTER TABLE "+w+" ADD COLUMN rev";e.executeSql(t,[],function(e){e.executeSql(q,[],function(e){var t="SELECT hex(doc_id_rev) as hex FROM "+w;e.executeSql(t,[],function(e,t){for(var r=[],o=0;o<t.rows.length;o++)r.push(t.rows.item(o));e.executeSql("SELECT dbid, hex(dbid) AS hexId FROM "+k,[],function(e,t){var o=t.rows.item(0).dbid,i=t.rows.item(0).hexId,s=i.length===2*o.length?"UTF-8":"UTF-16";n(r,s)})})})})})}function R(e){for(;U.length>0;){var t=U.pop();t(null,B)}I(e)}function I(e){e.executeSql("SELECT dbid, hex(dbid) AS hexId FROM "+k,[],function(e,t){var n=t.rows.item(0).dbid,r=t.rows.item(0).hexId;j=r.length===2*n.length?"UTF-8":"UTF-16"})}function D(e,t){if(0===t){var n="CREATE TABLE IF NOT EXISTS "+k+" (update_seq INTEGER, dbid, db_version INTEGER)",r="CREATE TABLE IF NOT EXISTS "+E+" (digest, json, body BLOB)",o="CREATE TABLE IF NOT EXISTS "+b+" (id unique, json, winningseq)",i="CREATE TABLE IF NOT EXISTS "+w+" (seq INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, json, deleted TINYINT(1), doc_id, rev)",a="CREATE TABLE IF NOT EXISTS "+S+" (id UNIQUE, rev, json)";e.executeSql(r),e.executeSql(a),e.executeSql(o,[],function(){e.executeSql(T),e.executeSql(i,[],function(){e.executeSql(x),e.executeSql(q),e.executeSql(n,[],function(){var t="INSERT INTO "+k+" (update_seq, db_version, dbid) VALUES (?, ?, ?)";B=f.uuid();var n=[0,g,B];e.executeSql(t,n,function(e){R(e)})})})})}else{var u=function(){var n=g>t;n&&e.executeSql("UPDATE "+k+" SET db_version = "+g);var r="SELECT dbid FROM "+k;e.executeSql(r,[],function(e,t){B=t.rows.item(0).dbid,R(e)})};switch(t){case 1:s(e,function(){m(e,function(){L(e,u)})});break;case 2:m(e,function(){L(e,u)});break;case 3:L(e,u);break;default:u()}}}function C(){J.transaction(function(e){e.executeSql("SELECT sql FROM sqlite_master WHERE tbl_name = "+k,[],function(e,t){t.rows.length?/db_version/.test(t.rows.item(0).sql)?e.executeSql("SELECT db_version FROM "+k,[],function(e,t){var n=t.rows.item(0).db_version;D(e,n)}):e.executeSql("ALTER TABLE "+k+" ADD COLUMN db_version INTEGER",[],function(){D(e,1)}):D(e,0)})},i(t),r)}function N(e,t){if(-1!==G)return t(G);var n=o("COUNT("+b+".id) AS 'num'",[b,w],A,w+".deleted=0");e.executeSql(n,[],function(e,n){G=n.rows.item(0).num,t(G)})}var j,F=this,B=null,M=e.name,P=l(e),U=[],G=-1,J=_(M,y,M,P);return J?("function"!=typeof J.readTransaction&&(J.readTransaction=J.transaction),f.isCordova()&&"undefined"!=typeof n?n.addEventListener(M+"_pouch",function V(){n.removeEventListener(M+"_pouch",V,!1),C()},!1):C(),F.type=function(){return"websql"},F._id=f.toPromise(function(e){e(null,B)}),F._info=function(e){J.readTransaction(function(t){N(t,function(n){var r="SELECT update_seq FROM "+k;t.executeSql(r,[],function(t,r){var o=r.rows.item(0).update_seq;e(null,{doc_count:n,update_seq:o})})})},i(e))},F._bulkDocs=function(e,t,n){function r(){var e=R.map(function(e){if(e._bulk_seq)delete e._bulk_seq;else if(!Object.keys(e).length)return{ok:!0};if(e.error)return e;var t=e.metadata,n=p.winningRev(t);return{ok:!0,id:t.id,rev:n}});d.Changes.notify(M);var t="SELECT update_seq FROM "+k;L.executeSql(t,[],function(t,r){var o=r.rows.item(0).update_seq+I,i="UPDATE "+k+" SET update_seq=?";t.executeSql(i,[o],function(){n(null,e)})})}function s(e,t){if(e.stub)return t();if("string"==typeof e.data){try{e.data=atob(e.data)}catch(r){var o=h.error(h.BAD_ARG,"Attachments need to be base64 encoded");return n(o)}var i=f.fixBinary(e.data);e.data=f.createBlob([i],{type:e.content_type})}var s=new FileReader;s.onloadend=function(){var n=f.arrayBufferToBinaryString(this.result);e.data=n,f.MD5(n).then(function(n){e.digest="md5-"+n,t()})},s.readAsArrayBuffer(e.data)}function a(e){function t(){n++,A.length===n&&e()}if(!A.length)return e();var n=0;A.forEach(function(e){function n(){o++,o===r.length&&t()}var r=e.data&&e.data._attachments?Object.keys(e.data._attachments):[],o=0;if(!r.length)return t();for(var i in e.data._attachments)e.data._attachments.hasOwnProperty(i)&&s(e.data._attachments[i],n)})}function c(e,t,n,r,i,s){function a(){I++;var t=e.data,r=n?1:0,i=t._id,s=t._rev,a=u(t),c="INSERT INTO "+w+" (doc_id, rev, json, deleted) VALUES (?, ?, ?, ?);",l=[i,s,a,r];L.executeSql(c,l,function(e,t){d(e,t.insertId)},function(){var e=o("seq",w,null,"doc_id=? AND rev=?");return L.executeSql(e,[i,s],function(e,t){var n=t.rows.item(0).seq,o="UPDATE "+w+" SET json=?, deleted=? WHERE doc_id=? AND rev=?;",u=[a,r,i,s];e.executeSql(o,u,function(e){I--,d(e,n)})}),!1})}function c(e){f||(e?(f=e,r(f)):p===h.length&&a())}function l(e){p++,c(e)}function d(n,o){e.metadata.seq=o,delete e.metadata.rev;var a=i?"UPDATE "+b+" SET json=?, winningseq=(SELECT seq FROM "+w+" WHERE doc_id="+b+".id AND rev=?) WHERE id=?":"INSERT INTO "+b+" (id, winningseq, json) VALUES (?, ?, ?);",u=v.stringify(e.metadata),c=e.metadata.id,l=i?[u,t,c]:[c,o,u];n.executeSql(a,l,function(){R[s]=e,D.set(c,e.metadata),r()})}var f=null,p=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev,n&&(e.data._deleted=!0);var h=e.data._attachments?Object.keys(e.data._attachments):[];for(var m in e.data._attachments)if(e.data._attachments[m].stub)p++,c();else{var _=e.data._attachments[m].data;delete e.data._attachments[m].data;var y=e.data._attachments[m].digest;x(e,y,_,l)}h.length||a()}function l(e,t,n,r){var o=p.merge(e.rev_tree,t.metadata.rev_tree[0],1e3),i=f.isDeleted(t.metadata),s=f.isDeleted(e),a=s&&i&&q||!s&&q&&"new_leaf"!==o.conflicts;if(a)return R[n]=S(h.REV_CONFLICT,t._bulk_seq),r();t.metadata.rev_tree=o.tree;var u=p.winningRev(t.metadata);i=f.isDeleted(t.metadata,u),c(t,u,i,r,!0,n)}function m(e,n,r){var o=p.winningRev(e.metadata),i=f.isDeleted(e.metadata,o);return"was_delete"in t&&i?(R[n]=h.MISSING_DOC,r()):void c(e,o,i,r,!1,n)}function _(){++C===A.length&&r()}function y(){if(!A.length)return r();var e=new f.Map;A.forEach(function(t,n){if(t._id&&f.isLocalId(t._id))return void F[t._deleted?"_removeLocal":"_putLocal"](t,{ctx:L},function(e){R[n]=e?e:{},_()});var r=t.metadata.id;e.has(r)?e.get(r).push([t,n]):e.set(r,[[t,n]])}),e.forEach(function(e,t){function n(){_(),++o<e.length&&r()}function r(){var r=e[o],i=r[0],s=r[1];D.has(t)?l(D.get(t),i,s,n):m(i,s,n)}var o=0;r()})}function g(e){function t(){++n===A.length&&e()}if(!A.length)return e();var n=0;A.forEach(function(e){if(e._id&&f.isLocalId(e._id))return t();var n=e.metadata.id;L.executeSql("SELECT json FROM "+b+" WHERE id = ?",[n],function(e,r){if(r.rows.length){var o=v.parse(r.rows.item(0).json);D.set(n,o)}t()})})}function S(e,t){return e._bulk_seq=t,e}function x(e,t,n,r){var o=[e.metadata.id,e.metadata.rev].join("@"),i={digest:t},s="SELECT digest, json FROM "+E+" WHERE digest=?";L.executeSql(s,[t],function(e,a){a.rows.length?(i.refs=JSON.parse(a.rows.item(0).json).refs,s="UPDATE "+E+" SET json=?, body=? WHERE digest=?",e.executeSql(s,[JSON.stringify(i),n,t],function(){r()})):(i.refs={},i.refs[o]=!0,s="INSERT INTO "+E+"(digest, json, body) VALUES (?, ?, ?)",e.executeSql(s,[t,JSON.stringify(i),n],function(){r()}))})}var q=t.new_edits,T=e.docs,A=T.map(function(e,t){if(e._id&&f.isLocalId(e._id))return e;var n=f.parseDoc(e,q);return n._bulk_seq=t,n}),O=A.filter(function(e){return e.error});if(O.length)return n(O[0]);var L,R=new Array(A.length),I=0,D=new f.Map,C=0;a(function(){J.transaction(function(e){L=e,g(y)},i(n),function(){G=-1})})},F._get=function(e,t,n){function r(){n(a,{doc:i,metadata:s,ctx:d})}t=f.clone(t);var i,s,a;if(!t.ctx)return void J.readTransaction(function(r){t.ctx=r,F._get(e,t,n)});var u,l,d=t.ctx;t.rev?(u=o(O,[b,w],b+".id="+w+".doc_id",[w+".doc_id=?",w+".rev=?"]),l=[e,t.rev]):(u=o(O,[b,w],A,b+".id=?"),l=[e]),d.executeSql(u,l,function(e,n){if(!n.rows.length)return a=h.MISSING_DOC,r();var o=n.rows.item(0);return s=v.parse(o.metadata),o.deleted&&!t.rev?(a=h.error(h.MISSING_DOC,"deleted"),r()):(i=c(o.data,s.id,o.rev),void r())})},F._allDocs=function(e,t){var n,r=[],s="startkey"in e?e.startkey:!1,a="endkey"in e?e.endkey:!1,u="key"in e?e.key:!1,l="descending"in e?e.descending:!1,d="limit"in e?e.limit:-1,f="skip"in e?e.skip:0,h=e.inclusive_end!==!1,m=[],_=[];if(u!==!1)_.push(b+".id = ?"),m.push(u);else if(s!==!1||a!==!1){if(s!==!1&&(_.push(b+".id "+(l?"<=":">=")+" ?"),m.push(s)),a!==!1){var y=l?">":"<";h&&(y+="="),_.push(b+".id "+y+" ?"),m.push(a)}u!==!1&&(_.push(b+".id = ?"),m.push(u))}"ok"!==e.deleted&&_.push(w+".deleted = 0"),J.readTransaction(function(t){N(t,function(i){if(n=i,0!==d){var s=o(O,[b,w],A,_,b+".id "+(l?"DESC":"ASC"));s+=" LIMIT "+d+" OFFSET "+f,t.executeSql(s,m,function(t,n){for(var o=0,i=n.rows.length;i>o;o++){var s=n.rows.item(o),a=v.parse(s.metadata),u=c(s.data,a.id,s.rev),l=u._rev,d={id:a.id,key:a.id,value:{rev:l}};if(e.include_docs){d.doc=u,d.doc._rev=l,e.conflicts&&(d.doc._conflicts=p.collectConflicts(a));for(var f in d.doc._attachments)d.doc._attachments.hasOwnProperty(f)&&(d.doc._attachments[f].stub=!0)}if(s.deleted){if("ok"!==e.deleted)continue;d.value.deleted=!0,d.doc=null}r.push(d)}})}})},i(t),function(){t(null,{total_rows:n,offset:e.skip,rows:r})})},F._changes=function(e){function t(){var t=[b+".winningseq > "+e.since],n=[];e.doc_ids&&(t.push(b+".id IN ("+e.doc_ids.map(function(){return"?"}).join(",")+")"),n=e.doc_ids);var l=o(O,[b,w],A,t,b+".winningseq "+(r?"DESC":"ASC")),d=f.filterChange(e);e.view||e.filter||(l+=" LIMIT "+i),J.readTransaction(function(t){t.executeSql(l,n,function(t,n){for(var r=0,o=0,l=n.rows.length;l>o;o++){var f=n.rows.item(o),p=v.parse(f.metadata);r<f.seq&&(r=f.seq);var h=c(f.data,p.id,f.rev),m=e.processChange(h,p,e);if(m.seq=f.seq,d(m)&&(u++,s&&a.push(m),e.onChange(m)),u===i)break}e.continuous||e.complete(null,{results:a,last_seq:r})})})}if(e=f.clone(e),e.continuous){var n=M+":"+f.uuid();return d.Changes.addListener(M,n,F,e),d.Changes.notify(M),{cancel:function(){d.Changes.removeListener(M,n)}}}var r=e.descending;e.since=e.since&&!r?e.since:0;var i="limit"in e?e.limit:-1;0===i&&(i=1);var s;s="returnDocs"in e?e.returnDocs:!0;var a=[],u=0;t()},F._close=function(e){e()},F._getAttachment=function(e,t,n){var r,o=t.ctx,i=e.digest,s=e.content_type,u="SELECT hex(body) as body FROM "+E+" WHERE digest=?";o.executeSql(u,[i],function(e,o){var i=a(o.rows.item(0).body,j);t.encode?r=btoa(i):(i=f.fixBinary(i),r=f.createBlob([i],{type:s})),n(null,r)})},F._getRevisionTree=function(e,t){J.readTransaction(function(n){var r="SELECT json AS metadata FROM "+b+" WHERE id = ?";n.executeSql(r,[e],function(e,n){if(n.rows.length){var r=v.parse(n.rows.item(0).metadata);t(null,r.rev_tree)}else t(h.MISSING_DOC)})})},F._doCompaction=function(e,t,n,r){return n.length?void J.transaction(function(o){var i="SELECT json AS metadata FROM "+b+" WHERE id = ?";o.executeSql(i,[e],function(o,i){if(!i.rows.length)return f.call(r);var s=v.parse(i.rows.item(0).metadata);s.rev_tree=t;var a=0;n.forEach(function(t){var i="DELETE FROM "+w+" WHERE doc_id=? AND rev=?";o.executeSql(i,[e,t],function(t){if(++a===n.length){var o="UPDATE "+b+" SET json = ? WHERE id = ?";t.executeSql(o,[v.stringify(s),e],function(){r()})}})})})}):r()},F._getLocal=function(e,t){J.readTransaction(function(n){var r="SELECT json, rev FROM "+S+" WHERE id=?";n.executeSql(r,[e],function(n,r){if(r.rows.length){var o=r.rows.item(0),i=c(o.json,e,o.rev);t(null,i)}else t(h.MISSING_DOC)})})},F._putLocal=function(e,t,n){function r(e){var r,i;s?(r="UPDATE "+S+" SET rev=?, json=? WHERE id=? AND rev=?",i=[o,l,a,s]):(r="INSERT INTO "+S+" (id, rev, json) VALUES (?,?,?)",i=[a,o,l]),e.executeSql(r,i,function(e,r){r.rowsAffected?(c={ok:!0,id:a,rev:o},t.ctx&&n(null,c)):n(h.REV_CONFLICT)},function(){return n(h.REV_CONFLICT),!1})}"function"==typeof t&&(n=t,t={}),delete e._revisions;var o,s=e._rev,a=e._id;o=e._rev=s?"0-"+(parseInt(s.split("-")[1],10)+1):"0-1";var c,l=u(e);t.ctx?r(t.ctx):J.transaction(function(e){r(e)},i(n),function(){c&&n(null,c)})},void(F._removeLocal=function(e,t){var n;J.transaction(function(r){var o="DELETE FROM "+S+" WHERE id=? AND rev=?",i=[e._id,e._rev];r.executeSql(o,i,function(r,o){return o.rowsAffected?void(n={ok:!0,id:e._id,rev:"0-0"}):t(h.REV_CONFLICT)})},i(t),function(){t(null,n)})})):t(h.UNKNOWN_ERROR)}var f=e("../utils"),p=e("../merge"),h=e("../deps/errors"),v=e("vuvuzela"),m={},_=f.getArguments(function(e){if("undefined"!=typeof n){if(n.navigator&&n.navigator.sqlitePlugin&&n.navigator.sqlitePlugin.openDatabase)return navigator.sqlitePlugin.openDatabase.apply(navigator.sqlitePlugin,e);if(n.sqlitePlugin&&n.sqlitePlugin.openDatabase)return n.sqlitePlugin.openDatabase.apply(n.sqlitePlugin,e);var t=m[e[0]];return t||(t=m[e[0]]=n.openDatabase.apply(n,e)),t}}),y=1,g=4,b=r("document-store"),w=r("by-sequence"),E=r("attach-store"),S=r("local-store"),k=r("metadata-store"),x="CREATE INDEX IF NOT EXISTS 'by-seq-deleted-idx' ON "+w+" (seq, deleted)",q="CREATE UNIQUE INDEX IF NOT EXISTS 'by-seq-doc-id-rev' ON "+w+" (doc_id, rev)",T="CREATE INDEX IF NOT EXISTS 'doc-winningseq-idx' ON "+b+" (winningseq)",A=w+".seq = "+b+".winningseq",O=w+".seq AS seq, "+w+".deleted AS deleted, "+w+".json AS data, "+w+".rev AS rev, "+b+".json AS metadata";d.valid=function(){if("undefined"!=typeof n){if(n.navigator&&n.navigator.sqlitePlugin&&n.navigator.sqlitePlugin.openDatabase)return!0;if(n.sqlitePlugin&&n.sqlitePlugin.openDatabase)return!0;if(n.openDatabase)return!0}return!1},d.destroy=f.toPromise(function(e,t,r){d.Changes.removeAllListeners(e);var o=l(t),s=_(e,y,e,o);s.transaction(function(e){var t=[b,w,E,k,S];t.forEach(function(t){e.executeSql("DROP TABLE IF EXISTS "+t,[])})},i(r),function(){f.hasLocalStorage()&&(delete n.localStorage["_pouch__websqldb_"+e],delete n.localStorage[e]),r(null,{ok:!0})})}),d.Changes=new f.Changes,t.exports=d}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../deps/errors":11,"../merge":18,"../utils":23,vuvuzela:57}],6:[function(e,t){"use strict";function n(e,t,n){function r(){i.cancel()}a.call(this);var i=this;this.db=e,t=t?o.clone(t):{};var s=n||t.complete||function(){},u=t.complete=o.once(function(t,n){t?i.emit("error",t):i.emit("complete",n),i.removeAllListeners(),e.removeListener("destroyed",r)});s&&(i.on("complete",function(e){s(null,e)}),i.on("error",function(e){s(e)}));var c=t.onChange;c&&i.on("change",c),e.once("destroyed",r),t.onChange=function(e){t.isCancelled||(i.emit("change",e),i.startSeq&&i.startSeq<=e.seq&&(i.emit("uptodate"),i.startSeq=!1),e.deleted?i.emit("delete",e):1===e.changes.length&&"1-"===e.changes[0].rev.slice(0,2)?i.emit("create",e):i.emit("update",e))};var l=new o.Promise(function(e,n){t.complete=function(t,r){t?n(t):e(r)}});i.once("cancel",function(){c&&i.removeListener("change",c),t.complete(null,{status:"cancelled"})}),this.then=l.then.bind(l),this["catch"]=l["catch"].bind(l),this.then(function(e){u(null,e)},u),e.taskqueue.isReady?i.doChanges(t):e.taskqueue.addTask(function(){i.isCancelled?i.emit("cancel"):i.doChanges(t)})}function r(e,t,n){var r=[{rev:e._rev}];"all_docs"===n.style&&(r=i.collectLeaves(t.rev_tree).map(function(e){return{rev:e.rev}}));var s={id:t.id,changes:r,doc:e};return o.isDeleted(t,e._rev)&&(s.deleted=!0),n.conflicts&&(s.doc._conflicts=i.collectConflicts(t),s.doc._conflicts.length||delete s.doc._conflicts),s}var o=e("./utils"),i=e("./merge"),s=e("./deps/errors"),a=e("events").EventEmitter,u=e("./evalFilter"),c=e("./evalView");t.exports=n,o.inherits(n,a),n.prototype.cancel=function(){this.isCancelled=!0,this.db.taskqueue.isReady&&this.emit("cancel")},n.prototype.doChanges=function(e){var t=this,n=e.complete;if(e=o.clone(e),"live"in e&&!("continuous"in e)&&(e.continuous=e.live),e.processChange=r,"latest"===e.since&&(e.since="now"),e.since||(e.since=0),"now"===e.since)return void this.db.info().then(function(r){return t.isCancelled?void n(null,{status:"cancelled"}):(e.since=r.update_seq-1,void t.doChanges(e))},n);if(e.continuous&&"now"!==e.since&&this.db.info().then(function(e){t.startSeq=e.update_seq-1},function(e){if("idbNull"!==e.id)throw e}),"http"!==this.db.type()&&e.filter&&"string"==typeof e.filter)return this.filterChanges(e);"descending"in e||(e.descending=!1),e.limit=0===e.limit?1:e.limit,e.complete=n;var i=this.db._changes(e);if(i&&"function"==typeof i.cancel){var s=t.cancel;t.cancel=o.getArguments(function(e){i.cancel(),s.apply(this,e)})}},n.prototype.filterChanges=function(e){var t=this,n=e.complete;if("_view"===e.filter){if(!e.view||"string"!=typeof e.view){var r=new Error("`view` filter parameter is not provided.");return r.status=s.BAD_REQUEST.status,r.name=s.BAD_REQUEST.name,r.error=!0,void n(r)}var o=e.view.split("/");this.db.get("_design/"+o[0],function(r,i){if(t.isCancelled)return void n(null,{status:"cancelled"});if(r)return void n(r);if(i&&i.views&&i.views[o[1]]){var a=c(i.views[o[1]].map);return e.filter=a,void t.doChanges(e)}var u=i.views?"missing json key: "+o[1]:"missing json key: views";r||(r=new Error(u),r.status=s.MISSING_DOC.status,r.name=s.MISSING_DOC.name,r.error=!0),n(r)})}else{var i=e.filter.split("/");this.db.get("_design/"+i[0],function(r,o){if(t.isCancelled)return void n(null,{status:"cancelled"});if(r)return void n(r);if(o&&o.filters&&o.filters[i[1]]){var a=u(o.filters[i[1]]);return e.filter=a,void t.doChanges(e)}var c=o&&o.filters?"missing json key: "+i[1]:"missing json key: filters";return r||(r=new Error(c),r.status=s.MISSING_DOC.status,r.name=s.MISSING_DOC.name,r.error=!0),void n(r)})}}},{"./deps/errors":11,"./evalFilter":15,"./evalView":16,"./merge":18,"./utils":23,events:27}],7:[function(e,t){(function(n){"use strict";function r(e){e&&n.debug&&console.error(e)}function o(e,t,n){if(!(this instanceof o))return new o(e,t,n);var c=this;("function"==typeof t||"undefined"==typeof t)&&(n=t,t={}),e&&"object"==typeof e&&(t=e,e=void 0),"undefined"==typeof n&&(n=r),t=t||{};var l=n;c.auto_compaction=t.auto_compaction,c.prefix=o.prefix,i.call(c),c.taskqueue=new a;var d=new u(function(r,i){n=function(e,t){return e?i(e):(delete t.then,void r(t))},t=s.clone(t);var a,u,l=t.name||e;return function(){try{if("string"!=typeof l)throw u=new Error("Missing/invalid DB name"),u.code=400,u;if(a=o.parseAdapter(l,t),t.originalName=l,t.name=a.name,t.prefix&&"http"!==a.adapter&&"https"!==a.adapter&&(t.name=t.prefix+t.name),t.adapter=t.adapter||a.adapter,c._adapter=t.adapter,c._db_name=l,!o.adapters[t.adapter])throw u=new Error("Adapter is missing"),u.code=404,u;if(!o.adapters[t.adapter].valid())throw u=new Error("Invalid Adapter"),u.code=404,u}catch(e){c.taskqueue.fail(e),c.changes=s.toPromise(function(t){t.complete&&t.complete(e)})}}(),u?i(u):(c.adapter=t.adapter,c.replicate={},c.replicate.from=function(e,t,n){return c.constructor.replicate(e,c,t,n)},c.replicate.to=function(e,t,n){return c.constructor.replicate(c,e,t,n)},c.sync=function(e,t,n){return c.constructor.sync(c,e,t,n)},c.replicate.sync=c.sync,c.destroy=s.adapterFun("destroy",function(e){var t=this;t.info(function(n,r){return n?e(n):void t.constructor.destroy(r.db_name,e)})}),o.adapters[t.adapter].call(c,t,function(e){function r(e){"destroyed"===e&&(c.emit("destroyed"),o.removeListener(l,r))}return e?void(n&&(c.taskqueue.fail(e),n(e))):(o.on(l,r),c.emit("created",c),o.emit("created",t.originalName),c.taskqueue.ready(c),void n(null,c))}),t.skipSetup&&c.taskqueue.ready(c),void(s.isCordova()&&cordova.fireWindowEvent(t.name+"_pouch",{})))});d.then(function(e){l(null,e)},l),c.then=d.then.bind(d),c["catch"]=d["catch"].bind(d)}var i=e("./adapter"),s=e("./utils"),a=e("./taskqueue"),u=s.Promise;s.inherits(o,i),t.exports=o}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./adapter":1,"./taskqueue":22,"./utils":23}],8:[function(e,t){"use strict";function n(e,t){function n(t,n,r){if(e.binary||e.json||!e.processData||"string"==typeof t){if(!e.binary&&e.json&&"string"==typeof t)try{t=JSON.parse(t)}catch(o){return r(o)}}else t=JSON.stringify(t);Array.isArray(t)&&(t=t.map(function(e){var t;return e.ok?e:e.error&&"conflict"===e.error?(t=i.REV_CONFLICT,t.id=e.id,t):e.error&&"forbidden"===e.error?(t=i.FORBIDDEN,t.id=e.id,t.reason=e.reason,t):e.missing?(t=i.MISSING_DOC,t.missing=e.missing,t):e})),r(null,t,n)}function a(e,t){var n,r,o,s;try{n=JSON.parse(e.responseText);for(s in i)if(i.hasOwnProperty(s)&&i[s].name===n.error){o=i[s];break}o||(o=i.UNKNOWN_ERROR,e.status&&(o.status=e.status),e.statusText&&(e.name=e.statusText)),r=i.error(o,n.reason)}catch(a){for(var s in i)if(i.hasOwnProperty(s)&&i[s].status===e.status){o=i[s];break}o||(o=i.UNKNOWN_ERROR,e.status&&(o.status=e.status),e.statusText&&(e.name=e.statusText)),r=i.error(o)}e.withCredentials&&0===e.status&&(r.status=405,r.statusText="Method Not Allowed"),t(r)}var u=!1,c=s.getArguments(function(e){u||(t.apply(this,e),u=!0)});"function"==typeof e&&(c=e,e={}),e=s.clone(e);var l={method:"GET",headers:{},json:!0,processData:!0,timeout:1e4,cache:!1};if(e=s.extend(!0,l,e),"GET"===e.method&&!e.cache){var d=-1!==e.url.indexOf("?");e.url+=(d?"&":"?")+"_nonce="+s.uuid(16)}var f,p;p=e.xhr?new e.xhr:new XMLHttpRequest,p.open(e.method,e.url),p.withCredentials=!0,e.json&&(e.headers.Accept="application/json",e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.body&&e.processData&&"string"!=typeof e.body&&(e.body=JSON.stringify(e.body))),e.binary&&(p.responseType="arraybuffer");var h=function(e,t,n){var r="";if(n){var o=new Date;o.setTime(o.getTime()+24*n*60*60*1e3),r="; expires="+o.toGMTString()}document.cookie=e+"="+t+r+"; path=/"};for(var v in e.headers)if("Cookie"===v){var m=e.headers[v].split("=");h(m[0],m[1],10)}else p.setRequestHeader(v,e.headers[v]);"body"in e||(e.body=null);var _=function(){u||(p.abort(),a(p,c))};if(p.onreadystatechange=function(){if(4===p.readyState&&!u)if(clearTimeout(f),p.status>=200&&p.status<300){var t;t=e.binary?o([p.response||""],{type:p.getResponseHeader("Content-Type")}):p.responseText,n(t,p,c)}else a(p,c)},e.timeout>0&&(f=setTimeout(_,e.timeout),p.onprogress=function(){clearTimeout(f),f=setTimeout(_,e.timeout)},"undefined"==typeof r&&(r=-1!==Object.keys(p).indexOf("upload")),r&&(p.upload.onprogress=p.onprogress)),e.body&&e.body instanceof Blob){var y=new FileReader;y.onloadend=function(){for(var e="",t=new Uint8Array(this.result),n=t.byteLength,r=0;n>r;r++)e+=String.fromCharCode(t[r]);e=s.fixBinary(e),p.send(e)},y.readAsArrayBuffer(e.body)}else p.send(e.body);return{abort:_}}var r,o=e("./blob.js"),i=e("./errors"),s=e("../utils");t.exports=n},{"../utils":23,"./blob.js":9,"./errors":11}],9:[function(e,t){(function(e){"use strict";function n(t,n){t=t||[],n=n||{};try{return new Blob(t,n)}catch(r){if("TypeError"!==r.name)throw r;for(var o=e.BlobBuilder||e.MSBlobBuilder||e.MozBlobBuilder||e.WebKitBlobBuilder,i=new o,s=0;s<t.length;s+=1)i.append(t[s]);return i.getBlob(n.type)}}t.exports=n}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],10:[function(e,t,n){"use strict";function r(){this.store={}}function o(){this.store=new r}n.Map=r,n.Set=o,r.prototype.mangle=function(e){if("string"!=typeof e)throw new TypeError("key must be a string but Got "+e);return"$"+e},r.prototype.unmangle=function(e){return e.substring(1)},r.prototype.get=function(e){var t=this.mangle(e);return t in this.store?this.store[t]:void 0},r.prototype.set=function(e,t){var n=this.mangle(e);return this.store[n]=t,!0},r.prototype.has=function(e){var t=this.mangle(e);return t in this.store},r.prototype["delete"]=function(e){var t=this.mangle(e);return t in this.store?(delete this.store[t],!0):!1},r.prototype.forEach=function(e){var t=this,n=Object.keys(t.store);n.forEach(function(n){var r=t.store[n];n=t.unmangle(n),e(r,n)})},o.prototype.add=function(e){return this.store.set(e,!0)},o.prototype.has=function(e){return this.store.has(e)},o.prototype["delete"]=function(e){return this.store["delete"](e)}},{}],11:[function(e,t,n){"use strict";function r(e){this.status=e.status,this.name=e.error,this.message=e.reason,this.error=!0}r.prototype__proto__=Error.prototype,r.prototype.toString=function(){return JSON.stringify({status:this.status,name:this.name,message:this.message})},n.UNAUTHORIZED=new r({status:401,error:"unauthorized",reason:"Name or password is incorrect."}),n.MISSING_BULK_DOCS=new r({status:400,error:"bad_request",reason:"Missing JSON list of 'docs'"}),n.MISSING_DOC=new r({status:404,error:"not_found",reason:"missing"}),n.REV_CONFLICT=new r({status:409,error:"conflict",reason:"Document update conflict"}),n.INVALID_ID=new r({status:400,error:"invalid_id",reason:"_id field must contain a string"}),n.MISSING_ID=new r({status:412,error:"missing_id",reason:"_id is required for puts"}),n.RESERVED_ID=new r({status:400,error:"bad_request",reason:"Only reserved document ids may start with underscore."}),n.NOT_OPEN=new r({status:412,error:"precondition_failed",reason:"Database not open"}),n.UNKNOWN_ERROR=new r({status:500,error:"unknown_error",reason:"Database encountered an unknown error"}),n.BAD_ARG=new r({status:500,error:"badarg",reason:"Some query argument is invalid"}),n.INVALID_REQUEST=new r({status:400,error:"invalid_request",reason:"Request was invalid"}),n.QUERY_PARSE_ERROR=new r({status:400,error:"query_parse_error",reason:"Some query parameter is invalid"}),n.DOC_VALIDATION=new r({status:500,error:"doc_validation",reason:"Bad special document member"}),n.BAD_REQUEST=new r({status:400,error:"bad_request",reason:"Something wrong with the request"}),n.NOT_AN_OBJECT=new r({status:400,error:"bad_request",reason:"Document must be a JSON object"}),n.DB_MISSING=new r({status:404,error:"not_found",reason:"Database not found"}),n.IDB_ERROR=new r({status:500,error:"indexed_db_went_bad",reason:"unknown"}),n.WSQ_ERROR=new r({status:500,error:"web_sql_went_bad",reason:"unknown"}),n.LDB_ERROR=new r({status:500,error:"levelDB_went_went_bad",reason:"unknown"}),n.FORBIDDEN=new r({status:403,error:"forbidden",reason:"Forbidden by design doc validate_doc_update function"}),n.error=function(e,t,n){function r(){this.message=t,n&&(this.name=n)}return r.prototype=e,new r(t)}},{}],12:[function(e,t){(function(n,r){"use strict";function o(e,t,n){if("function"==typeof e.slice)return t?n?e.slice(t,n):e.slice(t):e.slice();t=Math.floor(t||0),n=Math.floor(n||0);var r=e.byteLength;if(t=0>t?Math.max(t+r,0):Math.min(r,t),n=0>n?Math.max(n+r,0):Math.min(r,n),0>=n-t)return new ArrayBuffer(0);var o=new ArrayBuffer(n-t),i=new Uint8Array(o),s=new Uint8Array(e,t,n-t);return i.set(s),o}function i(e){var t=[255&e,e>>>8&255,e>>>16&255,e>>>24&255];return t.map(function(e){return String.fromCharCode(e)}).join("")}function s(e){for(var t="",n=0;n<e.length;n++)t+=i(e[n]);
return r.btoa(t)}var a=e("crypto"),u=e("spark-md5"),c=r.setImmediate||r.setTimeout;t.exports=function(e,t){function r(e,t,n,r){d?e.appendBinary(t.substring(n,r)):e.append(o(t,n,r))}function i(){var n=v*p,o=n+p;if(n+p>=e.size&&(o=e.size),v++,h>v)r(m,e,n,o),c(i);else{r(m,e,n,o);var a=m.end(!0),u=s(a);t(null,u),m.destroy()}}if(!n.browser){var l=a.createHash("md5").update(e).digest("base64");return void t(null,l)}var d="string"==typeof e,f=d?e.length:e.byteLength,p=Math.min(524288,f),h=Math.ceil(f/p),v=0,m=d?new u:new u.ArrayBuffer;i()}}).call(this,e("/Users/nolan/workspace/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"/Users/nolan/workspace/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":28,crypto:26,"spark-md5":56}],13:[function(e,t){"use strict";function n(e,t,n){return new o(function(o,i){return t&&"object"==typeof t&&(t=t._id),"string"!=typeof t?i(new Error("doc id is required")):void e.get(t,function(s,a){if(s)return 404!==s.status?i(s):o(r(e,n({_id:t}),n));var u=n(a);return u?void o(r(e,u,n)):o(a)})})}function r(e,t,r){return e.put(t)["catch"](function(o){if(409!==o.status)throw o;return n(e,t,r)})}var o=e("../utils").Promise;t.exports=function(e,t,r,o){return"function"!=typeof o?n(e,t,r):void n(e,t,r).then(function(e){o(null,e)},o)}},{"../utils":23}],14:[function(e,t){"use strict";function n(e){return 0|Math.random()*e}function r(e,t){t=t||o.length;var r="",i=-1;if(e){for(;++i<e;)r+=o[n(t)];return r}for(;++i<36;)switch(i){case 8:case 13:case 18:case 23:r+="-";break;case 19:r+=o[3&n(16)|8];break;default:r+=o[n(16)]}return r}var o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");t.exports=r},{}],15:[function(_dereq_,module,exports){"use strict";function evalFilter(input){return eval(["(function () { return ",input," })()"].join(""))}module.exports=evalFilter},{}],16:[function(_dereq_,module,exports){"use strict";function evalView(input){return eval(["(function () {","  return function (doc) {","    var emitted = false;","    var emit = function (a, b) {","      emitted = true;","    };","    var view = "+input+";","    view(doc);","    if (emitted) {","      return true;","    }","  }","})()"].join("\n"))}module.exports=evalView},{}],17:[function(e,t){(function(n){"use strict";var r=e("./setup");t.exports=r,r.ajax=e("./deps/ajax"),r.extend=e("pouchdb-extend"),r.utils=e("./utils"),r.Errors=e("./deps/errors"),r.replicate=e("./replicate").replicate,r.sync=e("./sync"),r.version=e("./version");var o=e("./adapters/http");if(r.adapter("http",o),r.adapter("https",o),r.adapter("idb",e("./adapters/idb")),r.adapter("websql",e("./adapters/websql")),r.plugin(e("pouchdb-mapreduce")),!n.browser){var i=e("./adapters/leveldb");r.adapter("ldb",i),r.adapter("leveldb",i)}}).call(this,e("/Users/nolan/workspace/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"))},{"./adapters/http":2,"./adapters/idb":3,"./adapters/leveldb":26,"./adapters/websql":5,"./deps/ajax":8,"./deps/errors":11,"./replicate":19,"./setup":20,"./sync":21,"./utils":23,"./version":24,"/Users/nolan/workspace/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":28,"pouchdb-extend":47,"pouchdb-mapreduce":50}],18:[function(e,t){"use strict";function n(e){for(var t,n=e.shift(),r=[n.id,n.opts,[]],o=r;e.length;)n=e.shift(),t=[n.id,n.opts,[]],o[2].push(t),o=t;return r}function r(e,t){for(var n=[{tree1:e,tree2:t}],r=!1;n.length>0;){var o=n.pop(),i=o.tree1,s=o.tree2;(i[1].status||s[1].status)&&(i[1].status="available"===i[1].status||"available"===s[1].status?"available":"missing");for(var a=0;a<s[2].length;a++)if(i[2][0]){for(var u=!1,c=0;c<i[2].length;c++)i[2][c][0]===s[2][a][0]&&(n.push({tree1:i[2][c],tree2:s[2][a]}),u=!0);u||(r="new_branch",i[2].push(s[2][a]),i[2].sort())}else r="new_leaf",i[2][0]=s[2][a]}return{conflicts:r,tree:e}}function o(e,t,n){var o,i=[],s=!1,a=!1;return e.length?(e.forEach(function(e){if(e.pos===t.pos&&e.ids[0]===t.ids[0])o=r(e.ids,t.ids),i.push({pos:e.pos,ids:o.tree}),s=s||o.conflicts,a=!0;else if(n!==!0){var u=e.pos<t.pos?e:t,c=e.pos<t.pos?t:e,l=c.pos-u.pos,d=[],f=[];for(f.push({ids:u.ids,diff:l,parent:null,parentIdx:null});f.length>0;){var p=f.pop();0!==p.diff?p.ids&&p.ids[2].forEach(function(e,t){f.push({ids:e,diff:p.diff-1,parent:p.ids,parentIdx:t})}):p.ids[0]===c.ids[0]&&d.push(p)}var h=d[0];h?(o=r(h.ids,c.ids),h.parent[2][h.parentIdx]=o.tree,i.push({pos:u.pos,ids:u.ids}),s=s||o.conflicts,a=!0):i.push(e)}else i.push(e)}),a||i.push(t),i.sort(function(e,t){return e.pos-t.pos}),{tree:i,conflicts:s||"internal_node"}):{tree:[t],conflicts:"new_leaf"}}function i(e,t){var r=a.rootToLeaf(e).map(function(e){var r=e.ids.slice(-t);return{pos:e.pos+(e.ids.length-r.length),ids:n(r)}});return r.reduce(function(e,t){return o(e,t,!0).tree},[r.shift()])}var s=e("pouchdb-extend"),a={};a.merge=function(e,t,n){e=s(!0,[],e),t=s(!0,{},t);var r=o(e,t);return{tree:i(r.tree,n),conflicts:r.conflicts}},a.winningRev=function(e){var t=[];return a.traverseRevTree(e.rev_tree,function(e,n,r,o,i){e&&t.push({pos:n,id:r,deleted:!!i.deleted})}),t.sort(function(e,t){return e.deleted!==t.deleted?e.deleted>t.deleted?1:-1:e.pos!==t.pos?t.pos-e.pos:e.id<t.id?1:-1}),t[0].pos+"-"+t[0].id},a.traverseRevTree=function(e,t){for(var n,r=e.slice();n=r.pop();)for(var o=n.pos,i=n.ids,s=i[2],a=t(0===s.length,o,i[0],n.ctx,i[1]),u=0,c=s.length;c>u;u++)r.push({pos:o+1,ids:s[u],ctx:a})},a.collectLeaves=function(e){var t=[];return a.traverseRevTree(e,function(e,n,r,o,i){e&&t.unshift({rev:n+"-"+r,pos:n,opts:i})}),t.sort(function(e,t){return t.pos-e.pos}),t.map(function(e){delete e.pos}),t},a.collectConflicts=function(e){var t=a.winningRev(e),n=a.collectLeaves(e.rev_tree),r=[];return n.forEach(function(e){e.rev===t||e.opts.deleted||r.push(e.rev)}),r},a.rootToLeaf=function(e){var t=[];return a.traverseRevTree(e,function(e,n,r,o,i){if(o=o?o.slice(0):[],o.push({id:r,opts:i}),e){var s=n+1-o.length;t.unshift({pos:s,ids:o})}return o}),t},t.exports=a},{"pouchdb-extend":47}],19:[function(e,t,n){"use strict";function r(){d.call(this),this.cancelled=!1;var e=this,t=new l.Promise(function(t,n){e.once("complete",t),e.once("error",n)});e.then=function(e,n){return t.then(e,n)},e["catch"]=function(e){return t["catch"](e)},e["catch"](function(){})}function o(e,t,n){var r=n.filter?n.filter.toString():"";return e.id().then(function(e){return t.id().then(function(t){var o=e+t+r+JSON.stringify(n.query_params)+n.doc_ids;return l.MD5(o).then(function(e){return e=e.replace(/\//g,".").replace(/\+/g,"_"),"_local/"+e})})})}function i(e,t,n,r){return e.get(t)["catch"](function(e){if(404===e.status)return{_id:t};throw e}).then(function(t){return r.cancelled?void 0:(t.last_seq=n,e.put(t))})}function s(e,t,n,r){this.src=e,this.target=t,this.id=n,this.returnValue=r}function a(e,t,n,r,o){function i(){if(0!==k.docs.length){var e=k.docs;return n.bulkDocs({docs:e},{new_edits:!1}).then(function(e){if(o.cancelled)throw y(),new Error("cancelled");var t=[];if(e.forEach(function(e){e.ok||(B.doc_write_failures++,t.push(new Error(e.reason||e.message||"Unknown reason")))}),t.length>0){var n=new Error("bulkDocs error");throw n.other_errors=t,_("target.bulkDocs failed to write docs",n),new Error("bulkWrite partial failure")}},function(t){throw B.doc_write_failures+=e.length,t})}}function a(){for(var e=k.diffs,n=Object.keys(e)[0],r=e[n].missing,i=[],s=0;s<r.length;s+=f)i.push(r.slice(s,Math.min(r.length,s+f)));return l.Promise.all(i.map(function(r){return t.get(n,{revs:!0,open_revs:r,attachments:!0}).then(function(t){t.forEach(function(t){return o.cancelled?y():void(t.ok&&(B.docs_read++,k.pendingRevs++,k.docs.push(t.ok),delete e[t.ok._id]))})})}))}function u(){return Object.keys(k.diffs).length>0?a().then(u):l.Promise.resolve()}function c(){var e=Object.keys(k.diffs).filter(function(e){var t=k.diffs[e].missing;return 1===t.length&&"1-"===t[0].slice(0,2)});return t.allDocs({keys:e,include_docs:!0}).then(function(e){if(o.cancelled)throw y(),new Error("cancelled");e.rows.forEach(function(e){!e.doc||e.deleted||"1-"!==e.value.rev.slice(0,2)||e.doc._attachments&&0!==Object.keys(e.doc._attachments).length||(B.docs_read++,k.pendingRevs++,k.docs.push(e.doc),delete k.diffs[e.id])})})}function d(){return c().then(u)}function p(){return T=!0,F.writeCheckpoint(k.seq).then(function(){if(T=!1,o.cancelled)throw y(),new Error("cancelled");B.last_seq=L=k.seq,B.docs_written+=k.docs.length,o.emit("change",l.clone(B)),k=void 0,E()})["catch"](function(e){throw T=!1,_("writeCheckpoint completed with error",e),e})}function h(){var e={};return k.changes.forEach(function(t){e[t.id]=t.changes.map(function(e){return e.rev})}),n.revsDiff(e).then(function(e){if(o.cancelled)throw y(),new Error("cancelled");k.diffs=e,k.pendingRevs=0})}function v(){if(!o.cancelled&&!k){if(0===x.length)return void m(!0);k=x.shift(),h().then(d).then(i).then(p).then(v)["catch"](function(e){_("batch processing terminated with error",e)})}}function m(e){return 0===q.changes.length?void(0!==x.length||k||((R&&M.live||A)&&o.emit("uptodate",l.clone(B)),A&&y())):void((e||A||q.changes.length>=I)&&(x.push(q),q={seq:0,changes:[],docs:[]},v()))}function _(e,t){O||(B.ok=!1,B.status="aborted",B.errors.push(t),x=[],q={seq:0,changes:[],docs:[]},y())}function y(){if(!(O||o.cancelled&&(B.status="cancelled",T))){if(B.status=B.status||"complete",B.end_time=new Date,B.last_seq=L,O=o.cancelled=!0,B.errors.length>0){var e=B.errors.pop();B.errors.length>0&&(e.other_errors=B.errors),e.result=B,o.emit("error",e)}else o.emit("complete",B);o.removeAllListeners()}}function g(e){return o.cancelled?y():(N++,0!==q.changes.length||0!==x.length||k||o.emit("outofdate",l.clone(B)),q.seq=e.seq,q.changes.push(e),void m(0===x.length))}function b(e){return C=!1,o.cancelled?y():(N>0?(M.since=e.last_seq,E()):R?(M.live=!0,E()):A=!0,void m(!0))}function w(e){return C=!1,o.cancelled?y():void _("changes rejected",e)}function E(){function e(){r.cancel()}function n(){o.removeListener("cancel",e)}if(!C&&!A&&x.length<D){C=!0,N=0,o.once("cancel",e);var r=t.changes(M).on("change",g);r.then(n,n),r.then(b)["catch"](w)}}function S(){F.getCheckpoint().then(function(e){L=e,M={since:L,limit:I,batch_size:I,style:"all_docs",doc_ids:j,returnDocs:!1},r.filter&&(M.filter=r.filter),r.query_params&&(M.query_params=r.query_params),E()})["catch"](function(e){_("getCheckpoint rejected with ",e)})}var k,x=[],q={seq:0,changes:[],docs:[]},T=!1,A=!1,O=!1,L=0,R=r.continuous||r.live||!1,I=r.batch_size||100,D=r.batches_limit||10,C=!1,N=0,j=r.doc_ids,F=new s(t,n,e,o),B={ok:!0,start_time:new Date,docs_read:0,docs_written:0,doc_write_failures:0,errors:[]},M={};o.ready(t,n),o.once("cancel",y),"function"==typeof r.onChange&&o.on("change",r.onChange),"function"==typeof r.complete&&(o.once("error",r.complete),o.once("complete",function(e){r.complete(null,e)})),"undefined"==typeof r.since?S():(T=!0,F.writeCheckpoint(r.since).then(function(){return T=!1,o.cancelled?void y():(L=r.since,void S())})["catch"](function(e){throw T=!1,_("writeCheckpoint completed with error",e),e}))}function u(e,t){var n=t.PouchConstructor;return"string"==typeof e?new n(e):e.then?e:l.Promise.resolve(e)}function c(e,t,n,i){"function"==typeof n&&(i=n,n={}),"undefined"==typeof n&&(n={}),n.complete||(n.complete=i||function(){}),n=l.clone(n),n.continuous=n.continuous||n.live,n.PouchConstructor=n.PouchConstructor||this;var s=new r(n);return u(e,n).then(function(e){return u(t,n).then(function(t){return o(e,t,n).then(function(r){a(r,e,t,n,s)})})})["catch"](function(e){s.emit("error",e),n.complete(e)}),s}var l=e("./utils"),d=e("events").EventEmitter,f=50;l.inherits(r,d),r.prototype.cancel=function(){this.cancelled=!0,this.emit("cancel")},r.prototype.ready=function(e,t){function n(){o.cancel()}function r(){e.removeListener("destroyed",n),t.removeListener("destroyed",n)}var o=this;e.once("destroyed",n),t.once("destroyed",n),this.then(r,r)},s.prototype.writeCheckpoint=function(e){var t=this;return this.updateTarget(e).then(function(){return t.updateSource(e)})},s.prototype.updateTarget=function(e){return i(this.target,this.id,e,this.returnValue)},s.prototype.updateSource=function(e){var t=this;return this.readOnlySource?l.Promise.resolve(!0):i(this.src,this.id,e,this.returnValue)["catch"](function(e){var n="number"==typeof e.status&&4===Math.floor(e.status/100);if(n)return t.readOnlySource=!0,!0;throw e})},s.prototype.getCheckpoint=function(){var e=this;return e.target.get(e.id).then(function(t){return e.src.get(e.id).then(function(e){return t.last_seq===e.last_seq?e.last_seq:0},function(n){if(404===n.status&&t.last_seq)return e.src.put({_id:e.id,last_seq:0}).then(function(){return 0},function(n){return 401===n.status?(e.readOnlySource=!0,t.last_seq):0});throw n})})["catch"](function(e){if(404!==e.status)throw e;return 0})},n.toPouch=u,n.replicate=c},{"./utils":23,events:27}],20:[function(e,t){(function(n){"use strict";var r=e("./constructor"),o=e("./utils"),i=o.Promise,s=e("events").EventEmitter;r.adapters={},r.preferredAdapters=e("./adapters/preferredAdapters.js"),r.prefix="_pouch_";var a=new s,u=["on","addListener","emit","listeners","once","removeAllListeners","removeListener","setMaxListeners"];u.forEach(function(e){r[e]=a[e].bind(a)}),r.setMaxListeners(0),r.parseAdapter=function(e,t){var i,s,a=e.match(/([a-z\-]*):\/\/(.*)/);if(a){if(e=/http(s?)/.test(a[1])?a[1]+"://"+a[2]:a[2],i=a[1],!r.adapters[i].valid())throw"Invalid adapter";return{name:e,adapter:a[1]}}var u="idb"in r.adapters&&"websql"in r.adapters&&o.hasLocalStorage()&&n.localStorage["_pouch__websqldb_"+r.prefix+e];if("undefined"!=typeof t&&t.db)s="leveldb";else for(var c=0;c<r.preferredAdapters.length;++c)if(s=r.preferredAdapters[c],s in r.adapters){if(u&&"idb"===s)continue;break}if(i=r.adapters[s],s&&i){var l="use_prefix"in i?i.use_prefix:!0;return{name:l?r.prefix+e:e,adapter:s}}throw"No valid adapter found"},r.destroy=o.toPromise(function(e,t,n){function s(){c.destroy(f,t,function(t,o){t?n(t):(r.emit("destroyed",e),r.emit(e,"destroyed"),n(null,o||{ok:!0}))})}("function"==typeof t||"undefined"==typeof t)&&(n=t,t={}),e&&"object"==typeof e&&(t=e,e=void 0);var a=r.parseAdapter(t.name||e,t),u=a.name,c=r.adapters[a.adapter],l="use_prefix"in c?c.use_prefix:!0,d=l?u.replace(new RegExp("^"+r.prefix),""):u,f=("http"===a.adapter||"https"===a.adapter?"":t.prefix||"")+u,p=o.extend(!0,{},t,{adapter:a.adapter});new r(d,p,function(e,u){return e?n(e):void u.get("_local/_pouch_dependentDbs",function(e,u){if(e)return 404!==e.status?n(e):s();var c=u.dependentDbs,d=Object.keys(c).map(function(e){var n=l?e.replace(new RegExp("^"+r.prefix),""):e,i=o.extend(!0,t,{adapter:a.adapter});return r.destroy(n,i)});i.all(d).then(s,function(e){n(e)})})})}),r.allDbs=o.toPromise(function(e){var t=new Error("allDbs method removed");t.stats="400",e(t)}),r.adapter=function(e,t){t.valid()&&(r.adapters[e]=t)},r.plugin=function(e){Object.keys(e).forEach(function(t){r.prototype[t]=e[t]})},r.defaults=function(e){function t(t,n,i){("function"==typeof n||"undefined"==typeof n)&&(i=n,n={}),t&&"object"==typeof t&&(n=t,t=void 0),n=o.extend(!0,{},e,n),r.call(this,t,n,i)}return o.inherits(t,r),t.destroy=o.toPromise(function(t,n,i){return("function"==typeof n||"undefined"==typeof n)&&(i=n,n={}),t&&"object"==typeof t&&(n=t,t=void 0),n=o.extend(!0,{},e,n),r.destroy(t,n,i)}),u.forEach(function(e){t[e]=a[e].bind(a)}),t.setMaxListeners(0),t.preferredAdapters=r.preferredAdapters.slice(),Object.keys(r).forEach(function(e){e in t||(t[e]=r[e])}),t},t.exports=r}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./adapters/preferredAdapters.js":4,"./constructor":7,"./utils":23,events:27}],21:[function(e,t){"use strict";function n(e,t,n,s){return"function"==typeof n&&(s=n,n={}),"undefined"==typeof n&&(n={}),n=o.clone(n),n.PouchConstructor=n.PouchConstructor||this,e=i.toPouch(e,n),t=i.toPouch(t,n),new r(e,t,n,s)}function r(e,t,n,r){function i(e){p||(p=!0,l.emit("cancel",e))}function a(e){l.emit("change",{direction:"pull",change:e})}function u(e){l.emit("change",{direction:"push",change:e})}function c(e){return function(t,n){var r="change"===t&&(n===a||n===u),o="cancel"===t&&n===i,s=t in h&&n===h[t];(r||o||s)&&(t in v||(v[t]={}),v[t][e]=!0,2===Object.keys(v[t]).length&&l.removeAllListeners(t))}}var l=this;this.canceled=!1;var d,f;"onChange"in n&&(d=n.onChange,delete n.onChange),"function"!=typeof r||n.complete?"complete"in n&&(f=n.complete,delete n.complete):f=r,this.push=s(e,t,n),this.pull=s(t,e,n);var p=!1,h={},v={};this.on("newListener",function(e){"change"===e?(l.pull.on("change",a),l.push.on("change",u)):"cancel"===e?(l.pull.on("cancel",i),l.push.on("cancel",i)):"error"===e||"removeListener"===e||"complete"===e||e in h||(h[e]=function(t){l.emit(e,t)},l.pull.on(e,h[e]),l.push.on(e,h[e]))}),this.on("removeListener",function(e){"change"===e?(l.pull.removeListener("change",a),l.push.removeListener("change",u)):"cancel"===e?(l.pull.removeListener("cancel",i),l.push.removeListener("cancel",i)):e in h&&"function"==typeof h[e]&&(l.pull.removeListener(e,h[e]),l.push.removeListener(e,h[e]),delete h[e])}),this.pull.on("removeListener",c("pull")),this.push.on("removeListener",c("push"));var m=o.Promise.all([this.push,this.pull]).then(function(e){var t={push:e[0],pull:e[1]};return l.emit("complete",t),f&&f(null,t),l.removeAllListeners(),t},function(e){throw l.cancel(),l.emit("error",e),f&&f(e),l.removeAllListeners(),e});this.then=function(e,t){return m.then(e,t)},this["catch"]=function(e){return m["catch"](e)}}var o=e("./utils"),i=e("./replicate"),s=i.replicate,a=e("events").EventEmitter;o.inherits(r,a),t.exports=n,r.prototype.cancel=function(){this.canceled||(this.canceled=!0,this.push.cancel(),this.pull.cancel())}},{"./replicate":19,"./utils":23,events:27}],22:[function(e,t){"use strict";function n(){this.isReady=!1,this.failed=!1,this.queue=[]}t.exports=n,n.prototype.execute=function(){var e,t;if(this.failed)for(;e=this.queue.shift();)"function"!=typeof e?(t=e.parameters[e.parameters.length-1],"function"==typeof t?t(this.failed):"changes"===e.name&&"function"==typeof t.complete&&t.complete(this.failed)):e(this.failed);else if(this.isReady)for(;e=this.queue.shift();)"function"==typeof e?e():e.task=this.db[e.name].apply(this.db,e.parameters)},n.prototype.fail=function(e){this.failed=e,this.execute()},n.prototype.ready=function(e){return this.failed?!1:0===arguments.length?this.isReady:(this.isReady=e?!0:!1,this.db=e,void this.execute())},n.prototype.addTask=function(e,t){if("function"!=typeof e){var n={name:e,parameters:t};return this.queue.push(n),this.failed&&this.execute(),n}this.queue.push(e),this.failed&&this.execute()}},{}],23:[function(e,t,n){(function(t,r){function o(e){var t={};return e.forEach(function(e){t[e]=!0}),t}function i(){return"undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage&&"undefined"!=typeof chrome.storage.local}function s(){if(!(this instanceof s))return new s;var e=this;l.call(this),this.isChrome=i(),this.listeners={},this.hasLocal=!1,this.isChrome||(this.hasLocal=n.hasLocalStorage()),this.isChrome?chrome.storage.onChanged.addListener(function(t){null!=t.db_name&&e.emit(t.dbName.newValue)}):this.hasLocal&&(r.addEventListener?r.addEventListener("storage",function(t){e.emit(t.key)}):r.attachEvent("storage",function(t){e.emit(t.key)}))}var a=e("./merge");n.extend=e("pouchdb-extend"),n.ajax=e("./deps/ajax"),n.createBlob=e("./deps/blob"),n.uuid=e("./deps/uuid"),n.getArguments=e("argsarray");var u=e("./deps/buffer"),c=e("./deps/errors"),l=e("events").EventEmitter,d=e("./deps/collections");n.Map=d.Map,n.Set=d.Set,n.Promise="function"==typeof r.Promise?r.Promise:e("bluebird");var f=n.Promise,p=o(["_id","_rev","_attachments","_deleted","_revisions","_revs_info","_conflicts","_deleted_conflicts","_local_seq","_rev_tree","_replication_id","_replication_state","_replication_state_time","_replication_state_reason","_replication_stats"]);n.clone=function(e){return n.extend(!0,{},e)},n.inherits=e("inherits"),n.invalidIdError=function(e){var t;if(e?"string"!=typeof e?(t=new TypeError(c.INVALID_ID.message),t.status=400):/^_/.test(e)&&!/^_(design|local)/.test(e)&&(t=new TypeError(c.RESERVED_ID.message),t.status=400):(t=new TypeError(c.MISSING_ID.message),t.status=412),t)throw t},n.call=n.getArguments(function(e){if(e.length){var t=e.shift();"function"==typeof t&&t.apply(this,e)}}),n.isLocalId=function(e){return/^_local/.test(e)},n.isDeleted=function(e,t){t||(t=a.winningRev(e));var n=t.indexOf("-");-1!==n&&(t=t.substring(n+1));var r=!1;return a.traverseRevTree(e.rev_tree,function(e,n,o,i,s){o===t&&(r=!!s.deleted)}),r},n.filterChange=function(e){return function(t){var n={},r=e.filter&&"function"==typeof e.filter;if(n.query=e.query_params,e.filter&&r&&!e.filter.call(this,t.doc,n))return!1;if(e.doc_ids&&-1===e.doc_ids.indexOf(t.id))return!1;if(e.include_docs)for(var o in t.doc._attachments)t.doc._attachments.hasOwnProperty(o)&&(t.doc._attachments[o].stub=!0);else delete t.doc;return!0}},n.parseDoc=function(e,t){var r,o,i,s,a={status:"available"};if(e._deleted&&(a.deleted=!0),t)if(e._id||(e._id=n.uuid()),o=n.uuid(32,16).toLowerCase(),e._rev){if(i=/^(\d+)-(.+)$/.exec(e._rev),!i){var u=new TypeError("invalid value for property '_rev'");u.status=400}e._rev_tree=[{pos:parseInt(i[1],10),ids:[i[2],{status:"missing"},[[o,a,[]]]]}],r=parseInt(i[1],10)+1}else e._rev_tree=[{pos:1,ids:[o,a,[]]}],r=1;else if(e._revisions&&(e._rev_tree=[{pos:e._revisions.start-e._revisions.ids.length+1,ids:e._revisions.ids.reduce(function(e,t){return null===e?[t,a,[]]:[t,{status:"missing"},[e]]},null)}],r=e._revisions.start,o=e._revisions.ids[0]),!e._rev_tree){if(i=/^(\d+)-(.+)$/.exec(e._rev),!i)throw s=new TypeError(c.BAD_ARG.message),s.status=c.BAD_ARG.status,s;r=parseInt(i[1],10),o=i[2],e._rev_tree=[{pos:parseInt(i[1],10),ids:[i[2],a,[]]}]}n.invalidIdError(e._id),e._rev=[r,o].join("-");var l={metadata:{},data:{}};for(var d in e)if(e.hasOwnProperty(d)){var f="_"===d[0];if(f&&!p[d])throw s=new Error(c.DOC_VALIDATION.message+": "+d),s.status=c.DOC_VALIDATION.status,s;f&&"_attachments"!==d?l.metadata[d.slice(1)]=e[d]:l.data[d]=e[d]}return l},n.isCordova=function(){return"undefined"!=typeof cordova||"undefined"!=typeof PhoneGap||"undefined"!=typeof phonegap},n.hasLocalStorage=function(){if(i())return!1;try{return r.localStorage}catch(e){return!1}},n.Changes=s,n.inherits(s,l),s.prototype.addListener=function(e,t,r,o){function i(){r.changes({include_docs:o.include_docs,conflicts:o.conflicts,continuous:!1,descending:!1,filter:o.filter,view:o.view,since:o.since,query_params:o.query_params,onChange:function(e){e.seq>o.since&&!o.cancelled&&(o.since=e.seq,n.call(o.onChange,e))}})}this.listeners[t]||(this.listeners[t]=i,this.on(e,i))},s.prototype.removeListener=function(e,t){t in this.listeners&&l.prototype.removeListener.call(this,e,this.listeners[t])},s.prototype.notifyLocalWindows=function(e){this.isChrome?chrome.storage.local.set({dbName:e}):this.hasLocal&&(localStorage[e]="a"===localStorage[e]?"b":"a")},s.prototype.notify=function(e){this.emit(e),this.notifyLocalWindows(e)},n.atob=t.browser&&"atob"in r?function(e){return atob(e)}:function(e){var t=new u(e,"base64");if(t.toString("base64")!==e)throw"Cannot base64 encode full string";return t.toString("binary")},n.btoa=t.browser&&"btoa"in r?function(e){return btoa(e)}:function(e){return new u(e,"binary").toString("base64")},n.fixBinary=function(e){if(!t.browser)return e;for(var n=e.length,r=new ArrayBuffer(n),o=new Uint8Array(r),i=0;n>i;i++)o[i]=e.charCodeAt(i);return r},n.once=function(e){var t=!1;return n.getArguments(function(n){if(t)throw"function"==typeof console.trace&&console.trace(),new Error("once called  more than once");t=!0,e.apply(this,n)})},n.toPromise=function(e){return n.getArguments(function(r){var o,i=this,s="function"==typeof r[r.length-1]?r.pop():!1;s&&(o=function(e,n){t.nextTick(function(){s(e,n)})});var a=new f(function(t,o){var s;try{var a=n.once(function(e,n){e?o(e):t(n)});r.push(a),s=e.apply(i,r),s&&"function"==typeof s.then&&t(s)}catch(u){o(u)}});return o&&a.then(function(e){o(null,e)},o),a.cancel=function(){return this},a})},n.adapterFun=function(e,t){return n.toPromise(n.getArguments(function(r){if(this._closed)return f.reject(new Error("database is closed"));var o=this;return this.taskqueue.isReady?t.apply(this,r):new n.Promise(function(t,n){o.taskqueue.addTask(function(i){i?n(i):t(o[e].apply(o,r))})})}))},n.arrayBufferToBinaryString=function(e){for(var t="",n=new Uint8Array(e),r=n.byteLength,o=0;r>o;o++)t+=String.fromCharCode(n[o]);return t},n.cancellableFun=function(e,t,r){r=r?n.clone(!0,{},r):{};var o=new l,i=r.complete||function(){},s=r.complete=n.once(function(e,t){e?i(e):(o.emit("end",t),i(null,t)),o.removeAllListeners()}),a=r.onChange||function(){},u=0;t.on("destroyed",function(){o.removeAllListeners()}),r.onChange=function(e){a(e),e.seq<=u||(u=e.seq,o.emit("change",e),e.deleted?o.emit("delete",e):1===e.changes.length&&"1-"===e.changes[0].rev.slice(0,1)?o.emit("create",e):o.emit("update",e))};var c=new f(function(e,t){r.complete=function(n,r){n?t(n):e(r)}});return c.then(function(e){s(null,e)},s),c.cancel=function(){c.isCancelled=!0,t.taskqueue.isReady&&r.complete(null,{status:"cancelled"})},t.taskqueue.isReady?e(t,r,c):t.taskqueue.addTask(function(){c.isCancelled?r.complete(null,{status:"cancelled"}):e(t,r,c)}),c.on=o.on.bind(o),c.once=o.once.bind(o),c.addListener=o.addListener.bind(o),c.removeListener=o.removeListener.bind(o),c.removeAllListeners=o.removeAllListeners.bind(o),c.setMaxListeners=o.setMaxListeners.bind(o),c.listeners=o.listeners.bind(o),c.emit=o.emit.bind(o),c},n.MD5=n.toPromise(e("./deps/md5"))}).call(this,e("/Users/nolan/workspace/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./deps/ajax":8,"./deps/blob":9,"./deps/buffer":26,"./deps/collections":10,"./deps/errors":11,"./deps/md5":12,"./deps/uuid":14,"./merge":18,"/Users/nolan/workspace/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":28,argsarray:25,bluebird:33,events:27,inherits:29,"pouchdb-extend":47}],24:[function(e,t){t.exports="3.0.5"},{}],25:[function(e,t){"use strict";function n(e){return function(){var t=arguments.length;if(t){for(var n=[],r=-1;++r<t;)n[r]=arguments[r];return e.call(this,n)}return e.call(this,[])}}t.exports=n},{}],26:[function(){},{}],27:[function(e,t){function n(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function r(e){return"function"==typeof e}function o(e){return"number"==typeof e}function i(e){return"object"==typeof e&&null!==e}function s(e){return void 0===e}t.exports=n,n.EventEmitter=n,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(e){if(!o(e)||0>e||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},n.prototype.emit=function(e){var t,n,o,a,u,c;if(this._events||(this._events={}),"error"===e&&(!this._events.error||i(this._events.error)&&!this._events.error.length)){if(t=arguments[1],t instanceof Error)throw t;throw TypeError('Uncaught, unspecified "error" event.')}if(n=this._events[e],s(n))return!1;if(r(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:for(o=arguments.length,a=new Array(o-1),u=1;o>u;u++)a[u-1]=arguments[u];n.apply(this,a)}else if(i(n)){for(o=arguments.length,a=new Array(o-1),u=1;o>u;u++)a[u-1]=arguments[u];for(c=n.slice(),o=c.length,u=0;o>u;u++)c[u].apply(this,a)}return!0},n.prototype.addListener=function(e,t){var o;if(!r(t))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,r(t.listener)?t.listener:t),this._events[e]?i(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,i(this._events[e])&&!this._events[e].warned){var o;o=s(this._maxListeners)?n.defaultMaxListeners:this._maxListeners,o&&o>0&&this._events[e].length>o&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace())}return this},n.prototype.on=n.prototype.addListener,n.prototype.once=function(e,t){function n(){this.removeListener(e,n),o||(o=!0,t.apply(this,arguments))}if(!r(t))throw TypeError("listener must be a function");var o=!1;return n.listener=t,this.on(e,n),this},n.prototype.removeListener=function(e,t){var n,o,s,a;if(!r(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(n=this._events[e],s=n.length,o=-1,n===t||r(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(i(n)){for(a=s;a-->0;)if(n[a]===t||n[a].listener&&n[a].listener===t){o=a;break}if(0>o)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(o,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},n.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(n=this._events[e],r(n))this.removeListener(e,n);else for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},n.prototype.listeners=function(e){var t;return t=this._events&&this._events[e]?r(this._events[e])?[this._events[e]]:this._events[e].slice():[]},n.listenerCount=function(e,t){var n;return n=e._events&&e._events[t]?r(e._events[t])?1:e._events[t].length:0}},{}],28:[function(e,t){var n=t.exports={};n.nextTick=function(){var e="undefined"!=typeof window&&window.setImmediate,t="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(e)return function(e){return window.setImmediate(e)};if(t){var n=[];return window.addEventListener("message",function(e){var t=e.source;if((t===window||null===t)&&"process-tick"===e.data&&(e.stopPropagation(),n.length>0)){var r=n.shift();r()}},!0),function(e){n.push(e),window.postMessage("process-tick","*")}}return function(e){setTimeout(e,0)}}(),n.title="browser",n.browser=!0,n.env={},n.argv=[],n.binding=function(){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(){throw new Error("process.chdir is not supported")}},{}],29:[function(e,t){t.exports="function"==typeof Object.create?function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:function(e,t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}},{}],30:[function(e,t){"use strict";function n(){}t.exports=n},{}],31:[function(e,t){"use strict";var n=e("./promise"),r=e("./reject"),o=e("./resolve"),i=e("./INTERNAL"),s=e("./handlers"),a=r(new TypeError("must be an array"));t.exports=function(e){function t(e,t){function n(e){c[t]=e,++l===r&!u&&(u=!0,s.resolve(f,c))}o(e).then(n,function(e){u||(u=!0,s.reject(f,e))})}if("[object Array]"!==Object.prototype.toString.call(e))return a;var r=e.length,u=!1;if(!r)return o([]);for(var c=new Array(r),l=0,d=-1,f=new n(i);++d<r;)t(e[d],d);return f}},{"./INTERNAL":30,"./handlers":32,"./promise":34,"./reject":36,"./resolve":37}],32:[function(e,t,n){"use strict";function r(e){var t=e&&e.then;return e&&"object"==typeof e&&"function"==typeof t?function(){t.apply(e,arguments)}:void 0}var o=e("./tryCatch"),i=e("./resolveThenable"),s=e("./states");
n.resolve=function(e,t){var a=o(r,t);if("error"===a.status)return n.reject(e,a.value);var u=a.value;if(u)i.safely(e,u);else{e.state=s.FULFILLED,e.outcome=t;for(var c=-1,l=e.queue.length;++c<l;)e.queue[c].callFulfilled(t)}return e},n.reject=function(e,t){e.state=s.REJECTED,e.outcome=t;for(var n=-1,r=e.queue.length;++n<r;)e.queue[n].callRejected(t);return e}},{"./resolveThenable":38,"./states":39,"./tryCatch":40}],33:[function(e,t,n){t.exports=n=e("./promise"),n.resolve=e("./resolve"),n.reject=e("./reject"),n.all=e("./all")},{"./all":31,"./promise":34,"./reject":36,"./resolve":37}],34:[function(e,t){"use strict";function n(e){if(!(this instanceof n))return new n(e);if("function"!=typeof e)throw new TypeError("reslover must be a function");this.state=s.PENDING,this.queue=[],this.outcome=void 0,e!==o&&i.safely(this,e)}var r=e("./unwrap"),o=e("./INTERNAL"),i=e("./resolveThenable"),s=e("./states"),a=e("./queueItem");t.exports=n,n.prototype["catch"]=function(e){return this.then(null,e)},n.prototype.then=function(e,t){if("function"!=typeof e&&this.state===s.FULFILLED||"function"!=typeof t&&this.state===s.REJECTED)return this;var i=new n(o);if(this.state!==s.PENDING){var u=this.state===s.FULFILLED?e:t;r(i,u,this.outcome)}else this.queue.push(new a(i,e,t));return i}},{"./INTERNAL":30,"./queueItem":35,"./resolveThenable":38,"./states":39,"./unwrap":41}],35:[function(e,t){"use strict";function n(e,t,n){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}var r=e("./handlers"),o=e("./unwrap");t.exports=n,n.prototype.callFulfilled=function(e){r.resolve(this.promise,e)},n.prototype.otherCallFulfilled=function(e){o(this.promise,this.onFulfilled,e)},n.prototype.callRejected=function(e){r.reject(this.promise,e)},n.prototype.otherCallRejected=function(e){o(this.promise,this.onRejected,e)}},{"./handlers":32,"./unwrap":41}],36:[function(e,t){"use strict";function n(e){var t=new r(o);return i.reject(t,e)}var r=e("./promise"),o=e("./INTERNAL"),i=e("./handlers");t.exports=n},{"./INTERNAL":30,"./handlers":32,"./promise":34}],37:[function(e,t){"use strict";function n(e){if(e)return e instanceof r?e:i.resolve(new r(o),e);var t=typeof e;switch(t){case"boolean":return s;case"undefined":return u;case"object":return a;case"number":return c;case"string":return l}}var r=e("./promise"),o=e("./INTERNAL"),i=e("./handlers");t.exports=n;var s=i.resolve(new r(o),!1),a=i.resolve(new r(o),null),u=i.resolve(new r(o),void 0),c=i.resolve(new r(o),0),l=i.resolve(new r(o),"")},{"./INTERNAL":30,"./handlers":32,"./promise":34}],38:[function(e,t,n){"use strict";function r(e,t){function n(t){a||(a=!0,o.reject(e,t))}function r(t){a||(a=!0,o.resolve(e,t))}function s(){t(r,n)}var a=!1,u=i(s);"error"===u.status&&n(u.value)}var o=e("./handlers"),i=e("./tryCatch");n.safely=r},{"./handlers":32,"./tryCatch":40}],39:[function(e,t,n){n.REJECTED=["REJECTED"],n.FULFILLED=["FULFILLED"],n.PENDING=["PENDING"]},{}],40:[function(e,t){"use strict";function n(e,t){var n={};try{n.value=e(t),n.status="success"}catch(r){n.status="error",n.value=r}return n}t.exports=n},{}],41:[function(e,t){"use strict";function n(e,t,n){r(function(){var r;try{r=t(n)}catch(i){return o.reject(e,i)}r===e?o.reject(e,new TypeError("Cannot resolve promise with itself")):o.resolve(e,r)})}var r=e("immediate"),o=e("./handlers");t.exports=n},{"./handlers":32,immediate:42}],42:[function(e,t){"use strict";function n(){o=!0;for(var e,t,n=a.length;n;){for(t=a,a=[],e=-1;++e<n;)t[e]();n=a.length}o=!1}function r(e){1!==a.push(e)||o||i()}for(var o,i,s=[e("./nextTick"),e("./mutation.js"),e("./messageChannel"),e("./stateChange"),e("./timeout")],a=[],u=-1,c=s.length;++u<c;)if(s[u]&&s[u].test&&s[u].test()){i=s[u].install(n);break}t.exports=r},{"./messageChannel":43,"./mutation.js":44,"./nextTick":26,"./stateChange":45,"./timeout":46}],43:[function(e,t,n){(function(e){"use strict";n.test=function(){return e.setImmediate?!1:"undefined"!=typeof e.MessageChannel},n.install=function(t){var n=new e.MessageChannel;return n.port1.onmessage=t,function(){n.port2.postMessage(0)}}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],44:[function(e,t,n){(function(e){"use strict";var t=e.MutationObserver||e.WebKitMutationObserver;n.test=function(){return t},n.install=function(n){var r=0,o=new t(n),i=e.document.createTextNode("");return o.observe(i,{characterData:!0}),function(){i.data=r=++r%2}}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],45:[function(e,t,n){(function(e){"use strict";n.test=function(){return"document"in e&&"onreadystatechange"in e.document.createElement("script")},n.install=function(t){return function(){var n=e.document.createElement("script");return n.onreadystatechange=function(){t(),n.onreadystatechange=null,n.parentNode.removeChild(n),n=null},e.document.documentElement.appendChild(n),t}}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],46:[function(e,t,n){"use strict";n.test=function(){return!0},n.install=function(e){return function(){setTimeout(e,0)}}},{}],47:[function(e,t){"use strict";function n(e){return null===e?String(e):"object"==typeof e||"function"==typeof e?u[f.call(e)]||"object":typeof e}function r(e){return null!==e&&e===e.window}function o(e){if(!e||"object"!==n(e)||e.nodeType||r(e))return!1;try{if(e.constructor&&!p.call(e,"constructor")&&!p.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(t){return!1}var o;for(o in e);return void 0===o||p.call(e,o)}function i(e){return"function"===n(e)}function s(){for(var e=[],t=-1,n=arguments.length,r=new Array(n);++t<n;)r[t]=arguments[t];var o={};e.push({args:r,result:{container:o,key:"key"}});for(var i;i=e.pop();)a(e,i.args,i.result);return o.key}function a(e,t,n){var r,s,a,u,c,l,d,f=t[0]||{},p=1,v=t.length,m=!1,_=/\d+/;for("boolean"==typeof f&&(m=f,f=t[1]||{},p=2),"object"==typeof f||i(f)||(f={}),v===p&&(f=this,--p);v>p;p++)if(null!=(r=t[p])){d=h(r);for(s in r)if(!(s in Object.prototype)){if(d&&!_.test(s))continue;if(a=f[s],u=r[s],f===u)continue;m&&u&&(o(u)||(c=h(u)))?(c?(c=!1,l=a&&h(a)?a:[]):l=a&&o(a)?a:{},e.push({args:[m,l,u],result:{container:f,key:s}})):void 0!==u&&(h(r)&&i(u)||(f[s]=u))}}n.container[n.key]=f}for(var u={},c=["Boolean","Number","String","Function","Array","Date","RegExp","Object","Error"],l=0;l<c.length;l++){var d=c[l];u["[object "+d+"]"]=d.toLowerCase()}var f=u.toString,p=u.hasOwnProperty,h=Array.isArray||function(e){return"array"===n(e)};t.exports=s},{}],48:[function(e,t){"use strict";var n=e("./upsert"),r=e("./utils"),o=r.Promise;t.exports=function(e){var t=e.db,i=e.viewName,s=e.map,a=e.reduce,u=e.temporary,c=s.toString()+(a&&a.toString())+"undefined";if(!u&&t._cachedViews){var l=t._cachedViews[c];if(l)return o.resolve(l)}return t.info().then(function(e){function o(e){e.views=e.views||{};var t=i;-1===t.indexOf("/")&&(t=i+"/"+i);var n=e.views[t]=e.views[t]||{};if(!n[l])return n[l]=!0,e}var l=e.db_name+"-mrview-"+(u?"temp":r.MD5(c));return n(t,"_local/mrviews",o).then(function(){return t.registerDependentDatabase(l).then(function(e){var n=e.db;n.auto_compaction=!0;var r={name:l,db:n,sourceDB:t,adapter:t.adapter,mapFun:s,reduceFun:a};return r.db.get("_local/lastSeq")["catch"](function(e){if(404!==e.status)throw e}).then(function(e){return r.seq=e?e.seq:0,u||(t._cachedViews=t._cachedViews||{},t._cachedViews[c]=r,r.db.on("destroyed",function(){delete t._cachedViews[c]})),r})})})})}},{"./upsert":54,"./utils":55}],49:[function(_dereq_,module,exports){"use strict";module.exports=function(func,emit,sum,log,isArray,toJSON){return eval("'use strict'; ("+func.replace(/;\s*$/,"")+");")}},{}],50:[function(e,t,n){(function(t){"use strict";function r(e){return-1===e.indexOf("/")?[e,e]:e.split("/")}function o(e,t,n){try{return{output:t.apply(null,n)}}catch(r){return e.emit("error",r),{error:r}}}function i(e,t){var n=S(e.key,t.key);return 0!==n?n:S(e.value,t.value)}function s(e,t,n){return n=n||0,"number"==typeof t?e.slice(n,t+n):n>0?e.slice(n):e}function a(e){var t=new Error("builtin "+e+" function requires map values to be numbers or number arrays");return t.name="invalid_value",t.status=500,t}function u(e){for(var t=0,n=0,r=e.length;r>n;n++){var o=e[n];if("number"!=typeof o){if(!Array.isArray(o))throw a("_sum");t="number"==typeof t?[t]:t;for(var i=0,s=o.length;s>i;i++){var u=o[i];if("number"!=typeof u)throw a("_sum");"undefined"==typeof t[i]?t.push(u):t[i]+=u}}else"number"==typeof t?t+=o:t[0]+=o}return t}function c(e,t,n,r){var o=t[e];"undefined"!=typeof o&&(r&&(o=encodeURIComponent(JSON.stringify(o))),n.push(e+"="+o))}function l(e,t){var n=e.descending?"endkey":"startkey",r=e.descending?"startkey":"endkey";if("undefined"!=typeof e[n]&&"undefined"!=typeof e[r]&&S(e[n],e[r])>0)throw new y("No rows can match your key range, reverse your start_key and end_key or set {descending : true}");if(t.reduce&&e.reduce!==!1){if(e.include_docs)throw new y("{include_docs:true} is invalid for reduce");if(e.keys&&e.keys.length>1&&!e.group&&!e.group_level)throw new y("Multi-key fetches for reduce views must use {group: true}")}if(e.group_level){if("number"!=typeof e.group_level)throw new y('Invalid value for integer: "'+e.group_level+'"');if(e.group_level<0)throw new y('Invalid value for positive integer: "'+e.group_level+'"')}}function d(e,t,n){var o,i=[],s="GET";if(c("reduce",n,i),c("include_docs",n,i),c("limit",n,i),c("descending",n,i),c("group",n,i),c("group_level",n,i),c("skip",n,i),c("stale",n,i),c("startkey",n,i,!0),c("endkey",n,i,!0),c("inclusive_end",n,i),c("key",n,i,!0),i=i.join("&"),i=""===i?"":"?"+i,"undefined"!=typeof n.keys){var a=2e3,u="keys="+encodeURIComponent(JSON.stringify(n.keys));u.length+i.length+1<=a?i+=("?"===i[0]?"&":"?")+u:(s="POST","string"==typeof t?o=JSON.stringify({keys:n.keys}):t.keys=n.keys)}if("string"==typeof t){var l=r(t);return e.request({method:s,url:"_design/"+l[0]+"/_view/"+l[1]+i,body:o})}return o=o||{},Object.keys(t).forEach(function(e){o[e]=Array.isArray(t[e])?t[e]:t[e].toString()}),e.request({method:"POST",url:"_temp_view"+i,body:o})}function f(e){return function(t){if(404===t.status)return e;throw t}}function p(e,t,n){var r="_local/doc_"+e;return t.db.get(r)["catch"](f({_id:r,keys:[]})).then(function(r){return O.resolve().then(function(){return r.keys.length?t.db.allDocs({keys:r.keys,include_docs:!0}):{rows:[]}}).then(function(t){var o=t.rows.map(function(e){return e.doc}).filter(function(e){return e}),i=n[e],s={};o.forEach(function(e){if(s[e._id]=!0,e._deleted=!i[e._id],!e._deleted){var t=i[e._id];"value"in t&&(e.value=t.value)}});var a=Object.keys(i);return a.forEach(function(e){if(!s[e]){var t={_id:e},n=i[e];"value"in n&&(t.value=n.value),o.push(t)}}),r.keys=A.uniq(a.concat(r.keys)),o.splice(0,0,r),o})})}function h(e,t,n){var r="_local/lastSeq";return e.db.get(r)["catch"](f({_id:r,seq:0})).then(function(r){var o=Object.keys(t);return O.all(o.map(function(n){return p(n,e,t)})).then(function(t){var o=[];return t.forEach(function(e){o=o.concat(e)}),r.seq=n,o.push(r),e.db.bulkDocs({docs:o})})})}function v(e,t,n){0===n.group_level&&delete n.group_level;var r,i=n.group||n.group_level;r=D[e.reduceFun]?D[e.reduceFun]:T(e.reduceFun.toString(),null,u,b,Array.isArray,JSON.parse);var a=[],c=n.group_level;t.forEach(function(e){var t=a[a.length-1],n=i?e.key:null;return i&&Array.isArray(n)&&"number"==typeof c&&(n=n.length>c?n.slice(0,c):n),t&&0===S(t.key[0][0],n)?(t.key.push([n,e.id]),void t.value.push(e.value)):void a.push({key:[[n,e.id]],value:[e.value]})});for(var l=0,d=a.length;d>l;l++){var f=a[l],p=o(e.sourceDB,r,[f.key,f.value,!1]);f.value=p.error?null:p.output,f.key=f.key[0][0]}return{rows:s(a,n.limit,n.skip)}}function m(e){return e.request({method:"POST",url:"_view_cleanup"})}function _(e,n,o){if("http"===e.type())return d(e,n,o);if("string"!=typeof n){l(o,n);var i={db:e,viewName:"temp_view/temp_view",map:n.map,reduce:n.reduce,temporary:!0};return R.add(function(){return q(i).then(function(e){function t(){return e.db.destroy()}return A.fin(C(e).then(function(){return N(e,o)}),t)})}),R.finish()}var s=n,a=r(s),u=a[0],c=a[1];return e.get("_design/"+u).then(function(n){var r=n.views&&n.views[c];if(!r||"string"!=typeof r.map)throw new g("ddoc "+u+" has no view named "+c);l(o,r);var i={db:e,viewName:s,map:r.map,reduce:r.reduce};return q(i).then(function(e){return"ok"===o.stale||"update_after"===o.stale?("update_after"===o.stale&&t.nextTick(function(){C(e)}),N(e,o)):C(e).then(function(){return N(e,o)})})})}function y(e){this.status=400,this.name="query_parse_error",this.message=e,this.error=!0;try{Error.captureStackTrace(this,y)}catch(t){}}function g(e){this.status=404,this.name="not_found",this.message=e,this.error=!0;try{Error.captureStackTrace(this,g)}catch(t){}}var b,w=e("pouchdb-collate"),E=e("./taskqueue"),S=w.collate,k=w.toIndexableString,x=w.normalizeKey,q=e("./create-view"),T=e("./evalfunc");b="undefined"!=typeof console&&"function"==typeof console.log?Function.prototype.bind.call(console.log,console):function(){};var A=e("./utils"),O=A.Promise,L=new E,R=new E,I=50,D={_sum:function(e,t){return u(t)},_count:function(e,t){return t.length},_stats:function(e,t){function n(e){for(var t=0,n=0,r=e.length;r>n;n++){var o=e[n];t+=o*o}return t}return{sum:u(t),min:Math.min.apply(null,t),max:Math.max.apply(null,t),count:t.length,sumsqr:n(t)}}},C=A.sequentialize(L,function(e){function t(e,t){var n={id:s._id,key:x(e)};"undefined"!=typeof t&&null!==t&&(n.value=x(t)),r.push(n)}function n(t,n){return function(){return h(e,t,n)}}var r,s,a;if("function"==typeof e.mapFun&&2===e.mapFun.length){var c=e.mapFun;a=function(e){return c(e,t)}}else a=T(e.mapFun.toString(),t,u,b,Array.isArray,JSON.parse);var l=e.seq||0,d=new E;return new O(function(t,u){function c(){d.finish().then(function(){e.seq=l,t()})}function f(){function t(e){u(e)}e.sourceDB.changes({conflicts:!0,include_docs:!0,since:l,limit:I}).on("complete",function(t){var u=t.results;if(!u.length)return c();for(var p={},h=0,v=u.length;v>h;h++){var m=u[h];if("_"!==m.doc._id[0]){r=[],s=m.doc,s._deleted||o(e.sourceDB,a,[s]),r.sort(i);for(var _,y={},g=0,b=r.length;b>g;g++){var w=r[g],E=[w.key,w.id];w.key===_&&E.push(g);var S=k(E);y[S]=w,_=w.key}p[m.doc._id]=y}l=m.seq}return d.add(n(p,l)),u.length<I?c():f()}).on("error",t)}f()})}),N=A.sequentialize(L,function(e,t){function n(t){return t.include_docs=!0,e.db.allDocs(t).then(function(e){return o=e.total_rows,e.rows.map(function(e){if("value"in e.doc&&"object"==typeof e.doc.value&&null!==e.doc.value){var t=Object.keys(e.doc.value).sort(),n=["id","key","value"];if(!(n>t||t>n))return e.doc.value}var r=w.parseIndexableString(e.doc._id);return{key:r[0],id:r[1],value:"value"in e.doc?e.doc.value:null}})})}function r(n){var r;if(r=i?v(e,n,t):{total_rows:o,offset:s,rows:n},t.include_docs){var a=n.map(function(t){var n=t.value,r=n&&"object"==typeof n&&n._id||t.id;return e.sourceDB.get(r).then(function(e){t.doc=e},function(){})});return O.all(a).then(function(){return r})}return r}var o,i=e.reduceFun&&t.reduce!==!1,s=t.skip||0;"undefined"==typeof t.keys||t.keys.length||(t.limit=0,delete t.keys);var a=function(e){return e.reduce(function(e,t){return e.concat(t)})};if("undefined"!=typeof t.keys){var u=t.keys,c=u.map(function(e){var t={startkey:k([e]),endkey:k([e,{}])};return n(t)});return O.all(c).then(a).then(r)}var l={descending:t.descending};if("undefined"!=typeof t.startkey&&(l.startkey=k(t.descending?[t.startkey,{}]:[t.startkey])),"undefined"!=typeof t.endkey){var d=t.inclusive_end!==!1;t.descending&&(d=!d),l.endkey=k(d?[t.endkey,{}]:[t.endkey])}if("undefined"!=typeof t.key){var f=k([t.key]),p=k([t.key,{}]);l.descending?(l.endkey=f,l.startkey=p):(l.startkey=f,l.endkey=p)}return i||("number"==typeof t.limit&&(l.limit=t.limit),l.skip=s),n(l).then(r)}),j=A.sequentialize(L,function(e){return e.get("_local/mrviews").then(function(t){var n={};Object.keys(t.views).forEach(function(e){var t=r(e),o="_design/"+t[0],i=t[1];n[o]=n[o]||{},n[o][i]=!0});var o={keys:Object.keys(n),include_docs:!0};return e.allDocs(o).then(function(r){var o={};r.rows.forEach(function(e){var r=e.key.substring(8);Object.keys(n[e.key]).forEach(function(n){var i=r+"/"+n;t.views[i]||(i=n);var s=Object.keys(t.views[i]),a=e.doc&&e.doc.views&&e.doc.views[n];s.forEach(function(e){o[e]=o[e]||a})})});var i=Object.keys(o).filter(function(e){return!o[e]}),s=i.map(function(t){return e.constructor.destroy(t,{adapter:e.adapter})});return O.all(s).then(function(){return{ok:!0}})})},f({ok:!0}))});n.viewCleanup=A.callbackify(function(){var e=this;return"http"===e.type()?m(e):j(e)}),n.query=function(e,t,n){"function"==typeof t&&(n=t,t={}),t=A.extend(!0,{},t),"function"==typeof e&&(e={map:e});var r=this,o=O.resolve().then(function(){return _(r,e,t)});return A.promisedCallback(o,n),o},A.inherits(y,Error),A.inherits(g,Error)}).call(this,e("/Users/nolan/workspace/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"))},{"./create-view":48,"./evalfunc":49,"./taskqueue":53,"./utils":55,"/Users/nolan/workspace/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":28,"pouchdb-collate":51}],51:[function(e,t,n){"use strict";function r(e){if(null!==e)switch(typeof e){case"boolean":return e?1:0;case"number":return l(e);case"string":return e.replace(/\u0002/g,"").replace(/\u0001/g,"").replace(/\u0000/g,"");case"object":var t=Array.isArray(e),r=t?e:Object.keys(e),o=-1,i=r.length,s="";if(t)for(;++o<i;)s+=n.toIndexableString(r[o]);else for(;++o<i;){var a=r[o];s+=n.toIndexableString(a)+n.toIndexableString(e[a])}return s}return""}function o(e,t){var n,r=t,o="1"===e[t];if(o)n=0,t++;else{var i="0"===e[t];t++;var s="",a=e.substring(t,t+f),u=parseInt(a,10)+d;for(i&&(u=-u),t+=f;;){var c=e[t];if("\x00"===c)break;s+=c,t++}s=s.split("."),n=1===s.length?parseInt(s,10):parseFloat(s[0]+"."+s[1]),i&&(n-=10),0!==u&&(n=parseFloat(n+"e"+u))}return{num:n,length:t-r}}function i(e,t){var n=e.pop();if(t.length){var r=t[t.length-1];n===r.element&&(t.pop(),r=t[t.length-1]);var o=r.element,i=r.index;if(Array.isArray(o))o.push(n);else if(i===e.length-2){var s=e.pop();o[s]=n}else e.push(n)}}function s(e,t){for(var r=Math.min(e.length,t.length),o=0;r>o;o++){var i=n.collate(e[o],t[o]);if(0!==i)return i}return e.length===t.length?0:e.length>t.length?1:-1}function a(e,t){return e===t?0:e>t?1:-1}function u(e,t){for(var r=Object.keys(e),o=Object.keys(t),i=Math.min(r.length,o.length),s=0;i>s;s++){var a=n.collate(r[s],o[s]);if(0!==a)return a;if(a=n.collate(e[r[s]],t[o[s]]),0!==a)return a}return r.length===o.length?0:r.length>o.length?1:-1}function c(e){var t=["boolean","number","string","object"],n=t.indexOf(typeof e);return~n?null===e?1:Array.isArray(e)?5:3>n?n+2:n+3:Array.isArray(e)?5:void 0}function l(e){if(0===e)return"1";var t=e.toExponential().split(/e\+?/),n=parseInt(t[1],10),r=0>e,o=r?"0":"2",i=(r?-n:n)-d,s=h.padLeft(i.toString(),"0",f);o+=p+s;var a=Math.abs(parseFloat(t[0]));r&&(a=10-a);var u=a.toFixed(20);return u=u.replace(/\.?0+$/,""),o+=p+u}var d=-324,f=3,p="",h=e("./utils");n.collate=function(e,t){if(e===t)return 0;e=n.normalizeKey(e),t=n.normalizeKey(t);var r=c(e),o=c(t);if(r-o!==0)return r-o;if(null===e)return 0;switch(typeof e){case"number":return e-t;case"boolean":return e===t?0:t>e?-1:1;case"string":return a(e,t)}return Array.isArray(e)?s(e,t):u(e,t)},n.normalizeKey=function(e){switch(typeof e){case"undefined":return null;case"number":return 1/0===e||e===-1/0||isNaN(e)?null:e;case"object":var t=e;if(Array.isArray(e)){var r=e.length;e=new Array(r);for(var o=0;r>o;o++)e[o]=n.normalizeKey(t[o])}else{if(e instanceof Date)return e.toJSON();if(null!==e){e={};for(var i in t)if(t.hasOwnProperty(i)){var s=t[i];"undefined"!=typeof s&&(e[i]=n.normalizeKey(s))}}}}return e},n.toIndexableString=function(e){var t="\x00";return e=n.normalizeKey(e),c(e)+p+r(e)+t},n.parseIndexableString=function(e){for(var t=[],n=[],r=0;;){var s=e[r++];if("\x00"!==s)switch(s){case"1":t.push(null);break;case"2":t.push("1"===e[r]),r++;break;case"3":var a=o(e,r);t.push(a.num),r+=a.length;break;case"4":for(var u="";;){var c=e[r];if("\x00"===c)break;u+=c,r++}u=u.replace(/\u0001\u0001/g,"\x00").replace(/\u0001\u0002/g,"").replace(/\u0002\u0002/g,""),t.push(u);break;case"5":var l={element:[],index:t.length};t.push(l.element),n.push(l);break;case"6":var d={element:{},index:t.length};t.push(d.element),n.push(d);break;default:throw new Error("bad collationIndex or unexpectedly reached end of input: "+s)}else{if(1===t.length)return t.pop();i(t,n)}}}},{"./utils":52}],52:[function(e,t,n){"use strict";function r(e,t,n){for(var r="",o=n-e.length;r.length<o;)r+=t;return r}n.padLeft=function(e,t,n){var o=r(e,t,n);return o+e},n.padRight=function(e,t,n){var o=r(e,t,n);return e+o},n.stringLexCompare=function(e,t){var n,r=e.length,o=t.length;for(n=0;r>n;n++){if(n===o)return 1;var i=e.charAt(n),s=t.charAt(n);if(i!==s)return s>i?-1:1}return o>r?-1:0},n.intToDecimalForm=function(e){var t=0>e,n="";do{var r=t?-Math.ceil(e%10):Math.floor(e%10);n=r+n,e=t?Math.ceil(e/10):Math.floor(e/10)}while(e);return t&&"0"!==n&&(n="-"+n),n}},{}],53:[function(e,t){"use strict";function n(){this.promise=new r(function(e){e()})}var r=e("./utils").Promise;n.prototype.add=function(e){return this.promise=this.promise["catch"](function(){}).then(function(){return e()}),this.promise},n.prototype.finish=function(){return this.promise},t.exports=n},{"./utils":55}],54:[function(e,t){"use strict";function n(e,t,n){return new o(function(o,i){return t&&"object"==typeof t&&(t=t._id),"string"!=typeof t?i(new Error("doc id is required")):void e.get(t,function(s,a){if(s)return 404!==s.status?i(s):o(r(e,n({_id:t}),n));var u=n(a);return u?void o(r(e,u,n)):o(a)})})}function r(e,t,r){return e.put(t)["catch"](function(o){if(409!==o.status)throw o;return n(e,t,r)})}var o=e("./utils").Promise;t.exports=n},{"./utils":55}],55:[function(e,t,n){(function(t,r){"use strict";n.Promise="function"==typeof r.Promise?r.Promise:e("lie"),n.uniq=function(e){var t={};return e.forEach(function(e){t[e]=!0}),Object.keys(t)},n.inherits=e("inherits"),n.extend=e("pouchdb-extend");var o=e("argsarray");n.promisedCallback=function(e,n){return n&&e.then(function(e){t.nextTick(function(){n(null,e)})},function(e){t.nextTick(function(){n(e)})}),e},n.callbackify=function(e){return o(function(t){var r=t.pop(),o=e.apply(this,t);return"function"==typeof r&&n.promisedCallback(o,r),o})},n.fin=function(e,t){return e.then(function(e){var n=t();return"function"==typeof n.then?n.then(function(){return e}):e},function(e){var n=t();if("function"==typeof n.then)return n.then(function(){throw e});throw e})},n.sequentialize=function(e,t){return function(){var n=arguments,r=this;return e.add(function(){return t.apply(r,n)})}};var i=e("crypto"),s=e("spark-md5");n.MD5=function(e){return t.browser?s.hash(e):i.createHash("md5").update(e).digest("hex")}}).call(this,e("/Users/nolan/workspace/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"/Users/nolan/workspace/pouchdb/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":28,argsarray:25,crypto:26,inherits:29,lie:33,"pouchdb-extend":47,"spark-md5":56}],56:[function(e,t,n){!function(e){if("object"==typeof n)t.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var r;try{r=window}catch(o){r=self}r.SparkMD5=e()}}(function(){"use strict";var e=function(e,t){return e+t&4294967295},t=function(t,n,r,o,i,s){return n=e(e(n,t),e(o,s)),e(n<<i|n>>>32-i,r)},n=function(e,n,r,o,i,s,a){return t(n&r|~n&o,e,n,i,s,a)},r=function(e,n,r,o,i,s,a){return t(n&o|r&~o,e,n,i,s,a)},o=function(e,n,r,o,i,s,a){return t(n^r^o,e,n,i,s,a)},i=function(e,n,r,o,i,s,a){return t(r^(n|~o),e,n,i,s,a)},s=function(t,s){var a=t[0],u=t[1],c=t[2],l=t[3];a=n(a,u,c,l,s[0],7,-680876936),l=n(l,a,u,c,s[1],12,-389564586),c=n(c,l,a,u,s[2],17,606105819),u=n(u,c,l,a,s[3],22,-1044525330),a=n(a,u,c,l,s[4],7,-176418897),l=n(l,a,u,c,s[5],12,1200080426),c=n(c,l,a,u,s[6],17,-1473231341),u=n(u,c,l,a,s[7],22,-45705983),a=n(a,u,c,l,s[8],7,1770035416),l=n(l,a,u,c,s[9],12,-1958414417),c=n(c,l,a,u,s[10],17,-42063),u=n(u,c,l,a,s[11],22,-1990404162),a=n(a,u,c,l,s[12],7,1804603682),l=n(l,a,u,c,s[13],12,-40341101),c=n(c,l,a,u,s[14],17,-1502002290),u=n(u,c,l,a,s[15],22,1236535329),a=r(a,u,c,l,s[1],5,-165796510),l=r(l,a,u,c,s[6],9,-1069501632),c=r(c,l,a,u,s[11],14,643717713),u=r(u,c,l,a,s[0],20,-373897302),a=r(a,u,c,l,s[5],5,-701558691),l=r(l,a,u,c,s[10],9,38016083),c=r(c,l,a,u,s[15],14,-660478335),u=r(u,c,l,a,s[4],20,-405537848),a=r(a,u,c,l,s[9],5,568446438),l=r(l,a,u,c,s[14],9,-1019803690),c=r(c,l,a,u,s[3],14,-187363961),u=r(u,c,l,a,s[8],20,1163531501),a=r(a,u,c,l,s[13],5,-1444681467),l=r(l,a,u,c,s[2],9,-51403784),c=r(c,l,a,u,s[7],14,1735328473),u=r(u,c,l,a,s[12],20,-1926607734),a=o(a,u,c,l,s[5],4,-378558),l=o(l,a,u,c,s[8],11,-2022574463),c=o(c,l,a,u,s[11],16,1839030562),u=o(u,c,l,a,s[14],23,-35309556),a=o(a,u,c,l,s[1],4,-1530992060),l=o(l,a,u,c,s[4],11,1272893353),c=o(c,l,a,u,s[7],16,-155497632),u=o(u,c,l,a,s[10],23,-1094730640),a=o(a,u,c,l,s[13],4,681279174),l=o(l,a,u,c,s[0],11,-358537222),c=o(c,l,a,u,s[3],16,-722521979),u=o(u,c,l,a,s[6],23,76029189),a=o(a,u,c,l,s[9],4,-640364487),l=o(l,a,u,c,s[12],11,-421815835),c=o(c,l,a,u,s[15],16,530742520),u=o(u,c,l,a,s[2],23,-995338651),a=i(a,u,c,l,s[0],6,-198630844),l=i(l,a,u,c,s[7],10,1126891415),c=i(c,l,a,u,s[14],15,-1416354905),u=i(u,c,l,a,s[5],21,-57434055),a=i(a,u,c,l,s[12],6,1700485571),l=i(l,a,u,c,s[3],10,-1894986606),c=i(c,l,a,u,s[10],15,-1051523),u=i(u,c,l,a,s[1],21,-2054922799),a=i(a,u,c,l,s[8],6,1873313359),l=i(l,a,u,c,s[15],10,-30611744),c=i(c,l,a,u,s[6],15,-1560198380),u=i(u,c,l,a,s[13],21,1309151649),a=i(a,u,c,l,s[4],6,-145523070),l=i(l,a,u,c,s[11],10,-1120210379),c=i(c,l,a,u,s[2],15,718787259),u=i(u,c,l,a,s[9],21,-343485551),t[0]=e(a,t[0]),t[1]=e(u,t[1]),t[2]=e(c,t[2]),t[3]=e(l,t[3])},a=function(e){var t,n=[];for(t=0;64>t;t+=4)n[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return n},u=function(e){var t,n=[];for(t=0;64>t;t+=4)n[t>>2]=e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24);return n},c=function(e){var t,n,r,o,i,u,c=e.length,l=[1732584193,-271733879,-1732584194,271733878];for(t=64;c>=t;t+=64)s(l,a(e.substring(t-64,t)));for(e=e.substring(t-64),n=e.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;n>t;t+=1)r[t>>2]|=e.charCodeAt(t)<<(t%4<<3);if(r[t>>2]|=128<<(t%4<<3),t>55)for(s(l,r),t=0;16>t;t+=1)r[t]=0;return o=8*c,o=o.toString(16).match(/(.*?)(.{0,8})$/),i=parseInt(o[2],16),u=parseInt(o[1],16)||0,r[14]=i,r[15]=u,s(l,r),l},l=function(e){var t,n,r,o,i,a,c=e.length,l=[1732584193,-271733879,-1732584194,271733878];for(t=64;c>=t;t+=64)s(l,u(e.subarray(t-64,t)));for(e=c>t-64?e.subarray(t-64):new Uint8Array(0),n=e.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;n>t;t+=1)r[t>>2]|=e[t]<<(t%4<<3);if(r[t>>2]|=128<<(t%4<<3),t>55)for(s(l,r),t=0;16>t;t+=1)r[t]=0;return o=8*c,o=o.toString(16).match(/(.*?)(.{0,8})$/),i=parseInt(o[2],16),a=parseInt(o[1],16)||0,r[14]=i,r[15]=a,s(l,r),l},d=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],f=function(e){var t,n="";for(t=0;4>t;t+=1)n+=d[e>>8*t+4&15]+d[e>>8*t&15];return n},p=function(e){var t;for(t=0;t<e.length;t+=1)e[t]=f(e[t]);return e.join("")},h=function(e){return p(c(e))},v=function(){this.reset()};return"5d41402abc4b2a76b9719d911017c592"!==h("hello")&&(e=function(e,t){var n=(65535&e)+(65535&t),r=(e>>16)+(t>>16)+(n>>16);return r<<16|65535&n}),v.prototype.append=function(e){return/[\u0080-\uFFFF]/.test(e)&&(e=unescape(encodeURIComponent(e))),this.appendBinary(e),this},v.prototype.appendBinary=function(e){this._buff+=e,this._length+=e.length;var t,n=this._buff.length;for(t=64;n>=t;t+=64)s(this._state,a(this._buff.substring(t-64,t)));return this._buff=this._buff.substr(t-64),this},v.prototype.end=function(e){var t,n,r=this._buff,o=r.length,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;o>t;t+=1)i[t>>2]|=r.charCodeAt(t)<<(t%4<<3);return this._finish(i,o),n=e?this._state:p(this._state),this.reset(),n},v.prototype._finish=function(e,t){var n,r,o,i=t;if(e[i>>2]|=128<<(i%4<<3),i>55)for(s(this._state,e),i=0;16>i;i+=1)e[i]=0;n=8*this._length,n=n.toString(16).match(/(.*?)(.{0,8})$/),r=parseInt(n[2],16),o=parseInt(n[1],16)||0,e[14]=r,e[15]=o,s(this._state,e)},v.prototype.reset=function(){return this._buff="",this._length=0,this._state=[1732584193,-271733879,-1732584194,271733878],this},v.prototype.destroy=function(){delete this._state,delete this._buff,delete this._length},v.hash=function(e,t){/[\u0080-\uFFFF]/.test(e)&&(e=unescape(encodeURIComponent(e)));var n=c(e);return t?n:p(n)},v.hashBinary=function(e,t){var n=c(e);return t?n:p(n)},v.ArrayBuffer=function(){this.reset()},v.ArrayBuffer.prototype.append=function(e){var t,n=this._concatArrayBuffer(this._buff,e),r=n.length;for(this._length+=e.byteLength,t=64;r>=t;t+=64)s(this._state,u(n.subarray(t-64,t)));return this._buff=r>t-64?n.subarray(t-64):new Uint8Array(0),this},v.ArrayBuffer.prototype.end=function(e){var t,n,r=this._buff,o=r.length,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;o>t;t+=1)i[t>>2]|=r[t]<<(t%4<<3);return this._finish(i,o),n=e?this._state:p(this._state),this.reset(),n},v.ArrayBuffer.prototype._finish=v.prototype._finish,v.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._state=[1732584193,-271733879,-1732584194,271733878],this},v.ArrayBuffer.prototype.destroy=v.prototype.destroy,v.ArrayBuffer.prototype._concatArrayBuffer=function(e,t){var n=e.length,r=new Uint8Array(n+t.byteLength);return r.set(e),r.set(new Uint8Array(t),n),r},v.ArrayBuffer.hash=function(e,t){var n=l(new Uint8Array(e));return t?n:p(n)},v})},{}],57:[function(e,t,n){"use strict";function r(e,t,n){var r=n[n.length-1];e===r.element&&(n.pop(),r=n[n.length-1]);var o=r.element,i=r.index;if(Array.isArray(o))o.push(e);else if(i===t.length-2){var s=t.pop();o[s]=e}else t.push(e)}n.stringify=function(e){var t=[];t.push({obj:e});for(var n,r,o,i,s,a,u,c,l,d,f,p="";n=t.pop();)if(r=n.obj,o=n.prefix||"",i=n.val||"",p+=o,i)p+=i;else if("object"!=typeof r)p+="undefined"==typeof r?null:JSON.stringify(r);else if(null===r)p+="null";else if(Array.isArray(r)){for(t.push({val:"]"}),s=r.length-1;s>=0;s--)a=0===s?"":",",t.push({obj:r[s],prefix:a});t.push({val:"["})}else{u=[];for(c in r)r.hasOwnProperty(c)&&u.push(c);for(t.push({val:"}"}),s=u.length-1;s>=0;s--)l=u[s],d=r[l],f=s>0?",":"",f+=JSON.stringify(l)+":",t.push({obj:d,prefix:f});t.push({val:"{"})}return p},n.parse=function(e){for(var t,n,o,i,s,a,u,c,l,d=[],f=[],p=0;;)if(t=e[p++],"}"!==t&&"]"!==t&&"undefined"!=typeof t)switch(t){case" ":case"	":case"\n":case":":case",":break;case"n":p+=3,r(null,d,f);break;case"t":p+=3,r(!0,d,f);break;case"f":p+=4,r(!1,d,f);break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"-":for(n="",p--;;){if(o=e[p++],!/[\d\.\-e\+]/.test(o)){p--;break}n+=o}r(parseFloat(n),d,f);break;case'"':for(i="",s=void 0,a=0;;){if(u=e[p++],'"'===u&&("\\"!==s||a%2!==1))break;i+=u,s=u,"\\"===s?a++:a=0}r(JSON.parse('"'+i+'"'),d,f);break;case"[":c={element:[],index:d.length},d.push(c.element),f.push(c);break;case"{":l={element:{},index:d.length},d.push(l.element),f.push(l);break;default:throw new Error("unexpectedly reached end of input: "+t)}else{if(1===d.length)return d.pop();r(d.pop(),d,f)}}},{}]},{},[17])(17)});
TP.boot.$srcPath = '';

        
        TP.extern.PouchDB = PouchDB;
        
    
TP.boot.$srcPath = '~lib_src/tibet/storage/pouchdb/TP.sig.PouchDBRequest.js';
TP.sig.IORequest.defineSubtype('PouchDBRequest');TP.sig.PouchDBRequest.Type.defineAttribute('responseType','TP.sig.PouchDBResponse');
TP.boot.$srcPath = '~lib_src/tibet/storage/pouchdb/TP.sig.PouchDBResponse.js';
TP.sig.IOResponse.defineSubtype('PouchDBResponse');
TP.boot.$srcPath = '~lib_src/tibet/storage/pouchdb/TP.core.PouchDBService.js';
TP.core.IOService.defineSubtype('PouchDBService');TP.core.PouchDBService.Type.defineAttribute('triggerSignals','TP.sig.PouchDBRequest');TP.core.PouchDBService.Type.defineAttribute('supportedModes',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.PouchDBService.Type.defineAttribute('mode',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.PouchDBService.register();TP.core.PouchDBService.Inst.defineMethod('handlePouchDBRequest',function(j){var a,e,c,f,b,h,i,d,g;a=TP.request(j);a.atPut('async',this.rewriteRequestMode(a));c=a.at('id');f=a.at('rev');b=a.at('dbName');h=a.at('body');if(TP.notValid(e=new TP.extern.PouchDB(b))){a.fail(TP.FAILURE,TP.sc('Cannot open pouchDB database named: '+b));return this;}switch(a.at('action')){case'deleteDB':PouchDB.destroy(b,function(c,d){if(TP.isValid(c)){return a.fail(TP.FAILURE,TP.sc('Trying to delete database:',b,' but had an error: ',TP.str(c)));}a.complete(TP.json2js(TP.js2json(d)));});break;case'deleteItem':if(TP.notEmpty(f)){i=TP.hc('_id',c,'_rev',f).asObject();}else{i=c;}e.get(i,function(g,f){var d;if(TP.isValid(g)){return a.fail(TP.FAILURE,TP.sc('Trying to delete item with id: ',c,' from database:',b,' but had an error: ',TP.str(g)));}if(TP.notValid(f)||TP.notValid(f._rev)){return a.fail(TP.FAILURE,TP.sc('There is no existing item with id: ',c,' in database:',b,'.'));}d=TP.hc('_id',c,'_rev',f._rev);d=d.asObject();e.remove(d,function(d,e){if(TP.isValid(d)){return a.fail(TP.FAILURE,TP.sc('Trying to delete item with id: ',c,' from database:',b,' but had an error: ',TP.str(d)));}a.complete(TP.json2js(TP.js2json(e)));});});break;case'retrieveItem':if(TP.isEmpty(c)){return a.fail(TP.FAILURE,TP.sc('Trying to retrieve an item from the',' database:',b,' but had missing the unique id.'));}e.get(c,function(c,d){if(TP.isValid(c)){return a.fail(TP.FAILURE,TP.sc('Trying to retrieve an item from database:',b,' but had an error: ',TP.str(c)));}a.complete(TP.json2js(TP.js2json(d)));});break;case'retrieveItemInfo':if(TP.isEmpty(c)){return a.fail(TP.FAILURE,TP.sc('Trying to retrieve item info from the',' database:',b,' but had missing the unique id.'));}e.get(c,function(d,e){var c;if(TP.isValid(d)){return a.fail(TP.FAILURE,TP.sc('Trying to retrieve item info from database:',b,' but had an error: ',TP.str(d)));}c=TP.json2js(TP.js2json(e));c=TP.hc('_id',c.at('_id'),'date_created',c.at('date_created'),'date_modified',c.at('date_modified'));a.complete(c);});break;case'retrieveDBInfo':e.allDocs(function(c,d){if(TP.isValid(c)){return a.fail(TP.FAILURE,TP.sc('Trying to retrieve information about the',' database:',b,' but had an error: ',TP.str(c)));}a.complete(TP.json2js(TP.js2json(d)));});break;case'createItem':d=h.asHash();g=TP.dc();d.atPut('date_created',g);d.atPut('date_modified',g);if(TP.isEmpty(c)){d=d.asObject();e.post(d,function(c,d){if(TP.isValid(c)){return a.fail(TP.FAILURE,TP.sc('Trying to create an item in the',' database:',b,' but had an error: ',TP.str(c)));}a.complete(TP.json2js(TP.js2json(d)));});}else{d.atPut('_id',c);d=d.asObject();e.get(c,function(f,g){if(TP.isValid(f)&&f.status!==404){return a.fail(TP.FAILURE,TP.sc('Trying to create an item in the',' database:',b,' but had an error: ',TP.str(f)));}if(TP.isValid(g)&&TP.isValid(g._rev)){return a.fail(TP.FAILURE,TP.sc('Already had item with id: ',c,' in database:',b,'.'));}e.put(d,function(c,d){if(TP.isValid(c)){return a.fail(TP.FAILURE,TP.sc('Trying to create an item in the',' database:',b,' but had an error: ',TP.str(c)));}a.complete(TP.json2js(TP.js2json(d)));});});}break;case'updateItem':if(TP.isEmpty(c)){return a.fail(TP.FAILURE,TP.sc('Trying to update an item in the',' database:',b,' but had missing the unique id.'));}else{d=h.asHash();d.atPut('_id',c);e.get(c,function(g,f){if(TP.isValid(g)){return a.fail(TP.FAILURE,TP.sc('Trying to update an item in the',' database:',b,' but had an error: ',TP.str(g)));}if(TP.notValid(f)||TP.notValid(f._rev)){return a.fail(TP.FAILURE,TP.sc('There is no existing item with id: ',c,' in database:',b,'.'));}d.atPut('_rev',f._rev);d.atPut('date_modified',TP.dc());d=d.asObject();e.put(d,function(c,d){if(TP.isValid(c)){return a.fail(TP.FAILURE,TP.sc('Trying to create an item in the',' database:',b,' but had an error: ',TP.str(c)));}a.complete(TP.json2js(TP.js2json(d)));});});}break;default:break;}return this;});
TP.boot.$srcPath = '~lib_src/tibet/storage/pouchdb/TP.core.PouchDBURL.js';
TP.core.URL.defineSubtype('TP.core.PouchDBURL');TP.core.PouchDBURL.Type.defineConstant('POUCHDB_REGEX',TP.rc('^pouchdb://([^/]+)(/([^?]+)(\\??(\\S*))?)?'));TP.core.PouchDBURL.Type.defineConstant('SCHEME','pouchdb');TP.core.PouchDBURL.Type.defineAttribute('supportedModes',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.PouchDBURL.Type.defineAttribute('mode',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.PouchDBURL.registerForScheme('pouchdb');TP.core.PouchDBURL.Inst.defineAttribute('query');TP.core.PouchDBURL.Inst.defineAttribute('queryDict');TP.core.PouchDBURL.Inst.defineAttribute('dbName');TP.core.PouchDBURL.Inst.defineAttribute('resourceID');TP.core.PouchDBURL.Inst.defineAttribute('$lastAdded');TP.core.PouchDBURL.Type.defineMethod('$getDefaultHandler',function(a,b){return TP.core.PouchDBURLHandler;});TP.core.PouchDBURL.Inst.defineMethod('init',function(c){var a,d,e,b,f;this.callNextMethod();a=this.getType().POUCHDB_REGEX.exec(c);if(TP.notValid(a)||TP.isEmpty(d=a.at(1))){return this.raise('TP.sig.InvalidURI',arguments,'Invalid pouch URL - no dbName: '+c);}this.set('path',TP.join(a.at(1),'/',a.at(3)));this.set('dbName',d);if(TP.notEmpty(e=a.at(3))){this.set('resourceID',e);}if(TP.notEmpty(b=a.at(5))){this.set('query',b);f=TP.lang.Hash.fromString(b);this.set('queryDict',f);}return this;});TP.core.PouchDBURL.Inst.defineMethod('addResource',function(b,a,c){this.set('$lastAdded',a);return;});TP.core.PouchDBURL.Inst.defineMethod('getContent',function(a){if(TP.isValid(a)){a.atPutIfAbsent('refresh',true);}return this.callNextMethod();});
TP.boot.$srcPath = '~lib_src/tibet/storage/pouchdb/TP.core.PouchDBURLHandler.js';
TP.core.URIHandler.defineSubtype('PouchDBURLHandler');TP.core.PouchDBURLHandler.Type.defineMethod('load',function(b,k){var a,e,f,c,g,h,i,j,d;TP.debug('break.uri_load');a=TP.request(k);e=a.constructResponse();if(TP.notValid(g=b.get('dbName'))){a.fail(TP.FAILURE,'No db name specified for: '+TP.str(b));return e;}c=b.get('resourceID');if(a.at('verb')===TP.HTTP_HEAD){f='retrieveItemInfo';}else if(TP.isValid(c)){if(c==='_all_docs'){f='retrieveDBInfo';}else{f='retrieveItem';}}else{a.fail(TP.FAILURE,'Can\'t compute a load action for: '+TP.str(b));return e;}if(TP.isValid(h=b.get('queryDict'))){i=h.at('securePW');}j=TP.hc('action',f,'dbName',g,'securePW',i,'id',c);d=TP.sig.PouchDBRequest.construct(j);a.andJoinChild(d);d.fire();a.updateRequestMode(d);return e;});TP.core.PouchDBURLHandler.Type.defineMethod('nuke',function(c,k){var a,d,e,f,h,i,j,g,b;TP.debug('break.uri_nuke');a=TP.request(k);d=a.constructResponse();if(TP.notValid(f=c.get('dbName'))){a.fail(TP.FAILURE,'No db name specified for: '+TP.str(c));return d;}if(TP.isValid(h=c.get('resourceID'))){e='deleteItem';}else{e='deleteDB';}if(TP.isValid(i=c.get('queryDict'))){j=i.at('securePW');}g=TP.hc('action',e,'dbName',f,'securePW',j,'id',h);b=TP.sig.PouchDBRequest.construct(g);a.andJoinChild(b);b.fire();a.updateRequestMode(b);return d;});TP.core.PouchDBURLHandler.Type.defineMethod('save',function(b,l){var a,c,f,g,k,i,j,h,e,d;TP.debug('break.uri_save');a=TP.request(l);c=a.constructResponse();if(TP.notValid(f=b.get('dbName'))){a.fail(TP.FAILURE,'No db name specified for: '+TP.str(b));return c;}g=b.get('resourceID');j=a.at('cmdAction');if(j===TP.ADD){}else{if(TP.isEmpty(h=b.getResource(TP.hc('refresh',false,'async',false)))){a.fail(TP.FAILURE,'No content to save for: '+TP.str(b));return c;}}if(TP.isValid(k=b.get('queryDict'))){i=k.at('securePW');}if(a.at('verb')===TP.HTTP_PUT){if(TP.notValid(g)){a.fail(TP.FAILURE,'No resource ID specified for: '+TP.str(b));return c;}e=TP.hc('action','updateItem','dbName',f,'securePW',i,'id',g,'body',h);}else{e=TP.hc('action','createItem','dbName',f,'securePW',i,'body',h);}d=TP.sig.PouchDBRequest.construct(e);a.andJoinChild(d);d.fire();a.updateRequestMode(d);return c;});
TP.boot.$srcPath = '~lib_src/tibet/workflow/UserIOSignal.js';
TP.lang.Object.defineSubtype('sig:UserIOSignal');TP.sig.UserIOSignal.Type.defineMethod('shouldLog',function(){return TP.sys.shouldLogUserIOSignals();});TP.sig.UserIOSignal.Inst.defineAttribute('messageType','message');TP.sig.UserIOSignal.Inst.defineMethod('getMessageType',function(){var a;if(TP.isValid(a=this.at('messageType'))){return a;}return this.$get('messageType');});TP.sig.UserIOSignal.Inst.defineMethod('isError',function(a){if(TP.isBoolean(a)){if(TP.isValid(this.at('messageType'))){this.atPut('messageType',a);}else{this.$set('messageType','failure');}}return this.getMessageType()==='failure';});
TP.boot.$srcPath = '~lib_src/tibet/workflow/UserIORequest.js';
TP.sig.IORequest.defineSubtype('UserIORequest');TP.sig.UserIORequest.addTraitsFrom(TP.sig.UserIOSignal);TP.sig.UserIORequest.Type.resolveTraits(TP.ac('shouldLog','getSignalName'),TP.sig.UserIORequest);TP.sig.UserIORequest.Inst.resolveTraits(TP.ac('asSource','asDumpString','asHTMLString','asJSONSource','asPrettyString','asXMLString','asString','at','atPut','getSignalName','getProperty','copy','shouldLog','init','handle','isRecyclable','recycle'),TP.sig.UserIORequest);TP.sig.UserIORequest.executeTraitResolution();TP.sig.UserIORequest.Type.defineAttribute('defaultPolicy',TP.INHERITANCE_FIRING);TP.sig.UserIORequest.isSignalingRoot(true);TP.sig.UserIORequest.Type.defineAttribute('responseType','TP.sig.UserIOResponse');
TP.boot.$srcPath = '~lib_src/tibet/workflow/UserIOResponse.js';
TP.sig.IOResponse.defineSubtype('UserIOResponse');TP.sig.UserIOResponse.addTraitsFrom(TP.sig.UserIOSignal);TP.sig.UserIOResponse.Type.resolveTraits(TP.ac('shouldLog','getSignalName'),TP.sig.UserIOResponse);TP.sig.UserIOResponse.Inst.resolveTraits(TP.ac('asSource','asDumpString','asHTMLString','asJSONSource','asPrettyString','asXMLString','asString','at','atPut','getSignalName','getProperty','copy','shouldLog','init','isRecyclable','recycle'),TP.sig.UserIOResponse);TP.sig.UserIOResponse.defineSubtype('UserOutput');TP.sig.UserIOResponse.defineSubtype('UserInput');TP.sig.UserInput.defineSubtype('UserInputEntry');
TP.boot.$srcPath = '~lib_src/tibet/workflow/UserIOService.js';
TP.core.IOService.defineSubtype('UserIOService');TP.core.UserIOService.Type.defineAttribute('triggerSignals','TP.sig.UserIORequest');TP.core.UserIOService.Inst.defineAttribute('requestQueue');TP.core.UserIOService.Inst.defineAttribute('lastInputRequest');TP.core.UserIOService.Inst.defineMethod('init',function(a,b){this.callNextMethod();this.$set('requestQueue',TP.ac());return this;});TP.core.UserIOService.Inst.defineMethod('getRequestQueue',function(){return this.$get('requestQueue');});TP.core.UserIOService.Inst.defineMethod('getNextRequest',function(a){return this.get('requestQueue').shift();});TP.core.UserIOService.Inst.defineMethod('getRequestById',function(b){var a,c;if(TP.isValid(a=this.get('lastInputRequest'))){if(a.getRequestID()===b){return a;}}c=this.get('requestQueue');a=c.detect(function(a){return a.getRequestID()===b;});return a;});TP.core.UserIOService.Inst.defineMethod('handleNextRequest',function(c){var a,b,d;if(TP.isValid(a=this.get('lastInputRequest'))){if(a.isActive()){this.refreshFromRequest(a);return;}}this.set('lastInputRequest',null);this.isAwaitingInput(false);this.shouldConcealInput(false);if(TP.notValid(a=this.getNextRequest(c))){return this.handleNoMoreRequests(c);}if(!TP.isType(d=TP.sys.getTypeByName(a.getTypeName()))){return this.raise('TP.sig.InvalidType',arguments,a.getTypeName());}b=d.getHandlerName(null,false,c);if(TP.isMethod(this[b])){return this[b](a);}b=d.getHandlerName(null,true,c);if(TP.isMethod(this[b])){return this[b](a);}return this.raise('TP.sig.UnhandledInputRequest',arguments,b);});TP.core.UserIOService.Inst.defineMethod('handleNoMoreRequests',function(a){return;});TP.core.UserIOService.Inst.defineMethod('handleUserInputRequest',function(a){return;});TP.core.UserIOService.Inst.defineMethod('handleUserInputSeries',function(a){return;});TP.core.UserIOService.Inst.defineMethod('handleUserOutputRequest',function(a){return;});TP.core.UserIOService.Inst.defineMethod('isAwaitingInput',function(a){return TP.override();});TP.core.UserIOService.Inst.defineMethod('queueIORequest',function(a){this.get('requestQueue').add(a);return this;});TP.core.UserIOService.Inst.defineMethod('refreshFromRequest',function(a){return this;});
TP.boot.$srcPath = '~lib_src/tibet/workflow/UserInputRequest.js';
TP.sig.UserIORequest.defineSubtype('UserInputRequest');TP.sig.UserInputRequest.Type.defineAttribute('responseType','TP.sig.UserInput');TP.sig.UserInputRequest.Inst.defineAttribute('messageType','prompt');
TP.boot.$srcPath = '~lib_src/tibet/workflow/UserInputSeries.js';
TP.sig.UserInputRequest.defineSubtype('UserInputSeries');TP.sig.UserInputSeries.Type.defineConstant('QUERY_INDEX',0);TP.sig.UserInputSeries.Type.defineConstant('DEFAULT_INDEX',1);TP.sig.UserInputSeries.Type.defineConstant('PASSWORD_INDEX',2);TP.sig.UserInputSeries.Type.defineConstant('RETRY_INDEX',3);TP.sig.UserInputSeries.Type.defineConstant('VALIDATOR_INDEX',4);TP.sig.UserInputSeries.Type.defineConstant('COUNT_INDEX',5);TP.sig.UserInputSeries.Type.defineConstant('OPTIONAL',function(){return true;});TP.sig.UserInputSeries.Type.defineConstant('MANDATORY',function(a){return TP.notEmpty(a);});TP.sig.UserInputSeries.Type.defineAttribute('responseType','TP.sig.UserInput');TP.sig.UserInputSeries.Inst.defineAttribute('origin');TP.sig.UserInputSeries.Inst.defineAttribute('queries');TP.sig.UserInputSeries.Inst.defineAttribute('queryIndex',0);TP.sig.UserInputSeries.Inst.defineAttribute('replies');TP.sig.UserInputSeries.Inst.defineAttribute('retries',0);TP.sig.UserInputSeries.Inst.defineAttribute('retryMax',5);TP.sig.UserInputSeries.Inst.defineAttribute('uor');TP.sig.UserInputSeries.Inst.defineAttribute('cancelHooks');TP.sig.UserInputSeries.Inst.defineAttribute('failureHooks');TP.sig.UserInputSeries.Inst.defineAttribute('successHooks');TP.sig.UserInputSeries.Inst.defineMethod('init',function(){this.callNextMethod();this.$set('queries',TP.ac());this.$set('replies',TP.ac());return this;});TP.sig.UserInputSeries.Inst.defineMethod('failJob',function(d,e){var b,a,c;this.callNextMethod();this.setSignalName(this.getTypeName());if(TP.isArray(b=this.get('failureHooks'))){c=b.getSize();for(a=0;a<c;a++){try{b.at(a)(this,d);}catch(a){TP.ifError()?TP.error(TP.ec(a,'Error running failure hook.'),TP.LOG,arguments):0;}}}return this;});TP.sig.UserInputSeries.Inst.defineMethod('addCancelHook',function(b){var a;if(!TP.isCallable(b)){return this.raise('TP.sig.InvalidFunction',arguments);}if(TP.notValid(a=this.get('cancelHooks'))){a=TP.ac();this.$set('cancelHooks',a);}a.add(b);return this;});TP.sig.UserInputSeries.Inst.defineMethod('addFailureHook',function(b){var a;if(!TP.isCallable(b)){return this.raise('TP.sig.InvalidFunction',arguments);}if(TP.notValid(a=this.get('failureHooks'))){a=TP.ac();this.$set('failureHooks',a);}a.add(b);return this;});TP.sig.UserInputSeries.Inst.defineMethod('addQuery',function(c){var a,b;b=c||TP.hc();a=TP.ac();a.atPut(this.getType().get('QUERY_INDEX'),b.at('query'));a.atPut(this.getType().get('DEFAULT_INDEX'),b.at('default'));a.atPut(this.getType().get('PASSWORD_INDEX'),b.atIfInvalid('hideInput',false));a.atPut(this.getType().get('RETRY_INDEX'),b.atIfInvalid('retryPrompt','Retry?'));a.atPut(this.getType().get('VALIDATOR_INDEX'),b.atIfInvalid('validator',TP.isValid));a.atPut(this.getType().get('COUNT_INDEX'),b.atIfInvalid('count',3));this.get('queries').add(a);return this;});TP.sig.UserInputSeries.Inst.defineMethod('addSuccessHook',function(b){var a;if(!TP.isCallable(b)){return this.raise('TP.sig.InvalidFunction',arguments);}if(TP.notValid(a=this.get('successHooks'))){a=TP.ac();this.$set('successHooks',a);}a.add(b);return this;});TP.sig.UserInputSeries.Inst.defineMethod('cancelJob',function(d){var b,a,c;this.callNextMethod();this.setSignalName(this.getTypeName());if(TP.isArray(b=this.get('cancelHooks'))){c=b.getSize();for(a=0;a<c;a++){try{b.at(a)(this,d);}catch(a){TP.ifError()?TP.error(TP.ec(a,'Error running cancellation hook.'),TP.LOG,arguments):0;}}}this.$set('queryIndex',Number.POSITIVE_INFINITY);return this;});TP.sig.UserInputSeries.Inst.defineMethod('completeJob',function(){var b,a,c;this.callNextMethod();this.setSignalName(this.getTypeName());if(TP.isArray(b=this.get('successHooks'))){c=b.getSize();for(a=0;a<c;a++){try{b.at(a)(this);}catch(a){TP.ifError()?TP.error(TP.ec(a,'Error running success hook.'),TP.LOG,arguments):0;}}}return this;});TP.sig.UserInputSeries.Inst.defineMethod('fire',function(e,f,g){var a,b,c,d;this.reset();this.set('origin',TP.ifInvalid(this.getRequestID(),e));this.$set('queryIndex',0);this.$set('retries',0);this.get('replies').empty();a=this.get('queries').at(0);if(TP.notValid(a)){TP.ifWarn()?TP.warn('No queries for TP.sig.UserInputSeries.',TP.LOG,arguments):0;return;}b=a.at(this.getType().get('QUERY_INDEX'));c=a.at(this.getType().get('DEFAULT_INDEX'));if(TP.isTrue(d=a.at(this.getType().get('PASSWORD_INDEX')))){this.atPut('password',true);}else{this.atPut('password',false);}try{this.atPut('query',TP.isCallable(b)?b(this.getLastReply(),this).asString():b);}catch(a){TP.ifError()?TP.error(TP.ec(a,'Error executing query generator.'),TP.LOG,arguments):0;this.atPut('query',b);}if(TP.isFalse(d)){try{this.atPut('default',TP.isCallable(c)?c(this.getLastReply(),this).asString():c);}catch(a){TP.ifError()?TP.error(TP.ec(a,'Error executing default generator.'),TP.LOG,arguments):0;this.atPut('default',c);}}return this.callNextMethod();});TP.sig.UserInputSeries.Inst.defineMethod('getLastReply',function(){return this.get('replies').last();});TP.sig.UserInputSeries.Inst.defineMethod('getReplies',function(){return this.$get('replies');});TP.sig.UserInputSeries.Inst.defineMethod('getUor',function(){var a;a=this.$get('uor');if(TP.notValid(a)){a=TP.sig.UserOutputRequest.construct();this.$set('uor',a);}return a;});TP.sig.UserInputSeries.Inst.defineMethod('handleUserInput',function(l){var m,c,d,a,i,b,g,j,h,f,e,k;if(l.get('statusCode')===TP.CANCELLED){this.cancel();return;}h=l.getResult();k=this.get('responder');this.get('replies').atPut(this.get('queryIndex'),h);a=this.get('queries').at(this.get('queryIndex'));if(TP.isEmpty(a)){this.complete();return;}e=TP.ifInvalid(a.at(this.getType().get('COUNT_INDEX')),this.get('retryMax'));e=e.min(this.get('retryMax'));g=a.at(this.getType().get('VALIDATOR_INDEX'));if(TP.isCallable(g)){try{j=g(h,this);}catch(a){TP.ifError()?TP.error(TP.ec(a,'Error executing validator.'),TP.LOG,arguments):0;j=false;}if(!j){this.set('retries',this.get('retries')+1);b=this.get('uor');if(this.get('retries')>e){b.atPut('output','Aborting.... Retry limit reached.');b.atPut('messageType','failure');b.fire(this.get('origin'));this.fail();return;}f=a.at(this.getType().get('RETRY_INDEX'));if(TP.notValid(f)){f='Invalid input. Please retry.';}b.atPut('output',TP.$DEBUG&&TP.$VERBOSE?'Invalid input. Validator is: '+g:f);b.atPut('messageType','failure');b.fire(this.get('origin'));this.reset();this.isActive(true);this.atPut('default',h);this.setSignalName('TP.sig.RequestModified');TP.handle(k,this);return;}}i=this.get('queryIndex')+1;this.$set('queryIndex',i);if(TP.notValid(a=this.get('queries').at(i))){this.complete();return;}this.reset();this.isActive(true);if(TP.isTrue(m=a.at(this.getType().get('PASSWORD_INDEX')))){this.atPut('password',true);}else{this.atPut('password',false);}c=a.at(this.getType().get('QUERY_INDEX'));d=a.at(this.getType().get('DEFAULT_INDEX'));try{this.atPut('query',TP.isCallable(c)?c(this.getLastReply(),this).asString():c);}catch(a){TP.ifError()?TP.error(TP.ec(a,'Error executing query generator.'),TP.LOG,arguments):0;this.atPut('query',c);}if(TP.isFalse(m)){try{this.atPut('default',TP.isCallable(d)?d(this.getLastReply(),this).asString():d);}catch(a){TP.ifError()?TP.error(TP.ec(a,'Error executing default generator.'),TP.LOG,arguments):0;this.atPut('default',d);}}this.setSignalName('TP.sig.RequestModified');TP.handle(k,this);return;});TP.sig.UserInputSeries.Inst.defineMethod('reset',function(){this.setSignalName(this.getTypeName());this.$set('response',null,false);this.$set('statusCode',TP.READY,false);this.atPut('messageType','prompt',false);this.atPut('query',null,false);this.atPut('default',null,false);this.atPut('password',null,false);return;});
TP.boot.$srcPath = '~lib_src/tibet/workflow/UserOutputRequest.js';
TP.sig.UserIORequest.defineSubtype('UserOutputRequest');TP.sig.UserOutputRequest.Type.defineAttribute('responseType','TP.sig.UserOutput');TP.sig.UserOutputRequest.Inst.defineAttribute('messageType','message');TP.sig.UserOutputRequest.Inst.defineAttribute('outputNode');TP.sig.UserOutputRequest.Inst.defineMethod('getOutputNode',function(){return this.$get('outputNode');});
TP.boot.$srcPath = '~lib_src/tibet/workflow/TPSignalCoalescer.js';
TP.lang.Object.defineSubtype('sig:SignalCoalescer');TP.sig.SignalCoalescer.Type.defineConstant('ORIGIN_INDEX',0);TP.sig.SignalCoalescer.Type.defineConstant('SIGNAL_INDEX',1);TP.sig.SignalCoalescer.Type.defineConstant('COUNT_INDEX',2);TP.sig.SignalCoalescer.Type.defineConstant('SEEN_INDEX',3);TP.sig.SignalCoalescer.Type.defineConstant('ORDER_INDEX',4);TP.sig.SignalCoalescer.Inst.defineAttribute('autoReset',true);TP.sig.SignalCoalescer.Inst.defineAttribute('triggers');TP.sig.SignalCoalescer.Inst.defineAttribute('spoilers');TP.sig.SignalCoalescer.Inst.defineAttribute('notifier');TP.sig.SignalCoalescer.Inst.defineMethod('init',function(a){this.callNextMethod();this.$set('triggers',TP.hc());this.$set('spoilers',TP.hc());this.$set('notifier',a||this.getTypeName());return this;});TP.sig.SignalCoalescer.Inst.defineMethod('addSpoiler',function(a,b,f,g){var c,e,d;e=TP.ifInvalid(f,1);d=this.get('spoilers');c=d.at(this.computeSignalID(a,b));if(TP.isValid(c)){c.atPut(TP.sig.SignalCoalescer.COUNT_INDEX,c.at(TP.sig.SignalCoalescer.COUNT_INDEX)+e);return this;}d.atPut(this.computeSignalID(a,b),TP.ac(a,b,e,0,d.getSize()));this.observe(a,b,this,g);return this;});TP.sig.SignalCoalescer.Inst.defineMethod('addTrigger',function(a,b,f,g){var c,e,d;e=TP.ifInvalid(f,1);d=this.get('triggers');c=d.at(this.computeSignalID(a,b));if(TP.isValid(c)){c.atPut(TP.sig.SignalCoalescer.COUNT_INDEX,c.at(TP.sig.SignalCoalescer.COUNT_INDEX)+e);return this;}d.atPut(this.computeSignalID(a,b),TP.ac(a,b,e,0,d.getSize()));this.observe(a,b,this,g);return this;});TP.sig.SignalCoalescer.Inst.defineMethod('computeSignalID',function(a,b){var c,d;c=TP.notValid(a)?TP.ANY:TP.id(a);d=TP.notValid(b)?TP.ANY:b.getSignalName();return c+'.'+d;});TP.sig.SignalCoalescer.Inst.defineMethod('handleSignal',function(d){var e,b,c,a;e=false;b=d.getOrigin();c=this.computeSignalID(b,d);a=this.get('triggers').at(c);if(TP.isValid(a)){a.atPut(TP.sig.SignalCoalescer.SEEN_INDEX,a.at(TP.sig.SignalCoalescer.SEEN_INDEX)+1);e=this.hasCoalesced(a);}if(b!==TP.ANY){b=TP.ANY;c=this.computeSignalID(b,d);a=this.get('triggers').at(c);if(TP.isValid(a)){a.atPut(TP.sig.SignalCoalescer.SEEN_INDEX,a.at(TP.sig.SignalCoalescer.SEEN_INDEX)+1);}}if(this.hasCoalesced(a)){this.signal(this.get('notifier'));if(this.shouldAutoReset()){this.resetObservations();}}return this;});TP.sig.SignalCoalescer.Inst.defineMethod('hasCoalesced',function(a){return TP.override();});TP.sig.SignalCoalescer.Inst.defineMethod('resetObservations',function(){this.get('triggers').perform(function(a){a.last().atPut(TP.sig.SignalCoalescer.SEEN_INDEX,0);});return this;});TP.sig.SignalCoalescer.Inst.defineMethod('setNotifier',function(a){if(TP.notValid(a)){return this.raise('TP.sig.InvalidSignal',arguments);}this.$set('notifier',a);return this;});TP.sig.SignalCoalescer.Inst.defineMethod('shouldAutoReset',function(a){if(TP.isDefined(a)){this.set('autoReset',a,false);}return this.get('autoReset');});
TP.boot.$srcPath = '~lib_src/tibet/workflow/TPOrJoin.js';
TP.sig.SignalCoalescer.defineSubtype('OrJoin');TP.sig.OrJoin.Inst.defineMethod('hasCoalesced',function(a){return a.at(TP.sig.SignalCoalescer.SEEN_INDEX)===a.at(TP.sig.SignalCoalescer.COUNT_INDEX);});
TP.boot.$srcPath = '~lib_src/tibet/workflow/TPAndJoin.js';
TP.sig.SignalCoalescer.defineSubtype('AndJoin');TP.sig.AndJoin.Inst.defineAttribute('orderMatters',false);TP.sig.AndJoin.Inst.defineAttribute('allowOverflow',true);TP.sig.AndJoin.Inst.defineMethod('hasCoalesced',function(h){var c,a,d,e,f,b,g,i;c=this.get('triggers');if(this.shouldOrderMatter()){d=TP.keys(c);f=this.computeSignalID(h.at(TP.sig.SignalCoalescer.ORIGIN_INDEX),h.at(TP.sig.SignalCoalescer.SIGNAL_INDEX));g=d.getPosition(f);if(TP.notValid(g)){this.raise('TP.sig.InvalidTriggerID',arguments);return false;}for(b=0;b<g;b++){a=c.at(d.at(b));if(!this.shouldAllowOverflow()){if(a.at(TP.sig.SignalCoalescer.SEEN_INDEX)>a.at(TP.sig.SignalCoalescer.COUNT_INDEX)){this.resetObservations();return false;}}if(a.at(TP.sig.SignalCoalescer.SEEN_INDEX)!==a.at(TP.sig.SignalCoalescer.COUNT_INDEX)){this.resetObservations();return false;}}if(d.last()===f){return a.at(TP.sig.SignalCoalescer.SEEN_INDEX)===a.at(TP.sig.SignalCoalescer.COUNT_INDEX);}else{return false;}}else{if(!this.shouldAllowOverflow()){if(a.at(TP.sig.SignalCoalescer.SEEN_INDEX)>a.at(TP.sig.SignalCoalescer.COUNT_INDEX)){this.resetObservations();return false;}}e=c.getValues();i=e.getSize();for(b=0;b<i;b++){a=e.at(b);if(a.at(TP.sig.SignalCoalescer.SEEN_INDEX)!==a.at(TP.sig.SignalCoalescer.COUNT_INDEX)){return false;}}return true;}});TP.sig.AndJoin.Inst.defineMethod('shouldAllowOverflow',function(a){if(TP.isDefined(a)){this.$set('allowOverflow',a,false);}return this.$get('allowOverflow');});TP.sig.AndJoin.Inst.defineMethod('shouldOrderMatter',function(a){if(TP.isDefined(a)){this.$set('orderMatters',a,false);}return this.$get('orderMatters');});
TP.boot.$srcPath = '~lib_src/tibet/workflow/TPRequestCoalescer.js';
TP.sig.AndJoin.defineSubtype('RequestCoalescer');TP.sig.RequestCoalescer.Inst.defineMethod('addRequest',function(a){if(TP.notValid(a)){return this.raise('TP.sig.InvalidRequest',arguments);}this.addTrigger(a.getRequestID(),'TP.sig.RequestCompleted');return this;});
TP.boot.$srcPath = '~lib_src/tibet/shells/TPShellResponse.js';
TP.sig.Response.defineSubtype('ShellResponse');TP.sig.ShellResponse.Inst.defineAttribute('messageType','response');TP.sig.ShellResponse.Type.defineMethod('shouldLog',function(){return TP.sys.shouldLogTSHSignals();});TP.sig.ShellResponse.Inst.defineMethod('getMessageType',function(){var a;if(TP.isValid(a=this.at('messageType'))){return a;}return this.$get('messageType');});
TP.boot.$srcPath = '~lib_src/tibet/shells/TPShellRequest.js';
TP.sig.Request.defineSubtype('ShellRequest');TP.sig.ShellRequest.Type.defineAttribute('responseType','TP.sig.ShellResponse');TP.sig.ShellRequest.Type.defineAttribute('tableName','history');TP.sig.ShellRequest.Type.defineAttribute('defaultPolicy',TP.FIRE_ONE);TP.sig.ShellRequest.Type.defineMethod('construct',function(a){var b;if(TP.isString(a)){b=TP.hc('cmd',a);}else if(TP.canInvoke(a,'getPayload')){b=a.getPayload();}else if(TP.canInvoke(a,TP.ac('at','atPut'))){b=a;}else{this.raise('TP.sig.InvalidParameter',arguments);return;}return this.callNextMethod(b);});TP.sig.ShellRequest.Type.defineMethod('shouldLog',function(){return TP.sys.shouldLogTSHSignals();});TP.sig.ShellRequest.Inst.defineAttribute('ARGUMENTS');TP.sig.ShellRequest.Inst.defineAttribute('PARAMS');TP.sig.ShellRequest.Inst.defineAttribute('messageType','query');TP.sig.ShellRequest.Inst.defineAttribute('message');TP.sig.ShellRequest.Inst.defineAttribute('subrequests');TP.sig.ShellRequest.Inst.defineAttribute('$timestart');TP.sig.ShellRequest.Inst.defineAttribute('$evaltime');TP.sig.ShellRequest.Inst.defineAttribute('$exectime');TP.sig.ShellRequest.Inst.defineAttribute('$tagtime');TP.sig.ShellRequest.Inst.defineMethod('cancel',function(a,b){this.callNextMethod();return TP.BREAK;});TP.sig.ShellRequest.Inst.defineMethod('complete',function(a){this.callNextMethod();return TP.CONTINUE;});TP.sig.ShellRequest.Inst.defineMethod('fail',function(b,c,a){if(this.isCompleting()||this.didComplete()){return;}if(TP.isValid(a)){this.raise(a,arguments,TP.ifInvalid(c,b));}this.callNextMethod();return TP.BREAK;});TP.sig.ShellRequest.Inst.defineMethod('getEvaltime',function(){return this.$summarizeSubrequestData('$evaltime');});TP.sig.ShellRequest.Inst.defineMethod('getExectime',function(){return this.$get('$exectime');});TP.sig.ShellRequest.Inst.defineMethod('getOriginalCmdText',function(){var a,b,c;a='';if(TP.isNode(b=this.at('cmdRoot'))){if(TP.isCDATASectionNode(c=TP.nodeGetFirstDescendantByType(b,Node.CDATA_SECTION_NODE))){a=TP.nodeGetTextContent(c);}}return a;});TP.sig.ShellRequest.Inst.defineMethod('getTagtime',function(){return this.$summarizeSubrequestData('$tagtime');});TP.sig.ShellRequest.Inst.defineMethod('getMessageType',function(){var a;if(TP.isValid(a=this.at('messageType'))){return a;}return this.$get('messageType');});TP.sig.ShellRequest.Inst.defineMethod('setMessageType',function(a){return this.atPut('messageType',a);});TP.sig.ShellRequest.Inst.defineMethod('stderr',function(c,d){var a,b;TP.debug('break.tsh_stderr');a=TP.request(TP.ifInvalid(d,this));if(TP.notTrue(a.at('cmdSilent'))){b=a.at('cmdShell');if(TP.canInvoke(b,'stderr')){b.stderr(c,a);}}return;});TP.sig.ShellRequest.Inst.defineMethod('stdin',function(){TP.debug('break.tsh_stdin');return TP.ifInvalid(this.at(TP.STDIN),TP.ac());});TP.sig.ShellRequest.Inst.defineMethod('stdout',function(c,d){var a,b;TP.debug('break.tsh_stdout');a=TP.request(TP.ifInvalid(d,this));if(TP.notTrue(a.at('cmdSilent'))){b=a.at('cmdShell');if(TP.canInvoke(b,'stdout')){b.stdout(c,a);}}return;});TP.sig.ShellRequest.Inst.defineMethod('$summarizeSubrequestData',function(d){var b,a,c;b=this.get('subrequests');if(TP.notEmpty(b)){a=b.collect(function(a){return TP.ifInvalid(a.get(d),0);});if(TP.notEmpty(a)){if(TP.isNumber(a.first())){c=0;a.perform(function(a){c+=a;});return c;}}return 0;}return this.get(d);});
TP.boot.$srcPath = '~lib_src/tibet/shells/TPShell.js';
TP.definePrimitive('shell',function(k,n,m,l,e,i,h){var c,j,b,d,a,g,f;if(TP.isEmpty(e)){c=TP.core.TSH.getDefaultInstance();}else if(TP.isString(e)){c=TP.core.Resource.getResourceById(e);if(!TP.isKindOf(c,'TP.core.Shell')){TP.raise(this,'TP.sig.InvalidParameter',arguments,'Shell ID must be a valid string or shell.');return;}}else if(TP.isKindOf(e,'TP.core.Shell')){c=e;}else{TP.raise(this,'TP.sig.InvalidParameter',arguments,'Shell ID must be a valid string or shell.');return;}j=TP.ifInvalid(l,false);b=TP.sig.ShellRequest.construct(TP.hc('cmd',k,'cmdAsIs',true,'cmdExecute',true,'cmdInteractive',false,'cmdAllowSubs',true,'cmdLiteral',false,'cmdPhases','nocache','cmdShell',c,'cmdSilent',!j));m===true?b.atPut('cmdHistory',true):0;n===true?b.atPut('echoRequest',true):0;a=TP.hc('notify',TP.ac(),'stdin',TP.ac(),'stdout',TP.ac(),'stderr',TP.ac());d=TP.lang.Object.construct();d.defineMethod('notify',function(b,c){a.at('notify').push(b);});d.defineMethod('stdin',function(b,c,d){a.at('stdin').push(b);});d.defineMethod('stdout',function(b,c){a.at('stdout').push(b);});d.defineMethod('stderr',function(b,c){a.at('stderr').push(b);});c.attachSTDIO(d);if(TP.isCallable(i)){g=function(d){c.detachSTDIO();g.ignore(b,'TP.sig.ShellRequestSucceeded');if(TP.isEmpty(a.at('stdout'))){a.at('stdout').push('');}i(d,a);};g.observe(b,'TP.sig.ShellRequestSucceeded');}if(TP.isCallable(h)){f=function(d){c.detachSTDIO();f.ignore(b,'TP.sig.ShellRequestFailed');h(d,a);};f.observe(b,'TP.sig.ShellRequestFailed');}c.handleShellRequest(b);return b;});TP.core.Service.defineSubtype('Shell');TP.core.Shell.Type.defineConstant('HISTORY_MAX',100);TP.core.Shell.Type.defineConstant('POSITIONAL_MAX',25);TP.core.Shell.Type.defineConstant('MIN_USERNAME_LEN',2);TP.core.Shell.Type.defineConstant('MIN_PASSWORD_LEN',2);TP.core.Shell.Type.defineConstant('INVALID_ARGUMENT_MATCHER',TP.rc('(xmlns|xmlns:\\w+|class|tibet:sourcetag|sourcetag|tsh:argv|argv)'));TP.core.Shell.Type.defineAttribute('triggerSignals','TP.sig.ShellRequest');TP.core.Shell.Type.defineAttribute('commandPrefix','');TP.core.Shell.Type.defineAttribute('updateInfo');TP.core.Shell.Type.defineMethod('initialize',function(){TP.sys.require('TP.sig.ShellRequest');TP.sys.require('TP.sig.UserOutputRequest');TP.sys.require('TP.sig.UserInputRequest');TP.sys.require('TP.sig.ConsoleRequest');this.observe(TP.sys,'TP.sig.UpdateAvailable');return;});TP.core.Shell.Type.defineMethod('handleUpdateAvailable',function(c){var a,b;this.ignore(TP.sys,'TP.sig.UpdateAvailable');if(TP.isValid(a=c.getPayload())){this.set('updateInfo',a);b=function(){var b;b=TP.sig.UserOutputRequest.construct(TP.hc('cmdTitle','Version Update','echoRequest',true,'output',TP.elem(TP.join('<span xmlns="',TP.w3.Xmlns.XHTML,'">','There is a new TIBET version: ',TP.sys.getLibVersion(a),'</span>')),'cmdAsIs',true,'cmdBox',false));b.fire(this);};b.fork(2000);}return this;});TP.core.Shell.Inst.defineAttribute('aliases');TP.core.Shell.Inst.defineAttribute('commandPrefix');TP.core.Shell.Inst.defineAttribute('commandPrompt');TP.core.Shell.Inst.defineAttribute('executionInstance');TP.core.Shell.Inst.defineAttribute('history');TP.core.Shell.Inst.defineAttribute('historyIndex',0);TP.core.Shell.Inst.defineAttribute('nextPID',0);TP.core.Shell.Inst.defineAttribute('running',false);TP.core.Shell.Inst.defineAttribute('request');TP.core.Shell.Inst.defineAttribute('current');TP.core.Shell.Inst.defineAttribute('previous');TP.core.Shell.Inst.defineAttribute('username');TP.core.Shell.Inst.defineAttribute('pathStack');TP.core.Shell.Inst.defineAttribute('announcement',null);TP.core.Shell.Inst.defineAttribute('goodbye',null);TP.core.Shell.Inst.defineAttribute('introduction',null);TP.core.Shell.Inst.defineAttribute('watcherSSESource');TP.core.Shell.Inst.defineMethod('init',function(a,b){this.callNextMethod();this.$set('request',b);this.$set('aliases',TP.hc());this.$set('history',TP.ac());this.$set('pathStack',TP.ac());this.setPrefix();this.setPrompt(this.getPrefix()+'&#160;&#187;');this.observe(TP.sys,'TP.sig.AppShutdown');TP.sys.registerObject(this,a);return this;});TP.core.Shell.Inst.defineMethod('$getEqualityValue',function(){return this.getID();});TP.core.Shell.Inst.defineMethod('getNextPID',function(){var a;a=this.$get('nextPID');this.$set('nextPID',a+1);return a;});TP.core.Shell.Inst.defineMethod('getPrefix',function(){return this.$get('commandPrefix');});TP.core.Shell.Inst.defineMethod('getPrompt',function(){return this.$get('commandPrompt');});TP.core.Shell.Inst.defineMethod('setPrefix',function(b){var a;a=TP.ifEmpty(b,this.getType().get('commandPrefix'));this.$set('commandPrefix',a);return this;});TP.core.Shell.Inst.defineMethod('setPrompt',function(a){this.$set('commandPrompt',a);return this;});TP.core.Shell.Inst.defineMethod('announce',function(c){var a,b;a=TP.ifInvalid(this.get('announcement'),'');a+=TP.ifInvalid(this.get('introduction'),'');b=TP.sig.UserOutputRequest.construct(TP.hc('cmdTitle','Announcement','echoRequest',true,'output',a,'cssClass','inbound_announce','cmdAsIs',true,'cmdBox',false));b.fire(this);return;});TP.core.Shell.Inst.defineMethod('handleAppShutdown',function(a){this.logout(a);return;});TP.core.Shell.Inst.defineMethod('isLoginShell',function(){return true;});TP.core.Shell.Inst.defineMethod('isRunning',function(a){if(TP.isBoolean(a)){this.$set('running',a);}return this.$get('running');});TP.core.Shell.Inst.defineMethod('login',function(a){TP.override();return this;});TP.core.Shell.Inst.defineMethod('logout',function(a){if(!this.isLoginShell(a)){return this;}if(this.isRunning()){try{this.saveProfile();}catch(a){}finally{this.isRunning(false);}}this.signal('TP.sig.TSH_Logout');return this;});TP.core.Shell.Inst.defineMethod('start',function(a){if(this.isRunning()){return a;}if(this.isLoginShell(a)){this.announce(a);}else{this.isRunning(true);}return a;});TP.core.Shell.Inst.defineMethod('initProfile',function(){var c,d,a,b,e,f;if(TP.notEmpty(c=this.get('username'))){d=TP.core.LocalStorage.construct();b=d.at('user_'+c);a=TP.ac();if(TP.notEmpty(b)){e=TP.json2js(b);if(TP.notEmpty(f=e.at('history'))){f.perform(function(b){var c;c=TP.sig.ShellRequest.construct(TP.hc('cmd',b.at('cmd'),'cmdAllowSubs',b.at('cmdAllowSubs'),'cmdAsIs',b.at('cmdAsIs'),'cmdExecute',b.at('cmdExecute'),'cmdHistory',false,'cmdInteractive',b.at('cmdInteractive'),'cmdLiteral',b.at('cmdLiteral'),'cmdPhases',b.at('cmdPhases'),'cmdRecycle',b.at('cmdRecycle'),'cmdRoot',TP.elem(b.at('cmdRoot')),'cmdShell',b.at('cmdShell'),'cmdSilent',b.at('cmdSilent')));c.atPut('cmdPeer',c);a.add(c);});this.set('history',a);}}}return;});TP.core.Shell.Inst.defineMethod('saveProfile',function(){var a,b,c,d;if(TP.notEmpty(a=this.get('username'))){b=this.get('history').collect(function(a){return TP.hc('cmd',a.at('cmd'),'cmdAllowSubs',a.at('cmdAllowSubs'),'cmdExecute',a.at('cmdExecute'),'cmdInteractive',a.at('cmdInteractive'),'cmdLiteral',a.at('cmdLiteral'),'cmdPhases',a.at('cmdPhases'),'cmdRecycle',a.at('cmdRecycle'),'cmdRoot',TP.str(a.at('cmdRoot')),'cmdSilent',a.at('cmdSilent'));});c=TP.hc('history',b);d=TP.core.LocalStorage.construct();d.atPut('user_'+a,TP.js2json(c));}return;});TP.core.Shell.Inst.defineMethod('getAlias',function(a){var b,c,d;b=TP.ifInvalid(this.get('aliases'),TP.hc());if(TP.isDefined(c=b.at(a))){return this.getAlias(c);}if(TP.isValid(d=this.get('parent'))){return d.getAlias(a);}return a;});TP.core.Shell.Inst.defineMethod('setAlias',function(c,a){var b;if(a.charAt(0)==='"'){b=this.resolveVariableSubstitutions(a.unquoted());}else{b=a.unquoted();}this.get('aliases').atPut(c,b);return this;});TP.core.Shell.Inst.defineMethod('unsetAlias',function(a){this.get('aliases').removeKey(a);return this;});TP.core.Shell.Inst.defineMethod('addHistory',function(f){var a,b,g,c,d,e;a=this.get('history');b=f.at('cmd');b=b.trim();this.set('historyIndex',a.getSize());g=TP.ifInvalid(this.getVariable('HISTSIZE'),this.getType().HISTORY_MAX);c=TP.ifInvalid(this.getVariable('HISTDUP'),'prev');c.toLowerCase();if(c==='prev'&&a.getSize()>0){if(a.last().at('cmd')===b){return;}}else if(c==='all'){for(d=a.getSize()-1;d>=0;d--){if(a.at(d).at('cmd')===b){return;}}}a.add(f);e=a.getSize()-g;if(e>0){a.atPut(e-1,null);}this.set('historyIndex',a.getSize());return a.getSize()-1;});TP.core.Shell.Inst.defineMethod('decrementHistoryIndex',function(){this.set('historyIndex',0..max(this.get('historyIndex')-1));return this.get('historyIndex');});TP.core.Shell.Inst.defineMethod('getHistory',function(a,i){var d,b,c,g,e,h,f;d=TP.ifInvalid(i,false);if(TP.notValid(a)){return this.$get('history');}if(TP.isNumber(a)){b=this.$get('history').at(a);if(TP.isValid(b)){if(TP.isString(b)){return b;}else if(d){c=b.getOriginalCmdText();return c;}else{return b.at('cmd');}}}else{if(!TP.isRegExp(e=a)){e=TP.rc('^'+RegExp.escapeMetachars(a)+'[\\s\\S]*');}if(TP.notValid(e)){this.raise('TP.sig.InvalidParameter',arguments,a);return;}h=this.$get('history').slice(0,-1);f=h.reverse().detect(function(a){var b;b=d?a.getOriginalCmdText():a.at('cmd');return e.test(b);});if(TP.isValid(f)){c=d?f.getOriginalCmdText():f.at('cmd');}else{return;}if(TP.isDocument(g=TP.documentFromString(c))){c=TP.elementGetInnerContent(g.documentElement);}return c;}return null;});TP.core.Shell.Inst.defineMethod('incrementHistoryIndex',function(){this.set('historyIndex',(this.get('historyIndex')+1).min(this.get('history').getSize()));return this.get('historyIndex');});TP.core.Shell.Inst.defineMethod('getVariable',function(b){var c,a,d,e;c=this.getExecutionInstance();a=b.toUpperCase();if(a.charAt(0)!=='$'){a='$'+a;}if(TP.isDefined(d=c.at(a))){return d;}if(TP.isValid(e=this.get('parent'))){return e.getVariable(a);}return TP.sys.cfg(b)||TP.sys.env(b);});TP.core.Shell.Inst.defineMethod('setVariable',function(b,c){var a;a=b.toUpperCase();if(a.charAt(0)!=='$'){a='$'+a;}this.getExecutionInstance().atPut(a,c);return this;});TP.core.Shell.Inst.defineMethod('unsetVariable',function(b){var a;a=b.toUpperCase();if(a.charAt(0)!=='$'){a='$'+a;}this.getExecutionInstance().removeKey(a);return this;});TP.core.Shell.Inst.defineMethod('handleShellRequest',function(a){var c,b,d;a.isActive(true);if(TP.notValid(c=a.constructResponse())){a.fail(TP.FAILURE,'Couldn\'t construct response.');this.raise('TP.sig.ProcessingException',arguments,'Couldn\'t construct response.');return;}a.set('responder',this);a.atPut('cmdShell',this);this.$set('previous',this.$get('current'));this.$set('current',a);if(TP.isTrue(a.at('cmdInteractive'))&&TP.notTrue(a.at('cmdSilent'))&&TP.notValid(a.at('cmdPeer'))){a.atPutIfAbsent('cmdID',a.getRequestID());a.atPut('cmdRecycle',true);b=a.at('cmd');if(TP.notBlank(b)){d=TP.hc('cmd',b,'cmdID',a.at('cmdID'),'cmdConstruct',true,'echoRequest',true);this.stdout(null,d);}this.execute.bind(this).fork(0,a);}else{this.execute(a);}return c;});TP.core.Shell.Inst.defineMethod('handleUserInput',function(a){var b,e,c,f,d;b=a.getRequest();b.isActive(true);e=a.getRequest().get('responder');c=TP.sig.ShellRequest.construct(TP.hc('cmd',a.getResult()));c.set('requestor',this);try{f=TP.handle(this,c);}catch(a){}finally{if(TP.isValid(e)){a.getRequestID().signal('TP.sig.RequestCompleted');}}d=a.constructResponse();d.complete();b.complete();return d;});TP.core.Shell.Inst.defineMethod('attachSTDIO',function(a){if(!TP.canInvoke(a,TP.ac('notify','stdin','stdout','stderr'))){return this.raise('TP.sig.InvalidProvider',arguments,'STDIO provider must implement stdin, stdout, and stderr');}if(TP.notValid(this.$origStdin)){this.$origNotify=this.notify;this.$origStdin=this.stdin;this.$origStdout=this.stdout;this.$origStderr=this.stderr;}this.notify=function(b,c){return a.notify(b,c);};this.stdin=function(b,c,d){return a.stdin(b,c,d);};this.stdout=function(b,c){return a.stdout(b,c);};this.stderr=function(b,c){return a.stderr(b,c);};return this;});TP.core.Shell.Inst.defineMethod('detachSTDIO',function(){if(TP.notValid(this.$origStdin)){return;}this.notify=this.$origNotify;this.stdin=this.$origStdin;this.stdout=this.$origStdout;this.stderr=this.$origStderr;return this;});TP.core.Shell.Inst.defineMethod('notify',function(a,c){var b,d,e;if(TP.isString(a)){b=a;}else if(TP.isError(a)){b=TP.ifInvalid(a.message,'');}else if(TP.canInvoke(a,'at')){b=a.at('message');if(TP.notValid(b)&&TP.canInvoke(a,'get')){b=a.get('message');}if(TP.notValid(b)||!TP.isString(b)){b=TP.str(a);}}else{b=TP.str(a);}d=TP.ifKeyInvalid(c,'cmdNotifier',null);e=TP.ifKeyInvalid(c,'cmdAsIs',false);TP.boot.$alert(b);return;});TP.core.Shell.Inst.defineMethod('stderr',function(c,b){var a;if(TP.notValid(b)){a=TP.sig.UserOutputRequest.construct();a.set('requestor',this);}else if(TP.isKindOf(b,TP.sig.UserOutputRequest)){a=b;}else{a=TP.sig.UserOutputRequest.construct(b);a.set('requestor',this);}a.atPut('output',c);a.atPut('messageType','failure');a.atPutIfAbsent('messageLevel',TP.ERROR);a.fire(this);return;});TP.core.Shell.Inst.defineMethod('stdin',function(c,d,b){var a;if(TP.notValid(b)){a=TP.sig.UserInputRequest.construct();a.set('requestor',this);}else if(TP.isKindOf(b,TP.sig.UserInputRequest)){a=b;}else{a=TP.sig.UserInputRequest.construct(b);a.set('requestor',this);}a.atPut('query',c);a.atPut('default',d);a.fire(this);return;});TP.core.Shell.Inst.defineMethod('stdout',function(c,b){var a;if(TP.notValid(b)){a=TP.sig.UserOutputRequest.construct();a.set('requestor',this);}else if(TP.isKindOf(b,TP.sig.UserIORequest)){a=b;}else{a=TP.sig.UserOutputRequest.construct(b);a.set('requestor',this);}a.atPut('output',c);a.fire(this);return;});TP.core.Shell.Inst.defineMethod('addPath',function(f){var b,a,g,c,d,e;if(TP.notValid(b=this.expandPath(f))){this.stderr('Path expansion failed for '+f);return;}a=this.get('pathStack');g=TP.ifInvalid(this.getVariable('PATHSIZE'),this.getType().PATH_MAX);c=TP.ifInvalid(this.getVariable('PATHDUP'),'prev');c.toLowerCase();if(c==='prev'){if(a.last()===b){return;}}else if(c==='all'){for(d=a.getSize()-1;d>=0;d--){if(a.at(d)===b){return;}}}a.add(b);e=a.getSize()-g;if(e>0){a.atPut(e-1,null);}return a.getSize()-1;});TP.core.Shell.Inst.defineMethod('clearPaths',function(){this.get('pathStack').empty();return this;});TP.core.Shell.Inst.defineMethod('execute',function(a){return TP.override();});TP.core.Shell.Inst.defineMethod('expandPath',function(a){var g,b,f,h,i,e,c,d;if(TP.isEmpty(a)){return this.getPath();}g=TP.ifInvalid(this.getVariable('HOME'),TP.sys.getAppRoot());b=a.unquoted();f=false;h=TP.core.URI.getSubtypes(true)||TP.ac();i=h.collect(function(a){return a.get('SCHEME');});i.perform(function(a){if(TP.isValid(a)&&a!==''&&b.startsWith(a)){f=true;}});if(f){return b;}if(a.startsWith('~app/')){b=TP.uriJoinPaths(g,a.slice(5));}else if(a.toLowerCase().startsWith('~lib/')){b=TP.uriJoinPaths(TP.sys.getLibRoot(),a.slice(5));}else if(a.startsWith('~/')){b=TP.uriJoinPaths(TP.sys.getAppHead(),a.slice(2));}else if(a.first()==='='){e=a.split('/');c=e.shift().slice(1);if(c.equalTo('-')){d=this.getPath();b=TP.uriJoinPaths(d,e.join('/'));}else{if(!TP.isNaN(parseInt(c,10))){d=this.get('pathStack').at(c);if(TP.isString(d)){b=TP.uriJoinPaths(d,e.join('/'));}}}if(TP.notValid(b)){this.stderr('Unable to resolve "='+c+'"');}}else{if(/^[a-zA-Z]/.test(a)){b=TP.uriResolvePaths(this.getPath(),a);}}return b;});TP.core.Shell.Inst.defineMethod('getPath',function(a){var b;if(TP.isNumber(a)){b=this.$get('pathStack').at(a);}if(TP.isNumber(a)){this.raise('TP.sig.InvalidParameter',arguments,a);return;}b=this.$get('pathStack').last();if(TP.notValid(b)){return TP.sys.getLibRoot();}return b;});TP.core.Shell.Inst.defineMethod('getLastPath',function(){return this.$get('pathStack').last();});TP.core.Shell.Inst.defineMethod('removePath',function(b){var a,c;a=this.$get('pathStack');if(a.getSize()===0){return;}if(TP.notValid(b)){c=this.getLastPath();a.removeLast();}else{if(a.getSize()>b){c=a.at(b);a.removeAt(b);}else{this.stderr('Path index not found for removal.');}}return c;});TP.core.Shell.Inst.defineMethod('getExecutionContext',function(c){var a,d,b;if(TP.isValid(c)&&TP.isValid(a=c.at('execContext'))){return a;}if(TP.isValid(a=this.$get('context'))){return a;}if(TP.isWindow(d=TP.global.$$findTIBET())){b=d;}if(TP.notValid(b)){b=window;}this.setExecutionContext(b);return this.$get('context');});TP.core.Shell.Inst.defineMethod('getExecutionInstance',function(b){var c,a;if(TP.isValid(b)&&TP.isValid(c=b.at('execInstance'))){return c;}if(TP.notValid(a=this.$get('executionInstance'))){a={};TP.defineSlot(a,'at',function(a){return this[a];},TP.METHOD,TP.LOCAL_TRACK,TP.HIDDEN_DESCRIPTOR);TP.defineSlot(a,'atPut',function(a,b){this[a]=b;},TP.METHOD,TP.LOCAL_TRACK,TP.HIDDEN_DESCRIPTOR);TP.defineSlot(a,'hasKey',function(a){return this[a]!==undefined;},TP.METHOD,TP.LOCAL_TRACK,TP.HIDDEN_DESCRIPTOR);TP.defineSlot(a,'removeKey',function(a){delete this[a];},TP.METHOD,TP.LOCAL_TRACK,TP.HIDDEN_DESCRIPTOR);this.$set('executionInstance',a);}return a;});TP.core.Shell.Inst.defineMethod('resolveObjectReference',function(c,h){var f,d,a,e,b,g;if(!TP.isString(c)){return c;}if(c==='{}'){return Object.construct();}if(c==='[]'){return TP.ac();}a=c;f=this.getExecutionInstance();d=this.getExecutionContext();if(a.startsWith('${')&&a.endsWith('}')){a='$'+a.slice(2,-1);}if(TP.regex.TSH_DEREF_SUGAR.test(a)){a=c.slice(1);}try{if(TP.regex.URI_LIKELY.test(a)&&!TP.regex.REGEX_LITERAL_STRING.test(a)){e=this.expandPath(a);if(TP.isURI(e=TP.uc(e))){b=e.getResource(TP.hc('async',false));}}else if(f.hasKey(a)){b=f.at(a);}else{if(a.charAt(0)==='{'&&a.charAt(a.length-1)==='}'){a='('+a+')';}if(Function.$$getNameRegex.test(a)){a='('+a+')';}try{b=d.eval(a);if(TP.notValid(b)){if(TP.regex.NS_QUALIFIED.test(a)){b=d.eval('\''+a+'\'.asType()');}}}catch(c){if(TP.regex.NS_QUALIFIED.test(a)){b=d.eval('\''+a+'\'.asType()');}}}if(TP.regex.TSH_DEREF_SUGAR.test(c)){if(TP.canInvoke(b,'cmdGetContent')){b=b.cmdGetContent(h);}else if(TP.canInvoke(b,'getType')){g=b.getType();if(TP.canInvoke(g,'cmdGetContent')){b=g.cmdGetContent(h);}}}}catch(a){b=undefined;}return b;});TP.core.Shell.Inst.defineMethod('resolveVariableSubstitutions',function(b){var a;TP.debug('break.tsh_substitutions');a=b;if(a==='$_'){return this.getExecutionInstance().at('$_');}if(TP.regex.TSH_VARSUB.test(a)){a=a.replace(TP.regex.TSH_VARSUB,function(b,a){return this.getExecutionInstance().at('$'+a);}.bind(this));}return a;});TP.core.Shell.Inst.defineMethod('setExecutionContext',function(b){var a;a=TP.ifInvalid(b,window);if(!TP.isWindow(a)){if(TP.isString(a)){a=TP.byOID(a);if(TP.notValid(a)){return this.raise('TP.sig.InvalidWindow',arguments);}else if(!TP.isWindow(a)){if(!TP.isFunction(a.getNativeWindow)){return this.raise('TP.sig.InvalidWindow',arguments);}else{a=a.getNativeWindow();}}}else if(TP.isFunction(a.getNativeWindow)){if(!TP.isWindow(a=a.getNativeWindow())){return this.raise('TP.sig.InvalidWindow',arguments);}}else{return this.raise('TP.sig.InvalidWindow',arguments);}}this.$set('context',a);return a;});TP.core.Shell.Inst.defineMethod('updateCommandNode',function(c,e){var a,d,b;TP.debug('break.tsh_substitutions');if(TP.notValid(a=c.at('cmdNode'))){return c.fail();}if(!TP.isElement(a)){return c.fail();}d=a.attributes.length;for(b=0;b<d;b++){a.attributes[b].value=this.resolveVariableSubstitutions(a.attributes[b].value);}return a;});TP.core.Shell.Inst.defineMethod('updateExecutionInstance',function(d){var b,e,a,c;TP.debug('break.tsh_substitutions');b=this.getExecutionInstance();e=this.getType().POSITIONAL_MAX;for(a=0;a<e;a++){if(TP.notDefined(b.at('$'+a))){break;}delete b['$'+a];}c=d.stdin();b.atPut('$INPUT',c.at(0));if(d.at('cmdIterate')){b.atPut('$_',null);}else{b.atPut('$_',b.at('$INPUT'));for(a=0;a<c.length;a++){b.atPut('$'+a,c.at(a));}}return b;});TP.core.Shell.Inst.defineMethod('getArgument',function(g,e,h,i,b){var c,a,f,d;if(TP.notValid(c=this.getArguments(g,true))){return h;}if(TP.isValid(a=c.at(e))){if(e==='ARGV'){if(b){a=a.collect(function(a){return a.first();});}else{a=a.collect(function(a){return a.last();});}return a;}else{a=b?a.first():a.last();if(TP.isValid(a)){return a;}}}if(i){if(TP.isValid(a=c.at('ARG0'))){a=b?a.first():a.last();if(TP.isValid(a)){return a;}}f=g.at('cmdNode');if(TP.isElement(f)){if(TP.notEmpty(a=TP.nodeGetTextContent(f))){d=TP.ac(a,this.resolveVariableSubstitutions(TP.xmlEntitiesToLiterals(a)));c.atPut(e,d);a=b?d.first():d.last();return a;}}}return h;});TP.core.Shell.Inst.defineMethod('getArguments',function(b,d){var c,e,f,g,a;if(TP.isValid(a=b.get('ARGUMENTS'))){if(d){return a;}c=TP.hc();a.perform(function(d){var a,b,e;a=d.first();b=d.last();if(a!=='ARGV'){c.atPut(a,b.last());}else{e=b.collect(function(a){return a.last();});c.atPut(a,e);}});return c;}e=b.at('cmdNode');if(!TP.isElement(e)){TP.raise(this,'TP.sig.InvalidElement','Command node not an element.');return;}f=this;g=TP.elementGetAttributes(e);a=TP.hc();g.perform(function(l){var i,j,k,g,e,c,h;i=l.first();j=TP.xmlEntitiesToLiterals(l.last().trim());e=null;c=null;if(i==='tsh:argv'){k=TP.ac();g=TP.$tokenize(j,TP.tsh.script.$tshOperators,true,false,false,true);g=g.select(function(a){return a.name!=='space'&&a.name!=='tab';});g=g.collect(function(a){e=null;c=null;if(a.name==='number'){c=a.value.asNumber();}else if(a.name==='regexp'){h=a.value.split('/');c=TP.rc(h.at(1),h.at(2));}else if(a.name==='keyword'&&(a.value==='true'||a.value==='false')){c=TP.bc(a.value);}else if(a.name==='string'){if(a.value.charAt(0)==='"'){e=a.value.unquoted();}else if(a.value.charAt(0)==='\''){c=a.value;}else{c=a.value.unquoted();}}else if(a.name==='substitution'||a.name==='identifier'){e=a.value.unquoted();}else{c=a.value;}if(TP.isValid(e)&&TP.notValid(c)){c=TP.tsh.cmd.expandContent(e,f,b);if(c==='null'){c=null;}else if(c==='undefined'){c=undefined;}}if(d){return TP.ac(a.value,c);}else{return c;}});g.perform(function(b,c){a.atPut('ARG'+c,b);k.push(b);});a.atPut('ARGV',k);}else if(!TP.core.Shell.INVALID_ARGUMENT_MATCHER.test(i)){e=j;c=null;if(e==='true'||e==='false'){c=TP.bc(e);}else if(TP.regex.REGEX_LITERAL_STRING.test(e)){h=e.split('/');c=TP.rc(h.at(1),h.at(2));}else if(TP.regex.ANY_NUMBER.test(e)||TP.regex.PERCENTAGE.test(e)){c=e.asNumber();}else{if(e.charAt(0)==='"'){e=e.unquoted();}else if(e.charAt(0)==='\''){c=e;}else if(e.charAt(0)==='`'){}else{e=e.unquoted();}if(TP.isValid(e)&&TP.notValid(c)){c=TP.tsh.cmd.expandContent(e,f,b);if(c==='null'){c=null;}else if(c==='undefined'){c=undefined;}}}a.atPut(i,d?TP.ac(j,c):c);}});a.atPutIfAbsent('ARGV',TP.ac());b.set('ARGUMENTS',a);return a;});TP.core.Shell.Inst.defineMethod('getParam',function(b,c){var a;a=this.getParams(b);return a.at(c);});TP.core.Shell.Inst.defineMethod('getParams',function(b){var a,c,d;TP.debug('break.tsh_params');if(TP.isValid(a=b.get('PARAMS'))){return a;}c=b.at('cmdNode');if(!TP.isElement(c)){TP.raise(this,'TP.sig.InvalidElement','Command node not an element.');return;}d=this;a=TP.hc();TP.nodeChildElementsPerform(c,function(b){var c,e,d;if(TP.elementGetFullName(b)!=='tsh:param'){return;}if(TP.isEmpty(c=TP.elementGetAttribute(b,'tsh:name',true))){c=TP.nodeGetChildTextContent(b,'tsh:name');if(TP.isEmpty(c)){if(e=TP.nodeGetFirstElementChildByTagName(b,'tsh:name')){c=TP.wrap(e).getBoundInput();}if(TP.isEmpty(c)){TP.raise(b,'TP.sig.InvalidElement',arguments,'<param> tag has no name property or child.');return TP.BREAK;}}}if(TP.isEmpty(d=TP.elementGetAttribute(b,'tsh:value',true))){d=TP.nodeGetChildTextContent(b,'tsh:value');if(TP.isEmpty(d)){if(e=TP.nodeGetFirstElementChildByTagName(b,'tsh:value')){d=TP.wrap(e).getBoundInput();}if(TP.isEmpty(d)){TP.raise(b,'TP.sig.InvalidElement',arguments,'<param> tag has no value property'+' or child.');return TP.BREAK;}}}a.atPut(c,d);});b.set('PARAMS',a);return a;});TP.core.Shell.Inst.defineMethod('executeAbout',function(c){var a,b;a=TP.ifInvalid(this.get('announcement'),'');a+=TP.ifInvalid(this.get('introduction'),'');b=TP.sig.UserOutputRequest.construct(TP.hc('output',a,'cssClass','inbound_announce','cmdAsIs',true,'cmdBox',false,'cmdRecycle',true,'cmdID',c.at('cmdID')));b.fire(this);return;});TP.core.Shell.Inst.defineMethod('executeAlias',function(a){var c,d,b,e,f;TP.debug('break.tsh_alias');c=a.at('cmdShell');d=this.getArgument(a,'ARGV');switch(d.getSize()){case 0:a.stdout(c.get('aliases'));break;case 1:b=d.at(0);a.stdout(c.getAlias(b));break;case 2:b=d.at(0);e=d.at(1);if(e==='null'||e===b){c.unsetAlias(b);}else{c.setAlias(b,e);}a.stdout(c.getAlias(b));break;default:f=a.at('cmdNode');return a.fail(TP.FAILED,'Too many arguments: '+TP.str(f));}return a.complete();});TP.core.Shell.Inst.defineMethod('executeClear',function(b){var a;a=TP.sig.ConsoleRequest.construct(TP.hc('cmd','clear','cmdSilent',true));a.fire(this);return b.complete();});TP.core.Shell.Inst.defineMethod('executeFlag',function(b){var e,a,d,c;e=b.at('cmdNode');a=this.getArgument(b,'ARG0');d=this.getArgument(b,'ARG1');if(TP.isEmpty(a)){c=TP.hc();c.addAll(TP.sys.cfg());c.addAll(TP.sys.env());c.sort();b.stdout(c);}else if(TP.isEmpty(d)){if(a.indexOf('.')>-1){b.stdout(a+','+TP.sys.cfg(a));}else{b.stdout(TP.hc(TP.sys.cfg(a)).sort());}}else{if(TP.notDefined(TP.sys.get('configuration').at(a))){TP.ifWarn()?TP.warn('Unknown flag: '+a,TP.LOG,arguments):0;}TP.sys.setcfg(a,d);b.stdout(TP.sys.cfg(a));}return b.complete();});TP.core.Shell.Inst.defineMethod('executeSave',function(a){this.saveProfile();return a.complete();});TP.core.Shell.Inst.defineMethod('executeSet',function(a){var b,e,f,c,d;b=this.getArgument(a,'ARGV');if(b.getSize()===0){e=TP.hc(this.getExecutionInstance());a.stdout(e);return a.complete();}f=b.at(0);if(TP.isEmpty(f)){e=TP.hc(this.getExecutionInstance());a.stdout(e);return a.complete();}if(b.getSize()===1){this.unsetVariable(b.at(0));return a.complete();}c=b.slice(1).join(' ');if(TP.isNaN(d=parseFloat(c))){if(c.toLowerCase()==='false'){d=false;}else if(c.toLowerCase()==='true'){d=true;}else{d=c;}}this.setVariable(f,d);a.stdout(this.getVariable(f));return a.complete();});
TP.boot.$srcPath = '~lib_src/tibet/shells/TPShellExtensions.js';
TP.defineMetaTypeMethod('cmdFilterInput',function(a){a.complete(this);return;});TP.defineMetaTypeMethod('cmdTransformInput',function(a){a.complete(this);return;});Object.Type.defineMethod('cmdAddContent',function(a){this.raise('TP.sig.InvalidSink',arguments);return;});Object.Type.defineMethod('cmdGetContent',function(a){var c,b,d;if(TP.notValid(c=a.at('cmdInstance'))){b='No command instance.';return a.fail(TP.FAILURE,b);}if(TP.notValid(d=c.get('value'))){b='No content.';return a.fail(TP.FAILURE,b);}a.complete(d);return;});Object.Type.defineMethod('cmdRunContent',function(a){return this.tshExecute(a);});Object.Type.defineMethod('cmdSetContent',function(a){var d,b,e,c;if(TP.isEmpty(d=a.stdin())){b='No content.';return a.fail(TP.FAILURE,b);}if(TP.notValid(e=a.at('cmdInstance'))){b='No command instance.';return a.fail(TP.FAILURE,b);}c=d.first();e.set('value',c);a.complete(c);return;});Array.Type.defineMethod('cmdAddContent',function(a){var d,b,c;if(TP.isEmpty(d=a.stdin())){b='No content.';return a.fail(TP.FAILURE,b);}if(TP.notValid(c=a.at('cmdInstance'))){b='No command instance.';return a.fail(TP.FAILURE,b);}c.addAll(d);a.complete(c);return;});Array.Type.defineMethod('cmdSetContent',function(a){var d,b,c;if(TP.isEmpty(d=a.stdin())){b='No content.';return a.fail(TP.FAILURE,b);}if(TP.notValid(c=a.at('cmdInstance'))){b='No command instance.';return a.fail(TP.FAILURE,b);}c.length=0;c.addAll(d);a.complete(c);return;});RegExp.Type.defineMethod('cmdFilterInput',function(a){var f,c,g,d,b,e,h;TP.debug('break.tsh_filter');if(TP.isEmpty(f=a.stdin())){c='No content.';return a.fail(TP.FAILURE,c);}if(TP.notValid(e=a.at('cmdInstance'))){c='No command instance.';return a.fail(TP.FAILURE,c);}g=f.getSize();for(d=0;d<g;d++){b=f.at(d);if(TP.notValid(b)){continue;}if(a.at('cmdIterate')){if(TP.isCollection(b)){h=b.select(function(a){return e.test(TP.str(a));});a.stdout(h);}else{TP.ifWarn()?TP.warn('Splatting with non-collection content.',TP.LOG,arguments):0;if(e.test(TP.str(b))){a.stdout(TP.ac(b));}else{a.stdout(undefined);}}}else{if(e.test(TP.str(b))){a.stdout(b);}else{a.stdout(undefined);}}}a.complete();return;});RegExp.Type.defineMethod('cmdTransformInput',function(a){var i,h,k,f,c,b,j,e,d,g;TP.debug('break.tsh_transform');if(TP.isEmpty(i=a.stdin())){h='No content.';return a.fail(TP.FAILURE,h);}if(TP.notValid(b=a.at('cmdInstance'))){h='No command instance.';return a.fail(TP.FAILURE,h);}b.lastIndex=0;k=i.getSize();for(f=0;f<k;f++){c=i.at(f);if(TP.notValid(c)){continue;}if(a.at('cmdIterate')){if(TP.isCollection(c)){j=c.collect(function(a){if(b.global){e=TP.str(a);d=TP.ac();while(g=b.exec(e)){d.push(g);}return d;}else{return b.exec(TP.str(a));}});a.stdout(j);}else{TP.ifWarn()?TP.warn('Splatting with non-collection content.',TP.LOG,arguments):0;a.stdout(b.exec(TP.str(c)));}}else{if(b.global){e=TP.str(c);d=TP.ac();while(g=b.exec(e)){d.push(g);}a.stdout(d);}else{a.stdout(b.exec(TP.str(c)));}}}a.complete();return;});String.Type.defineMethod('cmdFilterInput',function(a){var f,d,h,i,g,e,b,j,c;TP.debug('break.tsh_filter');if(TP.isEmpty(f=a.stdin())){d='No content.';return a.fail(TP.FAILURE,d);}if(TP.notValid(h=a.at('cmdInstance'))){d='No command instance.';return a.fail(TP.FAILURE,d);}i=h.unquoted();g=f.getSize();for(e=0;e<g;e++){b=f.at(e);if(TP.notValid(b)){continue;}c=function(a){return TP.isValid(TP.objectValue(a,i));};if(a.at('cmdIterate')){if(TP.isCollection(b)){j=b.select(c);a.stdout(j);}else{TP.ifWarn()?TP.warn('Splatting with non-collection content.',TP.LOG,arguments):0;if(c(b)){a.stdout(b);}else{a.stdout(undefined);}}}else{if(c(b)){a.stdout(b);}else{a.stdout(undefined);}}}a.complete();return;});String.Type.defineMethod('cmdTransformInput',function(a){var i,e,k,b,j,f,c,g,h,d;TP.debug('break.tsh_transform');if(TP.isEmpty(i=a.stdin())){e='No content.';return a.fail(TP.FAILURE,e);}if(TP.notValid(k=a.at('cmdInstance'))){e='No command instance.';return a.fail(TP.FAILURE,e);}b=k.unquoted();j=i.getSize();for(f=0;f<j;f++){c=i.at(f);if(TP.notValid(c)){return b;}if(TP.regex.HAS_ACP.test(b)||TP.regex.SUBSTITUTION_STRING.test(b)){g=TP.ifInvalid(a.getPayload(),TP.hc());if(a.at('cmdIterate')){if(TP.isCollection(c)){d=c.collect(function(a){return b.transform(a,g);});a.stdout(d);break;}else{TP.ifWarn()?TP.warn('Splatting with non-collection content.',TP.LOG,arguments):0;a.stdout(TP.ac(b.transform(c,g)));}}else{a.stdout(b.transform(c,g));}}else{h=TP.isType(TP.sys.getTypeByName(b))?TP.format:TP.val;if(TP.isTrue(a.at('cmdIterate'))){if(TP.isCollection(c)){d=c.collect(function(a){return h(a,b);});a.stdout(d);break;}else{TP.ifWarn()?TP.warn('Splatting with non-collection content.',TP.LOG,arguments):0;a.stdout(TP.ac(h(c,b)));}}else{a.stdout(h(c,b));}}}a.complete();return;});TP.core.Node.Type.defineMethod('cmdAddContent',function(a){var d,b,e,c;if(TP.isEmpty(d=a.stdin())){b='No content.';return a.fail(TP.FAILURE,b);}if(TP.notValid(e=a.at('cmdInstance'))){b='No command instance.';return a.fail(TP.FAILURE,b);}c=d.first();e.addContent(c,a);a.complete(c);return;});TP.core.Node.Type.defineMethod('cmdGetContent',function(a){var c,b,d;if(TP.notValid(c=a.at('cmdInstance'))){b='No command instance.';return a.fail(TP.FAILURE,b);}if(TP.notValid(d=c.get('content'))){b='No content.';return a.fail(TP.FAILURE,b);}a.complete(d);return;});TP.core.Node.Type.defineMethod('cmdSetContent',function(a){var d,e,c,b;if(TP.isEmpty(d=a.stdin())){b='No content.';return a.fail(TP.FAILURE,b);}if(TP.notValid(e=a.at('cmdInstance'))){b='No command instance.';return a.fail(TP.FAILURE,b);}c=d.at(0);e.set('content',c,a);a.complete(c);return;});TP.core.XSLDocumentNode.Type.defineMethod('cmdTransformInput',function(a){var f,c,d,g,e,b,h;if(TP.isEmpty(f=a.stdin())){d='No content.';return a.fail(TP.FAILURE,d);}if(TP.notValid(c=a.at('cmdInstance'))){d='No command instance.';return a.fail(TP.FAILURE,d);}g=f.getSize();for(e=0;e<g;e++){b=f.at(e);if(TP.notValid(b)){continue;}if(a.at('cmdIterate')){if(TP.isCollection(b)){h=b.collect(function(b){return c.transform(b,a);});a.stdout(h);break;}else{TP.ifWarn()?TP.warn('Splatting with non-collection content.',TP.LOG,arguments):0;a.stdout(TP.ac(c.transform(b,a)));}}else{a.stdout(c.transform(b,a));}}a.complete();return;});TP.core.UICanvas.Type.defineMethod('cmdGetContent',function(a){var c,d,b;if(TP.notValid(c=a.at('cmdInstance'))){b='No command instance.';return a.fail(TP.FAILURE,b);}if(TP.notValid(d=c.getContentDocument())){b='No content.';return a.fail(TP.FAILURE,b);}return a.complete(d);});TP.core.UICanvas.Type.defineMethod('cmdSetContent',function(a){var d,e,b,c;if(TP.isEmpty(d=a.stdin())){b='No content.';return a.fail(TP.FAILURE,b);}if(TP.notValid(e=a.at('cmdInstance'))){b='No command instance.';return a.fail(TP.FAILURE,b);}c=TP.wrap(d.first());e.setContent(c,a);a.complete(c);return;});TP.core.URI.Type.defineMethod('cmdAddContent',function(a){return this.cmdRunContent(a,TP.ADD);});TP.core.URI.Type.defineMethod('cmdFilterInput',function(a){return this.cmdRunContent(a,TP.FILTER);});TP.core.URI.Type.defineMethod('cmdGetContent',function(a){return this.cmdRunContent(a,TP.GET);});TP.core.URI.Type.defineMethod('cmdRunContent',function(a,l){var c,j,g,e,k,h,f,b,d,i;TP.debug('break.tsh_uri');if(TP.notValid(c=a.at('cmdInstance'))){j='No command instance.';return a.fail(TP.FAILURE,j);}g=c.getLocation();e=TP.elementGetAttribute(a.at('cmdNode'),'tsh:pipe',true);b=TP.request(a.at('TP.tsh.uri.params'));b.atPut('cmdAction',a.at('cmdAction'));b.defineMethod('cancelJob',function(b,c){switch(arguments.length){case 1:this.$wrapupJob('Cancelled',TP.CANCELLED,b);return a.cancel(b);case 2:this.$wrapupJob('Cancelled',TP.CANCELLED,b,c);return a.cancel(b,c);default:this.$wrapupJob('Cancelled',TP.CANCELLED);return a.cancel();}});b.defineMethod('completeJob',function(d){var c;switch(arguments.length){case 1:this.$wrapupJob('Succeeded',TP.SUCCEEDED,d);return a.complete(d);default:c=b.getResult();if(TP.isDefined(c)){this.$wrapupJob('Succeeded',TP.SUCCEEDED,c);return a.complete(c);}else{this.$wrapupJob('Succeeded',TP.SUCCEEDED);return a.complete();}}});b.defineMethod('failJob',function(b,c){switch(arguments.length){case 1:this.$wrapupJob('Failed',TP.FAILED,b);return a.fail(b);case 2:this.$wrapupJob('Failed',TP.FAILED,b,c);return a.fail(b,c);default:this.$wrapupJob('Failed',TP.FAILED);return a.fail();}});switch(l){case TP.TRANSFORM:case TP.FILTER:f=/\?/.test(e)?'cmdFilterInput':'cmdTransformInput';b.defineMethod('handleRequestSucceeded',function(e){var b,d,c;b=e.getResult();if(TP.notValid(b)){c='Missing pipe resource: '+g;a.fail(TP.FAILURE,c);return;}else if(TP.canInvoke(b,f)){b=b[f](a);}else if(TP.canInvoke(b,'getType')){d=b.getType();if(TP.canInvoke(d,f)){a.atPut('cmdInstance',b);b=d[f](a);}}else{c='Incapable pipe resource: '+g;a.fail(TP.FAILURE,c);return;}if(TP.isDefined(b)){a.complete(b);}else{a.complete();}return;});c.getResource(b);return;case TP.SET:i=a.stdin().at(0);k=c.isLoaded()?TP.UPDATE:TP.CREATE;h=c.setResource(i);if(/!/.test(e)){h=null;b.atPut('crud',k);c.save(b);}else{b.complete(h);}return;case TP.ADD:if(/!/.test(e)){d=TP.request();d.defineMethod('handleRequestFailed',function(b){a.fail(TP.FAILURE,b.getResult());return;});d.defineMethod('handleRequestSucceeded',function(b){a.complete(b.getResult());return;});}b.defineMethod('handleRequestSucceeded',function(g){var b,f;f=g.getResult();b=a.stdin().at(0);if(/!/.test(e)){d.atPut('crud',TP.CREATE);c.save(d);c.addResource(f,b,d);}else{c.addResource(f,b,a);}return;});c.getResource(b);return;case TP.GET:default:c.getResource(b);break;}return;});TP.core.URI.Type.defineMethod('cmdSetContent',function(a){return this.cmdRunContent(a,TP.SET);});TP.core.URI.Type.defineMethod('cmdTransformInput',function(a){return this.cmdRunContent(a,TP.TRANSFORM);});TP.core.Window.Type.defineMethod('cmdAddContent',function(a){var b;if(TP.notValid(b=a.at('cmdInstance'))){return a.fail(TP.FAILURE,'No command instance');}return b.getDocument().getType().cmdAddContent(a);});TP.core.Window.Type.defineMethod('cmdGetContent',function(a){var b;if(TP.notValid(b=a.at('cmdInstance'))){return a.fail(TP.FAILURE,'No command instance');}return b.getDocument().getType().cmdGetContent(a);});TP.core.Window.Type.defineMethod('cmdSetContent',function(a){var b;if(TP.notValid(b=a.at('cmdInstance'))){return a.fail(TP.FAILURE,'No command instance');}return b.getDocument().getType().cmdSetContent(a);});
TP.boot.$srcPath = '~lib_src/tibet/shells/TSH.js';
TP.core.Shell.defineSubtype('TSH');TP.core.TSH.Type.defineConstant('ACTION_PREFIX',':');TP.core.TSH.Type.defineConstant('ESCAPE_PREFIX','*');TP.core.TSH.Type.defineConstant('COMMAND_SPLIT_REGEX',/\n([-a-zA-Z_0-9]*?):([-a-zA-Z_0-9]*?)($|\s)/g);TP.core.TSH.Type.defineConstant('COMMAND_START_REGEX',/^([-a-zA-Z_0-9]*?):([-a-zA-Z_0-9]*?)($|\s)/);TP.core.TSH.Type.defineConstant('AWAKEN_PHASES',TP.ac('AwakenDOM','AwakenEvents','AwakenData','AwakenInfo','AwakenBinds','AwakenStyle'));TP.core.TSH.Type.defineConstant('CACHE_PHASES',TP.ac('Includes','Instructions','Precompile','Compile','Tidy','Marshal','Store','Load','Unmarshal','Localize','Optimize','Finalize'));TP.core.TSH.Type.defineConstant('COMPILE_PHASES',TP.ac('Includes','Instructions','Precompile','Compile'));TP.core.TSH.Type.defineConstant('EXECUTE_PHASES',TP.ac());TP.core.TSH.Type.defineConstant('NOCACHE_PHASES',TP.ac('Includes','Instructions','Precompile','Compile','Tidy','Localize','Optimize','Finalize'));TP.core.TSH.Type.defineConstant('REVIVE_PHASES',TP.ac('Unmarshal','Localize','Optimize','Finalize'));TP.core.TSH.set('commandPrefix','tsh');TP.core.TSH.register();TP.core.TSH.Type.defineMethod('initialize',function(){TP.core.TSH.Inst.defineAttribute('goodbye','logged out at '+TP.dc().toLocaleString());return;});TP.core.TSH.Type.defineMethod('handleActivationKeyUp',function(a){return TP.core.Window.open('~tdc_html/home.html');});TP.core.TSH.Inst.defineAttribute('context');TP.core.TSH.Inst.defineAttribute('watchArray',TP.ac());TP.core.TSH.Inst.defineAttribute('watchHash',TP.hc());TP.core.TSH.Inst.defineAttribute('commandXMLNS','tsh:');TP.core.TSH.Inst.defineAttribute('xpathVizController');TP.core.TSH.Inst.defineAttribute('testing',false);TP.core.TSH.Inst.defineAttribute('testCount',0);TP.core.TSH.Inst.defineAttribute('testID');TP.core.TSH.Inst.defineAttribute('testOk',true);TP.core.TSH.Inst.defineAttribute('testVerbose',false);TP.core.TSH.Inst.defineAttribute('announcement',TP.join('TIBET&#8482; Interactive Web Shell (TP.core.TSH) ',TP.sys.getLibVersion(),'\n','Copyright (C) 1999, Technical Pursuit Inc, ','All Rights Reserved. Patents Pending.'));TP.core.TSH.Inst.defineAttribute('introduction',null);TP.core.TSH.Inst.defineMethod('init',function(b,c){var a;this.callNextMethod();a=this.get('commandXMLNS');this.setPrompt(a.chop(':')+'&nbsp;&#187;');this.$set('commandXMLNS',TP.sys.require(a));return this;});TP.core.TSH.Inst.defineMethod('isLoginShell',function(c){var a,b;a=this.get('request');if(TP.isValid(a)){b=a.atIfInvalid('cmdLogin',false);return b;}else{return this.callNextMethod();}});TP.core.TSH.Inst.defineMethod('login',function(e){var c,b,a,d;a=this;if(TP.notEmpty(c=e.at('username'))){b=c;}else if(TP.notEmpty(c=TP.sys.getEffectiveUser())){b=c.get('shortname');a.initProfile();}else if(TP.notEmpty(c=TP.core.Cookie.getCookie('username'))){try{b=c.unquoted();}catch(a){}}b=TP.ifEmpty(b,'');this.set('username',b);d=TP.sig.UserInputRequest.construct(TP.hc('query','username:','default',b,'async',true));d.defineMethod('handleUserInput',function(d){var b,c,e;if(TP.isValid(e=d.getRequest().get('responder'))){d.getRequestID().signal('TP.sig.RequestCompleted');}c=d.getResult();if(TP.notValid(c)||c.getSize()<TP.core.Shell.MIN_USERNAME_LEN){a.isRunning(false);b=TP.sig.UserOutputRequest.construct(TP.hc('output','Invalid username. Must be '+TP.core.Shell.MIN_USERNAME_LEN+' chars or more.','async',true));b.isError(true);b.fire(a);return;}b=TP.sig.UserInputRequest.construct(TP.hc('username',c,'query',c+' password:','default',null,'hideInput',true,'async',true));b.defineMethod('handleUserInput',function(b){var c,d,e,f;if(TP.isValid(f=b.getRequest().get('responder'))){b.getRequestID().signal('TP.sig.RequestCompleted');}d=b.getResult();if(TP.notValid(d)||!d.equalTo(this.at('username'))){a.isRunning(false);c=TP.sig.UserOutputRequest.construct(TP.hc('output','Login failed.'+' Defaulting requestor settings.'+' Use :login to try again.'));c.isError(true);c.fire(a);return;}TP.core.User.construct(this.at('username'));a.isRunning(true);a.setVariable('USER',this.at('username'));TP.core.Cookie.setCookie('username',this.at('username'),TP.dc().addDuration('P1Y'));TP.sig.UserOutputRequest.construct(TP.hc('output','<br/>','render',true)).fire(a);e=Number.random().toString();TP.sig.UserOutputRequest.construct(TP.hc('output','Loading and initializing user profile'+' data for user '+b.getResult()+'...','cssClass','inbound_announce','render',true,'threadID',e)).fire(a);(function(){a.initProfile();a.signal('TP.sig.TSH_Login');}.fork(20));return;});b.fire(a);return;});d.fire(a);return this;});TP.core.TSH.Inst.defineMethod('handle',function(a){if(TP.boot.isUA('GECKO')&&TP.isTrue(this.getVariable('PRIVILEGED'))&&TP.sys.shouldRequestPrivileges()){try{if(TP.sys.cfg('log.privilege_requests')){TP.sys.logSecurity('Privilege request at '+'handle',TP.TRACE,arguments);}netscape.security.PrivilegeManager.enablePrivilege('UniversalBrowserRead '+'UniversalBrowserWrite '+'UniversalXPConnect');}catch(a){this.setVariable('PRIVILEGED',false);TP.sys.logSecurity(TP.join('Enhanced privileges refused. Setting PRIVILEGED to',' false.\n','You may need signed.applets.codebase_principal_support\n','set to true. See the TIBET installation guide for more.'),TP.WARN,arguments);}}return this.callNextMethod();});TP.core.TSH.Inst.defineMethod('handleShellRequest',function(a){a.atPut('PID',this.getNextPID());return this.callNextMethod();});TP.core.TSH.Inst.defineMethod('handleShellRequestCompleted',function(f){var a,b,d,e,c;TP.debug('break.shell_response');a=f;b=a.getRequest();d=b.get('$timestart');e=Date.now();c=e-d;b.set('$exectime',TP.isNaN(c)?0:c);return a;});TP.core.TSH.Inst.defineMethod('shouldComputeCosts',function(a){if(TP.isBoolean(a)){this.setVariable('COMPUTE_COSTS',a);}return TP.ifInvalid(this.getVariable('COMPUTE_COSTS'),false);});TP.core.TSH.Inst.defineMethod('translateSymbol',function(b){var c,a;if(TP.notValid(b)){return;}c=b.charAt(0);switch(c){case'@':a='commat';break;case'\\':a='bsol';break;case'`':a='grave';break;case'#':a='num';break;case'!':a='excl';break;case'~':a='tilde';break;case'/':a='sol';break;case'&':a='amp';break;case'%':a='percnt';break;case'=':a='equals';break;case'.':a='period';break;case'^':a='circ';break;case'?':a='quest';break;case'$':a='dollar';break;case'*':a='ast';break;case':':a='colon';break;case',':a='comma';break;case'<':a='lt';break;case'>':a='gt';break;case'|':a='brvbar';break;default:return b;}return a+b.slice(1);});TP.core.TSH.Inst.defineMethod('execute',function(a){var b,l,q,e,h,k,d,f,c,p,o,j,m,i,g,n;TP.debug('break.shell_execute');if(TP.notValid(a)){return;}a.set('result',undefined);a.set('$timestart',Date.now());if(TP.notValid(b=a.at('cmd'))){if(TP.notValid(b=a.at('cmdNode'))){return a.fail(TP.FAILURE,'Invalid request input.');}a.atPut('cmd',TP.nodeAsString(b,false,true));}if(TP.notValid(l=a.get('response'))){return a.fail(TP.FAILURE,'No response object found.');}l.atPut('creations','off');l.set('messageType','response');if(TP.isTrue(a.at('cmdHistory'))){q=this.addHistory(a);a.atPut('cmdHistoryID',q);}a.atPut('cmdPhase','Construct');if(TP.isString(b)){if(TP.isEmpty(b=b.trim())){return a.complete();}if(/^(\w)*:$/.test(b)){if(TP.isType(e=TP.sys.require(b))){this.$set('commandXMLNS',e);this.setPrompt(b.chop(':')+'&nbsp;&#187;');return a.complete();}else{return a.fail(TP.FAILURE,'Unable to switch to XMLNS '+b);}}if(TP.isValid(e=a.at('cmdXMLNS'))){e=TP.sys.require(e);if(TP.notValid(e)){return a.fail(TP.FAILURE,'Unable to find XMLNS type: '+a.at('cmdXMLNS'));}}else{e=this.get('commandXMLNS');if(TP.notValid(e)){e=TP.sys.require('tsh:');}}if(TP.canInvoke(e,'getTSHScriptTag')){h=e.getTSHScriptTag();}else{h=e.getTagName()+'script';}k=TP.sys.require(h);if(TP.notValid(k)||!TP.canInvoke(k,'$xmlifyContent')){return a.fail(TP.FAILURE,'Unable to find tag type: '+h);}b=k.$xmlifyContent(b,this,a);d=TP.nodeFromString(TP.join('<',h,'>',b,'</',h,'>'),false);if(TP.notValid(d)){d=TP.nodeFromString(TP.join('<',h,'><![CDATA[',b,']]></',h,'>'));}if(TP.notValid(d)){return a.fail(TP.FAILURE,'Unable to create command XML: "'+b+'".');}}else if(!TP.isNode(d=b)){return a.fail(TP.FAILURE,'Invalid command: "'+b+'".');}if(TP.isDocument(d)){f=d;if(TP.notValid(d)){return a.fail(TP.FAILURE,'Unable to process empty document.');}}else{if(TP.nodeIsDetached(d)){f=TP.createDocument('','request');f.documentElement.appendChild(d);}else{f=TP.nodeGetDocument(d);}}a.atPut('cmdRoot',d);c=a.atIfInvalid('cmdPhases','nocache');if(TP.isString(c)){c=this.getType()[c.toUpperCase()+'_PHASES'];if(TP.notValid(c)){TP.ifWarn()?TP.warn('Invalid phase set in request: '+a.at('cmdPhases'),TP.LOG,arguments):0;c=this.getType().NOCACHE_PHASES;}}else if(!TP.isArray(c)){return a.fail(TP.FAILURE,'Invalid phase definition: '+c+'.');}p=TP.ifKeyInvalid(a,'targetPhase',c.last());j=0;m=a.atIfInvalid('cmdPhaseMax',c.getSize()*2);a.atPut('cmdPhases',c);if(TP.notEmpty(c)){o=TP.nodeGetStartPhase(d,c,a.at('cmdRoot'));a.atPut('cmdPhase',c.at(c.getPosition(o)));do{j++;i=a.at('cmdRoot');if(TP.nodeIsDetached(i,f)){TP.debug('break.node_detached');g=a.at('cmdNode');if(TP.nodeIsDetached(g,f)){return a.fail(TP.FAILURE,a.at('cmdPhase')+' cycle node detached: '+TP.str(g,false));}a.atPut('cmdRoot',g);}else{a.atPut('cmdNode',i);}if(TP.nodeHasReachedPhase(a.at('cmdRoot'),p,c,a.at('cmdRoot'))){break;}a.atPut('nextPhase',null);this.$runPhase(a);TP.elementSetAttributeInNS(TP.elem(a.at('cmdRoot')),'tibet:phase',a.at('cmdPhase'),TP.w3.Xmlns.TIBET);n=TP.ifInvalid(a.at('nextPhase'),a.at('cmdPhases').after(a.at('cmdPhase')));a.atPut('cmdPhase',n);}while(j<m&&TP.isValid(n)&&a.isRunnable());}if(TP.notEmpty(c)&&j>=m){return a.fail(TP.FAILURE,'Terminated content processing: content.phase_max exceeded.');}else if(a.didComplete()){return a;}if(a.atIfInvalid('cmdExecute',false)){i=a.at('cmdRoot');if(TP.nodeIsDetached(i,f)){g=a.at('cmdNode');if(TP.nodeIsDetached(g,f)){return a.fail(TP.FAILURE,'Execution cycle node detached: '+TP.str(g,false));}a.atPut('cmdRoot',g);}else{a.atPut('cmdNode',i);}a.atPut('cmdExpansion',TP.nodeAsString(a.at('cmdRoot'),true,false));a.atPut('cmdPhase','Execute');this.$runPhase(a);}if(!a.didComplete()&&a.canComplete()){if(TP.notValid(a.get('result'))){a.set('result',a.at('cmdRoot'));}if(a.at('cmdPhase')==='Execute'){a.complete(a.get('result'));}else{a.complete();}}return a;});TP.core.TSH.Inst.defineMethod('$runPhase',function(a){var f,b,e,c,d,g;f=a.at('cmdPhases');b=a.at('cmdPhase');if(TP.isEmpty(b)){return;}TP.ifTrace(TP.sys.cfg('log.tsh_phases'))?TP.trace(Date.now()+' TP.core.TSH '+b,TP.LOG,arguments):0;e=a.at('cmdNode');if(TP.notValid(e)){return;}c=TP.nodeGetDocument(e);g=this;d='tsh'+b;TP.nodeDepthTraversal(e,function(g){var j,i,h,e,l,k;j=TP.core.Node.getConcreteType(g);if(TP.notValid(j)){return;}if(TP.canInvoke(j,d)){if(TP.nodeHasReachedPhase(g,b,f)){TP.ifTrace(TP.$VERBOSE&&TP.sys.cfg('log.tsh_phases')&&TP.sys.cfg('log.tsh_phase_skips'))?TP.trace('TP.core.TSH '+b+' skipping: '+TP.name(j)+' '+TP.nodeAsString(g,false,true),TP.LOG,arguments):0;if(TP.isElement(e=TP.nodeGetFirstChildElement(g))){h=e;}else{if(TP.isElement(e=TP.nodeGetFirstSiblingElement(g))){h=e;}else{e=g.parentNode;h=TP.ac(e,TP.CONTINUE);}}}else{a.atPut('cmdNode',g);TP.ifTrace(TP.$VERBOSE&&TP.sys.cfg('log.tsh_phases')&&TP.sys.cfg('log.tsh_phase_nodes'))?TP.trace(Date.now()+' TP.core.TSH '+b+' nodetype: '+TP.name(j)+' '+TP.nodeAsString(g,false,true),TP.LOG,arguments):0;TP.debug('break.tsh_phase_exec');try{h=j[d](a);}catch(b){k='Error running '+TP.name(j)+'.'+d;TP.error(k+': '+b.message);return a.fail(TP.FAILURE,TP.ec(b,k));}}if(TP.isArray(h)){e=h.at(0);i=h.at(1);}else if(TP.isNode(h)){e=h;}else if(TP.notValid(h)){h=TP.DESCEND;i=TP.DESCEND;}if(TP.isNode(e)){l=a.at('cmdRoot');if(g===l){if(TP.nodeIsDetached(l,c)){if(TP.nodeContainsNode(l,e)){}else{a.atPut('cmdRoot',e);if(TP.notValid(i)){i=TP.REPEAT;}}}else{if(TP.nodeIsDetached(e,c)){}else{if(TP.notValid(i)){i=TP.REPEAT;}}}}else{if(TP.nodeIsDetached(e,c)){TP.nodeReplaceChild(g.parentNode,e,g,false);}}if(TP.notValid(i)){i=TP.CONTINUE;}a.atPut('cmdNode',e);}else if(i!==TP.BREAK){if(TP.nodeIsDetached(g,c)){TP.debug('break.node_detachment');k='TP.core.TSH '+b+' node detached: '+TP.nodeAsString(g,false);TP.error(k);return a.fail(TP.FAILURE,k);}}}else{TP.ifTrace(TP.$VERBOSE&&TP.sys.cfg('log.tsh_phases')&&TP.sys.cfg('log.tsh_phase_skips'))?TP.trace('TP.core.TSH '+b+' skipping: '+TP.name(j)+' '+TP.nodeAsString(g,false,true),TP.LOG,arguments):0;}return h;},null,function(e){var h,k,f,g,j,i;if(e.nodeType!==Node.PROCESSING_INSTRUCTION_NODE){return;}h=TP.core.Node.getConcreteType(e);if(TP.notValid(h)){return;}if(TP.canInvoke(h,d)){a.atPut('cmdNode',e);TP.ifTrace(TP.$VERBOSE&&TP.sys.cfg('log.tsh_phases')&&TP.sys.cfg('log.tsh_phase_nodes'))?TP.trace(Date.now()+' TP.core.TSH '+b+' nodetype: '+TP.name(h)+' '+TP.nodeAsString(e,false,true),TP.LOG,arguments):0;TP.debug('break.tsh_phase_exec');try{f=h[d](a);}catch(b){i='Error running '+TP.name(h)+'.'+d;TP.error(i+': '+b.message);return a.fail(TP.FAILURE,TP.ec(b,i));}if(TP.isArray(f)){g=f.at(0);k=f.at(1);}else if(TP.isNode(f)){g=f;k=f;}if(TP.isNode(g)){j=a.at('cmdRoot');if(e===j){if(TP.nodeIsDetached(j,c)||!TP.nodeContainsNode(j,g)){a.atPut('cmdRoot',g);}}else{if(TP.nodeIsDetached(g,c)){TP.nodeReplaceChild(e.parentNode,g,e,false);}}a.atPut('cmdNode',g);}else if(k!==TP.BREAK){if(TP.nodeIsDetached(e,c)){TP.debug('break.node_detachment');i='TP.core.TSH '+b+' node detached: '+TP.nodeAsString(e,false);TP.error(i);return a.fail(TP.FAILURE,i);}}}else{TP.ifTrace(TP.$VERBOSE&&TP.sys.cfg('log.tsh_phases')&&TP.sys.cfg('log.tsh_phase_skips'))?TP.trace('TP.core.TSH '+b+' skipping: '+TP.name(h)+' '+TP.nodeAsString(e,false,true),TP.LOG,arguments):0;}return f;});return a;});TP.core.TSH.Inst.defineMethod('executeEcho',function(a){var b;b=this.getArgument(a,'ARGV');a.stdout(b.join(' '));return a.complete();});TP.core.TSH.Inst.defineMethod('executeLog',function(a){a.stdout(TP.sys.getActivityLog());return a.complete();});TP.core.TSH.Inst.defineMethod('executeLogin',function(a){var b,c;b=this.getArgument(a,'ARGV');if(TP.notEmpty(c=b.first())){a.atPut('username',c);this.login(a);}return a.complete();});TP.core.TSH.Inst.defineMethod('executeLogout',function(b){var a;this.logout();a=TP.sig.UserOutputRequest.construct(TP.hc('output','Logging out user '+this.get('username'),'cssClass','inbound_announce','cmdAsIs',true,'cmdBox',false,'cmdRecycle',true,'cmdID',b.at('cmdID')));a.fire(this);return;});TP.core.TSH.Inst.defineMethod('executeSort',function(a){});TP.core.TSH.Inst.defineMethod('executeUniq',function(a){});TP.core.TSH.Inst.defineMethod('executeBreak',function(a){});TP.core.TSH.Inst.defineMethod('executeExpect',function(a){});TP.core.TSH.Inst.defineMethod('executeWatch',function(a){});TP.core.TSH.Inst.defineMethod('executeJob',function(a){});TP.core.TSH.Inst.defineMethod('executeKill',function(a){});TP.core.TSH.Inst.defineMethod('executeAs',function(a){var h,c,g,d,i,e,b,f;if(TP.notValid(h=a.at('cmdNode'))){return a.fail();}if(TP.isEmpty(g=a.stdin())){return a.fail(TP.FAILURE,'Unable to find input for: '+TP.str(h));}c=this.getArgument(a,'tsh:format',null,true);d=this.getArgument(a,'tsh:repeat',false,true);i=g.getSize();for(e=0;e<i;e++){b=g.at(e);if(TP.isTrue(a.at('cmdIterate'))){if(TP.canInvoke(b,'collect')){f=b.collect(function(a){return TP.format(a,c,TP.hc('repeat',d));});}else{f=TP.format(b,c,TP.hc('repeat',d));}}else{f=TP.format(b,c,TP.hc('repeat',d));}a.stdout(f);}a.complete();return;});TP.core.TSH.Inst.defineMethod('executeDump',function(a){var c,b;c=this.getArgument(a,'ARG0');b=this.resolveObjectReference(c,a);if(TP.isValid(b)){a.stdout(b,TP.request('cmdTitle',TP.name(b)));a.complete();}else{a.fail();}return;});TP.core.TSH.Inst.defineMethod('executeEdit',function(b){var a,d,c,e;a=this.getArgument(b,'ARG0');if(TP.regex.URI_LIKELY.test(a)&&!TP.regex.REGEX_LITERAL_STRING.test(a)){d=this.expandPath(a);if(TP.isURI(d=TP.uc(d))){c=d;}else{c=this.resolveObjectReference(a,b);}}else{c=this.resolveObjectReference(a,b);}if(TP.isValid(c)){if(TP.isValid(e=TP.byOID('DeveloperEditor'))){e.setContentObject(c);e.navigateToEditorScreen();b.complete();return;}}b.fail();return;});TP.core.TSH.Inst.defineMethod('executeScreen',function(b){var a,c;c=this.getArgument(b,'ARG0');a=TP.byOID('DeveloperPortal');a.toggleZoomed();a.setCurrentScreenCell('screen_'+c+'_cell');a.toggleZoomed();b.complete();});TP.core.TSH.Inst.defineMethod('executeInspect',function(a){});TP.core.TSH.Inst.defineMethod('executeReflect',function(b){var k,j,a,g,f,c,e,h,d,i;if(TP.notValid(k=b.at('cmdNode'))){return b.fail();}j=b.at('cmdShell');a=this.getArgument(b,'tsh:ref',null,true);if(TP.notValid(a)){if(TP.isEmpty(a=b.stdin())){return b.fail(TP.FAILURE,'Unable to find type reference: '+TP.str(a));}}if(TP.isValid(a=this.resolveObjectReference(a,b))){g=TP.stypes(a).collect(function(a){return TP.name(a);});if(TP.canInvoke(a,'getSubtypes')){f=a.getSubtypes().collect(function(a){return TP.name(a);});}c=a.getInterface('known_inherited').sort();c.convert(function(b){if(TP.isMethod(a[b])){return b+' ('+TP.name(a[b][TP.OWNER])+')';}return b;});if(TP.isType(a)){e=TP.hc('Supertypes',g,'Subtypes',f,'Local',a.getInterface('known_local').sort(),'Introduced',a.getInterface('known_introduced').sort(),'Inherited',c,'Overridden',a.getInterface('known_overridden').sort());}else{e=TP.hc('Supertypes',g,'Subtypes',f);h=TP.hc('Local',a.getInterface('known_local').sort(),'Introduced',a.getInterface('known_introduced').sort(),'Inherited',c,'Overridden',a.getInterface('known_overridden').sort());e.atPut('Instance',h);d=a.getType();c=d.getInterface('known_inherited').sort();c.convert(function(b){if(TP.isMethod(a[b])){return b+' ('+TP.name(a[b][TP.OWNER])+')';}return b;});i=TP.hc('Local',d.getInterface('known_local').sort(),'Introduced',d.getInterface('known_introduced').sort(),'Inherited',c,'Overridden',d.getInterface('known_overridden').sort());e.atPut('Type',i);}b.stdout(e);}else{return b.fail(TP.FAILURE,'Unable to resolve object reference '+a);}b.complete();return;});TP.core.TSH.Inst.defineMethod('executeEntity',function(a){var b,c;b=this.getArgument(a,'ARG0');if(TP.isValid(b)){c='&#'+b.replace(';','')+';';a.atPut('cmdAsIs',true);a.stdout(c);}else{a.stdout('Entity table dump not yet implemented.');a.complete();}});TP.core.TSH.Inst.defineMethod('executeExport',function(c){var d,f,e,a,g,b;d=this.getArgument(c,'tsh:href',null,true);if(TP.isEmpty(d)){return c.fail(TP.FAILURE,'Unable to determine target url.');}f=TP.uriExtension(d);if(TP.isEmpty(f)){d=d+'.tsh';}e=TP.uc(d);if(TP.notValid(e)){return c.fail(TP.FAILURE,'Invalid target url.');}a=TP.elementGetAttribute(c.at('cmdNode'),'tsh:hid',true);a=TP.ifEmpty(a,-2);a=parseInt(a,10);if(TP.notValid(a)||TP.isNaN(a)){return c.fail(TP.FAILURE,'Invalid target history.');}g=this.$get('history').at(a);b=g.at('cmdExpansion');b=TP.XML_10_UTF8_HEADER+b;b=b.replace(/>/g,'>\n');c.stdout(b);e.setContent(b,TP.request('resultType',TP.TEXT));e.save(TP.request('verb',TP.HTTP_PUT));return;});TP.core.TSH.Inst.defineMethod('executeImport',function(a){var r,q,l,b,k,h,g,c,d,m,f,n,o,p,j,i,e;if(TP.notValid(r=a.at('cmdNode'))){return a.fail();}q=a.at('cmdShell');l=a.at('rootRequest');b=this.getArgument(a,'tsh:href',null,true);if(TP.notValid(b)){if(TP.isEmpty(b=a.stdin())){return a.fail(TP.FAILURE,'Unable to find reference for '+TP.str(g));}}else{b=TP.ac(b);}k=b.getSize();for(h=0;h<k;h++){g=b.at(h);c=TP.boot.$$loadpaths.grep(g);if(TP.isEmpty(c)){c=TP.ac(g);}if(c.getSize()>1){a.fail(TP.FAILURE,'Multiple choices: '+TP.src(c));continue;}d=c.collapse();try{m=TP.sys.shouldLogCodeChanges();TP.sys.shouldLogCodeChanges(false);l.stdout('tsh:import loading source from '+d,a);f=TP.uc(d);if(TP.notValid(f)){a.fail(TP.FAILURE,'tsh:import failed to load '+d);continue;}if(TP.notValid(n=f.getContent(TP.hc('refresh',true,'async',false)))){a.fail(TP.FAILURE,'tsh:import failed to load '+d);continue;}o=TP.sys.shouldUseDebugger();TP.sys.shouldUseDebugger(false);TP.boot.$sourceImport(n,null,TP.str(f),null,true);p=f.getLocation();j=TP.uriName(p);i=j.slice(0,j.lastIndexOf('.'));i=i.replace(/_/,':');if(TP.isType(e=i.asType())&&!e.isInitialized()&&e.ownsMethod('initialize')){try{e.initialize();e.isInitialized(true);}catch(a){this.raise('TP.sig.InitializationException',arguments,'Unable to initialize '+e.getName());}}}catch(b){a.fail(TP.FAILURE,TP.ec(b,'tsh:import failed to load '+d));continue;}finally{TP.sys.shouldLogCodeChanges(m);TP.sys.shouldUseDebugger(o);}}a.complete(f);return;});TP.core.TSH.Inst.defineMethod('executeSource',function(a){var p,o,k,c,j,h,e,d,b,i,l,g,m,n,f;if(TP.notValid(p=a.at('cmdNode'))){return a.fail();}o=a.at('cmdShell');k=a.at('rootRequest');c=this.getArgument(a,'tsh:ref',null,true);if(TP.notValid(c)){if(TP.isEmpty(c=a.stdin())){return a.fail(TP.FAILURE,'Unable to find reference for '+TP.str(c));}}else{c=TP.ac(c);}j=c.getSize();for(h=0;h<j;h++){e=c.at(h);d=this.resolveObjectReference(e,a);if(TP.notValid(d)){a.fail(TP.FAILURE,'Unable to resolve object reference '+e);continue;}if(TP.isNode(i=TP.objectGetLoadNode(d))&&(TP.notEmpty(b=TP.elementGetAttribute(i,'src'))||TP.notEmpty(b=TP.elementGetAttribute(i,'source')))){try{l=TP.sys.shouldLogCodeChanges();TP.sys.shouldLogCodeChanges(false);k.stdout('tsh:source loading source from '+b,a);g=TP.uc(b);if(TP.notValid(g)){a.fail(TP.FAILURE,'tsh:source failed to load '+b);continue;}if(TP.notValid(m=g.getContent(TP.hc('refresh',true,'async',false)))){a.fail(TP.FAILURE,'tsh:source failed to load '+b);continue;}n=TP.sys.shouldUseDebugger();TP.sys.shouldUseDebugger(false);TP.boot.$sourceImport(m,null,b,null,true);if(TP.isType(d)){f=d;}else{f=d.getType();}if(TP.owns(f,'initialize')){f.initialize();}}catch(c){a.fail(TP.FAILURE,TP.ec(c,'tsh:source failed to eval '+b));continue;}finally{TP.sys.shouldLogCodeChanges(l);TP.sys.shouldUseDebugger(n);}}else{a.fail(TP.FAILURE,'Object '+e+' source file not found.');continue;}}a.complete(g);return;});TP.core.TSH.Inst.defineMethod('executeBuiltins',function(a){});TP.core.TSH.Inst.defineMethod('executeGlobals',function(b){var a;a=TP.$getOwnKeys(window);a=a.select(function(a){if(TP.isFunction(window[a])&&(window[a][TP.TRACK]==='Global'||window[a][TP.TRACK]==='Local')){return true;}return false;});b.stdout(a.sort().join('\n'));b.complete(a);});TP.core.TSH.Inst.defineMethod('executeHelp',function(a){});TP.core.TSH.Inst.defineMethod('executeShorts',function(b){var a;a=TP.$getOwnKeys(window);a=a.select(function(a){if(a.indexOf('$')===0&&TP.isFunction(window[a])&&(window[a][TP.TRACK]==='Global'||window[a][TP.TRACK]==='Local')){return true;}return false;});b.stdout(a.sort().join('\n'));b.complete(a);return;});TP.core.TSH.Inst.defineMethod('executeTypes',function(a){var d,e,c,b;if(TP.notValid(d=a.at('cmdNode'))){return a.fail();}e=a.at('cmdShell');b=TP.sys.getCustomTypes().getKeys();c=this.getArgument(a,'tsh:includeNative');if(TP.isValid(c)&&TP.isTrue(TP.bc(c))){b.addAll(TP.sys.getNativeTypes().getKeys());}if(TP.notEmpty(b)){a.stdout(b.sort());}a.complete();return;});TP.core.TSH.Inst.defineMethod('executeOpen',function(a){});TP.core.TSH.Inst.defineMethod('executeSleep',function(b){var a;a=this.getArgument(b,'tsh:ms',TP.sys.cfg('tsh.sleep_default',1000),true);a=Math.max(a,TP.sys.cfg('tsh.sleep_max',30000));setTimeout(function(){b.complete();},a);return;});TP.core.TSH.Inst.defineMethod('executeWait',function(a){});TP.core.TSH.Inst.defineMethod('executeTibet',function(b){var e,f,d,a,c,g;e=this.getArgument(b,'tsh:cmd',null,true);if(TP.isEmpty(e)){e='help';}a=TP.uriJoinPaths(TP.sys.getLaunchRoot(),TP.sys.cfg('tds.cli_uri'));a+='?cmd='+encodeURIComponent(e);d=this.getArgument(b,'ARGV');if(TP.notEmpty(d)){d.shift();if(TP.notEmpty(d)){a+='&argv='+encodeURIComponent(d.join(' '));}}f=this.getArguments(b);f.perform(function(d){var b;var c;b=d.first();c=d.last();if(/^ARG/.test(b)){return;}if(/tsh:/.test(b)){b=b.slice(4);}a+='&'+encodeURIComponent(b);if(TP.notEmpty(c)){if(c!==true){a+='='+encodeURIComponent((''+c).stripEnclosingQuotes());}}});a=TP.uc(a);if(TP.notValid(a)){return b.fail(TP.FAILURE,'Invalid request input.');}c=TP.sig.HTTPRequest.construct(TP.hc('uri',a,'verb',TP.HTTP_POST));c.defineMethod('handleRequestSucceeded',function(){b.stdout(c.getResult());b.complete();});c.defineMethod('handleRequestFailed',function(){b.stderr(c.getResult());b.complete();});g=c.fire();});TP.sig.SourceSignal.defineSubtype('FileChangedEvent');TP.sig.FileChangedEvent.Type.defineConstant('NATIVE_NAME',TP.sys.cfg('tds.watch_event'));TP.sig.FileChangedEvent.Type.defineAttribute('pending',TP.hc());TP.core.TSH.Inst.defineMethod('executeChangedFS',function(a){var b;b=TP.sig.FileChangedEvent.get('pending');a.stdout(TP.str(b));a.complete();});TP.core.TSH.Inst.defineMethod('executeSourceFS',function(a){var b,d,c;b=TP.sig.FileChangedEvent.get('pending');c=TP.ac();d=b.getKeys();d.perform(function(b){var e,d,f,g;try{e=TP.sys.shouldLogCodeChanges();TP.sys.shouldLogCodeChanges(false);a.stdout('Reloading source from: '+b);d=TP.uc(b);if(TP.notValid(d)){a.fail(TP.FAILURE,'Source failed to load: '+b);return;}if(TP.notValid(f=d.getContent(TP.hc('refresh',true,'async',false)))){a.fail(TP.FAILURE,'Source failed to load: '+b);return;}g=TP.sys.shouldUseDebugger();TP.sys.shouldUseDebugger(false);TP.boot.$sourceImport(f,null,b,null,true);c.push(b);}catch(c){a.fail(TP.FAILURE,TP.ec(c,'Source failed to exec: '+b));return;}finally{TP.sys.shouldLogCodeChanges(e);TP.sys.shouldUseDebugger(g);}});c.perform(function(a){b.removeKey(a);});a.complete();});TP.core.TSH.Inst.defineMethod('executeWatchFS',function(b){var a,c;if(TP.notValid(a=this.get('watcherSSESource'))){c=TP.uriJoinPaths(TP.sys.cfg('path.app_root'),TP.sys.cfg('tds.watch_uri'));a=TP.core.SSESignalSource.construct(c);this.set('watcherSSESource',a);}this.observe(a,'TP.sig.FileChangedEvent');b.stdout('File system change monitoring active.');return b.complete();});TP.core.TSH.Inst.defineMethod('executeUnwatchFS',function(b){var a,c;if(TP.notValid(a=this.get('watcherSSESource'))){c=TP.uriJoinPaths(TP.sys.cfg('path.app_root'),TP.sys.cfg('tds.watch_uri'));a=TP.core.SSESignalSource.construct(c);}this.ignore(a,'TP.sig.FileChangedEvent');b.stdout('File system change monitoring ended.');return b.complete();});TP.core.TSH.Inst.defineMethod('handleTP_sig_FileChangedEvent',function(d){var e,b,a,f,g,c;if(TP.notValid(e=d.getPayload())){return;}c=d.getType().get('pending');a='.'+e.at('data').asString().stripEnclosingQuotes();a=TP.uriJoinPaths(TP.sys.getLaunchRoot(),a);b=c.at(a);if(TP.notValid(b)){f='File system change: '+a;g=TP.sig.UserOutputRequest.construct(TP.hc('output',f,'cssClass','inbound_announce','cmdAsIs',true,'cmdBox',false,'cmdRecycle',true));g.fire(this);b=1;}else{b+=1;}c.atPut(a,b);return this;});
TP.boot.$srcPath = '~lib_src/tibet/shells/YAK.js';
TP.core.Shell.defineSubtype('YAK');TP.core.YAK.set('commandPrefix','yak');TP.w3.Xmlns.registerNSInfo('urn:yak',TP.hc('uri','urn:yak','prefix','yak'));TP.core.YAK.Inst.defineAttribute('debug',true);TP.core.YAK.Inst.defineAttribute('lastNode');TP.core.YAK.Inst.defineAttribute('secureJIDs');TP.core.YAK.Inst.defineAttribute('serverURI');TP.core.YAK.Inst.defineAttribute('serverName');TP.core.YAK.Inst.defineAttribute('serviceID');TP.core.YAK.Inst.defineAttribute('targetJID');TP.core.YAK.Inst.defineAttribute('userJID');TP.core.YAK.Inst.defineAttribute('announcement',TP.join('TIBET&#8482; Instant Messaging Shell (TP.core.YAK&#8482;) ',TP.sys.getLibVersion(),'<br/>','Copyright (C) 1999, Technical Pursuit Inc, ','All Rights Reserved. Patents Pending.<br/>','Agent: ',navigator.userAgent,'<br/><br/>'));TP.core.YAK.Inst.defineAttribute('introduction',TP.join('Shift-Return to send. Shift-Up/Down for history. ','Shift-Delete to clear. Shift-Esc to cancel.<br/><br/>','Type ','<a class="help_table_link" href="#" onclick="TP.shell(','\':help\', false, false, false, \'','`getID()`','\'); ','return false;">?</a> or ','<a class="help_table_link" href="#" onclick="TP.shell(','\':help\', false, false, false, \'','`getID()`','\'); ','return false;">:help</a> for help, ','<a class="help_table_link" href="#" onclick="TP.shell(','\':history\', false, false, false, \'','`getID()`','\'); ','return false;">#?</a> or ','<a class="help_table_link" href="#" onclick="TP.shell(','\':history\', false, false, false, \'','`getID()`','\'); ','return false;">:history</a> for history; use ','<a class="help_table_link" href="#" onclick="TP.shell(','\':to \', false, false, false, \'','`getID()`','\'); ','return false;">:to</a> to target a specific JID.','<br/>'));TP.core.YAK.Inst.defineMethod('init',function(a){this.callNextMethod(a);this.observe(null,'TP.sig.XMPPInput');this.$set('secureJIDs',TP.hc());return this;});TP.core.YAK.Inst.defineMethod('canSend',function(){var a;if(!this.isRunning()){return false;}if(TP.notValid(a=TP.core.XMPPService.getInstanceById(this.getServiceID()))){return false;}return a.hasAuthConnection();});TP.core.YAK.Inst.defineMethod('displayDebugData',function(b){var c,a,d,e;if(TP.notTrue(this.get('debug'))||!this.isRunning()){return;}c=TP.core.XMPPService.getInstanceById(this.getServiceID());a=c.get('connection').getOutputStream().getLastPacket();if(TP.notValid(a)){return;}e=TP.isValid(b)?b.getTypeName()+':\n':'';try{d=TP.join('[SEND]\n',e,TP.nodeAsString(a));TP.sig.UserOutputRequest.construct(TP.hc('output',d,'messageType','debug')).fire(this);}catch(a){}return;});TP.core.YAK.Inst.defineMethod('getServiceID',function(){return this.getID()+'Service';});TP.core.YAK.Inst.defineMethod('setTargetJID',function(a){this.$set('targetJID',a);this.setVariable('TARGET',a.asString());return this;});TP.core.YAK.Inst.defineMethod('login',function(c){var a,b;if(this.isRunning()){this.stderr('Still logged in. Please log out first.');return;}a=this;b=TP.sig.UserInputSeries.construct();b.addQuery(TP.hc('query','polling uri:','retryPrompt','Invalid URI. Please re-enter...','validator',function(b,d){var c;if(TP.notValid(b)||b.getSize()<'http://'.getSize()||TP.notValid(c=TP.uc(b))){return false;}a.$set('serverURI',b);return true;}));b.addQuery(TP.hc('query','server name:','retryPrompt','Invalid server name. Please re-enter...','default',function(d,c){var b,a;b=c.getLastReply();try{a=TP.uc(b).get('host');}catch(b){a='';}return a;},'validator',function(b,c){if(TP.notValid(b)||b.getSize()<1){return false;}a.$set('serverName',b);return true;}));b.addQuery(TP.hc('query','user jid:','retryPrompt','Invalid JID. Please re-enter...','validator',function(b,d){var c;if(TP.notValid(b)||TP.notValid(c=TP.xmpp.JID.construct(b))){return false;}a.$set('userJID',c);return true;}));b.addQuery(TP.hc('query','password:','hideInput',true,'retryPrompt','Password cannot be empty.'+' Please re-enter...','validator',function(a,b){if(TP.notValid(a)||a.getSize()<TP.core.Shell.MIN_PASSWORD_LEN){return false;}return true;}));b.addCancelHook(function(b){TP.sig.UserOutputRequest.construct(TP.hc('output','Login request cancelled.','messageType','failure')).fire(a);a.logout();return;});b.addFailureHook(function(b){TP.sig.UserOutputRequest.construct(TP.hc('output','Login request failed.','messageType','failure')).fire(a);a.logout();return;});b.addSuccessHook(function(b){TP.sig.UserOutputRequest.construct(TP.hc('output','Login parameters obtained.'+' Attempting login...')).fire(a);a.loginCompletion(b);return;});b.fire(a);return this;});TP.core.YAK.Inst.defineMethod('loginCompletion',function(c){var d,e,b,f,a;d=TP.NOT_FOUND;e=c.get('queries');for(b=0;b<e.getSize();b++){if(e.at(b).at(c.getType().QUERY_INDEX).startsWith('password')){d=b;break;}}f=c.get('replies').at(d);if(TP.notValid(a=TP.core.XMPPService.getInstanceById(this.getServiceID()))){a=TP.core.XMPPService.construct(this.getServiceID());a.set('serviceURI',this.get('serverURI'));a.set('serverName',this.get('serverName'));}if(a.hasAuthConnection()){return;}if(!a.openConnection()){TP.sig.UserOutputRequest.construct(TP.hc('output','Login attempt failed.'+' Connection did not open.','messageType','failure')).fire(this);return;}if(a.authenticateConnection(this.get('userJID'),f)){TP.core.User.construct(this.get('userJID'));this.isRunning(true);this.setVariable('USER',this.get('userJID').asString());TP.sig.UserOutputRequest.construct(TP.hc('output',this.get('userJID').asString()+' logged in at '+TP.dc().toLocaleString(),'messageType','response','cssClass','inbound_announce')).fire(this);a.setupCurrentUser();this.displayDebugData(a.get('lastMsg'));}else{TP.sig.UserOutputRequest.construct(TP.hc('output','Login authentication failed.','messageType','failure')).fire(this);}return;});TP.core.YAK.Inst.defineMethod('logout',function(b){var a;try{if(TP.notValid(a=TP.core.XMPPService.getInstanceById(this.getServiceID()))){if(this.isRunning()){this.isRunning(false);}this.signal('TP.sig.Logout');return this;}a.shutdownConnection();}catch(a){}if(this.isRunning()){this.isRunning(false);}this.signal('TP.sig.Logout');return this;});TP.core.YAK.Inst.defineMethod('register',function(c){var a,b;if(this.isRunning()){this.stderr('Still logged in. Please log out first.');return;}a=this;b=TP.sig.UserInputSeries.construct();b.addQuery(TP.hc('query','polling uri:','retryPrompt','Invalid URI. Please re-enter...','validator',function(b,d){var c;if(TP.notValid(b)||b.getSize()<'http://'.getSize()||TP.notValid(c=TP.uc(b))){return false;}a.$set('serverURI',b);return true;}));b.addQuery(TP.hc('query','server name:','default',function(d,c){var b,a;b=c.getLastReply();try{a=TP.uc(b).get('host');}catch(b){a='';}return a;},'retryPrompt','Invalid server name.'+' Please re-enter...','validator',function(b,c){if(TP.notValid(b)||b.getSize()<1){return false;}a.$set('serverName',b);return true;}));b.addCancelHook(function(b){TP.sig.UserOutputRequest.construct(TP.hc('output','Registration request cancelled.','messageType','failure')).fire(a);a.logout();return;});b.addFailureHook(function(b){TP.sig.UserOutputRequest.construct(TP.hc('output','Registration request failed.','messageType','failure')).fire(a);a.logout();return;});b.addSuccessHook(function(d){var b,c;if(TP.notValid(b=TP.core.XMPPService.getInstanceById(this.getServiceID()))){b=TP.core.XMPPService.construct(this.getServiceID());b.set('serviceURI',a.get('serverURI'));b.set('serverName',a.get('serverName'));}if(!b.openConnection()){TP.sig.UserOutputRequest.construct(TP.hc('output','Registration attempt failed.'+' Connection did not open.','messageType','failure')).fire(a);return;}c=b.initiateRegistration();if(TP.notValid(c)){TP.sig.UserOutputRequest.construct(TP.hc('output','Registration attempt failed.'+' No response.','messageType','failure')).fire(a);return;}try{a.registerCompletion(c);}catch(b){TP.sig.UserOutputRequest.construct(TP.hc('output','Registration attempt failed processing'+' response.','messageType','failure')).fire(a);}return;});b.fire(a);return this;});TP.core.YAK.Inst.defineMethod('registerCompletion',function(e){var a,b,c,d;a=this;b=TP.sig.UserInputSeries.construct();b.addQuery(TP.hc('query','username:','retryPrompt','Username cannot be empty.'+' Please re-enter...','validator',function(b,d){var c;if(TP.isEmpty(b)){return false;}if(b.containsString('@')){c=TP.xmpp.JID.construct(b);}else{c=TP.xmpp.JID.construct(b+'@'+a.get('serverName'));}a.$set('userJID',c);return true;}));b.addQuery(TP.hc('query','password:','hideInput',true,'retryPrompt','Password cannot be empty.'+' Please re-enter...','validator',function(a,b){if(TP.notValid(a)||a.getSize()<TP.core.Shell.MIN_PASSWORD_LEN){return false;}return true;}));c=TP.core.XMPPService.getInstanceById(this.getServiceID());d=c.getRegistrationFieldsFrom(e);d.perform(function(c){if(c.first()==='username'||c.first()==='password'){return;}if(c.first()==='instructions'){a.stdout(c.last());return;}b.addQuery(TP.hc('query',TP.join(c.first(),' (',c.last(),'): ')));});b.addSuccessHook(function(d){var i,g,h,c,b,e,f;g=TP.hc();h=d.get('queries');for(c=0;c<h.getSize();c++){b=h.at(c).at(d.getType().QUERY_INDEX);b=b.chop(':');e=d.getReplies().at(c);if(b.startsWith('username')&&b.containsString('@')){e=e.split('@').at(0);}g.atPut(b,e);}i=TP.core.XMPPService.getInstanceById(this.getServiceID());f=i.finalizeRegistration(g);if(TP.notValid(f)){TP.sig.UserOutputRequest.construct(TP.hc('output','Registration attempt failed.'+' No response.','messageType','failure')).fire(a);return;}if(f.isError()){TP.sig.UserOutputRequest.construct(TP.hc('output','Registration attempt failed. '+f.get('errorMessage'),'messageType','failure')).fire(a);}else{TP.sig.UserOutputRequest.construct(TP.hc('output','Registration successful.'+' Logging in...')).fire(a);a.loginCompletion(d);}return;});b.fire(a);return this;});TP.core.YAK.Inst.defineMethod('start',function(c){var a,b;if(this.isRunning()){return;}b=this;this.announce(c);this.setVariable('SHOW_INVALID',false);a=TP.sig.UserInputRequest.construct(TP.hc('query','(n)ew or (e)xisting user?','default','existing','async',true));a.defineMethod('handleRequestCancelled',function(){b.logout(c);});a.defineMethod('handleUserInput',function(e){var d;a.ignore(a.getRequestID(),'TP.sig.UserInput');a.getRequestID().signal('TP.sig.RequestCompleted');if(e.didFail()){b.logout(c);return;}d=e.getResult();if(TP.isString(d)&&d.toLowerCase().startsWith('e')){b.login(c);}else{b.register(c);}});a.fire(b);return;});TP.core.YAK.Inst.defineMethod('echoRequest',function(b){var f,a,d,e,c;if(TP.notValid(a=b.at('cmd'))){return b;}if(TP.notTrue(b.at('echoRequest'))){return b;}if(a.startsWith(':')){d='query';e=a;}else{if(a.startsWith('\\:')){a=a.slice(1);}c=this.get('targetJID');if(TP.notValid(c)){c='undefined';}d='message';e=TP.join('<span class="outbound_ident_time">','[',TP.dc().asTimestamp(false,false),']','</span><span class="outbound_ident_tid">','&nbsp;&gt;&nbsp;',c.asString(),'</span>&nbsp;',a);}f=TP.sig.UserOutputRequest.construct(TP.hc('output',e,'render',true,'messageType',d));f.fire(this);return b;});TP.core.YAK.Inst.defineMethod('execute',function(b){var a;if(TP.notValid(a=b.constructResponse())){this.raise('TP.sig.ProcessingException',arguments,'Couldn\'t construct response.');return;}return a;});TP.core.YAK.Inst.defineMethod('executeAvailable',function(a){var b,c,d;if(!this.canSend()){return a.fail(TP.FAILURE,'No active XMPP connection. Please login.');}b=this.getCommandArguments(a);if(b.getSize()>0){c=b.join(' ');}else{c='';}d=TP.core.XMPPService.getInstanceById(this.getServiceID());d.setPresence(TP.xmpp.XMLNS.ONLINE,c);this.displayDebugData(d.get('lastMsg'));return a.complete();});TP.core.YAK.Inst.defineMethod('executeAway',function(a){var b,c,d;if(!this.canSend()){return a.fail(TP.FAILURE,'No active XMPP connection. Please login.');}b=this.getCommandArguments(a);if(b.getSize()>0){c=b.join(' ');}else{c='';}d=TP.core.XMPPService.getInstanceById(this.getServiceID());d.setPresence(TP.xmpp.XMLNS.AWAY,c);this.displayDebugData(d.get('lastMsg'));return a.complete();});TP.core.YAK.Inst.defineMethod('executeDebug',function(a){var b,c;b=this.getCommandArguments(a);if(b.getSize()!==0){c=TP.bc(b.at(0));this.set('debug',c);}a.set('result','debug is '+(TP.isTrue(this.get('debug'))?'on':'off'));return a.complete();});TP.core.YAK.Inst.defineMethod('executeRegister',function(a){this.register();return a.complete();});TP.core.YAK.Inst.defineMethod('executeRoster',function(b){var a;if(!this.canSend()){return b.fail(TP.FAILURE,'No active XMPP connection. Please login.');}a=TP.core.XMPPService.getInstanceById(this.getServiceID());a.fetchRoster();this.displayDebugData(a.get('lastMsg'));return b.complete();});TP.core.YAK.Inst.defineMethod('executeSecure',function(b){var a,d,c;a=this.getCommandArguments(b);if(a.getSize()<1){TP.sig.UserOutputRequest.construct(TP.hc('output',TP.keys(this.get('secureJIDs')),'messageType','response')).fire(this);return b.complete();}d=a.at(0);if(a.getSize()===1){c=window.location;}else{a.shift();c=a.join(' ');}this.get('secureJIDs').atPut(d,c);return b.complete();});TP.core.YAK.Inst.defineMethod('executeSend',function(a){var b,c,e,d;if(!this.canSend()){return a.fail(TP.FAILURE,'No active XMPP connection. Please login.');}if(TP.notValid(c=this.get('targetJID'))){return a.fail(TP.FAILURE,'No active target JID. Use :to to set one.');}if(TP.notValid(e=this.get('secureJIDs').at(c))){d=a.at('cmd');}else{d=a.at('cmd').encrypt(e);}b=TP.core.XMPPService.getInstanceById(this.getServiceID());b.sendMessage(c,d);this.displayDebugData(b.get('lastMsg'));return a.complete();});TP.core.YAK.Inst.defineMethod('executeStatus',function(i){var e,a,f,d,g,c,b,h;a=TP.ac();a.push('<table width="100%" cellpadding="3" cellspacing="0"',' class="xmpp_table"><thead class="xmpp_table_title">','<tr><td>JID</td>','<td>Showing</td>','<td>Status</td></tr></thead>','<tbody class="xmpp_table_data">');f=TP.xmpp.JID.get('instances');c=TP.keys(f).sort();for(b=0;b<c.getSize();b++){h=f.at(c.at(b));if(TP.notValid(e=h.get('presence'))){d='unknown';g='unknown';}else{d=TP.ifInvalid(e.get('show'),'Online');g=TP.ifInvalid(e.get('status'),'');}if(d==='unknown'){continue;}a.push('<tr><td>','<a href="#" onclick="','TP.shell(','\':to ',c.at(b),'\'',', false, false, false,','\'',this.getID(),'\'',');',' return false;">',c.at(b),'</a>','</td>');a.push('<td>',d,'</td>');a.push('<td>',g,'</td>');a.push('</tr>');}a.push('</tbody></table>');a=a.join('');TP.sig.UserOutputRequest.construct(TP.hc('output',a,'render',true,'messageType','response')).fire(this);return i.complete();});TP.core.YAK.Inst.defineMethod('executeSubscribe',function(a){var b,d,c;b=this.getCommandArguments(a);if(b.getSize()<1){return a.complete();}else{d=b.at(0);}if(!this.canSend()){return a.fail(TP.FAILURE,'No active XMPP connection. Please login.');}c=TP.core.XMPPService.getInstanceById(this.getServiceID());c.subscribeTo(d);this.displayDebugData(c.get('lastMsg'));return a.complete();});TP.core.YAK.Inst.defineMethod('executeTo',function(b){var a,c,d,e,f,g,h,i;a=this.getCommandArguments(b);if(a.getSize()<1){TP.sig.UserOutputRequest.construct(TP.hc('output',this.get('targetJID'),'messageType','response')).fire(this);return b.complete();}else if(a.getSize()===1){this.set('targetJID',a.at(0));return b.complete();}if(!this.canSend()){return b.fail(TP.FAILURE,'No active XMPP connection. Please login.');}c=a.at(0);a.shift();d=a.join(' ');if(TP.notValid(i=this.get('secureJIDs').at(c))){e=d;}else{e=d.encrypt(i);}f=TP.core.XMPPService.getInstanceById(this.getServiceID());f.sendMessage(c,e);this.displayDebugData(f.get('lastMsg'));g=TP.join('<span class="outbound_ident_time">','[',TP.dc().asTimestamp(false,false),']','</span><span class="outbound_ident_tid">','&nbsp;&gt;&nbsp;',c,'</span>&nbsp;',d);h=TP.sig.UserOutputRequest.construct(TP.hc('output',g,'render',true,'messageType','message'));h.fire(this);return b.complete();});TP.core.YAK.Inst.defineMethod('executeUnavailable',function(a){return this.executeAway(a);});TP.core.YAK.Inst.defineMethod('executeUnsecure',function(a){var b,c;b=this.getCommandArguments(a);if(b.getSize()!==1){a.atPut('topic','unsecure');return this.executeHelpTopic(a);}c=b.at(0);this.get('secureJIDs').removeKey(c);return a.complete();});TP.core.YAK.Inst.defineMethod('executeUnsubscribe',function(a){var b,d,c;b=this.getCommandArguments(a);if(b.getSize()<1){return a.complete();}else{d=b.at(0);}if(!this.canSend()){return a.fail(TP.FAILURE,'No active XMPP connection. Please login.');}c=TP.core.XMPPService.getInstanceById(this.getServiceID());c.unsubscribeFrom(d);this.displayDebugData(c.get('lastMsg'));return a.complete();});TP.core.YAK.Inst.defineMethod('handleXMPPInput',function(b){var c,e,a,d;if(TP.notValid(b)||TP.notValid(e=b.getPayload())){TP.ifWarn()?TP.warn('Invalid signal data for TP.sig.XMPPInput event.',TP.LOG,arguments):0;return;}if(TP.notValid(a=e.at('node'))){TP.ifWarn()?TP.warn('Missing stanza data for TP.sig.XMPPInput event.',TP.LOG,arguments):0;return;}this.set('lastNode',a);d=false;if(TP.isTrue(this.get('debug'))){c='[RECV]\n'+a.getTypeName()+':\n'+a.asString()+'\n';TP.sig.UserOutputRequest.construct(TP.hc('output',c,'render',d,'messageType','debug')).fire(this);}try{c=a.asConsoleString(this);d=a.shouldRenderConsoleString();TP.sig.UserOutputRequest.construct(TP.hc('output',c,'render',d,'messageType','message')).fire(this);}catch(a){TP.sig.UserOutputRequest.construct(TP.hc('output',TP.str(a),'messageType','failure')).fire(this);}try{if(TP.canInvoke(a,'handleArrival')){b.set('console',this);a.handleArrival(b);}}catch(a){TP.sig.UserOutputRequest.construct(TP.hc('output',TP.str(a),'messageType','failure')).fire(this);}return;});
TP.boot.$srcPath = '~app/node_modules/tibet/deps/d3-tpi.min.js';
!function(){function n(n,t){return t>n?-1:n>t?1:n>=t?0:0/0}function t(n){return null!=n&&!isNaN(n)}function e(n){return{left:function(t,e,r,u){for(arguments.length<3&&(r=0),arguments.length<4&&(u=t.length);u>r;){var i=r+u>>>1;n(t[i],e)<0?r=i+1:u=i}return r},right:function(t,e,r,u){for(arguments.length<3&&(r=0),arguments.length<4&&(u=t.length);u>r;){var i=r+u>>>1;n(t[i],e)>0?u=i:r=i+1}return r}}}function r(n){return n.length}function u(n){for(var t=1;n*t%1;)t*=10;return t}function i(n,t){try{for(var e in t)Object.defineProperty(n.prototype,e,{value:t[e],enumerable:!1})}catch(r){n.prototype=t}}function o(){}function a(n){return ha+n in this}function c(n){return n=ha+n,n in this&&delete this[n]}function s(){var n=[];return this.forEach(function(t){n.push(t)}),n}function l(){var n=0;for(var t in this)t.charCodeAt(0)===ga&&++n;return n}function f(){for(var n in this)if(n.charCodeAt(0)===ga)return!1;return!0}function h(){}function g(n,t,e){return function(){var r=e.apply(t,arguments);return r===t?n:r}}function p(n,t){if(t in n)return t;t=t.charAt(0).toUpperCase()+t.substring(1);for(var e=0,r=pa.length;r>e;++e){var u=pa[e]+t;if(u in n)return u}}function v(){}function d(){}function m(n){function t(){for(var t,r=e,u=-1,i=r.length;++u<i;)(t=r[u].on)&&t.apply(this,arguments);return n}var e=[],r=new o;return t.on=function(t,u){var i,o=r.get(t);return arguments.length<2?o&&o.on:(o&&(o.on=null,e=e.slice(0,i=e.indexOf(o)).concat(e.slice(i+1)),r.remove(t)),u&&e.push(r.set(t,{on:u})),n)},t}function y(){Wo.event.preventDefault()}function x(){for(var n,t=Wo.event;n=t.sourceEvent;)t=n;return t}function M(n){for(var t=new d,e=0,r=arguments.length;++e<r;)t[arguments[e]]=m(t);return t.of=function(e,r){return function(u){try{var i=u.sourceEvent=Wo.event;u.target=n,Wo.event=u,t[u.type].apply(e,r)}finally{Wo.event=i}}},t}function _(n){return da(n,_a),n}function b(n){return"function"==typeof n?n:function(){return ma(n,this)}}function w(n){return"function"==typeof n?n:function(){return ya(n,this)}}function S(n,t){function e(){this.removeAttribute(n)}function r(){this.removeAttributeNS(n.space,n.local)}function u(){this.setAttribute(n,t)}function i(){this.setAttributeNS(n.space,n.local,t)}function o(){var e=t.apply(this,arguments);null==e?this.removeAttribute(n):this.setAttribute(n,e)}function a(){var e=t.apply(this,arguments);null==e?this.removeAttributeNS(n.space,n.local):this.setAttributeNS(n.space,n.local,e)}return n=Wo.ns.qualify(n),null==t?n.local?r:e:"function"==typeof t?n.local?a:o:n.local?i:u}function k(n){return n.trim().replace(/\s+/g," ")}function E(n){return new RegExp("(?:^|\\s+)"+Wo.requote(n)+"(?:\\s+|$)","g")}function A(n){return n.trim().split(/^|\s+/)}function C(n,t){function e(){for(var e=-1;++e<u;)n[e](this,t)}function r(){for(var e=-1,r=t.apply(this,arguments);++e<u;)n[e](this,r)}n=A(n).map(N);var u=n.length;return"function"==typeof t?r:e}function N(n){var t=E(n);return function(e,r){if(u=e.classList)return r?u.add(n):u.remove(n);var u=e.getAttribute("class")||"";r?(t.lastIndex=0,t.test(u)||e.setAttribute("class",k(u+" "+n))):e.setAttribute("class",k(u.replace(t," ")))}}function T(n,t,e){function r(){TP.elementGetStyleObj(this).removeProperty(n)}function u(){TP.elementGetStyleObj(this).setProperty(n,t,e)}function i(){var r=t.apply(this,arguments);null==r?TP.elementGetStyleObj(this).removeProperty(n):TP.elementGetStyleObj(this).setProperty(n,r,e)}return null==t?r:"function"==typeof t?i:u}function L(n,t){function e(){delete this[n]}function r(){this[n]=t}function u(){var e=t.apply(this,arguments);null==e?delete this[n]:this[n]=e}return null==t?e:"function"==typeof t?u:r}function q(n){return"function"==typeof n?n:(n=Wo.ns.qualify(n)).local?function(){return this.ownerDocument.createElementNS(n.space,n.local)}:function(){return this.ownerDocument.createElementNS(this.namespaceURI,n)}}function z(n){return{__data__:n}}function R(n){return function(){return Ma(this,n)}}function D(t){return arguments.length||(t=n),function(n,e){return n&&e?t(n.__data__,e.__data__):!n-!e}}function P(n,t){for(var e=0,r=n.length;r>e;e++)for(var u,i=n[e],o=0,a=i.length;a>o;o++)(u=i[o])&&t(u,o,e);return n}function j(n){return da(n,wa),n}function U(n){var t,e;return function(r,u,i){var o,a=n[i].update,c=a.length;for(i!=e&&(e=i,t=0),u>=t&&(t=u+1);!(o=a[t])&&++t<c;);return o}}function H(){var n=this.__transition__;n&&++n.active}function O(n,t,e){function r(){var t=this[o];t&&(this.removeEventListener(n,t,t.$),delete this[o])}function u(){var u=c(t,Qo(arguments));r.call(this),this.addEventListener(n,this[o]=u,u.$=e),u._=t}function i(){var t,e=new RegExp("^__on([^.]+)"+Wo.requote(n)+"$");for(var r in this)if(t=r.match(e)){var u=this[r];this.removeEventListener(t[1],u,u.$),delete this[r]}}var o="__on"+n,a=n.indexOf("."),c=F;a>0&&(n=n.substring(0,a));var s=ka.get(n);return s&&(n=s,c=I),a?t?u:r:t?v:i}function F(n,t){return function(e){var r=Wo.event;Wo.event=e,t[0]=this.__data__;try{n.apply(this,t)}finally{Wo.event=r}}}function I(n,t){var e=F(n,t);return function(n){var t=this,r=n.relatedTarget;r&&(r===t||8&r.compareDocumentPosition(t))||e.call(t,n)}}function Y(){var n=".dragsuppress-"+ ++Aa,t="click"+n,e=Wo.select(ea).on("touchmove"+n,y).on("dragstart"+n,y).on("selectstart"+n,y);if(Ea){var r=ta.style,u=r[Ea];r[Ea]="none"}return function(i){function o(){e.on(t,null)}e.on(n,null),Ea&&(r[Ea]=u),i&&(e.on(t,function(){y(),o()},!0),setTimeout(o,0))}}function Z(n,t){t.changedTouches&&(t=t.changedTouches[0]);var e=n.ownerSVGElement||n;if(e.createSVGPoint){var r=e.createSVGPoint();return r.x=t.clientX,r.y=t.clientY,r=r.matrixTransform(n.getScreenCTM().inverse()),[r.x,r.y]}var u=n.getBoundingClientRect();return[t.clientX-u.left-n.clientLeft,t.clientY-u.top-n.clientTop]}function V(){return Wo.event.changedTouches[0].identifier}function $(){return Wo.event.target}function X(){return ea}function B(n){return n>0?1:0>n?-1:0}function G(n,t,e){return(t[0]-n[0])*(e[1]-n[1])-(t[1]-n[1])*(e[0]-n[0])}function J(n){return n>1?0:-1>n?Ca:Math.acos(n)}function W(n){return n>1?Ta:-1>n?-Ta:Math.asin(n)}function K(n){return((n=Math.exp(n))-1/n)/2}function Q(n){return((n=Math.exp(n))+1/n)/2}function nt(n){return((n=Math.exp(2*n))-1)/(n+1)}function tt(n){return(n=Math.sin(n/2))*n}function et(){}function rt(n,t,e){return new ut(n,t,e)}function ut(n,t,e){this.h=n,this.s=t,this.l=e}function it(n,t,e){function r(n){return n>360?n-=360:0>n&&(n+=360),60>n?i+(o-i)*n/60:180>n?o:240>n?i+(o-i)*(240-n)/60:i}function u(n){return Math.round(255*r(n))}var i,o;return n=isNaN(n)?0:(n%=360)<0?n+360:n,t=isNaN(t)?0:0>t?0:t>1?1:t,e=0>e?0:e>1?1:e,o=.5>=e?e*(1+t):e+t-e*t,i=2*e-o,yt(u(n+120),u(n),u(n-120))}function ot(n,t,e){return new at(n,t,e)}function at(n,t,e){this.h=n,this.c=t,this.l=e}function ct(n,t,e){return isNaN(n)&&(n=0),isNaN(t)&&(t=0),st(e,Math.cos(n*=za)*t,Math.sin(n)*t)}function st(n,t,e){return new lt(n,t,e)}function lt(n,t,e){this.l=n,this.a=t,this.b=e}function ft(n,t,e){var r=(n+16)/116,u=r+t/500,i=r-e/200;return u=gt(u)*Za,r=gt(r)*Va,i=gt(i)*$a,yt(vt(3.2404542*u-1.5371385*r-.4985314*i),vt(-.969266*u+1.8760108*r+.041556*i),vt(.0556434*u-.2040259*r+1.0572252*i))}function ht(n,t,e){return n>0?ot(Math.atan2(e,t)*Ra,Math.sqrt(t*t+e*e),n):ot(0/0,0/0,n)}function gt(n){return n>.206893034?n*n*n:(n-4/29)/7.787037}function pt(n){return n>.008856?Math.pow(n,1/3):7.787037*n+4/29}function vt(n){return Math.round(255*(.00304>=n?12.92*n:1.055*Math.pow(n,1/2.4)-.055))}function dt(n){return yt(n>>16,255&n>>8,255&n)}function mt(n){return dt(n)+""}function yt(n,t,e){return new xt(n,t,e)}function xt(n,t,e){this.r=n,this.g=t,this.b=e}function Mt(n){return 16>n?"0"+Math.max(0,n).toString(16):Math.min(255,n).toString(16)}function _t(n,t,e){var r,u,i,o=0,a=0,c=0;if(r=/([a-z]+)\((.*)\)/i.exec(n))switch(u=r[2].split(","),r[1]){case"hsl":return e(parseFloat(u[0]),parseFloat(u[1])/100,parseFloat(u[2])/100);case"rgb":return t(kt(u[0]),kt(u[1]),kt(u[2]))}return(i=Ga.get(n))?t(i.r,i.g,i.b):(null==n||"#"!==n.charAt(0)||isNaN(i=parseInt(n.substring(1),16))||(4===n.length?(o=(3840&i)>>4,o=o>>4|o,a=240&i,a=a>>4|a,c=15&i,c=c<<4|c):7===n.length&&(o=(16711680&i)>>16,a=(65280&i)>>8,c=255&i)),t(o,a,c))}function bt(n,t,e){var r,u,i=Math.min(n/=255,t/=255,e/=255),o=Math.max(n,t,e),a=o-i,c=(o+i)/2;return a?(u=.5>c?a/(o+i):a/(2-o-i),r=n==o?(t-e)/a+(e>t?6:0):t==o?(e-n)/a+2:(n-t)/a+4,r*=60):(r=0/0,u=c>0&&1>c?0:r),rt(r,u,c)}function wt(n,t,e){n=St(n),t=St(t),e=St(e);var r=pt((.4124564*n+.3575761*t+.1804375*e)/Za),u=pt((.2126729*n+.7151522*t+.072175*e)/Va),i=pt((.0193339*n+.119192*t+.9503041*e)/$a);return st(116*u-16,500*(r-u),200*(u-i))}function St(n){return(n/=255)<=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4)}function kt(n){var t=parseFloat(n);return"%"===n.charAt(n.length-1)?Math.round(2.55*t):t}function Et(n){return"function"==typeof n?n:function(){return n}}function At(n){return n}function Ct(n){return function(t,e,r){return 2===arguments.length&&"function"==typeof e&&(r=e,e=null),Nt(t,e,n,r)}}function Nt(n,t,e,r){function u(){var n,t=c.status;if(!t&&c.responseText||t>=200&&300>t||304===t){try{n=e.call(i,c)}catch(r){return o.error.call(i,r),void 0}o.load.call(i,n)}else o.error.call(i,c)}var i={},o=Wo.dispatch("beforesend","progress","load","error"),a={},c=new XMLHttpRequest,s=null;return!ea.XDomainRequest||"withCredentials"in c||!/^(http(s)?:)?\/\//.test(n)||(c=new XDomainRequest),"onload"in c?c.onload=c.onerror=u:c.onreadystatechange=function(){c.readyState>3&&u()},c.onprogress=function(n){var t=Wo.event;Wo.event=n;try{o.progress.call(i,c)}finally{Wo.event=t}},i.header=function(n,t){return n=(n+"").toLowerCase(),arguments.length<2?a[n]:(null==t?delete a[n]:a[n]=t+"",i)},i.mimeType=function(n){return arguments.length?(t=null==n?null:n+"",i):t},i.responseType=function(n){return arguments.length?(s=n,i):s},i.response=function(n){return e=n,i},["get","post"].forEach(function(n){i[n]=function(){return i.send.apply(i,[n].concat(Qo(arguments)))}}),i.send=function(e,r,u){if(2===arguments.length&&"function"==typeof r&&(u=r,r=null),c.open(e,n,!0),null==t||"accept"in a||(a.accept=t+",*/*"),c.setRequestHeader)for(var l in a)c.setRequestHeader(l,a[l]);return null!=t&&c.overrideMimeType&&c.overrideMimeType(t),null!=s&&(c.responseType=s),null!=u&&i.on("error",u).on("load",function(n){u(null,n)}),o.beforesend.call(i,c),c.send(null==r?null:r),i},i.abort=function(){return c.abort(),i},Wo.rebind(i,o,"on"),null==r?i:i.get(Tt(r))}function Tt(n){return 1===n.length?function(t,e){n(null==t?e:null)}:n}function Lt(){var n=qt(),t=zt()-n;t>24?(isFinite(t)&&(clearTimeout(Qa),Qa=setTimeout(Lt,t)),Ka=0):(Ka=1,tc(Lt))}function qt(){var n=Date.now();for(nc=Ja;nc;)n>=nc.t&&(nc.f=nc.c(n-nc.t)),nc=nc.n;return n}function zt(){for(var n,t=Ja,e=1/0;t;)t.f?t=n?n.n=t.n:Ja=t.n:(t.t<e&&(e=t.t),t=(n=t).n);return Wa=n,e}function Rt(n,t){return t-(n?Math.ceil(Math.log(n)/Math.LN10):1)}function Dt(n,t){var e=Math.pow(10,3*fa(8-t));return{scale:t>8?function(n){return n/e}:function(n){return n*e},symbol:n}}function Pt(n){var t=n.decimal,e=n.thousands,r=n.grouping,u=n.currency,i=r?function(n){for(var t=n.length,u=[],i=0,o=r[0];t>0&&o>0;)u.push(n.substring(t-=o,t+o)),o=r[i=(i+1)%r.length];return u.reverse().join(e)}:At;return function(n){var e=rc.exec(n),r=e[1]||" ",o=e[2]||">",a=e[3]||"",c=e[4]||"",s=e[5],l=+e[6],f=e[7],h=e[8],g=e[9],p=1,v="",d="",m=!1;switch(h&&(h=+h.substring(1)),(s||"0"===r&&"="===o)&&(s=r="0",o="=",f&&(l-=Math.floor((l-1)/4))),g){case"n":f=!0,g="g";break;case"%":p=100,d="%",g="f";break;case"p":p=100,d="%",g="r";break;case"b":case"o":case"x":case"X":"#"===c&&(v="0"+g.toLowerCase());case"c":case"d":m=!0,h=0;break;case"s":p=-1,g="r"}"$"===c&&(v=u[0],d=u[1]),"r"!=g||h||(g="g"),null!=h&&("g"==g?h=Math.max(1,Math.min(21,h)):("e"==g||"f"==g)&&(h=Math.max(0,Math.min(20,h)))),g=uc.get(g)||jt;var y=s&&f;return function(n){var e=d;if(m&&n%1)return"";var u=0>n||0===n&&0>1/n?(n=-n,"-"):a;if(0>p){var c=Wo.formatPrefix(n,h);n=c.scale(n),e=c.symbol+d}else n*=p;n=g(n,h);var x=n.lastIndexOf("."),M=0>x?n:n.substring(0,x),_=0>x?"":t+n.substring(x+1);!s&&f&&(M=i(M));var b=v.length+M.length+_.length+(y?0:u.length),w=l>b?new Array(b=l-b+1).join(r):"";return y&&(M=i(w+M)),u+=v,n=M+_,("<"===o?u+n+w:">"===o?w+u+n:"^"===o?w.substring(0,b>>=1)+u+n+w.substring(b):u+(y?n:w+n))+e}}}function jt(n){return n+""}function Ut(){this._=new Date(arguments.length>1?Date.UTC.apply(this,arguments):arguments[0])}function Ht(n,t,e){function r(t){var e=n(t),r=i(e,1);return r-t>t-e?e:r}function u(e){return t(e=n(new oc(e-1)),1),e}function i(n,e){return t(n=new oc(+n),e),n}function o(n,r,i){var o=u(n),a=[];if(i>1)for(;r>o;)e(o)%i||a.push(new Date(+o)),t(o,1);else for(;r>o;)a.push(new Date(+o)),t(o,1);return a}function a(n,t,e){try{oc=Ut;var r=new Ut;return r._=n,o(r,t,e)}finally{oc=Date}}n.floor=n,n.round=r,n.ceil=u,n.offset=i,n.range=o;var c=n.utc=Ot(n);return c.floor=c,c.round=Ot(r),c.ceil=Ot(u),c.offset=Ot(i),c.range=a,n}function Ot(n){return function(t,e){try{oc=Ut;var r=new Ut;return r._=t,n(r,e)._}finally{oc=Date}}}function Ft(n){function t(n){function t(t){for(var e,u,i,o=[],a=-1,c=0;++a<r;)37===n.charCodeAt(a)&&(o.push(n.substring(c,a)),null!=(u=cc[e=n.charAt(++a)])&&(e=n.charAt(++a)),(i=C[e])&&(e=i(t,null==u?"e"===e?" ":"0":u)),o.push(e),c=a+1);return o.push(n.substring(c,a)),o.join("")}var r=n.length;return t.parse=function(t){var r={y:1900,m:0,d:1,H:0,M:0,S:0,L:0,Z:null},u=e(r,n,t,0);if(u!=t.length)return null;"p"in r&&(r.H=r.H%12+12*r.p);var i=null!=r.Z&&oc!==Ut,o=new(i?Ut:oc);return"j"in r?o.setFullYear(r.y,0,r.j):"w"in r&&("W"in r||"U"in r)?(o.setFullYear(r.y,0,1),o.setFullYear(r.y,0,"W"in r?(r.w+6)%7+7*r.W-(o.getDay()+5)%7:r.w+7*r.U-(o.getDay()+6)%7)):o.setFullYear(r.y,r.m,r.d),o.setHours(r.H+Math.floor(r.Z/100),r.M+r.Z%100,r.S,r.L),i?o._:o},t.toString=function(){return n},t}function e(n,t,e,r){for(var u,i,o,a=0,c=t.length,s=e.length;c>a;){if(r>=s)return-1;if(u=t.charCodeAt(a++),37===u){if(o=t.charAt(a++),i=N[o in cc?t.charAt(a++):o],!i||(r=i(n,e,r))<0)return-1}else if(u!=e.charCodeAt(r++))return-1}return r}function r(n,t,e){b.lastIndex=0;var r=b.exec(t.substring(e));return r?(n.w=w.get(r[0].toLowerCase()),e+r[0].length):-1}function u(n,t,e){M.lastIndex=0;var r=M.exec(t.substring(e));return r?(n.w=_.get(r[0].toLowerCase()),e+r[0].length):-1}function i(n,t,e){E.lastIndex=0;var r=E.exec(t.substring(e));return r?(n.m=A.get(r[0].toLowerCase()),e+r[0].length):-1}function o(n,t,e){S.lastIndex=0;var r=S.exec(t.substring(e));return r?(n.m=k.get(r[0].toLowerCase()),e+r[0].length):-1}function a(n,t,r){return e(n,C.c.toString(),t,r)}function c(n,t,r){return e(n,C.x.toString(),t,r)}function s(n,t,r){return e(n,C.X.toString(),t,r)}function l(n,t,e){var r=x.get(t.substring(e,e+=2).toLowerCase());return null==r?-1:(n.p=r,e)}var f=n.dateTime,h=n.date,g=n.time,p=n.periods,v=n.days,d=n.shortDays,m=n.months,y=n.shortMonths;t.utc=function(n){function e(n){try{oc=Ut;var t=new oc;return t._=n,r(t)}finally{oc=Date}}var r=t(n);return e.parse=function(n){try{oc=Ut;var t=r.parse(n);return t&&t._}finally{oc=Date}},e.toString=r.toString,e},t.multi=t.utc.multi=ae;var x=Wo.map(),M=Yt(v),_=Zt(v),b=Yt(d),w=Zt(d),S=Yt(m),k=Zt(m),E=Yt(y),A=Zt(y);p.forEach(function(n,t){x.set(n.toLowerCase(),t)});var C={a:function(n){return d[n.getDay()]},A:function(n){return v[n.getDay()]},b:function(n){return y[n.getMonth()]},B:function(n){return m[n.getMonth()]},c:t(f),d:function(n,t){return It(n.getDate(),t,2)},e:function(n,t){return It(n.getDate(),t,2)},H:function(n,t){return It(n.getHours(),t,2)},I:function(n,t){return It(n.getHours()%12||12,t,2)},j:function(n,t){return It(1+ic.dayOfYear(n),t,3)},L:function(n,t){return It(n.getMilliseconds(),t,3)},m:function(n,t){return It(n.getMonth()+1,t,2)},M:function(n,t){return It(n.getMinutes(),t,2)},p:function(n){return p[+(n.getHours()>=12)]},S:function(n,t){return It(n.getSeconds(),t,2)},U:function(n,t){return It(ic.sundayOfYear(n),t,2)},w:function(n){return n.getDay()},W:function(n,t){return It(ic.mondayOfYear(n),t,2)},x:t(h),X:t(g),y:function(n,t){return It(n.getFullYear()%100,t,2)},Y:function(n,t){return It(n.getFullYear()%1e4,t,4)},Z:ie,"%":function(){return"%"}},N={a:r,A:u,b:i,B:o,c:a,d:Qt,e:Qt,H:te,I:te,j:ne,L:ue,m:Kt,M:ee,p:l,S:re,U:$t,w:Vt,W:Xt,x:c,X:s,y:Gt,Y:Bt,Z:Jt,"%":oe};return t}function It(n,t,e){var r=0>n?"-":"",u=(r?-n:n)+"",i=u.length;return r+(e>i?new Array(e-i+1).join(t)+u:u)}function Yt(n){return new RegExp("^(?:"+n.map(Wo.requote).join("|")+")","i")}function Zt(n){for(var t=new o,e=-1,r=n.length;++e<r;)t.set(n[e].toLowerCase(),e);return t}function Vt(n,t,e){sc.lastIndex=0;var r=sc.exec(t.substring(e,e+1));return r?(n.w=+r[0],e+r[0].length):-1}function $t(n,t,e){sc.lastIndex=0;var r=sc.exec(t.substring(e));return r?(n.U=+r[0],e+r[0].length):-1}function Xt(n,t,e){sc.lastIndex=0;var r=sc.exec(t.substring(e));return r?(n.W=+r[0],e+r[0].length):-1}function Bt(n,t,e){sc.lastIndex=0;var r=sc.exec(t.substring(e,e+4));return r?(n.y=+r[0],e+r[0].length):-1}function Gt(n,t,e){sc.lastIndex=0;var r=sc.exec(t.substring(e,e+2));return r?(n.y=Wt(+r[0]),e+r[0].length):-1}function Jt(n,t,e){return/^[+-]\d{4}$/.test(t=t.substring(e,e+5))?(n.Z=-t,e+5):-1}function Wt(n){return n+(n>68?1900:2e3)}function Kt(n,t,e){sc.lastIndex=0;var r=sc.exec(t.substring(e,e+2));return r?(n.m=r[0]-1,e+r[0].length):-1}function Qt(n,t,e){sc.lastIndex=0;var r=sc.exec(t.substring(e,e+2));return r?(n.d=+r[0],e+r[0].length):-1}function ne(n,t,e){sc.lastIndex=0;var r=sc.exec(t.substring(e,e+3));return r?(n.j=+r[0],e+r[0].length):-1}function te(n,t,e){sc.lastIndex=0;var r=sc.exec(t.substring(e,e+2));return r?(n.H=+r[0],e+r[0].length):-1}function ee(n,t,e){sc.lastIndex=0;var r=sc.exec(t.substring(e,e+2));return r?(n.M=+r[0],e+r[0].length):-1}function re(n,t,e){sc.lastIndex=0;var r=sc.exec(t.substring(e,e+2));return r?(n.S=+r[0],e+r[0].length):-1}function ue(n,t,e){sc.lastIndex=0;var r=sc.exec(t.substring(e,e+3));return r?(n.L=+r[0],e+r[0].length):-1}function ie(n){var t=n.getTimezoneOffset(),e=t>0?"-":"+",r=~~(fa(t)/60),u=fa(t)%60;return e+It(r,"0",2)+It(u,"0",2)}function oe(n,t,e){lc.lastIndex=0;var r=lc.exec(t.substring(e,e+1));return r?e+r[0].length:-1}function ae(n){for(var t=n.length,e=-1;++e<t;)n[e][0]=this(n[e][0]);return function(t){for(var e=0,r=n[e];!r[1](t);)r=n[++e];return r[0](t)}}function ce(){}function se(n,t,e){var r=e.s=n+t,u=r-n,i=r-u;e.t=n-i+(t-u)}function le(n,t){n&&pc.hasOwnProperty(n.type)&&pc[n.type](n,t)}function fe(n,t,e){var r,u=-1,i=n.length-e;for(t.lineStart();++u<i;)r=n[u],t.point(r[0],r[1],r[2]);t.lineEnd()}function he(n,t){var e=-1,r=n.length;for(t.polygonStart();++e<r;)fe(n[e],t,1);t.polygonEnd()}function ge(){function n(n,t){n*=za,t=t*za/2+Ca/4;var e=n-r,o=e>=0?1:-1,a=o*e,c=Math.cos(t),s=Math.sin(t),l=i*s,f=u*c+l*Math.cos(a),h=l*o*Math.sin(a);dc.add(Math.atan2(h,f)),r=n,u=c,i=s}var t,e,r,u,i;mc.point=function(o,a){mc.point=n,r=(t=o)*za,u=Math.cos(a=(e=a)*za/2+Ca/4),i=Math.sin(a)},mc.lineEnd=function(){n(t,e)}}function pe(n){var t=n[0],e=n[1],r=Math.cos(e);return[r*Math.cos(t),r*Math.sin(t),Math.sin(e)]}function ve(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function de(n,t){return[n[1]*t[2]-n[2]*t[1],n[2]*t[0]-n[0]*t[2],n[0]*t[1]-n[1]*t[0]]}function me(n,t){n[0]+=t[0],n[1]+=t[1],n[2]+=t[2]}function ye(n,t){return[n[0]*t,n[1]*t,n[2]*t]}function xe(n){var t=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);n[0]/=t,n[1]/=t,n[2]/=t}function Me(n){return[Math.atan2(n[1],n[0]),W(n[2])]}function _e(n,t){return fa(n[0]-t[0])<La&&fa(n[1]-t[1])<La}function be(n,t){n*=za;var e=Math.cos(t*=za);we(e*Math.cos(n),e*Math.sin(n),Math.sin(t))}function we(n,t,e){++yc,Mc+=(n-Mc)/yc,_c+=(t-_c)/yc,bc+=(e-bc)/yc}function Se(){function n(n,u){n*=za;var i=Math.cos(u*=za),o=i*Math.cos(n),a=i*Math.sin(n),c=Math.sin(u),s=Math.atan2(Math.sqrt((s=e*c-r*a)*s+(s=r*o-t*c)*s+(s=t*a-e*o)*s),t*o+e*a+r*c);xc+=s,wc+=s*(t+(t=o)),Sc+=s*(e+(e=a)),kc+=s*(r+(r=c)),we(t,e,r)}var t,e,r;Nc.point=function(u,i){u*=za;var o=Math.cos(i*=za);t=o*Math.cos(u),e=o*Math.sin(u),r=Math.sin(i),Nc.point=n,we(t,e,r)}}function ke(){Nc.point=be}function Ee(){function n(n,t){n*=za;var e=Math.cos(t*=za),o=e*Math.cos(n),a=e*Math.sin(n),c=Math.sin(t),s=u*c-i*a,l=i*o-r*c,f=r*a-u*o,h=Math.sqrt(s*s+l*l+f*f),g=r*o+u*a+i*c,p=h&&-J(g)/h,v=Math.atan2(h,g);Ec+=p*s,Ac+=p*l,Cc+=p*f,xc+=v,wc+=v*(r+(r=o)),Sc+=v*(u+(u=a)),kc+=v*(i+(i=c)),we(r,u,i)}var t,e,r,u,i;Nc.point=function(o,a){t=o,e=a,Nc.point=n,o*=za;var c=Math.cos(a*=za);r=c*Math.cos(o),u=c*Math.sin(o),i=Math.sin(a),we(r,u,i)},Nc.lineEnd=function(){n(t,e),Nc.lineEnd=ke,Nc.point=be}}function Ae(){return!0}function Ce(n,t,e,r,u){var i=[],o=[];if(n.forEach(function(n){if(!((t=n.length-1)<=0)){var t,e=n[0],r=n[t];if(_e(e,r)){u.lineStart();for(var a=0;t>a;++a)u.point((e=n[a])[0],e[1]);return u.lineEnd(),void 0}var c=new Te(e,n,null,!0),s=new Te(e,null,c,!1);c.o=s,i.push(c),o.push(s),c=new Te(r,n,null,!1),s=new Te(r,null,c,!0),c.o=s,i.push(c),o.push(s)}}),o.sort(t),Ne(i),Ne(o),i.length){for(var a=0,c=e,s=o.length;s>a;++a)o[a].e=c=!c;for(var l,f,h=i[0];;){for(var g=h,p=!0;g.v;)if((g=g.n)===h)return;l=g.z,u.lineStart();do{if(g.v=g.o.v=!0,g.e){if(p)for(var a=0,s=l.length;s>a;++a)u.point((f=l[a])[0],f[1]);else r(g.x,g.n.x,1,u);g=g.n}else{if(p){l=g.p.z;for(var a=l.length-1;a>=0;--a)u.point((f=l[a])[0],f[1])}else r(g.x,g.p.x,-1,u);g=g.p}g=g.o,l=g.z,p=!p}while(!g.v);u.lineEnd()}}}function Ne(n){if(t=n.length){for(var t,e,r=0,u=n[0];++r<t;)u.n=e=n[r],e.p=u,u=e;u.n=e=n[0],e.p=u}}function Te(n,t,e,r){this.x=n,this.z=t,this.o=e,this.e=r,this.v=!1,this.n=this.p=null}function Le(n,t,e,r){return function(u,i){function o(t,e){var r=u(t,e);n(t=r[0],e=r[1])&&i.point(t,e)}function a(n,t){var e=u(n,t);d.point(e[0],e[1])}function c(){y.point=a,d.lineStart()}function s(){y.point=o,d.lineEnd()}function l(n,t){v.push([n,t]);var e=u(n,t);M.point(e[0],e[1])}function f(){M.lineStart(),v=[]}function h(){l(v[0][0],v[0][1]),M.lineEnd();var n,t=M.clean(),e=x.buffer(),r=e.length;if(v.pop(),p.push(v),v=null,r)if(1&t){n=e[0];var u,r=n.length-1,o=-1;if(r>0){for(_||(i.polygonStart(),_=!0),i.lineStart();++o<r;)i.point((u=n[o])[0],u[1]);i.lineEnd()}}else r>1&&2&t&&e.push(e.pop().concat(e.shift())),g.push(e.filter(qe))}var g,p,v,d=t(i),m=u.invert(r[0],r[1]),y={point:o,lineStart:c,lineEnd:s,polygonStart:function(){y.point=l,y.lineStart=f,y.lineEnd=h,g=[],p=[]},polygonEnd:function(){y.point=o,y.lineStart=c,y.lineEnd=s,g=Wo.merge(g);var n=De(m,p);g.length?(_||(i.polygonStart(),_=!0),Ce(g,Re,n,e,i)):n&&(_||(i.polygonStart(),_=!0),i.lineStart(),e(null,null,1,i),i.lineEnd()),_&&(i.polygonEnd(),_=!1),g=p=null},sphere:function(){i.polygonStart(),i.lineStart(),e(null,null,1,i),i.lineEnd(),i.polygonEnd()}},x=ze(),M=t(x),_=!1;return y}}function qe(n){return n.length>1}function ze(){var n,t=[];return{lineStart:function(){t.push(n=[])},point:function(t,e){n.push([t,e])},lineEnd:v,buffer:function(){var e=t;return t=[],n=null,e},rejoin:function(){t.length>1&&t.push(t.pop().concat(t.shift()))}}}function Re(n,t){return((n=n.x)[0]<0?n[1]-Ta-La:Ta-n[1])-((t=t.x)[0]<0?t[1]-Ta-La:Ta-t[1])}function De(n,t){var e=n[0],r=n[1],u=[Math.sin(e),-Math.cos(e),0],i=0,o=0;dc.reset();for(var a=0,c=t.length;c>a;++a){var s=t[a],l=s.length;if(l)for(var f=s[0],h=f[0],g=f[1]/2+Ca/4,p=Math.sin(g),v=Math.cos(g),d=1;;){d===l&&(d=0),n=s[d];var m=n[0],y=n[1]/2+Ca/4,x=Math.sin(y),M=Math.cos(y),_=m-h,b=_>=0?1:-1,w=b*_,S=w>Ca,k=p*x;if(dc.add(Math.atan2(k*b*Math.sin(w),v*M+k*Math.cos(w))),i+=S?_+b*Na:_,S^h>=e^m>=e){var E=de(pe(f),pe(n));xe(E);var A=de(u,E);xe(A);var C=(S^_>=0?-1:1)*W(A[2]);(r>C||r===C&&(E[0]||E[1]))&&(o+=S^_>=0?1:-1)}if(!d++)break;h=m,p=x,v=M,f=n}}return(-La>i||La>i&&0>dc)^1&o}function Pe(n){var t,e=0/0,r=0/0,u=0/0;return{lineStart:function(){n.lineStart(),t=1},point:function(i,o){var a=i>0?Ca:-Ca,c=fa(i-e);fa(c-Ca)<La?(n.point(e,r=(r+o)/2>0?Ta:-Ta),n.point(u,r),n.lineEnd(),n.lineStart(),n.point(a,r),n.point(i,r),t=0):u!==a&&c>=Ca&&(fa(e-u)<La&&(e-=u*La),fa(i-a)<La&&(i-=a*La),r=je(e,r,i,o),n.point(u,r),n.lineEnd(),n.lineStart(),n.point(a,r),t=0),n.point(e=i,r=o),u=a},lineEnd:function(){n.lineEnd(),e=r=0/0},clean:function(){return 2-t}}}function je(n,t,e,r){var u,i,o=Math.sin(n-e);return fa(o)>La?Math.atan((Math.sin(t)*(i=Math.cos(r))*Math.sin(e)-Math.sin(r)*(u=Math.cos(t))*Math.sin(n))/(u*i*o)):(t+r)/2}function Ue(n,t,e,r){var u;if(null==n)u=e*Ta,r.point(-Ca,u),r.point(0,u),r.point(Ca,u),r.point(Ca,0),r.point(Ca,-u),r.point(0,-u),r.point(-Ca,-u),r.point(-Ca,0),r.point(-Ca,u);else if(fa(n[0]-t[0])>La){var i=n[0]<t[0]?Ca:-Ca;u=e*i/2,r.point(-i,u),r.point(0,u),r.point(i,u)}else r.point(t[0],t[1])}function He(n){function t(n,t){return Math.cos(n)*Math.cos(t)>i}function e(n){var e,i,c,s,l;return{lineStart:function(){s=c=!1,l=1},point:function(f,h){var g,p=[f,h],v=t(f,h),d=o?v?0:u(f,h):v?u(f+(0>f?Ca:-Ca),h):0;if(!e&&(s=c=v)&&n.lineStart(),v!==c&&(g=r(e,p),(_e(e,g)||_e(p,g))&&(p[0]+=La,p[1]+=La,v=t(p[0],p[1]))),v!==c)l=0,v?(n.lineStart(),g=r(p,e),n.point(g[0],g[1])):(g=r(e,p),n.point(g[0],g[1]),n.lineEnd()),e=g;else if(a&&e&&o^v){var m;d&i||!(m=r(p,e,!0))||(l=0,o?(n.lineStart(),n.point(m[0][0],m[0][1]),n.point(m[1][0],m[1][1]),n.lineEnd()):(n.point(m[1][0],m[1][1]),n.lineEnd(),n.lineStart(),n.point(m[0][0],m[0][1])))}!v||e&&_e(e,p)||n.point(p[0],p[1]),e=p,c=v,i=d},lineEnd:function(){c&&n.lineEnd(),e=null},clean:function(){return l|(s&&c)<<1}}}function r(n,t,e){var r=pe(n),u=pe(t),o=[1,0,0],a=de(r,u),c=ve(a,a),s=a[0],l=c-s*s;if(!l)return!e&&n;var f=i*c/l,h=-i*s/l,g=de(o,a),p=ye(o,f),v=ye(a,h);me(p,v);var d=g,m=ve(p,d),y=ve(d,d),x=m*m-y*(ve(p,p)-1);if(!(0>x)){var M=Math.sqrt(x),_=ye(d,(-m-M)/y);if(me(_,p),_=Me(_),!e)return _;var b,w=n[0],S=t[0],k=n[1],E=t[1];w>S&&(b=w,w=S,S=b);var A=S-w,C=fa(A-Ca)<La,N=C||La>A;if(!C&&k>E&&(b=k,k=E,E=b),N?C?k+E>0^_[1]<(fa(_[0]-w)<La?k:E):k<=_[1]&&_[1]<=E:A>Ca^(w<=_[0]&&_[0]<=S)){var T=ye(d,(-m+M)/y);return me(T,p),[_,Me(T)]}}}function u(t,e){var r=o?n:Ca-n,u=0;return-r>t?u|=1:t>r&&(u|=2),-r>e?u|=4:e>r&&(u|=8),u}var i=Math.cos(n),o=i>0,a=fa(i)>La,c=gr(n,6*za);return Le(t,e,c,o?[0,-n]:[-Ca,n-Ca])}function Oe(n,t,e,r){return function(u){var i,o=u.a,a=u.b,c=o.x,s=o.y,l=a.x,f=a.y,h=0,g=1,p=l-c,v=f-s;if(i=n-c,p||!(i>0)){if(i/=p,0>p){if(h>i)return;g>i&&(g=i)}else if(p>0){if(i>g)return;i>h&&(h=i)}if(i=e-c,p||!(0>i)){if(i/=p,0>p){if(i>g)return;i>h&&(h=i)}else if(p>0){if(h>i)return;g>i&&(g=i)}if(i=t-s,v||!(i>0)){if(i/=v,0>v){if(h>i)return;g>i&&(g=i)}else if(v>0){if(i>g)return;i>h&&(h=i)}if(i=r-s,v||!(0>i)){if(i/=v,0>v){if(i>g)return;i>h&&(h=i)}else if(v>0){if(h>i)return;g>i&&(g=i)}return h>0&&(u.a={x:c+h*p,y:s+h*v}),1>g&&(u.b={x:c+g*p,y:s+g*v}),u}}}}}}function Fe(n,t,e,r){function u(r,u){return fa(r[0]-n)<La?u>0?0:3:fa(r[0]-e)<La?u>0?2:1:fa(r[1]-t)<La?u>0?1:0:u>0?3:2}function i(n,t){return o(n.x,t.x)}function o(n,t){var e=u(n,1),r=u(t,1);return e!==r?e-r:0===e?t[1]-n[1]:1===e?n[0]-t[0]:2===e?n[1]-t[1]:t[0]-n[0]}return function(a){function c(n){for(var t=0,e=d.length,r=n[1],u=0;e>u;++u)for(var i,o=1,a=d[u],c=a.length,s=a[0];c>o;++o)i=a[o],s[1]<=r?i[1]>r&&G(s,i,n)>0&&++t:i[1]<=r&&G(s,i,n)<0&&--t,s=i;return 0!==t}function s(i,a,c,s){var l=0,f=0;if(null==i||(l=u(i,c))!==(f=u(a,c))||o(i,a)<0^c>0){do s.point(0===l||3===l?n:e,l>1?r:t);while((l=(l+c+4)%4)!==f)}else s.point(a[0],a[1])}function l(u,i){return u>=n&&e>=u&&i>=t&&r>=i}function f(n,t){l(n,t)&&a.point(n,t)}function h(){N.point=p,d&&d.push(m=[]),S=!0,w=!1,_=b=0/0}function g(){v&&(p(y,x),M&&w&&A.rejoin(),v.push(A.buffer())),N.point=f,w&&a.lineEnd()}function p(n,t){n=Math.max(-Lc,Math.min(Lc,n)),t=Math.max(-Lc,Math.min(Lc,t));var e=l(n,t);if(d&&m.push([n,t]),S)y=n,x=t,M=e,S=!1,e&&(a.lineStart(),a.point(n,t));else if(e&&w)a.point(n,t);else{var r={a:{x:_,y:b},b:{x:n,y:t}};C(r)?(w||(a.lineStart(),a.point(r.a.x,r.a.y)),a.point(r.b.x,r.b.y),e||a.lineEnd(),k=!1):e&&(a.lineStart(),a.point(n,t),k=!1)}_=n,b=t,w=e}var v,d,m,y,x,M,_,b,w,S,k,E=a,A=ze(),C=Oe(n,t,e,r),N={point:f,lineStart:h,lineEnd:g,polygonStart:function(){a=A,v=[],d=[],k=!0},polygonEnd:function(){a=E,v=Wo.merge(v);var t=c([n,r]),e=k&&t,u=v.length;(e||u)&&(a.polygonStart(),e&&(a.lineStart(),s(null,null,1,a),a.lineEnd()),u&&Ce(v,i,t,s,a),a.polygonEnd()),v=d=m=null}};return N}}function Ie(n,t){function e(e,r){return e=n(e,r),t(e[0],e[1])}return n.invert&&t.invert&&(e.invert=function(e,r){return e=t.invert(e,r),e&&n.invert(e[0],e[1])}),e}function Ye(n){var t=0,e=Ca/3,r=ir(n),u=r(t,e);return u.parallels=function(n){return arguments.length?r(t=n[0]*Ca/180,e=n[1]*Ca/180):[180*(t/Ca),180*(e/Ca)]},u}function Ze(n,t){function e(n,t){var e=Math.sqrt(i-2*u*Math.sin(t))/u;return[e*Math.sin(n*=u),o-e*Math.cos(n)]}var r=Math.sin(n),u=(r+Math.sin(t))/2,i=1+r*(2*u-r),o=Math.sqrt(i)/u;return e.invert=function(n,t){var e=o-t;return[Math.atan2(n,e)/u,W((i-(n*n+e*e)*u*u)/(2*u))]},e}function Ve(){function n(n,t){zc+=u*n-r*t,r=n,u=t}var t,e,r,u;Uc.point=function(i,o){Uc.point=n,t=r=i,e=u=o},Uc.lineEnd=function(){n(t,e)}}function $e(n,t){Rc>n&&(Rc=n),n>Pc&&(Pc=n),Dc>t&&(Dc=t),t>jc&&(jc=t)}function Xe(){function n(n,t){o.push("M",n,",",t,i)}function t(n,t){o.push("M",n,",",t),a.point=e}function e(n,t){o.push("L",n,",",t)}function r(){a.point=n}function u(){o.push("Z")}var i=Be(4.5),o=[],a={point:n,lineStart:function(){a.point=t},lineEnd:r,polygonStart:function(){a.lineEnd=u},polygonEnd:function(){a.lineEnd=r,a.point=n},pointRadius:function(n){return i=Be(n),a},result:function(){if(o.length){var n=o.join("");return o=[],n}}};return a}function Be(n){return"m0,"+n+"a"+n+","+n+" 0 1,1 0,"+-2*n+"a"+n+","+n+" 0 1,1 0,"+2*n+"z"}function Ge(n,t){Mc+=n,_c+=t,++bc}function Je(){function n(n,r){var u=n-t,i=r-e,o=Math.sqrt(u*u+i*i);wc+=o*(t+n)/2,Sc+=o*(e+r)/2,kc+=o,Ge(t=n,e=r)}var t,e;Oc.point=function(r,u){Oc.point=n,Ge(t=r,e=u)}}function We(){Oc.point=Ge}function Ke(){function n(n,t){var e=n-r,i=t-u,o=Math.sqrt(e*e+i*i);wc+=o*(r+n)/2,Sc+=o*(u+t)/2,kc+=o,o=u*n-r*t,Ec+=o*(r+n),Ac+=o*(u+t),Cc+=3*o,Ge(r=n,u=t)}var t,e,r,u;Oc.point=function(i,o){Oc.point=n,Ge(t=r=i,e=u=o)},Oc.lineEnd=function(){n(t,e)}}function Qe(n){function t(t,e){n.moveTo(t,e),n.arc(t,e,o,0,Na)}function e(t,e){n.moveTo(t,e),a.point=r}function r(t,e){n.lineTo(t,e)}function u(){a.point=t}function i(){n.closePath()}var o=4.5,a={point:t,lineStart:function(){a.point=e},lineEnd:u,polygonStart:function(){a.lineEnd=i},polygonEnd:function(){a.lineEnd=u,a.point=t},pointRadius:function(n){return o=n,a},result:v};return a}function nr(n){function t(n){return(a?r:e)(n)}function e(t){return rr(t,function(e,r){e=n(e,r),t.point(e[0],e[1])})}function r(t){function e(e,r){e=n(e,r),t.point(e[0],e[1])}function r(){x=0/0,S.point=i,t.lineStart()}function i(e,r){var i=pe([e,r]),o=n(e,r);u(x,M,y,_,b,w,x=o[0],M=o[1],y=e,_=i[0],b=i[1],w=i[2],a,t),t.point(x,M)}function o(){S.point=e,t.lineEnd()}function c(){r(),S.point=s,S.lineEnd=l}function s(n,t){i(f=n,h=t),g=x,p=M,v=_,d=b,m=w,S.point=i}function l(){u(x,M,y,_,b,w,g,p,f,v,d,m,a,t),S.lineEnd=o,o()}var f,h,g,p,v,d,m,y,x,M,_,b,w,S={point:e,lineStart:r,lineEnd:o,polygonStart:function(){t.polygonStart(),S.lineStart=c},polygonEnd:function(){t.polygonEnd(),S.lineStart=r}};return S}function u(t,e,r,a,c,s,l,f,h,g,p,v,d,m){var y=l-t,x=f-e,M=y*y+x*x;if(M>4*i&&d--){var _=a+g,b=c+p,w=s+v,S=Math.sqrt(_*_+b*b+w*w),k=Math.asin(w/=S),E=fa(fa(w)-1)<La||fa(r-h)<La?(r+h)/2:Math.atan2(b,_),A=n(E,k),C=A[0],N=A[1],T=C-t,L=N-e,q=x*T-y*L;(q*q/M>i||fa((y*T+x*L)/M-.5)>.3||o>a*g+c*p+s*v)&&(u(t,e,r,a,c,s,C,N,E,_/=S,b/=S,w,d,m),m.point(C,N),u(C,N,E,_,b,w,l,f,h,g,p,v,d,m))}}var i=.5,o=Math.cos(30*za),a=16;return t.precision=function(n){return arguments.length?(a=(i=n*n)>0&&16,t):Math.sqrt(i)},t}function tr(n){var t=nr(function(t,e){return n([t*Ra,e*Ra])});return function(n){return or(t(n))}}function er(n){this.stream=n}function rr(n,t){return{point:t,sphere:function(){n.sphere()},lineStart:function(){n.lineStart()},lineEnd:function(){n.lineEnd()},polygonStart:function(){n.polygonStart()},polygonEnd:function(){n.polygonEnd()}}}function ur(n){return ir(function(){return n})()}function ir(n){function t(n){return n=a(n[0]*za,n[1]*za),[n[0]*h+c,s-n[1]*h]}function e(n){return n=a.invert((n[0]-c)/h,(s-n[1])/h),n&&[n[0]*Ra,n[1]*Ra]
}function r(){a=Ie(o=sr(m,y,x),i);var n=i(v,d);return c=g-n[0]*h,s=p+n[1]*h,u()}function u(){return l&&(l.valid=!1,l=null),t}var i,o,a,c,s,l,f=nr(function(n,t){return n=i(n,t),[n[0]*h+c,s-n[1]*h]}),h=150,g=480,p=250,v=0,d=0,m=0,y=0,x=0,M=Tc,_=At,b=null,w=null;return t.stream=function(n){return l&&(l.valid=!1),l=or(M(o,f(_(n)))),l.valid=!0,l},t.clipAngle=function(n){return arguments.length?(M=null==n?(b=n,Tc):He((b=+n)*za),u()):b},t.clipExtent=function(n){return arguments.length?(w=n,_=n?Fe(n[0][0],n[0][1],n[1][0],n[1][1]):At,u()):w},t.scale=function(n){return arguments.length?(h=+n,r()):h},t.translate=function(n){return arguments.length?(g=+n[0],p=+n[1],r()):[g,p]},t.center=function(n){return arguments.length?(v=n[0]%360*za,d=n[1]%360*za,r()):[v*Ra,d*Ra]},t.rotate=function(n){return arguments.length?(m=n[0]%360*za,y=n[1]%360*za,x=n.length>2?n[2]%360*za:0,r()):[m*Ra,y*Ra,x*Ra]},Wo.rebind(t,f,"precision"),function(){return i=n.apply(this,arguments),t.invert=i.invert&&e,r()}}function or(n){return rr(n,function(t,e){n.point(t*za,e*za)})}function ar(n,t){return[n,t]}function cr(n,t){return[n>Ca?n-Na:-Ca>n?n+Na:n,t]}function sr(n,t,e){return n?t||e?Ie(fr(n),hr(t,e)):fr(n):t||e?hr(t,e):cr}function lr(n){return function(t,e){return t+=n,[t>Ca?t-Na:-Ca>t?t+Na:t,e]}}function fr(n){var t=lr(n);return t.invert=lr(-n),t}function hr(n,t){function e(n,t){var e=Math.cos(t),a=Math.cos(n)*e,c=Math.sin(n)*e,s=Math.sin(t),l=s*r+a*u;return[Math.atan2(c*i-l*o,a*r-s*u),W(l*i+c*o)]}var r=Math.cos(n),u=Math.sin(n),i=Math.cos(t),o=Math.sin(t);return e.invert=function(n,t){var e=Math.cos(t),a=Math.cos(n)*e,c=Math.sin(n)*e,s=Math.sin(t),l=s*i-c*o;return[Math.atan2(c*i+s*o,a*r+l*u),W(l*r-a*u)]},e}function gr(n,t){var e=Math.cos(n),r=Math.sin(n);return function(u,i,o,a){var c=o*t;null!=u?(u=pr(e,u),i=pr(e,i),(o>0?i>u:u>i)&&(u+=o*Na)):(u=n+o*Na,i=n-.5*c);for(var s,l=u;o>0?l>i:i>l;l-=c)a.point((s=Me([e,-r*Math.cos(l),-r*Math.sin(l)]))[0],s[1])}}function pr(n,t){var e=pe(t);e[0]-=n,xe(e);var r=J(-e[1]);return((-e[2]<0?-r:r)+2*Math.PI-La)%(2*Math.PI)}function vr(n,t,e){var r=Wo.range(n,t-La,e).concat(t);return function(n){return r.map(function(t){return[n,t]})}}function dr(n,t,e){var r=Wo.range(n,t-La,e).concat(t);return function(n){return r.map(function(t){return[t,n]})}}function mr(n){return n.source}function yr(n){return n.target}function xr(n,t,e,r){var u=Math.cos(t),i=Math.sin(t),o=Math.cos(r),a=Math.sin(r),c=u*Math.cos(n),s=u*Math.sin(n),l=o*Math.cos(e),f=o*Math.sin(e),h=2*Math.asin(Math.sqrt(tt(r-t)+u*o*tt(e-n))),g=1/Math.sin(h),p=h?function(n){var t=Math.sin(n*=h)*g,e=Math.sin(h-n)*g,r=e*c+t*l,u=e*s+t*f,o=e*i+t*a;return[Math.atan2(u,r)*Ra,Math.atan2(o,Math.sqrt(r*r+u*u))*Ra]}:function(){return[n*Ra,t*Ra]};return p.distance=h,p}function Mr(){function n(n,u){var i=Math.sin(u*=za),o=Math.cos(u),a=fa((n*=za)-t),c=Math.cos(a);Fc+=Math.atan2(Math.sqrt((a=o*Math.sin(a))*a+(a=r*i-e*o*c)*a),e*i+r*o*c),t=n,e=i,r=o}var t,e,r;Ic.point=function(u,i){t=u*za,e=Math.sin(i*=za),r=Math.cos(i),Ic.point=n},Ic.lineEnd=function(){Ic.point=Ic.lineEnd=v}}function _r(n,t){function e(t,e){var r=Math.cos(t),u=Math.cos(e),i=n(r*u);return[i*u*Math.sin(t),i*Math.sin(e)]}return e.invert=function(n,e){var r=Math.sqrt(n*n+e*e),u=t(r),i=Math.sin(u),o=Math.cos(u);return[Math.atan2(n*i,r*o),Math.asin(r&&e*i/r)]},e}function br(n,t){function e(n,t){o>0?-Ta+La>t&&(t=-Ta+La):t>Ta-La&&(t=Ta-La);var e=o/Math.pow(u(t),i);return[e*Math.sin(i*n),o-e*Math.cos(i*n)]}var r=Math.cos(n),u=function(n){return Math.tan(Ca/4+n/2)},i=n===t?Math.sin(n):Math.log(r/Math.cos(t))/Math.log(u(t)/u(n)),o=r*Math.pow(u(n),i)/i;return i?(e.invert=function(n,t){var e=o-t,r=B(i)*Math.sqrt(n*n+e*e);return[Math.atan2(n,e)/i,2*Math.atan(Math.pow(o/r,1/i))-Ta]},e):Sr}function wr(n,t){function e(n,t){var e=i-t;return[e*Math.sin(u*n),i-e*Math.cos(u*n)]}var r=Math.cos(n),u=n===t?Math.sin(n):(r-Math.cos(t))/(t-n),i=r/u+n;return fa(u)<La?ar:(e.invert=function(n,t){var e=i-t;return[Math.atan2(n,e)/u,i-B(u)*Math.sqrt(n*n+e*e)]},e)}function Sr(n,t){return[n,Math.log(Math.tan(Ca/4+t/2))]}function kr(n){var t,e=ur(n),r=e.scale,u=e.translate,i=e.clipExtent;return e.scale=function(){var n=r.apply(e,arguments);return n===e?t?e.clipExtent(null):e:n},e.translate=function(){var n=u.apply(e,arguments);return n===e?t?e.clipExtent(null):e:n},e.clipExtent=function(n){var o=i.apply(e,arguments);if(o===e){if(t=null==n){var a=Ca*r(),c=u();i([[c[0]-a,c[1]-a],[c[0]+a,c[1]+a]])}}else t&&(o=null);return o},e.clipExtent(null)}function Er(n,t){return[Math.log(Math.tan(Ca/4+t/2)),-n]}function Ar(n){return n[0]}function Cr(n){return n[1]}function Nr(n){for(var t=n.length,e=[0,1],r=2,u=2;t>u;u++){for(;r>1&&G(n[e[r-2]],n[e[r-1]],n[u])<=0;)--r;e[r++]=u}return e.slice(0,r)}function Tr(n,t){return n[0]-t[0]||n[1]-t[1]}function Lr(n,t,e){return(e[0]-t[0])*(n[1]-t[1])<(e[1]-t[1])*(n[0]-t[0])}function qr(n,t,e,r){var u=n[0],i=e[0],o=t[0]-u,a=r[0]-i,c=n[1],s=e[1],l=t[1]-c,f=r[1]-s,h=(a*(c-s)-f*(u-i))/(f*o-a*l);return[u+h*o,c+h*l]}function zr(n){var t=n[0],e=n[n.length-1];return!(t[0]-e[0]||t[1]-e[1])}function Rr(){tu(this),this.edge=this.site=this.circle=null}function Dr(n){var t=ns.pop()||new Rr;return t.site=n,t}function Pr(n){$r(n),Wc.remove(n),ns.push(n),tu(n)}function jr(n){var t=n.circle,e=t.x,r=t.cy,u={x:e,y:r},i=n.P,o=n.N,a=[n];Pr(n);for(var c=i;c.circle&&fa(e-c.circle.x)<La&&fa(r-c.circle.cy)<La;)i=c.P,a.unshift(c),Pr(c),c=i;a.unshift(c),$r(c);for(var s=o;s.circle&&fa(e-s.circle.x)<La&&fa(r-s.circle.cy)<La;)o=s.N,a.push(s),Pr(s),s=o;a.push(s),$r(s);var l,f=a.length;for(l=1;f>l;++l)s=a[l],c=a[l-1],Kr(s.edge,c.site,s.site,u);c=a[0],s=a[f-1],s.edge=Jr(c.site,s.site,null,u),Vr(c),Vr(s)}function Ur(n){for(var t,e,r,u,i=n.x,o=n.y,a=Wc._;a;)if(r=Hr(a,o)-i,r>La)a=a.L;else{if(u=i-Or(a,o),!(u>La)){r>-La?(t=a.P,e=a):u>-La?(t=a,e=a.N):t=e=a;break}if(!a.R){t=a;break}a=a.R}var c=Dr(n);if(Wc.insert(t,c),t||e){if(t===e)return $r(t),e=Dr(t.site),Wc.insert(c,e),c.edge=e.edge=Jr(t.site,c.site),Vr(t),Vr(e),void 0;if(!e)return c.edge=Jr(t.site,c.site),void 0;$r(t),$r(e);var s=t.site,l=s.x,f=s.y,h=n.x-l,g=n.y-f,p=e.site,v=p.x-l,d=p.y-f,m=2*(h*d-g*v),y=h*h+g*g,x=v*v+d*d,M={x:(d*y-g*x)/m+l,y:(h*x-v*y)/m+f};Kr(e.edge,s,p,M),c.edge=Jr(s,n,null,M),e.edge=Jr(n,p,null,M),Vr(t),Vr(e)}}function Hr(n,t){var e=n.site,r=e.x,u=e.y,i=u-t;if(!i)return r;var o=n.P;if(!o)return-1/0;e=o.site;var a=e.x,c=e.y,s=c-t;if(!s)return a;var l=a-r,f=1/i-1/s,h=l/s;return f?(-h+Math.sqrt(h*h-2*f*(l*l/(-2*s)-c+s/2+u-i/2)))/f+r:(r+a)/2}function Or(n,t){var e=n.N;if(e)return Hr(e,t);var r=n.site;return r.y===t?r.x:1/0}function Fr(n){this.site=n,this.edges=[]}function Ir(n){for(var t,e,r,u,i,o,a,c,s,l,f=n[0][0],h=n[1][0],g=n[0][1],p=n[1][1],v=Jc,d=v.length;d--;)if(i=v[d],i&&i.prepare())for(a=i.edges,c=a.length,o=0;c>o;)l=a[o].end(),r=l.x,u=l.y,s=a[++o%c].start(),t=s.x,e=s.y,(fa(r-t)>La||fa(u-e)>La)&&(a.splice(o,0,new Qr(Wr(i.site,l,fa(r-f)<La&&p-u>La?{x:f,y:fa(t-f)<La?e:p}:fa(u-p)<La&&h-r>La?{x:fa(e-p)<La?t:h,y:p}:fa(r-h)<La&&u-g>La?{x:h,y:fa(t-h)<La?e:g}:fa(u-g)<La&&r-f>La?{x:fa(e-g)<La?t:f,y:g}:null),i.site,null)),++c)}function Yr(n,t){return t.angle-n.angle}function Zr(){tu(this),this.x=this.y=this.arc=this.site=this.cy=null}function Vr(n){var t=n.P,e=n.N;if(t&&e){var r=t.site,u=n.site,i=e.site;if(r!==i){var o=u.x,a=u.y,c=r.x-o,s=r.y-a,l=i.x-o,f=i.y-a,h=2*(c*f-s*l);if(!(h>=-qa)){var g=c*c+s*s,p=l*l+f*f,v=(f*g-s*p)/h,d=(c*p-l*g)/h,f=d+a,m=ts.pop()||new Zr;m.arc=n,m.site=u,m.x=v+o,m.y=f+Math.sqrt(v*v+d*d),m.cy=f,n.circle=m;for(var y=null,x=Qc._;x;)if(m.y<x.y||m.y===x.y&&m.x<=x.x){if(!x.L){y=x.P;break}x=x.L}else{if(!x.R){y=x;break}x=x.R}Qc.insert(y,m),y||(Kc=m)}}}}function $r(n){var t=n.circle;t&&(t.P||(Kc=t.N),Qc.remove(t),ts.push(t),tu(t),n.circle=null)}function Xr(n){for(var t,e=Gc,r=Oe(n[0][0],n[0][1],n[1][0],n[1][1]),u=e.length;u--;)t=e[u],(!Br(t,n)||!r(t)||fa(t.a.x-t.b.x)<La&&fa(t.a.y-t.b.y)<La)&&(t.a=t.b=null,e.splice(u,1))}function Br(n,t){var e=n.b;if(e)return!0;var r,u,i=n.a,o=t[0][0],a=t[1][0],c=t[0][1],s=t[1][1],l=n.l,f=n.r,h=l.x,g=l.y,p=f.x,v=f.y,d=(h+p)/2,m=(g+v)/2;if(v===g){if(o>d||d>=a)return;if(h>p){if(i){if(i.y>=s)return}else i={x:d,y:c};e={x:d,y:s}}else{if(i){if(i.y<c)return}else i={x:d,y:s};e={x:d,y:c}}}else if(r=(h-p)/(v-g),u=m-r*d,-1>r||r>1)if(h>p){if(i){if(i.y>=s)return}else i={x:(c-u)/r,y:c};e={x:(s-u)/r,y:s}}else{if(i){if(i.y<c)return}else i={x:(s-u)/r,y:s};e={x:(c-u)/r,y:c}}else if(v>g){if(i){if(i.x>=a)return}else i={x:o,y:r*o+u};e={x:a,y:r*a+u}}else{if(i){if(i.x<o)return}else i={x:a,y:r*a+u};e={x:o,y:r*o+u}}return n.a=i,n.b=e,!0}function Gr(n,t){this.l=n,this.r=t,this.a=this.b=null}function Jr(n,t,e,r){var u=new Gr(n,t);return Gc.push(u),e&&Kr(u,n,t,e),r&&Kr(u,t,n,r),Jc[n.i].edges.push(new Qr(u,n,t)),Jc[t.i].edges.push(new Qr(u,t,n)),u}function Wr(n,t,e){var r=new Gr(n,null);return r.a=t,r.b=e,Gc.push(r),r}function Kr(n,t,e,r){n.a||n.b?n.l===e?n.b=r:n.a=r:(n.a=r,n.l=t,n.r=e)}function Qr(n,t,e){var r=n.a,u=n.b;this.edge=n,this.site=t,this.angle=e?Math.atan2(e.y-t.y,e.x-t.x):n.l===t?Math.atan2(u.x-r.x,r.y-u.y):Math.atan2(r.x-u.x,u.y-r.y)}function nu(){this._=null}function tu(n){n.U=n.C=n.L=n.R=n.P=n.N=null}function eu(n,t){var e=t,r=t.R,u=e.U;u?u.L===e?u.L=r:u.R=r:n._=r,r.U=u,e.U=r,e.R=r.L,e.R&&(e.R.U=e),r.L=e}function ru(n,t){var e=t,r=t.L,u=e.U;u?u.L===e?u.L=r:u.R=r:n._=r,r.U=u,e.U=r,e.L=r.R,e.L&&(e.L.U=e),r.R=e}function uu(n){for(;n.L;)n=n.L;return n}function iu(n,t){var e,r,u,i=n.sort(ou).pop();for(Gc=[],Jc=new Array(n.length),Wc=new nu,Qc=new nu;;)if(u=Kc,i&&(!u||i.y<u.y||i.y===u.y&&i.x<u.x))(i.x!==e||i.y!==r)&&(Jc[i.i]=new Fr(i),Ur(i),e=i.x,r=i.y),i=n.pop();else{if(!u)break;jr(u.arc)}t&&(Xr(t),Ir(t));var o={cells:Jc,edges:Gc};return Wc=Qc=Gc=Jc=null,o}function ou(n,t){return t.y-n.y||t.x-n.x}function au(n,t,e){return(n.x-e.x)*(t.y-n.y)-(n.x-t.x)*(e.y-n.y)}function cu(n){return n.x}function su(n){return n.y}function lu(){return{leaf:!0,nodes:[],point:null,x:null,y:null}}function fu(n,t,e,r,u,i){if(!n(t,e,r,u,i)){var o=.5*(e+u),a=.5*(r+i),c=t.nodes;c[0]&&fu(n,c[0],e,r,o,a),c[1]&&fu(n,c[1],o,r,u,a),c[2]&&fu(n,c[2],e,a,o,i),c[3]&&fu(n,c[3],o,a,u,i)}}function hu(n,t){n=Wo.rgb(n),t=Wo.rgb(t);var e=n.r,r=n.g,u=n.b,i=t.r-e,o=t.g-r,a=t.b-u;return function(n){return"#"+Mt(Math.round(e+i*n))+Mt(Math.round(r+o*n))+Mt(Math.round(u+a*n))}}function gu(n,t){var e,r={},u={};for(e in n)e in t?r[e]=du(n[e],t[e]):u[e]=n[e];for(e in t)e in n||(u[e]=t[e]);return function(n){for(e in r)u[e]=r[e](n);return u}}function pu(n,t){return t-=n=+n,function(e){return n+t*e}}function vu(n,t){var e,r,u,i=rs.lastIndex=us.lastIndex=0,o=-1,a=[],c=[];for(n+="",t+="";(e=rs.exec(n))&&(r=us.exec(t));)(u=r.index)>i&&(u=t.substring(i,u),a[o]?a[o]+=u:a[++o]=u),(e=e[0])===(r=r[0])?a[o]?a[o]+=r:a[++o]=r:(a[++o]=null,c.push({i:o,x:pu(e,r)})),i=us.lastIndex;return i<t.length&&(u=t.substring(i),a[o]?a[o]+=u:a[++o]=u),a.length<2?c[0]?(t=c[0].x,function(n){return t(n)+""}):function(){return t}:(t=c.length,function(n){for(var e,r=0;t>r;++r)a[(e=c[r]).i]=e.x(n);return a.join("")})}function du(n,t){for(var e,r=Wo.interpolators.length;--r>=0&&!(e=Wo.interpolators[r](n,t)););return e}function mu(n,t){var e,r=[],u=[],i=n.length,o=t.length,a=Math.min(n.length,t.length);for(e=0;a>e;++e)r.push(du(n[e],t[e]));for(;i>e;++e)u[e]=n[e];for(;o>e;++e)u[e]=t[e];return function(n){for(e=0;a>e;++e)u[e]=r[e](n);return u}}function yu(n){return function(t){return 0>=t?0:t>=1?1:n(t)}}function xu(n){return function(t){return 1-n(1-t)}}function Mu(n){return function(t){return.5*(.5>t?n(2*t):2-n(2-2*t))}}function _u(n){return n*n}function bu(n){return n*n*n}function wu(n){if(0>=n)return 0;if(n>=1)return 1;var t=n*n,e=t*n;return 4*(.5>n?e:3*(n-t)+e-.75)}function Su(n){return function(t){return Math.pow(t,n)}}function ku(n){return 1-Math.cos(n*Ta)}function Eu(n){return Math.pow(2,10*(n-1))}function Au(n){return 1-Math.sqrt(1-n*n)}function Cu(n,t){var e;return arguments.length<2&&(t=.45),arguments.length?e=t/Na*Math.asin(1/n):(n=1,e=t/4),function(r){return 1+n*Math.pow(2,-10*r)*Math.sin((r-e)*Na/t)}}function Nu(n){return n||(n=1.70158),function(t){return t*t*((n+1)*t-n)}}function Tu(n){return 1/2.75>n?7.5625*n*n:2/2.75>n?7.5625*(n-=1.5/2.75)*n+.75:2.5/2.75>n?7.5625*(n-=2.25/2.75)*n+.9375:7.5625*(n-=2.625/2.75)*n+.984375}function Lu(n,t){n=Wo.hcl(n),t=Wo.hcl(t);var e=n.h,r=n.c,u=n.l,i=t.h-e,o=t.c-r,a=t.l-u;return isNaN(o)&&(o=0,r=isNaN(r)?t.c:r),isNaN(i)?(i=0,e=isNaN(e)?t.h:e):i>180?i-=360:-180>i&&(i+=360),function(n){return ct(e+i*n,r+o*n,u+a*n)+""}}function qu(n,t){n=Wo.hsl(n),t=Wo.hsl(t);var e=n.h,r=n.s,u=n.l,i=t.h-e,o=t.s-r,a=t.l-u;return isNaN(o)&&(o=0,r=isNaN(r)?t.s:r),isNaN(i)?(i=0,e=isNaN(e)?t.h:e):i>180?i-=360:-180>i&&(i+=360),function(n){return it(e+i*n,r+o*n,u+a*n)+""}}function zu(n,t){n=Wo.lab(n),t=Wo.lab(t);var e=n.l,r=n.a,u=n.b,i=t.l-e,o=t.a-r,a=t.b-u;return function(n){return ft(e+i*n,r+o*n,u+a*n)+""}}function Ru(n,t){return t-=n,function(e){return Math.round(n+t*e)}}function Du(n){var t=[n.a,n.b],e=[n.c,n.d],r=ju(t),u=Pu(t,e),i=ju(Uu(e,t,-u))||0;t[0]*e[1]<e[0]*t[1]&&(t[0]*=-1,t[1]*=-1,r*=-1,u*=-1),this.rotate=(r?Math.atan2(t[1],t[0]):Math.atan2(-e[0],e[1]))*Ra,this.translate=[n.e,n.f],this.scale=[r,i],this.skew=i?Math.atan2(u,i)*Ra:0}function Pu(n,t){return n[0]*t[0]+n[1]*t[1]}function ju(n){var t=Math.sqrt(Pu(n,n));return t&&(n[0]/=t,n[1]/=t),t}function Uu(n,t,e){return n[0]+=e*t[0],n[1]+=e*t[1],n}function Hu(n,t){var e,r=[],u=[],i=Wo.transform(n),o=Wo.transform(t),a=i.translate,c=o.translate,s=i.rotate,l=o.rotate,f=i.skew,h=o.skew,g=i.scale,p=o.scale;return a[0]!=c[0]||a[1]!=c[1]?(r.push("translate(",null,",",null,")"),u.push({i:1,x:pu(a[0],c[0])},{i:3,x:pu(a[1],c[1])})):c[0]||c[1]?r.push("translate("+c+")"):r.push(""),s!=l?(s-l>180?l+=360:l-s>180&&(s+=360),u.push({i:r.push(r.pop()+"rotate(",null,")")-2,x:pu(s,l)})):l&&r.push(r.pop()+"rotate("+l+")"),f!=h?u.push({i:r.push(r.pop()+"skewX(",null,")")-2,x:pu(f,h)}):h&&r.push(r.pop()+"skewX("+h+")"),g[0]!=p[0]||g[1]!=p[1]?(e=r.push(r.pop()+"scale(",null,",",null,")"),u.push({i:e-4,x:pu(g[0],p[0])},{i:e-2,x:pu(g[1],p[1])})):(1!=p[0]||1!=p[1])&&r.push(r.pop()+"scale("+p+")"),e=u.length,function(n){for(var t,i=-1;++i<e;)r[(t=u[i]).i]=t.x(n);return r.join("")}}function Ou(n,t){return t=t-(n=+n)?1/(t-n):0,function(e){return(e-n)*t}}function Fu(n,t){return t=t-(n=+n)?1/(t-n):0,function(e){return Math.max(0,Math.min(1,(e-n)*t))}}function Iu(n){for(var t=n.source,e=n.target,r=Zu(t,e),u=[t];t!==r;)t=t.parent,u.push(t);for(var i=u.length;e!==r;)u.splice(i,0,e),e=e.parent;return u}function Yu(n){for(var t=[],e=n.parent;null!=e;)t.push(n),n=e,e=e.parent;return t.push(n),t}function Zu(n,t){if(n===t)return n;for(var e=Yu(n),r=Yu(t),u=e.pop(),i=r.pop(),o=null;u===i;)o=u,u=e.pop(),i=r.pop();return o}function Vu(n){n.fixed|=2}function $u(n){n.fixed&=-7}function Xu(n){n.fixed|=4,n.px=n.x,n.py=n.y}function Bu(n){n.fixed&=-5}function Gu(n,t,e){var r=0,u=0;if(n.charge=0,!n.leaf)for(var i,o=n.nodes,a=o.length,c=-1;++c<a;)i=o[c],null!=i&&(Gu(i,t,e),n.charge+=i.charge,r+=i.charge*i.cx,u+=i.charge*i.cy);if(n.point){n.leaf||(n.point.x+=Math.random()-.5,n.point.y+=Math.random()-.5);var s=t*e[n.point.index];n.charge+=n.pointCharge=s,r+=s*n.point.x,u+=s*n.point.y}n.cx=r/n.charge,n.cy=u/n.charge}function Ju(n,t){return Wo.rebind(n,t,"sort","children","value"),n.nodes=n,n.links=ni,n}function Wu(n){return n.children}function Ku(n){return n.value}function Qu(n,t){return t.value-n.value}function ni(n){return Wo.merge(n.map(function(n){return(n.children||[]).map(function(t){return{source:n,target:t}})}))}function ti(n){return n.x}function ei(n){return n.y}function ri(n,t,e){n.y0=t,n.y=e}function ui(n){return Wo.range(n.length)}function ii(n){for(var t=-1,e=n[0].length,r=[];++t<e;)r[t]=0;return r}function oi(n){for(var t,e=1,r=0,u=n[0][1],i=n.length;i>e;++e)(t=n[e][1])>u&&(r=e,u=t);return r}function ai(n){return n.reduce(ci,0)}function ci(n,t){return n+t[1]}function si(n,t){return li(n,Math.ceil(Math.log(t.length)/Math.LN2+1))}function li(n,t){for(var e=-1,r=+n[0],u=(n[1]-r)/t,i=[];++e<=t;)i[e]=u*e+r;return i}function fi(n){return[Wo.min(n),Wo.max(n)]}function hi(n,t){return n.parent==t.parent?1:2}function gi(n){var t=n.children;return t&&t.length?t[0]:n._tree.thread}function pi(n){var t,e=n.children;return e&&(t=e.length)?e[t-1]:n._tree.thread}function vi(n,t){var e=n.children;if(e&&(u=e.length))for(var r,u,i=-1;++i<u;)t(r=vi(e[i],t),n)>0&&(n=r);return n}function di(n,t){return n.x-t.x}function mi(n,t){return t.x-n.x}function yi(n,t){return n.depth-t.depth}function xi(n,t){function e(n,r){var u=n.children;if(u&&(o=u.length))for(var i,o,a=null,c=-1;++c<o;)i=u[c],e(i,a),a=i;t(n,r)}e(n,null)}function Mi(n){for(var t,e=0,r=0,u=n.children,i=u.length;--i>=0;)t=u[i]._tree,t.prelim+=e,t.mod+=e,e+=t.shift+(r+=t.change)}function _i(n,t,e){n=n._tree,t=t._tree;var r=e/(t.number-n.number);n.change+=r,t.change-=r,t.shift+=e,t.prelim+=e,t.mod+=e}function bi(n,t,e){return n._tree.ancestor.parent==t.parent?n._tree.ancestor:e}function wi(n,t){return n.value-t.value}function Si(n,t){var e=n._pack_next;n._pack_next=t,t._pack_prev=n,t._pack_next=e,e._pack_prev=t}function ki(n,t){n._pack_next=t,t._pack_prev=n}function Ei(n,t){var e=t.x-n.x,r=t.y-n.y,u=n.r+t.r;return.999*u*u>e*e+r*r}function Ai(n){function t(n){l=Math.min(n.x-n.r,l),f=Math.max(n.x+n.r,f),h=Math.min(n.y-n.r,h),g=Math.max(n.y+n.r,g)}if((e=n.children)&&(s=e.length)){var e,r,u,i,o,a,c,s,l=1/0,f=-1/0,h=1/0,g=-1/0;if(e.forEach(Ci),r=e[0],r.x=-r.r,r.y=0,t(r),s>1&&(u=e[1],u.x=u.r,u.y=0,t(u),s>2))for(i=e[2],Li(r,u,i),t(i),Si(r,i),r._pack_prev=i,Si(i,u),u=r._pack_next,o=3;s>o;o++){Li(r,u,i=e[o]);var p=0,v=1,d=1;for(a=u._pack_next;a!==u;a=a._pack_next,v++)if(Ei(a,i)){p=1;break}if(1==p)for(c=r._pack_prev;c!==a._pack_prev&&!Ei(c,i);c=c._pack_prev,d++);p?(d>v||v==d&&u.r<r.r?ki(r,u=a):ki(r=c,u),o--):(Si(r,i),u=i,t(i))}var m=(l+f)/2,y=(h+g)/2,x=0;for(o=0;s>o;o++)i=e[o],i.x-=m,i.y-=y,x=Math.max(x,i.r+Math.sqrt(i.x*i.x+i.y*i.y));n.r=x,e.forEach(Ni)}}function Ci(n){n._pack_next=n._pack_prev=n}function Ni(n){delete n._pack_next,delete n._pack_prev}function Ti(n,t,e,r){var u=n.children;if(n.x=t+=r*n.x,n.y=e+=r*n.y,n.r*=r,u)for(var i=-1,o=u.length;++i<o;)Ti(u[i],t,e,r)}function Li(n,t,e){var r=n.r+e.r,u=t.x-n.x,i=t.y-n.y;if(r&&(u||i)){var o=t.r+e.r,a=u*u+i*i;o*=o,r*=r;var c=.5+(r-o)/(2*a),s=Math.sqrt(Math.max(0,2*o*(r+a)-(r-=a)*r-o*o))/(2*a);e.x=n.x+c*u+s*i,e.y=n.y+c*i-s*u}else e.x=n.x+r,e.y=n.y}function qi(n){return 1+Wo.max(n,function(n){return n.y})}function zi(n){return n.reduce(function(n,t){return n+t.x},0)/n.length}function Ri(n){var t=n.children;return t&&t.length?Ri(t[0]):n}function Di(n){var t,e=n.children;return e&&(t=e.length)?Di(e[t-1]):n}function Pi(n){return{x:n.x,y:n.y,dx:n.dx,dy:n.dy}}function ji(n,t){var e=n.x+t[3],r=n.y+t[0],u=n.dx-t[1]-t[3],i=n.dy-t[0]-t[2];return 0>u&&(e+=u/2,u=0),0>i&&(r+=i/2,i=0),{x:e,y:r,dx:u,dy:i}}function Ui(n){var t=n[0],e=n[n.length-1];return e>t?[t,e]:[e,t]}function Hi(n){return n.rangeExtent?n.rangeExtent():Ui(n.range())}function Oi(n,t,e,r){var u=e(n[0],n[1]),i=r(t[0],t[1]);return function(n){return i(u(n))}}function Fi(n,t){var e,r=0,u=n.length-1,i=n[r],o=n[u];return i>o&&(e=r,r=u,u=e,e=i,i=o,o=e),n[r]=t.floor(i),n[u]=t.ceil(o),n}function Ii(n){return n?{floor:function(t){return Math.floor(t/n)*n},ceil:function(t){return Math.ceil(t/n)*n}}:vs}function Yi(n,t,e,r){var u=[],i=[],o=0,a=Math.min(n.length,t.length)-1;for(n[a]<n[0]&&(n=n.slice().reverse(),t=t.slice().reverse());++o<=a;)u.push(e(n[o-1],n[o])),i.push(r(t[o-1],t[o]));return function(t){var e=Wo.bisect(n,t,1,a)-1;return i[e](u[e](t))}}function Zi(n,t,e,r){function u(){var u=Math.min(n.length,t.length)>2?Yi:Oi,c=r?Fu:Ou;return o=u(n,t,c,e),a=u(t,n,c,du),i}function i(n){return o(n)}var o,a;return i.invert=function(n){return a(n)},i.domain=function(t){return arguments.length?(n=t.map(Number),u()):n},i.range=function(n){return arguments.length?(t=n,u()):t},i.rangeRound=function(n){return i.range(n).interpolate(Ru)},i.clamp=function(n){return arguments.length?(r=n,u()):r},i.interpolate=function(n){return arguments.length?(e=n,u()):e},i.ticks=function(t){return Bi(n,t)},i.tickFormat=function(t,e){return Gi(n,t,e)},i.nice=function(t){return $i(n,t),u()},i.copy=function(){return Zi(n,t,e,r)},u()}function Vi(n,t){return Wo.rebind(n,t,"range","rangeRound","interpolate","clamp")}function $i(n,t){return Fi(n,Ii(Xi(n,t)[2]))}function Xi(n,t){null==t&&(t=10);var e=Ui(n),r=e[1]-e[0],u=Math.pow(10,Math.floor(Math.log(r/t)/Math.LN10)),i=t/r*u;return.15>=i?u*=10:.35>=i?u*=5:.75>=i&&(u*=2),e[0]=Math.ceil(e[0]/u)*u,e[1]=Math.floor(e[1]/u)*u+.5*u,e[2]=u,e}function Bi(n,t){return Wo.range.apply(Wo,Xi(n,t))}function Gi(n,t,e){var r=Xi(n,t);if(e){var u=rc.exec(e);if(u.shift(),"s"===u[8]){var i=Wo.formatPrefix(Math.max(fa(r[0]),fa(r[1])));return u[7]||(u[7]="."+Ji(i.scale(r[2]))),u[8]="f",e=Wo.format(u.join("")),function(n){return e(i.scale(n))+i.symbol}}u[7]||(u[7]="."+Wi(u[8],r)),e=u.join("")}else e=",."+Ji(r[2])+"f";return Wo.format(e)}function Ji(n){return-Math.floor(Math.log(n)/Math.LN10+.01)}function Wi(n,t){var e=Ji(t[2]);return n in ds?Math.abs(e-Ji(Math.max(fa(t[0]),fa(t[1]))))+ +("e"!==n):e-2*("%"===n)}function Ki(n,t,e,r){function u(n){return(e?Math.log(0>n?0:n):-Math.log(n>0?0:-n))/Math.log(t)}function i(n){return e?Math.pow(t,n):-Math.pow(t,-n)}function o(t){return n(u(t))}return o.invert=function(t){return i(n.invert(t))},o.domain=function(t){return arguments.length?(e=t[0]>=0,n.domain((r=t.map(Number)).map(u)),o):r},o.base=function(e){return arguments.length?(t=+e,n.domain(r.map(u)),o):t},o.nice=function(){var t=Fi(r.map(u),e?Math:ys);return n.domain(t),r=t.map(i),o},o.ticks=function(){var n=Ui(r),o=[],a=n[0],c=n[1],s=Math.floor(u(a)),l=Math.ceil(u(c)),f=t%1?2:t;if(isFinite(l-s)){if(e){for(;l>s;s++)for(var h=1;f>h;h++)o.push(i(s)*h);o.push(i(s))}else for(o.push(i(s));s++<l;)for(var h=f-1;h>0;h--)o.push(i(s)*h);for(s=0;o[s]<a;s++);for(l=o.length;o[l-1]>c;l--);o=o.slice(s,l)}return o},o.tickFormat=function(n,t){if(!arguments.length)return ms;arguments.length<2?t=ms:"function"!=typeof t&&(t=Wo.format(t));var r,a=Math.max(.1,n/o.ticks().length),c=e?(r=1e-12,Math.ceil):(r=-1e-12,Math.floor);return function(n){return n/i(c(u(n)+r))<=a?t(n):""}},o.copy=function(){return Ki(n.copy(),t,e,r)},Vi(o,n)}function Qi(n,t,e){function r(t){return n(u(t))}var u=no(t),i=no(1/t);return r.invert=function(t){return i(n.invert(t))},r.domain=function(t){return arguments.length?(n.domain((e=t.map(Number)).map(u)),r):e},r.ticks=function(n){return Bi(e,n)},r.tickFormat=function(n,t){return Gi(e,n,t)},r.nice=function(n){return r.domain($i(e,n))},r.exponent=function(o){return arguments.length?(u=no(t=o),i=no(1/t),n.domain(e.map(u)),r):t},r.copy=function(){return Qi(n.copy(),t,e)},Vi(r,n)}function no(n){return function(t){return 0>t?-Math.pow(-t,n):Math.pow(t,n)}}function to(n,t){function e(e){return i[((u.get(e)||("range"===t.t?u.set(e,n.push(e)):0/0))-1)%i.length]}function r(t,e){return Wo.range(n.length).map(function(n){return t+e*n})}var u,i,a;return e.domain=function(r){if(!arguments.length)return n;n=[],u=new o;for(var i,a=-1,c=r.length;++a<c;)u.has(i=r[a])||u.set(i,n.push(i));return e[t.t].apply(e,t.a)},e.range=function(n){return arguments.length?(i=n,a=0,t={t:"range",a:arguments},e):i},e.rangePoints=function(u,o){arguments.length<2&&(o=0);var c=u[0],s=u[1],l=(s-c)/(Math.max(1,n.length-1)+o);return i=r(n.length<2?(c+s)/2:c+l*o/2,l),a=0,t={t:"rangePoints",a:arguments},e},e.rangeBands=function(u,o,c){arguments.length<2&&(o=0),arguments.length<3&&(c=o);var s=u[1]<u[0],l=u[s-0],f=u[1-s],h=(f-l)/(n.length-o+2*c);return i=r(l+h*c,h),s&&i.reverse(),a=h*(1-o),t={t:"rangeBands",a:arguments},e},e.rangeRoundBands=function(u,o,c){arguments.length<2&&(o=0),arguments.length<3&&(c=o);var s=u[1]<u[0],l=u[s-0],f=u[1-s],h=Math.floor((f-l)/(n.length-o+2*c)),g=f-l-(n.length-o)*h;return i=r(l+Math.round(g/2),h),s&&i.reverse(),a=Math.round(h*(1-o)),t={t:"rangeRoundBands",a:arguments},e},e.rangeBand=function(){return a},e.rangeExtent=function(){return Ui(t.a[0])},e.copy=function(){return to(n,t)},e.domain(n)}function eo(e,r){function u(){var n=0,t=r.length;for(o=[];++n<t;)o[n-1]=Wo.quantile(e,n/t);return i}function i(n){return isNaN(n=+n)?void 0:r[Wo.bisect(o,n)]}var o;return i.domain=function(r){return arguments.length?(e=r.filter(t).sort(n),u()):e},i.range=function(n){return arguments.length?(r=n,u()):r},i.quantiles=function(){return o},i.invertExtent=function(n){return n=r.indexOf(n),0>n?[0/0,0/0]:[n>0?o[n-1]:e[0],n<o.length?o[n]:e[e.length-1]]},i.copy=function(){return eo(e,r)},u()}function ro(n,t,e){function r(t){return e[Math.max(0,Math.min(o,Math.floor(i*(t-n))))]}function u(){return i=e.length/(t-n),o=e.length-1,r}var i,o;return r.domain=function(e){return arguments.length?(n=+e[0],t=+e[e.length-1],u()):[n,t]},r.range=function(n){return arguments.length?(e=n,u()):e},r.invertExtent=function(t){return t=e.indexOf(t),t=0>t?0/0:t/i+n,[t,t+1/i]},r.copy=function(){return ro(n,t,e)},u()}function uo(n,t){function e(e){return e>=e?t[Wo.bisect(n,e)]:void 0}return e.domain=function(t){return arguments.length?(n=t,e):n},e.range=function(n){return arguments.length?(t=n,e):t},e.invertExtent=function(e){return e=t.indexOf(e),[n[e-1],n[e]]},e.copy=function(){return uo(n,t)},e}function io(n){function t(n){return+n}return t.invert=t,t.domain=t.range=function(e){return arguments.length?(n=e.map(t),t):n},t.ticks=function(t){return Bi(n,t)},t.tickFormat=function(t,e){return Gi(n,t,e)},t.copy=function(){return io(n)},t}function oo(n){return n.innerRadius}function ao(n){return n.outerRadius}function co(n){return n.startAngle}function so(n){return n.endAngle}function lo(n){function t(t){function o(){s.push("M",i(n(l),a))}for(var c,s=[],l=[],f=-1,h=t.length,g=Et(e),p=Et(r);++f<h;)u.call(this,c=t[f],f)?l.push([+g.call(this,c,f),+p.call(this,c,f)]):l.length&&(o(),l=[]);return l.length&&o(),s.length?s.join(""):null}var e=Ar,r=Cr,u=Ae,i=fo,o=i.key,a=.7;return t.x=function(n){return arguments.length?(e=n,t):e},t.y=function(n){return arguments.length?(r=n,t):r},t.defined=function(n){return arguments.length?(u=n,t):u},t.interpolate=function(n){return arguments.length?(o="function"==typeof n?i=n:(i=ks.get(n)||fo).key,t):o},t.tension=function(n){return arguments.length?(a=n,t):a},t}function fo(n){return n.join("L")}function ho(n){return fo(n)+"Z"}function go(n){for(var t=0,e=n.length,r=n[0],u=[r[0],",",r[1]];++t<e;)u.push("H",(r[0]+(r=n[t])[0])/2,"V",r[1]);return e>1&&u.push("H",r[0]),u.join("")}function po(n){for(var t=0,e=n.length,r=n[0],u=[r[0],",",r[1]];++t<e;)u.push("V",(r=n[t])[1],"H",r[0]);return u.join("")}function vo(n){for(var t=0,e=n.length,r=n[0],u=[r[0],",",r[1]];++t<e;)u.push("H",(r=n[t])[0],"V",r[1]);return u.join("")}function mo(n,t){return n.length<4?fo(n):n[1]+Mo(n.slice(1,n.length-1),_o(n,t))}function yo(n,t){return n.length<3?fo(n):n[0]+Mo((n.push(n[0]),n),_o([n[n.length-2]].concat(n,[n[1]]),t))}function xo(n,t){return n.length<3?fo(n):n[0]+Mo(n,_o(n,t))}function Mo(n,t){if(t.length<1||n.length!=t.length&&n.length!=t.length+2)return fo(n);var e=n.length!=t.length,r="",u=n[0],i=n[1],o=t[0],a=o,c=1;if(e&&(r+="Q"+(i[0]-2*o[0]/3)+","+(i[1]-2*o[1]/3)+","+i[0]+","+i[1],u=n[1],c=2),t.length>1){a=t[1],i=n[c],c++,r+="C"+(u[0]+o[0])+","+(u[1]+o[1])+","+(i[0]-a[0])+","+(i[1]-a[1])+","+i[0]+","+i[1];for(var s=2;s<t.length;s++,c++)i=n[c],a=t[s],r+="S"+(i[0]-a[0])+","+(i[1]-a[1])+","+i[0]+","+i[1]}if(e){var l=n[c];r+="Q"+(i[0]+2*a[0]/3)+","+(i[1]+2*a[1]/3)+","+l[0]+","+l[1]}return r}function _o(n,t){for(var e,r=[],u=(1-t)/2,i=n[0],o=n[1],a=1,c=n.length;++a<c;)e=i,i=o,o=n[a],r.push([u*(o[0]-e[0]),u*(o[1]-e[1])]);return r}function bo(n){if(n.length<3)return fo(n);var t=1,e=n.length,r=n[0],u=r[0],i=r[1],o=[u,u,u,(r=n[1])[0]],a=[i,i,i,r[1]],c=[u,",",i,"L",Eo(Cs,o),",",Eo(Cs,a)];for(n.push(n[e-1]);++t<=e;)r=n[t],o.shift(),o.push(r[0]),a.shift(),a.push(r[1]),Ao(c,o,a);return n.pop(),c.push("L",r),c.join("")}function wo(n){if(n.length<4)return fo(n);for(var t,e=[],r=-1,u=n.length,i=[0],o=[0];++r<3;)t=n[r],i.push(t[0]),o.push(t[1]);for(e.push(Eo(Cs,i)+","+Eo(Cs,o)),--r;++r<u;)t=n[r],i.shift(),i.push(t[0]),o.shift(),o.push(t[1]),Ao(e,i,o);return e.join("")}function So(n){for(var t,e,r=-1,u=n.length,i=u+4,o=[],a=[];++r<4;)e=n[r%u],o.push(e[0]),a.push(e[1]);for(t=[Eo(Cs,o),",",Eo(Cs,a)],--r;++r<i;)e=n[r%u],o.shift(),o.push(e[0]),a.shift(),a.push(e[1]),Ao(t,o,a);return t.join("")}function ko(n,t){var e=n.length-1;if(e)for(var r,u,i=n[0][0],o=n[0][1],a=n[e][0]-i,c=n[e][1]-o,s=-1;++s<=e;)r=n[s],u=s/e,r[0]=t*r[0]+(1-t)*(i+u*a),r[1]=t*r[1]+(1-t)*(o+u*c);return bo(n)}function Eo(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]+n[3]*t[3]}function Ao(n,t,e){n.push("C",Eo(Es,t),",",Eo(Es,e),",",Eo(As,t),",",Eo(As,e),",",Eo(Cs,t),",",Eo(Cs,e))}function Co(n,t){return(t[1]-n[1])/(t[0]-n[0])}function No(n){for(var t=0,e=n.length-1,r=[],u=n[0],i=n[1],o=r[0]=Co(u,i);++t<e;)r[t]=(o+(o=Co(u=i,i=n[t+1])))/2;return r[t]=o,r}function To(n){for(var t,e,r,u,i=[],o=No(n),a=-1,c=n.length-1;++a<c;)t=Co(n[a],n[a+1]),fa(t)<La?o[a]=o[a+1]=0:(e=o[a]/t,r=o[a+1]/t,u=e*e+r*r,u>9&&(u=3*t/Math.sqrt(u),o[a]=u*e,o[a+1]=u*r));for(a=-1;++a<=c;)u=(n[Math.min(c,a+1)][0]-n[Math.max(0,a-1)][0])/(6*(1+o[a]*o[a])),i.push([u||0,o[a]*u||0]);return i}function Lo(n){return n.length<3?fo(n):n[0]+Mo(n,To(n))}function qo(n){for(var t,e,r,u=-1,i=n.length;++u<i;)t=n[u],e=t[0],r=t[1]+ws,t[0]=e*Math.cos(r),t[1]=e*Math.sin(r);return n}function zo(n){function t(t){function c(){v.push("M",a(n(m),f),l,s(n(d.reverse()),f),"Z")}for(var h,g,p,v=[],d=[],m=[],y=-1,x=t.length,M=Et(e),_=Et(u),b=e===r?function(){return g}:Et(r),w=u===i?function(){return p}:Et(i);++y<x;)o.call(this,h=t[y],y)?(d.push([g=+M.call(this,h,y),p=+_.call(this,h,y)]),m.push([+b.call(this,h,y),+w.call(this,h,y)])):d.length&&(c(),d=[],m=[]);return d.length&&c(),v.length?v.join(""):null}var e=Ar,r=Ar,u=0,i=Cr,o=Ae,a=fo,c=a.key,s=a,l="L",f=.7;return t.x=function(n){return arguments.length?(e=r=n,t):r},t.x0=function(n){return arguments.length?(e=n,t):e},t.x1=function(n){return arguments.length?(r=n,t):r},t.y=function(n){return arguments.length?(u=i=n,t):i},t.y0=function(n){return arguments.length?(u=n,t):u},t.y1=function(n){return arguments.length?(i=n,t):i},t.defined=function(n){return arguments.length?(o=n,t):o},t.interpolate=function(n){return arguments.length?(c="function"==typeof n?a=n:(a=ks.get(n)||fo).key,s=a.reverse||a,l=a.closed?"M":"L",t):c},t.tension=function(n){return arguments.length?(f=n,t):f},t}function Ro(n){return n.radius}function Do(n){return[n.x,n.y]}function Po(n){return function(){var t=n.apply(this,arguments),e=t[0],r=t[1]+ws;return[e*Math.cos(r),e*Math.sin(r)]}}function jo(){return 64}function Uo(){return"circle"}function Ho(n){var t=Math.sqrt(n/Ca);return"M0,"+t+"A"+t+","+t+" 0 1,1 0,"+-t+"A"+t+","+t+" 0 1,1 0,"+t+"Z"}function Oo(n,t){return da(n,Rs),n.id=t,n}function Fo(n,t,e,r){var u=n.id;return P(n,"function"==typeof e?function(n,i,o){n.__transition__[u].tween.set(t,r(e.call(n,n.__data__,i,o)))}:(e=r(e),function(n){n.__transition__[u].tween.set(t,e)}))}function Io(n){return null==n&&(n=""),function(){this.textContent=n}}function Yo(n,t,e,r){var u=n.__transition__||(n.__transition__={active:0,count:0}),i=u[e];if(!i){var a=r.time;i=u[e]={tween:new o,time:a,ease:r.ease,delay:r.delay,duration:r.duration},++u.count,Wo.timer(function(r){function o(r){return u.active>e?s():(u.active=e,i.event&&i.event.start.call(n,l,t),i.tween.forEach(function(e,r){(r=r.call(n,l,t))&&v.push(r)}),Wo.timer(function(){return p.c=c(r||1)?Ae:c,1},0,a),void 0)}function c(r){if(u.active!==e)return s();for(var o=r/g,a=f(o),c=v.length;c>0;)v[--c].call(n,a);return o>=1?(i.event&&i.event.end.call(n,l,t),s()):void 0}function s(){return--u.count?delete u[e]:delete n.__transition__,1}var l=n.__data__,f=i.ease,h=i.delay,g=i.duration,p=nc,v=[];return p.t=h+a,r>=h?o(r-h):(p.c=o,void 0)},0,a)}}function Zo(n,t){n.attr("transform",function(n){return"translate("+t(n)+",0)"})}function Vo(n,t){n.attr("transform",function(n){return"translate(0,"+t(n)+")"})}function $o(n){return n.toISOString()
}function Xo(n,t,e){function r(t){return n(t)}function u(n,e){var r=n[1]-n[0],u=r/e,i=Wo.bisect(Ys,u);return i==Ys.length?[t.year,Xi(n.map(function(n){return n/31536e6}),e)[2]]:i?t[u/Ys[i-1]<Ys[i]/u?i-1:i]:[$s,Xi(n,e)[2]]}return r.invert=function(t){return Bo(n.invert(t))},r.domain=function(t){return arguments.length?(n.domain(t),r):n.domain().map(Bo)},r.nice=function(n,t){function e(e){return!isNaN(e)&&!n.range(e,Bo(+e+1),t).length}var i=r.domain(),o=Ui(i),a=null==n?u(o,10):"number"==typeof n&&u(o,n);return a&&(n=a[0],t=a[1]),r.domain(Fi(i,t>1?{floor:function(t){for(;e(t=n.floor(t));)t=Bo(t-1);return t},ceil:function(t){for(;e(t=n.ceil(t));)t=Bo(+t+1);return t}}:n))},r.ticks=function(n,t){var e=Ui(r.domain()),i=null==n?u(e,10):"number"==typeof n?u(e,n):!n.range&&[{range:n},t];return i&&(n=i[0],t=i[1]),n.range(e[0],Bo(+e[1]+1),1>t?1:t)},r.tickFormat=function(){return e},r.copy=function(){return Xo(n.copy(),t,e)},Vi(r,n)}function Bo(n){return new Date(n)}function Go(n){return JSON.parse(n.responseText)}function Jo(n){var t=na.createRange();return t.selectNode(na.body),t.createContextualFragment(n.responseText)}var Wo={version:"3.4.6"};Date.now||(Date.now=function(){return+new Date});var Ko=[].slice,Qo=function(n){return Ko.call(n)},na=document,ta=na.documentElement,ea=window;try{Qo(ta.childNodes)[0].nodeType}catch(ra){Qo=function(n){for(var t=n.length,e=new Array(t);t--;)e[t]=n[t];return e}}try{na.createElement("div").style.setProperty("opacity",0,"")}catch(ua){var ia=ea.Element.prototype,oa=ia.setAttribute,aa=ia.setAttributeNS,ca=ea.CSSStyleDeclaration.prototype,sa=ca.setProperty;ia.setAttribute=function(n,t){oa.call(this,n,t+"")},ia.setAttributeNS=function(n,t,e){aa.call(this,n,t,e+"")},ca.setProperty=function(n,t,e){sa.call(this,n,t+"",e)}}Wo.ascending=n,Wo.descending=function(n,t){return n>t?-1:t>n?1:t>=n?0:0/0},Wo.min=function(n,t){var e,r,u=-1,i=n.length;if(1===arguments.length){for(;++u<i&&!(null!=(e=n[u])&&e>=e);)e=void 0;for(;++u<i;)null!=(r=n[u])&&e>r&&(e=r)}else{for(;++u<i&&!(null!=(e=t.call(n,n[u],u))&&e>=e);)e=void 0;for(;++u<i;)null!=(r=t.call(n,n[u],u))&&e>r&&(e=r)}return e},Wo.max=function(n,t){var e,r,u=-1,i=n.length;if(1===arguments.length){for(;++u<i&&!(null!=(e=n[u])&&e>=e);)e=void 0;for(;++u<i;)null!=(r=n[u])&&r>e&&(e=r)}else{for(;++u<i&&!(null!=(e=t.call(n,n[u],u))&&e>=e);)e=void 0;for(;++u<i;)null!=(r=t.call(n,n[u],u))&&r>e&&(e=r)}return e},Wo.extent=function(n,t){var e,r,u,i=-1,o=n.length;if(1===arguments.length){for(;++i<o&&!(null!=(e=u=n[i])&&e>=e);)e=u=void 0;for(;++i<o;)null!=(r=n[i])&&(e>r&&(e=r),r>u&&(u=r))}else{for(;++i<o&&!(null!=(e=u=t.call(n,n[i],i))&&e>=e);)e=void 0;for(;++i<o;)null!=(r=t.call(n,n[i],i))&&(e>r&&(e=r),r>u&&(u=r))}return[e,u]},Wo.sum=function(n,t){var e,r=0,u=n.length,i=-1;if(1===arguments.length)for(;++i<u;)isNaN(e=+n[i])||(r+=e);else for(;++i<u;)isNaN(e=+t.call(n,n[i],i))||(r+=e);return r},Wo.mean=function(n,e){var r,u=0,i=n.length,o=-1,a=i;if(1===arguments.length)for(;++o<i;)t(r=n[o])?u+=r:--a;else for(;++o<i;)t(r=e.call(n,n[o],o))?u+=r:--a;return a?u/a:void 0},Wo.quantile=function(n,t){var e=(n.length-1)*t+1,r=Math.floor(e),u=+n[r-1],i=e-r;return i?u+i*(n[r]-u):u},Wo.median=function(e,r){return arguments.length>1&&(e=e.map(r)),e=e.filter(t),e.length?Wo.quantile(e.sort(n),.5):void 0};var la=e(n);Wo.bisectLeft=la.left,Wo.bisect=Wo.bisectRight=la.right,Wo.bisector=function(t){return e(1===t.length?function(e,r){return n(t(e),r)}:t)},Wo.shuffle=function(n){for(var t,e,r=n.length;r;)e=0|Math.random()*r--,t=n[r],n[r]=n[e],n[e]=t;return n},Wo.permute=function(n,t){for(var e=t.length,r=new Array(e);e--;)r[e]=n[t[e]];return r},Wo.pairs=function(n){for(var t,e=0,r=n.length-1,u=n[0],i=new Array(0>r?0:r);r>e;)i[e]=[t=u,u=n[++e]];return i},Wo.zip=function(){if(!(u=arguments.length))return[];for(var n=-1,t=Wo.min(arguments,r),e=new Array(t);++n<t;)for(var u,i=-1,o=e[n]=new Array(u);++i<u;)o[i]=arguments[i][n];return e},Wo.transpose=function(n){return Wo.zip.apply(Wo,n)},Wo.keys=function(n){var t=[];for(var e in n)t.push(e);return t},Wo.values=function(n){var t=[];for(var e in n)t.push(n[e]);return t},Wo.entries=function(n){var t=[];for(var e in n)t.push({key:e,value:n[e]});return t},Wo.merge=function(n){for(var t,e,r,u=n.length,i=-1,o=0;++i<u;)o+=n[i].length;for(e=new Array(o);--u>=0;)for(r=n[u],t=r.length;--t>=0;)e[--o]=r[t];return e};var fa=Math.abs;Wo.range=function(n,t,e){if(arguments.length<3&&(e=1,arguments.length<2&&(t=n,n=0)),1/0===(t-n)/e)throw new Error("infinite range");var r,i=[],o=u(fa(e)),a=-1;if(n*=o,t*=o,e*=o,0>e)for(;(r=n+e*++a)>t;)i.push(r/o);else for(;(r=n+e*++a)<t;)i.push(r/o);return i},Wo.map=function(n){var t=new o;if(n instanceof o)n.forEach(function(n,e){t.set(n,e)});else for(var e in n)t.set(e,n[e]);return t},i(o,{has:a,get:function(n){return this[ha+n]},set:function(n,t){return this[ha+n]=t},remove:c,keys:s,values:function(){var n=[];return this.forEach(function(t,e){n.push(e)}),n},entries:function(){var n=[];return this.forEach(function(t,e){n.push({key:t,value:e})}),n},size:l,empty:f,forEach:function(n){for(var t in this)t.charCodeAt(0)===ga&&n.call(this,t.substring(1),this[t])}});var ha="\x00",ga=ha.charCodeAt(0);Wo.nest=function(){function n(t,a,c){if(c>=i.length)return r?r.call(u,a):e?a.sort(e):a;for(var s,l,f,h,g=-1,p=a.length,v=i[c++],d=new o;++g<p;)(h=d.get(s=v(l=a[g])))?h.push(l):d.set(s,[l]);return t?(l=t(),f=function(e,r){l.set(e,n(t,r,c))}):(l={},f=function(e,r){l[e]=n(t,r,c)}),d.forEach(f),l}function t(n,e){if(e>=i.length)return n;var r=[],u=a[e++];return n.forEach(function(n,u){r.push({key:n,values:t(u,e)})}),u?r.sort(function(n,t){return u(n.key,t.key)}):r}var e,r,u={},i=[],a=[];return u.map=function(t,e){return n(e,t,0)},u.entries=function(e){return t(n(Wo.map,e,0),0)},u.key=function(n){return i.push(n),u},u.sortKeys=function(n){return a[i.length-1]=n,u},u.sortValues=function(n){return e=n,u},u.rollup=function(n){return r=n,u},u},Wo.set=function(n){var t=new h;if(n)for(var e=0,r=n.length;r>e;++e)t.add(n[e]);return t},i(h,{has:a,add:function(n){return this[ha+n]=!0,n},remove:function(n){return n=ha+n,n in this&&delete this[n]},values:s,size:l,empty:f,forEach:function(n){for(var t in this)t.charCodeAt(0)===ga&&n.call(this,t.substring(1))}}),Wo.behavior={},Wo.rebind=function(n,t){for(var e,r=1,u=arguments.length;++r<u;)n[e=arguments[r]]=g(n,t,t[e]);return n};var pa=["webkit","ms","moz","Moz","o","O"];Wo.dispatch=function(){for(var n=new d,t=-1,e=arguments.length;++t<e;)n[arguments[t]]=m(n);return n},d.prototype.on=function(n,t){var e=n.indexOf("."),r="";if(e>=0&&(r=n.substring(e+1),n=n.substring(0,e)),n)return arguments.length<2?this[n].on(r):this[n].on(r,t);if(2===arguments.length){if(null==t)for(n in this)this.hasOwnProperty(n)&&this[n].on(r,null);return this}},Wo.event=null,Wo.requote=function(n){return n.replace(va,"\\$&")};var va=/[\\\^\$\*\+\?\|\[\]\(\)\.\{\}]/g,da={}.__proto__?function(n,t){n.__proto__=t}:function(n,t){for(var e in t)n[e]=t[e]},ma=function(n,t){return t.querySelector(n)},ya=function(n,t){return t.querySelectorAll(n)},xa=ta[p(ta,"matchesSelector")],Ma=function(n,t){return xa.call(n,t)};"function"==typeof Sizzle&&(ma=function(n,t){return Sizzle(n,t)[0]||null},ya=Sizzle,Ma=Sizzle.matchesSelector),Wo.selection=function(){return Sa};var _a=Wo.selection.prototype=[];_a.select=function(n){var t,e,r,u,i=[];n=b(n);for(var o=-1,a=this.length;++o<a;){i.push(t=[]),t.parentNode=(r=this[o]).parentNode;for(var c=-1,s=r.length;++c<s;)(u=r[c])?(t.push(e=n.call(u,u.__data__,c,o)),e&&"__data__"in u&&(e.__data__=u.__data__)):t.push(null)}return _(i)},_a.selectAll=function(n){var t,e,r=[];n=w(n);for(var u=-1,i=this.length;++u<i;)for(var o=this[u],a=-1,c=o.length;++a<c;)(e=o[a])&&(r.push(t=Qo(n.call(e,e.__data__,a,u))),t.parentNode=e);return _(r)};var ba={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};Wo.ns={prefix:ba,qualify:function(n){var t=n.indexOf(":"),e=n;return t>=0&&(e=n.substring(0,t),n=n.substring(t+1)),ba.hasOwnProperty(e)?{space:ba[e],local:n}:n}},_a.attr=function(n,t){if(arguments.length<2){if("string"==typeof n){var e=this.node();return n=Wo.ns.qualify(n),n.local?e.getAttributeNS(n.space,n.local):e.getAttribute(n)}for(t in n)this.each(S(t,n[t]));return this}return this.each(S(n,t))},_a.classed=function(n,t){if(arguments.length<2){if("string"==typeof n){var e=this.node(),r=(n=A(n)).length,u=-1;if(t=e.classList){for(;++u<r;)if(!t.contains(n[u]))return!1}else for(t=e.getAttribute("class");++u<r;)if(!E(n[u]).test(t))return!1;return!0}for(t in n)this.each(C(t,n[t]));return this}return this.each(C(n,t))},_a.style=function(n,t,e){var r=arguments.length;if(3>r){if("string"!=typeof n){2>r&&(t="");for(e in n)this.each(T(e,n[e],t));return this}if(2>r)return ea.getComputedStyle(this.node(),null).getPropertyValue(n);e=""}return this.each(T(n,t,e))},_a.property=function(n,t){if(arguments.length<2){if("string"==typeof n)return this.node()[n];for(t in n)this.each(L(t,n[t]));return this}return this.each(L(n,t))},_a.text=function(n){return arguments.length?this.each("function"==typeof n?function(){var t=n.apply(this,arguments);this.textContent=null==t?"":t}:null==n?function(){this.textContent=""}:function(){this.textContent=n}):this.node().textContent},_a.html=function(n){return arguments.length?this.each("function"==typeof n?function(){var t=n.apply(this,arguments);this.innerHTML=null==t?"":t}:null==n?function(){this.innerHTML=""}:function(){this.innerHTML=n}):this.node().innerHTML},_a.append=function(n){return n=q(n),this.select(function(){return this.appendChild(n.apply(this,arguments))})},_a.insert=function(n,t){return n=q(n),t=b(t),this.select(function(){return this.insertBefore(n.apply(this,arguments),t.apply(this,arguments)||null)})},_a.remove=function(){return this.each(function(){var n=this.parentNode;n&&n.removeChild(this)})},_a.data=function(n,t){function e(n,e){var r,u,i,a=n.length,f=e.length,h=Math.min(a,f),g=new Array(f),p=new Array(f),v=new Array(a);if(t){var d,m=new o,y=new o,x=[];for(r=-1;++r<a;)d=t.call(u=n[r],u.__data__,r),m.has(d)?v[r]=u:m.set(d,u),x.push(d);for(r=-1;++r<f;)d=t.call(e,i=e[r],r),(u=m.get(d))?(g[r]=u,u.__data__=i):y.has(d)||(p[r]=z(i)),y.set(d,i),m.remove(d);for(r=-1;++r<a;)m.has(x[r])&&(v[r]=n[r])}else{for(r=-1;++r<h;)u=n[r],i=e[r],u?(u.__data__=i,g[r]=u):p[r]=z(i);for(;f>r;++r)p[r]=z(e[r]);for(;a>r;++r)v[r]=n[r]}p.update=g,p.parentNode=g.parentNode=v.parentNode=n.parentNode,c.push(p),s.push(g),l.push(v)}var r,u,i=-1,a=this.length;if(!arguments.length){for(n=new Array(a=(r=this[0]).length);++i<a;)(u=r[i])&&(n[i]=u.__data__);return n}var c=j([]),s=_([]),l=_([]);if("function"==typeof n)for(;++i<a;)e(r=this[i],n.call(r,r.parentNode.__data__,i));else for(;++i<a;)e(r=this[i],n);return s.enter=function(){return c},s.exit=function(){return l},s},_a.datum=function(n){return arguments.length?this.property("__data__",n):this.property("__data__")},_a.filter=function(n){var t,e,r,u=[];"function"!=typeof n&&(n=R(n));for(var i=0,o=this.length;o>i;i++){u.push(t=[]),t.parentNode=(e=this[i]).parentNode;for(var a=0,c=e.length;c>a;a++)(r=e[a])&&n.call(r,r.__data__,a,i)&&t.push(r)}return _(u)},_a.order=function(){for(var n=-1,t=this.length;++n<t;)for(var e,r=this[n],u=r.length-1,i=r[u];--u>=0;)(e=r[u])&&(i&&i!==e.nextSibling&&i.parentNode.insertBefore(e,i),i=e);return this},_a.sort=function(n){n=D.apply(this,arguments);for(var t=-1,e=this.length;++t<e;)this[t].sort(n);return this.order()},_a.each=function(n){return P(this,function(t,e,r){n.call(t,t.__data__,e,r)})},_a.call=function(n){var t=Qo(arguments);return n.apply(t[0]=this,t),this},_a.empty=function(){return!this.node()},_a.node=function(){for(var n=0,t=this.length;t>n;n++)for(var e=this[n],r=0,u=e.length;u>r;r++){var i=e[r];if(i)return i}return null},_a.size=function(){var n=0;return this.each(function(){++n}),n};var wa=[];Wo.selection.enter=j,Wo.selection.enter.prototype=wa,wa.append=_a.append,wa.empty=_a.empty,wa.node=_a.node,wa.call=_a.call,wa.size=_a.size,wa.select=function(n){for(var t,e,r,u,i,o=[],a=-1,c=this.length;++a<c;){r=(u=this[a]).update,o.push(t=[]),t.parentNode=u.parentNode;for(var s=-1,l=u.length;++s<l;)(i=u[s])?(t.push(r[s]=e=n.call(u.parentNode,i.__data__,s,a)),e.__data__=i.__data__):t.push(null)}return _(o)},wa.insert=function(n,t){return arguments.length<2&&(t=U(this)),_a.insert.call(this,n,t)},_a.transition=function(){for(var n,t,e=Ts||++Ds,r=[],u=Ls||{time:Date.now(),ease:wu,delay:0,duration:250},i=-1,o=this.length;++i<o;){r.push(n=[]);for(var a=this[i],c=-1,s=a.length;++c<s;)(t=a[c])&&Yo(t,c,e,u),n.push(t)}return Oo(r,e)},_a.interrupt=function(){return this.each(H)},Wo.select=function(n){var t=["string"==typeof n?ma(n,na):n];return t.parentNode=ta,_([t])},Wo.selectAll=function(n){var t=Qo("string"==typeof n?ya(n,na):n);return t.parentNode=ta,_([t])};var Sa=Wo.select(ta);_a.on=function(n,t,e){var r=arguments.length;if(3>r){if("string"!=typeof n){2>r&&(t=!1);for(e in n)this.each(O(e,n[e],t));return this}if(2>r)return(r=this.node()["__on"+n])&&r._;e=!1}return this.each(O(n,t,e))};var ka=Wo.map({mouseenter:"mouseover",mouseleave:"mouseout"});ka.forEach(function(n){"on"+n in na&&ka.remove(n)});var Ea="onselectstart"in na?null:p(ta.style,"userSelect"),Aa=0;Wo.mouse=function(n){return Z(n,x())},Wo.touches=function(n,t){return arguments.length<2&&(t=x().touches),t?Qo(t).map(function(t){var e=Z(n,t);return e.identifier=t.identifier,e}):[]},Wo.behavior.drag=function(){function n(){this.on("mousedown.drag",u).on("touchstart.drag",i)}function t(n,t,u,i,o){return function(){function a(){var n,e,r=t(h,v);r&&(n=r[0]-x[0],e=r[1]-x[1],p|=n|e,x=r,g({type:"drag",x:r[0]+s[0],y:r[1]+s[1],dx:n,dy:e}))}function c(){t(h,v)&&(m.on(i+d,null).on(o+d,null),y(p&&Wo.event.target===f),g({type:"dragend"}))}var s,l=this,f=Wo.event.target,h=l.parentNode,g=e.of(l,arguments),p=0,v=n(),d=".drag"+(null==v?"":"-"+v),m=Wo.select(u()).on(i+d,a).on(o+d,c),y=Y(),x=t(h,v);r?(s=r.apply(l,arguments),s=[s.x-x[0],s.y-x[1]]):s=[0,0],g({type:"dragstart"})}}var e=M(n,"drag","dragstart","dragend"),r=null,u=t(v,Wo.mouse,X,"mousemove","mouseup"),i=t(V,Wo.touch,$,"touchmove","touchend");return n.origin=function(t){return arguments.length?(r=t,n):r},Wo.rebind(n,e,"on")};var Ca=Math.PI,Na=2*Ca,Ta=Ca/2,La=1e-6,qa=La*La,za=Ca/180,Ra=180/Ca,Da=Math.SQRT2,Pa=2,ja=4;Wo.interpolateZoom=function(n,t){function e(n){var t=n*y;if(m){var e=Q(v),o=i/(Pa*h)*(e*nt(Da*t+v)-K(v));return[r+o*s,u+o*l,i*e/Q(Da*t+v)]}return[r+n*s,u+n*l,i*Math.exp(Da*t)]}var r=n[0],u=n[1],i=n[2],o=t[0],a=t[1],c=t[2],s=o-r,l=a-u,f=s*s+l*l,h=Math.sqrt(f),g=(c*c-i*i+ja*f)/(2*i*Pa*h),p=(c*c-i*i-ja*f)/(2*c*Pa*h),v=Math.log(Math.sqrt(g*g+1)-g),d=Math.log(Math.sqrt(p*p+1)-p),m=d-v,y=(m||Math.log(c/i))/Da;return e.duration=1e3*y,e},Wo.behavior.zoom=function(){function n(n){n.on(A,s).on(Oa+".zoom",f).on(C,h).on("dblclick.zoom",g).on(T,l)}function t(n){return[(n[0]-S.x)/S.k,(n[1]-S.y)/S.k]}function e(n){return[n[0]*S.k+S.x,n[1]*S.k+S.y]}function r(n){S.k=Math.max(E[0],Math.min(E[1],n))}function u(n,t){t=e(t),S.x+=n[0]-t[0],S.y+=n[1]-t[1]}function i(){_&&_.domain(x.range().map(function(n){return(n-S.x)/S.k}).map(x.invert)),w&&w.domain(b.range().map(function(n){return(n-S.y)/S.k}).map(b.invert))}function o(n){n({type:"zoomstart"})}function a(n){i(),n({type:"zoom",scale:S.k,translate:[S.x,S.y]})}function c(n){n({type:"zoomend"})}function s(){function n(){l=1,u(Wo.mouse(r),g),a(s)}function e(){f.on(C,ea===r?h:null).on(N,null),p(l&&Wo.event.target===i),c(s)}var r=this,i=Wo.event.target,s=L.of(r,arguments),l=0,f=Wo.select(ea).on(C,n).on(N,e),g=t(Wo.mouse(r)),p=Y();H.call(r),o(s)}function l(){function n(){var n=Wo.touches(g);return h=S.k,n.forEach(function(n){n.identifier in v&&(v[n.identifier]=t(n))}),n}function e(){for(var t=Wo.event.changedTouches,e=0,i=t.length;i>e;++e)v[t[e].identifier]=null;var o=n(),c=Date.now();if(1===o.length){if(500>c-m){var s=o[0],l=v[s.identifier];r(2*S.k),u(s,l),y(),a(p)}m=c}else if(o.length>1){var s=o[0],f=o[1],h=s[0]-f[0],g=s[1]-f[1];d=h*h+g*g}}function i(){for(var n,t,e,i,o=Wo.touches(g),c=0,s=o.length;s>c;++c,i=null)if(e=o[c],i=v[e.identifier]){if(t)break;n=e,t=i}if(i){var l=(l=e[0]-n[0])*l+(l=e[1]-n[1])*l,f=d&&Math.sqrt(l/d);n=[(n[0]+e[0])/2,(n[1]+e[1])/2],t=[(t[0]+i[0])/2,(t[1]+i[1])/2],r(f*h)}m=null,u(n,t),a(p)}function f(){if(Wo.event.touches.length){for(var t=Wo.event.changedTouches,e=0,r=t.length;r>e;++e)delete v[t[e].identifier];for(var u in v)return void n()}b.on(x,null),w.on(A,s).on(T,l),k(),c(p)}var h,g=this,p=L.of(g,arguments),v={},d=0,x=".zoom-"+Wo.event.changedTouches[0].identifier,M="touchmove"+x,_="touchend"+x,b=Wo.select(Wo.event.target).on(M,i).on(_,f),w=Wo.select(g).on(A,null).on(T,e),k=Y();H.call(g),e(),o(p)}function f(){var n=L.of(this,arguments);d?clearTimeout(d):(H.call(this),o(n)),d=setTimeout(function(){d=null,c(n)},50),y();var e=v||Wo.mouse(this);p||(p=t(e)),r(Math.pow(2,.002*Ua())*S.k),u(e,p),a(n)}function h(){p=null}function g(){var n=L.of(this,arguments),e=Wo.mouse(this),i=t(e),s=Math.log(S.k)/Math.LN2;o(n),r(Math.pow(2,Wo.event.shiftKey?Math.ceil(s)-1:Math.floor(s)+1)),u(e,i),a(n),c(n)}var p,v,d,m,x,_,b,w,S={x:0,y:0,k:1},k=[960,500],E=Ha,A="mousedown.zoom",C="mousemove.zoom",N="mouseup.zoom",T="touchstart.zoom",L=M(n,"zoomstart","zoom","zoomend");return n.event=function(n){n.each(function(){var n=L.of(this,arguments),t=S;Ts?Wo.select(this).transition().each("start.zoom",function(){S=this.__chart__||{x:0,y:0,k:1},o(n)}).tween("zoom:zoom",function(){var e=k[0],r=k[1],u=e/2,i=r/2,o=Wo.interpolateZoom([(u-S.x)/S.k,(i-S.y)/S.k,e/S.k],[(u-t.x)/t.k,(i-t.y)/t.k,e/t.k]);return function(t){var r=o(t),c=e/r[2];this.__chart__=S={x:u-r[0]*c,y:i-r[1]*c,k:c},a(n)}}).each("end.zoom",function(){c(n)}):(this.__chart__=S,o(n),a(n),c(n))})},n.translate=function(t){return arguments.length?(S={x:+t[0],y:+t[1],k:S.k},i(),n):[S.x,S.y]},n.scale=function(t){return arguments.length?(S={x:S.x,y:S.y,k:+t},i(),n):S.k},n.scaleExtent=function(t){return arguments.length?(E=null==t?Ha:[+t[0],+t[1]],n):E},n.center=function(t){return arguments.length?(v=t&&[+t[0],+t[1]],n):v},n.size=function(t){return arguments.length?(k=t&&[+t[0],+t[1]],n):k},n.x=function(t){return arguments.length?(_=t,x=t.copy(),S={x:0,y:0,k:1},n):_},n.y=function(t){return arguments.length?(w=t,b=t.copy(),S={x:0,y:0,k:1},n):w},Wo.rebind(n,L,"on")};var Ua,Ha=[0,1/0],Oa="onwheel"in na?(Ua=function(){return-Wo.event.deltaY*(Wo.event.deltaMode?120:1)},"wheel"):"onmousewheel"in na?(Ua=function(){return Wo.event.wheelDelta},"mousewheel"):(Ua=function(){return-Wo.event.detail},"MozMousePixelScroll");et.prototype.toString=function(){return this.rgb()+""},Wo.hsl=function(n,t,e){return 1===arguments.length?n instanceof ut?rt(n.h,n.s,n.l):_t(""+n,bt,rt):rt(+n,+t,+e)};var Fa=ut.prototype=new et;Fa.brighter=function(n){return n=Math.pow(.7,arguments.length?n:1),rt(this.h,this.s,this.l/n)},Fa.darker=function(n){return n=Math.pow(.7,arguments.length?n:1),rt(this.h,this.s,n*this.l)},Fa.rgb=function(){return it(this.h,this.s,this.l)},Wo.hcl=function(n,t,e){return 1===arguments.length?n instanceof at?ot(n.h,n.c,n.l):n instanceof lt?ht(n.l,n.a,n.b):ht((n=wt((n=Wo.rgb(n)).r,n.g,n.b)).l,n.a,n.b):ot(+n,+t,+e)};var Ia=at.prototype=new et;Ia.brighter=function(n){return ot(this.h,this.c,Math.min(100,this.l+Ya*(arguments.length?n:1)))},Ia.darker=function(n){return ot(this.h,this.c,Math.max(0,this.l-Ya*(arguments.length?n:1)))},Ia.rgb=function(){return ct(this.h,this.c,this.l).rgb()},Wo.lab=function(n,t,e){return 1===arguments.length?n instanceof lt?st(n.l,n.a,n.b):n instanceof at?ct(n.l,n.c,n.h):wt((n=Wo.rgb(n)).r,n.g,n.b):st(+n,+t,+e)};var Ya=18,Za=.95047,Va=1,$a=1.08883,Xa=lt.prototype=new et;Xa.brighter=function(n){return st(Math.min(100,this.l+Ya*(arguments.length?n:1)),this.a,this.b)},Xa.darker=function(n){return st(Math.max(0,this.l-Ya*(arguments.length?n:1)),this.a,this.b)},Xa.rgb=function(){return ft(this.l,this.a,this.b)},Wo.rgb=function(n,t,e){return 1===arguments.length?n instanceof xt?yt(n.r,n.g,n.b):_t(""+n,yt,it):yt(~~n,~~t,~~e)};var Ba=xt.prototype=new et;Ba.brighter=function(n){n=Math.pow(.7,arguments.length?n:1);var t=this.r,e=this.g,r=this.b,u=30;return t||e||r?(t&&u>t&&(t=u),e&&u>e&&(e=u),r&&u>r&&(r=u),yt(Math.min(255,~~(t/n)),Math.min(255,~~(e/n)),Math.min(255,~~(r/n)))):yt(u,u,u)},Ba.darker=function(n){return n=Math.pow(.7,arguments.length?n:1),yt(~~(n*this.r),~~(n*this.g),~~(n*this.b))},Ba.hsl=function(){return bt(this.r,this.g,this.b)},Ba.toString=function(){return"#"+Mt(this.r)+Mt(this.g)+Mt(this.b)};var Ga=Wo.map({aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074});Ga.forEach(function(n,t){Ga.set(n,dt(t))}),Wo.functor=Et,Wo.xhr=Ct(At),Wo.dsv=function(n,t){function e(n,e,i){arguments.length<3&&(i=e,e=null);var o=Nt(n,t,null==e?r:u(e),i);return o.row=function(n){return arguments.length?o.response(null==(e=n)?r:u(n)):e},o}function r(n){return e.parse(n.responseText)}function u(n){return function(t){return e.parse(t.responseText,n)}}function i(t){return t.map(o).join(n)}function o(n){return a.test(n)?'"'+n.replace(/\"/g,'""')+'"':n}var a=new RegExp('["'+n+"\n]"),c=n.charCodeAt(0);return e.parse=function(n,t){var r;return e.parseRows(n,function(n,e){if(r)return r(n,e-1);var u=new Function("d","return {"+n.map(function(n,t){return JSON.stringify(n)+": d["+t+"]"}).join(",")+"}");r=t?function(n,e){return t(u(n),e)}:u})},e.parseRows=function(n,t){function e(){if(l>=s)return o;if(u)return u=!1,i;var t=l;if(34===n.charCodeAt(t)){for(var e=t;e++<s;)if(34===n.charCodeAt(e)){if(34!==n.charCodeAt(e+1))break;++e}l=e+2;var r=n.charCodeAt(e+1);return 13===r?(u=!0,10===n.charCodeAt(e+2)&&++l):10===r&&(u=!0),n.substring(t+1,e).replace(/""/g,'"')}for(;s>l;){var r=n.charCodeAt(l++),a=1;if(10===r)u=!0;else if(13===r)u=!0,10===n.charCodeAt(l)&&(++l,++a);else if(r!==c)continue;return n.substring(t,l-a)}return n.substring(t)}for(var r,u,i={},o={},a=[],s=n.length,l=0,f=0;(r=e())!==o;){for(var h=[];r!==i&&r!==o;)h.push(r),r=e();(!t||(h=t(h,f++)))&&a.push(h)}return a},e.format=function(t){if(Array.isArray(t[0]))return e.formatRows(t);var r=new h,u=[];return t.forEach(function(n){for(var t in n)r.has(t)||u.push(r.add(t))}),[u.map(o).join(n)].concat(t.map(function(t){return u.map(function(n){return o(t[n])}).join(n)})).join("\n")},e.formatRows=function(n){return n.map(i).join("\n")},e},Wo.csv=Wo.dsv(",","text/csv"),Wo.tsv=Wo.dsv("	","text/tab-separated-values"),Wo.touch=function(n,t,e){if(arguments.length<3&&(e=t,t=x().changedTouches),t)for(var r,u=0,i=t.length;i>u;++u)if((r=t[u]).identifier===e)return Z(n,r)};var Ja,Wa,Ka,Qa,nc,tc=ea[p(ea,"requestAnimationFrame")]||function(n){setTimeout(n,17)};Wo.timer=function(n,t,e){var r=arguments.length;2>r&&(t=0),3>r&&(e=Date.now());var u=e+t,i={c:n,t:u,f:!1,n:null};Wa?Wa.n=i:Ja=i,Wa=i,Ka||(Qa=clearTimeout(Qa),Ka=1,tc(Lt))},Wo.timer.flush=function(){qt(),zt()},Wo.round=function(n,t){return t?Math.round(n*(t=Math.pow(10,t)))/t:Math.round(n)};var ec=["y","z","a","f","p","n","\xb5","m","","k","M","G","T","P","E","Z","Y"].map(Dt);Wo.formatPrefix=function(n,t){var e=0;return n&&(0>n&&(n*=-1),t&&(n=Wo.round(n,Rt(n,t))),e=1+Math.floor(1e-12+Math.log(n)/Math.LN10),e=Math.max(-24,Math.min(24,3*Math.floor((e-1)/3)))),ec[8+e/3]};var rc=/(?:([^{])?([<>=^]))?([+\- ])?([$#])?(0)?(\d+)?(,)?(\.-?\d+)?([a-z%])?/i,uc=Wo.map({b:function(n){return n.toString(2)},c:function(n){return String.fromCharCode(n)},o:function(n){return n.toString(8)},x:function(n){return n.toString(16)},X:function(n){return n.toString(16).toUpperCase()},g:function(n,t){return n.toPrecision(t)},e:function(n,t){return n.toExponential(t)},f:function(n,t){return n.toFixed(t)},r:function(n,t){return(n=Wo.round(n,Rt(n,t))).toFixed(Math.max(0,Math.min(20,Rt(n*(1+1e-15),t))))}}),ic=Wo.time={},oc=Date;Ut.prototype={getDate:function(){return this._.getUTCDate()},getDay:function(){return this._.getUTCDay()},getFullYear:function(){return this._.getUTCFullYear()},getHours:function(){return this._.getUTCHours()},getMilliseconds:function(){return this._.getUTCMilliseconds()},getMinutes:function(){return this._.getUTCMinutes()},getMonth:function(){return this._.getUTCMonth()},getSeconds:function(){return this._.getUTCSeconds()},getTime:function(){return this._.getTime()},getTimezoneOffset:function(){return 0},valueOf:function(){return this._.valueOf()},setDate:function(){ac.setUTCDate.apply(this._,arguments)},setDay:function(){ac.setUTCDay.apply(this._,arguments)},setFullYear:function(){ac.setUTCFullYear.apply(this._,arguments)},setHours:function(){ac.setUTCHours.apply(this._,arguments)},setMilliseconds:function(){ac.setUTCMilliseconds.apply(this._,arguments)},setMinutes:function(){ac.setUTCMinutes.apply(this._,arguments)},setMonth:function(){ac.setUTCMonth.apply(this._,arguments)},setSeconds:function(){ac.setUTCSeconds.apply(this._,arguments)},setTime:function(){ac.setTime.apply(this._,arguments)}};var ac=Date.prototype;ic.year=Ht(function(n){return n=ic.day(n),n.setMonth(0,1),n},function(n,t){n.setFullYear(n.getFullYear()+t)},function(n){return n.getFullYear()}),ic.years=ic.year.range,ic.years.utc=ic.year.utc.range,ic.day=Ht(function(n){var t=new oc(2e3,0);return t.setFullYear(n.getFullYear(),n.getMonth(),n.getDate()),t},function(n,t){n.setDate(n.getDate()+t)},function(n){return n.getDate()-1}),ic.days=ic.day.range,ic.days.utc=ic.day.utc.range,ic.dayOfYear=function(n){var t=ic.year(n);return Math.floor((n-t-6e4*(n.getTimezoneOffset()-t.getTimezoneOffset()))/864e5)},["sunday","monday","tuesday","wednesday","thursday","friday","saturday"].forEach(function(n,t){t=7-t;var e=ic[n]=Ht(function(n){return(n=ic.day(n)).setDate(n.getDate()-(n.getDay()+t)%7),n},function(n,t){n.setDate(n.getDate()+7*Math.floor(t))},function(n){var e=ic.year(n).getDay();return Math.floor((ic.dayOfYear(n)+(e+t)%7)/7)-(e!==t)});ic[n+"s"]=e.range,ic[n+"s"].utc=e.utc.range,ic[n+"OfYear"]=function(n){var e=ic.year(n).getDay();return Math.floor((ic.dayOfYear(n)+(e+t)%7)/7)}}),ic.week=ic.sunday,ic.weeks=ic.sunday.range,ic.weeks.utc=ic.sunday.utc.range,ic.weekOfYear=ic.sundayOfYear;var cc={"-":"",_:" ",0:"0"},sc=/^\s*\d+/,lc=/^%/;Wo.locale=function(n){return{numberFormat:Pt(n),timeFormat:Ft(n)}};var fc=Wo.locale({decimal:".",thousands:",",grouping:[3],currency:["$",""],dateTime:"%a %b %e %X %Y",date:"%m/%d/%Y",time:"%H:%M:%S",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]});Wo.format=fc.numberFormat,Wo.geo={},ce.prototype={s:0,t:0,add:function(n){se(n,this.t,hc),se(hc.s,this.s,this),this.s?this.t+=hc.t:this.s=hc.t},reset:function(){this.s=this.t=0},valueOf:function(){return this.s}};var hc=new ce;Wo.geo.stream=function(n,t){n&&gc.hasOwnProperty(n.type)?gc[n.type](n,t):le(n,t)};var gc={Feature:function(n,t){le(n.geometry,t)},FeatureCollection:function(n,t){for(var e=n.features,r=-1,u=e.length;++r<u;)le(e[r].geometry,t)}},pc={Sphere:function(n,t){t.sphere()},Point:function(n,t){n=n.coordinates,t.point(n[0],n[1],n[2])},MultiPoint:function(n,t){for(var e=n.coordinates,r=-1,u=e.length;++r<u;)n=e[r],t.point(n[0],n[1],n[2])},LineString:function(n,t){fe(n.coordinates,t,0)},MultiLineString:function(n,t){for(var e=n.coordinates,r=-1,u=e.length;++r<u;)fe(e[r],t,0)},Polygon:function(n,t){he(n.coordinates,t)},MultiPolygon:function(n,t){for(var e=n.coordinates,r=-1,u=e.length;++r<u;)he(e[r],t)},GeometryCollection:function(n,t){for(var e=n.geometries,r=-1,u=e.length;++r<u;)le(e[r],t)}};Wo.geo.area=function(n){return vc=0,Wo.geo.stream(n,mc),vc};var vc,dc=new ce,mc={sphere:function(){vc+=4*Ca},point:v,lineStart:v,lineEnd:v,polygonStart:function(){dc.reset(),mc.lineStart=ge},polygonEnd:function(){var n=2*dc;vc+=0>n?4*Ca+n:n,mc.lineStart=mc.lineEnd=mc.point=v}};Wo.geo.bounds=function(){function n(n,t){x.push(M=[l=n,h=n]),f>t&&(f=t),t>g&&(g=t)}function t(t,e){var r=pe([t*za,e*za]);if(m){var u=de(m,r),i=[u[1],-u[0],0],o=de(i,u);xe(o),o=Me(o);var c=t-p,s=c>0?1:-1,v=o[0]*Ra*s,d=fa(c)>180;if(d^(v>s*p&&s*t>v)){var y=o[1]*Ra;y>g&&(g=y)}else if(v=(v+360)%360-180,d^(v>s*p&&s*t>v)){var y=-o[1]*Ra;f>y&&(f=y)}else f>e&&(f=e),e>g&&(g=e);d?p>t?a(l,t)>a(l,h)&&(h=t):a(t,h)>a(l,h)&&(l=t):h>=l?(l>t&&(l=t),t>h&&(h=t)):t>p?a(l,t)>a(l,h)&&(h=t):a(t,h)>a(l,h)&&(l=t)}else n(t,e);m=r,p=t}function e(){_.point=t}function r(){M[0]=l,M[1]=h,_.point=n,m=null}function u(n,e){if(m){var r=n-p;y+=fa(r)>180?r+(r>0?360:-360):r}else v=n,d=e;mc.point(n,e),t(n,e)}function i(){mc.lineStart()}function o(){u(v,d),mc.lineEnd(),fa(y)>La&&(l=-(h=180)),M[0]=l,M[1]=h,m=null}function a(n,t){return(t-=n)<0?t+360:t}function c(n,t){return n[0]-t[0]}function s(n,t){return t[0]<=t[1]?t[0]<=n&&n<=t[1]:n<t[0]||t[1]<n}var l,f,h,g,p,v,d,m,y,x,M,_={point:n,lineStart:e,lineEnd:r,polygonStart:function(){_.point=u,_.lineStart=i,_.lineEnd=o,y=0,mc.polygonStart()},polygonEnd:function(){mc.polygonEnd(),_.point=n,_.lineStart=e,_.lineEnd=r,0>dc?(l=-(h=180),f=-(g=90)):y>La?g=90:-La>y&&(f=-90),M[0]=l,M[1]=h}};return function(n){g=h=-(l=f=1/0),x=[],Wo.geo.stream(n,_);var t=x.length;if(t){x.sort(c);for(var e,r=1,u=x[0],i=[u];t>r;++r)e=x[r],s(e[0],u)||s(e[1],u)?(a(u[0],e[1])>a(u[0],u[1])&&(u[1]=e[1]),a(e[0],u[1])>a(u[0],u[1])&&(u[0]=e[0])):i.push(u=e);
for(var o,e,p=-1/0,t=i.length-1,r=0,u=i[t];t>=r;u=e,++r)e=i[r],(o=a(u[1],e[0]))>p&&(p=o,l=e[0],h=u[1])}return x=M=null,1/0===l||1/0===f?[[0/0,0/0],[0/0,0/0]]:[[l,f],[h,g]]}}(),Wo.geo.centroid=function(n){yc=xc=Mc=_c=bc=wc=Sc=kc=Ec=Ac=Cc=0,Wo.geo.stream(n,Nc);var t=Ec,e=Ac,r=Cc,u=t*t+e*e+r*r;return qa>u&&(t=wc,e=Sc,r=kc,La>xc&&(t=Mc,e=_c,r=bc),u=t*t+e*e+r*r,qa>u)?[0/0,0/0]:[Math.atan2(e,t)*Ra,W(r/Math.sqrt(u))*Ra]};var yc,xc,Mc,_c,bc,wc,Sc,kc,Ec,Ac,Cc,Nc={sphere:v,point:be,lineStart:Se,lineEnd:ke,polygonStart:function(){Nc.lineStart=Ee},polygonEnd:function(){Nc.lineStart=Se}},Tc=Le(Ae,Pe,Ue,[-Ca,-Ca/2]),Lc=1e9;Wo.geo.clipExtent=function(){var n,t,e,r,u,i,o={stream:function(n){return u&&(u.valid=!1),u=i(n),u.valid=!0,u},extent:function(a){return arguments.length?(i=Fe(n=+a[0][0],t=+a[0][1],e=+a[1][0],r=+a[1][1]),u&&(u.valid=!1,u=null),o):[[n,t],[e,r]]}};return o.extent([[0,0],[960,500]])},(Wo.geo.conicEqualArea=function(){return Ye(Ze)}).raw=Ze,Wo.geo.albers=function(){return Wo.geo.conicEqualArea().rotate([96,0]).center([-.6,38.7]).parallels([29.5,45.5]).scale(1070)},Wo.geo.albersUsa=function(){function n(n){var i=n[0],o=n[1];return t=null,e(i,o),t||(r(i,o),t)||u(i,o),t}var t,e,r,u,i=Wo.geo.albers(),o=Wo.geo.conicEqualArea().rotate([154,0]).center([-2,58.5]).parallels([55,65]),a=Wo.geo.conicEqualArea().rotate([157,0]).center([-3,19.9]).parallels([8,18]),c={point:function(n,e){t=[n,e]}};return n.invert=function(n){var t=i.scale(),e=i.translate(),r=(n[0]-e[0])/t,u=(n[1]-e[1])/t;return(u>=.12&&.234>u&&r>=-.425&&-.214>r?o:u>=.166&&.234>u&&r>=-.214&&-.115>r?a:i).invert(n)},n.stream=function(n){var t=i.stream(n),e=o.stream(n),r=a.stream(n);return{point:function(n,u){t.point(n,u),e.point(n,u),r.point(n,u)},sphere:function(){t.sphere(),e.sphere(),r.sphere()},lineStart:function(){t.lineStart(),e.lineStart(),r.lineStart()},lineEnd:function(){t.lineEnd(),e.lineEnd(),r.lineEnd()},polygonStart:function(){t.polygonStart(),e.polygonStart(),r.polygonStart()},polygonEnd:function(){t.polygonEnd(),e.polygonEnd(),r.polygonEnd()}}},n.precision=function(t){return arguments.length?(i.precision(t),o.precision(t),a.precision(t),n):i.precision()},n.scale=function(t){return arguments.length?(i.scale(t),o.scale(.35*t),a.scale(t),n.translate(i.translate())):i.scale()},n.translate=function(t){if(!arguments.length)return i.translate();var s=i.scale(),l=+t[0],f=+t[1];return e=i.translate(t).clipExtent([[l-.455*s,f-.238*s],[l+.455*s,f+.238*s]]).stream(c).point,r=o.translate([l-.307*s,f+.201*s]).clipExtent([[l-.425*s+La,f+.12*s+La],[l-.214*s-La,f+.234*s-La]]).stream(c).point,u=a.translate([l-.205*s,f+.212*s]).clipExtent([[l-.214*s+La,f+.166*s+La],[l-.115*s-La,f+.234*s-La]]).stream(c).point,n},n.scale(1070)};var qc,zc,Rc,Dc,Pc,jc,Uc={point:v,lineStart:v,lineEnd:v,polygonStart:function(){zc=0,Uc.lineStart=Ve},polygonEnd:function(){Uc.lineStart=Uc.lineEnd=Uc.point=v,qc+=fa(zc/2)}},Hc={point:$e,lineStart:v,lineEnd:v,polygonStart:v,polygonEnd:v},Oc={point:Ge,lineStart:Je,lineEnd:We,polygonStart:function(){Oc.lineStart=Ke},polygonEnd:function(){Oc.point=Ge,Oc.lineStart=Je,Oc.lineEnd=We}};Wo.geo.path=function(){function n(n){return n&&("function"==typeof a&&i.pointRadius(+a.apply(this,arguments)),o&&o.valid||(o=u(i)),Wo.geo.stream(n,o)),i.result()}function t(){return o=null,n}var e,r,u,i,o,a=4.5;return n.area=function(n){return qc=0,Wo.geo.stream(n,u(Uc)),qc},n.centroid=function(n){return Mc=_c=bc=wc=Sc=kc=Ec=Ac=Cc=0,Wo.geo.stream(n,u(Oc)),Cc?[Ec/Cc,Ac/Cc]:kc?[wc/kc,Sc/kc]:bc?[Mc/bc,_c/bc]:[0/0,0/0]},n.bounds=function(n){return Pc=jc=-(Rc=Dc=1/0),Wo.geo.stream(n,u(Hc)),[[Rc,Dc],[Pc,jc]]},n.projection=function(n){return arguments.length?(u=(e=n)?n.stream||tr(n):At,t()):e},n.context=function(n){return arguments.length?(i=null==(r=n)?new Xe:new Qe(n),"function"!=typeof a&&i.pointRadius(a),t()):r},n.pointRadius=function(t){return arguments.length?(a="function"==typeof t?t:(i.pointRadius(+t),+t),n):a},n.projection(Wo.geo.albersUsa()).context(null)},Wo.geo.transform=function(n){return{stream:function(t){var e=new er(t);for(var r in n)e[r]=n[r];return e}}},er.prototype={point:function(n,t){this.stream.point(n,t)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}},Wo.geo.projection=ur,Wo.geo.projectionMutator=ir,(Wo.geo.equirectangular=function(){return ur(ar)}).raw=ar.invert=ar,Wo.geo.rotation=function(n){function t(t){return t=n(t[0]*za,t[1]*za),t[0]*=Ra,t[1]*=Ra,t}return n=sr(n[0]%360*za,n[1]*za,n.length>2?n[2]*za:0),t.invert=function(t){return t=n.invert(t[0]*za,t[1]*za),t[0]*=Ra,t[1]*=Ra,t},t},cr.invert=ar,Wo.geo.circle=function(){function n(){var n="function"==typeof r?r.apply(this,arguments):r,t=sr(-n[0]*za,-n[1]*za,0).invert,u=[];return e(null,null,1,{point:function(n,e){u.push(n=t(n,e)),n[0]*=Ra,n[1]*=Ra}}),{type:"Polygon",coordinates:[u]}}var t,e,r=[0,0],u=6;return n.origin=function(t){return arguments.length?(r=t,n):r},n.angle=function(r){return arguments.length?(e=gr((t=+r)*za,u*za),n):t},n.precision=function(r){return arguments.length?(e=gr(t*za,(u=+r)*za),n):u},n.angle(90)},Wo.geo.distance=function(n,t){var e,r=(t[0]-n[0])*za,u=n[1]*za,i=t[1]*za,o=Math.sin(r),a=Math.cos(r),c=Math.sin(u),s=Math.cos(u),l=Math.sin(i),f=Math.cos(i);return Math.atan2(Math.sqrt((e=f*o)*e+(e=s*l-c*f*a)*e),c*l+s*f*a)},Wo.geo.graticule=function(){function n(){return{type:"MultiLineString",coordinates:t()}}function t(){return Wo.range(Math.ceil(i/d)*d,u,d).map(h).concat(Wo.range(Math.ceil(s/m)*m,c,m).map(g)).concat(Wo.range(Math.ceil(r/p)*p,e,p).filter(function(n){return fa(n%d)>La}).map(l)).concat(Wo.range(Math.ceil(a/v)*v,o,v).filter(function(n){return fa(n%m)>La}).map(f))}var e,r,u,i,o,a,c,s,l,f,h,g,p=10,v=p,d=90,m=360,y=2.5;return n.lines=function(){return t().map(function(n){return{type:"LineString",coordinates:n}})},n.outline=function(){return{type:"Polygon",coordinates:[h(i).concat(g(c).slice(1),h(u).reverse().slice(1),g(s).reverse().slice(1))]}},n.extent=function(t){return arguments.length?n.majorExtent(t).minorExtent(t):n.minorExtent()},n.majorExtent=function(t){return arguments.length?(i=+t[0][0],u=+t[1][0],s=+t[0][1],c=+t[1][1],i>u&&(t=i,i=u,u=t),s>c&&(t=s,s=c,c=t),n.precision(y)):[[i,s],[u,c]]},n.minorExtent=function(t){return arguments.length?(r=+t[0][0],e=+t[1][0],a=+t[0][1],o=+t[1][1],r>e&&(t=r,r=e,e=t),a>o&&(t=a,a=o,o=t),n.precision(y)):[[r,a],[e,o]]},n.step=function(t){return arguments.length?n.majorStep(t).minorStep(t):n.minorStep()},n.majorStep=function(t){return arguments.length?(d=+t[0],m=+t[1],n):[d,m]},n.minorStep=function(t){return arguments.length?(p=+t[0],v=+t[1],n):[p,v]},n.precision=function(t){return arguments.length?(y=+t,l=vr(a,o,90),f=dr(r,e,y),h=vr(s,c,90),g=dr(i,u,y),n):y},n.majorExtent([[-180,-90+La],[180,90-La]]).minorExtent([[-180,-80-La],[180,80+La]])},Wo.geo.greatArc=function(){function n(){return{type:"LineString",coordinates:[t||r.apply(this,arguments),e||u.apply(this,arguments)]}}var t,e,r=mr,u=yr;return n.distance=function(){return Wo.geo.distance(t||r.apply(this,arguments),e||u.apply(this,arguments))},n.source=function(e){return arguments.length?(r=e,t="function"==typeof e?null:e,n):r},n.target=function(t){return arguments.length?(u=t,e="function"==typeof t?null:t,n):u},n.precision=function(){return arguments.length?n:0},n},Wo.geo.interpolate=function(n,t){return xr(n[0]*za,n[1]*za,t[0]*za,t[1]*za)},Wo.geo.length=function(n){return Fc=0,Wo.geo.stream(n,Ic),Fc};var Fc,Ic={sphere:v,point:v,lineStart:Mr,lineEnd:v,polygonStart:v,polygonEnd:v},Yc=_r(function(n){return Math.sqrt(2/(1+n))},function(n){return 2*Math.asin(n/2)});(Wo.geo.azimuthalEqualArea=function(){return ur(Yc)}).raw=Yc;var Zc=_r(function(n){var t=Math.acos(n);return t&&t/Math.sin(t)},At);(Wo.geo.azimuthalEquidistant=function(){return ur(Zc)}).raw=Zc,(Wo.geo.conicConformal=function(){return Ye(br)}).raw=br,(Wo.geo.conicEquidistant=function(){return Ye(wr)}).raw=wr;var Vc=_r(function(n){return 1/n},Math.atan);(Wo.geo.gnomonic=function(){return ur(Vc)}).raw=Vc,Sr.invert=function(n,t){return[n,2*Math.atan(Math.exp(t))-Ta]},(Wo.geo.mercator=function(){return kr(Sr)}).raw=Sr;var $c=_r(function(){return 1},Math.asin);(Wo.geo.orthographic=function(){return ur($c)}).raw=$c;var Xc=_r(function(n){return 1/(1+n)},function(n){return 2*Math.atan(n)});(Wo.geo.stereographic=function(){return ur(Xc)}).raw=Xc,Er.invert=function(n,t){return[-t,2*Math.atan(Math.exp(n))-Ta]},(Wo.geo.transverseMercator=function(){var n=kr(Er),t=n.center,e=n.rotate;return n.center=function(n){return n?t([-n[1],n[0]]):(n=t(),[-n[1],n[0]])},n.rotate=function(n){return n?e([n[0],n[1],n.length>2?n[2]+90:90]):(n=e(),[n[0],n[1],n[2]-90])},n.rotate([0,0])}).raw=Er,Wo.geom={},Wo.geom.hull=function(n){function t(n){if(n.length<3)return[];var t,u=Et(e),i=Et(r),o=n.length,a=[],c=[];for(t=0;o>t;t++)a.push([+u.call(this,n[t],t),+i.call(this,n[t],t),t]);for(a.sort(Tr),t=0;o>t;t++)c.push([a[t][0],-a[t][1]]);var s=Nr(a),l=Nr(c),f=l[0]===s[0],h=l[l.length-1]===s[s.length-1],g=[];for(t=s.length-1;t>=0;--t)g.push(n[a[s[t]][2]]);for(t=+f;t<l.length-h;++t)g.push(n[a[l[t]][2]]);return g}var e=Ar,r=Cr;return arguments.length?t(n):(t.x=function(n){return arguments.length?(e=n,t):e},t.y=function(n){return arguments.length?(r=n,t):r},t)},Wo.geom.polygon=function(n){return da(n,Bc),n};var Bc=Wo.geom.polygon.prototype=[];Bc.area=function(){for(var n,t=-1,e=this.length,r=this[e-1],u=0;++t<e;)n=r,r=this[t],u+=n[1]*r[0]-n[0]*r[1];return.5*u},Bc.centroid=function(n){var t,e,r=-1,u=this.length,i=0,o=0,a=this[u-1];for(arguments.length||(n=-1/(6*this.area()));++r<u;)t=a,a=this[r],e=t[0]*a[1]-a[0]*t[1],i+=(t[0]+a[0])*e,o+=(t[1]+a[1])*e;return[i*n,o*n]},Bc.clip=function(n){for(var t,e,r,u,i,o,a=zr(n),c=-1,s=this.length-zr(this),l=this[s-1];++c<s;){for(t=n.slice(),n.length=0,u=this[c],i=t[(r=t.length-a)-1],e=-1;++e<r;)o=t[e],Lr(o,l,u)?(Lr(i,l,u)||n.push(qr(i,o,l,u)),n.push(o)):Lr(i,l,u)&&n.push(qr(i,o,l,u)),i=o;a&&n.push(n[0]),l=u}return n};var Gc,Jc,Wc,Kc,Qc,ns=[],ts=[];Fr.prototype.prepare=function(){for(var n,t=this.edges,e=t.length;e--;)n=t[e].edge,n.b&&n.a||t.splice(e,1);return t.sort(Yr),t.length},Qr.prototype={start:function(){return this.edge.l===this.site?this.edge.a:this.edge.b},end:function(){return this.edge.l===this.site?this.edge.b:this.edge.a}},nu.prototype={insert:function(n,t){var e,r,u;if(n){if(t.P=n,t.N=n.N,n.N&&(n.N.P=t),n.N=t,n.R){for(n=n.R;n.L;)n=n.L;n.L=t}else n.R=t;e=n}else this._?(n=uu(this._),t.P=null,t.N=n,n.P=n.L=t,e=n):(t.P=t.N=null,this._=t,e=null);for(t.L=t.R=null,t.U=e,t.C=!0,n=t;e&&e.C;)r=e.U,e===r.L?(u=r.R,u&&u.C?(e.C=u.C=!1,r.C=!0,n=r):(n===e.R&&(eu(this,e),n=e,e=n.U),e.C=!1,r.C=!0,ru(this,r))):(u=r.L,u&&u.C?(e.C=u.C=!1,r.C=!0,n=r):(n===e.L&&(ru(this,e),n=e,e=n.U),e.C=!1,r.C=!0,eu(this,r))),e=n.U;this._.C=!1},remove:function(n){n.N&&(n.N.P=n.P),n.P&&(n.P.N=n.N),n.N=n.P=null;var t,e,r,u=n.U,i=n.L,o=n.R;if(e=i?o?uu(o):i:o,u?u.L===n?u.L=e:u.R=e:this._=e,i&&o?(r=e.C,e.C=n.C,e.L=i,i.U=e,e!==o?(u=e.U,e.U=n.U,n=e.R,u.L=n,e.R=o,o.U=e):(e.U=u,u=e,n=e.R)):(r=n.C,n=e),n&&(n.U=u),!r){if(n&&n.C)return n.C=!1,void 0;do{if(n===this._)break;if(n===u.L){if(t=u.R,t.C&&(t.C=!1,u.C=!0,eu(this,u),t=u.R),t.L&&t.L.C||t.R&&t.R.C){t.R&&t.R.C||(t.L.C=!1,t.C=!0,ru(this,t),t=u.R),t.C=u.C,u.C=t.R.C=!1,eu(this,u),n=this._;break}}else if(t=u.L,t.C&&(t.C=!1,u.C=!0,ru(this,u),t=u.L),t.L&&t.L.C||t.R&&t.R.C){t.L&&t.L.C||(t.R.C=!1,t.C=!0,eu(this,t),t=u.L),t.C=u.C,u.C=t.L.C=!1,ru(this,u),n=this._;break}t.C=!0,n=u,u=u.U}while(!n.C);n&&(n.C=!1)}}},Wo.geom.voronoi=function(n){function t(n){var t=new Array(n.length),r=a[0][0],u=a[0][1],i=a[1][0],o=a[1][1];return iu(e(n),a).cells.forEach(function(e,a){var c=e.edges,s=e.site,l=t[a]=c.length?c.map(function(n){var t=n.start();return[t.x,t.y]}):s.x>=r&&s.x<=i&&s.y>=u&&s.y<=o?[[r,o],[i,o],[i,u],[r,u]]:[];l.point=n[a]}),t}function e(n){return n.map(function(n,t){return{x:Math.round(i(n,t)/La)*La,y:Math.round(o(n,t)/La)*La,i:t}})}var r=Ar,u=Cr,i=r,o=u,a=es;return n?t(n):(t.links=function(n){return iu(e(n)).edges.filter(function(n){return n.l&&n.r}).map(function(t){return{source:n[t.l.i],target:n[t.r.i]}})},t.triangles=function(n){var t=[];return iu(e(n)).cells.forEach(function(e,r){for(var u,i,o=e.site,a=e.edges.sort(Yr),c=-1,s=a.length,l=a[s-1].edge,f=l.l===o?l.r:l.l;++c<s;)u=l,i=f,l=a[c].edge,f=l.l===o?l.r:l.l,r<i.i&&r<f.i&&au(o,i,f)<0&&t.push([n[r],n[i.i],n[f.i]])}),t},t.x=function(n){return arguments.length?(i=Et(r=n),t):r},t.y=function(n){return arguments.length?(o=Et(u=n),t):u},t.clipExtent=function(n){return arguments.length?(a=null==n?es:n,t):a===es?null:a},t.size=function(n){return arguments.length?t.clipExtent(n&&[[0,0],n]):a===es?null:a&&a[1]},t)};var es=[[-1e6,-1e6],[1e6,1e6]];Wo.geom.delaunay=function(n){return Wo.geom.voronoi().triangles(n)},Wo.geom.quadtree=function(n,t,e,r,u){function i(n){function i(n,t,e,r,u,i,o,a){if(!isNaN(e)&&!isNaN(r))if(n.leaf){var c=n.x,l=n.y;if(null!=c)if(fa(c-e)+fa(l-r)<.01)s(n,t,e,r,u,i,o,a);else{var f=n.point;n.x=n.y=n.point=null,s(n,f,c,l,u,i,o,a),s(n,t,e,r,u,i,o,a)}else n.x=e,n.y=r,n.point=t}else s(n,t,e,r,u,i,o,a)}function s(n,t,e,r,u,o,a,c){var s=.5*(u+a),l=.5*(o+c),f=e>=s,h=r>=l,g=(h<<1)+f;n.leaf=!1,n=n.nodes[g]||(n.nodes[g]=lu()),f?u=s:a=s,h?o=l:c=l,i(n,t,e,r,u,o,a,c)}var l,f,h,g,p,v,d,m,y,x=Et(a),M=Et(c);if(null!=t)v=t,d=e,m=r,y=u;else if(m=y=-(v=d=1/0),f=[],h=[],p=n.length,o)for(g=0;p>g;++g)l=n[g],l.x<v&&(v=l.x),l.y<d&&(d=l.y),l.x>m&&(m=l.x),l.y>y&&(y=l.y),f.push(l.x),h.push(l.y);else for(g=0;p>g;++g){var _=+x(l=n[g],g),b=+M(l,g);v>_&&(v=_),d>b&&(d=b),_>m&&(m=_),b>y&&(y=b),f.push(_),h.push(b)}var w=m-v,S=y-d;w>S?y=d+w:m=v+S;var k=lu();if(k.add=function(n){i(k,n,+x(n,++g),+M(n,g),v,d,m,y)},k.visit=function(n){fu(n,k,v,d,m,y)},g=-1,null==t){for(;++g<p;)i(k,n[g],f[g],h[g],v,d,m,y);--g}else n.forEach(k.add);return f=h=n=l=null,k}var o,a=Ar,c=Cr;return(o=arguments.length)?(a=cu,c=su,3===o&&(u=e,r=t,e=t=0),i(n)):(i.x=function(n){return arguments.length?(a=n,i):a},i.y=function(n){return arguments.length?(c=n,i):c},i.extent=function(n){return arguments.length?(null==n?t=e=r=u=null:(t=+n[0][0],e=+n[0][1],r=+n[1][0],u=+n[1][1]),i):null==t?null:[[t,e],[r,u]]},i.size=function(n){return arguments.length?(null==n?t=e=r=u=null:(t=e=0,r=+n[0],u=+n[1]),i):null==t?null:[r-t,u-e]},i)},Wo.interpolateRgb=hu,Wo.interpolateObject=gu,Wo.interpolateNumber=pu,Wo.interpolateString=vu;var rs=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,us=new RegExp(rs.source,"g");Wo.interpolate=du,Wo.interpolators=[function(n,t){var e=typeof t;return("string"===e?Ga.has(t)||/^(#|rgb\(|hsl\()/.test(t)?hu:vu:t instanceof et?hu:Array.isArray(t)?mu:"object"===e&&isNaN(t)?gu:pu)(n,t)}],Wo.interpolateArray=mu;var is=function(){return At},os=Wo.map({linear:is,poly:Su,quad:function(){return _u},cubic:function(){return bu},sin:function(){return ku},exp:function(){return Eu},circle:function(){return Au},elastic:Cu,back:Nu,bounce:function(){return Tu}}),as=Wo.map({"in":At,out:xu,"in-out":Mu,"out-in":function(n){return Mu(xu(n))}});Wo.ease=function(n){var t=n.indexOf("-"),e=t>=0?n.substring(0,t):n,r=t>=0?n.substring(t+1):"in";return e=os.get(e)||is,r=as.get(r)||At,yu(r(e.apply(null,Ko.call(arguments,1))))},Wo.interpolateHcl=Lu,Wo.interpolateHsl=qu,Wo.interpolateLab=zu,Wo.interpolateRound=Ru,Wo.transform=function(n){var t=na.createElementNS(Wo.ns.prefix.svg,"g");return(Wo.transform=function(n){if(null!=n){t.setAttribute("transform",n);var e=t.transform.baseVal.consolidate()}return new Du(e?e.matrix:cs)})(n)},Du.prototype.toString=function(){return"translate("+this.translate+")rotate("+this.rotate+")skewX("+this.skew+")scale("+this.scale+")"};var cs={a:1,b:0,c:0,d:1,e:0,f:0};Wo.interpolateTransform=Hu,Wo.layout={},Wo.layout.bundle=function(){return function(n){for(var t=[],e=-1,r=n.length;++e<r;)t.push(Iu(n[e]));return t}},Wo.layout.chord=function(){function n(){var n,s,f,h,g,p={},v=[],d=Wo.range(i),m=[];for(e=[],r=[],n=0,h=-1;++h<i;){for(s=0,g=-1;++g<i;)s+=u[h][g];v.push(s),m.push(Wo.range(i)),n+=s}for(o&&d.sort(function(n,t){return o(v[n],v[t])}),a&&m.forEach(function(n,t){n.sort(function(n,e){return a(u[t][n],u[t][e])})}),n=(Na-l*i)/n,s=0,h=-1;++h<i;){for(f=s,g=-1;++g<i;){var y=d[h],x=m[y][g],M=u[y][x],_=s,b=s+=M*n;p[y+"-"+x]={index:y,subindex:x,startAngle:_,endAngle:b,value:M}}r[y]={index:y,startAngle:f,endAngle:s,value:(s-f)/n},s+=l}for(h=-1;++h<i;)for(g=h-1;++g<i;){var w=p[h+"-"+g],S=p[g+"-"+h];(w.value||S.value)&&e.push(w.value<S.value?{source:S,target:w}:{source:w,target:S})}c&&t()}function t(){e.sort(function(n,t){return c((n.source.value+n.target.value)/2,(t.source.value+t.target.value)/2)})}var e,r,u,i,o,a,c,s={},l=0;return s.matrix=function(n){return arguments.length?(i=(u=n)&&u.length,e=r=null,s):u},s.padding=function(n){return arguments.length?(l=n,e=r=null,s):l},s.sortGroups=function(n){return arguments.length?(o=n,e=r=null,s):o},s.sortSubgroups=function(n){return arguments.length?(a=n,e=null,s):a},s.sortChords=function(n){return arguments.length?(c=n,e&&t(),s):c},s.chords=function(){return e||n(),e},s.groups=function(){return r||n(),r},s},Wo.layout.force=function(){function n(n){return function(t,e,r,u){if(t.point!==n){var i=t.cx-n.x,o=t.cy-n.y,a=u-e,c=i*i+o*o;if(c>a*a/d){if(p>c){var s=t.charge/c;n.px-=i*s,n.py-=o*s}return!0}if(t.point&&c&&p>c){var s=t.pointCharge/c;n.px-=i*s,n.py-=o*s}}return!t.charge}}function t(n){n.px=Wo.event.x,n.py=Wo.event.y,a.resume()}var e,r,u,i,o,a={},c=Wo.dispatch("start","tick","end"),s=[1,1],l=.9,f=ss,h=ls,g=-30,p=fs,v=.1,d=.64,m=[],y=[];return a.tick=function(){if((r*=.99)<.005)return c.end({type:"end",alpha:r=0}),!0;var t,e,a,f,h,p,d,x,M,_=m.length,b=y.length;for(e=0;b>e;++e)a=y[e],f=a.source,h=a.target,x=h.x-f.x,M=h.y-f.y,(p=x*x+M*M)&&(p=r*i[e]*((p=Math.sqrt(p))-u[e])/p,x*=p,M*=p,h.x-=x*(d=f.weight/(h.weight+f.weight)),h.y-=M*d,f.x+=x*(d=1-d),f.y+=M*d);if((d=r*v)&&(x=s[0]/2,M=s[1]/2,e=-1,d))for(;++e<_;)a=m[e],a.x+=(x-a.x)*d,a.y+=(M-a.y)*d;if(g)for(Gu(t=Wo.geom.quadtree(m),r,o),e=-1;++e<_;)(a=m[e]).fixed||t.visit(n(a));for(e=-1;++e<_;)a=m[e],a.fixed?(a.x=a.px,a.y=a.py):(a.x-=(a.px-(a.px=a.x))*l,a.y-=(a.py-(a.py=a.y))*l);c.tick({type:"tick",alpha:r})},a.nodes=function(n){return arguments.length?(m=n,a):m},a.links=function(n){return arguments.length?(y=n,a):y},a.size=function(n){return arguments.length?(s=n,a):s},a.linkDistance=function(n){return arguments.length?(f="function"==typeof n?n:+n,a):f},a.distance=a.linkDistance,a.linkStrength=function(n){return arguments.length?(h="function"==typeof n?n:+n,a):h},a.friction=function(n){return arguments.length?(l=+n,a):l},a.charge=function(n){return arguments.length?(g="function"==typeof n?n:+n,a):g},a.chargeDistance=function(n){return arguments.length?(p=n*n,a):Math.sqrt(p)},a.gravity=function(n){return arguments.length?(v=+n,a):v},a.theta=function(n){return arguments.length?(d=n*n,a):Math.sqrt(d)},a.alpha=function(n){return arguments.length?(n=+n,r?r=n>0?n:0:n>0&&(c.start({type:"start",alpha:r=n}),Wo.timer(a.tick)),a):r},a.start=function(){function n(n,r){if(!e){for(e=new Array(c),a=0;c>a;++a)e[a]=[];for(a=0;s>a;++a){var u=y[a];e[u.source.index].push(u.target),e[u.target.index].push(u.source)}}for(var i,o=e[t],a=-1,s=o.length;++a<s;)if(!isNaN(i=o[a][n]))return i;return Math.random()*r}var t,e,r,c=m.length,l=y.length,p=s[0],v=s[1];for(t=0;c>t;++t)(r=m[t]).index=t,r.weight=0;for(t=0;l>t;++t)r=y[t],"number"==typeof r.source&&(r.source=m[r.source]),"number"==typeof r.target&&(r.target=m[r.target]),++r.source.weight,++r.target.weight;for(t=0;c>t;++t)r=m[t],isNaN(r.x)&&(r.x=n("x",p)),isNaN(r.y)&&(r.y=n("y",v)),isNaN(r.px)&&(r.px=r.x),isNaN(r.py)&&(r.py=r.y);if(u=[],"function"==typeof f)for(t=0;l>t;++t)u[t]=+f.call(this,y[t],t);else for(t=0;l>t;++t)u[t]=f;if(i=[],"function"==typeof h)for(t=0;l>t;++t)i[t]=+h.call(this,y[t],t);else for(t=0;l>t;++t)i[t]=h;if(o=[],"function"==typeof g)for(t=0;c>t;++t)o[t]=+g.call(this,m[t],t);else for(t=0;c>t;++t)o[t]=g;return a.resume()},a.resume=function(){return a.alpha(.1)},a.stop=function(){return a.alpha(0)},a.drag=function(){return e||(e=Wo.behavior.drag().origin(At).on("dragstart.force",Vu).on("drag.force",t).on("dragend.force",$u)),arguments.length?(this.on("mouseover.force",Xu).on("mouseout.force",Bu).call(e),void 0):e},Wo.rebind(a,c,"on")};var ss=20,ls=1,fs=1/0;Wo.layout.hierarchy=function(){function n(t,o,a){var c=u.call(e,t,o);if(t.depth=o,a.push(t),c&&(s=c.length)){for(var s,l,f=-1,h=t.children=new Array(s),g=0,p=o+1;++f<s;)l=h[f]=n(c[f],p,a),l.parent=t,g+=l.value;r&&h.sort(r),i&&(t.value=g)}else delete t.children,i&&(t.value=+i.call(e,t,o)||0);return t}function t(n,r){var u=n.children,o=0;if(u&&(a=u.length))for(var a,c=-1,s=r+1;++c<a;)o+=t(u[c],s);else i&&(o=+i.call(e,n,r)||0);return i&&(n.value=o),o}function e(t){var e=[];return n(t,0,e),e}var r=Qu,u=Wu,i=Ku;return e.sort=function(n){return arguments.length?(r=n,e):r},e.children=function(n){return arguments.length?(u=n,e):u},e.value=function(n){return arguments.length?(i=n,e):i},e.revalue=function(n){return t(n,0),n},e},Wo.layout.partition=function(){function n(t,e,r,u){var i=t.children;if(t.x=e,t.y=t.depth*u,t.dx=r,t.dy=u,i&&(o=i.length)){var o,a,c,s=-1;for(r=t.value?r/t.value:0;++s<o;)n(a=i[s],e,c=a.value*r,u),e+=c}}function t(n){var e=n.children,r=0;if(e&&(u=e.length))for(var u,i=-1;++i<u;)r=Math.max(r,t(e[i]));return 1+r}function e(e,i){var o=r.call(this,e,i);return n(o[0],0,u[0],u[1]/t(o[0])),o}var r=Wo.layout.hierarchy(),u=[1,1];return e.size=function(n){return arguments.length?(u=n,e):u},Ju(e,r)},Wo.layout.pie=function(){function n(i){var o=i.map(function(e,r){return+t.call(n,e,r)}),a=+("function"==typeof r?r.apply(this,arguments):r),c=(("function"==typeof u?u.apply(this,arguments):u)-a)/Wo.sum(o),s=Wo.range(i.length);null!=e&&s.sort(e===hs?function(n,t){return o[t]-o[n]}:function(n,t){return e(i[n],i[t])});var l=[];return s.forEach(function(n){var t;l[n]={data:i[n],value:t=o[n],startAngle:a,endAngle:a+=t*c}}),l}var t=Number,e=hs,r=0,u=Na;return n.value=function(e){return arguments.length?(t=e,n):t},n.sort=function(t){return arguments.length?(e=t,n):e},n.startAngle=function(t){return arguments.length?(r=t,n):r},n.endAngle=function(t){return arguments.length?(u=t,n):u},n};var hs={};Wo.layout.stack=function(){function n(a,c){var s=a.map(function(e,r){return t.call(n,e,r)}),l=s.map(function(t){return t.map(function(t,e){return[i.call(n,t,e),o.call(n,t,e)]})}),f=e.call(n,l,c);s=Wo.permute(s,f),l=Wo.permute(l,f);var h,g,p,v=r.call(n,l,c),d=s.length,m=s[0].length;for(g=0;m>g;++g)for(u.call(n,s[0][g],p=v[g],l[0][g][1]),h=1;d>h;++h)u.call(n,s[h][g],p+=l[h-1][g][1],l[h][g][1]);return a}var t=At,e=ui,r=ii,u=ri,i=ti,o=ei;return n.values=function(e){return arguments.length?(t=e,n):t},n.order=function(t){return arguments.length?(e="function"==typeof t?t:gs.get(t)||ui,n):e},n.offset=function(t){return arguments.length?(r="function"==typeof t?t:ps.get(t)||ii,n):r},n.x=function(t){return arguments.length?(i=t,n):i},n.y=function(t){return arguments.length?(o=t,n):o},n.out=function(t){return arguments.length?(u=t,n):u},n};var gs=Wo.map({"inside-out":function(n){var t,e,r=n.length,u=n.map(oi),i=n.map(ai),o=Wo.range(r).sort(function(n,t){return u[n]-u[t]}),a=0,c=0,s=[],l=[];for(t=0;r>t;++t)e=o[t],c>a?(a+=i[e],s.push(e)):(c+=i[e],l.push(e));return l.reverse().concat(s)},reverse:function(n){return Wo.range(n.length).reverse()},"default":ui}),ps=Wo.map({silhouette:function(n){var t,e,r,u=n.length,i=n[0].length,o=[],a=0,c=[];for(e=0;i>e;++e){for(t=0,r=0;u>t;t++)r+=n[t][e][1];r>a&&(a=r),o.push(r)}for(e=0;i>e;++e)c[e]=(a-o[e])/2;return c},wiggle:function(n){var t,e,r,u,i,o,a,c,s,l=n.length,f=n[0],h=f.length,g=[];for(g[0]=c=s=0,e=1;h>e;++e){for(t=0,u=0;l>t;++t)u+=n[t][e][1];for(t=0,i=0,a=f[e][0]-f[e-1][0];l>t;++t){for(r=0,o=(n[t][e][1]-n[t][e-1][1])/(2*a);t>r;++r)o+=(n[r][e][1]-n[r][e-1][1])/a;i+=o*n[t][e][1]}g[e]=c-=u?i/u*a:0,s>c&&(s=c)}for(e=0;h>e;++e)g[e]-=s;return g},expand:function(n){var t,e,r,u=n.length,i=n[0].length,o=1/u,a=[];for(e=0;i>e;++e){for(t=0,r=0;u>t;t++)r+=n[t][e][1];if(r)for(t=0;u>t;t++)n[t][e][1]/=r;else for(t=0;u>t;t++)n[t][e][1]=o}for(e=0;i>e;++e)a[e]=0;return a},zero:ii});Wo.layout.histogram=function(){function n(n,i){for(var o,a,c=[],s=n.map(e,this),l=r.call(this,s,i),f=u.call(this,l,s,i),i=-1,h=s.length,g=f.length-1,p=t?1:1/h;++i<g;)o=c[i]=[],o.dx=f[i+1]-(o.x=f[i]),o.y=0;if(g>0)for(i=-1;++i<h;)a=s[i],a>=l[0]&&a<=l[1]&&(o=c[Wo.bisect(f,a,1,g)-1],o.y+=p,o.push(n[i]));return c}var t=!0,e=Number,r=fi,u=si;return n.value=function(t){return arguments.length?(e=t,n):e},n.range=function(t){return arguments.length?(r=Et(t),n):r},n.bins=function(t){return arguments.length?(u="number"==typeof t?function(n){return li(n,t)}:Et(t),n):u},n.frequency=function(e){return arguments.length?(t=!!e,n):t},n},Wo.layout.tree=function(){function n(n,i){function o(n,t){var r=n.children,u=n._tree;if(r&&(i=r.length)){for(var i,a,s,l=r[0],f=l,h=-1;++h<i;)s=r[h],o(s,a),f=c(s,a,f),a=s;Mi(n);var g=.5*(l._tree.prelim+s._tree.prelim);t?(u.prelim=t._tree.prelim+e(n,t),u.mod=u.prelim-g):u.prelim=g}else t&&(u.prelim=t._tree.prelim+e(n,t))}function a(n,t){n.x=n._tree.prelim+t;var e=n.children;if(e&&(r=e.length)){var r,u=-1;for(t+=n._tree.mod;++u<r;)a(e[u],t)}}function c(n,t,r){if(t){for(var u,i=n,o=n,a=t,c=n.parent.children[0],s=i._tree.mod,l=o._tree.mod,f=a._tree.mod,h=c._tree.mod;a=pi(a),i=gi(i),a&&i;)c=gi(c),o=pi(o),o._tree.ancestor=n,u=a._tree.prelim+f-i._tree.prelim-s+e(a,i),u>0&&(_i(bi(a,n,r),n,u),s+=u,l+=u),f+=a._tree.mod,s+=i._tree.mod,h+=c._tree.mod,l+=o._tree.mod;a&&!pi(o)&&(o._tree.thread=a,o._tree.mod+=f-l),i&&!gi(c)&&(c._tree.thread=i,c._tree.mod+=s-h,r=n)}return r}var s=t.call(this,n,i),l=s[0];xi(l,function(n,t){n._tree={ancestor:n,prelim:0,mod:0,change:0,shift:0,number:t?t._tree.number+1:0}}),o(l),a(l,-l._tree.prelim);var f=vi(l,mi),h=vi(l,di),g=vi(l,yi),p=f.x-e(f,h)/2,v=h.x+e(h,f)/2,d=g.depth||1;return xi(l,u?function(n){n.x*=r[0],n.y=n.depth*r[1],delete n._tree}:function(n){n.x=(n.x-p)/(v-p)*r[0],n.y=n.depth/d*r[1],delete n._tree}),s}var t=Wo.layout.hierarchy().sort(null).value(null),e=hi,r=[1,1],u=!1;return n.separation=function(t){return arguments.length?(e=t,n):e},n.size=function(t){return arguments.length?(u=null==(r=t),n):u?null:r},n.nodeSize=function(t){return arguments.length?(u=null!=(r=t),n):u?r:null},Ju(n,t)},Wo.layout.pack=function(){function n(n,i){var o=e.call(this,n,i),a=o[0],c=u[0],s=u[1],l=null==t?Math.sqrt:"function"==typeof t?t:function(){return t};if(a.x=a.y=0,xi(a,function(n){n.r=+l(n.value)}),xi(a,Ai),r){var f=r*(t?1:Math.max(2*a.r/c,2*a.r/s))/2;xi(a,function(n){n.r+=f}),xi(a,Ai),xi(a,function(n){n.r-=f})}return Ti(a,c/2,s/2,t?1:1/Math.max(2*a.r/c,2*a.r/s)),o}var t,e=Wo.layout.hierarchy().sort(wi),r=0,u=[1,1];return n.size=function(t){return arguments.length?(u=t,n):u},n.radius=function(e){return arguments.length?(t=null==e||"function"==typeof e?e:+e,n):t},n.padding=function(t){return arguments.length?(r=+t,n):r},Ju(n,e)},Wo.layout.cluster=function(){function n(n,i){var o,a=t.call(this,n,i),c=a[0],s=0;xi(c,function(n){var t=n.children;t&&t.length?(n.x=zi(t),n.y=qi(t)):(n.x=o?s+=e(n,o):0,n.y=0,o=n)});var l=Ri(c),f=Di(c),h=l.x-e(l,f)/2,g=f.x+e(f,l)/2;return xi(c,u?function(n){n.x=(n.x-c.x)*r[0],n.y=(c.y-n.y)*r[1]}:function(n){n.x=(n.x-h)/(g-h)*r[0],n.y=(1-(c.y?n.y/c.y:1))*r[1]}),a}var t=Wo.layout.hierarchy().sort(null).value(null),e=hi,r=[1,1],u=!1;return n.separation=function(t){return arguments.length?(e=t,n):e},n.size=function(t){return arguments.length?(u=null==(r=t),n):u?null:r},n.nodeSize=function(t){return arguments.length?(u=null!=(r=t),n):u?r:null},Ju(n,t)},Wo.layout.treemap=function(){function n(n,t){for(var e,r,u=-1,i=n.length;++u<i;)r=(e=n[u]).value*(0>t?0:t),e.area=isNaN(r)||0>=r?0:r}function t(e){var i=e.children;if(i&&i.length){var o,a,c,s=f(e),l=[],h=i.slice(),p=1/0,v="slice"===g?s.dx:"dice"===g?s.dy:"slice-dice"===g?1&e.depth?s.dy:s.dx:Math.min(s.dx,s.dy);for(n(h,s.dx*s.dy/e.value),l.area=0;(c=h.length)>0;)l.push(o=h[c-1]),l.area+=o.area,"squarify"!==g||(a=r(l,v))<=p?(h.pop(),p=a):(l.area-=l.pop().area,u(l,v,s,!1),v=Math.min(s.dx,s.dy),l.length=l.area=0,p=1/0);l.length&&(u(l,v,s,!0),l.length=l.area=0),i.forEach(t)}}function e(t){var r=t.children;if(r&&r.length){var i,o=f(t),a=r.slice(),c=[];for(n(a,o.dx*o.dy/t.value),c.area=0;i=a.pop();)c.push(i),c.area+=i.area,null!=i.z&&(u(c,i.z?o.dx:o.dy,o,!a.length),c.length=c.area=0);r.forEach(e)}}function r(n,t){for(var e,r=n.area,u=0,i=1/0,o=-1,a=n.length;++o<a;)(e=n[o].area)&&(i>e&&(i=e),e>u&&(u=e));return r*=r,t*=t,r?Math.max(t*u*p/r,r/(t*i*p)):1/0}function u(n,t,e,r){var u,i=-1,o=n.length,a=e.x,s=e.y,l=t?c(n.area/t):0;if(t==e.dx){for((r||l>e.dy)&&(l=e.dy);++i<o;)u=n[i],u.x=a,u.y=s,u.dy=l,a+=u.dx=Math.min(e.x+e.dx-a,l?c(u.area/l):0);u.z=!0,u.dx+=e.x+e.dx-a,e.y+=l,e.dy-=l}else{for((r||l>e.dx)&&(l=e.dx);++i<o;)u=n[i],u.x=a,u.y=s,u.dx=l,s+=u.dy=Math.min(e.y+e.dy-s,l?c(u.area/l):0);u.z=!1,u.dy+=e.y+e.dy-s,e.x+=l,e.dx-=l}}function i(r){var u=o||a(r),i=u[0];return i.x=0,i.y=0,i.dx=s[0],i.dy=s[1],o&&a.revalue(i),n([i],i.dx*i.dy/i.value),(o?e:t)(i),h&&(o=u),u}var o,a=Wo.layout.hierarchy(),c=Math.round,s=[1,1],l=null,f=Pi,h=!1,g="squarify",p=.5*(1+Math.sqrt(5));return i.size=function(n){return arguments.length?(s=n,i):s},i.padding=function(n){function t(t){var e=n.call(i,t,t.depth);return null==e?Pi(t):ji(t,"number"==typeof e?[e,e,e,e]:e)}function e(t){return ji(t,n)}if(!arguments.length)return l;var r;return f=null==(l=n)?Pi:"function"==(r=typeof n)?t:"number"===r?(n=[n,n,n,n],e):e,i},i.round=function(n){return arguments.length?(c=n?Math.round:Number,i):c!=Number},i.sticky=function(n){return arguments.length?(h=n,o=null,i):h},i.ratio=function(n){return arguments.length?(p=n,i):p},i.mode=function(n){return arguments.length?(g=n+"",i):g},Ju(i,a)},Wo.random={normal:function(n,t){var e=arguments.length;return 2>e&&(t=1),1>e&&(n=0),function(){var e,r,u;do e=2*Math.random()-1,r=2*Math.random()-1,u=e*e+r*r;while(!u||u>1);return n+t*e*Math.sqrt(-2*Math.log(u)/u)}},logNormal:function(){var n=Wo.random.normal.apply(Wo,arguments);return function(){return Math.exp(n())}},bates:function(n){var t=Wo.random.irwinHall(n);return function(){return t()/n}},irwinHall:function(n){return function(){for(var t=0,e=0;n>e;e++)t+=Math.random();return t}}},Wo.scale={};var vs={floor:At,ceil:At};Wo.scale.linear=function(){return Zi([0,1],[0,1],du,!1)};var ds={s:1,g:1,p:1,r:1,e:1};Wo.scale.log=function(){return Ki(Wo.scale.linear().domain([0,1]),10,!0,[1,10])};var ms=Wo.format(".0e"),ys={floor:function(n){return-Math.ceil(-n)},ceil:function(n){return-Math.floor(-n)}};Wo.scale.pow=function(){return Qi(Wo.scale.linear(),1,[0,1])},Wo.scale.sqrt=function(){return Wo.scale.pow().exponent(.5)},Wo.scale.ordinal=function(){return to([],{t:"range",a:[[]]})},Wo.scale.category10=function(){return Wo.scale.ordinal().range(xs)},Wo.scale.category20=function(){return Wo.scale.ordinal().range(Ms)},Wo.scale.category20b=function(){return Wo.scale.ordinal().range(_s)},Wo.scale.category20c=function(){return Wo.scale.ordinal().range(bs)};var xs=[2062260,16744206,2924588,14034728,9725885,9197131,14907330,8355711,12369186,1556175].map(mt),Ms=[2062260,11454440,16744206,16759672,2924588,10018698,14034728,16750742,9725885,12955861,9197131,12885140,14907330,16234194,8355711,13092807,12369186,14408589,1556175,10410725].map(mt),_s=[3750777,5395619,7040719,10264286,6519097,9216594,11915115,13556636,9202993,12426809,15186514,15190932,8666169,11356490,14049643,15177372,8077683,10834324,13528509,14589654].map(mt),bs=[3244733,7057110,10406625,13032431,15095053,16616764,16625259,16634018,3253076,7652470,10607003,13101504,7695281,10394312,12369372,14342891,6513507,9868950,12434877,14277081].map(mt);Wo.scale.quantile=function(){return eo([],[])},Wo.scale.quantize=function(){return ro(0,1,[0,1])},Wo.scale.threshold=function(){return uo([.5],[0,1])},Wo.scale.identity=function(){return io([0,1])},Wo.svg={},Wo.svg.arc=function(){function n(){var n=t.apply(this,arguments),i=e.apply(this,arguments),o=r.apply(this,arguments)+ws,a=u.apply(this,arguments)+ws,c=(o>a&&(c=o,o=a,a=c),a-o),s=Ca>c?"0":"1",l=Math.cos(o),f=Math.sin(o),h=Math.cos(a),g=Math.sin(a);
return c>=Ss?n?"M0,"+i+"A"+i+","+i+" 0 1,1 0,"+-i+"A"+i+","+i+" 0 1,1 0,"+i+"M0,"+n+"A"+n+","+n+" 0 1,0 0,"+-n+"A"+n+","+n+" 0 1,0 0,"+n+"Z":"M0,"+i+"A"+i+","+i+" 0 1,1 0,"+-i+"A"+i+","+i+" 0 1,1 0,"+i+"Z":n?"M"+i*l+","+i*f+"A"+i+","+i+" 0 "+s+",1 "+i*h+","+i*g+"L"+n*h+","+n*g+"A"+n+","+n+" 0 "+s+",0 "+n*l+","+n*f+"Z":"M"+i*l+","+i*f+"A"+i+","+i+" 0 "+s+",1 "+i*h+","+i*g+"L0,0"+"Z"}var t=oo,e=ao,r=co,u=so;return n.innerRadius=function(e){return arguments.length?(t=Et(e),n):t},n.outerRadius=function(t){return arguments.length?(e=Et(t),n):e},n.startAngle=function(t){return arguments.length?(r=Et(t),n):r},n.endAngle=function(t){return arguments.length?(u=Et(t),n):u},n.centroid=function(){var n=(t.apply(this,arguments)+e.apply(this,arguments))/2,i=(r.apply(this,arguments)+u.apply(this,arguments))/2+ws;return[Math.cos(i)*n,Math.sin(i)*n]},n};var ws=-Ta,Ss=Na-La;Wo.svg.line=function(){return lo(At)};var ks=Wo.map({linear:fo,"linear-closed":ho,step:go,"step-before":po,"step-after":vo,basis:bo,"basis-open":wo,"basis-closed":So,bundle:ko,cardinal:xo,"cardinal-open":mo,"cardinal-closed":yo,monotone:Lo});ks.forEach(function(n,t){t.key=n,t.closed=/-closed$/.test(n)});var Es=[0,2/3,1/3,0],As=[0,1/3,2/3,0],Cs=[0,1/6,2/3,1/6];Wo.svg.line.radial=function(){var n=lo(qo);return n.radius=n.x,delete n.x,n.angle=n.y,delete n.y,n},po.reverse=vo,vo.reverse=po,Wo.svg.area=function(){return zo(At)},Wo.svg.area.radial=function(){var n=zo(qo);return n.radius=n.x,delete n.x,n.innerRadius=n.x0,delete n.x0,n.outerRadius=n.x1,delete n.x1,n.angle=n.y,delete n.y,n.startAngle=n.y0,delete n.y0,n.endAngle=n.y1,delete n.y1,n},Wo.svg.chord=function(){function n(n,a){var c=t(this,i,n,a),s=t(this,o,n,a);return"M"+c.p0+r(c.r,c.p1,c.a1-c.a0)+(e(c,s)?u(c.r,c.p1,c.r,c.p0):u(c.r,c.p1,s.r,s.p0)+r(s.r,s.p1,s.a1-s.a0)+u(s.r,s.p1,c.r,c.p0))+"Z"}function t(n,t,e,r){var u=t.call(n,e,r),i=a.call(n,u,r),o=c.call(n,u,r)+ws,l=s.call(n,u,r)+ws;return{r:i,a0:o,a1:l,p0:[i*Math.cos(o),i*Math.sin(o)],p1:[i*Math.cos(l),i*Math.sin(l)]}}function e(n,t){return n.a0==t.a0&&n.a1==t.a1}function r(n,t,e){return"A"+n+","+n+" 0 "+ +(e>Ca)+",1 "+t}function u(n,t,e,r){return"Q 0,0 "+r}var i=mr,o=yr,a=Ro,c=co,s=so;return n.radius=function(t){return arguments.length?(a=Et(t),n):a},n.source=function(t){return arguments.length?(i=Et(t),n):i},n.target=function(t){return arguments.length?(o=Et(t),n):o},n.startAngle=function(t){return arguments.length?(c=Et(t),n):c},n.endAngle=function(t){return arguments.length?(s=Et(t),n):s},n},Wo.svg.diagonal=function(){function n(n,u){var i=t.call(this,n,u),o=e.call(this,n,u),a=(i.y+o.y)/2,c=[i,{x:i.x,y:a},{x:o.x,y:a},o];return c=c.map(r),"M"+c[0]+"C"+c[1]+" "+c[2]+" "+c[3]}var t=mr,e=yr,r=Do;return n.source=function(e){return arguments.length?(t=Et(e),n):t},n.target=function(t){return arguments.length?(e=Et(t),n):e},n.projection=function(t){return arguments.length?(r=t,n):r},n},Wo.svg.diagonal.radial=function(){var n=Wo.svg.diagonal(),t=Do,e=n.projection;return n.projection=function(n){return arguments.length?e(Po(t=n)):t},n},Wo.svg.symbol=function(){function n(n,r){return(Ns.get(t.call(this,n,r))||Ho)(e.call(this,n,r))}var t=Uo,e=jo;return n.type=function(e){return arguments.length?(t=Et(e),n):t},n.size=function(t){return arguments.length?(e=Et(t),n):e},n};var Ns=Wo.map({circle:Ho,cross:function(n){var t=Math.sqrt(n/5)/2;return"M"+-3*t+","+-t+"H"+-t+"V"+-3*t+"H"+t+"V"+-t+"H"+3*t+"V"+t+"H"+t+"V"+3*t+"H"+-t+"V"+t+"H"+-3*t+"Z"},diamond:function(n){var t=Math.sqrt(n/(2*zs)),e=t*zs;return"M0,"+-t+"L"+e+",0"+" 0,"+t+" "+-e+",0"+"Z"},square:function(n){var t=Math.sqrt(n)/2;return"M"+-t+","+-t+"L"+t+","+-t+" "+t+","+t+" "+-t+","+t+"Z"},"triangle-down":function(n){var t=Math.sqrt(n/qs),e=t*qs/2;return"M0,"+e+"L"+t+","+-e+" "+-t+","+-e+"Z"},"triangle-up":function(n){var t=Math.sqrt(n/qs),e=t*qs/2;return"M0,"+-e+"L"+t+","+e+" "+-t+","+e+"Z"}});Wo.svg.symbolTypes=Ns.keys();var Ts,Ls,qs=Math.sqrt(3),zs=Math.tan(30*za),Rs=[],Ds=0;Rs.call=_a.call,Rs.empty=_a.empty,Rs.node=_a.node,Rs.size=_a.size,Wo.transition=function(n){return arguments.length?Ts?n.transition():n:Sa.transition()},Wo.transition.prototype=Rs,Rs.select=function(n){var t,e,r,u=this.id,i=[];n=b(n);for(var o=-1,a=this.length;++o<a;){i.push(t=[]);for(var c=this[o],s=-1,l=c.length;++s<l;)(r=c[s])&&(e=n.call(r,r.__data__,s,o))?("__data__"in r&&(e.__data__=r.__data__),Yo(e,s,u,r.__transition__[u]),t.push(e)):t.push(null)}return Oo(i,u)},Rs.selectAll=function(n){var t,e,r,u,i,o=this.id,a=[];n=w(n);for(var c=-1,s=this.length;++c<s;)for(var l=this[c],f=-1,h=l.length;++f<h;)if(r=l[f]){i=r.__transition__[o],e=n.call(r,r.__data__,f,c),a.push(t=[]);for(var g=-1,p=e.length;++g<p;)(u=e[g])&&Yo(u,g,o,i),t.push(u)}return Oo(a,o)},Rs.filter=function(n){var t,e,r,u=[];"function"!=typeof n&&(n=R(n));for(var i=0,o=this.length;o>i;i++){u.push(t=[]);for(var e=this[i],a=0,c=e.length;c>a;a++)(r=e[a])&&n.call(r,r.__data__,a,i)&&t.push(r)}return Oo(u,this.id)},Rs.tween=function(n,t){var e=this.id;return arguments.length<2?this.node().__transition__[e].tween.get(n):P(this,null==t?function(t){t.__transition__[e].tween.remove(n)}:function(r){r.__transition__[e].tween.set(n,t)})},Rs.attr=function(n,t){function e(){this.removeAttribute(a)}function r(){this.removeAttributeNS(a.space,a.local)}function u(n){return null==n?e:(n+="",function(){var t,e=this.getAttribute(a);return e!==n&&(t=o(e,n),function(n){this.setAttribute(a,t(n))})})}function i(n){return null==n?r:(n+="",function(){var t,e=this.getAttributeNS(a.space,a.local);return e!==n&&(t=o(e,n),function(n){this.setAttributeNS(a.space,a.local,t(n))})})}if(arguments.length<2){for(t in n)this.attr(t,n[t]);return this}var o="transform"==n?Hu:du,a=Wo.ns.qualify(n);return Fo(this,"attr."+n,t,a.local?i:u)},Rs.attrTween=function(n,t){function e(n,e){var r=t.call(this,n,e,this.getAttribute(u));return r&&function(n){this.setAttribute(u,r(n))}}function r(n,e){var r=t.call(this,n,e,this.getAttributeNS(u.space,u.local));return r&&function(n){this.setAttributeNS(u.space,u.local,r(n))}}var u=Wo.ns.qualify(n);return this.tween("attr."+n,u.local?r:e)},Rs.style=function(n,t,e){function r(){this.style.removeProperty(n)}function u(t){return null==t?r:(t+="",function(){var r,u=ea.getComputedStyle(this,null).getPropertyValue(n);return u!==t&&(r=du(u,t),function(t){this.style.setProperty(n,r(t),e)})})}var i=arguments.length;if(3>i){if("string"!=typeof n){2>i&&(t="");for(e in n)this.style(e,n[e],t);return this}e=""}return Fo(this,"style."+n,t,u)},Rs.styleTween=function(n,t,e){function r(r,u){var i=t.call(this,r,u,ea.getComputedStyle(this,null).getPropertyValue(n));return i&&function(t){TP.elementGetStyleObj(this).setProperty(n,i(t),e)}}return arguments.length<3&&(e=""),this.tween("style."+n,r)},Rs.text=function(n){return Fo(this,"text",n,Io)},Rs.remove=function(){return this.each("end.transition",function(){var n;this.__transition__.count<2&&(n=this.parentNode)&&n.removeChild(this)})},Rs.ease=function(n){var t=this.id;return arguments.length<1?this.node().__transition__[t].ease:("function"!=typeof n&&(n=Wo.ease.apply(Wo,arguments)),P(this,function(e){e.__transition__[t].ease=n}))},Rs.delay=function(n){var t=this.id;return arguments.length<1?this.node().__transition__[t].delay:P(this,"function"==typeof n?function(e,r,u){e.__transition__[t].delay=+n.call(e,e.__data__,r,u)}:(n=+n,function(e){e.__transition__[t].delay=n}))},Rs.duration=function(n){var t=this.id;return arguments.length<1?this.node().__transition__[t].duration:P(this,"function"==typeof n?function(e,r,u){e.__transition__[t].duration=Math.max(1,n.call(e,e.__data__,r,u))}:(n=Math.max(1,n),function(e){e.__transition__[t].duration=n}))},Rs.each=function(n,t){var e=this.id;if(arguments.length<2){var r=Ls,u=Ts;Ts=e,P(this,function(t,r,u){Ls=t.__transition__[e],n.call(t,t.__data__,r,u)}),Ls=r,Ts=u}else P(this,function(r){var u=r.__transition__[e];(u.event||(u.event=Wo.dispatch("start","end"))).on(n,t)});return this},Rs.transition=function(){for(var n,t,e,r,u=this.id,i=++Ds,o=[],a=0,c=this.length;c>a;a++){o.push(n=[]);for(var t=this[a],s=0,l=t.length;l>s;s++)(e=t[s])&&(r=Object.create(e.__transition__[u]),r.delay+=r.duration,Yo(e,s,i,r)),n.push(e)}return Oo(o,i)},Wo.svg.axis=function(){function n(n){n.each(function(){var n,s=Wo.select(this),l=this.__chart__||e,f=this.__chart__=e.copy(),h=null==c?f.ticks?f.ticks.apply(f,a):f.domain():c,g=null==t?f.tickFormat?f.tickFormat.apply(f,a):At:t,p=s.selectAll(".tick").data(h,f),v=p.enter().insert("g",".domain").attr("class","tick").style("opacity",La),d=Wo.transition(p.exit()).style("opacity",La).remove(),m=Wo.transition(p.order()).style("opacity",1),y=Hi(f),x=s.selectAll(".domain").data([0]),M=(x.enter().append("path").attr("class","domain"),Wo.transition(x));v.append("line"),v.append("text");var _=v.select("line"),b=m.select("line"),w=p.select("text").text(g),S=v.select("text"),k=m.select("text");switch(r){case"bottom":n=Zo,_.attr("y2",u),S.attr("y",Math.max(u,0)+o),b.attr("x2",0).attr("y2",u),k.attr("x",0).attr("y",Math.max(u,0)+o),w.attr("dy",".71em").style("text-anchor","middle"),M.attr("d","M"+y[0]+","+i+"V0H"+y[1]+"V"+i);break;case"top":n=Zo,_.attr("y2",-u),S.attr("y",-(Math.max(u,0)+o)),b.attr("x2",0).attr("y2",-u),k.attr("x",0).attr("y",-(Math.max(u,0)+o)),w.attr("dy","0em").style("text-anchor","middle"),M.attr("d","M"+y[0]+","+-i+"V0H"+y[1]+"V"+-i);break;case"left":n=Vo,_.attr("x2",-u),S.attr("x",-(Math.max(u,0)+o)),b.attr("x2",-u).attr("y2",0),k.attr("x",-(Math.max(u,0)+o)).attr("y",0),w.attr("dy",".32em").style("text-anchor","end"),M.attr("d","M"+-i+","+y[0]+"H0V"+y[1]+"H"+-i);break;case"right":n=Vo,_.attr("x2",u),S.attr("x",Math.max(u,0)+o),b.attr("x2",u).attr("y2",0),k.attr("x",Math.max(u,0)+o).attr("y",0),w.attr("dy",".32em").style("text-anchor","start"),M.attr("d","M"+i+","+y[0]+"H0V"+y[1]+"H"+i)}if(f.rangeBand){var E=f,A=E.rangeBand()/2;l=f=function(n){return E(n)+A}}else l.rangeBand?l=f:d.call(n,f);v.call(n,l),m.call(n,f)})}var t,e=Wo.scale.linear(),r=Ps,u=6,i=6,o=3,a=[10],c=null;return n.scale=function(t){return arguments.length?(e=t,n):e},n.orient=function(t){return arguments.length?(r=t in js?t+"":Ps,n):r},n.ticks=function(){return arguments.length?(a=arguments,n):a},n.tickValues=function(t){return arguments.length?(c=t,n):c},n.tickFormat=function(e){return arguments.length?(t=e,n):t},n.tickSize=function(t){var e=arguments.length;return e?(u=+t,i=+arguments[e-1],n):u},n.innerTickSize=function(t){return arguments.length?(u=+t,n):u},n.outerTickSize=function(t){return arguments.length?(i=+t,n):i},n.tickPadding=function(t){return arguments.length?(o=+t,n):o},n.tickSubdivide=function(){return arguments.length&&n},n};var Ps="bottom",js={top:1,right:1,bottom:1,left:1};Wo.svg.brush=function(){function n(i){i.each(function(){var i=Wo.select(this).style("pointer-events","all").style("-webkit-tap-highlight-color","rgba(0,0,0,0)").on("mousedown.brush",u).on("touchstart.brush",u),o=i.selectAll(".background").data([0]);o.enter().append("rect").attr("class","background").style("visibility","hidden").style("cursor","crosshair"),i.selectAll(".extent").data([0]).enter().append("rect").attr("class","extent").style("cursor","move");var a=i.selectAll(".resize").data(p,At);a.exit().remove(),a.enter().append("g").attr("class",function(n){return"resize "+n}).style("cursor",function(n){return Us[n]}).append("rect").attr("x",function(n){return/[ew]$/.test(n)?-3:null}).attr("y",function(n){return/^[ns]/.test(n)?-3:null}).attr("width",6).attr("height",6).style("visibility","hidden"),a.style("display",n.empty()?"none":null);var l,f=Wo.transition(i),h=Wo.transition(o);c&&(l=Hi(c),h.attr("x",l[0]).attr("width",l[1]-l[0]),e(f)),s&&(l=Hi(s),h.attr("y",l[0]).attr("height",l[1]-l[0]),r(f)),t(f)})}function t(n){n.selectAll(".resize").attr("transform",function(n){return"translate("+l[+/e$/.test(n)]+","+f[+/^s/.test(n)]+")"})}function e(n){n.select(".extent").attr("x",l[0]),n.selectAll(".extent,.n>rect,.s>rect").attr("width",l[1]-l[0])}function r(n){n.select(".extent").attr("y",f[0]),n.selectAll(".extent,.e>rect,.w>rect").attr("height",f[1]-f[0])}function u(){function u(){32==Wo.event.keyCode&&(C||(x=null,T[0]-=l[1],T[1]-=f[1],C=2),y())}function p(){32==Wo.event.keyCode&&2==C&&(T[0]+=l[1],T[1]+=f[1],C=0,y())}function v(){var n=Wo.mouse(_),u=!1;M&&(n[0]+=M[0],n[1]+=M[1]),C||(Wo.event.altKey?(x||(x=[(l[0]+l[1])/2,(f[0]+f[1])/2]),T[0]=l[+(n[0]<x[0])],T[1]=f[+(n[1]<x[1])]):x=null),E&&d(n,c,0)&&(e(S),u=!0),A&&d(n,s,1)&&(r(S),u=!0),u&&(t(S),w({type:"brush",mode:C?"move":"resize"}))}function d(n,t,e){var r,u,a=Hi(t),c=a[0],s=a[1],p=T[e],v=e?f:l,d=v[1]-v[0];return C&&(c-=p,s-=d+p),r=(e?g:h)?Math.max(c,Math.min(s,n[e])):n[e],C?u=(r+=p)+d:(x&&(p=Math.max(c,Math.min(s,2*x[e]-r))),r>p?(u=r,r=p):u=p),v[0]!=r||v[1]!=u?(e?o=null:i=null,v[0]=r,v[1]=u,!0):void 0}function m(){v(),S.style("pointer-events","all").selectAll(".resize").style("display",n.empty()?"none":null),Wo.select("body").style("cursor",null),L.on("mousemove.brush",null).on("mouseup.brush",null).on("touchmove.brush",null).on("touchend.brush",null).on("keydown.brush",null).on("keyup.brush",null),N(),w({type:"brushend"})}var x,M,_=this,b=Wo.select(Wo.event.target),w=a.of(_,arguments),S=Wo.select(_),k=b.datum(),E=!/^(n|s)$/.test(k)&&c,A=!/^(e|w)$/.test(k)&&s,C=b.classed("extent"),N=Y(),T=Wo.mouse(_),L=Wo.select(ea).on("keydown.brush",u).on("keyup.brush",p);if(Wo.event.changedTouches?L.on("touchmove.brush",v).on("touchend.brush",m):L.on("mousemove.brush",v).on("mouseup.brush",m),S.interrupt().selectAll("*").interrupt(),C)T[0]=l[0]-T[0],T[1]=f[0]-T[1];else if(k){var q=+/w$/.test(k),z=+/^n/.test(k);M=[l[1-q]-T[0],f[1-z]-T[1]],T[0]=l[q],T[1]=f[z]}else Wo.event.altKey&&(x=T.slice());S.style("pointer-events","none").selectAll(".resize").style("display",null),Wo.select("body").style("cursor",b.style("cursor")),w({type:"brushstart"}),v()}var i,o,a=M(n,"brushstart","brush","brushend"),c=null,s=null,l=[0,0],f=[0,0],h=!0,g=!0,p=Hs[0];return n.event=function(n){n.each(function(){var n=a.of(this,arguments),t={x:l,y:f,i:i,j:o},e=this.__chart__||t;this.__chart__=t,Ts?Wo.select(this).transition().each("start.brush",function(){i=e.i,o=e.j,l=e.x,f=e.y,n({type:"brushstart"})}).tween("brush:brush",function(){var e=mu(l,t.x),r=mu(f,t.y);return i=o=null,function(u){l=t.x=e(u),f=t.y=r(u),n({type:"brush",mode:"resize"})}}).each("end.brush",function(){i=t.i,o=t.j,n({type:"brush",mode:"resize"}),n({type:"brushend"})}):(n({type:"brushstart"}),n({type:"brush",mode:"resize"}),n({type:"brushend"}))})},n.x=function(t){return arguments.length?(c=t,p=Hs[!c<<1|!s],n):c},n.y=function(t){return arguments.length?(s=t,p=Hs[!c<<1|!s],n):s},n.clamp=function(t){return arguments.length?(c&&s?(h=!!t[0],g=!!t[1]):c?h=!!t:s&&(g=!!t),n):c&&s?[h,g]:c?h:s?g:null},n.extent=function(t){var e,r,u,a,h;return arguments.length?(c&&(e=t[0],r=t[1],s&&(e=e[0],r=r[0]),i=[e,r],c.invert&&(e=c(e),r=c(r)),e>r&&(h=e,e=r,r=h),(e!=l[0]||r!=l[1])&&(l=[e,r])),s&&(u=t[0],a=t[1],c&&(u=u[1],a=a[1]),o=[u,a],s.invert&&(u=s(u),a=s(a)),u>a&&(h=u,u=a,a=h),(u!=f[0]||a!=f[1])&&(f=[u,a])),n):(c&&(i?(e=i[0],r=i[1]):(e=l[0],r=l[1],c.invert&&(e=c.invert(e),r=c.invert(r)),e>r&&(h=e,e=r,r=h))),s&&(o?(u=o[0],a=o[1]):(u=f[0],a=f[1],s.invert&&(u=s.invert(u),a=s.invert(a)),u>a&&(h=u,u=a,a=h))),c&&s?[[e,u],[r,a]]:c?[e,r]:s&&[u,a])},n.clear=function(){return n.empty()||(l=[0,0],f=[0,0],i=o=null),n},n.empty=function(){return!!c&&l[0]==l[1]||!!s&&f[0]==f[1]},Wo.rebind(n,a,"on")};var Us={n:"ns-resize",e:"ew-resize",s:"ns-resize",w:"ew-resize",nw:"nwse-resize",ne:"nesw-resize",se:"nwse-resize",sw:"nesw-resize"},Hs=[["n","e","s","w","nw","ne","se","sw"],["e","w"],["n","s"],[]],Os=ic.format=fc.timeFormat,Fs=Os.utc,Is=Fs("%Y-%m-%dT%H:%M:%S.%LZ");Os.iso=Date.prototype.toISOString&&+new Date("2000-01-01T00:00:00.000Z")?$o:Is,$o.parse=function(n){var t=new Date(n);return isNaN(t)?null:t},$o.toString=Is.toString,ic.second=Ht(function(n){return new oc(1e3*Math.floor(n/1e3))},function(n,t){n.setTime(n.getTime()+1e3*Math.floor(t))},function(n){return n.getSeconds()}),ic.seconds=ic.second.range,ic.seconds.utc=ic.second.utc.range,ic.minute=Ht(function(n){return new oc(6e4*Math.floor(n/6e4))},function(n,t){n.setTime(n.getTime()+6e4*Math.floor(t))},function(n){return n.getMinutes()}),ic.minutes=ic.minute.range,ic.minutes.utc=ic.minute.utc.range,ic.hour=Ht(function(n){var t=n.getTimezoneOffset()/60;return new oc(36e5*(Math.floor(n/36e5-t)+t))},function(n,t){n.setTime(n.getTime()+36e5*Math.floor(t))},function(n){return n.getHours()}),ic.hours=ic.hour.range,ic.hours.utc=ic.hour.utc.range,ic.month=Ht(function(n){return n=ic.day(n),n.setDate(1),n},function(n,t){n.setMonth(n.getMonth()+t)},function(n){return n.getMonth()}),ic.months=ic.month.range,ic.months.utc=ic.month.utc.range;var Ys=[1e3,5e3,15e3,3e4,6e4,3e5,9e5,18e5,36e5,108e5,216e5,432e5,864e5,1728e5,6048e5,2592e6,7776e6,31536e6],Zs=[[ic.second,1],[ic.second,5],[ic.second,15],[ic.second,30],[ic.minute,1],[ic.minute,5],[ic.minute,15],[ic.minute,30],[ic.hour,1],[ic.hour,3],[ic.hour,6],[ic.hour,12],[ic.day,1],[ic.day,2],[ic.week,1],[ic.month,1],[ic.month,3],[ic.year,1]],Vs=Os.multi([[".%L",function(n){return n.getMilliseconds()}],[":%S",function(n){return n.getSeconds()}],["%I:%M",function(n){return n.getMinutes()}],["%I %p",function(n){return n.getHours()}],["%a %d",function(n){return n.getDay()&&1!=n.getDate()}],["%b %d",function(n){return 1!=n.getDate()}],["%B",function(n){return n.getMonth()}],["%Y",Ae]]),$s={range:function(n,t,e){return Wo.range(Math.ceil(n/e)*e,+t,e).map(Bo)},floor:At,ceil:At};Zs.year=ic.year,ic.scale=function(){return Xo(Wo.scale.linear(),Zs,Vs)};var Xs=Zs.map(function(n){return[n[0].utc,n[1]]}),Bs=Fs.multi([[".%L",function(n){return n.getUTCMilliseconds()}],[":%S",function(n){return n.getUTCSeconds()}],["%I:%M",function(n){return n.getUTCMinutes()}],["%I %p",function(n){return n.getUTCHours()}],["%a %d",function(n){return n.getUTCDay()&&1!=n.getUTCDate()}],["%b %d",function(n){return 1!=n.getUTCDate()}],["%B",function(n){return n.getUTCMonth()}],["%Y",Ae]]);Xs.year=ic.year.utc,ic.scale.utc=function(){return Xo(Wo.scale.linear(),Xs,Bs)},Wo.text=Ct(function(n){return n.responseText}),Wo.json=function(n,t){return Nt(n,"application/json",Go,t)},Wo.html=function(n,t){return Nt(n,"text/html",Jo,t)},Wo.xml=Ct(function(n){return n.responseXML}),"function"==typeof define&&define.amd?define(Wo):"object"==typeof module&&module.exports?module.exports=Wo:this.d3=Wo}();
TP.boot.$srcPath = '';

        
        TP.extern.d3 = d3;
        
    
TP.boot.$srcPath = '~lib_src/tibet/services/rest/TPRESTRequest.js';
TP.sig.HTTPRequest.defineSubtype('RESTRequest');TP.sig.RESTRequest.Type.defineAttribute('responseType','TP.sig.RESTResponse');
TP.boot.$srcPath = '~lib_src/tibet/services/rest/TPRESTResponse.js';
TP.sig.HTTPResponse.defineSubtype('RESTResponse');
TP.boot.$srcPath = '~lib_src/tibet/services/rest/TPRESTService.js';
TP.core.HTTPService.defineSubtype('RESTService');TP.core.RESTService.Type.defineAttribute('triggerSignals','TP.sig.RESTRequest');TP.core.RESTService.register();
TP.boot.$srcPath = '~lib_src/tibet/services/json/TPJSONRequest.js';
TP.sig.IORequest.defineSubtype('JSONRequest');TP.sig.JSONRequest.Type.defineAttribute('responseType','TP.sig.JSONResponse');
TP.boot.$srcPath = '~lib_src/tibet/services/json/TPJSONResponse.js';
TP.sig.IOResponse.defineSubtype('JSONResponse');
TP.boot.$srcPath = '~lib_src/tibet/services/json/TPJSONService.js';
TP.core.IOService.defineSubtype('JSONService');TP.core.JSONService.Type.defineAttribute('triggerSignals','TP.sig.JSONRequest');TP.core.JSONService.Type.defineAttribute('supportedModes',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.JSONService.Type.defineAttribute('mode',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.JSONService.register();TP.core.JSONService.Inst.defineMethod('handleJSONRequest',function(g){var a,e,b,c,h,f,d;TP.debug('break.uri_service');if(!TP.isKindOf(g,'TP.sig.JSONRequest')){this.raise('TP.sig.InvalidRequest',arguments);return;}a=TP.request(g);b=TP.uc(a.at('uri'));if(TP.notValid(b)){return a.fail(TP.FAILURE,'TP.sig.InvalidURI');}a.atPut('async',this.rewriteRequestMode(a));c=TP.join(b.get('scheme'),'://',b.get('domain'),b.get('path'),'/',b.get('entity'));if(/jsonp:/.test(c)){h=true;if(TP.isTrue(b.get('useSSL'))){c=c.replace('jsonp:','https:');}else{c=c.replace('jsonp:','http:');}}if(TP.notEmpty(f=a.at('uriparams'))){f=TP.httpEncode(f,TP.URL_ENCODED);if(TP.notEmpty(f)){c=TP.uriJoinQuery(c,f);}}a.atPut('finaluri',c);d=a.constructResponse();e=a.at('callbackFunc');if(h){TP.jsonpCall(c,function(c){var f;if(TP.notValid(c)||TP.isString(c)&&TP.regex.JSON_ERRMSG.test(c)){d.setSignalName('TP.sig.IOFailed');d.fire();d.setSignalName('TP.sig.IOCompleted');d.fire();a.set('result',null);b.updateResourceCache(a);b.isLoaded(false);b.isDirty(true);a.fail(TP.FAILURE,c);}else{d.setSignalName('TP.sig.IOSucceeded');d.fire();d.setSignalName('TP.sig.IOCompleted');d.fire();a.set('result',c);f=b.updateResourceCache(a);b.isLoaded(true);b.isDirty(false);a.complete(f);}if(TP.isCallable(e)){e(c);}},a.at('callbackFuncName'),a.at('callbackParamName'));}else{a.atPutIfAbsent('async',true);a.defineMethod('handleIOSucceeded',function(f){var a,b,c,d;a=TP.sc('Succeeded but no data.');b=f.getPayload();if(TP.isXHR(c=b.at('xhr'))&&TP.notEmpty(d=TP.str(c))){a=TP.json2js(d);}if(TP.isCallable(e)){e(a);}this.complete(a);});a.defineMethod('handleIOFailed',function(f){var a,b,c,d;a=TP.sc('Failed with no message');b=f.getPayload();if(TP.isXHR(c=b.at('xhr'))&&TP.notEmpty(d=TP.str(c))){a=TP.sc('Failure: ')+d;}if(TP.isCallable(e)){e(a);}this.fail(TP.FAILURE,a);});TP.httpCall(c,g);}return this;});
TP.boot.$srcPath = '~lib_src/tibet/services/json/TPJSONPURL.js';
TP.core.URL.defineSubtype('JSONPURL');TP.core.JSONPURL.Type.defineConstant('JSONP_REGEX',TP.rc('jsonp://([^/]*)/?([^?]+)\\??(\\S*)'));TP.core.JSONPURL.Type.defineConstant('SCHEME','jsonp');TP.core.JSONPURL.Type.defineAttribute('supportedModes',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.JSONPURL.Type.defineAttribute('mode',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.JSONPURL.registerForScheme('jsonp');TP.core.JSONPURL.Type.defineMethod('$getDefaultHandler',function(a,b){return TP.core.JSONPURLHandler;});TP.core.JSONPURL.Inst.defineAttribute('domain');TP.core.JSONPURL.Inst.defineAttribute('entity');TP.core.JSONPURL.Inst.defineAttribute('query');TP.core.JSONPURL.Inst.defineAttribute('queryDict');TP.core.JSONPURL.Inst.defineAttribute('useSSL',false);TP.core.JSONPURL.Inst.defineMethod('init',function(d){var b,a,c,e;this.callNextMethod();b=this.getType().JSONP_REGEX.exec(d);if(TP.notValid(b)){this.raise('TP.sig.InvalidURI',arguments,'Unable to parse: '+d);return;}this.set('domain',b.at(1));a=b.at(2);if(a.contains('/')){this.set('path','/'+a.slice(0,a.lastIndexOf('/')));this.set('entity',a.slice(a.lastIndexOf('/')+1));}else{this.set('path','/');this.set('entity',a);}if(TP.notEmpty(c=b.at(3))){this.set('query',c);e=TP.lang.Hash.fromString(c);this.set('queryDict',e);}return this;});
TP.boot.$srcPath = '~lib_src/tibet/services/json/TPJSONPURLHandler.js';
TP.core.URIHandler.defineSubtype('JSONPURLHandler');TP.core.JSONPURLHandler.Type.defineMethod('load',function(c,h){var a,e,d,f,g,b;TP.debug('break.uri_load');if(!TP.canInvoke(c,'getLocation')){this.raise('TP.sig.InvalidURI',arguments);return;}a=TP.request(h);e=a.constructResponse();d=TP.ifInvalid(a.at('uriparams'),TP.hc());f=TP.ifInvalid(c.get('queryDict'),TP.hc());f.perform(function(a){d.atPutIfAbsent(a.first(),a.last());});g=TP.hc('uri',c,'uriparams',d);b=TP.sig.JSONRequest.construct(g);a.andJoinChild(b);b.fire();a.updateRequestMode(b);return e;});TP.core.JSONPURLHandler.Type.defineMethod('nuke',function(d,c){var a,b;this.raise('TP.sig.UnsupportedOperation',arguments);a=TP.request(c);b=a.constructResponse(false);a.fail();return b;});TP.core.JSONPURLHandler.Type.defineMethod('save',function(d,c){var a,b;this.raise('TP.sig.UnsupportedOperation',arguments);a=TP.request(c);b=a.constructResponse(false);a.fail();return b;});
TP.boot.$srcPath = '~lib_src/tibet/services/soap/TPSOAPRequest.js';
TP.sig.HTTPRequest.defineSubtype('SOAPRequest');TP.sig.SOAPRequest.Type.defineAttribute('responseType','TP.sig.SOAPResponse');TP.backstop(TP.ac('getFaultActor','getFaultDetails'),TP.sig.SOAPRequest.getInstPrototype(),true);TP.sig.SOAPRequest.Inst.defineMethod('asSOAPBody',function(d){var c,a,b;c=d||this;a=this.at('body');if(TP.notValid(a)){return;}if(TP.canInvoke(a,'asSOAPBody')){return a.asSOAPBody(c);}if(TP.isNode(a)){b=a;}else if(TP.canInvoke(a,'getNativeNode')){b=a.getNativeNode();}else{b=TP.node(a);if(TP.notValid(b)){this.raise('TP.sig.InvalidSOAPContent',arguments,'Unable to convert request body to XML.');return;}}return TP.isNode(b)?TP.str(b):null;});TP.sig.SOAPRequest.Inst.defineMethod('asSOAPMessage',function(){var a,b;a=TP.ac();a.push('<soap:Envelope ','xmlns:soap="http://www.w3.org/2003/05/soap-envelope" ','xmlns:xsi="http://www.w3.org/1999/XMLSchema-instance" ','xmlns:xsd="http://www.w3.org/1999/XMLSchema">');b=TP.str(TP.ifInvalid(this.asSOAPBody(this),''));if(b.indexOf('soap:Body')===TP.NOT_FOUND){a.push('<soap:Body>');}a.push(b);if(b.indexOf('soap:Body')===TP.NOT_FOUND){a.push('</soap:Body>');}a.push('</soap:Envelope>');return TP.node(a.join(''));});
TP.boot.$srcPath = '~lib_src/tibet/services/soap/TPSOAPResponse.js';
TP.sig.HTTPResponse.defineSubtype('SOAPResponse');TP.sig.SOAPResponse.Inst.defineMethod('getFaultActor',function(){var a,b;a=this.getResponseXML();if(TP.notValid(a)){return;}b=TP.nodeGetElementsByTagName(a,'faultactor');if(TP.notEmpty(b)){return TP.nodeGetTextContent(b.at(0));}return;});TP.sig.SOAPResponse.Inst.defineMethod('getFaultCode',function(){var a,b;a=this.getResponseXML();if(TP.notValid(a)){return this.callNextMethod();}b=TP.nodeGetElementsByTagName(a,'faultcode');if(TP.notEmpty(b)){return TP.nodeGetTextContent(b.at(0));}return;});TP.sig.SOAPResponse.Inst.defineMethod('getFaultDetails',function(){var a,b;a=this.getResponseXML();if(TP.notValid(a)){return;}b=TP.nodeGetElementsByTagName(a,'details');if(TP.notEmpty(b)){return TP.nodeGetTextContent(b.at(0));}return;});TP.sig.SOAPResponse.Inst.defineMethod('getFaultText',function(){var a,b;a=this.getResponseXML();if(TP.notValid(a)){return this.callNextMethod();}b=TP.nodeGetElementsByTagName(a,'faultstring');if(TP.notEmpty(b)){return TP.nodeGetTextContent(b.at(0));}return;});
TP.boot.$srcPath = '~lib_src/tibet/services/soap/TPSOAPService.js';
TP.core.HTTPService.defineSubtype('SOAPService');TP.core.SOAPService.Type.defineAttribute('triggerSignals','TP.sig.SOAPRequest');TP.core.SOAPService.register();TP.core.SOAPService.Inst.defineMethod('rewriteRequestMIMEType',function(a){return TP.XML_ENCODED;});TP.core.SOAPService.Inst.defineMethod('rewriteRequestBody',function(a){return a.asSOAPMessage();});TP.core.SOAPService.Inst.defineMethod('rewriteRequestHeaders',function(c){var a,b;a=this.callNextMethod();a.atPut('Content-Type',TP.XML_ENCODED);b=c.atIfInvalid('method','');a.atPut('SOAPAction',b);return a;});TP.core.SOAPService.Inst.defineMethod('rewriteRequestVerb',function(a){return TP.HTTP_POST;});
TP.boot.$srcPath = '~lib_src/tibet/services/webdav/TPWebDAVPrimitives.js';
TP.definePrimitive('webdavGetACL',function(b,c){var a;a=TP.ifInvalid(c,TP.hc());a.atPut('propertyXML','<D:acl/>');return TP.webdavPropFind(b,a);});TP.definePrimitive('webdavGetACLPrincipalPropSetReport',function(d,e){var a,b,c;a=TP.ifInvalid(e,TP.hc());a.atPut('verb',TP.WEBDAV_REPORT);b=TP.ifKeyInvalid(a,'headers',TP.hc());a.atPut('headers',b);b.atPutIfAbsent('Depth','0');c=TP.join(TP.XML_10_UTF8_HEADER,'\n','<D:acl-principal-prop-set xmlns:D="DAV:">\n','<D:prop>\n','<D:displayname/>\n','</D:prop>\n','</D:acl-principal-prop-set>');a.atPut('body',c);return TP.webdavCall(d,a);});TP.definePrimitive('webdavGetAllProperties',function(b,c){var a;a=TP.ifInvalid(c,TP.hc());a.atPut('propertyXML','<D:allprop/>');return TP.webdavPropFind(b,a);});TP.definePrimitive('webdavGetAllIncludedProperties',function(b,c){var a;a=TP.ifInvalid(c,TP.hc());a.atPut('propertyXML',TP.join('<D:allprop/>','<D:include>','<D:supported-live-property-set/>','<D:supported-report-set/>','</D:include>'));return TP.webdavPropFind(b,a);});TP.definePrimitive('webdavGetCurrentUserPrivilegeSet',function(b,c){var a;a=TP.ifInvalid(c,TP.hc());a.atPut('propertyXML','<D:current-user-privilege-set/>');return TP.webdavPropFind(b,a);});TP.definePrimitive('webdavGetDAVPropertyValues',function(e,f){var c,b,a,d;c=TP.ifInvalid(f,TP.hc());b=c.at('propertyNames');if(TP.notValid(b)||!TP.isArray(b)){TP.raise('TP.sig.InvalidParameter',arguments,'Must provide property name Array for WebDAV get '+'properties operation.');return;}a=TP.ac('<D:prop>');for(d=0;d<b.getSize();d++){a.push('<D:',TP.str(b.at(d)),'/>');}a.push('</D:prop>');a=a.join('');c.atPut('propertyXML',a);return TP.webdavPropFind(e,c);});TP.definePrimitive('webdavGetExpandPropertyReport',function(c,d){var a,b;a=TP.ifInvalid(d,TP.hc());a.atPut('verb',TP.WEBDAV_REPORT);b=TP.join(TP.XML_10_UTF8_HEADER,'\n','<D:expand-property xmlns:D="DAV:">\n','<D:property name="version-history">\n','<D:property name="version-set">\n','<D:property name="creator-displayname"/>\n','<D:property name="activity-set"/>\n','</D:property>\n','</D:property>\n','</D:expand-property>');a.atPut('body',b);return TP.webdavCall(c,a);});TP.definePrimitive('webdavGetPrincipalMatchReport',function(d,e){var a,b,c;a=TP.ifInvalid(e,TP.hc());a.atPut('verb',TP.WEBDAV_REPORT);b=TP.ifKeyInvalid(a,'headers',TP.hc());a.atPut('headers',b);b.atPutIfAbsent('Depth','0');c=TP.join(TP.XML_10_UTF8_HEADER,'\n','<D:principal-match xmlns:D="DAV:">\n','<D:principal-property>\n','<D:owner/>\n','</D:principal-property>\n','</D:principal-match>');a.atPut('body',c);return TP.webdavCall(d,a);});TP.definePrimitive('webdavGetPrincipalSearchPropertySetReport',function(d,e){var a,b,c;a=TP.ifInvalid(e,TP.hc());a.atPut('verb',TP.WEBDAV_REPORT);b=TP.ifKeyInvalid(a,'headers',TP.hc());a.atPut('headers',b);b.atPutIfAbsent('Depth','0');c=TP.join(TP.XML_10_UTF8_HEADER,'\n','<D:principal-search-property-set xmlns:D="DAV:"/>');a.atPut('body',c);return TP.webdavCall(d,a);});TP.definePrimitive('webdavGetProperty',function(d,e){var c,a,b;c=TP.ifInvalid(e,TP.hc());a=c.at('property');if(TP.notValid(a)){TP.raise('TP.sig.InvalidParameter',arguments,'Must provide property TP.lang.Hash for WebDAV get '+'property operation.');return;}b=TP.ac();b.push('<D:prop>','<P:',a.at('name'),' xmlns:P="',TP.ifInvalid(a.at('ns'),'DAV:'),'">',a.at('value'),'</P:',a.at('name'),'>','</D:prop>');b=b.join('');c.atPut('propertyXML',b);return TP.webdavPropFind(d,c);});TP.definePrimitive('webdavGetPropertyNames',function(b,c){var a;a=TP.ifInvalid(c,TP.hc());a.atPut('propertyXML','<D:propname/>');return TP.webdavPropFind(b,a);});TP.definePrimitive('webdavGetVersionTreeReport',function(c,d){var a,b;a=TP.ifInvalid(d,TP.hc());a.atPut('verb',TP.WEBDAV_REPORT);b=TP.join(TP.XML_10_UTF8_HEADER,'\n','<D:version-tree xmlns:D="DAV:">\n','<D:version-name/>\n','<D:creator-displayname/>\n','<D:successor-set/>\n','</D:version-tree>');a.atPut('body',b);return TP.webdavCall(c,a);});TP.definePrimitive('webdavRemoveProperty',function(c,d){var a,b;a=TP.ifInvalid(d,TP.hc());b=a.at('property');if(TP.notValid(b)){TP.raise('TP.sig.InvalidParameter',arguments,'Must provide property TP.lang.Hash for WebDAV get '+'property operation.');return;}a.atPut('removeList',TP.ac(b));return TP.webdavPropPatch(c,a);});TP.definePrimitive('webdavSetProperty',function(c,d){var a,b;a=TP.ifInvalid(d,TP.hc());b=a.at('property');if(TP.notValid(b)){TP.raise('TP.sig.InvalidParameter',arguments,'Must provide property TP.lang.Hash for WebDAV get '+'property operation.');return;}a.atPut('setList',TP.ac(b));return TP.webdavPropPatch(c,a);});TP.definePrimitive('webdavCall',function(d,e,f){var a,c,b;a=TP.ifInvalid(e,TP.hc());c=a.at('verb');if(TP.notValid(c)){TP.raise('TP.sig.InvalidParameter',arguments,'Must provide verb for WebDAV operation.');return;}b=TP.ifKeyInvalid(a,'headers',TP.hc());a.atPut('headers',b);b.atPutIfAbsent('Connection','TE');b.atPutIfAbsent('TE','trailers,deflate,gzip,compress');b.atPutIfAbsent('Translate','f');b.atPut('Content-Type',TP.XML_ENCODED);a.atPut('exceptionType','WebDAVException');if(TP.isTrue(f)){return TP.$httpQuery(c,d,a);}else{return TP.$httpSend(c,d,a);}});TP.definePrimitive('webdavCheckin',function(b,c){var a;a=TP.ifInvalid(c,TP.hc());a.atPut('verb',TP.WEBDAV_CHECKIN);return TP.webdavCall(b,a);});TP.definePrimitive('webdavCheckout',function(b,c){var a;a=TP.ifInvalid(c,TP.hc());a.atPut('verb',TP.WEBDAV_CHECKOUT);return TP.webdavCall(b,a);});TP.definePrimitive('webdavCopy',function(f,g){var a,c,b,d,e;a=TP.ifInvalid(g,TP.hc());a.atPut('verb',TP.WEBDAV_COPY);c=a.at('destination');if(TP.notValid(c)){TP.raise('TP.sig.InvalidParameter',arguments,'Must provide destination for WebDAV copy operation.');return;}b=TP.ifKeyInvalid(a,'headers',TP.hc());a.atPut('headers',b);b.atPut('Destination',c.getLocation());d=a.at('overwrite');if(TP.isTrue(d)){b.atPut('Overwrite','T');}else{b.atPut('Overwrite','F');}e=TP.join(TP.XML_10_UTF8_HEADER,'\n','<D:propertybehavior xmlns:D="DAV:">\n','<D:keepalive>*</D:keepalive>\n','</D:propertybehavior>');a.atPut('body',e);return TP.webdavCall(f,a);});TP.definePrimitive('webdavLock',function(i,j){var a,c,d,g,h,b,e,f;a=TP.ifInvalid(j,TP.hc());a.atPut('verb',TP.WEBDAV_LOCK);c=TP.ifKeyInvalid(a,'headers',TP.hc());a.atPut('headers',c);d=TP.ifKeyInvalid(a,'locktimeout',TP.WEBDAV_LOCKTIMEOUT_DEFAULT);c.atPut('Timeout',d);g=TP.ifKeyInvalid(a,'locktype',TP.WEBDAV_LOCKTYPE_WRITE);h=TP.ifKeyInvalid(a,'lockscope',TP.WEBDAV_LOCKSCOPE_SHARED);if(TP.notValid(b=a.at('lockowner'))){if(TP.isValid(e=TP.core.User.getEffectiveUser())){b=e.get('resourceID');}else{b='<D:unauthenticated/>';}}f=TP.join(TP.XML_10_UTF8_HEADER,'\n','<D:lockinfo xmlns:D="DAV:">\n','<D:lockscope><D:',h,'/></D:lockscope>','<D:locktype><D:',g,'/></D:locktype>','<D:owner>',b,'</D:owner>','</D:lockinfo>');a.atPut('body',f);return TP.webdavCall(i,a);});TP.definePrimitive('webdavMkCol',function(b,c){var a;a=TP.ifInvalid(c,TP.hc());a.atPut('verb',TP.WEBDAV_MKCOL);return TP.webdavCall(b,a);});TP.definePrimitive('webdavMove',function(f,g){var a,c,b,d,e;a=TP.ifInvalid(g,TP.hc());a.atPut('verb',TP.WEBDAV_MOVE);c=a.at('destination');if(TP.notValid(c)){TP.raise('TP.sig.InvalidParameter',arguments,'Must provide destination for WebDAV move operation.');return;}b=TP.ifKeyInvalid(a,'headers',TP.hc());a.atPut('headers',b);b.atPut('Destination',c.getLocation());d=a.at('overwrite');if(TP.isTrue(d)){b.atPut('Overwrite','T');}else{b.atPut('Overwrite','F');}e=TP.join(TP.XML_10_UTF8_HEADER,'\n','<D:propertybehavior xmlns:D="DAV:">\n','<D:keepalive>*</D:keepalive>','</D:propertybehavior>');a.atPut('body',e);return TP.webdavCall(f,a);});TP.definePrimitive('webdavPropFind',function(e,f){var a,c,d,b;a=TP.ifInvalid(f,TP.hc());a.atPut('verb',TP.WEBDAV_PROPFIND);c=TP.ifKeyInvalid(a,'headers',TP.hc());a.atPut('headers',c);c.atPutIfAbsent('Depth','0');b=TP.ac(TP.XML_10_UTF8_HEADER,'\n','<D:propfind xmlns:D="DAV:">\n');d=a.at('propertyXML');if(TP.notValid(d)){b.push('<D:allprop/>\n');}else{b.push(TP.str(d),'\n');}b.push('</D:propfind>');b=b.join('');a.atPut('body',b);return TP.webdavCall(e,a,true);});TP.definePrimitive('webdavPropPatch',function(i,j){var a,h,f,g,b,e,d,c;a=TP.ifInvalid(j,TP.hc());a.atPut('verb',TP.WEBDAV_PROPPATCH);h=TP.ifKeyInvalid(a,'headers',TP.hc());a.atPut('headers',h);c=TP.ac(TP.XML_10_UTF8_HEADER,'\n','<D:propertyupdate xmlns:D="DAV:">\n');f=a.at('setList');if(TP.notEmpty(f)){for(b=0;b<f.getSize();b++){e=f.at(b);c.push('<D:set><D:prop>','<P:',e.at('name'),' xmlns:P="',TP.ifInvalid(e.at('ns'),'DAV:'),'">',e.at('value'),'</P:',e.at('name'),'>','</D:prop></D:set>');}}g=a.at('removeList');if(TP.notEmpty(g)){for(b=0;b<g.getSize();b++){d=g.at(b);c.push('<D:remove><D:prop>','<P:',d.at('name'),' xmlns:P="',TP.ifInvalid(d.at('ns'),'DAV:'),'">',d.at('value'),'</P:',d.at('name'),'>','</D:prop></D:remove>');}}c.push('</D:propertyupdate>');c=c.join('');a.atPut('body',c);return TP.webdavCall(i,a);});TP.definePrimitive('webdavReport',function(b,c){var a;a=TP.ifInvalid(c,TP.hc());a.atPut('verb',TP.WEBDAV_REPORT);return TP.webdavCall(b,a);});TP.definePrimitive('webdavUnlock',function(d,e){var a,b,c;a=TP.ifInvalid(e,TP.hc());a.atPut('verb',TP.WEBDAV_UNLOCK);b=TP.ifKeyInvalid(a,'headers',TP.hc());a.atPut('headers',b);b.atPut('Connection','close');c=a.at('locktoken');if(TP.notValid(c)){TP.raise('TP.sig.InvalidParameter',arguments,'Must provide lock token for WebDAV unlock operation.');return;}b.atPut('Lock-Token','<'+c+'>');return TP.webdavCall(d,a);});TP.definePrimitive('webdavVersionControl',function(b,c){var a;a=TP.ifInvalid(c,TP.hc());a.atPut('verb',TP.WEBDAV_VERSIONCONTROL);return TP.webdavCall(b,a);});
TP.boot.$srcPath = '~lib_src/tibet/services/webdav/TPWebDAVRequest.js';
TP.sig.HTTPRequest.defineSubtype('WebDAVRequest');TP.sig.WebDAVRequest.Type.defineAttribute('responseType','TP.sig.WebDAVResponse');
TP.boot.$srcPath = '~lib_src/tibet/services/webdav/TPWebDAVResponse.js';
TP.sig.HTTPResponse.defineSubtype('WebDAVResponse');
TP.boot.$srcPath = '~lib_src/tibet/services/webdav/TPWebDAVService.js';
TP.core.HTTPService.defineSubtype('WebDAVService');TP.core.WebDAVService.Type.defineAttribute('triggerSignals','TP.sig.WebDAVRequest');TP.core.WebDAVService.register();TP.w3.Xmlns.registerNSInfo('DAV:',TP.hc('prefix','D'));TP.core.WebDAVService.Inst.defineMethod('performHTTPCall',function(a){var b,c,d;b=a.at('uri');if(TP.notValid(b)){return a.fail(TP.FAILURE,'TP.sig.InvalidURI');}try{d=TP.ifKeyInvalid(a,'headers',TP.hc());a.atPut('headers',d);d.atPut('Content-Type',TP.XML_ENCODED);switch(a.at('action')){case'read':c=TP.httpGet(b,a);break;case'write':c=TP.httpPut(b,a);break;case'remove':c=TP.httpDelete(b,a);break;case'copy':c=TP.webdavCopy(b,a);break;case'move':c=TP.webdavMove(b,a);break;case'makecoll':c=TP.webdavMkCol(b,a);break;case'listcoll':c=TP.webdavPropFind(b,a);break;case'getprop':c=TP.webdavGetProperty(b,a);break;case'getprops':c=TP.webdavGetAllProperties(b,a);break;case'setprops':c=TP.webdavPropPatch(b,a);break;case'setprop':c=TP.webdavSetProperty(b,a);break;case'deleteprops':c=TP.webdavPropPatch(b,a);break;case'lock':c=TP.webdavLock(b,a);break;case'unlock':c=TP.webdavUnlock(b,a);break;default:a.fail(TP.FAILURE,'Unrecognized action');break;}}catch(c){a.atPut('object',c);a.atPut('message',TP.str(c));return TP.httpError(b,TP.ifKeyInvalid('request','exceptionType','WebDAVException'),arguments,a);}return a;});
TP.boot.$srcPath = '~lib_src/tibet/services/webdav/TPWebDAVHandler.js';
TP.core.URIHandler.defineSubtype('WebDAVHandler');TP.core.WebDAVHandler.Type.defineMethod('load',function(e,f){var a,c,d,b;TP.debug('break.uri_load');a=TP.request(f);c=a.constructResponse();if(TP.isEmpty(d=a.at('action'))){a.fail();return c;}b=TP.core.WebDAVRequest.construct(TP.hc('action',d,'uri',e.asString(),'username',a.at('username'),'password',a.at('password')));a.andJoinChild(b);b.fire();a.updateRequestMode(b);return c;});TP.core.WebDAVHandler.Type.defineMethod('nuke',function(a,b){return TP.todo();});TP.core.WebDAVHandler.Type.defineMethod('save',function(d,g){var a,b,e,f,c;TP.debug('break.uri_save');a=TP.request(g);b=a.constructResponse();if(TP.isEmpty(e=d.getResourceText(TP.hc('async',false)))){a.fail();return b;}if(TP.isEmpty(f=a.at('action'))){a.fail();return b;}c=TP.core.WebDAVRequest.construct(TP.hc('uri',d.asString(),'body',e,'action',f,'refreshContent',false,'username',a.at('username'),'password',a.at('password')));a.andJoinChild(c);c.fire();a.updateRequestMode(c);return b;});
TP.boot.$srcPath = '~lib_src/tibet/services/xmlrpc/TPXMLRPCRequest.js';
TP.sig.HTTPRequest.defineSubtype('XMLRPCRequest');TP.sig.XMLRPCRequest.Type.defineAttribute('responseType','TP.sig.XMLRPCResponse');TP.sig.XMLRPCRequest.Type.defineMethod('formatParameter',function(c,g){var d,e,b,a,f;d=g;if(TP.isValid(d)){e=d.atIfInvalid('filter','unique_attributes');b=d.atIfInvalid('usenil',false);}else{e='unique_attributes';b=false;}a=TP.ac();a.push('<param><value>');if(TP.notValid(c)){a.push(b?TP.core.XMLRPCNode.NIL:'');}else{if(TP.canInvoke(c,'as')){f=c.as('TP.core.XMLRPCNode',e,b);}else{f=TP.core.XMLRPCNode.from(c,e,b);}if(TP.notValid(f)){a.push(b?TP.core.XMLRPCNode.NIL:'');}else{a.push(TP.str(f));}}a.push('</value></param>');return a.join('');});TP.sig.XMLRPCRequest.Inst.defineMethod('asXMLRPCBody',function(d){var b,a,c;b=d||this;a=this.at('body');if(TP.notValid(a)){return'<params/>';}if(TP.canInvoke(a,'asXMLRPCBody')){return a.asXMLRPCBody(b);}c=TP.join('<params>',this.getType().formatParameter(a,b),'</params>');return c;});TP.sig.XMLRPCRequest.Inst.defineMethod('asXMLRPCMessage',function(){var b,a;b=this.atIfInvalid('method','system.listMethods');a=TP.ac('<methodCall><methodName>',b,'</methodName>');a.push(TP.ifInvalid(this.asXMLRPCBody(this),'<params/>'));a.push('</methodCall>');return TP.node(a.join(''));});Array.Inst.defineMethod('asXMLRPCBody',function(g){var b,e,f,a,d,c;b=TP.request(g);e=b.atIfInvalid('bodyarray','single');f=e==='list'?true:false;a=TP.ac();if(f){d=this.getSize();if(d>0){a.push('<params>');for(c=0;c<d;c++){a.push(TP.sig.XMLRPCRequest.formatParameter(this.at(c),b));}a.push('</params>');}else{a.push('<params/>');}}else{a.push('<params>',TP.sig.XMLRPCRequest.formatParameter(this,b),'</params>');}return a.join('');});
TP.boot.$srcPath = '~lib_src/tibet/services/xmlrpc/TPXMLRPCResponse.js';
TP.sig.HTTPResponse.defineSubtype('XMLRPCResponse');TP.sig.XMLRPCResponse.Inst.defineMethod('getFaultCode',function(){var b,a;b=this.getResponseXML();if(TP.notValid(b)){return this.callNextMethod();}a=TP.nodeGetElementsByTagName(b,'fault');if(TP.notEmpty(a)){a=TP.nodeGetElementsByTagName(a.at(0),'int');if(TP.notEmpty(a)){return TP.nc(TP.nodeGetTextContent(a.at(0)));}}return;});TP.sig.XMLRPCResponse.Inst.defineMethod('getFaultText',function(){var b,a;b=this.getResponseXML();if(TP.notValid(b)){return this.callNextMethod();}a=TP.nodeGetElementsByTagName(b,'fault');if(TP.notEmpty(a)){a=TP.nodeGetElementsByTagName(a.at(0),'string');if(TP.notEmpty(a)){return TP.sc(TP.nodeGetTextContent(a.at(0)));}}return;});TP.sig.XMLRPCResponse.Inst.defineMethod('getResultObject',function(){var b,c,a;b=this.getResponseXML();if(TP.notValid(b)){return;}if(this.didFail()){a=TP.nodeGetElementsByTagName(b,'fault');if(TP.notEmpty(a)){c=TP.nodeGetChildElementAt(a.at(0),0);}}else{a=TP.nodeGetElementsByTagName(b,'param');if(TP.notEmpty(a)){c=TP.nodeGetChildElementAt(a.at(0),0);}}return TP.core.XMLRPCNode.objectFromNode(c);});
TP.boot.$srcPath = '~lib_src/tibet/services/xmlrpc/TPXMLRPCService.js';
TP.core.HTTPService.defineSubtype('XMLRPCService');TP.core.XMLRPCService.Type.defineAttribute('triggerSignals','TP.sig.XMLRPCRequest');TP.core.XMLRPCService.register();TP.core.XMLRPCService.Inst.defineMethod('rewriteRequestMIMEType',function(a){return TP.XMLRPC_ENCODED;});TP.core.XMLRPCService.Inst.defineMethod('rewriteRequestBody',function(a){a.atPut('bodyWantsXMLDeclaration',true);return a.asXMLRPCMessage();});TP.core.XMLRPCService.Inst.defineMethod('rewriteRequestHeaders',function(e){var c,d,a,b;c=this.callNextMethod();c.atPut('Content-Type',TP.XML_TEXT_ENCODED);d=TP.uc(e.at('uri'));if(TP.isURI(d)){b=d.get('port');b=b===80?'':':'+b;a=d.get('host');a=a==='localhost'?'0.0.0.0':a;c.atPut('Host',a+b);}return c;});TP.core.XMLRPCService.Inst.defineMethod('rewriteRequestVerb',function(a){return TP.HTTP_POST;});
TP.boot.$srcPath = '~lib_src/acl/acl_.js';
TP.core.XMLNamespace.defineSubtype('acl:XMLNS');
TP.boot.$srcPath = '~lib_src/acl/acl_info.js';
TP.core.InfoElementNode.defineSubtype('acl:info');
TP.boot.$srcPath = '~lib_src/ev/ev_.js';
TP.core.XMLNamespace.defineSubtype('ev:XMLNS');TP.ev.XMLNS.Type.defineMethod('awaken',function(d){var l,a,j,i,c,b,e,h,k,f,g;if(TP.isEmpty(l=TP.elementGetAttribute(d,'ev:event',true))){return TP.DESCEND;}TP.debug('break.awaken_events');a=l.trim();if(a==='*'){a=TP.ANY;}c=TP.elementGetAttribute(d,'ev:observer',true);b=TP.elementGetAttribute(d,'ev:target',true);e=TP.elementGetAttribute(d,'ev:handler',true);if(!/ /.test(a)){a=TP.isType(TP.sys.require(j=TP.expandSignalName(a)))?j:a;i=TP.regex.KEY_EVENT.test(a)?TP.sys.require('TP.sig.DOMKeySignal'):TP.sig.Signal;if(TP.isType(h=TP.sig.SignalMap.$getSignalType(a,i))&&TP.canInvoke(h,'getDefaultPolicy')&&h.getDefaultPolicy()!==TP.DOM_FIRING){if(TP.notEmpty(b)){if(TP.isEmpty(c)){c=b;}b=null;}}this.$registerEvInfo(d,a,c,b,e);}else{k=a.split(' ');f=TP.ac();g=TP.ac();k.perform(function(c){var b,a,d;a=TP.isType(TP.sys.require(d=TP.expandSignalName(c)))?d:c;if(TP.isType(b=TP.sig.SignalMap.$getSignalType(a,TP.sig.Signal))&&TP.canInvoke(b,'getDefaultPolicy')&&b.getDefaultPolicy()!==TP.DOM_FIRING){g.push(a);}else{f.push(a);}});if(TP.notEmpty(f)){this.$registerEvInfo(d,f.join(' '),c,b,e);}if(TP.notEmpty(b)){if(TP.isEmpty(c)){c=b;}b=null;}if(TP.notEmpty(g)){this.$registerEvInfo(d,g.join(' '),c,b,e);}}return TP.DESCEND;});TP.ev.XMLNS.Type.defineMethod('$registerEvInfo',function(a,v,u,t,s){var d,p,i,b,c,e,f,k,l,g,m,r,h,j,o,n,q;d=TP.nodeGetDocument(a);p=TP.nodeGetWindow(d);i=v;b=u;c=t;e=s;f=a;if(TP.isEmpty(b)){if(TP.isEmpty(e)){l=a.parentNode;g=l;f=l;}else{g=a;f=a;}if(TP.isEmpty(TP.elementGetAttribute(g,'id'))){m=TP.elemGenID(g,true);}b=TP.gid(g);}else if(b==='*'){b=TP.ANY;f=d;}else if(b==='#document'){b=TP.gid(d);f=d;}else if(TP.isString(b)&&TP.isURI(k=TP.uc(b))){b=k.getLocation();}else{g=TP.nodeGetElementById(d,b);if(TP.notValid(g)){j=b.split(' ');if(j.getSize()>1){f=b;j.convert(function(b){if(b==='#document'){return TP.gid(d);}else if(TP.isElement(g=TP.nodeGetElementById(d,b))){return TP.gid(g);}else{TP.ifWarn(TP.$DEBUG)?TP.warn('Specified ev:observer '+b+' not found for: '+TP.nodeAsString(a),TP.LOG,arguments):0;return b;}});b=j.join(' ');}else{TP.ifWarn(TP.$DEBUG)?TP.warn('Specified ev:observer not found for: '+TP.nodeAsString(a),TP.LOG,arguments):0;}}else{b=TP.gid(g);f=g;}}if(TP.isEmpty(e)){if(TP.isEmpty(TP.elementGetAttribute(a,'id'))){m=TP.lid(a);TP.elementSetAttribute(a,'id',m);}if(TP.elementHasAttribute(a,'sig:name',true)&&TP.isType(r=TP.sys.getTypeByName('sig:dispatch'))&&TP.core.ElementNode.getConcreteType(a)!==r){e=TP.join('javascript:','TP.sig.XMLNS.dispatchSignal(','triggerSignal.getResolvedTarget());');}else{e=TP.gid(a);}}else{if(/^#/.test(e)){e=e.slice(1);if(TP.isElement(h=TP.nodeGetElementById(d,e))){e=TP.gid(h);}else{e=TP.gid(p)+'#'+e;}}else if(TP.isElement(h=TP.nodeGetElementById(d,e))){e=TP.gid(h);}else{}}if(TP.isEmpty(c)){c=b;}else if(c==='*'){c=TP.ANY;f=d;}else if(c==='#document'){c=TP.gid(d);f=d;}else if(TP.isString(c)&&TP.isURI(k=TP.uc(c))){c=k.getLocation();}else if(TP.isElement(h=TP.nodeGetElementById(d,c))){c=TP.gid(h);f=h;}else{j=c.split(' ');if(TP.notEmpty(j)){j.convert(function(a){if(TP.isElement(h=TP.nodeGetElementById(d,a))){return TP.gid(h);}});f=j.join(' ');c=f;}else{TP.ifWarn(TP.$DEBUG&&TP.$VERBOSE)?TP.warn('Specified ev:target not found for: '+TP.nodeAsString(a),TP.LOG,arguments):0;}}i=i.split(' ');i=i.collect(function(a){var b;if(TP.isType(b=TP.sys.getTypeByName(a))){return b.getSignalName();}return a;});i=i.join(' ');o=TP.elementGetAttribute(a,'ev:phase',true);n=TP.elementGetAttribute(a,'ev:propagate',true);q=TP.elementGetAttribute(a,'ev:defaultAction',true);TP.sig.SignalMap.$registerHandlerInfo(c,i,e,o,n,q,b,true);return a;});
TP.boot.$srcPath = '~lib_src/ev/ev_info.js';
TP.core.InfoElementNode.defineSubtype('ev:info');
TP.boot.$srcPath = '~lib_src/ev/ev_listener.js';
TP.core.InfoElementNode.defineSubtype('ev:listener');
TP.boot.$srcPath = '~lib_src/ev/ev_script.js';
TP.core.ActionElementNode.defineSubtype('ev:script');TP.ev.script.Type.defineMethod('tshExecute',function(aRequest){var node,funcID,win,result,src,source,url,type,req,shell,signal;node=aRequest.at('cmdNode');if(TP.notEmpty(funcID=TP.elementGetAttribute(node,'tibet:function',true))){win=TP.nodeGetWindow(node)||window;if(TP.canInvoke(win,funcID)){try{result=win[funcID](aRequest,aRequest.at('cmdTrigger'));return aRequest.complete(result);}catch(a){return aRequest.fail(TP.FAILURE,TP.join('Error executing TP.ev.script function: ',this.asString()),'EvalException');}}}src=TP.elementGetAttribute(node,'ev:src',true);if(TP.isEmpty(src)){source=TP.nodeGetTextContent(node);}else{if(TP.notValid(url=TP.uc(src))){return aRequest.fail(TP.FAILURE,'Invalid src attribute value: '+src);}source=url.getResourceText(TP.hc('async',false));}if(TP.isEmpty(source)){return aRequest.fail('No source code found for: '+TP.str(node));}type=TP.ifEmpty(TP.elementGetAttribute(node,'ev:type',true),TP.ietf.Mime.TSH);if(type===TP.ietf.Mime.TSH){req=TP.sig.ShellRequest.construct(TP.hc('cmd',source,'cmdAllowSubs',false,'cmdAsIs',aRequest.at('cmdAsIs'),'cmdExecute',true,'cmdHistory',false,'cmdInteractive',false,'cmdLiteral',aRequest.at('cmdLiteral'),'cmdPhases','nocache','cmdShell',aRequest.at('cmdShell'),'cmdSilent',true,'execContext',TP.ifInvalid(TP.nodeGetWindow(node),window)));shell=aRequest.at('cmdShell');req.defineMethod('cancelJob',function(a,b){shell.unsetVariable('SIGNAL');shell.unsetVariable('TARGET');return aRequest.cancel(TP.ifInvalid(a,TP.FAILURE),TP.ifInvalid(b,'TP.ev.script cancelled.'));});req.defineMethod('completeJob',function(a){shell.unsetVariable('SIGNAL');shell.unsetVariable('TARGET');if(arguments.length>0){return aRequest.complete(a);}else{return aRequest.complete();}});req.defineMethod('failJob',function(a,b){shell.unsetVariable('SIGNAL');shell.unsetVariable('TARGET');return aRequest.fail(TP.ifInvalid(a,TP.FAILURE),TP.ifInvalid(b,'TP.ev.script failed.'));});req.configureSTDIO(aRequest);req.atPut(TP.STDIN,this.getActionInput(aRequest));if(TP.isValid(signal=aRequest.at('cmdTrigger'))){shell.setVariable('SIGNAL',signal);shell.setVariable('TARGET',signal.getTarget());}shell.handleShellRequest(req);}else if(type===TP.ietf.Mime.JS){funcID=TP.genID('ev_script');source='function(shellRequest, triggerSignal) {'+source+'};';try{win=TP.nodeGetWindow(node)||window;eval('win.$$handler = '+source);win[funcID]=win.$$handler;}catch(a){return aRequest.fail(TP.FAILURE,TP.join('Error creating TP.ev.script function: ',source,'. ',TP.str(a)));}TP.elementSetAttribute(node,'tibet:function',funcID,true);try{result=win[funcID](aRequest,aRequest.at('cmdTrigger'));aRequest.complete(result);}catch(a){return aRequest.fail(TP.FAILURE,TP.join('Error executing TP.ev.script function: ',this.asString()),'EvalException');}}else{return aRequest.fail(TP.FAILURE,TP.join('Invalid TP.ev.script source type: ',type));}return TP.CONTINUE;});
TP.boot.$srcPath = '~lib_src/xhtml/html_Element.js';
TP.core.UIElementNode.defineSubtype('html:Element');TP.html.Element.isAbstract(true);TP.html.Element.Inst.defineMethod('addCSSClass',function(a,b){TP.elementAddCSSClass(this.getNativeNode(),a,b);return this;});TP.html.Element.Inst.defineMethod('getClass',function(){return TP.elementGetClass(this.getNativeNode());});TP.html.Element.Inst.defineMethod('getStyle',function(){return TP.elementGetStyle(this.getNativeNode());});TP.html.Element.Inst.defineMethod('removeCSSClass',function(a){TP.elementRemoveCSSClass(this.getNativeNode(),a);return this;});TP.html.Element.Inst.defineMethod('replaceCSSClass',function(a,b){TP.elementReplaceCSSClass(this.getNativeNode(),a,b);return this;});TP.html.Element.Inst.defineMethod('setClass',function(a){TP.elementSetClass(this.getNativeNode(),a);return this;});TP.html.Element.Inst.defineMethod('setStyle',function(a){var b;if(TP.isString(a)){TP.elementSetStyle(this.getNativeNode(),a);}b=this.getNativeNode().style;a.perform(function(c){var a;a=c.first().asDOMName();if(TP.isString(a)){b[a]=c.last();}});return this;});TP.html.Element.Inst.defineMethod('getDisplayValue',function(){var a,b;a=this.getNativeNode();if(TP.elementHasAttribute(a,'value')){return this.getAttribute('value');}try{if(TP.notEmpty(b=a.value)){return b;}}catch(a){}return TP.nodeGetTextContent(a);});TP.html.Element.Inst.defineMethod('setDisplayValue',function(b){var a,c;a=this.getNativeNode();this.setAttribute('value',b);try{if(TP.notEmpty(c=a.value)){a.value=b;}else{TP.nodeSetTextContent(a,b);}}catch(c){TP.nodeSetTextContent(a,b);}return this;});
TP.boot.$srcPath = '~lib_src/xhtml/html_CommonNodes.js';
TP.core.UIElementNode.defineSubtype('html:CoreAttrs');TP.html.CoreAttrs.addTraitsFrom(TP.html.Element);TP.html.CoreAttrs.isAbstract(true);TP.html.CoreAttrs.Type.resolveTraits(TP.ac('tagCompile','canConnectFrom','canConnectTo','isValidConnectorDest','isValidConnectorSource'),TP.html.Element);TP.html.CoreAttrs.Inst.resolveTraits(TP.ac('getDisplayValue','setDisplayValue'),TP.html.Element);TP.core.UIElementNode.defineSubtype('html:Attrs');TP.html.Attrs.addTraitsFrom(TP.html.Element);TP.html.Attrs.isAbstract(true);TP.html.Attrs.Type.resolveTraits(TP.ac('tagCompile','canConnectFrom','canConnectTo','isValidConnectorDest','isValidConnectorSource'),TP.html.Element);TP.html.Attrs.Inst.resolveTraits(TP.ac('getDisplayValue','setDisplayValue'),TP.html.Element);TP.html.Attrs.defineSubtype('Aligned');TP.html.Aligned.isAbstract(true);TP.html.Attrs.defineSubtype('Focused');TP.html.Focused.isAbstract(true);TP.html.Attrs.defineSubtype('Citation');TP.html.Citation.isAbstract(true);TP.html.Attrs.defineSubtype('List');TP.html.List.isAbstract(true);TP.html.List.Type.defineMethod('generateMarkup',function(b,g,c,h,i,d){var a,e,f;if(TP.isArray(b)){}else if(TP.isTrue(h)&&TP.isTrue(d.at('repeat'))){a=this.getTagName();e=TP.join('<',a,g,'>','{{0%',c,'}}','{{1%',c,'}}','</',a,'>');f=e.transform(b,d);return f;}return this.callNextMethod();});TP.html.List.Type.defineMethod('getItemTagName',function(){return'html:li';});TP.html.List.Type.defineMethod('shouldAutoWrapItems',function(b,a){if(TP.isBoolean(a.at('autowrap'))){return a.at('autowrap');}if(TP.isArray(b)){return false;}return true;});
TP.boot.$srcPath = '~lib_src/xhtml/html_10Nodes.js';
TP.html.CoreAttrs.defineSubtype('applet');TP.html.applet.set('uriAttrs',TP.ac('src'));TP.html.CoreAttrs.defineSubtype('basefont');TP.html.Attrs.defineSubtype('center');TP.html.List.defineSubtype('dir');TP.html.CoreAttrs.defineSubtype('font');TP.html.CoreAttrs.defineSubtype('frame');TP.html.CoreAttrs.defineSubtype('frameset');TP.html.CoreAttrs.defineSubtype('iframe');TP.html.iframe.addTraitsFrom(TP.core.UICanvas);TP.html.iframe.Type.resolveTraits(TP.ac('cmdGetContent','cmdSetContent','constructContentObject','getConcreteType','fromObject','fromString','fromTP_sig_Signal','handleSignal','construct'),TP.html.CoreAttrs);TP.html.iframe.Inst.resolveTraits(TP.ac('getContentNode','canResolveDNU','resolveDNU','getContentMIMEType','asSource','getKeys','isResponderFor','getNextResponder','asDumpString','asHTMLString','asJSONSource','asPrettyString','asXMLString','getName','getID','setID','getLocalName','asString','changed','shouldSignalChange','at','atPut','signal','observe','resume','suspend','getSize','getValues','first','last','getPairs','getKVPairs','getItems','equalTo','getProperty','get','getContent','getValue','setProperty','set','setValue','perform','collect','collectGet','collectInvoke','convert','detectInvoke','detectMax','detectMin','flatten','grep','grepKeys','groupBy','injectInto','orderedBy','partition','performInvoke','performOver','performSet','performUntil','performWhile','reject','select','containsKey','containsValue','contains','init','processTP_sig_Request','asArray','asHTMLNode','asXHTMLNode','asXHTMLString','asXMLNode','collapse','asHash','removeKey','removeKeys','transform'),TP.html.CoreAttrs);TP.html.iframe.set('uriAttrs',TP.ac('src','longdesc'));TP.html.iframe.Inst.defineMethod('setContentFromSource',function(){var a;if(TP.notEmpty(a=this.getAttribute('src'))){this.setContentUsingRelativePath(a);}return this;});TP.html.iframe.Inst.defineMethod('setContentUsingRelativePath',function(b){var c,a;if(TP.notEmpty(b)){c=this.computeAbsoluteURIFromValue(b);a=TP.uc(c);a=a.rewrite();if(TP.isURI(a)){this.setContent(a);}}return this;});TP.html.iframe.Inst.defineMethod('getCanvasID',function(){return TP.join(this.getWindow().getCanvasID(),'.',this.getLocalID());});TP.html.iframe.Inst.defineMethod('getGlobalID',function(){return TP.gid(this.getNativeNode());});TP.html.iframe.Inst.defineMethod('getLocalID',function(){return TP.lid(this.getNativeNode());});TP.html.iframe.Inst.defineMethod('getNativeContentDocument',function(){var a;if(TP.isElement(a=this.getNativeNode())){return TP.elementGetIFrameDocument(a);}return null;});TP.html.iframe.Inst.defineMethod('getNativeContentWindow',function(){var a;if(TP.isElement(a=this.getNativeNode())){return TP.elementGetIFrameWindow(a);}return null;});TP.html.iframe.Inst.defineMethod('$get',function(c){var a,b;a=this.callNextMethod();if(TP.notDefined(a)&&TP.isWindow(b=this.getNativeContentWindow())){a=b[c];}return a;});TP.html.iframe.Inst.defineMethod('constructObject',function(c){var a,b;b=TP.elementGetIFrameWindow(this.getNativeNode());a=TP.args(arguments);a.unshift(b);return TP.windowConstructObject.apply(b,a);});TP.html.iframe.Inst.resolveTrait('setContent',TP.core.UICanvas);TP.html.CoreAttrs.defineSubtype('isindex');TP.html.Attrs.defineSubtype('listing');TP.html.List.defineSubtype('menu');TP.html.Attrs.defineSubtype('noframes');TP.html.Attrs.defineSubtype('s');TP.html.Attrs.defineSubtype('strike');TP.html.Attrs.defineSubtype('u');
TP.boot.$srcPath = '~lib_src/xhtml/html_BaseModuleNodes.js';
TP.html.Attrs.defineSubtype('base');
TP.boot.$srcPath = '~lib_src/xhtml/html_BidirectionalTextModuleNodes.js';
TP.html.Attrs.defineSubtype('bdo');
TP.boot.$srcPath = '~lib_src/xhtml/html_ClientSideImageMapModuleNodes.js';
TP.html.Focused.defineSubtype('area');TP.html.area.set('uriAttrs',TP.ac('href'));TP.html.Attrs.defineSubtype('map');
TP.boot.$srcPath = '~lib_src/xhtml/html_EditModuleNodes.js';
TP.html.Citation.defineSubtype('del');TP.html.del.set('uriAttrs',TP.ac('cite'));TP.html.Citation.defineSubtype('ins');TP.html.ins.set('uriAttrs',TP.ac('cite'));
TP.boot.$srcPath = '~lib_src/xhtml/html_FormsModuleNodes.js';
TP.html.Attrs.defineSubtype('fieldset');TP.html.fieldset.Inst.defineMethod('refresh',function(a){if(TP.isTrue(a.at('deep'))){}return;});TP.core.UIElementNode.defineSubtype('html:textUtilities');TP.html.textUtilities.addTraitsFrom(TP.html.Element);TP.html.textUtilities.Type.resolveTraits(TP.ac('tagCompile','canConnectFrom','canConnectTo','isValidConnectorDest','isValidConnectorSource'),TP.html.Element);TP.html.textUtilities.Inst.resolveTraits(TP.ac('getDisplayValue','setDisplayValue'),TP.html.Element);TP.html.textUtilities.isAbstract(true);TP.html.textUtilities.Inst.defineMethod('clearValue',function(){var a,b;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}b=a.value;a.value='';this.changed('value',TP.DELETE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,''));return this;});TP.html.textUtilities.Inst.defineMethod('clearSelection',function(){var a,b;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}b=this.getSelection();TP.textElementReplaceSelection(a,'');this.changed('selection',TP.DELETE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,''));return this;});TP.html.textUtilities.Inst.defineMethod('collapseSelection',function(b){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}if(TP.boot.isUA('IE')){return this;}if(b){a.setSelectionRange(a.selectionStart,a.selectionStart);}else{a.setSelectionRange(a.selectionEnd,a.selectionEnd);}return this;});TP.html.textUtilities.Inst.defineMethod('getSelection',function(){var a,b;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}if(TP.boot.isUA('IE')){if(TP.notValid(b=this.getNativeDocument().selection)){return'';}return b.createRange().text;}return a.value.substring(a.selectionStart,a.selectionEnd);});TP.html.textUtilities.Inst.defineMethod('getSelectionEnd',function(){var b,a,c,d,e;if(TP.notValid(b=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}if(TP.boot.isUA('IE')){a=this.getNativeDocument().selection.createRange();c=a.duplicate();d=0-c.moveStart('character',-100000)-1;e=d+a.text.length;return e;}return b.selectionEnd;});TP.html.textUtilities.Inst.defineMethod('getSelectionStart',function(){var a,b,c,d;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}if(TP.boot.isUA('IE')){b=this.getNativeDocument().selection.createRange();c=b.duplicate();d=0-c.moveStart('character',-100000)-1;return d;}return a.selectionStart;});TP.html.textUtilities.Inst.defineMethod('getValue',function(){return this.getDisplayValue();});TP.html.textUtilities.Inst.defineMethod('insertAfterSelection',function(c){var a,b;a=this.getSelection();this.replaceSelection(TP.join(a,c));b=this.getSelection();this.changed('selection',TP.INSERT,TP.hc(TP.OLDVAL,a,TP.NEWVAL,b));return this;});TP.html.textUtilities.Inst.defineMethod('insertBeforeSelection',function(c){var a,b;a=this.getSelection();this.replaceSelection(TP.join(c,a));b=this.getSelection();this.changed('selection',TP.INSERT,TP.hc(TP.OLDVAL,a,TP.NEWVAL,b));return this;});TP.html.textUtilities.Inst.defineMethod('replaceSelection',function(d){var a,b,c;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}b=this.getSelection();TP.textElementReplaceSelection(a,d);c=this.getSelection();this.changed('selection',TP.UPDATE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,c));return this;});TP.html.textUtilities.Inst.defineMethod('selectFromTo',function(b,d){var c,a;if(TP.notValid(c=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}if(TP.boot.isUA('IE')){a=c.createTextRange();a.collapse(true);a.moveStart('character',b);a.moveEnd('character',d-b);a.select();return this;}c.setSelectionRange(b,d);return this;});TP.html.textUtilities.Inst.defineMethod('setCursorPosition',function(b){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}try{a.focus();}catch(a){}a.setSelectionRange(b,b+1);return this;});TP.html.textUtilities.Inst.defineMethod('setCursorToEnd',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}try{a.focus();}catch(a){}TP.documentCollapseSelection(this.getNativeDocument());return this;});TP.html.textUtilities.Inst.defineMethod('setCursorToStart',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}try{a.focus();}catch(a){}TP.documentCollapseSelection(this.getNativeDocument(),true);return this;});TP.html.textUtilities.Inst.defineMethod('setValue',function(c,e){var d,a,b;d=this.getValue();if(this.hasAttribute('xctrls:showas')){a=this.$formatValue(c,'xctrls:showas');}else{a=c;}this.setDisplayValue(a);if(TP.notValid(b=e)){b=this.shouldSignalChange();}if(b){this.changed('value',TP.UPDATE,TP.hc(TP.OLDVAL,d,TP.NEWVAL,a));}return this;});TP.html.textUtilities.Inst.defineMethod('setSelection',function(a){this.replaceSelection(a);return this;});TP.html.textUtilities.Inst.defineMethod('wrapSelection',function(a,b){return this.replaceSelection(TP.join(a,this.getSelection(),b));});TP.html.Focused.defineSubtype('input');TP.html.input.isAbstract(true);TP.html.input.set('uriAttrs',TP.ac('src','usemap'));TP.html.input.Type.defineMethod('fromArray',function(a,b){return a.as('TP.html.select',b);});TP.html.input.Type.defineMethod('fromBoolean',function(c,d){var a,b;a=TP.str(c);b=TP.ifInvalid(d.at('$INDEX'),TP.genID().slice(10));return TP.join('<input id="field_',b,'" type="checkbox" value="',a,'"/>');});TP.html.input.Type.defineMethod('fromDate',function(b,c){var a,d;if(TP.isTrue(c.at('escapeContent'))){a=TP.xmlLiteralsToEntities(TP.str(b));}else{a=TP.str(b);}d=TP.ifInvalid(c.at('$INDEX'),TP.genID().slice(10));return TP.join('<input id="field_',d,'" type="text" value="',a,'"/>');});TP.html.input.Type.defineMethod('fromNumber',function(b,c){var a,d;if(TP.isTrue(c.at('escapeContent'))){a=TP.xmlLiteralsToEntities(TP.str(b));}else{a=TP.str(b);}d=TP.ifInvalid(c.at('$INDEX'),TP.genID().slice(10));return TP.join('<input id="field_',d,'" type="text" value="',a,'"/>');});TP.html.input.Type.defineMethod('fromString',function(b,c){var a,d;if(TP.isTrue(c.at('escapeContent'))){a=TP.xmlLiteralsToEntities(TP.htmlEntitiesToXmlEntities(TP.str(b)));}else{a=TP.str(b);}d=TP.ifInvalid(c.at('$INDEX'),TP.genID().slice(10));return TP.join('<input id="field_',d,'" type="text" value="',a,'"/>');});TP.html.input.Type.defineMethod('generateMarkup',function(b,f,g,h,i,d){var e,a,c;e=this.getTagName();if(TP.isArray(b)){a=TP.join('<label for="field_{{$INDEX}}">','Field #{{$INDEX}}:','</label>','{{%TP.html.input}}');}else{a=TP.join('<label for="field_{{$INDEX}}">','{{0}}:','</label>','{{1%TP.html.input}}');}c=a.transform(b,d);return c;});TP.html.input.Type.defineMethod('shouldAutoWrapItems',function(b,a){if(TP.isBoolean(a.at('autowrap'))){return a.at('autowrap');}return false;});TP.html.input.Type.defineMethod('getConcreteType',function(a){var b,c;if(TP.isString(a)){return TP.byOID(a);}if(TP.isEmpty(b=TP.elementGetAttribute(a,'type'))){b='text';}c=TP.html.form.NODE_TYPE_NAMES.at(b);return c.asType();});TP.html.input.Type.defineMethod('handlePeerTP_sig_DOMChange',function(b,c){var a;a=TP.wrap(b);if(TP.isValid(a)&&a.shouldSignalChange()){a.changed('value',TP.UPDATE);}});TP.html.input.Inst.defineMethod('isSingleValued',function(){return true;});TP.html.input.Inst.defineMethod('isScalarValued',function(){return true;});TP.html.input.defineSubtype('inputVisible');TP.html.inputVisible.isAbstract(true);TP.html.inputVisible.defineSubtype('inputClickable');TP.html.inputClickable.isAbstract(true);TP.backstop(TP.ac('click'),TP.html.inputClickable.getInstPrototype());TP.html.inputClickable.Inst.defineMethod('disable',function(){this.setAttribute('disabled','true');return this;});TP.html.inputClickable.Inst.defineMethod('enable',function(){this.removeAttribute('disabled');return this;});TP.html.inputClickable.defineSubtype('inputCheckable');TP.html.inputCheckable.isAbstract(true);TP.html.inputCheckable.Inst.defineMethod('addSelection',function(g,k){var b,e,j,f,h,i,c,a,d;if(TP.isString(g)){b=g.split(' ').collapse();}else{b=g;}if(TP.isArray(b)&&!this.allowsMultiples()){return this.raise('TP.sig.InvalidOperation',arguments,'Target TP.html.select does not allow multiple selection');}if(TP.notValid(e=this.getElementArray())){return this.raise('TP.sig.InvalidElementArray',arguments);}if(TP.isArray(b)){f=TP.hc().addAllKeys(b);}else{f=TP.hc(b,'');}j=TP.ifInvalid(k,'value');h=false;i=e.getSize();for(c=0;c<i;c++){a=e.at(c);switch(j){case'value':d=a.value;break;case'label':d=TP.nodeGetTextContent(e.at(c));break;case'id':d=a.id;break;case'index':d=c;break;}if(f.containsKey(d)){if(!a.checked){h=true;}a.checked=true;TP.elementSetAttribute(a,'checked','checked',true);}}if(h){this.changed('selection',TP.UPDATE);}return this;});TP.html.inputCheckable.Inst.defineMethod('deselect',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}if(TP.isFalse(a.checked)){return this;}a.checked=false;this.removeAttribute('checked');return this;});TP.html.inputCheckable.Inst.defineMethod('deselectAll',function(){var b,c,d,a;if(TP.notValid(b=this.getElementArray())){return this.raise('TP.sig.InvalidElementArray',arguments);}c=false;d=b.getSize();for(a=0;a<d;a++){if(b.at(a).checked){c=true;}b.at(a).checked=false;TP.elementRemoveAttribute(b.at(a),'checked',true);}if(c){this.changed('selection',TP.UPDATE);}return this;});TP.html.inputCheckable.Inst.defineMethod('getDisplayValue',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return TP.bc(a.checked);});TP.html.inputCheckable.Inst.defineMethod('getElementArray',function(){var b,a;if(TP.notValid(b=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}if(TP.isEmpty(a=this.getAttribute('name'))){return TP.ac();}return this.get(TP.cpc('*[name="'+a+'"]'));});TP.html.inputCheckable.Inst.defineMethod('isSelected',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return TP.bc(a.checked);});TP.html.inputCheckable.Inst.defineMethod('on',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a.checked=true;this.setAttribute('checked','checked');return this;});TP.html.inputCheckable.Inst.defineMethod('off',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a.checked=false;this.removeAttribute('checked');return this;});TP.html.inputCheckable.Inst.defineMethod('removeSelection',function(g,k){var b,e,j,f,h,i,c,a,d;if(TP.isString(g)){b=g.split(' ').collapse();}else{b=g;}if(TP.isArray(b)&&!this.allowsMultiples()){return this.raise('TP.sig.InvalidOperation',arguments,'Target TP.html.select does not allow multiple selection');}if(TP.notValid(e=this.getElementArray())){return this.raise('TP.sig.InvalidElementArray',arguments);}if(TP.isArray(b)){f=TP.hc().addAllKeys(b);}else{f=TP.hc(b,'');}j=TP.ifInvalid(k,'value');h=false;i=e.getSize();for(c=0;c<i;c++){a=e.at(c);switch(j){case'value':d=a.value;break;case'label':d=TP.nodeGetTextContent(e.at(c));break;case'id':d=a.id;break;case'index':d=c;break;}if(f.containsKey(d)){if(a.checked){h=true;}a.checked=false;TP.elementRemoveAttribute(a,'checked',true);}}if(h){this.changed('selection',TP.UPDATE);}return this;});TP.html.inputCheckable.Inst.defineMethod('select',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}if(a.checked){return this;}a.checked=true;this.setAttribute('checked','checked');return this;});TP.html.inputCheckable.Inst.defineMethod('selectAll',function(){var b,c,d,a;if(!this.allowsMultiples()){return this.raise('TP.sig.InvalidOperation',arguments,'Target does not allow multiple selection');}if(TP.notValid(b=this.getElementArray())){return this.raise('TP.sig.InvalidElementArray',arguments);}c=false;d=b.getSize();for(a=0;a<d;a++){if(!b.at(a).checked){c=true;}b.at(a).checked=true;TP.elementSetAttribute(b.at(a),'checked','checked',true);}if(c){this.changed('selection',TP.UPDATE);}return this;});TP.html.inputCheckable.Inst.defineMethod('setDisplayValue',function(b){var a;a=TP.bc(b);if(a){this.on();}else{this.off();}return this;});TP.html.inputVisible.defineSubtype('inputSelectable');TP.html.inputSelectable.isAbstract(true);TP.backstop(TP.ac('select'),TP.html.inputSelectable.getInstPrototype());TP.html.Attrs.defineSubtype('form');TP.html.form.Type.defineConstant('NODE_TYPE_NAMES',TP.hc('button','TP.html.inputButton','image','TP.html.inputImage','checkbox','TP.html.inputCheckbox','color','TP.html.inputColor','date','TP.html.inputDate','datetime','TP.html.inputDateTime','datetime-local','TP.html.inputDateTimeLocal','email','TP.html.inputEmail','file','TP.html.inputFile','hidden','TP.html.inputHidden','month','TP.html.inputMonth','number','TP.html.inputNumber','password','TP.html.inputPassword','radio','TP.html.inputRadio','range','TP.html.inputRange','reset','TP.html.inputReset','search','TP.html.inputSearch','select-one','TP.html.select','select-single','TP.html.select','select-multiple','TP.html.select','submit','TP.html.inputSubmit','tel','TP.html.inputTel','text','TP.html.inputText','textarea','TP.html.textarea','time','TP.html.inputTime','url','TP.html.inputUrl','week','TP.html.inputWeek'));TP.html.form.set('uriAttrs',TP.ac('action'));TP.html.form.Type.defineMethod('getItemTagName',function(){return'html:input';});TP.html.form.Type.defineMethod('shouldAutoWrapItems',function(b,a){if(TP.isBoolean(a.at('autowrap'))){return a.at('autowrap');}return false;});TP.html.form.Inst.defineMethod('getElementArray',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.elements;});TP.html.form.Inst.defineMethod('getDisplayValue',function(){var a,b,c,e,d;if(TP.notValid(e=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}d=TP.hc();b=e.elements;for(a=0;a<b.length;a++){c='TP.html.Element'.construct(b[a]);if(TP.notValid(c)){TP.ifWarn()?TP.warn(TP.boot.$annotate(TP.nodeCloneNode(b[a]),'Unable to acquire wrapper.'),TP.LOG,arguments):0;continue;}d.atPut(c.getSubmitName(),c.getValue());}return d;});TP.html.form.Inst.defineMethod('setDisplayValue',function(d){var e,b,a,c;if(TP.notValid(e=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}if(!TP.isKindOf(d,TP.lang.Hash)){return this.raise('TP.sig.InvalidParameter',arguments,'Must provide a hash of key value pairs.');}b=e.elements;for(a=0;a<b.length;a++){c='TP.html.Element'.construct(b[a]);if(TP.notValid(c)){TP.ifWarn()?TP.warn(TP.boot.$annotate(TP.nodeCloneNode(b[a]),'Unable to acquire wrapper.'),TP.LOG,arguments):0;continue;}c.setDisplayValue(d.at(c.getSubmitName()));}return this;});TP.html.form.Inst.defineMethod('reset',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.reset();});TP.html.form.Inst.defineMethod('submit',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.submit();});TP.html.inputClickable.defineSubtype('inputButton');TP.html.inputClickable.defineSubtype('inputColor');TP.html.inputClickable.defineSubtype('inputDate');TP.html.inputClickable.defineSubtype('inputDateTime');TP.html.inputClickable.defineSubtype('inputDateTimeLocal');TP.html.inputClickable.defineSubtype('inputMonth');TP.html.inputClickable.defineSubtype('inputRange');TP.html.inputCheckable.defineSubtype('inputCheckbox');TP.html.inputSelectable.defineSubtype('inputEmail');TP.html.inputEmail.addTraitsFrom(TP.html.textUtilities);TP.html.inputEmail.Type.resolveTraits(TP.ac('tagCompile','canConnectFrom','canConnectTo','isValidConnectorDest','isValidConnectorSource'),TP.html.Element);TP.html.inputEmail.Inst.resolveTraits(TP.ac('getValue','setValue','addCSSClass','getClass','getStyle','removeCSSClass','replaceCSSClass','setClass','setStyle'),TP.html.textUtilities);TP.html.inputEmail.Inst.defineMethod('getDisplayValue',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.value;});TP.html.inputEmail.Inst.defineMethod('setDisplayValue',function(b){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a.value=b;return this;});TP.html.inputSelectable.defineSubtype('inputFile');TP.html.input.defineSubtype('inputHidden');TP.html.inputSelectable.defineSubtype('inputNumber');TP.html.inputNumber.addTraitsFrom(TP.html.textUtilities);TP.html.inputNumber.Type.resolveTraits(TP.ac('tagCompile','canConnectFrom','canConnectTo','isValidConnectorDest','isValidConnectorSource'),TP.html.Element);TP.html.inputNumber.Inst.resolveTraits(TP.ac('getValue','setValue','addCSSClass','getClass','getStyle','removeCSSClass','replaceCSSClass','setClass','setStyle'),TP.html.textUtilities);TP.html.inputNumber.Inst.defineMethod('getDisplayValue',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.value;});TP.html.inputNumber.Inst.defineMethod('setDisplayValue',function(b){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a.value=b;return this;});TP.html.input.defineSubtype('inputImage');TP.html.inputSelectable.defineSubtype('inputPassword');TP.html.inputPassword.addTraitsFrom(TP.html.textUtilities);TP.html.inputPassword.Type.resolveTraits(TP.ac('tagCompile','canConnectFrom','canConnectTo','isValidConnectorDest','isValidConnectorSource'),TP.html.Element);TP.html.inputPassword.Inst.resolveTraits(TP.ac('getValue','setValue','addCSSClass','getClass','getStyle','removeCSSClass','replaceCSSClass','setClass','setStyle'),TP.html.textUtilities);TP.html.inputPassword.Inst.defineMethod('getDisplayValue',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.value;});TP.html.inputPassword.Inst.defineMethod('setDisplayValue',function(b){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a.value=b;return this;});TP.html.inputSelectable.defineSubtype('inputSearch');TP.html.inputSearch.addTraitsFrom(TP.html.textUtilities);TP.html.inputSearch.Type.resolveTraits(TP.ac('tagCompile','canConnectFrom','canConnectTo','isValidConnectorDest','isValidConnectorSource'),TP.html.Element);TP.html.inputSearch.Inst.resolveTraits(TP.ac('getValue','setValue','addCSSClass','getClass','getStyle','removeCSSClass','replaceCSSClass','setClass','setStyle'),TP.html.textUtilities);TP.html.inputSearch.Inst.defineMethod('getDisplayValue',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.value;});TP.html.inputSearch.Inst.defineMethod('setDisplayValue',function(b){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a.value=b;return this;});TP.html.inputCheckable.defineSubtype('inputRadio');TP.html.inputRadio.Inst.defineMethod('allowsMultiples',function(){return false;});TP.html.inputRadio.Inst.defineMethod('off',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a.checked=false;this.removeAttribute('checked');return this;});TP.html.inputRadio.Inst.defineMethod('on',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a.checked=true;this.setAttribute('checked','checked');return this;});TP.html.inputRadio.Inst.defineMethod('getDisplayValue',function(){var e,c,f,d,g,a,b;if(TP.notValid(e=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}c=TP.elementGetAttribute(e,'name');if(TP.isEmpty(c)){return this.raise('TP.sig.InvalidName',arguments,'Radio item missing name attribute');}f=this.getNativeDocument();d=TP.nodeGetDescendantElementsByName(f,c);g=d.getSize();for(a=0;a<g;a++){b=d.at(a);if(b.checked||TP.elementGetAttribute(b,'checked')==='checked'){return b.value;}}return null;});TP.html.inputRadio.Inst.defineMethod('getSubmitName',function(){var b,a;if(TP.notValid(b=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a=TP.elementGetAttribute(b,'id');if(TP.isEmpty(a)){a=TP.elementGetAttribute(b,'name');}return a;});TP.html.inputRadio.Inst.defineMethod('setDisplayValue',function(h){var d,e,f,c,g,b,a;if(TP.notValid(d=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}if(TP.isEmpty(e=TP.elementGetAttribute(d,'name'))){return this.raise('TP.sig.InvalidName',arguments,'Radio item missing name attribute');}f=this.getNativeDocument();c=TP.nodeGetDescendantElementsByName(f,e);g=c.getSize();for(b=0;b<g;b++){a=c.at(b);if(a.value===h){a.checked=true;TP.elementSetAttribute(a,'checked','checked');}else{a.checked=false;TP.elementRemoveAttribute(a,'checked');}}return this;});TP.html.inputClickable.defineSubtype('inputReset');TP.html.inputClickable.defineSubtype('inputSubmit');TP.html.inputSelectable.defineSubtype('inputTel');TP.html.inputTel.addTraitsFrom(TP.html.textUtilities);TP.html.inputTel.Type.resolveTraits(TP.ac('tagCompile','canConnectFrom','canConnectTo','isValidConnectorDest','isValidConnectorSource'),TP.html.Element);TP.html.inputTel.Inst.resolveTraits(TP.ac('getValue','setValue','addCSSClass','getClass','getStyle','removeCSSClass','replaceCSSClass','setClass','setStyle'),TP.html.textUtilities);TP.html.inputTel.Inst.defineMethod('getDisplayValue',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.value;});TP.html.inputTel.Inst.defineMethod('setDisplayValue',function(b){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a.value=b;return this;});TP.html.inputSelectable.defineSubtype('inputText');TP.html.inputText.addTraitsFrom(TP.html.textUtilities);TP.html.inputText.Type.resolveTraits(TP.ac('tagCompile','canConnectFrom','canConnectTo','isValidConnectorDest','isValidConnectorSource'),TP.html.Element);TP.html.inputText.Inst.resolveTraits(TP.ac('getValue','setValue','addCSSClass','getClass','getStyle','removeCSSClass','replaceCSSClass','setClass','setStyle'),TP.html.textUtilities);TP.html.inputText.Inst.defineMethod('getDisplayValue',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.value;});TP.html.inputText.Inst.defineMethod('setDisplayValue',function(b){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a.value=b;return this;});TP.html.inputClickable.defineSubtype('inputTime');TP.html.inputClickable.defineSubtype('inputWeek');TP.html.inputSelectable.defineSubtype('inputUrl');TP.html.inputUrl.addTraitsFrom(TP.html.textUtilities);TP.html.inputUrl.Type.resolveTraits(TP.ac('tagCompile','canConnectFrom','canConnectTo','isValidConnectorDest','isValidConnectorSource'),TP.html.Element);TP.html.inputUrl.Inst.resolveTraits(TP.ac('getValue','setValue','addCSSClass','getClass','getStyle','removeCSSClass','replaceCSSClass','setClass','setStyle'),TP.html.textUtilities);TP.html.inputUrl.Inst.defineMethod('getDisplayValue',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.value;});TP.html.inputUrl.Inst.defineMethod('setDisplayValue',function(b){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a.value=b;return this;});TP.html.Attrs.defineSubtype('label');TP.html.Aligned.defineSubtype('legend');TP.html.Attrs.defineSubtype('optgroup');TP.html.Attrs.defineSubtype('option');TP.html.option.Type.defineMethod('generateMarkup',function(d,e,f,h,i,g){var a,b,c;a=this.getTagName();if(TP.isFalse(h)){if(TP.isTrue(g.at('repeat'))){if(TP.isArray(d)){b=TP.join('<',a,e,' value="{{$INDEX}}">','{{%',f,'}}','</',a,'>');}else{b=TP.join('<',a,e,' value="{{0}}">','{{1%',f,'}}','</',a,'>');}c=b.transform(d,g);return c;}}else{b=TP.join('<',a,e,' value="{{0}}">','{{1%',f,'}}','</',a,'>');c=b.transform(d,g);return c;}return this.callNextMethod();});TP.html.option.Type.defineMethod('shouldAutoWrapItems',function(b,a){if(TP.isBoolean(a.at('autowrap'))){return a.at('autowrap');}return false;});TP.html.option.Inst.defineMethod('isSelected',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.selected;});TP.html.option.Inst.defineMethod('on',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a.selected=true;this.setAttribute('selected','selected');return this;});TP.html.option.Inst.defineMethod('off',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a.selected=false;this.removeAttribute('selected');return this;});TP.html.Focused.defineSubtype('select');TP.backstop(TP.ac('add','remove'),TP.html.select.getInstPrototype());TP.html.select.Type.defineMethod('getItemTagName',function(){return'html:option';});TP.html.select.Type.defineMethod('shouldAutoWrapItems',function(b,a){if(TP.isBoolean(a.at('autowrap'))){return a.at('autowrap');}return false;});TP.html.select.Inst.defineMethod('addSelection',function(g,k){var b,e,j,f,h,i,c,a,d;if(TP.isString(g)){b=g.split(' ').collapse();}else{b=g;}if(TP.isArray(b)&&!this.allowsMultiples()){return this.raise('TP.sig.InvalidOperation',arguments,'Target TP.html.select does not allow multiple selection');}if(TP.notValid(e=this.getElementArray())){return this.raise('TP.sig.InvalidElementArray',arguments);}if(TP.isArray(b)){f=TP.hc().addAllKeys(b);}else{f=TP.hc(b,'');}j=TP.ifInvalid(k,'value');h=false;i=e.getSize();for(c=0;c<i;c++){a=e.at(c);switch(j){case'value':d=a.value;break;case'label':d=TP.nodeGetTextContent(e.at(c));break;case'id':d=a.id;break;case'index':d=c;break;}if(f.containsKey(d)){if(!a.selected){h=true;}a.selected=true;TP.elementSetAttribute(a,'selected','selected',true);}}if(h){this.changed('selection',TP.UPDATE);}return this;});TP.html.select.Inst.defineMethod('allowsMultiples',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.type==='select-multiple';});TP.html.select.Inst.defineMethod('deselect',function(c){var b,d,e,f,a;if(TP.isEmpty(c)){return this.deselectAll();}if(TP.notValid(b=this.getElementArray())){return this.raise('TP.sig.InvalidElementArray',arguments);}if(TP.isArray(c)){d=TP.hc().addAllKeys(c,'');}else{d=TP.hc(c,'');}e=false;f=b.getSize();for(a=0;a<f;a++){if(d.containsKey(b.at(a).value)){if(b.at(a).selected){e=true;}b.at(a).selected=false;TP.elementRemoveAttribute(b.at(a),'selected',true);}}if(e){this.changed('selection',TP.UPDATE);}return this;});TP.html.select.Inst.defineMethod('deselectAll',function(){var b,c,d,a;if(TP.notValid(b=this.getElementArray())){return this.raise('TP.sig.InvalidElementArray',arguments);}c=false;d=b.getSize();for(a=0;a<d;a++){if(b.at(a).selected){c=true;}b.at(a).selected=false;TP.elementRemoveAttribute(b.at(a),'selected',true);}if(c){this.changed('selection',TP.UPDATE);}return this;});TP.html.select.Type.defineMethod('handlePeerTP_sig_DOMChange',function(b,c){var a;a=TP.wrap(b);if(TP.isValid(a)&&a.shouldSignalChange()){a.changed('value',TP.UPDATE);}});TP.html.select.Inst.defineMethod('getElementArray',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.options;});TP.html.select.Inst.defineMethod('getDisplayValue',function(){var d,a,e,c,f,b;if(TP.notValid(d=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}if(TP.notValid(a=this.getElementArray())){return this.raise('TP.sig.InvalidElementArray',arguments);}if(!this.allowsMultiples()){if((e=d.selectedIndex)===TP.NOT_FOUND){return null;}return a.at(e).value;}c=TP.ac();f=a.getSize();for(b=0;b<f;b++){if(a.at(b).selected){c.push(a.at(b).value);}}return c;});TP.html.select.Inst.defineMethod('refreshItems',function(m,l){var h,a,f,d,b,i,j,g,c,k,e;if(TP.notValid(h=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a=TP.ifInvalid(l,TP.nodeGetFirstElementChildByTagName(h,'xctrls:itemset'));if(TP.notValid(a)){return;}f=TP.unwrap(a);a=TP.tpnode(a);d=a.getItemContainer();if(!TP.isNode(d)){return this.raise('TP.sig.InvalidMarkup',arguments,'Itemset not enclosed in an itembox: '+a.asString());}b=a.getBoundContent();if(TP.isEmpty(b)){TP.nodeSetContent(d,f);return;}if(!TP.canInvoke(b,'injectInto')){TP.ifWarn()?TP.warn(TP.boot.$annotate(this,'Itemset content not a collection.'),TP.LOG,arguments):0;return;}i=TP.elementGetAttribute(f,'xctrls:label',true);j=TP.elementGetAttribute(f,'xctrls:value',true);g='<option value="{{'+j+'}}">{{'+i+'}}</option>';c=TP.ac();if(TP.isArray(b)){k=b.length;for(e=0;e<k;e++){c.push(g.transform(b.at(e)));}}else{c=b.injectInto(c,function(b,a,c){a.push(g.transform(b));return a;});}TP.nodeSetContent(d,c.join());return;});TP.html.select.Inst.defineMethod('refreshRepeatContent',function(f){var c,d,b,e,a;if(TP.notValid(c=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}d=TP.nodeGetFirstElementChildByTagName(c,'option');if(TP.notValid(d)){return this.raise('TP.sig.InvalidElement',arguments,'TP.html.select option child not found.');}b=this.getBoundContent();if(TP.isEmpty(b)){return;}if(!TP.canInvoke(b,'perform')){TP.ifWarn()?TP.warn(TP.boot.$annotate(this,'Itemset is not a collection.'),TP.LOG,arguments):0;return;}e=TP.nodeAsString(d,false,true);a=TP.ac();a.push(e);a=b.injectInto(a,function(b,a,c){a.push(e.transform(b));return a;});TP.nodeSetContent(c,a.join());return;});TP.html.select.Inst.defineMethod('removeSelection',function(g,k){var b,e,j,f,h,i,c,a,d;if(TP.isString(g)){b=g.split(' ').collapse();}else{b=g;}if(TP.isArray(b)&&!this.allowsMultiples()){return this.raise('TP.sig.InvalidOperation',arguments,'Target TP.html.select does not allow multiple selection');}if(TP.notValid(e=this.getElementArray())){return this.raise('TP.sig.InvalidElementArray',arguments);}if(TP.isArray(b)){f=TP.hc().addAllKeys(b);}else{f=TP.hc(b,'');}j=TP.ifInvalid(k,'value');h=false;i=e.getSize();for(c=0;c<i;c++){a=e.at(c);switch(j){case'value':d=a.value;break;case'label':d=TP.nodeGetTextContent(e.at(c));break;case'id':d=a.id;break;case'index':d=c;break;}if(f.containsKey(d)){if(a.selected){h=true;}a.selected=false;TP.elementRemoveAttribute(a,'selected',true);}}if(h){this.changed('selection',TP.UPDATE);}return this;});TP.html.select.Inst.defineMethod('select',function(d){var b,c,e,f,g,a;if(TP.isEmpty(d)){return this.selectAll();}if(TP.isString(d)){b=d.split(' ').collapse();}else{b=d;}if(TP.isArray(b)&&!this.allowsMultiples()){return this.raise('TP.sig.InvalidOperation',arguments,'Target TP.html.select does not allow multiple selection');}if(TP.notValid(c=this.getElementArray())){return this.raise('TP.sig.InvalidElementArray',arguments);}if(TP.isArray(b)){e=TP.hc().addAllKeys(b);}else{e=TP.hc(b,'');}f=false;g=c.getSize();for(a=0;a<g;a++){if(e.containsKey(c.at(a).value)){if(!c.at(a).selected){f=true;}c.at(a).selected=true;TP.elementSetAttribute(c.at(a),'selected','selected',true);}}if(f){this.changed('selection',TP.UPDATE);}return this;});TP.html.select.Inst.defineMethod('selectAll',function(){var b,c,d,a;if(!this.allowsMultiples()){return this.raise('TP.sig.InvalidOperation',arguments,'Target TP.html.select does not allow multiple selection');}if(TP.notValid(b=this.getElementArray())){return this.raise('TP.sig.InvalidElementArray',arguments);}c=false;d=b.getSize();for(a=0;a<d;a++){if(!b.at(a).selected){c=true;}b.at(a).selected=true;TP.elementSetAttribute(b.at(a),'selected','selected',true);}if(c){this.changed('selection',TP.UPDATE);}return this;});TP.html.select.Inst.defineMethod('setDisplayValue',function(d){var b,c,f,e,g,a;if(TP.isEmpty(d)){return this.deselectAll();}if(TP.notValid(b=this.getElementArray())){return this.raise('TP.sig.InvalidElementArray',arguments);}if(TP.isString(d)){c=d.split(' ').collapse();}else{c=d;}if(TP.isArray(c)&&!this.allowsMultiples()){c=c.at(0);}if(TP.isArray(c)){f=TP.hc().addAllKeys(c,'');}else{f=TP.hc(c,'');}e=false;g=b.getSize();for(a=0;a<g;a++){if(f.containsKey(b.at(a).value)){if(!b.at(a).selected){e=true;}b.at(a).selected=true;TP.elementSetAttribute(b.at(a),'selected','selected',true);}else{if(b.at(a).selected){e=true;}b.at(a).selected=false;TP.elementRemoveAttribute(b.at(a),'selected',true);}}if(e){this.changed('selection',TP.UPDATE);}return this;});TP.html.Focused.defineSubtype('textarea');TP.html.textarea.addTraitsFrom(TP.html.textUtilities);TP.html.textarea.Type.resolveTraits(TP.ac('tagCompile','canConnectFrom','canConnectTo','isValidConnectorDest','isValidConnectorSource'),TP.html.Element);TP.html.textarea.Inst.resolveTraits(TP.ac('getValue','setValue','addCSSClass','getClass','getStyle','removeCSSClass','replaceCSSClass','setClass','setStyle'),TP.html.textUtilities);TP.backstop(TP.ac('select'),TP.html.textarea.getInstPrototype());TP.html.textarea.Inst.defineMethod('getDisplayValue',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.value;});TP.html.textarea.Type.defineMethod('handlePeerTP_sig_DOMChange',function(b,c){var a;a=TP.wrap(b);if(TP.isValid(a)&&a.shouldSignalChange()){a.changed('value',TP.UPDATE);}});TP.html.textarea.Inst.defineMethod('isSingleValued',function(){return true;});TP.html.textarea.Inst.defineMethod('isScalarValued',function(){return true;});TP.html.textarea.Inst.defineMethod('setDisplayValue',function(b){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}a.value=b;return this;});TP.html.inputClickable.defineSubtype('button');
TP.boot.$srcPath = '~lib_src/xhtml/html_HypertextModuleNodes.js';
TP.html.Focused.defineSubtype('a');TP.html.a.set('uriAttrs',TP.ac('href'));
TP.boot.$srcPath = '~lib_src/xhtml/html_ImageModuleNodes.js';
TP.html.Attrs.defineSubtype('img');TP.html.img.set('uriAttrs',TP.ac('src','longdesc','usemap'));TP.html.img.Type.defineMethod('constructContentObject',function(a){return TP.tpnode(TP.elementFromString(TP.join('<html:img xmlns:html="',TP.w3.Xmlns.XHTML,'" src="',a.getLocation(),'"/>')));});
TP.boot.$srcPath = '~lib_src/xhtml/html_LinkModuleNodes.js';
TP.html.Attrs.defineSubtype('link');TP.html.link.set('uriAttrs',TP.ac('href'));TP.html.link.Type.defineMethod('tagPrecompile',function(c){var a,b,d,g,e,f;TP.debug('break.css_processing');if(!TP.sys.cfg('css.process_styles')){return TP.CONTINUE;}if(TP.notValid(a=c.at('node'))){return c.fail(TP.FAILURE,'Unable to find command node');}b=a.href||TP.elementGetAttribute(a,'href');if(TP.isEmpty(b)){return c.fail(TP.FAILURE,'TP.html.link must have href attribute.','TP.sig.InvalidElement');}b=TP.uriJoinPaths(TP.elementComputeXMLBaseFrom(a),b);d=TP.uc(b);if(TP.notValid(d)){return c.fail(TP.FAILURE,'TP.html.link href not a valid URI.','TP.sig.InvalidURI');}g=d.getResourceText(TP.hc('async',false));e=TP.join('<html:style type="text/css" src="',b,'" ','xmlns:html="',TP.w3.Xmlns.XHTML,'"><![CDATA[',g,']]></html:style>');f=TP.nodeFromString(e);if(TP.notValid(f)){return c.fail(TP.FAILURE,'TP.html.link href not a valid URI.','Unable to create new css:sheet node from :'+e,'TP.sig.InvalidNode');}TP.nodeReplaceChild(a.parentNode,f,a);return;});
TP.boot.$srcPath = '~lib_src/xhtml/html_ListModuleNodes.js';
TP.html.List.defineSubtype('dl');TP.html.dl.Type.defineMethod('generateMarkup',function(c,d,h,g,i,e){var a,b,f;a=this.getTagName();if(TP.isTrue(g)&&TP.isTrue(e.at('repeat'))){if(TP.isArray(c)){b=TP.join('<',a,d,'>','{{$INDEX%TP.html.dt}}','{{value%TP.html.dd}}','</',a,'>');}else{b=TP.join('<',a,d,'>','{{0%TP.html.dt}}','{{1%TP.html.dd}}','</',a,'>');}f=b.transform(c,e);return f;}return this.callNextMethod();});TP.html.dl.Type.defineMethod('getItemTagName',function(){return'';});TP.html.dl.Type.defineMethod('shouldAutoWrapItems',function(a,b){return true;});TP.html.Attrs.defineSubtype('dt');TP.html.Attrs.defineSubtype('dd');TP.html.List.defineSubtype('ol');TP.html.List.defineSubtype('ul');TP.html.ul.Type.defineMethod('generateMarkup',function(b,g,c,h,i,d){var a,e,f;if(TP.isArray(b)){}else if(TP.isTrue(h)&&TP.isTrue(d.at('repeat'))){a=this.getTagName();e=TP.join('<',a,g,'>','{{0%',c,'}}','{{1%',c,'}}','</',a,'>');f=e.transform(b,d);return f;}return this.callNextMethod();});TP.html.Attrs.defineSubtype('li');
TP.boot.$srcPath = '~lib_src/xhtml/html_MetainformationModuleNodes.js';
TP.html.Attrs.defineSubtype('meta');
TP.boot.$srcPath = '~lib_src/xhtml/html_ObjectModuleNodes.js';
TP.html.Attrs.defineSubtype('audio');TP.html.Attrs.defineSubtype('canvas');TP.html.canvas.Type.defineConstant('TWO_D_CONTEXT_PROPERTY_NAMES',TP.ac('canvas','globalAlpha','globalCompositeOperation','strokeStyle','fillStyle','lineWidth','lineCap','lineJoin','miterLimit','shadowOffsetX','shadowOffsetY','shadowBlur','shadowColor','font','textAlign','textBaseline'));TP.html.canvas.Type.defineConstant('TWO_D_CONTEXT_METHOD_NAMES',TP.ac('save','restore','scale','rotate','translate','transform','setTransform','createLinearGradient','createRadialGradient','createPattern','clearRect','fillRect','strokeRect','beginPath','closePath','moveTo','lineTo','quadraticCurveTo','bezierCurveTo','arcTo','rect','arc','fill','stroke','clip','isPointInPath','drawImage','createImageData','getImageData','putImageData','fillText','strokeText'));TP.html.canvas.Inst.defineMethod('toDataURL',function(b){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.toDataURL(b);});TP.html.canvas.Inst.defineMethod('get2DContext',function(){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.getContext('2d');});TP.html.canvas.Inst.defineMethod('getContext',function(b){var a;if(TP.notValid(a=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}return a.getContext(b);});TP.html.canvas.Inst.defineMethod('canResolveDNU',function(b,a,c,d){if(this.getType().TWO_D_CONTEXT_METHOD_NAMES.contains(a)){return true;}return this.callNextMethod();});TP.html.canvas.Inst.defineMethod('resolveDNU',function(e,d,b,f){var a,c;if(TP.notValid(a=this.get2DContext())){return this.raise('TP.sig.InvalidContext',arguments);}try{if(!TP.isCallable(c=a[d])){return this.raise('TP.sig.InvalidFunction',arguments);}}catch(a){return this.raise('TP.sig.InvalidFunction',arguments,TP.ec(a));}if(TP.notValid(b)||b.length===0){return a.func();}return c.apply(a,b);});TP.html.canvas.Inst.defineMethod('$get',function(c){var a,b;a=this.callNextMethod();if(TP.notDefined(a)){if(TP.notValid(b=this.get2DContext())){return this.raise('TP.sig.InvalidContext',arguments);}a=b[c];}return a;});TP.html.canvas.Inst.defineMethod('$set',function(a,b){var c;if(!this.getType().TWO_D_CONTEXT_PROPERTY_NAMES.contains(a)){return this.callNextMethod();}if(TP.notValid(c=this.get2DContext())){return this.raise('TP.sig.InvalidContext',arguments);}c[a]=b;return b;});TP.html.Attrs.defineSubtype('embed');TP.html.embed.set('uriAttrs',TP.ac('src'));TP.html.Attrs.defineSubtype('object');TP.html.object.isAbstract(true);TP.html.object.set('uriAttrs',TP.ac('classid','codebase','usemap','data'));TP.html.object.Type.defineMethod('getConcreteType',function(a){var b;if(TP.isString(a)){return TP.byOID(a);}b=TP.ietf.Mime.get('info').at(TP.elementGetAttribute(a,'type')).at('objectNodeType');return b.asType();});TP.html.Attrs.defineSubtype('param');TP.html.Attrs.defineSubtype('source');TP.html.source.set('uriAttrs',TP.ac('src'));TP.html.Attrs.defineSubtype('video');
TP.boot.$srcPath = '~lib_src/xhtml/html_PresentationModuleNodes.js';
TP.html.Attrs.defineSubtype('b');TP.html.Attrs.defineSubtype('big');TP.html.Attrs.defineSubtype('datalist');TP.html.Attrs.defineSubtype('details');TP.html.Aligned.defineSubtype('hr');TP.html.Attrs.defineSubtype('i');TP.html.Attrs.defineSubtype('output');TP.html.Attrs.defineSubtype('meter');TP.html.Attrs.defineSubtype('progress');TP.html.Attrs.defineSubtype('small');TP.html.Attrs.defineSubtype('sub');TP.html.Attrs.defineSubtype('summary');TP.html.Attrs.defineSubtype('sup');TP.html.Attrs.defineSubtype('time');TP.html.Attrs.defineSubtype('tt');
TP.boot.$srcPath = '~lib_src/xhtml/html_ScriptingModuleNodes.js';
TP.html.Attrs.defineSubtype('command');TP.html.Attrs.defineSubtype('keygen');TP.html.Attrs.defineSubtype('noscript');TP.html.Attrs.defineSubtype('script');TP.html.script.set('uriAttrs',TP.ac('src'));TP.html.script.Type.defineMethod('$xmlifyContent',function(a){return a;});
TP.boot.$srcPath = '~lib_src/xhtml/html_StructureModuleNodes.js';
TP.html.Attrs.defineSubtype('article');TP.html.Attrs.defineSubtype('aside');TP.html.Attrs.defineSubtype('body');TP.html.body.set('uriAttrs',TP.ac('background'));TP.html.Attrs.defineSubtype('figcaption');TP.html.Attrs.defineSubtype('figure');TP.html.Attrs.defineSubtype('footer');TP.html.Attrs.defineSubtype('head');TP.html.head.Type.defineMethod('tagTidy',function(a){TP.ifTrace(TP.sys.cfg('log.css_processing'))?TP.trace('Merging css:sheet elements into css:sheetset',TP.CSS_LOG,arguments):0;return;});TP.html.Attrs.defineSubtype('header');TP.html.Attrs.defineSubtype('hgroup');TP.html.Attrs.defineSubtype('html');TP.html.html.Type.defineMethod('tagAttachData',function(b){var a;a=TP.nodeGetDocument(b.at('node'));TP.signal(a,'TP.sig.DOMModelConstruct');TP.signal(a,'TP.sig.DOMModelConstructDone');return;});TP.html.html.Type.defineMethod('tagTidy',function(i){var f,a,d,b,e,g,c,h;f=i.at('node');a=TP.nodeGetDocument(f);if(TP.isDocument(a)){d=TP.nodeGetElementsByTagName(a,'head').at(0);if(TP.isElement(d)){b=TP.nodeEvaluateXPath(d,TP.join('./*[','local-name() != "base" and ','local-name() != "link" and ','local-name() != "meta" and ','local-name() != "object" and ','local-name() != "script" and ','local-name() != "style" and ','local-name() != "title" and ','namespace-uri() != "',TP.w3.Xmlns.CSSML,'"',']'),TP.NODESET);}if(TP.notEmpty(b)){e=TP.nodeGetElementsByTagName(a,'body').at(0);if(TP.isElement(e)){g=b.getSize();for(c=0;c<g;c++){h=b.at(c);e.appendChild(h);}}}}return TP.CONTINUE;});TP.html.Attrs.defineSubtype('nav');TP.html.Attrs.defineSubtype('section');TP.html.Attrs.defineSubtype('title');
TP.boot.$srcPath = '~lib_src/xhtml/html_StylesheetModuleNodes.js';
TP.html.Attrs.defineSubtype('style');TP.html.style.Type.defineMethod('tagPrecompile',function(c){var a,e,f,b,g,d,h;TP.debug('break.css_processing');if(!TP.sys.cfg('css.process_styles')){return TP.CONTINUE;}if(TP.notValid(a=c.at('node'))){return c.fail(TP.FAILURE,'Unable to find command node.');}e=TP.ifInvalid(TP.elementGetAttribute(a,'src'),'.');f=TP.nodeGetTextContent(a);b=TP.ac();TP.regex.CSS_IMPORT_RULE.lastIndex=0;g=f.replace(TP.regex.CSS_IMPORT_RULE,function(g,h,c){var d,a,f;a=c.unquoted();a=/\//.test(a)?a:'./'+a;if(TP.notValid(d=TP.uc(TP.uriResolvePaths(e,a)))){f=TP.join('/* ',TP.sc('Invalid import URL: '),c,' */');return f;}b.push('<html:link type="text/css" rel="stylesheet"',' href="',d.getLocation(),'" ','xmlns:html="',TP.w3.Xmlns.XHTML,'"/>');return'/* Externalized '+c+' import. */\n';});b.push('<css:sheet type="inline" xmlns:css="',TP.w3.Xmlns.CSSML,'">','<![CDATA[',g,']]></css:sheet>');h=b.join('');d=TP.fragmentFromString(h);if(TP.notValid(d)){return c.fail(TP.FAILURE,'Unable to create new css:sheet node for inline TP.html.style.');}TP.nodeReplaceChild(a.parentNode,d,a);return;});
TP.boot.$srcPath = '~lib_src/xhtml/html_TableModuleNodes.js';
TP.html.Attrs.defineSubtype('tcell');TP.html.tcell.isAbstract(true);TP.html.tcell.defineSubtype('tcolumn');TP.html.tcolumn.isAbstract(true);TP.html.Aligned.defineSubtype('caption');TP.html.tcolumn.defineSubtype('col');TP.html.tcolumn.defineSubtype('colgroup');TP.html.Attrs.defineSubtype('table');TP.backstop(TP.ac('createCaption','createTFoot','createTHead','deleteCaption','deleteRow','deleteTFoot','deleteTHead','insertRow'),TP.html.table.getInstPrototype());TP.html.table.Type.defineMethod('generateMarkup',function(e,f,h,g,i,b){var a,c,d;a=this.getTagName();if(TP.isTrue(g)&&TP.isTrue(b.at('repeat'))){c=TP.join('<',a,f,'>','{{value%TP.html.tr}}','</',a,'>');d=c.transform(e,b);return d;}return this.callNextMethod();});TP.html.table.Type.defineMethod('getItemTagName',function(){return'html:tr';});TP.html.table.Type.defineMethod('shouldAutoWrapItems',function(b,a){if(TP.isBoolean(a.at('autowrap'))){return a.at('autowrap');}return false;});TP.html.tcell.defineSubtype('tbody');TP.backstop(TP.ac('deleteRow','insertRow'),TP.html.tbody.getInstPrototype());TP.html.tbody.Inst.defineMethod('refresh',function(a){return this;});TP.html.tcell.defineSubtype('td');TP.html.tcell.defineSubtype('tfoot');TP.html.tcell.defineSubtype('th');TP.html.tcell.defineSubtype('thead');TP.html.tcell.defineSubtype('tr');TP.backstop(TP.ac('deleteCell','insertCell'),TP.html.tr.getInstPrototype());TP.html.tr.Type.defineMethod('generateMarkup',function(b,g,c,h,i,d){var a,e,f;if(TP.isArray(b)){}else if(TP.isTrue(h)&&TP.isTrue(d.at('repeat'))){a=this.getTagName();e=TP.join('<',a,g,'>','{{0%',c,'}}','{{1%',c,'}}','</',a,'>');f=e.transform(b,d);return f;}return this.callNextMethod();});TP.html.tr.Type.defineMethod('getItemTagName',function(){return'html:td';});TP.html.tr.Type.defineMethod('shouldAutoWrapItems',function(b,a){if(TP.isBoolean(a.at('autowrap'))){return a.at('autowrap');}if(TP.isArray(b)){return false;}return true;});
TP.boot.$srcPath = '~lib_src/xhtml/html_TextModuleNodes.js';
TP.html.Attrs.defineSubtype('abbr');TP.html.Attrs.defineSubtype('acronym');TP.html.Attrs.defineSubtype('address');TP.html.Citation.defineSubtype('blockquote');TP.html.blockquote.set('uriAttrs',TP.ac('cite'));TP.html.CoreAttrs.defineSubtype('br');TP.html.Citation.defineSubtype('cite');TP.html.Attrs.defineSubtype('code');TP.html.Attrs.defineSubtype('dfn');TP.html.Aligned.defineSubtype('div');TP.html.Attrs.defineSubtype('em');TP.html.Aligned.defineSubtype('h1');TP.html.Aligned.defineSubtype('h2');TP.html.Aligned.defineSubtype('h3');TP.html.Aligned.defineSubtype('h4');TP.html.Aligned.defineSubtype('h5');TP.html.Aligned.defineSubtype('h6');TP.html.Attrs.defineSubtype('kbd');TP.html.Attrs.defineSubtype('mark');TP.html.Aligned.defineSubtype('p');TP.html.Attrs.defineSubtype('pre');TP.html.Citation.defineSubtype('q');TP.html.q.set('uriAttrs',TP.ac('cite'));TP.html.Attrs.defineSubtype('ruby');TP.html.Attrs.defineSubtype('rp');TP.html.Attrs.defineSubtype('rt');TP.html.Attrs.defineSubtype('samp');TP.html.Attrs.defineSubtype('span');TP.html.Attrs.defineSubtype('strong');TP.html.Attrs.defineSubtype('var');TP.html.Attrs.defineSubtype('wbr');
TP.boot.$srcPath = '~lib_src/sig/sig_.js';
TP.core.XMLNamespace.defineSubtype('sig:XMLNS');TP.sig.XMLNS.Type.defineMethod('dispatchSignal',function(c){var b,i,d,a,j,h,e,f,k,g;if(TP.isEmpty(b=TP.elementGetAttribute(c,'sig:name',true))){return;}b=TP.isType(TP.sys.require(i=TP.expandSignalName(b)))?i:b;d=TP.elementGetAttribute(c,'sig:origin',true);if(d==='*'){a=TP.ANY;}else{if(TP.isEmpty(d)){a=TP.ac(c);}else{if(TP.isEmpty(a=TP.unwrap(TP.byPath(d)))){a=TP.ac(TP.unwrap(TP.byOID(d)));}}if(TP.notValid(a)){if(TP.isWindow(j=TP.nodeGetWindow(c))){if(TP.notValid(a=TP.ac(TP.byId(d,j)))){return;}}}}if(TP.notEmpty(h=TP.elementGetAttribute(c,'sig:payload',true))){e=TP.lang.Hash.from(h);}if(a===TP.ANY){TP.signal(null,b,arguments,e);}else if(TP.notEmpty(a)){if(TP.isType(k=TP.sys.getTypeByName(b))){g=k.getDefaultPolicy();}else{g=TP.DOM_FIRING;}a.perform(function(a){if(TP.isElement(a)){f=TP.nodeGetWindow(a);if(TP.notValid(f)){TP.ifWarn()?TP.warn('No window for target. Defaulting to '+'codeframe.',TP.LOG,arguments):0;f=window;}f.TP.dispatch(null,b,a,e,g,TP.elementGetAttribute(c,'ev:cancelable',true),TP.elementGetAttribute(c,'ev:bubbles',true));}else{TP.signal(a,b,arguments,e);}});}return;});
TP.boot.$srcPath = '~lib_src/sig/sig_dispatch.js';
TP.core.ActionElementNode.defineSubtype('sig:dispatch');TP.sig.dispatch.Type.defineMethod('shouldFailOnEmptyInput',function(){return false;});TP.sig.dispatch.Type.defineMethod('tshExecute',function(f){var b,c,k,e,a,j,i,d,g,l,h;if(TP.notValid(b=f.at('cmdNode'))){f.fail();return TP.BREAK;}if(TP.isEmpty(c=TP.elementGetAttribute(b,'sig:name',true))){f.fail(TP.FAILURE,'Missing required "name" attribute.');return TP.BREAK;}c=TP.isType(TP.sys.require(k=TP.expandSignalName(c)))?k:c;e=TP.elementGetAttribute(b,'sig:origin',true);if(e==='*'){a=TP.ANY;}else{if(TP.isEmpty(e)){a=TP.ac(b);}else{if(TP.isEmpty(a=TP.unwrap(TP.byPath(e)))){a=TP.ac(TP.unwrap(TP.byOID(e)));}}if(TP.notValid(a)){if(TP.isWindow(j=TP.nodeGetWindow(b))){if(TP.notValid(a=TP.ac(TP.byId(e,j)))){f.fail(TP.FAILURE,'Specified "origin" element not found: '+TP.str(b));return TP.BREAK;}}}}if(TP.notEmpty(i=TP.elementGetAttribute(b,'sig:payload',true))){d=TP.lang.Hash.from(i);}else{d=this.getActionInput(f);if(TP.isArray(d)){d=d.collapse();}}if(a===TP.ANY){TP.signal(null,c,arguments,d);}else if(TP.notEmpty(a)){if(TP.isType(l=TP.sys.getTypeByName(c))){h=l.getDefaultPolicy();}else{h=TP.DOM_FIRING;}a.perform(function(a){if(TP.isElement(a)){g=TP.nodeGetWindow(a);if(TP.notValid(g)){TP.ifWarn()?TP.warn('No window for target. Defaulting to '+'codeframe.',TP.LOG,arguments):0;g=window;}g.TP.dispatch(null,c,a,d,h,TP.elementGetAttribute(b,'ev:cancelable',true),TP.elementGetAttribute(b,'ev:bubbles',true));}else{TP.signal(a,c,arguments,d);}});}return TP.CONTINUE;});
TP.boot.$srcPath = '~lib_src/sig/sig_action.js';
TP.core.ActionElementNode.defineSubtype('sig:action');TP.sig.action.Type.defineMethod('tshExecute',function(a){return TP.DESCEND;});
TP.boot.$srcPath = '~lib_src/tibet/xmlns/tibet_.js';
TP.core.XMLNamespace.defineSubtype('tibet:XMLNS');
TP.boot.$srcPath = '~lib_src/tibet/xmlns/tibet_group.js';
TP.core.UIElementNode.defineSubtype('tibet:group');TP.tibet.group.Type.defineMethod('tagAttachDOM',function(d){var b,a,c;if(!TP.isElement(b=d.at('node'))){return;}a=TP.tpnode(b);if(TP.notEmpty(c=a.getMembers())){c.perform(function(b){b.setGroupElement(a);});}return;});TP.tibet.group.Inst.defineMethod('findFocusableElements',function(b){var a;if(b){a=this.get('*[tabindex][tibet|group="'+this.getLocalID()+'"]'+', tibet|group');}else{a=this.get('*[tabindex][tibet|group="'+this.getLocalID()+'"]');}a=a.select(function(a){return TP.elementIsDisplayed(a);});return TP.wrap(a);});TP.tibet.group.Inst.defineMethod('focus',function(){var a;if(TP.notEmpty(a=this.findFocusableElements())){a.first().focus();}return this;});TP.tibet.group.Inst.defineMethod('getMembers',function(){var b,c,a;if(TP.isEmpty(b=this.getAttribute('tibet:query'))){b='./*';}if(TP.isEmpty(this.getChildElements())){c=this.getDocument().getDocumentElement();}else{c=this;}if(TP.notValid(a=c.get(b))){return TP.ac();}a=a.select(function(a){return TP.isElement(a);});a=TP.wrap(a);return a;});TP.tibet.group.Inst.defineMethod('getMemberGroups',function(){var a,b;if(TP.isEmpty(a=this.getMembers())){return TP.ac();}b=a.select(function(a){return TP.isKindOf(a,TP.tibet.group);});return b;});
TP.boot.$srcPath = '~lib_src/tsh/tsh_.js';
TP.core.XMLNamespace.defineSubtype('tsh:XMLNS');
TP.boot.$srcPath = '~lib_src/tsh/tsh_Element.js';
TP.core.ElementNode.defineSubtype('tsh:Element');
TP.boot.$srcPath = '~lib_src/tsh/tsh_cmd.js';
TP.core.ActionElementNode.defineSubtype('tsh:cmd');TP.tsh.cmd.addTraitsFrom(TP.tsh.Element);TP.tsh.cmd.Type.defineAttribute('$tshOperators',TP.ac('^'));TP.tsh.cmd.Type.defineMethod('$desugarTSH',function(H,h,a,E){var D,n,B,s,j,F,G,g,k,A,c,b,i,d,x,f,q,u,l,w,m,t,y,C,p,z,e,r,v,o;TP.debug('break.tsh_desugar');g=H;k=TP.$condenseJS(g,false,false,this.$tshOperators,true,true,true);A=k.length;c=0;if(TP.notValid(b=k[c])){return g;}m=false;t=0;d=TP.ac();r=TP.ac();switch(b.value){case'\\':c+=1;break;case'^':TP.debug('break.tsh_history');y=h.getHistory().at(-2);if(TP.isValid(y)){C=y.at('cmd');p=g.split('^');z=TP.rc(p.at(1),TP.ifInvalid(p.at(3),''));if(TP.notValid(z)){w=TP.join(TP.sc('Invalid history regexp substitution: '),p.at(1),' ',TP.ifInvalid(p.at(3),''));a.fail(TP.FAILURE,w);return;}g=C.replace(z,p.at(2));e=TP.sig.ShellRequest.construct(TP.hc('cmd',g,'cmdAllowSubs',a.at('cmdAllowSubs'),'cmdAsIs',a.at('cmdAsIs'),'cmdExecute',true,'cmdHistory',a.at('cmdHistory'),'cmdInteractive',a.at('cmdInteractive'),'cmdLiteral',a.at('cmdLiteral'),'cmdPeer',a,'cmdPhases',a.at('cmdPhases'),'cmdRecycle',a.at('cmdRecycle'),'cmdShell',a.at('cmdShell'),'cmdSilent',a.at('cmdSilent')));e.defineMethod('cancel',function(b,c){return a.cancel(TP.ifInvalid(b,TP.FAILURE),TP.ifInvalid(c,TP.sc('History request cancelled.')));});e.defineMethod('complete',function(b){if(arguments.length>0){return a.complete(b);}else{return a.complete();}});e.defineMethod('fail',function(b,c){return a.fail(TP.ifInvalid(b,TP.FAILURE),TP.ifInvalid(c,TP.sc('History request failed.')));});h.handleShellRequest(e);return;}else{w=TP.sc('No previous command to edit.');a.fail(TP.FAILURE,w);return;}break;case'function':m=true;d.push(b.value);c+=1;break;default:if(TP.$is_identifier(b.name)){if(TP.isValid(h)){x=h.getAlias(b.value);}if(x!==b.value){TP.debug('break.tsh_alias');g=this.$interpolateAlias(x,k.slice(1));g=this.$desugarTSH(g,h,a,E);if(a.didComplete()){return;}e=TP.sig.ShellRequest.construct(TP.hc('cmd',g,'cmdAllowSubs',a.at('cmdAllowSubs'),'cmdAsIs',a.at('cmdAsIs'),'cmdExecute',true,'cmdHistory',a.at('cmdHistory'),'cmdInteractive',a.at('cmdInteractive'),'cmdLiteral',a.at('cmdLiteral'),'cmdPeer',a,'cmdPhases',a.at('cmdPhases'),'cmdShell',a.at('cmdShell'),'cmdRecycle',a.at('cmdRecycle'),'cmdSilent',a.at('cmdSilent')));e.defineMethod('cancel',function(b,c){return a.cancel(TP.ifInvalid(b,TP.FAILURE),TP.ifInvalid(c,TP.sc('Aliased request cancelled.')));});e.defineMethod('complete',function(b){if(arguments.length>0){return a.complete(b);}else{return a.complete();}});e.defineMethod('fail',function(b,c){return a.fail(TP.ifInvalid(b,TP.FAILURE),TP.ifInvalid(c,'Aliased request failed: '+this.at('cmd')));});e.defineMethod('stderr',function(b,c){return a.stderr(b,c);});e.defineMethod('stdin',function(){return a.stdin();});e.defineMethod('stdout',function(b,c){return a.stdout(b,c);});h.handleShellRequest(e);return;}else{o=b.value;TP.regex.TSH_VARSUB_EXTENDED.lastIndex=0;o=o.replace(TP.regex.TSH_VARSUB_EXTENDED,'$$$1');if(TP.isValid(f=k.at(c+1))){q=2;while(f&&TP.$is_whitespace(f.name)){f=k.at(c+q);q++;}if(f&&f.value==='='){if(TP.notDefined(TP.global[o])){r.push(o);}}}d.push(o);c+=1;}}break;}n=a;B=n.at('cmdNode');s=h;D=s.get('previous');j=h.getExecutionContext(n);F=h.getExecutionInstance(n);j.$LASTREQ=D;j.$REQUEST=n;j.$NODE=B;j.$SHELL=s;j.$CONTEXT=j;j.$SCOPE=F;j.$SCRIPT=G;j.$_=null;while(b=k[c]){switch(b.name){case'substitution':i=this.expandContent(b.value,s,n);d.push(i);c+=1;break;case'string':if(b.value.indexOf('"')===0){i=this.$desugarTSH(b.value.unquoted('"'),h,a,false);if(a.didComplete()){return;}if(TP.regex.HAS_ACP.test(i)){i=i.transform(s.getExecutionInstance(n));}d.push('"',i,'"');}else{d.push(b.value);}c+=1;break;case'operator':if(b.value==='{'){if(m){t++;}}else if(b.value==='}'){if(m){t--;if(t===0){m=false;}}}d.push(b.value);c+=1;break;default:if(b.value==='function'){m=true;d.push(b.value);c+=1;break;}if(TP.notTrue(m)&&TP.$is_identifier(b.name)){if(TP.isValid(f=k.at(c+1))){q=2;while(f&&TP.$is_whitespace(f.name)){f=k.at(c+q);q++;}if(f&&f.value==='='){u=d.getSize()-1;l=d.at(u);while(l){if(l===';'){break;}else if(TP.regex.WHITESPACE.test(l)){u--;l=d[u];}else{l=null;}}if(l===';'&&TP.notDefined(TP.global[b.value])){d.push('$SCOPE','.');r.push(b.value);}}}}d.push(b.value);c+=1;break;}}if(TP.notEmpty(r)){v=TP.ac();A=d.length;for(c=0;c<A;c++){i=d[c];if(r.containsString(i)){if(d[c-1]!=='.'){v.push('$SCOPE','.');}}v.push(i);}d=v;}if(TP.isTrue(E)){return d;}return d.join('');});TP.tsh.cmd.Type.defineMethod('$interpolateAlias',function(o,j){var i,h,b,d,a,f,c,e,g,n,k,m,l;TP.debug(TP.sys.cfg('break.tsh_alias')||TP.sys.cfg('break.tsh_interpolate'));if(!TP.regex.VARSUB.test(o)){return o+j.collect(function(a){return a.value;}).join('');}i=TP.ac();h=TP.hc();b=0;d=[];a=j[b];while(a){if(TP.$is_identifier(a.name)){f=j[b+1];while(f&&f.value!=='='&&!TP.$is_whitespace(f.name)){b+=1;a.value+=f.value;f=j[b+1];}}d.push(a);b+=1;a=j[b];}b=0;a=d[b];while(a){if(TP.$is_identifier(a.name)){f=d[b+1];if(f&&f.value==='='){c=d[b+2];if(c){h.atPut(a.value,c.value);b+=3;a=d[b];continue;}}}if(!TP.$is_whitespace(a.name)){i.push(a.value);}b+=1;a=d[b];}d=TP.$tokenize(o,TP.tsh.script.$tshOperators,true,false,true,true);b=0;a=d[b];e=TP.ac();while(a){if(a.name==='substitution'&&a.value.charAt(0)==='$'){g=a.value.slice(2,a.value.length-1);if(g.indexOf('|')!==-1){n=g.split('|');g=n.at(0);k=n.at(1);}l=TP.nc(g);if(TP.isNumber(l)){c=i.at(l);if(TP.isDefined(c)){i.atPut(l,'');if(TP.notEmpty(k)){e.push(TP.format(c,k));}else{e.push(c);}}else{e.push(a.value);}}else{c=h.at(g);if(TP.isDefined(c)){h.removeKey(g);if(TP.notEmpty(k)){e.push(TP.format(c,k));}else{e.push(c);}}else{e.push(a.value);}}}else{e.push(a.value);}b+=1;a=d[b];}m=e.join('');if(TP.notEmpty(h)){m+=' '+h.asQueryString(' ');}if(TP.notEmpty(i)){m+=' '+i.join(' ');}return m;});TP.tsh.cmd.Type.defineMethod('isAccessPath',function(d){var c,a,b;if(TP.isEmpty(c=d)||c.getSize()<2){return false;}b=0;a=c[b];if(!TP.$is_identifier(a.name)){return false;}b+=1;a=c[b];if(a.value!=='.'){return false;}b+=1;a=c[b];while(a){if(!TP.$is_identifier(a.name)&&a.name!=='number'&&a.value!=='.'&&a.value!==','&&a.value!=='-'&&a.value!=='['&&a.value!==']'&&a.value!==':'){return false;}b+=1;a=c[b];}return true;});TP.tsh.cmd.Type.defineMethod('cmdAddContent',function(a){return this.cmdRunContent(a,TP.ADD);});TP.tsh.cmd.Type.defineMethod('cmdFilterInput',function(a){return this.cmdRunContent(a,TP.FILTER);});TP.tsh.cmd.Type.defineMethod('cmdGetContent',function(p){var l,i,j,d,h,e,o,q,k,n,a,f,g,c,m,b;TP.debug(TP.sys.cfg('break.tsh_fetch')||TP.sys.cfg('break.tsh_cmd'));a=p;f=a.at('cmdNode');g=a.at('cmdShell');n=g.get('previous');b=TP.nodeGetTextContent(f);if(TP.isBlank(b)){a.complete();return;}if(f.getAttribute('tsh:literal')!=='true'&&a.at('cmdLiteral')!==true){b=this.$desugarTSH(b,g,a);if(a.didComplete()){return;}TP.nodeSetTextContent(f,b);}h=TP.$condenseJS(b,false,false,this.$tshOperators,true,true,true);if(this.isAccessPath(h)){q=true;b=h[0].value+'.get(TP.apc(\''+h.slice(2).collect(function(a){return a.value;}).join('')+'\'));';TP.nodeSetTextContent(f,b);}try{c=g.getExecutionContext(a);m=g.getExecutionInstance(a);c.$LASTREQ=n;c.$REQUEST=a;c.$NODE=f;c.$SHELL=g;c.$CONTEXT=c;c.$SCOPE=m;c.$SCRIPT=b;c.$_=null;if(b.charAt(0)==='{'&&b.charAt(b.length-1)==='}'){b='('+b+')';}if(Function.$$getNameRegex.test(b)){b='('+b+')';}o='with ($SCOPE) {'+b+'};';l=Date.now();d=c.eval(o);i=Date.now();j=TP.ifInvalid(a.get('$evaltime'),0);a.set('$evaltime',j+(i-l));if(TP.canInvoke(d,'cmdGetContent')){d=d.cmdGetContent(a);}else if(TP.isType(k=TP.type(d))){if(TP.canInvoke(k,'cmdGetContent')){a.atPut('cmdInstance',d);d=k.cmdGetContent(a);}}a.complete(d);}catch(c){i=Date.now();j=TP.ifInvalid(a.get('$evaltime'),0);a.set('$evaltime',j+(i-l));if(TP.sys.cfg('tsh.ignore_eval_errors')===true){a.complete(undefined);}else{e=TP.str(c);if(e.contains(' &#171; ')){e=TP.trim(e.slice(0,e.indexOf(' &#171; ')));}if(/[sS]yntax/.test(e)){d=e+': '+b;}else{d=e.endsWith('.')?e:e+'.';}a.fail(TP.FAILURE,d);}}return;});TP.tsh.cmd.Type.defineMethod('cmdRunContent',function(t,s){var m,b,g,d,r,p,l,k,h,n,o,a,i,q,j,f,e,c;TP.debug('break.tsh_cmd');a=t;j=a.at('cmdShell');o=j.$LASTREQ;o=j.get('previous');i=a.at('cmdNode');q=TP.wrap(i);c=TP.trim(TP.nodeGetTextContent(i));if(TP.isBlank(c)){a.complete();return;}f=j.getExecutionContext(a);e=j.getExecutionInstance(a);f.$LASTREQ=o;f.$REQUEST=a;f.$NODE=i;f.$SHELL=j;f.$CONTEXT=f;f.$SCOPE=e;f.$SCRIPT=c;m=TP.elementGetAttribute(i,'tsh:pipe',true);if(TP.$is_ioend(m)){m=null;}if(i.getAttribute('tsh:literal')!=='true'&&a.at('cmdLiteral')!==true){c=this.$desugarTSH(c,j,a);if(a.didComplete()){return;}TP.nodeSetTextContent(i,c);}if(TP.isBlank(c)){return;}n=s;switch(s){case'add':case'set':g=TP.$condenseJS(c,false,false,this.$tshOperators,true,true,true);if(g.length===1){d=g[0];if(d&&TP.$is_identifier(d.name)){if(TP.notDefined(e[d.value])){c='$SCOPE.'+d.value+' = $INPUT';TP.nodeSetTextContent(i,c);n='var';}}else{}}else if(this.isAccessPath(g)){l=true;c=g[0].value+'.set(TP.apc(\''+g.slice(2).collect(function(a){return a.value;}).join('')+'\').set(\'makeStruct\', true), $INPUT);';TP.nodeSetTextContent(i,c);}else{}break;default:if(TP.notEmpty(m)){g=TP.$condenseJS(c,false,false,this.$tshOperators,true,true,true);if(g.length===1){r=m.indexOf('?')!==TP.NOT_FOUND;d=g[0];switch(d.name){case'regexp':p=TP.rc(d.value.slice(1,d.value.lastIndexOf('/')),d.value.slice(d.value.lastIndexOf('/')+1));if(TP.notValid(p)){b='Invalid RegExp filter: '+d.value.slice(1,d.value.lastIndexOf('/'))+' '+d.value.slice(d.value.lastIndexOf('/')+1);a.fail(TP.FAILURE,b);return;}a.atPut('cmdInstance',p);if(r){RegExp.cmdFilterInput(a);}else{RegExp.cmdTransformInput(a);}return;case'string':a.atPut('cmdInstance',d.value);if(r){String.cmdFilterInput(a);}else{String.cmdTransformInput(a);}return;default:}}else if(this.isAccessPath(g)){l=true;c=g[0].value+'.get(TP.apc(\''+g.slice(2).collect(function(a){return a.value;}).join('')+'\'), $INPUT);';TP.nodeSetTextContent(i,c);}else{}}else{a.atPut('cmdLiteral',true);TP.nodeSetTextContent(i,c);if(!q.isLastSegment()&&q.getDownstreamSegment().getRedirectionType()!==TP.GET){return this.cmdGetContent(a);}}break;}k=function(o){var h,n,j,g,m,l,d,i,k;TP.debug('break.tsh_execute');h=a.stdin();n=a.at('cmdIterate');j=h.getSize();if(j===0){h=TP.ac(null);j=1;}if(c.charAt(0)==='{'&&c.charAt(c.length-1)==='}'){c='('+c+')';}if(Function.$$getNameRegex.test(c)){c='('+c+')';}k='with ($SCOPE) {'+c+'};';for(g=0;g<j;g++){e.$INPUT=h.at(g);try{m=Date.now();if(n){if(TP.isCollection(e.$INPUT)){b=e.$INPUT.collect(function(a,b){e.$INDEX=b;e.$_=a;return f.eval(k);});}else{e.$_=e.$INPUT;b=TP.ac(f.eval(k));}}else{e.$_=e.$INPUT;b=f.eval(k);}l=Date.now();i=TP.ifInvalid(a.get('$evaltime'),0);a.set('$evaltime',i+(l-m));if(TP.notFalse(o)){a.complete(b);}}catch(e){l=Date.now();i=TP.ifInvalid(a.get('$evaltime'),0);a.set('$evaltime',i+(l-m));if(TP.sys.cfg('tsh.ignore_eval_errors')===true){a.complete(undefined);}else{d=TP.str(e);d=d.indexOf(':: file:')===TP.NOT_FOUND?TP.trim(d):TP.trim(d.slice(0,d.indexOf(':: file:')));if(/[sS]yntax/.test(d)){b=d+': '+c;}else if(/missing ; before statement/.test(d)){b='syntax error: '+c;}else{b=d.endsWith('.')?d:d+'.';}a.fail(TP.FAILURE,b);}return;}}};switch(n){case'var':a.atPut('cmdIterate',false);k();break;case TP.ADD:a.atPut('cmdIterate',false);k(TP.ifInvalid(l,false));if(a.didComplete()){return;}if(TP.canInvoke(b,'cmdAddContent')){b=b.cmdAddContent(a);}else if(TP.isType(h=TP.type(b))){if(TP.canInvoke(h,'cmdAddContent')){a.atPut('cmdInstance',b);b=h.cmdAddContent(a);}else{a.fail(TP.FAILURE,'Invalid sink.');}}else if(!TP.isMutable(b)){a.fail(TP.FAILURE,'Non-mutable sink.');}else{a.fail(TP.FAILURE,'Missing sink.');}break;case TP.FILTER:k(TP.ifInvalid(l,false));if(a.didComplete()){return;}if(/\$INPUT/.test(c)!==true&&/\$_/.test(c)!==true){if(TP.canInvoke(b,'cmdFilterInput')){b=b.cmdFilterInput(a);}else if(TP.isType(h=TP.type(b))){if(TP.canInvoke(h,'cmdFilterInput')){a.atPut('cmdInstance',b);b=h.cmdFilterInput(a);}else{a.fail(TP.FAILURE,'Invalid pipe.');}}else{a.complete(b);}}else{a.complete(b);}break;case TP.SET:a.atPut('cmdIterate',false);k(TP.ifInvalid(l,false));if(a.didComplete()){return;}if(TP.canInvoke(b,'cmdSetContent')){b=b.cmdSetContent(a);}else if(TP.isType(h=TP.type(b))){if(TP.canInvoke(h,'cmdSetContent')){a.atPut('cmdInstance',b);b=h.cmdSetContent(a);}else{a.fail(TP.FAILURE,'Invalid sink.');}}else if(!TP.isMutable(b)){a.fail(TP.FAILURE,'Non-mutable sink.');}else{a.fail(TP.FAILURE,'Missing sink.');}break;case TP.TRANSFORM:k(TP.ifInvalid(l,false));if(a.didComplete()){return;}if(/\$INPUT/.test(c)!==true&&/\$_/.test(c)!==true){if(TP.canInvoke(b,'cmdTransformInput')){b=b.cmdTransformInput(a);}else if(TP.isType(h=TP.type(b))){if(TP.canInvoke(h,'cmdTransformInput')){a.atPut('cmdInstance',b);b=h.cmdTransformInput(a);}else{a.fail(TP.FAILURE,'Invalid pipe.');}}else{a.complete(b);}}else{a.complete(b);}break;default:k();break;}return;});TP.tsh.cmd.Type.defineMethod('cmdSetContent',function(a){return this.cmdRunContent(a,TP.SET);});TP.tsh.cmd.Type.defineMethod('cmdTransformInput',function(a){return this.cmdRunContent(a,TP.TRANSFORM);});TP.tsh.cmd.Type.defineMethod('expandContent',function(m,p,g){var h,i,o,e,n,f,c,k,b,d,a,l,j;e=g;f=p;k=f.getExecutionInstance(e);h=TP.ac();a=m;if(TP.regex.HAS_ACP.test(a)){TP.regex.TSH_VARSUB_EXTENDED.lastIndex=0;a=a.replace(TP.regex.TSH_VARSUB_EXTENDED,'$$$1');l=TP.ac();TP.regex.TSH_VARSUB_EXTRACT.lastIndex=0;TP.regex.TSH_VARSUB_EXTRACT.performWith(function(b,a){l.push('$'+a);},a);a=a.transform(k,TP.hc('sourcevars',l));}else{TP.regex.TSH_VARSUB_EXTENDED.lastIndex=0;a=a.replace(TP.regex.TSH_VARSUB_EXTENDED,'$$$1');}j=false;if(a.indexOf('`')===0){j=true;a=a.slice(1,-1);}b=f.resolveVariableSubstitutions(a);if(j===true){if(TP.notTrue(TP.ifKeyInvalid(g,'cmdInteractive',false))&&TP.notTrue(TP.ifKeyInvalid(g,'cmdAllowSubs',false))){g.fail(TP.FAILURE,TP.sc(TP.join('Security violation. Attempt to use',' command substitution outside of',' interactive mode.')));return;}if(TP.regex.TSH_DEREF_SUGAR.test(a)){a=a.slice(1);}b=a;n=e.at('cmdNode');o=f.get('previous');c=p.getExecutionContext(e);c.$LASTREQ=o;c.$REQUEST=e;c.$NODE=n;c.$SHELL=f;c.$CONTEXT=c;c.$SCOPE=k;c.$SCRIPT=b;c.$_=null;try{c.$SCRIPT=b;if(b.charAt(0)==='{'&&b.charAt(b.length-1)==='}'){b='('+b+')';}if(Function.$$getNameRegex.test(b)){b='('+b+')';}b='with ($SCOPE) {'+b+'};';i=c.eval(b);}catch(a){if(TP.sys.cfg('tsh.ignore_eval_errors')===true){i='undefined';}else{d=TP.str(a);d=d.indexOf(':: file:')===TP.NOT_FOUND?TP.trim(d):TP.trim(d.slice(0,d.indexOf(':: file:')));d=d.endsWith('.')?d:d+'.';e.fail(TP.FAILURE,TP.join(TP.sc('Command substitution `'),m.slice(1,-1),TP.sc('` failed: '),d));}}if(g.didComplete()){return;}h.push(i);}else{h.push(a);}return h.join('');});TP.tsh.cmd.Type.defineMethod('tshExecute',function(a){TP.debug('break.tsh_cmd');this.raise('TP.sig.InvalidOperation',arguments);return TP.BREAK;});
TP.boot.$srcPath = '~lib_src/tsh/tsh_history.js';
TP.core.ActionElementNode.defineSubtype('tsh:history');TP.tsh.history.addTraitsFrom(TP.tsh.Element);TP.tsh.history.Type.defineMethod('cmdRunContent',function(a){var g,d,f,h,i,c,b,j,e;TP.debug('break.tsh_history');g=a.at('cmdNode');d=a.at('cmdShell');f=TP.elementGetAttribute(g,'tsh:hid',true);if(TP.isEmpty(f)){h=TP.hc();i=0;d.get('history').perform(function(a){h.atPut(i++,a.at('cmd'));});return a.complete(h);}c=this.translateHistoryReference(f,a,d);if(TP.isEmpty(c)){a.fail();return;}if(c===f){a.fail(TP.FAILURE,TP.sc('History translation failed.'));return;}if(c.indexOf('tsh:history')!==TP.NOT_FOUND){a.fail(TP.FAILURE,TP.sc('Recursive history translation unsupported.'));return;}if(TP.notValid(e=a.at('rootRequest'))){e=a;}j=TP.elementGetAttribute(g,'tsh:edit',true);if(TP.bc(j)){b=TP.sig.ConsoleRequest.construct(TP.hc('cmd','input','body',c));b.fire(d);e.getResponse().atPut('cmdInput',true);return a.complete();}b=TP.sig.ShellRequest.construct(TP.hc('cmd',c,'cmdAllowSubs',a.at('cmdAllowSubs'),'cmdAsIs',a.at('cmdAsIs'),'cmdExecute',true,'cmdHistory',a.at('cmdHistory'),'cmdInteractive',a.at('cmdInteractive'),'cmdLiteral',a.at('cmdLiteral'),'cmdPeer',a,'cmdPhases',a.at('cmdPhases'),'cmdRecycle',a.at('cmdRecycle'),'cmdSilent',a.at('cmdSilent')));e.atPut('cmdTitle',c);b.defineMethod('cancelJob',function(b,c){return a.cancel(b,c);});b.defineMethod('completeJob',function(c){return a.complete(c||b.getResult());});b.defineMethod('failJob',function(b,c){return a.fail(b,c);});d.handleShellRequest(b);return;});TP.tsh.history.Type.defineMethod('translateHistoryReference',function(c,h,d){var j,f,n,l,q,k,p,m,b,i,a,g,e,r,s,o;j='';if(c==='!'){k=d.getHistory(-2,true);}else if(c.charAt(0)==='/'){f=TP.$tokenize(c);n=f.at(0);if(TP.notValid(n)||n.name!=='regexp'){h.fail(TP.FAILURE,TP.sc('Invalid history regex specification'));return;}l=n.value.split('/');q=TP.rc(RegExp.escapeMetachars(l.at(1)),l.at(2));if(TP.notValid(q)){h.fail(TP.FAILURE,TP.sc('Invalid history regex specification'));return;}k=d.getHistory(q,true);}else if(/^[\-0-9]/.test(c)){l=c.split(':');p=l.at(0);m=p==='0'?0:parseInt(p,10);if(!TP.isNumber(m)){h.fail(TP.FAILURE,TP.sc('Invalid history index.'));return;}if(c.charAt(0)==='-'){m-=1;}k=d.getHistory(m,true);}else{k=d.getHistory(c,true);}if(TP.isEmpty(k)){h.fail(TP.FAILURE,TP.sc('Unable to find specified history entry.'));return;}if(!TP.regex.HAS_COLON.test(c)){return k;}if(TP.regex.HAS_COLON.test(c)){if(/^:[^\+\-0-9]/.test(c)){b=c;}else if(/^:/.test(c)){b='!'+c;f=b.split(':');b=f.at(0);if(f.getSize()>1){f.shift();}}else{f=c.split(':');b=f.at(0);f.shift();i=f.join('');}}else{b=c;}if(/^[+\-]/.test(b)){if(b.getSize()===1){a=1;}else{a=b.slice(1);if(/^[0-9]/.test(a)){if(TP.isNaN(parseInt(a,10))){if(g=a.match(/[^0-9]/)){a=a.slice(0,g);j=a.slice(g);}else{h.fail(TP.FAILURE,TP.sc('Invalid history index.'));return;}}else{a=parseInt(a,10);}}else{h.fail(TP.FAILURE,TP.sc('Invalid history index.'));return;}}if(b.charAt(0)==='+'){a=d.get('historyIndex')+a-1;e=d.getHistory(a);}else{a=d.get('historyIndex')-a-1;e=d.getHistory(a);}}else{if(/^[0-9]/.test(b)){if(TP.isNaN(parseInt(b,10))){if(g=a.match(/[^0-9]/)){a=a.slice(0,g);j=a.slice(g);}else{h.fail(TP.FAILURE,TP.sc('Invalid history index.'));return;}}else{e=d.getHistory(parseInt(b,10));}}else{if(/^!/.test(b)){a=d.get('historyIndex')-1;e=d.getHistory(a);b=b.slice(1);if(TP.notValid(i)){j=b;}}else if(/^\?/.test(b)){return':history';}else{e='';r=TP.rc('^'+b);s=d.get('history');for(o=s.getSize()-1;o>=0;o--){if(r.test(e=d.getHistory(o))){break;}}}}}if(TP.notValid(i)){return TP.ifInvalid(e+j,'');}if(TP.isNaN(parseInt(i,10))){if(g=i.match(/[^0-9]/)){a=i.slice(0,g);j=i.slice(g);}else{h.fail(TP.FAILURE,TP.sc('Invalid history index.'));return;}}else{a=i;}e=e.split(' ').at(a);return TP.isString(e)?e+j:'';});
TP.boot.$srcPath = '~lib_src/tsh/tsh_lint.js';
TP.core.ActionElementNode.defineSubtype('tsh:lint');TP.tsh.lint.addTraitsFrom(TP.tsh.Element);TP.tsh.lint.Type.defineMethod('cmdRunContent',function(a){var e,c,b,d;TP.debug('break.tsh_lint');e=a.at('cmdNode');c=a.at('cmdShell');b=c.getArgument(a,'ARG0');if(TP.isEmpty(b)){a.stdout('Assembling full coverage worklist.');}else{d=c.resolveObjectReference(b,a);if(TP.notValid(d)){a.fail(TP.FAILURE,'Unable to resolve object: '+b);return;}a.stdout('Assembling '+b+'-only worklist.');}return;});
TP.boot.$srcPath = '~lib_src/tsh/tsh_pp.js';
TP.lang.Object.defineSubtype('tsh:pp');TP.tsh.pp.Type.defineMethod('fromArray',function(a,b){var f,c,e,g,d;if(a.$$format_tsh_pp){return TP.recursion(a);}a.$$format_tsh_pp=true;if(TP.isValid(b)){b.atPut('cmdBox',false);b.atPut('cmdAsIs',true);b.atPut('cmdAwaken',false);}f=a.getSize();c=TP.ac();c.push('<span class="tsh_pp"><span class="Array">');e=0;g=1;for(d=0;d<f;d++){if(e>g-1){e=0;}c.push('<span data-name="',d,'">',TP.format(a.at(d),'TP.tsh.pp',b),'</span>');e++;}c.push('</span></span>');delete a.$$format_tsh_pp;return c.join('');});TP.tsh.pp.Type.defineMethod('fromNamedNodeMap',function(d,c){var a,e,b;if(TP.isValid(c)){c.atPut('cmdBox',false);c.atPut('cmdAsIs',true);c.atPut('cmdAwaken',false);}a=TP.ac();e=d.length;a.push('<span class="NamedNodeMap">');for(b=0;b<e;b++){a.push('<span data-name="key">',TP.name(d.item(b)),'</span>','<span data-name="value">',TP.val(d.item(b)),'</span>');}a.push('</span>');return'<span class="tsh_pp">'+a.join('')+'</span>';});TP.tsh.pp.Type.defineMethod('fromNode',function(b,a){if(TP.isValid(a)){a.atPut('cmdBox',false);a.atPut('cmdAsIs',true);a.atPut('cmdAwaken',false);}return'<span class="tsh_pp">'+TP.str(b).asEscapedXML()+'</span>';});TP.tsh.pp.Type.defineMethod('fromNodeList',function(d,c){var a,e,b;if(TP.isValid(c)){c.atPut('cmdBox',false);c.atPut('cmdAsIs',true);c.atPut('cmdAwaken',false);}a=TP.ac();e=d.length;a.push('<span class="NodeList">');for(b=0;b<e;b++){a.push('<span data-name="',b,'">',TP.str(d[b]).asEscapedXML(),'</span>');}a.push('</span>');return'<span class="tsh_pp">'+a.join('')+'</span>';});TP.tsh.pp.Type.defineMethod('fromObject',function(a,b){if(TP.isValid(b)){b.atPut('cmdBox',false);b.atPut('cmdAsIs',true);b.atPut('cmdAwaken',false);}if(a===TP||a===TP.sys){return'<span class="tsh_pp">'+TP.htmlstr(TP.keys(a).sort())+'</span>';}return'<span class="tsh_pp">'+TP.htmlstr(a)+'</span>';});TP.tsh.pp.Type.defineMethod('fromString',function(b,a){var c;if(TP.isValid(a)){a.atPut('cmdBox',false);a.atPut('cmdAsIs',false);a.atPut('cmdAwaken',false);}if(TP.regex.CONTAINS_ELEM_MARKUP.test(b)){if(TP.isValid(a)){a.atPut('cmdAsIs',true);}}c=b.asEscapedXML();return'<span class="tsh_pp">'+TP.htmlstr(c)+'</span>';});TP.tsh.pp.Type.defineMethod('fromTP_boot_Annotation',function(b,a){if(TP.isValid(a)){a.atPut('cmdBox',false);a.atPut('cmdAsIs',true);a.atPut('cmdAwaken',false);}return'<span class="tsh_pp">'+'<span class="TP_boot_Annotation">'+'<span data-name="object">'+TP.htmlstr(b.object)+'</span>'+'<span data-name="message">'+TP.htmlstr(b.message)+'</span>'+'</span>'+'</span>';});TP.tsh.pp.Type.defineMethod('fromTP_boot_Log',function(f,c){var b,d,e,a;if(TP.isValid(c)){c.atPut('cmdBox',false);c.atPut('cmdAsIs',true);c.atPut('cmdAwaken',false);}b=f.getEntries();d='';e=b.getSize();for(a=0;a<e;a++){d+='<span class="Date" data-name="timestamp">'+b[a][TP.LOG_ENTRY_DATE]+'</span>'+'<span class="String" data-name="log-name">'+b[a][TP.LOG_ENTRY_NAME]+'</span>'+'<span class="Number" data-name="log-level">'+b[a][TP.LOG_ENTRY_LEVEL]+'</span>'+'<span class="String" data-name="log-entry">'+b[a][TP.LOG_ENTRY_PAYLOAD]+'</span>'+'<span class="String" data-name="log-context">'+b[a][TP.LOG_ENTRY_CONTEXT]+'</span>'+'<span class="String" data-name="log-delta">'+b[a][TP.LOG_ENTRY_DELTA]+'</span>';}return'<span class="tsh_pp">'+d+'</span>';});TP.tsh.pp.Type.defineMethod('fromTP_lang_Hash',function(a,b){var c,e,f,d;if(a.$$format_tsh_pp){return TP.recursion(a);}a.$$format_tsh_pp=true;if(TP.isValid(b)){b.atPut('cmdBox',false);b.atPut('cmdAsIs',true);b.atPut('cmdAwaken',false);}c=TP.ac();c.push('<span class="tsh_pp"><span class="TP_lang_Hash">');e=TP.keys(a);f=e.getSize();for(d=0;d<f;d++){c.push('<span data-name="',e.at(d),'">',TP.format(a.at(e.at(d)),'TP.tsh.pp',b),'</span>');}c.push('</span></span>');delete a.$$format_tsh_pp;return c.join('');});TP.tsh.pp.Type.defineMethod('fromTP_core_Node',function(b,a){if(TP.isValid(a)){a.atPut('cmdBox',false);a.atPut('cmdAsIs',true);a.atPut('cmdAwaken',false);}return'<span class="tsh_pp">'+TP.str(b.getNativeNode()).asEscapedXML()+'</span>';});TP.tsh.pp.Type.defineMethod('fromTP_core_Window',function(g,e){var d,b,c,f,a;if(TP.isValid(e)){e.atPut('cmdBox',false);e.atPut('cmdAsIs',true);e.atPut('cmdAwaken',false);}d=g.getNativeWindow();b=TP.ac();c=TP.sys.$windowkeys;f=c.length;b.push('<span class="TP_core_Window ',TP.escapeTypeName(TP.tname(d)),'">','<span class="Window" gid="',TP.gid(d),'">');for(a=0;a<f;a++){if(c[a]==='document'){b.push('<span data-name="',c[a],'">',TP.str(d.document).asEscapedXML(),'</span>');continue;}try{b.push('<span data-name="',c[a],'">',TP.htmlstr(d[c[a]]),'</span>');}catch(d){b.push('<span data-name="',c[a],'">',TP.htmlstr(undefined),'</span>');}}b.push('</span></span>');return'<span class="tsh_pp">'+b.join('')+'</span>';});TP.tsh.pp.Type.defineMethod('fromTP_sig_Signal',TP.tsh.pp.fromObject);TP.tsh.pp.Type.defineMethod('fromWindow',function(e,d){var b,c,f,a;if(TP.isValid(d)){d.atPut('cmdBox',false);d.atPut('cmdAsIs',true);d.atPut('cmdAwaken',false);}b=TP.ac();c=TP.sys.$windowkeys;f=c.length;b.push('<span class="Window" gid="',TP.gid(e),'">');for(a=0;a<f;a++){if(c[a]==='document'){b.push('<span data-name="',c[a],'">',TP.str(e.document).asEscapedXML(),'</span>');continue;}try{b.push('<span data-name="',c[a],'">',TP.htmlstr(e[c[a]]),'</span>');}catch(d){b.push('<span data-name="',c[a],'">',TP.htmlstr(undefined),'</span>');}}b.push('</span>');return'<span class="tsh_pp">'+b.join('')+'</span>';});TP.tsh.pp.Type.defineMethod('transformObject',function(b,a){var c;if(TP.isValid(a)){a.atPut('cmdBox',false);a.atPut('cmdAsIs',true);a.atPut('cmdAwaken',false);}if(TP.isValid(b)){if(TP.notEmpty(c=this.getBestMethodName(arguments,b,'from'))){return this[c].apply(this,arguments);}}return'<span class="tsh_pp">'+TP.htmlstr(b)+'</span>';});
TP.boot.$srcPath = '~lib_src/tsh/tsh_script.js';
TP.core.ActionElementNode.defineSubtype('tsh:script');TP.tsh.script.addTraitsFrom(TP.tsh.Element);TP.tsh.script.Type.defineAttribute('$tshOperators');TP.tsh.script.Type.defineMethod('initialize',function(){this.set('$tshOperators',TP.ac('.|','.&','.|&','.|*','.&*','.|&*','.|?','.&?','.|&?','.|?*','.&?*','.|&?*','.||','.&&','.>','.&>','.>&','.>!','.&>!','.>&!','.>>','.&>>','.>>&','.>>!','.&>>!','.>>&!','.<','.<!','.<<','.;','.((','.))','.{{','.}}','.[[','.]]','<?','?>','<![',']]>','</','/>'));TP.regex.TSH_PIPE=TP.rc(TP.tsh.script.$tshOperators.collect(function(a){return TP.regExpEscape(a);}).join('|'));return;});TP.tsh.script.Type.defineMethod('$adjustPipeSymbols',function(i,g,j){var a,d,b,e,c,f,h;TP.debug('break.tsh_pipe_adjust');a=TP.nodeGetChildElements(i);if(a.length>1){d=a.last();b=a.before(d);while(b){if(TP.elementHasAttribute(b,'tsh:pipe',true)){TP.elementSetAttribute(d,'tsh:pipe',TP.elementGetAttribute(b,'tsh:pipe',true),true);TP.elementRemoveAttribute(b,'tsh:pipe',true);}d=b;b=a.before(d);}}if(TP.isValid(e=j.at('cmdPeer'))){c=TP.elementGetAttribute(e.at('cmdNode'),'tsh:pipe',true);if(TP.notEmpty(c)){TP.elementSetAttribute(a[0],'tsh:pipe',c,true);}else if(TP.notEmpty(h=e.get('ins'))){c=TP.elementGetAttribute(h.at(0).at('cmdNode'),'tsh:pipe',true);TP.elementSetAttribute(a[0],'tsh:pipe',c,true);}if(TP.notEmpty(c)){f=e.at('cmdLast');if(TP.isValid(f)){g.at(0).atPut('cmdLast',f);}else{g.at(0).atPut('cmdPeer',e);}}}return;});TP.tsh.script.Type.defineMethod('$connectPipeSections',function(j,q){var d,b,c,n,k,i,a,f,e,l,g,m,o,p,h;TP.debug('break.tsh_pipe_connect');if(!TP.isArray(j)){this.raise('TP.sig.InvalidParameter',arguments,'Sequence must be an Array.');return;}n=j.getSize();for(d=0;d<n;d++){a=j.at(d);h=null;if(d===0){if(TP.isValid(l=q.at(TP.STDIN))){if(!TP.isArray(l)){a.atPut(TP.STDIN,TP.ac(l));}else{a.atPut(TP.STDIN,l);}}}o=a.at('cmdNode');if(TP.notEmpty(p=TP.elementGetAttribute(o,'tsh:cond',true))){if(p==='.||'){h=TP.FAILED;}}f=d>0?j.at(d-1):null;e=TP.isValid(f)?f.get('outs'):null;g=a.get('ins');if(TP.notEmpty(g)){k=g.getSize();for(b=0;b<k;b++){a.andJoin(g.at(b));if(TP.notEmpty(e)){i=e.getSize();for(c=0;c<i;c++){g.at(b).andJoin(e.at(c),h);}}else if(TP.isValid(f)){f.joinTo(g.at(b),h);}}}else{if(TP.notEmpty(e)){i=e.getSize();for(c=0;c<i;c++){a.andJoin(e.at(c),h);}}else if(TP.isValid(f)){f.joinTo(a,h);}}m=a.get('outs');if(TP.notEmpty(m)){k=m.getSize();for(b=0;b<k;b++){a.joinTo(m.at(b));}}}return;});TP.tsh.script.Type.defineMethod('cmdAddContent',function(a){return this.tshExecute(a);});TP.tsh.script.Type.defineMethod('cmdFilterInput',function(a){return this.tshExecute(a);});TP.tsh.script.Type.defineMethod('cmdGetContent',function(a){return this.tshExecute(a);});TP.tsh.script.Type.defineMethod('cmdRunContent',function(a){return this.tshExecute(a);});TP.tsh.script.Type.defineMethod('cmdSetContent',function(a){return this.tshExecute(a);});TP.tsh.script.Type.defineMethod('cmdTransformInput',function(a){return this.tshExecute(a);});TP.tsh.script.Type.defineMethod('$desugarXML',function(t,x,v,n){var u,d,w,c,o,f,j,g,h,b,p,a,s,q,k,m,e,i,l,r;u=function(a){return'"'+a.replace(/"/g,'&quot;')+'"';};d=TP.isArray(t)?t:TP.$condenseJS(t,false,false,this.$tshOperators,true,true,true);w=d.length;r='tsh';c=[];o=[];f=[];j=[];b=0;a=d[b];if(a&&a.value==='='){if(TP.isValid(n)){n.atPut('cmdLiteral',true);}b+=1;a=d[b];}else if(a&&a.value===';'){if(TP.isValid(n)){n.atPut('cmdSilent',true);}b+=1;a=d[b];}TP.debug('break.tsh_desugar');while(a){switch(g){case'tag':b+=1;for(;;){a=d[b];if(!a){break;}if(TP.$is_terminator(a.value)&&a.value!=='.[['){switch(a.value){case';':break;default:c.splice(1,0,' tsh:pipe="',TP.xmlLiteralsToEntities(a.value),'"');break;}b+=1;a=d[b];break;}else if(a.name==='operator'){if(a.value==='='){m=d[b-1];if(!m||m.name!=='identifier'){TP.ifWarn()?TP.warn('Missing attribute name in'+' tag input: '+a.value,TP.LOG,arguments):0;b+=1;a=d[b];continue;}e=d[b+1];if(e&&e.name!=='string'){c.push(a.value,'"');j.length=0;b+=1;a=d[b];while(a&&!TP.$is_whitespace(a.name)&&!TP.$is_terminator(a.value)){j.push(a.value);b+=1;a=d[b];}c.push(j.join(''),'"');}else{c.push(a.value,u(e.value));b+=2;a=d[b];}}else if(a.value==='--'||a.value==='-'){e=d[b+1];if(e&&e.name==='identifier'){i=d[b+2];if(i&&i.value==='='){c.push(' tsh:',e.value);b+=2;a=i;continue;}else{c.push(' tsh:',e.value,'="');if(a.value==='--'){c.push('\'',e.value,'\'');}else if(a.value==='-'){c.push('true');}c.push('"');b+=2;a=d[b];}}else{TP.ifWarn()?TP.warn('Missing flag name in tag'+' input.',TP.LOG,arguments):0;break;}}else if(a.value==='.[['){if(f.length>0){c.push(' tsh:argv="');k=TP.xmlLiteralsToEntities(f.join(' ').trim());if(f.length>1){k=k.unquoted();}c.push(k);c.push('"');f.length=0;}c.push('>');c.push('<![CDATA[');b+=1;for(;;){a=d[b];if(!a){TP.ifWarn()?TP.warn('Unexpected end of CDATA'+' input.',TP.LOG,arguments):0;break;}if(a.value==='.]]'){c.push(']]>');c.push('</',h,'>');break;}c.push(a.value);b+=1;}q='';b+=1;a=d[b];}else{if(!/^(~|\.|\/|{|%)/.test(a.value)){TP.ifWarn()?TP.warn('Unexpected operator in tag'+' input: '+a.value,TP.LOG,arguments):0;}j.length=0;j.push(a.value);b+=1;a=d[b];while(a&&!TP.$is_whitespace(a.name)&&!TP.$is_terminator(a.value)){j.push(a.value);b+=1;a=d[b];}f.push(j.join(''));b+=1;a=d[b];}}else if(TP.$is_identifier(a.name)&&TP.isValid(d[b+1])&&d[b+1].value===':'){c.push(a.value,':');b+=2;a=d[b];if(a&&TP.$is_identifier(a.name)){c.push(a.value);}else{TP.ifWarn()?TP.warn('Unexpected end of prefixed'+' attribute.',TP.LOG,arguments):0;break;}e=d[b+1];if(!e||(TP.$is_whitespace(e.name)||TP.$is_terminator(e.value))){c.push('="true"');}b+=1;a=d[b];}else{m=d[b-1];e=d[b+1];if(a.name!=='space'&&a.name!=='tab'&&(m&&m.value!==':')&&(TP.notValid(e)||e.value!=='=')){j.length=0;j.push(a.value);b+=1;a=d[b];while(a&&!TP.$is_whitespace(a.name)&&!TP.$is_terminator(a.value)){j.push(a.value);b+=1;a=d[b];}f.push(j.join(''));}else{c.push(a.value);b+=1;a=d[b];}}}if(f.length>0){c.push(' tsh:argv="');k=TP.xmlLiteralsToEntities(f.join(' ').trim());if(f.length>1){k=k.unquoted();}c.push(k);c.push('"');f.length=0;}c.push(TP.ifInvalid(q,'/>'));o.addAll(c);c.length=0;g=null;break;case'src':l=0;b+=1;for(;;){a=d[b];if(!a){break;}if('{(['.indexOf(a.value)>=0){l++;}else if('])}'.indexOf(a.value)>=0){l--;if(l<0){}}if(TP.$is_terminator(a.value)){if(a.value===';'){c.push(a.value);b+=1;a=d[b];if(l<=0){if(TP.sys.cfg('tsh.split_commands')){break;}p=1;while(e=d[b+p]){if(!TP.$is_whitespace(e.name)){break;}p++;}if(e){if(e.value===':'){break;}else if(TP.$is_identifier(e.name)){i=d[b+p+1];if(i&&i.value===':'){break;}}}}}else{if(l>0){}c.splice(1,0,' tsh:pipe="',TP.xmlLiteralsToEntities(a.value),'"');b+=1;a=d[b];break;}}else{c.push(a.value);b+=1;a=d[b];}}if(l!==0){}c.push(q||']]></tsh:cmd>');o.addAll(c);c.length=0;g=null;break;default:q=null;switch(a.name){case'newline':case'space':case'tab':b+=1;a=d[b];break;case'uri':c.push('<tsh:uri',' tsh:href="',TP.xmlLiteralsToEntities(a.value),'"');g='tag';h='tsh:uri';break;case'keyword':case'reserved':case'identifier':e=d[b+1];if(e&&e.value===':'){i=d[b+2];if(i&&i.value==='/'){c.push('<tsh:uri');f.push(a.value);b+=1;a=d[b];while(a&&!TP.$is_terminator(a.value)&&!TP.$is_whitespace(a.name)){f.push(a.value);b+=1;a=d[b];}if(f.length>0){c.push(' tsh:href="',TP.xmlLiteralsToEntities(s+f.join('')),'"');f.length=0;}if(a&&(TP.$is_terminator(a.value)||TP.$is_whitespace(a.name))){b--;}g='tag';h='tsh:uri';}else if(i&&!TP.$is_whitespace(i.name)){h=a.value+e.value+i.value;if(TP.notValid(TP.sys.getTypeByName(h))){if(TP.notValid(TP.sys.require(h))){TP.ifWarn()?TP.warn('Unable to find'+' custom type '+h,TP.LOG,arguments):0;}}c.push('<'+h);b+=2;g='tag';}else{r=a.value;n.stdout('Changing default prefix to '+a.value+e.value);b+=2;g=null;}}else{c.push('<tsh:cmd','><![CDATA[',a.value);g='src';}break;case'operator':switch(a.value){case'#':e=d[b+1];if(e&&/^\d+/.test(e.value)){c.push('<tsh:history');b+=1;a=d[b];while(a&&!TP.$is_terminator(a.value)&&!TP.$is_whitespace(a.name)){f.push(a.value);b+=1;a=d[b];}if(f.length>0){c.push(' hid="',TP.xmlLiteralsToEntities(f.join('')),'"');f.length=0;}c.push(' edit="true"');if(a&&(TP.$is_terminator(a.value)||TP.$is_whitespace(a.name))){b--;}g='tag';h='tsh:history';break;}case'~':e=d[b+1];if(e&&(TP.$is_whitespace(e.name)||e.value==='('||!TP.$is_identifier(e.name)&&e.value.indexOf('/')!==0)){c.push('<tsh:cmd','><![CDATA[',a.value);g='src';break;}c.push('<tsh:uri');s=a.value;b+=1;a=d[b];while(a&&!TP.$is_terminator(a.value)&&!TP.$is_whitespace(a.name)){f.push(a.value);b+=1;a=d[b];}if(f.length>0){c.push(' tsh:href="',TP.xmlLiteralsToEntities(s+f.join('')),'"');f.length=0;}if(a&&(TP.$is_terminator(a.value)||TP.$is_whitespace(a.name))){b--;}g='tag';h='tsh:uri';break;case'!':e=d[b+1];if(e&&(TP.$is_whitespace(e.name)||e.value==='(')){c.push('<tsh:cmd','><![CDATA[',a.value);g='src';break;}c.push('<tsh:history');b+=1;a=d[b];while(a&&!TP.$is_terminator(a.value)&&!TP.$is_whitespace(a.name)){f.push(a.value);b+=1;a=d[b];}if(f.length>0){c.push(' hid="',TP.xmlLiteralsToEntities(f.join('')),'"');f.length=0;}if(a&&(TP.$is_terminator(a.value)||TP.$is_whitespace(a.name))){b--;}g='tag';h='tsh:history';break;case'%':c.push('<tsh:job');e=d[b+1];if(e){c.push(' pid="',TP.xmlLiteralsToEntities(e.value),'"');b+=1;}g='tag';h='tsh:job';break;case'&':e=d[b+1];if(e&&e.value==='#'){c.push('<tsh:entity');g='tag';b+=1;}else if(TP.notValid(e)){c.push('<tsh:entity');g='tag';}else{c.push('<tsh:cmd','><![CDATA[&');g='src';}break;case'=':c.push('<tsh:cmd',' literal="true"><![CDATA[');g='src';break;case':':b+=1;a=d[b];c.push('<'+r+':'+a.value);g='tag';h=r+':'+a.value;break;case'.':e=d[b+1];if(e&&TP.$is_identifier(e.name)){b+=1;a=d[b];while(a&&!TP.$is_whitespace(a.name)&&!TP.$is_terminator(a.value)){f.push(a.value);b+=1;a=d[b];}if(f.length>0){c.push('<tsh:source',' ref="',TP.xmlLiteralsToEntities(f.join('')),'"');f.length=0;}if(a&&(TP.$is_terminator(a.value)||TP.$is_whitespace(a.name))){b--;}g='tag';h='tsh:source';}else if(e&&e.name==='uri'){b+=1;a=d[b];g='tag';if(TP.uriExtension(a.value)==='tsh'){c.push('<tsh:script',' src="',TP.xmlLiteralsToEntities(a.value),'"');h='tsh:script';}else{c.push('<tsh:import',' href="',TP.xmlLiteralsToEntities(a.value),'"');h='tsh:import';}}else{c.push('<tsh:cmd',' literal="true"><![CDATA[.');g='src';}break;case'/':b+=1;a=d[b];while(a&&!TP.$is_whitespace(a.name)&&!TP.$is_terminator(a.value)){f.push(a.value);b+=1;a=d[b];}c.push('<tsh:flag');if(f.length>0){c.push(' name="',TP.xmlLiteralsToEntities(f.join('')),'"');f.length=0;}if(a&&(TP.$is_terminator(a.value)||TP.$is_whitespace(a.name))){b--;}g='tag';h='tsh:flag';break;case'?':c.push('<tsh:help');e=d[b+1];if(e){c.push(' topic="',TP.xmlLiteralsToEntities(e.value),'"');b+=1;}g='tag';h='tsh:help';break;default:if(TP.$is_terminator(a.value)&&a.value!==';'){if(TP.isElement(v)){TP.elementSetAttribute(v,'tsh:pipe',TP.xmlLiteralsToEntities(a.value),true);}else{c.push('<tsh:uri',' tsh:pipe="',TP.xmlLiteralsToEntities(a.value),'"',' tsh:href="tibet:///$$" />');}b+=1;a=d[b];}else{c.push('<tsh:cmd','><![CDATA[',a.value);g='src';}break;}break;default:c.push('<tsh:cmd','><![CDATA[',a.value);g='src';break;}break;}}switch(g){case'tag':c.push('/>');break;case'src':c.push(']]></tsh:cmd>');break;default:break;}o.addAll(c);return o.join('');});TP.tsh.script.Type.defineMethod('scriptFail',function(a,e){var b,c,d;b=TP.ifInvalid(e,'Script execution error.');c=a.at('cmdNode');if(TP.elementIsNested(c)){d=TP.ifKeyInvalid(a,'rootRequest',a.at('cmdShell'));d.stderr(b,a);return TP.BREAK;}else{a.fail(TP.FAILURE,b);}return TP.BREAK;});TP.tsh.script.Type.defineMethod('tshCompile',function(a){var d,g,k,e,j,f,b,c,h,i,l;TP.debug('break.tsh_compile');d=a.at('cmdNode');g=a.at('cmdShell');if(TP.notEmpty(k=TP.elementGetAttribute(d,'tibet:phase',true))){if(k==='Compile'){return TP.CONTINUE;}}e=TP.ac(d.childNodes);j=e.length;for(f=0;f<j;f++){b=e[f];switch(b.nodeType){case Node.TEXT_NODE:case Node.CDATA_SECTION_NODE:c=TP.nodeGetTextContent(b);if(TP.isEmpty(c)){continue;}c=TP.xmlEntitiesToLiterals(c);h=this.$desugarXML(c,g,e.before(b),a);i=TP.nodeFromString(TP.ifInvalid(h,''));if(i){TP.nodeReplaceChild(d,i,b);}else{l=TP.ifKeyInvalid(a,'rootRequest',g);l.stderr('Unable to create node from: '+h,a);a.fail();}break;case Node.ELEMENT_NODE:break;default:break;}}return TP.DESCEND;});TP.tsh.script.Type.defineMethod('tshExecute',function(a){var c,q,k,v,E,n,g,y,s,t,A,D,h,x,d,r,o,f,i,b,l,m,j,z,e,u,p,B,C,w;TP.debug('break.tsh_execute');c=a.at('cmdNode');k=a.at('cmdShell');if(TP.sys.cfg('log.tsh_execute')){TP.ifTrace()?TP.trace('tsh_execute:\n'+TP.str(c),TP.LOG,arguments):0;}v=TP.elementIsNested(c);E=k.getType().get('commandPrefix');n=a.at('cmdID');e=TP.ac();g=TP.elementGetAttribute(c,'tibet:src',true);if(TP.notEmpty(g)){q=c;y=TP.uc(g);if(TP.notValid(y)){return this.scriptFail(a,'Invalid or unresolvable TSH script url: '+g);}s=y.getResource(TP.hc('refresh',true,'async',false,'resultType',TP.WRAP));if(!TP.canInvoke(s,'getNativeNode')){return this.scriptFail(a,'Unable to read valid XML for: '+g);}c=s.getNativeNode();if(TP.notValid(c)){return this.scriptFail(a,'Unable to get XML document for: '+g);}c=TP.elem(c);if(TP.notValid(c)){return this.scriptFail(a,'Unable to get root node for: '+g);}if(TP.qname(c)!==this.getTagName()){return this.scriptFail(a,'Invalid (!tsh:script) root node for: '+g);}t=TP.sig.ShellRequest.construct(TP.hc('cmdNode',c,'cmdShell',k));k.execute(t);c=t.at('cmdNode');if(TP.elementGetAttribute(q,'subshell')==='true'){TP.ifWarn()?TP.warn('Pure subshell not yet supported. Using block.',TP.LOG,arguments):0;}TP.nodeCopyChildNodesTo(c,q);c=q;}A=TP.sys.cfg('break.tsh_tag_exec');D=TP.sys.cfg('tsh.trace_commands');h=0;x=c.childNodes;if(x.length===0){a.complete();return TP.CONTINUE;}l=TP.ifInvalid(a.at('rootRequest'),a);while(d=x[h]){r=d.nodeType;if(r!==Node.ELEMENT_NODE&&r!==Node.PROCESSING_INSTRUCTION_NODE){h+=1;continue;}TP.debug(A);o=d;u=0;b=TP.sig.TSHRunRequest.construct(TP.hc('cmdAllowSubs',a.at('cmdAllowSubs'),'cmdAsIs',a.at('cmdAsIs'),'cmdHistory',a.at('cmdHistory'),'cmdID',n,'cmdInteractive',a.at('cmdInteractive'),'cmdLast',e.last(),'cmdLiteral',a.at('cmdLiteral'),'cmdNode',o,'cmdRecycle',a.at('cmdRecycle'),'cmdSequence',e,'cmdShell',k,'cmdSilent',a.at('cmdSilent'),'echoRequest',a.at('echoRequest'),'execContext',a.at('execContext'),'execInstance',a.at('execInstance'),'rootRequest',l));e.push(b);f=TP.isElement(o)?TP.elementGetAttribute(o,'tsh:pipe',true):'';a:while(TP.notEmpty(f)){i=TP.nodeGetFirstSiblingElement(d);if(TP.notValid(i)&&!v&&f!=='.;'){l.stderr('Unexpected end of pipe at: '+TP.str(d),a);return TP.BREAK;}f=TP.xmlEntitiesToLiterals(f);switch(f){case'.|':case'.|?':case'.|*':case'.|?*':b.atPut(TP.STDOUT,TP.ac());break a;case'.&':case'.&?':case'.&*':case'.&?*':b.atPut(TP.STDERR,TP.ac());break a;case'.|&':case'.|?&':case'.|&*':case'.|&?*':b.atPut(TP.STDIO,TP.ac());break a;case'.||':TP.elementSetAttribute(i,'tsh:cond','.||',true);break a;case'.&&':TP.elementSetAttribute(i,'tsh:cond','.&&',true);break a;case'.<':case'.<!':m=TP.sig.TSHRunRequest.construct(TP.hc('cmdAllowSubs',a.at('cmdAllowSubs'),'cmdAsIs',a.at('cmdAsIs'),'cmdHistory',b.at('cmdHistory'),'cmdID',n,'cmdInteractive',b.at('cmdInteractive'),'cmdIOName','$_'+u,'cmdLiteral',b.at('cmdLiteral'),'cmdNode',i,'cmdRecycle',b.at('cmdRecycle'),'cmdRequest',b,'cmdShell',k,'cmdSilent',b.at('cmdSilent'),'echoRequest',b.at('echoRequest'),'execContext',a.at('execContext'),'execInstance',a.at('execInstance'),'rootRequest',l));m.defineMethod('stdout',function(a){this.at('cmdRequest').atPut(this.at('cmdIOName'),a);});u++;b.addInputRequest(m);break;case'.<<':l.stderr('Unexpected pipe symbol at: '+TP.str(d),a);return TP.BREAK;case'.>':case'.>!':b.atPut(TP.STDOUT,TP.ac());j=true;break;case'.&>':case'.&>!':b.atPut(TP.STDERR,TP.ac());j=true;break;case'.>&':case'.>&!':b.atPut(TP.STDIO,TP.ac());j=true;break;case'.>>':case'.>>!':b.atPut(TP.STDOUT,TP.ac());j=true;break;case'.&>>':case'.&>>!':b.atPut(TP.STDERR,TP.ac());j=true;break;case'.>>&':case'.>>&!':b.atPut(TP.STDIO,TP.ac());j=true;break;case'.;':break a;default:l.stderr('Unexpected pipe symbol at: '+TP.str(d),a);return TP.BREAK;}if(j){m=TP.sig.TSHRunRequest.construct(TP.hc('cmdAllowSubs',a.at('cmdAllowSubs'),'cmdAsIs',a.at('cmdAsIs'),'cmdHistory',b.at('cmdHistory'),'cmdID',n,'cmdInteractive',b.at('cmdInteractive'),'cmdLiteral',b.at('cmdLiteral'),'cmdNode',i,'cmdRecycle',b.at('cmdRecycle'),'cmdRequest',b,'cmdShell',k,'cmdSilent',b.at('cmdSilent'),'echoRequest',b.at('echoRequest'),'execContext',a.at('execContext'),'execInstance',a.at('execInstance'),'rootRequest',l));b.addOutputRequest(m);j=false;}f=TP.isElement(i)?TP.elementGetAttribute(i,'tsh:pipe',true):'';d=i;h+=1;}h+=1;}if(TP.notValid(b)){return this.scriptFail(a,'Unable to construct subcommand(s) for: '+g);}a.set('subrequests',e);p=b.get('outs');if(TP.isEmpty(p)){a.andJoinChild(b);}else{B=p.getSize();for(h=0;h<B;h++){C=p.at(h);a.andJoinChild(C);}}if(v){e.last().atPut(TP.STDOUT,a.at(TP.STDOUT));e.last().atPut(TP.STDIO,a.at(TP.STDIO));}this.$adjustPipeSymbols(c,e,a);if(TP.notEmpty(f=TP.elementGetAttribute(c,'tsh:pipe',true))){if(f==='.<'){d=e.last();if(TP.isValid(d)){d.atPut('cmdRequest',a.at('cmdRequest'));d.atPut('cmdIOName',a.at('cmdIOName'));d.stdout=a.stdout;}}else{d=e.first().at('cmdNode');if(TP.isElement(d)){TP.elementSetAttribute(d,'tsh:pipe',f,true);e.first().atPut(TP.STDIN,a.at(TP.STDIN));}}}this.$connectPipeSections(e,a);w=TP.tsh.RunService.getDefaultInstance();if(TP.isValid(z=e.first().get('ins'))){z.perform(function(a){w.handleTSHRunRequest(a);});}else{w.handleTSHRunRequest(e.first());}return TP.BREAK;});TP.tsh.script.Type.defineMethod('$xmlifyContent',function(g,p,o){var e,a,b,d,f,i,c,l,j,h,k,n,m;if(!TP.regex.HAS_ELEMENT.test(g)&&!TP.regex.HAS_PI.test(g)&&!TP.regex.HAS_ENTITY.test(g)&&!TP.regex.TSH_SUBSHELL.test(g)&&!TP.regex.TSH_SUBGROUP.test(g)&&!TP.regex.TSH_HEREDOC.test(g)){return g;}TP.debug('break.tsh_xmlify');e=TP.$tokenize(g,this.$tshOperators,true,false,false,false);b=0;a=e[b];f='content';h=false;d=TP.ac();j=TP.ac();c=TP.ac();while(a){switch(a.value){case'<':case'</':i=e[b+1];if(!i){d.push(TP.xmlLiteralsToEntities(a.value));b+=1;a=e[b];continue;}if(i.name!=='identifier'){if(i.value==='!'&&e[b+2]!==null&&e[b+2].value==='--'){c.push('<!--');b+=3;for(;;){a=e[b];if(!a){break;}if(a.value==='--'&&e[b+1]==='>'){c.push('-->');b+=1;break;}c.push(a.value);b+=1;}d.push(c.join(''));c.length=0;b+=1;break;}d.push(TP.xmlLiteralsToEntities(a.value));b+=1;a=e[b];continue;}c.push(a.value,i.value);b+=2;for(;;){a=e[b];if(!a){f='content';break;}c.push(a.value);if(a.name==='operator'){if(a.value==='>'||a.value==='/>'){f='tag';break;}else if(a.value==='-'){b+=1;continue;}else if(a.value!==':'&&a.value!=='='){f='content';break;}}else if(a.name==='string'||TP.$is_identifier(a.name)||TP.$is_whitespace(a.name)){b+=1;continue;}else{f='content';break;}b+=1;}if(f==='content'){if(c.last()==='.<<'){c.length=c.length-1;b-=1;}else if(c.last()==='.(('){c.length=c.length-1;b-=1;}else if(c.last()==='.{{'){c.length=c.length-1;b-=1;}else{b+=1;}d.push(TP.xmlLiteralsToEntities(c.join('')));c.length=0;h=false;}else{d.push(c.join(''));c.length=0;f='content';h=a.value==='<';b+=1;}a=e[b];break;case'<![':c.push('<![CDATA[');b+=3;for(;;){a=e[b];if(!a){break;}if(a.value===']'&&e.slice(b,b+2).join('')===']]>'){c.push(']]>');b+=2;break;}c.push(a.value);b+=1;}d.push(c.join(''));c.length=0;b+=1;break;case'<?':c.push(a.value);b+=1;a=e[b];while(a&&a.value!=='?>'){c.push(a.value);b+=1;a=e[b];}if(a&&a.value==='?>'){c.push(a.value);}d.push(c.join(''));c.length=0;b+=1;break;case'.{{':d.push('<tsh:script>');h=true;b+=1;break;case'.}}':d.push('</tsh:script>');h=false;b+=1;break;case'.((':d.push('<tsh:script subshell="true">');h=true;b+=1;break;case'.))':d.push('</tsh:script>');h=false;b+=1;break;case'.<<':b+=1;a=e[b];while(a&&a.name!=='identifier'){n=a.value==='\\';m=a.value==='-';b+=1;a=e[b];}if(a&&a.name==='identifier'){l=a.value;b+=1;a=e[b];if(TP.$is_whitespace(a.name)){b+=1;a=e[b];}d.push('.&lt;');d.push('<tsh:here');if(n){d.push(' literal="true"');}if(m){d.push(' preserve="true"');}d.push(' ><![CDATA[');while(a){if(a.value===l){b+=1;break;}j.push(a.value);b+=1;a=e[b];}if(j.length>0){d.push(TP.xmlLiteralsToEntities(j.join('')));j.length=0;}d.push(']]></tsh:here>');f='content';}else{TP.ifWarn()?TP.warn('Invalid syntax at: '+a.value,TP.LOG,arguments):0;b+=1;}break;default:if(a.name==='string'||a.name==='operator'){a.value=TP.xmlLiteralsToEntities(a.value);d.push(a.value);b+=1;}else{d.push(a.value);b+=1;}break;}a=e[b];}k=d.join('');if(TP.sys.cfg('log.tsh_xmlify')){TP.ifTrace()?TP.trace('tsh_xmlify:\n'+k,TP.LOG,arguments):0;}return k;});TP.tsh.script.Inst.defineMethod('constructActRequest',function(b){var a;a=this.callNextMethod();if(TP.notEmpty(this.getAttribute('tibet:src'))){a.atPut('cmdPhases','finalize');}return a;});TP.sig.ShellRequest.defineSubtype('TSHRunRequest');TP.sig.TSHRunRequest.Type.defineAttribute('responseType','TP.sig.TSHRunResponse');TP.sig.TSHRunRequest.Inst.defineAttribute('ins');TP.sig.TSHRunRequest.Inst.defineAttribute('outs');TP.sig.TSHRunRequest.Inst.defineMethod('addInputRequest',function(b){var a;a=this.$get('ins');if(TP.notValid(a)){a=TP.ac();this.$set('ins',a);}a.push(b);return this;});TP.sig.TSHRunRequest.Inst.defineMethod('addOutputRequest',function(b){var a;a=this.$get('outs');if(TP.notValid(a)){a=TP.ac();this.$set('outs',a);}a.push(b);return this;});TP.sig.TSHRunRequest.Inst.defineMethod('cancel',function(a,b){if(this.isCompleting()||this.didComplete()){return;}if(arguments.length>0&&TP.notTrue(this.at('cmdSilent'))){switch(arguments.length){case 1:this.stderr(a);break;case 2:this.stderr(a,b);break;default:break;}}return this.callNextMethod();});TP.sig.TSHRunRequest.Inst.defineMethod('complete',function(a){if(this.isCompleting()||this.didComplete()){return;}if(arguments.length>0&&TP.notTrue(this.at('cmdSilent'))){this.stdout(a);}return this.callNextMethod();});TP.sig.TSHRunRequest.Inst.defineMethod('fail',function(a,b,c){if(this.isCompleting()||this.didComplete()){return;}if(TP.isValid(c)){this.raise(c,arguments,TP.ifInvalid(b,a));}if(arguments.length>0&&TP.notTrue(this.at('cmdSilent'))){switch(arguments.length){case 1:this.stderr(a);break;case 2:this.stderr(a+': '+b);break;default:break;}}return this.callNextMethod();});TP.sig.TSHRunRequest.Inst.defineMethod('notify',function(b,c){var a;a=this.at('cmdShell');return a.notify(b,TP.ifInvalid(c,this));});TP.sig.TSHRunRequest.Inst.defineMethod('stderr',function(a,e){var b,c,d,f,g,h;TP.debug('break.tsh_stderr');b=TP.isValid(e)?this.getPayload().addAll(e):this;if(TP.isValid(c=this.at(TP.STDERR))){d=true;c.push(a);}if(TP.isValid(c=this.at(TP.STDIO))){d=true;c.push(a);}this.set('result',a);if(d){return;}if(TP.isNumber(f=b.at('cmdStart'))&&TP.isNumber(g=b.at('cmdEnd'))){this.$set('$tagtime',g-f);}h=this.at('rootRequest');return h.stderr(a,b);});TP.sig.TSHRunRequest.Inst.defineMethod('stdin',function(){var b,g,c,a,d,e,f,h;TP.debug('break.tsh_stdin');if(TP.isValid(b=this.at(TP.STDIN))){return b;}g=this.at('cmdNode');c=TP.elementGetAttribute(g,'tsh:pipe',true);c=TP.isEmpty(c)?c:TP.xmlEntitiesToLiterals(c);switch(c){case'.|':case'.|*':case'.|?':case'.|?*':a=TP.STDOUT;break;case'.&':case'.&?':case'.&*':case'.&?*':a=TP.STDERR;break;case'.|&':case'.|&?':case'.|&*':case'.|&?*':a=TP.STDIO;break;case'.||':case'.&&':a=TP.STDOUT;break;case'.<':case'.<!':case'.<<':a=TP.STDOUT;break;case'.>':case'.>!':case'.>>':case'.>>!':a=TP.STDOUT;break;case'.&>':case'.&>!':case'.&>>':case'.&>>!':a=TP.STDERR;break;case'.>&':case'.>&!':case'.>>&':case'.>>&!':a=TP.STDIO;break;default:break;}if(TP.notEmpty(a)){d=this.at('cmdLast')||this.at('cmdRequest');if(TP.isValid(d)){b=d.at(a);}else{e=this.at('cmdPeer');if(TP.isValid(e)){b=e.at(TP.STDIN);}}}b=TP.ifInvalid(b,TP.ac());f=0;for(;;){if(TP.notDefined(h=this.at('$_'+f))){break;}b.push(h);f+=1;}this.atPut(TP.STDIN,b);return b;});TP.sig.TSHRunRequest.Inst.defineMethod('stdout',function(c,f){var a,h,b,d,e,j,i,g;TP.debug('break.tsh_stdout');a=TP.isValid(f)?this.getPayload().addAll(f):this;if(TP.isValid(d=this.at(TP.STDOUT))){e=true;d.push(c);}if(TP.isValid(d=this.at(TP.STDIO))){e=true;d.push(c);}this.set('result',c);if(e){return;}j=this.at('cmdShell');h=this.at('cmdNode');b=TP.ifEmpty(TP.elementGetAttribute(h,'tsh:asis',true),a.at('cmdAsIs'));if(TP.notEmpty(b)){b=TP.bc(b);}a.atPutIfAbsent('cmdAsIs',b);if(TP.isNumber(i=a.at('cmdStart'))&&TP.isNumber(g=a.at('cmdEnd'))){this.$set('$tagtime',g-i);}return this.at('rootRequest').stdout(c,a);});TP.sig.ShellResponse.defineSubtype('TSHRunResponse');TP.core.Service.defineSubtype('tsh:RunService');TP.tsh.RunService.Type.defineAttribute('triggerSignals','TP.sig.TSHRunRequest');TP.tsh.RunService.register();TP.tsh.RunService.Inst.defineMethod('handleTSHRunRequest',function(a){var f,e,m,j,h,k,l,b,d,i,c,g;TP.debug('break.tsh_execute');a.isActive(true);f=a.at('cmdNode');e=a.at('cmdShell');if(TP.sys.cfg('log.tsh_run')){TP.ifTrace()?TP.trace('tsh_run:\n'+TP.str(f),TP.LOG,arguments):0;}m=e.getType().get('commandPrefix');j=f.nodeType;if(j!==Node.ELEMENT_NODE&&j!==Node.PROCESSING_INSTRUCTION_NODE){a.fail();return;}c=TP.elementGetAttribute(f,'tsh:pipe',true);c=TP.isEmpty(c)?c:TP.xmlEntitiesToLiterals(c);if(TP.notEmpty(c)){if(c.indexOf('*')!==TP.NOT_FOUND){a.atPut('cmdIterate',true);}if(c.indexOf('!')!==TP.NOT_FOUND){a.atPut('cmdCommit',true);a.atPut('cmdRefresh',true);}if(c.indexOf('>>')!==TP.NOT_FOUND){a.atPut('cmdAction',TP.ADD);}else if(c.indexOf('<')!==TP.NOT_FOUND){a.atPut('cmdAction',TP.GET);}else if(c.indexOf('>')!==TP.NOT_FOUND){a.atPut('cmdAction',TP.SET);}else if(c.indexOf('?')!==TP.NOT_FOUND){a.atPut('cmdAction',TP.FILTER);}else{a.atPut('cmdAction',TP.TRANSFORM);}}g=TP.elementGetAttribute(f,'tsh:async',true);g=TP.isEmpty(g)?false:TP.bc(g);a.atPut('async',g);h=TP.qname(f);k=h.split(':');l=k.at(0);if(l===m){b='execute'+e.translateSymbol(k.at(1)).asStartUpper();if(TP.canInvoke(e,b)){i=Date.now();a.atPut('cmdStart',i);e.updateExecutionInstance(a);e[b](a);return;}b=null;}d=TP.sys.require(h);if(TP.notValid(d)){a.at('rootRequest').stderr('Invalid command: '+h,a);a.fail();return;}switch(c){case'.|':case'.|*':case'.&':case'.&*':case'.|&':case'.|&*':if(TP.canInvoke(d,'cmdTransformInput')){b='cmdTransformInput';}break;case'.|?':case'.|?*':case'.&?':case'.&?*':case'.|&?':case'.|&?*':if(TP.canInvoke(d,'cmdFilterInput')){b='cmdFilterInput';}break;case'.>':case'.>!':case'.&>':case'.&>!':case'.>&':case'.>&!':if(TP.canInvoke(d,'cmdSetContent')){b='cmdSetContent';}break;case'.>>':case'.>>!':case'.&>>':case'.&>>!':case'.>>&':case'.>>&!':if(TP.canInvoke(d,'cmdAddContent')){b='cmdAddContent';}a.atPut('cmdAppend',true);break;case'.<':case'.<!':case'.<<':if(TP.canInvoke(d,'cmdGetContent')){b='cmdGetContent';}break;default:break;}i=Date.now();a.atPut('cmdStart',i);if(TP.isEmpty(b)){b='cmdRunContent';}if(!TP.canInvoke(d,b)){a.at('rootRequest').stderr('Unable to execute '+h+'.'+b,a);a.fail();return;}e.updateExecutionInstance(a);d[b](a);return TP.BREAK;});
TP.boot.$srcPath = '~lib_src/tsh/tsh_service.js';
TP.core.ActionElementNode.defineSubtype('tsh:service');TP.tsh.service.addTraitsFrom(TP.tsh.Element);TP.tsh.service.Type.defineMethod('cmdAddContent',function(a){return this.cmdRunContent(a);});TP.tsh.service.Type.defineMethod('cmdFilterInput',function(a){return this.cmdRunContent(a);});TP.tsh.service.Type.defineMethod('cmdGetContent',function(a){return this.cmdRunContent(a);});TP.tsh.service.Type.defineMethod('cmdSetContent',function(a){return this.cmdRunContent(a);});TP.tsh.service.Type.defineMethod('cmdTransformInput',function(a){return this.cmdRunContent(a);});TP.tsh.service.Type.defineMethod('tshExecute',function(a){var b,c;TP.debug('break.tsh_request');b=a.at('cmdNode');c=TP.wrap(b);return c.execute(a);});TP.tsh.service.Inst.defineMethod('execute',function(b){var a,n,f,l,c,m,q,p,k,g,i,e,h,o,d;TP.debug('break.tsh_service');a=b.at('cmdNode');n=b.at('cmdShell');if(TP.elementGetAttribute(a,'tsh:busy',true)==='true'){this.dispatch('tsh-service-error',a,TP.hc('error-type','request-in-progress'));b.fail(TP.FAILURE,'Service call already in progress for: '+TP.str(a));return TP.BREAK;}else{}if(TP.isEmpty(f=TP.elementGetAttribute(a,'tsh:href',true))){if(TP.isEmpty(f=this.getActionParam(b,'href'))){this.raise('TP.sig.InvalidParameter',arguments,'Missing required resource attribute for: '+TP.str(a));this.dispatch('tsh-service-error',a,TP.hc('error-type','resource-error'));return TP.BREAK;}}f=TP.uc(f);if(TP.notValid(f)){this.raise('TP.sig.InvalidParameter',arguments,'Invalid resource attribute for: '+TP.str(a));this.dispatch('tsh-service-error',a,TP.hc('error-type','resource-error'));return TP.BREAK;}if(TP.isEmpty(l=TP.elementGetAttribute(a,'tsh:method',true))){if(TP.isEmpty(l=this.getActionParam(b,'method'))){this.raise('TP.sig.InvalidParameter',arguments,'Missing required method attribute for: '+TP.str(a));this.dispatch('tsh-service-error',a,TP.hc('error-type','method-error'));return TP.BREAK;}}c=TP.hc('route',l);c.atPut('verb',l.toUpperCase());m=TP.core.URI.route(f,c);if(TP.notValid(m)){this.raise('TP.sig.InvalidHandler',arguments,'Missing required handler type for: '+TP.str(a));this.dispatch('tsh-service-error',a,TP.hc('error-type','handler-error'));return TP.BREAK;}q=this.getType().getActionInput(b);c.atPut('body',q);p=n.getArguments(b).getItems();k=p.getSize();for(g=0;g<k;g++){i=p.at(g);e=i.first();h=i.last();switch(e){case'tsh:href':case'tsh:method':break;case'tsh:async':c.atPut('async',TP.bc(h));break;case'tsh:refresh':c.atPut('refresh',TP.bc(h));break;default:if(e.indexOf('tsh:')===0){c.atPut(e.slice(4),h);}break;}}o=n.getParams(b).getItems();k=o.getSize();for(g=0;g<k;g++){i=o.at(g);e=i.first();h=i.last();switch(e){case'tsh:href':case'tsh:method':break;default:if(e.indexOf('tsh:')===0){c.atPut(e.slice(4),h);}else{c.atPut(e,h);}break;}}var j;j=f.asString().transform(c);if(!TP.isURI(j=TP.uc(j))){j=f;}d=TP.request(c);d.defineMethod('cancelJob',function(a,c){this.$wrapupJob('Cancelled',TP.CANCELLED,a,c);return b.cancel(a,c);});d.defineMethod('completeJob',function(a){this.$wrapupJob('Completed',TP.COMPLETED,a||d.getResult());return b.complete(a||d.getResult());});d.defineMethod('failJob',function(a,c){this.$wrapupJob('Failed',TP.FAILED,a,c);return b.fail(a,c);});d.defineMethod('handleRequestCompleted',function(){alert('tsh:service completed');return;});d.defineMethod('handleRequestFailed',function(){alert('tsh:service failed');return;});d.defineMethod('handleRequestSucceeded',function(a){alert('tsh:service succeeded');TP.ifInfo()?TP.info('The results are: '+TP.str(a.getResult()),TP.LOG,arguments):0;return;});m.service(j,d);return TP.CONTINUE;});TP.tsh.service.Inst.defineMethod('isBoundElement',function(){return true;});TP.tsh.service.Inst.defineMethod('isSingleValued',function(){return true;});
TP.boot.$srcPath = '~lib_src/tsh/tsh_template.js';
TP.core.ActionElementNode.defineSubtype('tsh:template');TP.tsh.template.addTraitsFrom(TP.tsh.Element);TP.tsh.template.Type.defineAttribute('uriAttrs',TP.ac('src'));TP.tsh.template.Type.defineMethod('processJSTemplate',function(b,g,e){var c,a,f,d;if(TP.isURI(e)){c=e.getResourceNode(TP.hc('async',false));if(TP.isDocument(c)){a=TP.nodeGetTextContent(c.documentElement);}}if(!TP.isString(a)||TP.isEmpty(a)){if(TP.isCDATASectionNode(f=TP.nodeGetFirstChildByType(b,Node.CDATA_SECTION_NODE))){a=TP.nodeGetTextContent(f);}else{a=TP.nodeGetTextContent(b);TP.ifWarn()?TP.warn('Template not found in CDATA block for: '+this.asString(),TP.LOG,arguments):0;}}if(!TP.isString(a)||TP.isEmpty(a)){return this.raise('TP.sig.InvalidTemplate',arguments,'Empty or invalid template for: '+this.asString());}if(TP.elementGetAttribute(b,'escape')==='true'){a=a.escapeWhitespace();}d=a.compile(g,true,true);if(!TP.isFunction(d)){return this.raise('TP.sig.InvalidTemplate',arguments,'JS template failed to compile for: '+this.asString());}return d;});TP.tsh.template.Type.defineMethod('processXMLTemplate',function(h,j,g){var a,b,i,e,c,f,d;if(TP.isURI(g)){a=g.getResourceNode(TP.hc('async',false));if(TP.isDocument(a)){TP.elementAddNamespace(a.documentElement,'tibet',TP.w3.Xmlns.TIBET);}}if(!TP.isDocument(a)){b=TP.nodeGetChildElements(h);switch(b.getSize()){case 0:return this.raise('TP.sig.InvalidTemplate',arguments,'Empty or invalid template for: '+this.asString());case 1:d=b.first();d=TP.nodeCloneNode(d,true);TP.elementAddNamespace(d,'tibet',TP.w3.Xmlns.TIBET);a=TP.doc(TP.str(d));break;default:f=TP.documentCreateFragment(TP.nodeGetDocument(h));i=b.getSize();for(e=0;e<i;e++){c=b.at(e);c=TP.nodeCloneNode(c,true);TP.elementAddNamespace(c,'tibet',TP.w3.Xmlns.TIBET);f.appendChild(c);}a=f;break;}}if(!TP.isNode(a)){return this.raise('TP.sig.InvalidTemplate',arguments,'Unable to acquire XML document for: '+this.asString());}TP.uc(TP.TIBET_URN_PREFIX+j).setResource(TP.wrap(a));return a;});TP.tsh.template.Type.defineMethod('processXSLTTemplate',function(c,g,e){var d,a,f,b;d=this.getXSLTBoilerplate(c);if(!TP.isKindOf(d,'TP.core.XSLDocumentNode')){return this.raise('TP.sig.InvalidDocument',arguments,'Unable to load XSLT template document.');}if(TP.isURI(e)){a=e.getResourceNode(TP.hc('async',false));if(TP.isDocument(a)){TP.elementAddNamespace(a.documentElement,'tibet',TP.w3.Xmlns.TIBET);}}if(!TP.isDocument(a)){f=TP.nodeGetChildElements(c);switch(f.getSize()){case 0:return this.raise('TP.sig.InvalidTemplate',arguments,'Empty or invalid template for: '+this.asString());default:a=TP.nodeCloneNode(d.getNativeNode(),true);if(TP.notValid(b=TP.nodeGetElementById(a,'INLINE_CONTENT_HERE'))){return this.raise('TP.sig.InvalidTemplate',arguments,'Can\'t find insertion marker '+'for XSLT template.');}TP.nodeCopyChildNodesTo(c,b.parentNode,b);TP.nodeDetach(b);break;}}if(!TP.isNode(a)){return this.raise('TP.sig.InvalidTemplate',arguments,'Unable to acquire XSLT document for: '+this.asString());}TP.uc(TP.TIBET_URN_PREFIX+g).setResource(TP.wrap(a));return a;});TP.tsh.template.Type.defineMethod('getTemplateGenerator',function(b){var a;if(!TP.isElement(b)){return this.raise('TP.sig.InvalidElement',arguments);}a=b.getAttribute('tsh:generator');if(TP.notEmpty(a)){return TP.sys.require(a);}return;});TP.tsh.template.Type.defineMethod('getTemplateResult',function(g,k,j){var e,b,f,d,h,c,i,a;e=TP.uc(TP.TIBET_URN_PREFIX+g);if(TP.notValid(e)){}b=e.getResource(TP.hc('resultType',TP.WRAP));if(TP.notValid(b)||!TP.canInvoke(b,'format')){}if(TP.isKindOf(b,TP.core.CollectionNode)){f=TP.unwrap(b);d=TP.nodeGetElementsByTagName(f,'tsh:template');h=TP.nodeGetDocument(f);d.perform(function(a){var b;b=TP.documentCreateElement(h,'templateDummy');TP.nodeReplaceChild(a.parentNode,b,a,false);});}c=b.transform(k,j);if(TP.isString(c)){a=TP.nodeFromString(c);}else{a=c;}if(TP.notEmpty(d)){i=TP.nodeGetElementsByTagName(a,'templateDummy');i.perform(function(a,b){TP.nodeReplaceChild(a.parentNode,d.at(b),a,false);});}if(!TP.isNode(a)){a=TP.nodeFromString(TP.join('<span xmlns="',TP.w3.Xmlns.XHTML,'">',TP.sc('Error producing node from template: '),g,'</span>'));}return a;});TP.tsh.template.Type.defineMethod('getXSLTBoilerplate',function(d){var a,b,c;a=TP.sys.cfg('xslt.boilerplate_path');b=TP.uc(a);if(TP.notValid(b)){return this.raise('TP.sig.InvalidURI',arguments,'Unable to load XSLT boilerplate: '+a);}c=TP.wrap(b.getResourceNode(TP.hc('async',false)));if(!TP.isKindOf(c,'TP.core.XSLDocumentNode')){return this.raise('TP.sig.InvalidDocument',arguments,'Unable to acquire XSLT template for: '+this.asString());}return c;});TP.tsh.template.Type.defineMethod('wrapInTransformElement',function(f,g){var d,a,b,e,c;d=TP.join('<tsh:transform xmlns:tsh="',TP.w3.Xmlns.TSH,'">',TP.str(f),'</tsh:transform>');if(!TP.isElement(a=TP.elem(d))){return null;}b=TP.nodeGetFirstChildElement(a);e=TP.ifInvalid(g,'');if(TP.isEmpty(c=TP.elementGetAttribute(b,'tsh:name',true))){c='template_'+e+'_'+TP.genID();TP.elementSetAttribute(b,'tsh:name',c,true);}TP.elementSetAttribute(b,'tsh:root','true',true);TP.elementSetAttribute(a,'tsh:root_template',c,true);return a;});TP.tsh.template.Type.defineMethod('tagCompile',function(q){var a,h,j,d,k,m,e,b,i,p,l,n,o,c,f,g;if(TP.notValid(a=q.at('node'))){return;}if(TP.elementHasAttribute(a,'tibet:src',true)&&TP.notTrue(TP.bc(TP.elementGetAttribute(a,'tsh:fallback',true)))){h=TP.elementGetAttribute(a,'tibet:src',true);if(TP.isEmpty(h)||TP.notValid(j=TP.uc(h))){this.raise('TP.sig.InvalidURI',arguments,'Invalid URI in src attribute: '+h);return;}}if(TP.isEmpty(d=TP.elementGetAttribute(a,'tsh:name',true))){d='template_'+TP.genID();TP.elementSetAttribute(a,'tsh:name',d,true);}if(TP.isEmpty(k=TP.elementGetAttribute(a,'tibet:type',true))){k=TP.ietf.Mime.XML;}switch(k){case TP.ietf.Mime.JS:this.processJSTemplate(a,d,j);break;case TP.ietf.Mime.XSLT:this.processXSLTTemplate(a,d,j);break;case TP.ietf.Mime.XML:case TP.ietf.Mime.XHTML:this.processXMLTemplate(a,d,j);break;default:this.raise('TP.sig.InvalidTemplate',arguments,'Unknown template type: '+k);return;}if(TP.notEmpty(m=TP.elementGetAttribute(a,'tsh:generator',true))){e=this.getTemplateResult(d,a,q);if(!TP.isNode(e)){this.raise('TP.sig.InvalidNode',arguments,'Template '+d+' produced invalid output: '+e);return TP.CONTINUE;}if(!TP.isFragment(e)){TP.elementMergeAttributes(a,e,false);if(TP.elementGetAttribute(e,'tibet:phase',true)==='Compile'){TP.elementRemoveAttribute(e,'tsh:generator',true);}}b=TP.nodeImportNode(a,e);i=false;if(TP.isElement(b)&&TP.elementGetCanonicalName(b)===m){p=TP.nodeGetFirstChildElement(b);if(TP.notValid(p)){b=TP.elementReplaceWith(a,b);return TP.ac(b,TP.CONTINUE);}else{i=true;}}else if(!TP.isElement(b)){i=true;}if(i){l=b;b=TP.nodeListAsFragment(b.childNodes);n=TP.documentCreateElement(TP.nodeGetDocument(a),'fragwrapper');n.appendChild(b);b=n;}o=TP.request(TP.hc('cmdExecute',false,'cmdSilent',true,'cmdTargetDoc',TP.nodeGetDocument(a),'cmdPhases',TP.core.TSH.COMPILE_PHASES,'targetPhase','Compile'));c=TP.process(b,o);if(!TP.isNode(c=TP.unwrap(c))){this.raise('TP.sig.InvalidNode',arguments);}if(TP.name(c)==='fragwrapper'){c=TP.nodeListAsFragment(c.childNodes);TP.nodeAppendChild(l,c);c=l;}c=TP.elementReplaceWith(a,c,null,false);f=c;}else{f=a;}g=f.parentNode;if(TP.isElement(g)&&!TP.elementHasAttribute(g,'tsh:root_template',true)&&(TP.elementGetAttribute(f,'tsh:root',true)==='true'||TP.nodeGetElementsByTagName(g,'tsh:template').getSize()===1)){TP.elementSetAttribute(g,'tsh:root_template',d,true);TP.elementSetAttribute(f,'tsh:root','true',true);}if(TP.notEmpty(m)){TP.uc(TP.TIBET_URN_PREFIX+d).setResource(TP.wrap(c));return f;}else{return;}});
TP.boot.$srcPath = '~lib_src/tsh/tsh_test.js';
TP.core.ActionElementNode.defineSubtype('tsh:test');TP.tsh.test.addTraitsFrom(TP.tsh.Element);TP.tsh.test.Type.defineMethod('cmdRunContent',function(a){var b,c,d,g,h,e,f;TP.debug('break.tsh_test');d=TP.sys.getTypeByName('TP.test.Suite');if(TP.notValid(d)){a.fail(TP.FAILURE,'Unable to find TP.test.Suite.');return;}b=a.at('cmdShell');g=b.getArgument(a,'tsh:ignore_only',false);h=b.getArgument(a,'tsh:ignore_skip',false);e=TP.hc('ignore_only',g,'ignore_skip',h);c=b.getArgument(a,'ARG0');if(TP.isEmpty(c)){d.runTargetSuites(null,e).then(function(b){a.complete();},function(b){a.fail(b);});}else{f=b.resolveObjectReference(c,a);if(TP.notValid(f)){a.fail(TP.FAILURE,'Unable to resolve object: '+c);return;}f.runTestSuites(e).then(function(b){a.complete();},function(b){a.fail(b);});}return;});
TP.boot.$srcPath = '~lib_src/tsh/tsh_transform.js';
TP.core.ActionElementNode.defineSubtype('tsh:transform');TP.tsh.transform.addTraitsFrom(TP.core.PipeSegmentElementNode);TP.tsh.transform.addTraitsFrom(TP.tsh.Element);TP.tsh.transform.Type.defineMethod('compileTemplates',function(a){var c,b;c=TP.nodeGetElementsByTagName(a,'tsh:template');b=TP.lid(a,true);c.perform(function(c){var d,e,f,g;if(TP.isEmpty(d=TP.elementGetAttribute(c,'tsh:name',true))){d='template_'+b+'_'+TP.genID();TP.elementSetAttribute(c,'tsh:name',d,true);}e=TP.uc(TP.TIBET_URN_PREFIX+d);if(TP.notValid(e.getResource(TP.hc('async',false)))){TP.elementSetAttribute(c,'tsh:generator',b,true);f=TP.request(TP.hc('cmdExecute',false,'cmdSilent',true,'cmdTargetDoc',TP.nodeGetDocument(a),'cmdPhases',TP.core.TSH_COMPILE_PHASES,'targetPhase','Compile'));TP.process(c,f);g=TP.nodeGetFirstChildElement(c);e.setResource(TP.wrap(TP.nodeCloneNode(g)));}});return;});TP.tsh.transform.Type.defineMethod('transformInput',function(h,c,d){var a,b,e,g,f;a=TP.elementGetAttribute(c,'tsh:root_template',true);if(TP.isEmpty(a)){d.fail(TP.FAILURE,'Invalid root template name.');return;}b=a.startsWith(TP.TIBET_URN_PREFIX)?a:TP.TIBET_URN_PREFIX+a;if(TP.notValid(e=TP.uc(b).getResource(TP.hc('async',false)))){this.compileTemplates(c);if(TP.notValid(e=TP.uc(b).getResource(TP.hc('async',false)))){d.fail(TP.FAILURE,'Unable to find template: '+b);return;}}if(TP.elementGetAttribute(c,'tsh:repeat',true)==='true'){g=TP.hc('repeat',true);}f=TP.format(h,e,g);if(TP.isValid(f)){return f;}else{d.fail(TP.FAILURE,'Transform failed to produce output.');return;}});TP.tsh.transform.Inst.defineMethod('isSingleValued',function(){return false;});
TP.boot.$srcPath = '~lib_src/tsh/tsh_uri.js';
TP.core.ActionElementNode.defineSubtype('tsh:uri');TP.tsh.uri.addTraitsFrom(TP.tsh.Element);TP.tsh.uri.Type.defineMethod('cmdAddContent',function(a){return this.cmdRunContent(a);});TP.tsh.uri.Type.defineMethod('cmdFilterInput',function(a){return this.cmdRunContent(a);});TP.tsh.uri.Type.defineMethod('cmdGetContent',function(a){return this.cmdRunContent(a);});TP.tsh.uri.Type.defineMethod('cmdRunContent',function(a){var f,k,d,i,h,b,n,l,o,e,m,j,c,g;TP.debug('break.tsh_uri');f=a.at('cmdShell');if(f.getArgument(a,'tsh:debug',null,false)){return this.showDebug(a,true,false);}if(f.getArgument(a,'tsh:debug_resolve',null,false)){return this.showDebug(a,true,true);}k=a.at('cmdNode');d=TP.nodeGetTextContent(k);i=f.getArgument(a,'tsh:href',null,true);if(TP.isEmpty(i)){a.fail(TP.FAILURE,'Invalid href for URI');return;}h=TP.uc(i);if(TP.notValid(h)){a.fail(TP.FAILURE,'Badly formed href for URI');return;}b=TP.hc('uri',i);l=f.getArguments(a).getItems();o=l.getSize();for(e=0;e<o;e++){m=l.at(e);j=m.first();c=m.last();switch(j){case'tsh:pipe':b.atPut('pipe',c);break;case'tsh:href':break;case'tsh:verb':b.atPut('verb',c.toUpperCase());break;case'tsh:mimetype':b.atPut('mimetype',c);break;case'tsh:async':b.atPut('async',TP.bc(c));break;case'tsh:refresh':b.atPut('refresh',TP.bc(c));break;case'tsh:timeout':if(TP.isNumber(g=parseInt(c))){g=g.asDuration();}b.atPut('timeout',Date.getMillisecondsInDuration(g));break;case'tsh:encoding':b.atPut('encoding',c);break;case'tsh:separator':b.atPut('separator',c);break;case'tsh:noencode':b.atPut('noencode',TP.bc(c));break;default:if(/^(tsh:|ARGV)/.test(j)){continue;}g=f.resolveObjectReference(c,a);b.atPut(j,g);break;}}if(TP.notEmpty(d)){b.atPut('body',d);h.setResource(d);}e=9;n=a.stdin();while(e>0){d=n.at(e);if(TP.isValid(d)){b.atPut('body',d);h.setResource(d);break;}e--;}a.atPut('cmdInstance',h);a.atPut('TP.tsh.uri.params',b);TP.core.URI.cmdRunContent(a,TP.wrap(k).getRedirectionType());return;});TP.tsh.uri.Type.defineMethod('cmdSetContent',function(a){return this.cmdRunContent(a);});TP.tsh.uri.Type.defineMethod('cmdTransformInput',function(a){return this.cmdRunContent(a);});TP.tsh.uri.Type.defineMethod('tshCompile',function(c){var a,b;a=c.at('cmdNode');b=TP.elementBecome(a,'code',TP.hc('class','tibet-action'),TP.w3.Xmlns.XHTML,false);return TP.ac(b,TP.DESCEND);});TP.tsh.uri.Type.defineMethod('tshExecute',function(a){return this.cmdRunContent(a);});
TP.boot.$srcPath = '~lib_src/xml/lang/de/TPDELocale.js';
TP.core.Locale.defineSubtype('DELocale');TP.core.DELocale.Type.defineAttribute('langCode','de');TP.core.DELocale.Type.defineAttribute('falseStrings',TP.ac('0','','nein','Nein','NEIN','n','N','f','F','falsch','Falsch','FALSCH'));TP.core.DELocale.Type.defineAttribute('longMonthNames',TP.ac('Januar','Februar','Marz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'));TP.core.DELocale.Type.defineAttribute('shortMonthNames',TP.ac('Jan','Feb','Mar','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'));TP.core.DELocale.Type.defineAttribute('longWeekdayNames',TP.ac('Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Frietag','Samstag'));TP.core.DELocale.Type.defineAttribute('shortWeekdayNames',TP.ac('Son','Mon','Die','Mit','Don','Fri','Sam'));TP.core.Locale.registerLocale(TP.core.DELocale);
TP.boot.$srcPath = '~lib_src/xml/lang/en/TPENLocale.js';
TP.core.Locale.defineSubtype('ENLocale');TP.core.ENLocale.Type.defineAttribute('langCode','en');TP.core.Locale.registerLocale(TP.core.ENLocale);
TP.boot.$srcPath = '~lib_src/xml/lang/en_gb/TPENGBLocale.js';
TP.core.ENLocale.defineSubtype('ENGBLocale');TP.core.ENGBLocale.Type.defineAttribute('countryCode','gb');TP.core.Locale.registerLocale(TP.core.ENGBLocale);
TP.boot.$srcPath = '~lib_src/xml/lang/en_us/TPENUSLocale.js';
TP.core.ENLocale.defineSubtype('ENUSLocale');TP.core.ENUSLocale.Type.defineAttribute('countryCode','us');TP.core.Locale.registerLocale(TP.core.ENUSLocale);
TP.boot.$srcPath = '~lib_src/xml/lang/fr/TPFRLocale.js';
TP.core.Locale.defineSubtype('FRLocale');TP.core.FRLocale.Type.defineAttribute('langCode','fr');TP.core.Locale.registerLocale(TP.core.FRLocale);
TP.boot.$srcPath = '~lib_src/goog/goog_Element.js';
TP.core.ElementNode.defineSubtype('goog:Element');TP.w3.Xmlns.registerNSInfo('urn:goog',TP.hc('prefix','goog'));
TP.boot.$srcPath = '~lib_src/goog/services/TPGoogleResponse.js';
TP.sig.HTTPResponse.defineSubtype('GoogleResponse');
TP.boot.$srcPath = '~lib_src/goog/services/TPGoogleRequest.js';
TP.sig.HTTPRequest.defineSubtype('GoogleRequest');TP.sig.GoogleRequest.Type.defineAttribute('responseType','TP.sig.GoogleResponse');
TP.boot.$srcPath = '~lib_src/goog/services/TPGoogleService.js';
TP.core.HTTPService.defineSubtype('goog:GoogleService');TP.goog.GoogleService.isAbstract(true);TP.goog.GoogleService.Type.defineAttribute('gdataVersion','3.0');TP.goog.GoogleService.Type.defineAttribute('defaultedParameters',TP.hc('auth',TP.NONE,'iswebdav',false));TP.goog.GoogleService.register();TP.goog.GoogleService.Inst.defineAttribute('authToken');TP.goog.GoogleService.Inst.defineAttribute('username');TP.goog.GoogleService.Inst.defineAttribute('password');TP.goog.GoogleService.Inst.defineMethod('init',function(e,a){var b,c,d;this.callNextMethod();if(TP.isValid(a)){b=a;}else{b=TP.hc();}if(TP.notValid(c=b.at('username'))){a.fail(TP.FAILURE,TP.sc('Missing required username parameter in request'));return;}this.set('username',c);if(TP.notValid(d=b.at('password'))){a.fail(TP.FAILURE,TP.sc('Missing required password parameter in request'));return;}this.set('password',d);return this;});TP.goog.GoogleService.Inst.defineMethod('finalizeRequest',function(b){var a;var c;b.atPut('async',true);a=b.atPutIfAbsent('uriparams',TP.hc());switch(b.at('action')){case'login':a.atPut('accountType','GOOGLE');a.atPut('Email',this.get('username'));a.atPut('Passwd',this.get('password'));a.atPutIfAbsent('source',TP.join('TPI-TIBET-'+TP.sys.$version.root));break;}return this.callNextMethod();});TP.goog.GoogleService.Inst.defineMethod('handleRequestSucceeded',function(d){var a,e,b,f,c,g;a=d.getRequest();e=a.getResponse();switch(a.at('action')){case'login':if(TP.notEmpty(b=e.getResponseText())){f=b.match(/Error=([A-z]+)/);c=b.match(/Auth=([A-z0-9_-]+)/);if(b.indexOf('Email:')>0||TP.notEmpty(f)){TP.ifError()?TP.error('Google login error: '+b,TP.LOG,arguments):0;}else{if(TP.notEmpty(c)){g=c.at(1);this.set('authToken',g);}}}a.getParameters().removeKey('username');a.getParameters().removeKey('password');break;default:return this.callNextMethod();}return d;});TP.goog.GoogleService.Inst.defineMethod('handleHTTPRequest',function(a){var b;if(TP.isEmpty(this.get('authToken'))&&a.at('action')!=='login'){a.cancel(TP.FAILURE,TP.sc('No authToken available. Refiring after token fetched.'));b=TP.sig.GoogleRequest.construct(TP.hc('action','login'));b.defineMethod('handleRequestSucceeded',function(b){this.handleRequestSucceeded(b);b.stopPropagation();a.getParameters().removeKey('username');a.getParameters().removeKey('password');a.getParameters().atPut('auth',this.get('authToken'));a.fire();}.bind(this));TP.handle(this,b);return a.constructResponse();}return this.callNextMethod();});TP.goog.GoogleService.Inst.defineMethod('rewriteRequestHeaders',function(b){var a;a=this.callNextMethod();a.atPut('GData-Version',this.getType().get('gdataVersion'));switch(b.at('action')){case'login':break;default:a.atPut('Authorization','GoogleLogin auth='+this.get('authToken'));break;}return a;});TP.goog.GoogleService.Inst.defineMethod('rewriteRequestURI',function(a){switch(a.at('action')){case'login':return'https://www.google.com/accounts/ClientLogin';default:a.fail(TP.FAILURE,'Unrecognized action');return;}return this.callNextMethod();});TP.goog.GoogleService.Inst.defineMethod('rewriteRequestVerb',function(a){switch(a.at('action')){case'login':return TP.HTTP_POST;}return this.callNextMethod();});
TP.boot.$srcPath = '~lib_src/goog/services/docs/GoogleDocsResponse.js';
TP.sig.GoogleResponse.defineSubtype('GoogleDocsResponse');
TP.boot.$srcPath = '~lib_src/goog/services/docs/GoogleDocsRequest.js';
TP.sig.GoogleRequest.defineSubtype('GoogleDocsRequest');TP.sig.GoogleDocsRequest.Type.defineAttribute('responseType','TP.sig.GoogleDocsResponse');
TP.boot.$srcPath = '~lib_src/goog/services/docs/GoogleDocsHandler.js';
TP.core.URIHandler.defineSubtype('goog:GoogleDocsHandler');TP.goog.GoogleDocsHandler.Type.defineMethod('load',function(e,d){var a,c,b;TP.debug('break.uri_load');a=TP.request(d);c=a.constructResponse();b=TP.sig.GoogleDocsRequest.construct(TP.hc('action',a.atIfInvalid('action','downloadDoc'),'docId',a.at('docId'),'username',a.at('username'),'password',a.at('password')));a.andJoinChild(b);b.fire();a.updateRequestMode(b);return c;});TP.goog.GoogleDocsHandler.Type.defineMethod('nuke',function(a,b){return TP.todo();});TP.goog.GoogleDocsHandler.Type.defineMethod('save',function(e,f){var a,c,d,b;TP.debug('break.uri_save');a=TP.request(f);c=a.constructResponse();if(TP.isEmpty(d=e.getResource(TP.hc('async',false)))){a.fail();return c;}b=TP.sig.GoogleDocsRequest.construct(TP.hc('action','uploadDoc','body',d,'docName',a.at('name'),'refreshContent',false,'username',a.at('username'),'password',a.at('password')));a.andJoinChild(b);b.fire();a.updateRequestMode(b);return c;});
TP.boot.$srcPath = '~lib_src/goog/services/docs/GoogleDocsService.js';
TP.goog.GoogleService.defineSubtype('GoogleDocsService');TP.goog.GoogleDocsService.Type.defineAttribute('triggerSignals','TP.sig.GoogleDocsRequest');TP.goog.GoogleDocsService.Type.defineAttribute('defaultedParameters',TP.hc('serviceURI',TP.NONE,'auth',TP.NONE,'iswebdav',false));TP.goog.GoogleDocsService.register();TP.goog.GoogleDocsService.Inst.defineMethod('finalizeRequest',function(a){var b;a.atPut('async',true);b=a.atPutIfAbsent('uriparams',TP.hc());switch(a.at('action')){case'login':b.atPut('service','writely');break;case'downloadDoc':b.atPut('docId',a.at('docId'));break;}return this.callNextMethod();});TP.goog.GoogleDocsService.Inst.defineMethod('rewriteRequestBody',function(a){var b;switch(a.at('action')){case'uploadDoc':b=TP.ac(TP.hc('body',TP.join('<?xml version="1.0" encoding="UTF-8"?>','<entry xmlns="http://www.w3.org/2005/Atom" xmlns:docs="http://schemas.google.com/docs/2007">','<category scheme="http://schemas.google.com/g/2005#kind" term="http://schemas.google.com/docs/2007#document"/>','<title>',a.at('docName'),'</title>','<docs:writersCanInvite value="false" />','</entry>'),'mimetype',TP.ATOM_ENCODED),TP.hc('body',a.at('body'),'mimetype',TP.HTML_TEXT_ENCODED));a.atPut('body',b);a.atPut('mimetype',TP.MP_RELATED_ENCODED);break;}return this.callNextMethod();});TP.goog.GoogleDocsService.Inst.defineMethod('rewriteRequestURI',function(a){switch(a.at('action')){case'fetchDocList':case'uploadDoc':return'http://docs.google.com/feeds/default/private/full';case'downloadDoc':return'http://docs.google.com/feeds/download/documents/Export';}return this.callNextMethod();});TP.goog.GoogleDocsService.Inst.defineMethod('rewriteRequestVerb',function(a){switch(a.at('action')){case'fetchDocList':case'downloadDoc':return TP.HTTP_GET;case'uploadDoc':return TP.HTTP_POST;}return this.callNextMethod();});
TP.boot.$srcPath = '~lib_src/goog/services/contacts/GoogleContactsResponse.js';
TP.sig.GoogleResponse.defineSubtype('GoogleContactsResponse');
TP.boot.$srcPath = '~lib_src/goog/services/contacts/GoogleContactsRequest.js';
TP.sig.GoogleRequest.defineSubtype('GoogleContactsRequest');TP.sig.GoogleContactsRequest.Type.defineAttribute('responseType','TP.sig.GoogleContactsResponse');
TP.boot.$srcPath = '~lib_src/goog/services/contacts/GoogleContactsService.js';
TP.goog.GoogleService.defineSubtype('GoogleContactsService');TP.goog.GoogleContactsService.Type.defineAttribute('triggerSignals','TP.sig.GoogleContactsRequest');TP.goog.GoogleContactsService.Type.defineAttribute('defaultedParameters',TP.hc('serviceURI',TP.NONE,'auth',TP.NONE,'iswebdav',false));TP.goog.GoogleContactsService.register();TP.goog.GoogleContactsService.Inst.defineMethod('finalizeRequest',function(a){var b;a.atPut('async',true);b=a.atPutIfAbsent('uriparams',TP.hc());switch(a.at('action')){case'login':b.atPut('service','cp');break;}return this.callNextMethod();});TP.goog.GoogleContactsService.Inst.defineMethod('rewriteRequestURI',function(a){switch(a.at('action')){case'fetchContacts':return'http://www.google.com/m8/feeds/contacts/'+a.at('userEmail')+'/full';}return this.callNextMethod();});TP.goog.GoogleContactsService.Inst.defineMethod('rewriteRequestVerb',function(a){switch(a.at('action')){case'fetchContacts':return TP.HTTP_GET;}return this.callNextMethod();});
TP.boot.$srcPath = '~lib_src/goog/services/search/TPGoogleSearchTypes.js';
TP.core.JSONContent.defineSubtype('goog:GoogleSearchData');TP.goog.GoogleSearchData.Inst.defineAttribute('results',{'value':TP.apc('data.responseData.results')});TP.goog.GoogleSearchData.Inst.defineAttribute('resultsFromTo',{'value':TP.apc('data.responseData.results.[{{0}}:{{1}}]')});TP.goog.GoogleSearchData.Inst.defineAttribute('estimatedResultCount',{'value':TP.apc('data.responseData.cursor.estimatedResultCount',true)});TP.goog.GoogleSearchData.Inst.defineAttribute('currentPageIndex',{'value':TP.apc('data.responseData.cursor.currentPageIndex',true)});TP.goog.GoogleSearchData.Inst.defineAttribute('moreResultsUrl',{'value':TP.apc('data.responseData.cursor.moreResultsUrl',true)});
TP.boot.$srcPath = '~lib_src/amz/services/s3/AmazonS3Response.js';
TP.sig.RESTResponse.defineSubtype('AmazonS3Response');
TP.boot.$srcPath = '~lib_src/amz/services/s3/AmazonS3Request.js';
TP.sig.RESTRequest.defineSubtype('AmazonS3Request');TP.sig.AmazonS3Request.Type.defineAttribute('responseType','TP.sig.AmazonS3Response');TP.sig.AmazonS3Request.Inst.defineMethod('init',function(f,g,h){var b,a,d,c,e;b=this.callNextMethod();if(TP.isEmpty(e=TP.uc(b.at('uri')))){return;}b.atPut('serviceURI',TP.join(e.get('scheme'),'://',e.get('host')));if(TP.isEmpty(a=e.get('path'))){return b;}a=a.slice(1);if(!a.contains('/')){d=a.slice(0);b.atPut('bucketName',d);return b;}else{d=a.slice(0,a.indexOf('/'));b.atPut('bucketName',d);}c=a.slice(a.indexOf('/')+1);if(c.endsWith('/')){c=c.slice(0,a.lastIndexOf('/'));}b.atPut('keyName',c);return b;});TP.sig.AmazonS3Request.defineSubtype('AmazonS3GetItemRequest');TP.sig.AmazonS3GetItemRequest.Inst.defineMethod('init',function(a,b,c){a.atPutIfAbsent('action','getItemFromBucket');return this.callNextMethod();});TP.sig.AmazonS3Request.defineSubtype('AmazonS3PutItemRequest');TP.sig.AmazonS3PutItemRequest.Inst.defineMethod('init',function(a,b,c){a.atPutIfAbsent('action','putItemInBucket');return this.callNextMethod();});TP.sig.AmazonS3PutItemRequest.Inst.defineMethod('handle404',function(c){var b,a;if(c.get('faultText')==='Not Found'){b=this.getParameters();a=TP.sig.AmazonS3Request.construct(TP.hc('action','createBucket','uri',b.at('uri')));this.andJoinChild(a);a.defineMethod('handleRequestSucceeded',function(d){var c;c=TP.sig.AmazonS3PutItemRequest.construct(b);a.andJoinChild(c);c.fire();});a.fire();}else{this.fail();}});
TP.boot.$srcPath = '~lib_src/amz/services/s3/AmazonS3Handler.js';
TP.core.URIHandler.defineSubtype('amz:AmazonS3Handler');TP.amz.AmazonS3Handler.Type.defineMethod('load',function(c,f){var a,d,e,b;TP.debug('break.uri_load');a=TP.request(f);d=a.constructResponse();if(TP.notEmpty(e=a.at('action'))){b=TP.sig.AmazonS3Request.construct(TP.hc('action',e,'uri',c.asString()));}else{b=TP.sig.AmazonS3GetItemRequest.construct(TP.hc('uri',c.asString()));}b.atPut('key',a.at('key'));b.atPut('secretkey',a.at('secretkey'));a.andJoinChild(b);b.fire();a.updateRequestMode(b);return d;});TP.amz.AmazonS3Handler.Type.defineMethod('nuke',function(a,b){return TP.todo();});TP.amz.AmazonS3Handler.Type.defineMethod('save',function(d,f){var a,c,e,b;TP.debug('break.uri_save');a=TP.request(f);c=a.constructResponse();if(TP.isEmpty(e=d.getResourceText(TP.hc('async',false)))){a.fail();return c;}b=TP.sig.AmazonS3PutItemRequest.construct(TP.hc('uri',d.asString(),'body',e,'refreshContent',false));b.atPut('key',a.at('key'));b.atPut('secretkey',a.at('secretkey'));a.andJoinChild(b);b.fire();a.updateRequestMode(b);return c;});
TP.boot.$srcPath = '~lib_src/amz/services/s3/AmazonS3Service.js';
TP.core.RESTService.defineSubtype('amz:AmazonS3Service');TP.amz.AmazonS3Service.Type.defineAttribute('triggerSignals','TP.sig.AmazonS3Request');TP.amz.AmazonS3Service.register();TP.amz.AmazonS3Service.Inst.defineAttribute('serverKey');TP.amz.AmazonS3Service.Inst.defineAttribute('secretServerKey');TP.amz.AmazonS3Service.Inst.defineMethod('init',function(b,a){this.callNextMethod();this.configureAuthData(a);return this;});TP.amz.AmazonS3Service.Inst.defineMethod('clearAuthData',function(){this.callNextMethod();this.set('serverKey',null);this.set('secretServerKey',null);return this;});TP.amz.AmazonS3Service.Inst.defineMethod('configureAuthData',function(b){var a,c,d;this.callNextMethod();if(TP.isValid(b)){a=b;}else{a=TP.hc();}this.populateMissingVCardData(TP.hc('key',TP.ac('key','Enter server key (optional for public buckets): ',false),'secretkey',TP.ac('secretkey','Enter secret server key (optional for public buckets): ',false)),a);if(TP.notValid(c=a.at('key'))){b.fail(TP.FAILURE,TP.sc('Missing required server key parameter in request'));return;}this.set('serverKey',c);if(TP.notValid(d=a.at('secretkey'))){b.fail(TP.FAILURE,TP.sc('Missing required secret server key parameter in request'));return;}this.set('secretServerKey',d);return this;});TP.amz.AmazonS3Service.Inst.defineMethod('rewriteRequestVerb',function(a){switch(a.at('action')){case'createBucket':return TP.HTTP_PUT;case'deleteBucket':return TP.HTTP_DELETE;case'listBuckets':return TP.HTTP_GET;case'checkBucketExists':return TP.HTTP_HEAD;case'deleteItemFromBucket':return TP.HTTP_DELETE;case'listKeysInBucket':return TP.HTTP_GET;case'getItemFromBucket':return TP.HTTP_GET;case'headItemInBucket':return TP.HTTP_HEAD;case'putItemInBucket':return TP.HTTP_PUT;default:a.fail(TP.FAILURE,'Unrecognized action');return'';}return this.callNextMethod();});TP.amz.AmazonS3Service.Inst.defineMethod('rewriteRequestURI',function(a){var b;switch(a.at('action')){case'createBucket':case'deleteBucket':case'listKeysInBucket':case'checkBucketExists':b=TP.join('/',a.at('bucketName'));break;case'listBuckets':b='/';break;case'deleteItemFromBucket':case'getItemFromBucket':case'headItemInBucket':case'putItemInBucket':b=TP.join('/',a.at('bucketName'),'/',a.at('keyName'));break;default:a.fail(TP.FAILURE,'Unrecognized action');return;}a.atPut('resource',b);return this.get('serviceURI')+b;});TP.amz.AmazonS3Service.Inst.defineMethod('rewriteRequestHeaders',function(a){var b,h,k,f,g,c,i,e,j,l,d,n,m;b=this.callNextMethod();if(TP.isEmpty(h=a.at('verb'))){a.fail(TP.FAILURE,'No verb in TP.amz.AmazonS3Service::rewriteRequestHeaders');return null;}if(TP.isEmpty(k=a.at('resource'))){a.fail(TP.FAILURE,'No resource in TP.amz.AmazonS3Service::rewriteRequestHeaders');return null;}if(TP.isEmpty(f=this.get('serverKey'))&&TP.isEmpty(f=a.at('key'))){a.fail(TP.FAILURE,'No key in TP.amz.AmazonS3Service::rewriteRequestHeaders');return null;}if(TP.isEmpty(g=this.get('secretServerKey'))&&TP.isEmpty(g=a.at('secretKey'))){a.fail(TP.FAILURE,'No secretKey in TP.amz.AmazonS3Service::rewriteRequestHeaders');return null;}if(TP.notValid(c=a.at('contentType'))){if(h===TP.HTTP_PUT){c=TP.ietf.Mime.guessMIMEType(a.at('body'));if(a.at('action')==='putItemInBucket'){c+='; charset='+TP.UTF8;}}else{c='';}}b.atPut('Content-Type',c);if(f===TP.NULL||g===TP.NULL){return b;}e='';if(TP.notEmpty(j=a.at('acl'))){b.atPut('x-amz-acl',j);e+='x-amz-acl:'+j+'\n';}else if(a.at('action')==='putItemInBucket'){b.atPut('x-amz-acl','public-read');e+='x-amz-acl:'+'public-read'+'\n';}i=TP.dc().formatHTTPDate();b.atPut('x-amz-date',i);e+='x-amz-date:'+i+'\n';if(TP.isValid(l=a.at('meta'))){d=TP.ac();l.perform(function(a){b.atPut('x-amz-meta-'+a.first(),a.last());d.push('x-amz-meta-',a.first(),':',a.last(),'\n');});d=d.join('');}else{d='';}n=TP.join(h,'\n','','\n',c,'\n','','\n',e,d,k);m=TP.hmac(n,g,TP.HASH_SHA1,TP.HASH_B64);b.atPut('Authorization',TP.join('AWS ',f,':',m));return b;});
TP.boot.$srcPath = '~lib_src/amz/services/simpledb/AmazonSimpleDBResponse.js';
TP.sig.RESTResponse.defineSubtype('AmazonSimpleDBResponse');
TP.boot.$srcPath = '~lib_src/amz/services/simpledb/AmazonSimpleDBRequest.js';
TP.sig.RESTRequest.defineSubtype('AmazonSimpleDBRequest');TP.sig.AmazonSimpleDBRequest.Type.defineAttribute('responseType','TP.sig.AmazonSimpleDBResponse');
TP.boot.$srcPath = '~lib_src/amz/services/simpledb/AmazonSimpleDBHandler.js';
TP.core.URIHandler.defineSubtype('amz:AmazonSimpleDBHandler');TP.amz.AmazonSimpleDBHandler.Type.defineMethod('load',function(c,g){var a,d,b,e,f;TP.debug('break.uri_load');a=TP.request(g);d=a.constructResponse();if(TP.isEmpty(e=a.at('DomainName'))){b=TP.sig.AmazonSimpleDBRequest.construct(TP.hc('action','ListDomains','uri',c.asString()));}else if(TP.isEmpty(f=a.at('ItemName'))){b=TP.sig.AmazonSimpleDBRequest.construct(TP.hc('action','ListDomains','uri',c.asString()));}else{b=TP.sig.AmazonSimpleDBRequest.construct(TP.hc('action','GetAttributes','uri',c.asString(),'uriparams',TP.hc('DomainName',e,'ItemName',f)));}b.atPut('key',a.at('key'));b.atPut('secretkey',a.at('secretkey'));a.andJoinChild(b);b.fire();a.updateRequestMode(b);return d;});TP.amz.AmazonSimpleDBHandler.Type.defineMethod('nuke',function(a,b){return TP.todo();});TP.amz.AmazonSimpleDBHandler.Type.defineMethod('save',function(e,j){var a,c,d,f,g,h,i,b;TP.debug('break.uri_save');a=TP.request(j);c=a.constructResponse();if(TP.isEmpty(d=e.getResource(TP.hc('async',false,'refresh',false)))){a.fail(TP.FAILURE,'No content to send for: '+TP.str(e));return c;}if(TP.isString(d)){b=TP.sig.AmazonSimpleDBRequest.construct(TP.hc('action','Select','uri',e.asString(),'uriparams',TP.hc('SelectExpression',d)));}else{if(TP.isEmpty(f=a.at('DomainName'))){a.fail(TP.FAILURE,'Missing parameter: DomainName');return c;}if(TP.isEmpty(g=a.at('ItemName'))){a.fail(TP.FAILURE,'Missing parameter: ItemName');return c;}h=d.getKeys();i=d.getValues();b=TP.sig.AmazonSimpleDBRequest.construct(TP.hc('action','PutAttributes','uri',e.asString(),'uriparams',TP.hc('DomainName',f,'ItemName',g),'Names',h,'Values',i));}b.atPut('key',a.at('key'));b.atPut('secretkey',a.at('secretkey'));a.andJoinChild(b);b.fire();a.updateRequestMode(b);return c;});
TP.boot.$srcPath = '~lib_src/amz/services/simpledb/AmazonSimpleDBService.js';
TP.core.RESTService.defineSubtype('amz:AmazonSimpleDBService');TP.amz.AmazonSimpleDBService.Type.defineAttribute('triggerSignals','TP.sig.AmazonSimpleDBRequest');TP.amz.AmazonSimpleDBService.Type.defineAttribute('version','2009-04-15');TP.amz.AmazonSimpleDBService.register();TP.amz.AmazonSimpleDBService.Inst.defineAttribute('serverKey');TP.amz.AmazonSimpleDBService.Inst.defineAttribute('secretServerKey');TP.amz.AmazonSimpleDBService.Inst.defineMethod('init',function(b,a){this.callNextMethod();this.configureAuthData(a);return this;});TP.amz.AmazonSimpleDBService.Inst.defineMethod('clearAuthData',function(){this.callNextMethod();this.set('serverKey',null);this.set('secretServerKey',null);return this;});TP.amz.AmazonSimpleDBService.Inst.defineMethod('configureAuthData',function(b){var a,c,d;this.callNextMethod();if(TP.isValid(b)){a=b;}else{a=TP.hc();}this.populateMissingVCardData(TP.hc('key',TP.ac('key','Enter server key (optional for public buckets): '),'secretkey',TP.ac('secretkey','Enter secret server key (optional for public buckets): ')),a);if(TP.notValid(c=a.at('key'))){b.fail(TP.FAILURE,TP.sc('Missing required server key parameter in request'));return;}this.set('serverKey',c);if(TP.notValid(d=a.at('secretkey'))){b.fail(TP.FAILURE,TP.sc('Missing required secret server key parameter in request'));return;}this.set('secretServerKey',d);return this;});TP.amz.AmazonSimpleDBService.Inst.defineMethod('encodeURIParam',function(a){return encodeURIComponent(a).replace(/!/g,'%21').replace(/'/g,'%27').replace(/\(/g,'%28').replace(/\)/g,'%29').replace(/\*/g,'%2A');});TP.amz.AmazonSimpleDBService.Inst.defineMethod('finalizeRequest',function(a){var d,e,f,j,b,l,i,g,h,c,k;if(TP.isEmpty(d=this.get('serverKey'))&&TP.isEmpty(d=a.at('key'))){a.fail(TP.FAILURE,'No key in TP.amz.AmazonSimpleDBService::finalizeRequest');return null;}if(TP.isEmpty(e=this.get('secretServerKey'))&&TP.isEmpty(e=a.at('secretkey'))){a.fail(TP.FAILURE,'No secretKey in TP.amz.AmazonSimpleDBService::finalizeRequest');return null;}f=a.at('action');if(f==='PutAttributes'||f==='DeleteAttributes'){this.repackageAttributes(a);}j=TP.dc().as('TP.iso.ISO8601','%{yyyy}-%{mm}-%{dd}T%{hhi}:%{mmn}:%{ss}.000Z');b=TP.hc('Action',a.at('action'),'AWSAccessKeyId',d,'SignatureVersion','2','SignatureMethod','HmacSHA1','Timestamp',j,'Version',TP.amz.AmazonSimpleDBService.get('version'));if(TP.isValid(l=a.at('uriparams'))){b.addAll(l);}i=TP.keys(b).sort(TP.NATURAL_ORDER_SORT);g=TP.uc(a.at('uri'));h=g.get('path');c=TP.ac(a.at('verb'),'\n',g.get('host'),'\n',TP.isEmpty(h)?'/':h,'\n');i.perform(function(a){c.push(this.encodeURIParam(a).replace('%7E','~').replace('%2F','/'),'=',this.encodeURIParam(b.at(a)).replace('%7E','~'),'&');}.bind(this));c.pop();c=c.join('');k=TP.hmac(c,e,TP.HASH_SHA1,TP.HASH_B64);b.atPut('Signature',k);a.atPut('uriparams',b);return this.callNextMethod();});TP.amz.AmazonSimpleDBService.Inst.defineMethod('repackageAttributes',function(c){var d,a,e,f,g,b;d=c.at('action');a=c.at('uriparams');e=c.at('Names');f=c.at('Values');g=c.at('Replaces');if(TP.isEmpty(e)&&d==='DeleteAttributes'){return;}if(TP.isEmpty(e)){c.fail(TP.FAILURE,TP.join(TP.sc('Missing "Names" parameter in request for action:'),' "',d,'"'));return;}if(TP.isEmpty(f)){c.fail(TP.FAILURE,TP.join(TP.sc('Missing "Values" parameter in request for action:'),' "',d,'"'));return;}if(d==='PutAttributes'){b=0;f.perform(function(c,f){var d;d=e.at(f);if(TP.isArray(c)){c.perform(function(c){a.atPut(TP.join('Attribute.',b,'.Name'),d);a.atPut(TP.join('Attribute.',b++,'.Value'),c);});}else{a.atPut(TP.join('Attribute.',b,'.Name'),d);a.atPut(TP.join('Attribute.',b++,'.Value'),c);}});if(TP.notEmpty(g)){g.perform(function(c){var b;b=e.indexOf(c);a.atPut(TP.join('Attribute.',b,'.Replace'),'true');});}}else if(d==='DeleteAttributes'){b=0;f.perform(function(d,f){var c;c=e.at(f);if(TP.isArray(d)){d.perform(function(d){a.atPut(TP.join('Attribute.',b,'.Name'),c);a.atPut(TP.join('Attribute.',b++,'.Value'),d);});}else{a.atPut(TP.join('Attribute.',b++,'.Name'),c);}});}return;});TP.amz.AmazonSimpleDBService.Inst.defineMethod('rewriteRequestVerb',function(a){return TP.HTTP_GET;});
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_.js';
TP.core.XMLNamespace.defineSubtype('xctrls:XMLNS');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_Element.js';
TP.core.UIElementNode.defineSubtype('xctrls:Element');TP.xctrls.Element.addTraitsFrom(TP.core.NonNativeUIElementNode);TP.xctrls.Element.executeTraitResolution();TP.xctrls.Element.Type.defineAttribute('requiredAttrs');TP.xctrls.Element.Type.defineMethod('tagCompile',function(b){var a,c,d;a=b.at('node');TP.elementSetAttribute(a,'tibet:nodetype',TP.qname(a),true);if(TP.notEmpty(c=this.get('requiredAttrs'))){TP.elementSetAttributes(a,c,true);}if(TP.notEmpty(d=this.getCompilationAttrs(b))){TP.elementSetAttributes(a,d,true);}return;});TP.xctrls.Element.Type.defineMethod('cmdRunContent',function(a){var b;if(!TP.isElement(b=a.at('cmdNode'))){return;}a.atPut('cmdAsIs',true);a.atPut('cmdBox',false);a.complete(b);return;});
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_FramedElement.js';
TP.xctrls.Element.defineSubtype('FramedElement');TP.xctrls.FramedElement.Type.defineAttribute('frameFileURI');TP.xctrls.FramedElement.Type.defineMethod('tagAttachDOM',function(g){var a,c,d,e,f,b;this.callNextMethod();if(!TP.isElement(a=g.at('node'))){return;}d=TP.lid(a,true);e=TP.elem(TP.join('<iframe xmlns="',TP.w3.Xmlns.XHTML,'"',' id="',d,'_frame"',' style="position: relative; border: none;',' width: 100%; height: 100%"></iframe>'));TP.nodeAppendChild(a,e,false);c=TP.tpnode(a);if(TP.notEmpty(f=TP.elementGetAttribute(a,'stubHref'))){b=TP.uc(f);}else{b=this.get('frameFileURI');}c.startIFrameLoad(b);return TP.CONTINUE;});TP.xctrls.FramedElement.Type.defineMethod('cmdRunContent',function(a){var b;if(TP.notValid(b=a.at('cmdNode'))){return;}a.atPut('cmdAsIs',true);a.atPut('cmdBox',false);a.atPut('cmdMinHeight',200);a.complete(b);return;});TP.xctrls.FramedElement.Inst.defineAttribute('tpIFrame');TP.xctrls.FramedElement.Inst.defineMethod('init',function(b,c){var a;this.callNextMethod();a=this.getDocument().getElementById(this.getAttribute('id')+'_frame');if(TP.isKindOf(a,'TP.core.ElementNode')){this.set('tpIFrame',a);}return this;});TP.xctrls.FramedElement.Inst.defineMethod('configure',function(){this.signal('TP.sig.DOMReady');return this;});TP.xctrls.FramedElement.Inst.defineMethod('getNativeContentDocument',function(){return this.get('tpIFrame').getNativeContentDocument();});TP.xctrls.FramedElement.Inst.defineMethod('getNativeContentWindow',function(){return this.get('tpIFrame').getNativeContentWindow();});TP.xctrls.FramedElement.Inst.defineMethod('startIFrameLoad',function(b){var a,c;a=this.get('tpIFrame');a.getNativeNode().frameLoad=function(){this.configure();a.getNativeNode().tpObj=this;}.bind(this);if(TP.notEmpty(b)){c=a.getNativeContentWindow();c.location=b.getLocation();}else{}return this;});
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_MultiItemElement.js';
TP.core.UIElementNode.defineSubtype('xctrls:MultiItemElement');TP.xctrls.MultiItemElement.Inst.defineMethod('addItem',function(e,f,g){var a,b,c,d;if(!TP.isElement(a=this.get('body'))){return;}a=TP.wrap(a);if(TP.notEmpty(g)){b=this.get('transformWithName',g);}if(!TP.isElement(b)){if(!TP.isElement(b=this.get('firstTransform'))){return;}}if(!TP.isArray(c=e)){c=TP.ac(e);}d=TP.request(TP.hc('cmdExecute',true,'cmdPhases','Execute','cmdSilent',true));c.perform(function(e,h){var g,c;e.atPut('index',h);d.atPut(TP.STDIN,TP.ac(e));g=TP.process(b,d);c=TP.elem(g);if(TP.notEmpty(f)){a.insertProcessedContent(c,f);}else{a.addProcessedContent(c);}});return this;});
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_label/xctrls_label.js';
TP.core.UIElementNode.defineSubtype('xctrls:label');TP.xctrls.label.addTraitsFrom(TP.xctrls.Element);TP.xctrls.label.executeTraitResolution();
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_accordionbox/xctrls_accordionbox.js';
TP.core.UIElementNode.defineSubtype('xctrls:accordionbox');TP.xctrls.accordionbox.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.accordionbox.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.accordionbox.executeTraitResolution();TP.xctrls.accordionbox.Inst.defineAttribute('subitems',{'value':TP.cpc('xctrls|accordionitem',false)});TP.xctrls.accordionbox.Inst.defineAttribute('selectedItem',{'value':TP.cpc('xctrls|accordionitem[pclass|selected]',true)});TP.xctrls.accordionbox.Inst.defineAttribute('itemWithValue',{'value':TP.xpc('./xctrls:accordionitem/xctrls:value[text() = "{{1}}"]/..',true)});TP.xctrls.accordionbox.Inst.defineAttribute('selectedValue',{'value':TP.xpc('string(./xctrls:accordionitem'+'[@pclass:selected = "true"]/xctrls:value)',true)});TP.xctrls.accordionbox.Inst.defineMethod('getDisplayValue',function(){return this.get('selectedValue');});TP.xctrls.accordionbox.Inst.defineMethod('handleValueChange',function(a){this.toggleSelectedItem(this.get('selectedItem'),this.get('itemWithValue',this.get('value')));return;});TP.xctrls.accordionbox.Inst.defineMethod('handleDOMClick',function(c){var a,b;if(this.get('disabled')===true){return;}a=c.getTarget();if(TP.name(a)!=='xctrls:accordionitem'){if(TP.notValid(a=TP.wrap(a).get('ancestor::xctrls:accordionitem'))){return;}a=a.first();}if(!TP.isElement(a)){return;}b=TP.wrap(a).get('string(./xctrls:value)');if(TP.isValid(b)){this.set('value',b);}return;});TP.xctrls.accordionbox.Inst.defineMethod('setDisplayValue',function(a){this.toggleSelectedItem(this.get('selectedItem'),this.get('itemWithValue',a));return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.accordionbox.css_uri', '~TP.xctrls.accordionbox/xctrls_accordionbox.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.accordionbox.xhtml_uri', '~TP.xctrls.accordionbox/xctrls_accordionbox.xhtml');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_accordionitem/xctrls_accordionitem.js';
TP.core.UIElementNode.defineSubtype('xctrls:accordionitem');TP.xctrls.accordionitem.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.accordionitem.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.accordionitem.executeTraitResolution();
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.accordionitem.xsl_uri', '~TP.xctrls.accordionitem/xctrls_accordionitem.xsl');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_button/xctrls_button.js';
TP.core.UIElementNode.defineSubtype('xctrls:button');TP.xctrls.button.addTraitsFrom(TP.xctrls.Element);TP.xctrls.button.executeTraitResolution();
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.button.css_uri', '~TP.xctrls.button/xctrls_button.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.button.xhtml_uri', '~TP.xctrls.button/xctrls_button.xhtml');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.button.css_white_uri', '~TP.xctrls.XMLNS/themes/white/xctrls_button.css');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_checkitem/xctrls_checkitem.js';
TP.core.UIElementNode.defineSubtype('xctrls:checkitem');TP.xctrls.checkitem.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.checkitem.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.checkitem.executeTraitResolution();TP.xctrls.checkitem.Inst.defineAttribute('valuePElem',{'value':TP.cpc('*[tibet|pelem="value"]',true)});TP.xctrls.checkitem.Inst.defineMethod('handleDOMClick',function(a){if(this.get('disabled')===true){return;}this.toggleValue();return;});TP.xctrls.checkitem.Inst.defineMethod('getDisplayValue',function(){var a;if(this.hasAttribute('pclass:checked')){a=this.get('string(./xctrls:value)');return a;}return null;});TP.xctrls.checkitem.Inst.defineMethod('setDisabled',function(b){var a;a=this.get('valuePElem');if(TP.isTrue(b)){a.setAttribute('disabled',true);a.setAttribute('pclass:disabled','true');}else{a.removeAttribute('disabled');a.removeAttribute('pclass:disabled');}return this.callNextMethod();});TP.xctrls.checkitem.Inst.defineMethod('setDisplayValue',function(b){var a;a=this.get('string(./xctrls:value)');if(TP.equal(a,b)){this.setAttribute('pclass:checked','true');}else{this.removeAttribute('pclass:checked');}return this;});TP.xctrls.checkitem.Inst.defineMethod('toggleValue',function(){var b,a;b=this.getDisplayValue();if(this.hasAttribute('pclass:checked')){a=null;}else{a=this.get('string(./xctrls:value)');}this.set('value',a);if(this.shouldSignalChange()){this.changed('value',TP.UPDATE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,a));}return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.checkitem.css_uri', '~TP.xctrls.checkitem/xctrls_checkitem.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.checkitem.xhtml_uri', '~TP.xctrls.checkitem/xctrls_checkitem.xhtml');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_radioitem/xctrls_radioitem.js';
TP.core.UIElementNode.defineSubtype('xctrls:radioitem');TP.xctrls.radioitem.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.radioitem.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.radioitem.executeTraitResolution();TP.xctrls.radioitem.Inst.defineAttribute('valuePElem',{'value':TP.cpc('*[tibet|pelem="value"]',true)});TP.xctrls.radioitem.Inst.defineMethod('handleDOMClick',function(a){if(this.get('disabled')===true){return;}this.toggleValue();return;});TP.xctrls.radioitem.Inst.defineMethod('getDisplayValue',function(){var a;if(this.hasAttribute('pclass:checked')){a=this.get('string(./xctrls:value)');return a;}return null;});TP.xctrls.radioitem.Inst.defineMethod('setDisabled',function(b){var a;a=this.get('valuePElem');if(TP.isTrue(b)){a.setAttribute('disabled',true);a.setAttribute('pclass:disabled','true');}else{a.removeAttribute('disabled');a.removeAttribute('pclass:disabled');}return this.callNextMethod();});TP.xctrls.radioitem.Inst.defineMethod('setDisplayValue',function(b){var a;a=this.get('string(./xctrls:value)');if(TP.equal(a,b)){this.setAttribute('pclass:checked','true');}else{this.removeAttribute('pclass:checked');}return this;});TP.xctrls.radioitem.Inst.defineMethod('toggleValue',function(){var b,a;b=this.getDisplayValue();if(this.hasAttribute('pclass:checked')){a=null;}else{a=this.get('string(./xctrls:value)');}this.set('value',a);if(this.shouldSignalChange()){this.changed('value',TP.UPDATE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,a));}return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.radioitem.css_uri', '~TP.xctrls.radioitem/xctrls_radioitem.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.radioitem.xhtml_uri', '~TP.xctrls.radioitem/xctrls_radioitem.xhtml');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_textitem/xctrls_textitem.js';
TP.core.UIElementNode.defineSubtype('xctrls:textitem');TP.xctrls.textitem.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.textitem.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.textitem.executeTraitResolution();TP.xctrls.textitem.Inst.defineMethod('handleDOMClick',function(a){if(this.get('disabled')===true){return;}this.toggleValue();return;});TP.xctrls.textitem.Inst.defineMethod('getDisplayValue',function(){var a;if(this.hasAttribute('pclass:selected')){a=this.get('string(./xctrls:value)');return a;}return null;});TP.xctrls.textitem.Inst.defineMethod('setDisplayValue',function(b){var a;a=this.get('string(./xctrls:value)');if(TP.equal(a,b)){this.setAttribute('pclass:selected','true');}else{this.removeAttribute('pclass:selected');}return this;});TP.xctrls.textitem.Inst.defineMethod('toggleValue',function(){var b,a;b=this.getDisplayValue();if(this.hasAttribute('pclass:selected')){a=null;}else{a=this.get('string(./xctrls:value)');}this.set('value',a);if(this.shouldSignalChange()){this.changed('value',TP.UPDATE,TP.hc(TP.OLDVAL,b,TP.NEWVAL,a));}return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.textitem.css_uri', '~TP.xctrls.textitem/xctrls_textitem.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.textitem.xhtml_uri', '~TP.xctrls.textitem/xctrls_textitem.xhtml');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_chart/xctrls_chart.js';
TP.xctrls.FramedElement.defineSubtype('chart');TP.xctrls.chart.Type.defineAttribute('frameFileURI',TP.uc('~lib_src/xctrls/xctrls_chart/xctrls_chart_stub.html'));TP.xctrls.chart.Type.defineMethod('cmdSetContent',function(a){var b,c,d;if(TP.isEmpty(b=a.stdin())){return a.fail(TP.FAILURE,'No content');}if(TP.notValid(c=a.at('cmdInstance'))){return a.fail(TP.FAILURE,'No command instance');}d=b.at(0);c.setContent(d,a);a.complete();return;});TP.xctrls.chart.Type.defineMethod('getCompilationAttrs',function(c){var a,b;if(!TP.isElement(a=c.at('node'))){return TP.hc();}b=TP.ifEmpty(TP.elementGetAttribute(a,'type'),'bar');return TP.hc('tibet:nodetype','xctrls:'+b+'chart');});TP.xctrls.chart.Type.defineMethod('getResourceTypeName',function(){return'TP.xctrls.chart';});TP.xctrls.chart.Inst.defineAttribute('currentData');TP.xctrls.chart.Inst.defineMethod('configure',function(){this.set('currentData',null);this.refresh();return this.callNextMethod();});TP.xctrls.chart.Inst.defineMethod('$getD3Inst',function(){return this.get('tpIFrame').getNativeContentWindow().d3;});TP.xctrls.chart.Inst.defineMethod('getDisplayValue',function(){return this.get('currentData');});TP.xctrls.chart.Inst.defineMethod('refresh',function(a){return;});TP.xctrls.chart.Inst.defineMethod('setDisplayValue',function(a){this.set('currentData',a);this.refresh();return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.chart.css_uri', '~TP.xctrls.chart/xctrls_chart.css');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_chart/xctrls_barchart.js';
TP.xctrls.chart.defineSubtype('barchart');TP.xctrls.barchart.Inst.defineMethod('refresh',function(k){var i,h,j,g,a,b,c,d,f,e;if(TP.notValid(i=this.get('currentData'))){return;}if(!TP.isElement(h=this.get('tpIFrame').getNativeContentDocument().body)){return;}TP.nodeEmptyContent(h);j=this.$getD3Inst();g=430;a=230;b=TP.extern.d3.scale.linear().domain([0,1]).range([0,g]);c=TP.extern.d3.scale.ordinal().domain(TP.extern.d3.range(i.length)).rangeBands([0,a],0.2);d=TP.extern.d3.select(h).append('svg:svg').attr('width',g+40).attr('height',a+20).append('svg:g').attr('transform','translate(20,0)');f=d.selectAll('g.bar').data(i).enter().append('svg:g').attr('class','bar').attr('transform',function(b,a){return'translate(0,'+c(a)+')';});f.append('svg:rect').attr('fill','steelblue').attr('width',b).attr('height',c.rangeBand());f.append('svg:text').attr('x',b).attr('y',c.rangeBand()/2).attr('dx',-6).attr('dy','.35em').attr('fill','white').attr('text-anchor','end').text(b.tickFormat(100));f.append('svg:text').attr('x',0).attr('y',c.rangeBand()/2).attr('dx',-6).attr('dy','.35em').attr('text-anchor','end').text(function(b,a){return String.fromCharCode(65+a);});e=d.selectAll('g.rule').data(b.ticks(10)).enter().append('svg:g').attr('class','rule').attr('transform',function(a){return'translate('+b(a)+',0)';});e.append('svg:line').attr('y1',a).attr('y2',a+6).attr('stroke','black');e.append('svg:line').attr('y1',0).attr('y2',a).attr('stroke','white').attr('stroke-opacity',0.3);e.append('svg:text').attr('y',a+9).attr('dy','.71em').attr('text-anchor','middle').text(b.tickFormat(10));d.append('svg:line').attr('y1',0).attr('y2',a).attr('stroke','black');return;});
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_clipbox/xctrls_clipbox.js';
TP.core.UIElementNode.defineSubtype('xctrls:clipbox');TP.xctrls.clipbox.addTraitsFrom(TP.xctrls.Element);TP.xctrls.clipbox.executeTraitResolution();TP.xctrls.clipbox.Inst.defineAttribute('bodyElement',{'value':TP.cpc('> xctrls|body',true)});TP.xctrls.clipbox.Inst.defineMethod('getDisplayValue',function(){var c,b,d,a,e;c=this.getHeight();b=this.get('bodyElement');d=TP.elementGetHeight(b);a=TP.elementGetStyleValueInPixels(b,'top');a=a.asNumber().abs();e=a/(d-c);return e;});TP.xctrls.clipbox.Inst.defineMethod('handleSlide',function(b){var a;a=b.getPayload();this.moveByIncrement(a.at('side'),TP.ifInvalid(a.at('increment'),this.getAttribute('xctrls:increment')));return this;});TP.xctrls.clipbox.Inst.defineMethod('handleValueChange',function(a){this.setValue(a.getSignalOrigin().getValue());return;});TP.xctrls.clipbox.Inst.defineMethod('moveByIncrement',function(e,f){var a,c,b,d;a=this.get('bodyElement');c=TP.ifInvalid(e,'TP.TOP');b=TP.elementGetPixelValue(a,f,'top');if(c==='TP.TOP'){b=-b;}d=TP.elementGetStyleValueInPixels(a,'top');TP.elementGetStyleObj(a).top=d+b+'px';return this;});TP.xctrls.clipbox.Inst.defineMethod('setDisplayValue',function(e){var b,a,c,d;b=this.getHeight();a=this.get('bodyElement');c=TP.elementGetHeight(a);d=e*(c-b);TP.elementGetStyleObj(a).top=-d+'px';return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.clipbox.css_uri', '~TP.xctrls.clipbox/xctrls_clipbox.css');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_curtain/xctrls_curtain.js';
TP.core.UIElementNode.defineSubtype('xctrls:curtain');TP.xctrls.curtain.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.curtain.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.curtain.executeTraitResolution();TP.xctrls.curtain.set('requiredAttrs',TP.hc('pclass:hidden',true));
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.curtain.css_uri', '~TP.xctrls.curtain/xctrls_curtain.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.curtain.xhtml_uri', '~TP.xctrls.curtain/xctrls_curtain.xhtml');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_dialog/xctrls_dialog.js';
TP.core.UIElementNode.defineSubtype('xctrls:dialog');TP.xctrls.dialog.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.dialog.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.dialog.executeTraitResolution();TP.xctrls.dialog.Inst.defineAttribute('body',{'value':TP.cpc('*[tibet|pelem="body"]',true)});TP.xctrls.dialog.Inst.defineAttribute('curtain',{'value':TP.xpc('//xctrls:curtain[1]',true).set('fallbackWith',function(a){var b,c;b=TP.elem('<xctrls:curtain xmlns:xctrls="'+TP.w3.Xmlns.XCONTROLS+'"/>');if(TP.isValid(c=TP.wrap(TP.documentGetBody(a)))){return TP.unwrap(c.insertContent(b,TP.BEFORE_END,TP.hc('doc',a)));}})});TP.xctrls.dialog.Inst.defineMethod('getDisplayValue',function(){return TP.wrap(this.get('body')).getContentText();});TP.xctrls.dialog.Inst.defineMethod('setClosed',function(b){var a;if(this.getAttribute('modal')==='true'){if(TP.isValid(a=TP.wrap(this.get('curtain')))){a.set('hidden',b);}}return this.callNextMethod();});TP.xctrls.dialog.Inst.defineMethod('setDisplayValue',function(a){TP.wrap(this.get('body')).setContent(a);return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.dialog.css_uri', '~TP.xctrls.dialog/xctrls_dialog.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.dialog.xsl_uri', '~TP.xctrls.dialog/xctrls_dialog.xsl');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.dialog.css_white_uri', '~TP.xctrls.XMLNS/themes/white/xctrls_dialog.css');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_drawerbox/xctrls_drawerbox.js';
TP.core.UIElementNode.defineSubtype('xctrls:drawerbox');TP.xctrls.drawerbox.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.drawerbox.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.drawerbox.executeTraitResolution();
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.drawerbox.css_uri', '~TP.xctrls.drawerbox/xctrls_drawerbox.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.drawerbox.xhtml_uri', '~TP.xctrls.drawerbox/xctrls_drawerbox.xhtml');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_codeeditor/xctrls_codeeditor.js';
TP.xctrls.FramedElement.defineSubtype('codeeditor');TP.xctrls.codeeditor.Type.defineConstant('XML_MODE','xml');TP.xctrls.codeeditor.Type.defineConstant('CSS_MODE','css');TP.xctrls.codeeditor.Type.defineConstant('JS_MODE','javascript');TP.xctrls.codeeditor.set('frameFileURI',TP.uc('~lib_src/xctrls/xctrls_codeeditor/xctrls_codeeditor_stub.html'));TP.xctrls.codeeditor.addTraitsFrom(TP.html.textUtilities);TP.xctrls.codeeditor.Type.resolveTraits(TP.ac('tagCompile','canConnectFrom','canConnectTo','isValidConnectorDest','isValidConnectorSource'),TP.xctrls.FramedElement);TP.xctrls.codeeditor.Inst.resolveTraits(TP.ac('getValue','setValue','addCSSClass','getClass','getStyle','removeCSSClass','replaceCSSClass','setClass','setStyle','setHidden'),TP.html.textUtilities);TP.xctrls.codeeditor.executeTraitResolution();TP.xctrls.codeeditor.Type.defineMethod('cmdGetContent',function(a){var c,b;if(TP.notValid(c=a.at('cmdInstance'))){return a.fail(TP.FAILURE,'No command instance.');}if(TP.notValid(b=c.getValue())){return a.fail(TP.FAILURE,'No content.');}else{b=TP.join('<span xmlns="',TP.w3.Xmlns.XHTML,'">',b,'</span>');return a.complete(b);}});TP.xctrls.codeeditor.Type.defineMethod('cmdSetContent',function(a){var b,c,d;if(TP.isEmpty(b=a.stdin())){return a.fail(TP.FAILURE,'No content.');}if(TP.notValid(c=a.at('cmdInstance'))){return a.fail(TP.FAILURE,'No command instance.');}d=b.at(0);c.setContent(d,a);a.complete();return;});TP.xctrls.codeeditor.Inst.defineAttribute('$oldSelectionLength');TP.xctrls.codeeditor.Inst.defineAttribute('$currentKeyHandler');TP.xctrls.codeeditor.Inst.defineMethod('appendToLine',function(c,d){var a,b,e;a=this.$getEditorInstance();if(d===TP.LAST){b=a.lastLine();}else{b=d;}e=a.lineInfo(b);a.replaceRange(c,this.createPos(b,e.text.length));this.changed('selection',TP.INSERT,TP.hc(TP.OLDVAL,'',TP.NEWVAL,c));return this;});TP.xctrls.codeeditor.Inst.defineMethod('configure',function(){this.refresh();return this.callNextMethod();});TP.xctrls.codeeditor.Inst.defineMethod('createPos',function(a,b){return this.$getEditorConstructor().Pos(a,b);});TP.xctrls.codeeditor.Inst.defineMethod('executeMode',function(a,b,c){this.$getEditorConstructor().runMode(a,b,c);return this;});TP.xctrls.codeeditor.Inst.defineMethod('focus',function(){this.$getEditorInstance().focus();return this;});TP.xctrls.codeeditor.Inst.defineMethod('getCursor',function(a){return this.$getEditorInstance().getCursor(a);});TP.xctrls.codeeditor.Inst.defineMethod('getDisplayValue',function(){return this.$getEditorInstance().getValue();});TP.xctrls.codeeditor.Inst.defineMethod('$getEditorConstructor',function(){return this.get('tpIFrame').getNativeContentWindow().CodeMirror;});TP.xctrls.codeeditor.Inst.defineMethod('$getEditorInstance',function(){return this.get('tpIFrame').get('cmEditor');});TP.xctrls.codeeditor.Inst.defineMethod('getEditorHeight',function(){return TP.elementGetHeight(this.$getEditorInstance().display.sizer);});TP.xctrls.codeeditor.Inst.defineMethod('insertAtCursor',function(b){var a;a=this.$getEditorInstance();a.setSelection(a.getCursor(),a.getCursor());a.replaceSelection(b);this.changed('selection',TP.INSERT,TP.hc(TP.OLDVAL,'',TP.NEWVAL,b));return this;});TP.xctrls.codeeditor.Inst.defineMethod('refresh',function(a){return;});TP.xctrls.codeeditor.Inst.defineMethod('refreshEditor',function(){this.$getEditorInstance().refresh();return this;});TP.xctrls.codeeditor.Inst.defineMethod('select',function(){var a,b;a=this.$getEditorInstance();if(TP.notValid(b=a.lineInfo(a.lastLine()))){return this;}a.setSelection({line:0,ch:0},{line:b.line,ch:b.text.length});this.focus();return this;});TP.xctrls.codeeditor.Inst.defineMethod('setDisplayValue',function(a){if(TP.regex.CONTAINS_ELEM_MARKUP.test(a)){this.setEditorMode(this.getType().XML_MODE);}else{this.setEditorMode(this.getType().JS_MODE);}this.$getEditorInstance().setValue(a);return this;});TP.xctrls.codeeditor.Inst.defineMethod('setEditorEventHandler',function(a,b){this.$getEditorInstance().on(a,b);return this;});TP.xctrls.codeeditor.Inst.defineMethod('setEditorMode',function(a){this.$getEditorInstance().setOption('mode',a);return this;});TP.xctrls.codeeditor.Inst.defineMethod('setEditorTheme',function(a){this.$getEditorInstance().setOption('theme',a);return this;});TP.xctrls.codeeditor.Inst.defineMethod('setKeyHandler',function(c){var a,b;a=function(b,a){c(a);};b=this.$getEditorInstance();b.on('keydown',a);b.on('keyup',a);b.on('keypress',a);this.set('$currentKeyHandler',a);return this;});TP.xctrls.codeeditor.Inst.defineMethod('setShowLineNumbers',function(a){this.$getEditorInstance().setOption('lineNumbers',a);return this;});TP.xctrls.codeeditor.Inst.defineMethod('setWrap',function(a){this.$getEditorInstance().lineWrapping=a;return this;});TP.xctrls.codeeditor.Inst.defineMethod('unsetCurrentKeyHandler',function(){var a,b;if(!TP.isCallable(a=this.get('$currentKeyHandler'))){return this;}b=this.$getEditorInstance();b.off('keydown',a);b.off('keyup',a);b.off('keypress',a);this.set('$currentKeyHandler',null);return this;});TP.xctrls.codeeditor.Inst.defineMethod('unsetEditorEventHandler',function(a,b){this.$getEditorInstance().off(a,b);return this;});TP.xctrls.codeeditor.Inst.defineMethod('clearValue',function(){var a;a=this.$getEditorInstance().getValue();this.$getEditorInstance().setValue('');this.changed('value',TP.DELETE,TP.hc(TP.OLDVAL,a,TP.NEWVAL,''));return this;});TP.xctrls.codeeditor.Inst.defineMethod('clearSelection',function(){var a;a=this.getSelection();this.$getEditorInstance().replaceSelection('');this.changed('selection',TP.DELETE,TP.hc(TP.OLDVAL,a,TP.NEWVAL,''));return this;});TP.xctrls.codeeditor.Inst.defineMethod('collapseSelection',function(f){var d,e,a,b,c;d=this.$getEditorInstance();e=d.listSelections();if(TP.isEmpty(e)||TP.notValid(a=e.first())){return this;}if(a.anchor.line===a.head.line&&a.anchor.ch===a.head.ch){return this;}if(a.anchor.line<a.head.line){b=a.anchor;c=a.head;}else if(a.anchor.line===a.head.line){if(a.anchor.ch<a.head.ch){b=a.anchor;c=a.head;}else{b=a.head;c=a.anchor;}}else if(a.anchor.line>a.head.line){b=a.head;c=a.anchor;}if(f){d.setSelection(b,c);}else{d.setSelection(c,b);}return this;});TP.xctrls.codeeditor.Inst.defineMethod('getSelection',function(){return this.$getEditorInstance().getSelection(TP.JOIN);});TP.xctrls.codeeditor.Inst.defineMethod('getSelectionEnd',function(){return this.$getEditorInstance().getCursor('to').ch;});TP.xctrls.codeeditor.Inst.defineMethod('getSelectionStart',function(){return this.$getEditorInstance().getCursor('from').ch;});TP.xctrls.codeeditor.Inst.defineMethod('insertAfterSelection',function(c){var a,b;a=this.getSelection();this.$getEditorInstance().replaceSelection(TP.join(a,c));b=this.getSelection();this.changed('selection',TP.INSERT,TP.hc(TP.OLDVAL,a,TP.NEWVAL,b));return this;});TP.xctrls.codeeditor.Inst.defineMethod('insertBeforeSelection',function(c){var a,b;a=this.getSelection();this.$getEditorInstance().replaceSelection(TP.join(c,a));b=this.getSelection();this.changed('selection',TP.INSERT,TP.hc(TP.OLDVAL,a,TP.NEWVAL,b));return this;});TP.xctrls.codeeditor.Inst.defineMethod('replaceSelection',function(c){var a,b;a=this.getSelection();this.$getEditorInstance().replaceSelection(c);b=this.getSelection();this.changed('selection',TP.UPDATE,TP.hc(TP.OLDVAL,a,TP.NEWVAL,b));return this;});TP.xctrls.codeeditor.Inst.defineMethod('selectFromTo',function(d,e){var a,b,c;a=this.$getEditorInstance();b=a.posFromIndex(d);c=a.posFromIndex(e);a.setSelection(b,c);return this;});TP.xctrls.codeeditor.Inst.defineMethod('setCursorPosition',function(c){var a,b;a=this.$getEditorInstance();b=a.posFromIndex(c);a.setCursor(b);return this;});TP.xctrls.codeeditor.Inst.defineMethod('setCursorToEnd',function(){var a,b;a=this.$getEditorInstance();if(TP.notValid(b=a.lineInfo(a.lastLine()))){return this;}a.setCursor({line:b.line,ch:b.text.length});return this;});TP.xctrls.codeeditor.Inst.defineMethod('setCursorToStart',function(){this.$getEditorInstance().setCursor({line:0,ch:0});return this;});TP.xctrls.codeeditor.Inst.defineMethod('setSelection',function(a){this.replaceSelection(a);return this;});TP.xctrls.codeeditor.Inst.defineMethod('wrapSelection',function(a,b){this.replaceSelection(TP.join(a,this.getSelection(),b));return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.codeeditor.css_uri', '~TP.xctrls.codeeditor/xctrls_codeeditor.css');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_listbox/xctrls_listbox.js';
TP.core.UIElementNode.defineSubtype('xctrls:listbox');TP.xctrls.listbox.addTraitsFrom(TP.xctrls.Element,TP.xctrls.MultiItemElement,TP.core.TemplatedNode);TP.xctrls.listbox.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.listbox.executeTraitResolution();TP.xctrls.listbox.Inst.defineAttribute('items',{'value':TP.cpc('*[class~="item"]',false)});TP.xctrls.listbox.Inst.defineAttribute('selectedItem',{'value':TP.cpc('xctrls|textitem[pclass|selected]',true)});TP.xctrls.listbox.Inst.defineAttribute('itemWithValue',{'value':TP.xpc('./html:div/xctrls:textitem/xctrls:value[text() = "{{1}}"]/..',true)});TP.xctrls.listbox.Inst.defineAttribute('selectedValue',{'value':TP.xpc('string(./html:div/xctrls:textitem[@pclass:selected = "true"]/xctrls:value)',true)});TP.xctrls.listbox.Inst.defineAttribute('body',{'value':TP.xpc('.//xctrls:body',true)});TP.xctrls.listbox.Inst.defineAttribute('firstTransform',{'value':TP.xpc('.//tsh:transform[1]',true)});TP.xctrls.listbox.Inst.defineAttribute('transformWithName',{'value':TP.xpc('.//tsh:transform/tsh:template[@tsh:name = "{{1}}"]/..',true)});TP.xctrls.listbox.Type.defineMethod('tagAttachDOM',function(a){TP.xctrls.Element.tagAttachDOM.call(this,a);TP.core.EmbeddedTemplateNode.tagAttachDOM.call(this,a);return;});TP.xctrls.listbox.Inst.defineMethod('getDisplayValue',function(){return this.get('selectedValue');});TP.xctrls.listbox.Inst.defineMethod('handleValueChange',function(a){this.toggleSelectedItem(this.get('selectedItem'),this.get('itemWithValue',this.get('value')));return;});TP.xctrls.listbox.Inst.defineMethod('handleDOMClick',function(c){var a,b;if(this.get('disabled')===true){return;}a=c.getTarget();if(TP.name(a)!=='xctrls:textitem'){if(TP.notValid(a=TP.wrap(a).get('ancestor::xctrls:textitem'))){return;}a=a.first();}if(!TP.isElement(a)){return;}b=TP.wrap(a).get('string(./xctrls:value)');if(TP.isValid(b)){this.set('value',b);}return;});TP.xctrls.listbox.Inst.defineMethod('setDisplayValue',function(a){this.toggleSelectedItem(this.get('selectedItem'),this.get('itemWithValue',a));return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.listbox.css_uri', '~TP.xctrls.listbox/xctrls_listbox.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.listbox.xhtml_uri', '~TP.xctrls.listbox/xctrls_listbox.xhtml');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_log/xctrls_log.js';
TP.core.UIElementNode.defineSubtype('xctrls:log');TP.xctrls.log.addTraitsFrom(TP.xctrls.Element,TP.xctrls.MultiItemElement,TP.core.TemplatedNode);TP.xctrls.log.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.log.executeTraitResolution();TP.xctrls.log.Inst.defineAttribute('body',{'value':TP.cpc('*[tibet|pelem="body"]',true)});TP.xctrls.log.Inst.defineAttribute('firstTransform',{'value':TP.xpc('.//tsh:transform[1]',true)});TP.xctrls.log.Inst.defineAttribute('transformWithName',{'value':TP.xpc('.//tsh:transform/tsh:template[@tsh:name = "{{1}}"]/..',true)});TP.xctrls.log.Type.defineMethod('tagAttachDOM',function(a){TP.xctrls.Element.tagAttachDOM.call(this,a);TP.core.EmbeddedTemplateNode.tagAttachDOM.call(this,a);return;});TP.xctrls.log.Inst.defineMethod('handleChange',function(c){var a,b,d;a=c.get('aspect');b=TP.wrap(c.getOrigin());d=b.get(a);this.logData(TP.join('The "',a,'" aspect',' of: "',b.getID(),'"',' changed to: "',d,'"'));return;});TP.xctrls.log.Inst.defineMethod('logData',function(b){var a;this.addItem(TP.hc('itemData',b));a=this.get('body');a.scrollTop=a.scrollHeight;return;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.log.css_uri', '~TP.xctrls.log/xctrls_log.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.log.xhtml_uri', '~TP.xctrls.log/xctrls_log.xhtml');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.log.css_white_uri', '~TP.xctrls.XMLNS/themes/white/xctrls_log.css');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_notifier/xctrls_notifier.js';
TP.core.UIElementNode.defineSubtype('xctrls:notifier');TP.xctrls.notifier.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.notifier.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.notifier.executeTraitResolution();
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.notifier.css_uri', '~TP.xctrls.notifier/xctrls_notifier.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.notifier.xhtml_uri', '~TP.xctrls.notifier/xctrls_notifier.xhtml');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_tabbar/xctrls_tabbar.js';
TP.core.UIElementNode.defineSubtype('xctrls:tabbar');TP.xctrls.tabbar.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.tabbar.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.tabbar.executeTraitResolution();TP.xctrls.tabbar.Inst.defineAttribute('tabs',{'value':TP.cpc('xctrls|tabitem',false)});TP.xctrls.tabbar.Inst.defineAttribute('selectedTab',{'value':TP.cpc('xctrls|tabitem[pclass|selected]',true)});TP.xctrls.tabbar.Inst.defineAttribute('tabWithValue',{'value':TP.xpc('./xctrls:tabitem/xctrls:value[text() = "{{1}}"]/..',true)});TP.xctrls.tabbar.Inst.defineAttribute('selectedValue',{'value':TP.xpc('string(./xctrls:tabitem[@pclass:selected = "true"]/xctrls:value)',true)});TP.xctrls.tabbar.Inst.defineMethod('getDisplayValue',function(){return this.get('selectedValue');});TP.xctrls.tabbar.Inst.defineMethod('handleDOMClick',function(c){var a,b;if(this.get('disabled')===true){return;}a=c.getTarget();if(TP.name(a)!=='xctrls:tabitem'){if(TP.notValid(a=TP.wrap(a).get('ancestor::xctrls:tabitem'))){return;}a=a.first();}if(!TP.isElement(a)){return;}b=TP.wrap(a).get('string(./xctrls:value)');if(TP.isValid(b)){this.set('value',b);}return;});TP.xctrls.tabbar.Inst.defineMethod('setDisplayValue',function(a){this.toggleSelectedItem(this.get('selectedTab'),this.get('tabWithValue',a));return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.tabbar.css_uri', '~TP.xctrls.tabbar/xctrls_tabbar.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.tabbar.xhtml_uri', '~TP.xctrls.tabbar/xctrls_tabbar.xhtml');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_tabbox/xctrls_tabbox.js';
TP.core.UIElementNode.defineSubtype('xctrls:tabbox');TP.xctrls.tabbox.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.tabbox.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.tabbox.executeTraitResolution();TP.xctrls.tabbox.Inst.defineAttribute('tabbar',{'value':TP.cpc('xctrls|tabbar',true)});TP.xctrls.tabbox.Inst.defineAttribute('panels',{'value':TP.cpc('xctrls|panel',false)});TP.xctrls.tabbox.Inst.defineAttribute('selectedPanel',{'value':TP.cpc('xctrls|panel[pclass|selected]',true)});TP.xctrls.tabbox.Inst.defineAttribute('panelWithValue',{'value':TP.xpc('./xctrls:panel/xctrls:value[text() = "{{1}}"]/..',true)});TP.xctrls.tabbox.Inst.defineMethod('getDisplayValue',function(){return TP.wrap(this.get('tabbar')).get('value');});TP.xctrls.tabbox.Inst.defineMethod('handleValueChange',function(a){this.toggleSelectedItem(this.get('selectedPanel'),this.get('panelWithValue',this.get('value')));return;});TP.xctrls.tabbox.Inst.defineMethod('setDisplayValue',function(a){TP.wrap(this.get('tabbar')).set('value',a);return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.tabbox.css_uri', '~TP.xctrls.tabbox/xctrls_tabbox.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.tabbox.xsl_uri', '~TP.xctrls.tabbox/xctrls_tabbox.xsl');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_scrollbox/xctrls_scrollbox.js';
TP.core.UIElementNode.defineSubtype('xctrls:scrollbox');TP.xctrls.scrollbox.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.scrollbox.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.scrollbox.executeTraitResolution();
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.scrollbox.css_uri', '~TP.xctrls.scrollbox/xctrls_scrollbox.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.scrollbox.xhtml_uri', '~TP.xctrls.scrollbox/xctrls_scrollbox.xhtml');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_slidebar/xctrls_slidebar.js';
TP.core.UIElementNode.defineSubtype('xctrls:slidebar');TP.xctrls.slidebar.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.slidebar.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.slidebar.executeTraitResolution();TP.xctrls.slidebar.Type.defineAttribute('vertSlideResponder');TP.xctrls.slidebar.Type.defineAttribute('horizSlideResponder');TP.xctrls.slidebar.Type.defineAttribute('defaultIncrement',5);TP.xctrls.slidebar.Inst.defineAttribute('thumb',{'value':TP.cpc('*[tibet|pelem="thumb"]',true)});TP.xctrls.slidebar.Inst.defineAttribute('decrementButton',{'value':TP.cpc('.decrement',true)});TP.xctrls.slidebar.Inst.defineAttribute('incrementButton',{'value':TP.cpc('.increment',true)});TP.xctrls.slidebar.Inst.defineAttribute('dragger',{'value':TP.cpc('*[tibet|pelem="drag"]',true)});TP.xctrls.slidebar.Type.defineMethod('tagAttachDOM',function(a){var b,c;TP.xctrls.Element.tagAttachDOM.call(this,a);if(!TP.isElement(b=a.at('node'))){return;}c=TP.tpnode(b);c.setAttribute('value','0');return;});TP.xctrls.slidebar.Inst.defineMethod('getDisplayValue',function(){var a,b,c;a=TP.elementGetHeight(this.getNativeNode());b=TP.elementGetHeight(this.get('thumb'));c=this.getThumbPosition()/(a-b);return c;});TP.xctrls.slidebar.Inst.defineMethod('getThumbPosition',function(){var a;a=TP.elementGetStyleValueInPixels(this.get('thumb'),'top');return a;});TP.xctrls.slidebar.Inst.defineMethod('handleDOMClick',function(b){var a;if(b.getTarget()===this.get('decrementButton')){a='TP.TOP';}if(b.getTarget()===this.get('incrementButton')){a='TP.BOTTOM';}this.moveByIncrement(a,TP.ifEmpty(this.getAttribute('xctrls:increment'),this.getType().get('defaultIncrement')));if(this.shouldSignalChange()){this.changed('value',TP.UPDATE);}return;});TP.xctrls.slidebar.Inst.defineMethod('handleDOMDragMove',function(a){if(this.shouldSignalChange()){this.changed('value',TP.UPDATE);}return;});TP.xctrls.slidebar.Inst.defineMethod('moveByIncrement',function(b,c){var a;a=TP.elementGetPixelValue(this.get('thumb'),c,'top');if(b==='TP.TOP'){a=-a;}this.setThumbPosition(this.getThumbPosition()+a);return this;});TP.xctrls.slidebar.Inst.defineMethod('setDisplayValue',function(d){var a,b,c;a=TP.elementGetHeight(this.getNativeNode());b=TP.elementGetHeight(this.get('thumb'));c=(a-b)*d;this.setThumbPosition(c);return this;});TP.xctrls.slidebar.Inst.defineMethod('setThumbPosition',function(e){var b,c,d,a;b=TP.elementGetHeight(this.getNativeNode());c=TP.elementGetHeight(this.get('thumb'));d=b-c;a=e.max(0);a=a.min(d);TP.elementGetStyleObj(this.get('thumb')).top=a+'px';return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.slidebar.css_uri', '~TP.xctrls.slidebar/xctrls_slidebar.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.slidebar.xhtml_uri', '~TP.xctrls.slidebar/xctrls_slidebar.xhtml');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_splitbar/xctrls_splitbar.js';
TP.core.UIElementNode.defineSubtype('xctrls:splitbar');TP.xctrls.splitbar.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.splitbar.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.splitbar.executeTraitResolution();TP.xctrls.splitbar.Inst.defineMethod('getDisplayValue',function(){var a,b,c;a=this.getOffsetParent().getHeight();b=this.getOffsetPoint().getY();c=b/a;return c;});TP.xctrls.splitbar.Inst.defineMethod('handleDOMDragMove',function(a){if(this.shouldSignalChange()){this.changed('value',TP.UPDATE);}return;});TP.xctrls.splitbar.Inst.defineMethod('setDisplayValue',function(d){var b,c,a;if(!TP.isNumber(a=d.asNumber())){return;}b=this.getNativeNode();c=this.getOffsetParent().getHeight();a=a*c;TP.elementGetStyleObj(b).top=a+'px';return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.splitbar.css_uri', '~TP.xctrls.splitbar/xctrls_splitbar.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.splitbar.xhtml_uri', '~TP.xctrls.splitbar/xctrls_splitbar.xhtml');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_splitbox/xctrls_splitbox.js';
TP.core.UIElementNode.defineSubtype('xctrls:splitbox');TP.xctrls.splitbox.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.splitbox.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.splitbox.executeTraitResolution();TP.xctrls.splitbox.Inst.defineAttribute('splitbar',{'value':TP.cpc('xctrls|splitbar',true)});TP.xctrls.splitbox.Inst.defineAttribute('beforePanel',{'value':TP.xpc('./xctrls:panel[1]',true)});TP.xctrls.splitbox.Inst.defineAttribute('afterPanel',{'value':TP.xpc('./xctrls:panel[2]',true)});TP.xctrls.splitbox.Inst.defineMethod('getDisplayValue',function(){return TP.wrap(this.get('splitbar')).get('value');});TP.xctrls.splitbox.Inst.defineMethod('handleValueChange',function(f){var b,c,d,e,a;b=this.get('splitbar');c=this.get('beforePanel');d=this.get('afterPanel');e=this.getHeight();a=TP.wrap(b).getOffsetPoint().getY();TP.elementGetStyleObj(c).height=a+'px';TP.elementGetStyleObj(d).top=a+'px';return;});TP.xctrls.splitbox.Inst.defineMethod('setDisplayValue',function(a){TP.wrap(this.get('splitbar')).set('value',a);return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.splitbox.css_uri', '~TP.xctrls.splitbox/xctrls_splitbox.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.splitbox.xhtml_uri', '~TP.xctrls.splitbox/xctrls_splitbox.xhtml');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_textinput/xctrls_textinput.js';
TP.core.UIElementNode.defineSubtype('xctrls:textinput');TP.xctrls.textinput.addTraitsFrom(TP.xctrls.Element,TP.core.TemplatedNode);TP.xctrls.textinput.Type.resolveTrait('tagCompile',TP.core.TemplatedNode);TP.xctrls.textinput.executeTraitResolution();TP.xctrls.textinput.Inst.defineAttribute('valuePElem',{'value':TP.cpc('*[tibet|pelem="value"]',true)});TP.xctrls.textinput.Inst.defineMethod('blur',function(){var a;this.callNextMethod();a=this.get('valuePElem');a.blur();return this;});TP.xctrls.textinput.Inst.defineMethod('focus',function(){var a;this.callNextMethod();a=this.get('valuePElem');a.focus();return this;});TP.xctrls.textinput.Inst.defineMethod('getDisplayValue',function(){var a;a=this.get('valuePElem');return a.value;});TP.xctrls.textinput.Inst.defineMethod('setDisabled',function(b){var a;a=this.get('valuePElem');if(TP.isTrue(b)){a.setAttribute('disabled',true);a.setAttribute('pclass:disabled','true');}else{a.removeAttribute('disabled');a.removeAttribute('pclass:disabled');}return this.callNextMethod();});TP.xctrls.textinput.Inst.defineMethod('setDisplayValue',function(b){var a;a=this.get('valuePElem');a.value=b;return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.textinput.css_uri', '~TP.xctrls.textinput/xctrls_textinput.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.textinput.xhtml_uri', '~TP.xctrls.textinput/xctrls_textinput.xhtml');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_barcode/xctrls_barcode.js';
TP.core.UIElementNode.defineSubtype('xctrls:barcode');TP.xctrls.barcode.addTraitsFrom(TP.core.PipeSegmentElementNode);TP.xctrls.barcode.executeTraitResolution();TP.xctrls.barcode.Type.defineMethod('generateCode39Table',function(r,u){var c,p,g,f,n,o,h,j,q,s,t,b,k,a,d,i,l,m,e;c='CODE39';p=true;g=1;f=50;n=3;o=1;h=TP.str(r);j='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-. $/+%*';q=TP.ac('nbnBNbNbnX','NbnBnbnbNX','nbNBnbnbNX','NbNBnbnbnX','nbnBNbnbNX','NbnBNbnbnX','nbNBNbnbnX','nbnBnbNbNX','NbnBnbNbnX','nbNBnbNbnX','NbnbnBnbNX','nbNbnBnbNX','NbNbnBnbnX','nbnbNBnbNX','NbnbNBnbnX','nbNbNBnbnX','nbnbnBNbNX','NbnbnBNbnX','nbNbnBNbnX','nbnbNBNbnX','NbnbnbnBNX','nbNbnbnBNX','NbNbnbnBnX','nbnbNbnBNX','NbnbNbnBnX','nbNbNbnBnX','nbnbnbNBNX','NbnbnbNBnX','nbNbnbNBnX','nbnbNbNBnX','NBnbnbnbNX','nBNbnbnbNX','NBNbnbnbnX','nBnbNbnbNX','NBnbNbnbnX','nBNbNbnbnX','nBnbnbNbNX','NBnbnbNbnX','nBNbnbNbnX','nBnBnBnbnX','nBnBnbnBnX','nBnbnBnBnX','nbnBnBnBnX','nBnbNbNbnX');s=TP.join('\0\x01\x02\x03\x04\x05\x06\x07\b\t\n\x0B\f\r\x0E\x0F','\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1A\x1B\x1C\x1D\x1E\x1F',' !"#$%&\'()*+,-./','0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_','`abcdefghijklmnopqrstuvwxyz{|}~\x7F');t=TP.ac('%U','$A','$B','$C','$D','$E','$F','$G','$H','$I','$J','$K','$L','$M','$N','$O','$P','$Q','$R','$S','$T','$U','$V','$W','$X','$Y','$Z','%A','%B','%C','%D','%E',' ','/A','/B','/C','$','%','/F','/G','/H','/I','/J','+','/L','-','.','/O','0','1','2','3','4','5','6','7','8','9','/Z','%F','%G','%H','%I','%J','%V','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z','%K','%L','%M','%N','%O','%W','+A','+B','+C','+D','+E','+F','+G','+H','+I','+J','+K','+L','+M','+N','+O','+P','+Q','+R','+S','+T','+U','+V','+W','+X','+Y','+Z','%P','%Q','%R','%S','%T');k=r!=='';if(k===true){k=c==='CODE39'||c==='CODE39_CHECKSUM'||c==='CODE39_EXTENDED'||c==='CODE39_EXTENDED_CHECKSUM';}if(k===false){b=c+' ??';}else{d='';i='';if(c==='CODE39_EXTENDED'||c==='CODE39_EXTENDED_CHECKSUM'){for(a=0;a<h.length;a++){i+=h.charAt(a);d+=t[s.indexOf(h.charAt(a))];}}else{for(a=0;a<h.length;a++){if(j.indexOf(h.charAt(a))!==-1){d+=h.charAt(a);}}i=d;}l='';if(c==='CODE39_CHECKSUM'||c==='CODE39_EXTENDED_CHECKSUM'){m=0;for(a=0;a<d.length;a++){m+=j.indexOf(d.charAt(a));}l=j.charAt(m%43);}d='*'+d+l+'*';i='*'+i+l+'*';e='';for(a=0;a<d.length;a++){e+=q[j.indexOf(d.charAt(a))];}b='<table xmlns="'+TP.w3.Xmlns.XHTML+'" border="0" cellspacing="0" cellpadding="0">\n';if(p){b+='<caption align=bottom>'+i+'</caption>\n';}b+='<tr>';b+='<td><div style="background-color: black; width:'+10*g+'px; height:'+f+'px"></div></td>\n';for(a=0;a<e.length;a++){if(e.charAt(a)==='X'){b+='<td><div style="background-color: black; height:'+f+'px; width:'+o+'px"></div></td>\n';}if(e.charAt(a)==='b'){b+='<td><div style="background-color: black; height:'+f+'px; width:'+g+'px"></div></td>\n';}if(e.charAt(a)==='B'){b+='<td><div style="background-color: black; height:'+f+'px; width:'+g*n+'px"></div></td>\n';}if(e.charAt(a)==='n'){b+='<td><div style="background-color: white; height:'+f+'px; width:'+g+'px"></div></td>\n';}if(e.charAt(a)==='N'){b+='<td><div style="background-color: white; height:'+f+'px; width:'+g*n+'px"></div></td>\n';}}b+='<td><div style="background-color: black; width:'+10*g+'px; height:'+f+'px"></div></td>\n';b+='</tr></table>';return b;}});TP.xctrls.barcode.Type.defineMethod('getPrimaryArgumentName',function(){return'code';});TP.xctrls.barcode.Type.defineMethod('getPrimaryArgument',function(b){var a;if(TP.notEmpty(a=this.callNextMethod())){return a.split(' ');}return;});TP.xctrls.barcode.Type.defineMethod('processInput',function(a,b){a.atPut('cmdAsIs',true);return this.callNextMethod();});TP.xctrls.barcode.Type.defineMethod('transformInput',function(a,b,c){return this.generateCode39Table(a);});
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_richtext/xctrls_richtext.js';
TP.xctrls.FramedElement.defineSubtype('richtext');TP.xctrls.FramedElement.set('frameFileURI',TP.uc('~lib_src/xctrls/xctrls_richtext/xctrls_richtext_stub.html'));TP.xctrls.richtext.Type.defineMethod('cmdGetContent',function(a){var c,b;if(TP.notValid(c=a.at('cmdInstance'))){return a.fail(TP.FAILURE,'No command instance.');}if(TP.notValid(b=c.getValue())){return a.fail(TP.FAILURE,'No content.');}else{b=TP.join('<span xmlns="',TP.w3.Xmlns.XHTML,'">',b,'</span>');return a.complete(b);}});TP.xctrls.richtext.Type.defineMethod('cmdSetContent',function(a){var b,c,d;if(TP.isEmpty(b=a.stdin())){return a.fail(TP.FAILURE,'No content.');}if(TP.notValid(c=a.at('cmdInstance'))){return a.fail(TP.FAILURE,'No command instance.');}d=b.at(0);c.setContent(d,a);a.complete();return;});TP.xctrls.richtext.Inst.defineAttribute('$oldSelectionLength');TP.xctrls.richtext.Inst.defineMethod('configure',function(){var a;a=this.$getEditorInstance();a.onNodeChange.add(function(a,b,c,d,e){this.selectionChangeHandler(a,b,c,d,e);}.bind(this));a.settings.save_onsavecallback=function(a){this.signal('TP.sig.ContentSave',null,this.getValue());}.bind(this);this.refresh();return this.callNextMethod();});TP.xctrls.richtext.Inst.defineMethod('focus',function(){return this;});TP.xctrls.richtext.Inst.defineMethod('getDisplayValue',function(){return this.$getEditorInstance().getContent();});TP.xctrls.richtext.Inst.defineMethod('$getEditorInstance',function(){return this.get('tpIFrame').get('tinyMCE').activeEditor;});TP.xctrls.richtext.Inst.defineMethod('refresh',function(a){return;});TP.xctrls.richtext.Inst.defineMethod('focus',function(){return this;});TP.xctrls.richtext.Inst.defineMethod('selectionChangeHandler',function(c,d,e,f,g){var b,a;b=TP.ifInvalid(this.$get('$oldSelectionLength'),0);a=this.getSelection().length;if(b!==a){this.$changed('selection',TP.CREATE);}this.$set('$oldSelectionLength',a,false);return this;});TP.xctrls.richtext.Inst.defineMethod('setDisplayValue',function(a){this.$getEditorInstance().setContent(a);return this;});TP.xctrls.richtext.Inst.defineMethod('handleXMPPPubsubEventInput',function(c){var a,b;a=c.getPayload().at('node').getNamedDescendant('item');b=a.firstChild;this.setContent(TP.str(b));});TP.xctrls.richtext.Inst.defineMethod('publishContent',function(b){var c,d,a;if(TP.isEmpty(b)){return;}c=TP.elem(TP.join('<span xmlns="',TP.w3.Xmlns.XHTML,'">',this.getValue(),'</span>'));d=TP.hc('action','publish','pubsubServiceJID',TP.xmpp.JID.construct('pubsub.localhost'),'nodeID','/home/localhost/testrat/'+b,'payload',c);a=TP.sig.XMPPRequest.construct(d);a.defineMethod('handleRequestSucceeded',function(a){TP.log(a.getResponseText(),TP.LOG,arguments);});a.defineMethod('handleRequestFailed',function(a){TP.ifError()?TP.error(a.getResponseText(),TP.LOG,arguments):0;});a.fire();});TP.xctrls.richtext.Inst.defineMethod('shouldShare',function(d,b){var c,a;if(TP.isEmpty(b)){return;}if(TP.isFalse(d)){c=TP.hc('id','unsubscribe1','action','unsubscribe','pubsubServiceJID',TP.xmpp.JID.construct('pubsub.localhost'),'nodeID','/home/localhost/testrat/'+b);this.ignore(null,'TP.sig.XMPPPubsubEventInput');}else{c=TP.hc('action','subscribe','pubsubServiceJID',TP.xmpp.JID.construct('pubsub.localhost'),'nodeID','/home/localhost/testrat/'+b);this.observe(null,'TP.sig.XMPPPubsubEventInput');}a=TP.sig.XMPPRequest.construct(c);a.defineMethod('handleRequestSucceeded',function(a){TP.log(a.getResponseText(),TP.LOG,arguments);});a.defineMethod('handleRequestFailed',function(a){TP.ifError()?TP.error(a.getResponseText(),TP.LOG,arguments):0;});a.fire();return this;});TP.xctrls.richtext.Inst.defineMethod('clearValue',function(){var a;a=this.$getEditorInstance().getContent();this.$getEditorInstance().setContent('');this.changed('value',TP.DELETE,TP.hc(TP.OLDVAL,a,TP.NEWVAL,''));return this;});TP.xctrls.richtext.Inst.defineMethod('clearSelection',function(){var a;a=this.getSelection();this.$getEditorInstance().selection.setContent('');this.changed('selection',TP.DELETE,TP.hc(TP.OLDVAL,a,TP.NEWVAL,''));return this;});TP.xctrls.richtext.Inst.defineMethod('collapseSelection',function(a){this.$getEditorInstance().selection.collapse(a);return this;});TP.xctrls.richtext.Inst.defineMethod('getSelection',function(){return this.$getEditorInstance().selection.getContent();});TP.xctrls.richtext.Inst.defineMethod('getSelectionEnd',function(){return TP.todo();});TP.xctrls.richtext.Inst.defineMethod('getSelectionStart',function(){return TP.todo();});TP.xctrls.richtext.Inst.defineMethod('insertAfterSelection',function(a){TP.documentInsertAfterSelection(this.$getEditorInstance().getDoc(),a);return this;});TP.xctrls.richtext.Inst.defineMethod('insertBeforeSelection',function(a){TP.documentInsertBeforeSelection(this.$getEditorInstance().getDoc(),a);return this;});TP.xctrls.richtext.Inst.defineMethod('replaceSelection',function(c){var a,b;a=this.getSelection();this.$getEditorInstance().selection.setContent(c);b=this.getSelection();this.changed('selection',TP.UPDATE,TP.hc(TP.OLDVAL,a,TP.NEWVAL,b));return this;});TP.xctrls.richtext.Inst.defineMethod('selectFromTo',function(a,b){TP.todo();return this;});TP.xctrls.richtext.Inst.defineMethod('setCursorToEnd',function(){TP.todo();return this;});TP.xctrls.richtext.Inst.defineMethod('setCursorToStart',function(){TP.todo();return this;});TP.xctrls.richtext.Inst.defineMethod('setSelection',function(a){this.replaceSelection(a);return this;});TP.xctrls.richtext.Inst.defineMethod('wrapSelection',function(a,b){this.replaceSelection(TP.join(a,this.getSelection(),b));return this;});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.richtext.css_uri', '~TP.xctrls.richtext/xctrls_richtext.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.richtext.xhtml_uri', '~TP.xctrls.richtext/xctrls_richtext.xhtml');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_map/TPMapUtils.js';
TP.core.Point.defineSubtype('LatLong');TP.definePrimitive('llc',function(a,b){return TP.core.LatLong.construct.apply(TP.core.LatLong,arguments);});TP.core.LatLong.Inst.defineAttribute('description');TP.core.LatLong.Inst.defineMethod('init',function(a,b){this.callNextMethod();return this;});TP.core.LatLong.Inst.defineMethod('getLat',function(){return this.get('y');});TP.core.LatLong.Inst.defineMethod('getLong',function(){return this.get('x');});TP.core.LatLong.Inst.defineMethod('distance',function(b){var c,a;a=Math.PI*2/360;c=(b.get('long')*a-this.get('long')*a).cos()*(b.get('lat')*a-this.get('lat')*a).cos();return c.acos()*6378.137;});TP.lang.Object.defineSubtype('core:MapBounds');TP.core.MapBounds.Inst.defineAttribute('southWestLatLong');TP.core.MapBounds.Inst.defineAttribute('northEastLatLong');TP.core.MapBounds.Inst.defineMethod('init',function(a,b,c,d){this.callNextMethod();this.set('southWestLatLong',TP.llc(a,b));this.set('northEastLatLong',TP.llc(c,d));return this;});TP.lang.Object.defineSubtype('core:MapMarker');TP.core.MapMarker.Inst.defineAttribute('$nativeMarker');TP.core.MapMarker.Inst.defineAttribute('location');TP.core.MapMarker.Inst.defineAttribute('labelText');TP.core.MapMarker.Inst.defineAttribute('iconURL');TP.core.MapMarker.Inst.defineAttribute('infoBubble');TP.core.MapMarker.Inst.defineMethod('init',function(a){this.callNextMethod();this.set('location',a);return this;});TP.sig.DOMSignal.defineSubtype('xctrls:MapSignal');TP.xctrls.MapSignal.defineSubtype('MapClicked');TP.xctrls.MapSignal.defineSubtype('MapPanned');TP.xctrls.MapSignal.defineSubtype('MapZoomed');TP.xctrls.MapSignal.defineSubtype('MapGeocodeComplete');TP.xctrls.MapSignal.defineSubtype('MapMarkerAdded');TP.xctrls.MapSignal.defineSubtype('MapMarkerClicked');TP.xctrls.MapSignal.defineSubtype('MapMarkerRemoved');TP.xctrls.MapSignal.defineSubtype('MapMarkersRemoved');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_map/xctrls_map.js';
TP.xctrls.FramedElement.defineSubtype('map');TP.sys.require('TP.core.LatLong');TP.sys.require('TP.core.MapBounds');TP.sys.require('TP.core.MapMarker');TP.xctrls.map.Type.defineConstant('ROAD',1);TP.xctrls.map.Type.defineConstant('SATELLITE',2);TP.xctrls.map.Type.defineConstant('HYBRID',3);TP.xctrls.map.Type.defineAttribute('defaultLatLong',TP.llc(29.65,91.13));TP.xctrls.map.Type.defineAttribute('frameFileURI',TP.uc('~lib_src/xctrls/xctrls_map/xctrls_map_stub.html'));TP.xctrls.map.Type.defineMethod('getCompilationAttrs',function(c){var a,b;if(!TP.isElement(a=c.at('node'))){return TP.hc();}b=TP.ifEmpty(TP.elementGetAttribute(a,'type'),'google');return TP.hc('tibet:nodetype','xctrls:'+b+'map');});TP.xctrls.map.Type.defineMethod('getResourceTypeName',function(){return'TP.xctrls.map';});TP.xctrls.map.Inst.defineAttribute('$map');TP.xctrls.map.Inst.defineAttribute('$markers');TP.xctrls.map.Inst.defineMethod('init',function(a,b){this.callNextMethod();this.set('$markers',TP.ac());return this;});TP.xctrls.map.Inst.defineMethod('addControls',function(a,b,c,d,e){return TP.override();});TP.xctrls.map.Inst.defineMethod('addLargeControls',function(){return TP.override();});TP.xctrls.map.Inst.defineMethod('addMapTypeControls',function(){return TP.override();});TP.xctrls.map.Inst.defineMethod('addMarker',function(a){return TP.override();});TP.xctrls.map.Inst.defineMethod('addSmallControls',function(){return TP.override();});TP.xctrls.map.Inst.defineMethod('autoCenterAndZoom',function(){var a,b,c,d;a=-90;b=90;c=-180;d=180;this.get('$markers').perform(function(g){var e,f;e=g.get('location').get('lat');f=g.get('location').get('long');a=a.max(e);b=b.min(e);c=c.max(f);d=d.min(f);});this.setBounds(TP.core.MapBounds.construct(b,d,a,c));return this;});TP.xctrls.map.Inst.defineMethod('getBounds',function(){return TP.override();});TP.xctrls.map.Inst.defineMethod('getCenter',function(){return TP.override();});TP.xctrls.map.Inst.defineMethod('getLatLongForAddress',function(a){return TP.override();});TP.xctrls.map.Inst.defineMethod('getMapType',function(){return TP.override();});TP.xctrls.map.Inst.defineMethod('getZoom',function(){return TP.override();});TP.xctrls.map.Inst.defineMethod('getZoomLevelForMapBounds',function(a){return TP.override();});TP.xctrls.map.Inst.defineMethod('hideAllMarkers',function(){return TP.override();});TP.xctrls.map.Inst.defineMethod('refresh',function(a){if(TP.isEmpty(this.get('$markers'))){this.setCenterAndZoom(this.getType().get('defaultLatLong'),4);return this;}this.hideAllMarkers();this.autoCenterAndZoom();this.showAllMarkers();return this;});TP.xctrls.map.Inst.defineMethod('removeAllMarkers',function(){this.hideAllMarkers();this.get('$markers').empty();this.signal('TP_xctrls_MapMarkersRemoved');return this;});TP.xctrls.map.Inst.defineMethod('removeAllControls',function(){return TP.override();});TP.xctrls.map.Inst.defineMethod('removeMarker',function(a){return TP.override();});TP.xctrls.map.Inst.defineMethod('setBounds',function(a){return TP.override();});TP.xctrls.map.Inst.defineMethod('setCenter',function(a){return TP.override();});TP.xctrls.map.Inst.defineMethod('setLat',function(c){var a,b;a=this.getCenter();b=TP.llc(c,a.get('long'));this.get('$map').setCenter(this.$convertLatLongToGoogleLatLong(b));return this;});TP.xctrls.map.Inst.defineMethod('setLong',function(c){var a,b;a=this.getCenter();b=TP.llc(a.get('lat'),c);this.get('$map').setCenter(this.$convertLatLongToGoogleLatLong(b));return this;});TP.xctrls.map.Inst.defineMethod('setCenterAndZoom',function(a,b){return TP.override();});TP.xctrls.map.Inst.defineMethod('setIsDraggable',function(a){return TP.override();});TP.xctrls.map.Inst.defineMethod('setMapType',function(a){return TP.override();});TP.xctrls.map.Inst.defineMethod('setZoom',function(a){return TP.override();});TP.xctrls.map.Inst.defineMethod('showAllMarkers',function(){return TP.override();});TP.xctrls.map.Inst.defineMethod('sizeTo',function(a,b){return TP.override();});TP.xctrls.map.Inst.defineMethod('swapMarker',function(a){return TP.override();});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.map.css_uri', '~TP.xctrls.map/xctrls_map.css');
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_map/xctrls_googlemap.js';
TP.xctrls.map.defineSubtype('googlemap');TP.xctrls.googlemap.Inst.defineAttribute('$controls');TP.xctrls.googlemap.Inst.defineMethod('addControl',function(b){var a;a=this.get('tpIFrame').constructObject(b);this.get('map').addControl(a);this.get('$controls').push(a);return this;});TP.xctrls.googlemap.Inst.defineMethod('$computeGoogleMapScriptSrc',function(){var a,b;a='http://maps.google.com/maps?file'+'=api&amp;v'+'=2';if(TP.sys.getHost()==='www.teamtibet.com'){a+='&amp;key=';a+='ABQIAAAAzoA5NNjo_-QiYUYvQRpT0RSjtrq-CQXrGeMzST1i1B8lQE1tOxSt-Axj-Be6w0eRhU_n84bqnK92wA';return a;}else if(TP.sys.getHost()==='localhost'){a+='&amp;key=';a+='ABQIAAAAzoA5NNjo_-QiYUYvQRpT0RT2yXp_ZAY8_ufC3CFXhHIE1NvwkxSGIytpSlL94aueLIRsScd7x4WogA';return a;}else if(TP.isEmpty(TP.sys.getHost())){a+='';return a;}else{b=TP.prompt('You loaded a TIBET-based application from a domain that has no known Google Maps key: '+TP.sys.getHost()+'. Please enter your Google Maps key (only the part after "key'+'=").');if(TP.notEmpty(b)){a+='&amp;key=';a+=b;}return a;}return null;});TP.xctrls.googlemap.Inst.defineMethod('$convertLatLongToGoogleLatLong',function(a){return this.get('tpIFrame').constructObject('GLatLng',a.get('lat'),a.get('long'));});TP.xctrls.googlemap.Inst.defineMethod('$convertMarkerToGoogleMarker',function(d){var a,b,c,e;a=this.get('tpIFrame');b=a.constructObject('Object');if(TP.isValid(c=d.get('labelText'))){b.title=c;}if(TP.isValid(c=d.get('iconURL'))){b.icon=a.constructObject('GIcon',a.get('G_DEFAULT_ICON'),c);}e=a.constructObject('GMarker',this.$convertLatLongToGoogleLatLong(d.get('location')),b);return e;});TP.xctrls.googlemap.Inst.defineMethod('init',function(a,b){this.callNextMethod();this.set('$controls',TP.ac());return this;});TP.xctrls.googlemap.Inst.defineMethod('addControls',function(a,b,c,d,e){this.removeAllControls();if(TP.isValid(b)||TP.isTrue(a)){this.$addControl('GLargeMapControl');}else{this.$addControl('GSmallMapControl');}if(TP.isTrue(c)){this.$addControl('GMapTypeControl');}if(TP.isTrue(d)){this.$addControl('GScaleControl');}if(TP.isTrue(e)){this.$addControl('GOverviewMapControl');}return this;});TP.xctrls.googlemap.Inst.defineMethod('addLargeControls',function(){this.$addControl('GLargeMapControl');this.$addControl('GMapTypeControl');this.$addControl('GScaleControl');this.$addControl('GOverviewMapControl');return this;});TP.xctrls.googlemap.Inst.defineMethod('addMapTypeControls',function(){this.$addControl('GMapTypeControl');return this;});TP.xctrls.googlemap.Inst.defineMethod('addMarker',function(a){var b;b=this.$convertMarkerToGoogleMarker(a);a.set('nativeMarker',b);this.get('tpIFrame').get('GEvent').addListener(b,'click',TP.windowBuildFunctionFor(this.get('tpIFrame').getNativeContentWindow(),function(){this.signal('TP_xctrls_MapMarkerClicked',null,a);}.bind(this)));this.get('map').addOverlay(b);this.get('markers').push(a);this.signal('TP_xctrls_MapMarkerAdded',null,a);return this;});TP.xctrls.googlemap.Inst.defineMethod('addSmallControls',function(){this.$addControl('GSmallMapControl');return this;});TP.xctrls.googlemap.Inst.defineMethod('configure',function(){var a,b,d,e,c;a=this.get('tpIFrame');b=a.getNativeContentWindow();d=a.getNativeContentDocument();e=TP.nodeGetElementById(d,'map_stub');c=a.constructObject('GMap2',e);c.setUIToDefault();this.set('map',c);a.get('GEvent').addListener(this.get('map'),'click',TP.windowBuildFunctionFor(b,function(b,a){this.signal('TP_xctrls_MapClicked',null,TP.llc(a.x,a.y));}.bind(this)));a.get('GEvent').addListener(this.get('map'),'moveend',TP.windowBuildFunctionFor(b,function(){this.signal('TP_xctrls_MapPanned',null,this.getCenter());}.bind(this)));this.refresh();return this.callNextMethod();});TP.xctrls.googlemap.Inst.defineMethod('getBounds',function(){var a,b,c,d;a=this.get('map').getBounds();b=a.getSouthWest();c=a.getNorthEast();d=TP.core.MapBounds.construct(b.lat(),b.lng(),c.lat(),c.lng());return d;});TP.xctrls.googlemap.Inst.defineMethod('getCenter',function(){var a;a=this.get('map').getCenter();return TP.llc(a.lat(),a.lng());});TP.xctrls.googlemap.Inst.defineMethod('getLatLongForAddress',function(b){var a;a=this.get('tpIFrame').constructObject('GClientGeocoder');a.getLocations(b,function(a){var b;if(TP.notValid(a)||a.Status.code!==200){return;}b=TP.llc(a.Placemark[0].Point.coordinates[1],a.Placemark[0].Point.coordinates[0]);b.set('description',a.Placemark[0].address);this.signal('TP_xctrls_MapGeocodeComplete',null,b);}.bind(this));return this;});TP.xctrls.googlemap.Inst.defineMethod('getMapType',function(){var a,c,b,d;a=this.getType();c=this.get('map');b=this.get('tpIFrame');d=c.getCurrentMapType();switch(d){case b.get('G_NORMAL_MAP'):return a.at('ROAD');case b.get('G_SATELLITE_MAP'):return a.at('SATELLITE');case b.get('G_HYBRID_MAP'):return a.at('HYBRID');default:break;}return this;});TP.xctrls.googlemap.Inst.defineMethod('getZoom',function(){return this.get('map').getZoom();});TP.xctrls.googlemap.Inst.defineMethod('getZoomLevelForMapBounds',function(a){var b,c,d,e;c=this.$convertLatLongToGoogleLatLong(a.get('northEastLatLong'));b=this.$convertLatLongToGoogleLatLong(a.get('southWestLatLong'));d=this.get('tpIFrame').constructObject('GLatLngBounds',b,c);e=this.get('map').getBoundsZoomLevel(d);return e;});TP.xctrls.googlemap.Inst.defineMethod('hideAllMarkers',function(){this.get('map').clearOverlays();return this;});TP.xctrls.googlemap.Inst.defineMethod('removeAllControls',function(){var a;a=this.get('map');this.get('$controls').perform(function(b){a.removeControl(b);});this.get('$controls').empty();return this;});TP.xctrls.googlemap.Inst.defineMethod('removeMarker',function(a){this.get('map').removeOverlay(a.get('nativeMarker'));this.get('markers').remove(a,TP.IDENTITY);this.signal('TP_xctrls_MapMarkerRemoved',null,a);return this;});TP.xctrls.googlemap.Inst.defineMethod('setBounds',function(b){var c,d,a;d=this.$convertLatLongToGoogleLatLong(b.get('northEastLatLong'));c=this.$convertLatLongToGoogleLatLong(b.get('southWestLatLong'));a=this.get('tpIFrame').constructObject('GLatLngBounds',c,d);this.get('map').setCenter(a.getCenter(),this.get('map').getBoundsZoomLevel(a));return this;});TP.xctrls.googlemap.Inst.defineMethod('setCenter',function(b){var c,d,a;c=this.getCenter();if(TP.isString(b)){d=b.split(',');a=TP.llc(d.at(0),d.at(1));}else{a=b;}if(c.get('lat')===a.get('lat')&&c.get('long')===a.get('long')){return this;}this.get('map').setCenter(this.$convertLatLongToGoogleLatLong(a));return this;});TP.xctrls.googlemap.Inst.defineMethod('setCenterAndZoom',function(a,b){this.get('map').setCenter(this.$convertLatLongToGoogleLatLong(a),b);return this;});TP.xctrls.googlemap.Inst.defineMethod('setIsDraggable',function(a){if(TP.isTrue(a)){this.get('map').enableDragging();}else{this.get('map').disableDragging();}return this;});TP.xctrls.googlemap.Inst.defineMethod('setMapType',function(d){var c,a,b;c=this.getType();a=this.get('map');b=this.get('tpIFrame');switch(d){case c.at('ROAD'):a.setMapType(b.get('G_NORMAL_MAP'));break;case c.at('SATELLITE'):a.setMapType(b.get('G_SATELLITE_MAP'));break;case c.at('HYBRID'):a.setMapType(b.get('G_HYBRID_MAP'));break;default:a.setMapType(b.get('G_NORMAL_MAP'));break;}return this;});TP.xctrls.googlemap.Inst.defineMethod('setZoom',function(a){this.get('map').setZoom(a);this.signal('TP_xctrls_MapZoomed');return this;});TP.xctrls.googlemap.Inst.defineMethod('showAllMarkers',function(){var a,b;a=this.get('tpIFrame');b=a.getNativeContentWindow();this.get('markers').perform(function(d){var c;c=this.$convertMarkerToGoogleMarker(d);d.set('nativeMarker',c);a.get('GEvent').addListener(c,'click',TP.windowBuildFunctionFor(b,function(){this.signal('TP_xctrls_MapMarkerClicked',null,d);}.bind(this)));this.get('map').addOverlay(c);}.bind(this));return this;});TP.xctrls.googlemap.Inst.defineMethod('sizeTo',function(a,b){return TP.todo();});TP.xctrls.googlemap.Inst.defineMethod('startIFrameLoad',function(){var a;a=this.get('tpIFrame');a.getNativeNode().computeMapSrc=this.$computeGoogleMapScriptSrc;return this.callNextMethod();});TP.xctrls.googlemap.Inst.defineMethod('swapMarker',function(a){return TP.todo();});
TP.boot.$srcPath = '~lib_src/xctrls/xctrls_map/xctrls_yahoomap.js';
TP.xctrls.map.defineSubtype('yahoomap');TP.xctrls.yahoomap.Inst.defineMethod('$computeYahooMapScriptSrc',function(){var a;a='http://api.maps.yahoo.com/ajaxymap?v'+'=3.0&appid'+'=KlKbHSHIkY0QsgeX1Xqig2R.iHoSiYy_';return a;});TP.xctrls.yahoomap.Inst.defineMethod('$convertLatLongToYahooLatLong',function(a){return this.get('tpIFrame').constructObject('YGeoPoint',a.get('lat'),a.get('long'));});TP.xctrls.yahoomap.Inst.defineMethod('$convertMarkerToYahooMarker',function(a){var b,c,d;b=this.get('tpIFrame');if(TP.isValid(c=a.get('iconURL'))){d=b.constructObject('YMarker',this.$convertLatLongToYahooLatLong(a.get('location')),b.constructObject('YImage',c));}else{d=b.constructObject('YMarker',this.$convertLatLongToYahooLatLong(a.get('location')));}if(TP.isValid(c=a.get('labelText'))){d.addLabel(c);}return d;});TP.xctrls.yahoomap.Inst.defineMethod('addControls',function(c,b,e,f,d){var a;this.removeAllControls();a=this.get('map');if(TP.isTrue(c)){a.addPanControl();}if(b==='small'){a.addZoomShort();}else if(b==='large'){a.addZoomLong();}if(TP.isTrue(d)){a.Type.defineControl();}return this;});TP.xctrls.yahoomap.Inst.defineMethod('addLargeControls',function(){this.get('map').addPanControl();this.get('map').addZoomLong();return this;});TP.xctrls.yahoomap.Inst.defineMethod('addMapTypeControls',function(){this.get('map').Type.defineControl();return this;});TP.xctrls.yahoomap.Inst.defineMethod('addMarker',function(a){var b;b=this.$convertMarkerToYahooMarker(a);a.set('nativeMarker',b);this.get('tpIFrame').get('YEvent').Capture(b,this.get('tpIFrame').get('EventsList').MouseClick,function(){this.signal('TP_xctrls_MapMarkerClicked',null,a);}.bind(this));this.get('map').addOverlay(b);this.get('markers').push(a);this.signal('TP_xctrls_MapMarkerAdded',null,a);return this;});TP.xctrls.yahoomap.Inst.defineMethod('addSmallControls',function(){this.get('map').addPanControl();this.get('map').addZoomShort();return this;});TP.xctrls.yahoomap.Inst.defineMethod('configure',function(){var a,b,d,e,f,c;a=this.get('tpIFrame');b=a.getNativeContentWindow();d=a.getNativeContentDocument();e=TP.nodeGetElementById(d,'map_stub');f=a.constructObject('YMap',e);this.set('map',f);c=false;a.get('YEvent').Capture(this.get('map'),a.get('EventsList').MouseClick,TP.windowBuildFunctionFor(b,function(b,a){if(c){c=false;return;}this.signal('TP_xctrls_MapClicked',null,TP.llc(a.Lat,a.Lon));}.bind(this)));a.get('YEvent').Capture(this.get('map'),a.get('EventsList').endPan,TP.windowBuildFunctionFor(b,function(){this.signal('TP_xctrls_MapPanned',null,this.getCenter());c=true;}.bind(this)));a.get('YEvent').Capture(this.get('map'),a.get('EventsList').changeZoom,TP.windowBuildFunctionFor(b,function(){this.signal('TP_xctrls_MapPanned',null,this.getCenter());}.bind(this)));this.refresh();return this.callNextMethod();});TP.xctrls.yahoomap.Inst.defineMethod('getBounds',function(){var a,b;a=this.get('map').getBoundsLatLon();b=TP.core.MapBounds.construct(a.LatMin,a.LonMin,a.LatMax,a.LonMax);return b;});TP.xctrls.yahoomap.Inst.defineMethod('getCenter',function(){var a;a=this.get('map').getCenterLatLon();return TP.llc(a.Lat,a.Lon);});TP.xctrls.yahoomap.Inst.defineMethod('getLatLongForAddress',function(c){var b,a;b=this.get('map');a=this.get('tpIFrame');a.get('YEvent').Capture(b,a.get('EventsList').onEndGeoCode,function(a){var b;if(a.success!==1){return;}b=TP.llc(a.Lat,a.Lon);b.set('description',a.Address);this.signal('TP_xctrls_MapGeocodeComplete',null,b);}.bind(this));this.get('map').geoCodeAddress(c);return this;});TP.xctrls.yahoomap.Inst.defineMethod('getMapType',function(){var a,c,b,d;a=this.getType();c=this.get('map');b=this.get('tpIFrame');d=c.getCurrentMapType();switch(d){case b.get('YAHOO_MAP_REG'):return a.at('ROAD');case b.get('YAHOO_MAP_SAT'):return a.at('SATELLITE');case b.get('YAHOO_MAP_HYB'):return a.at('HYBRID');default:break;}return this;});TP.xctrls.yahoomap.Inst.defineMethod('getZoom',function(){return 18-this.get('map').getZoomLevel();});TP.xctrls.yahoomap.Inst.defineMethod('getZoomLevelForMapBounds',function(a){var b,c,d;c=this.$convertLatLongToYahooLatLong(a.get('northEastLatLong'));b=this.$convertLatLongToYahooLatLong(a.get('southWestLatLong'));d=this.get('map').getZoomLevel(TP.ac(c,b));return d;});TP.xctrls.yahoomap.Inst.defineMethod('hideAllMarkers',function(){this.get('map').removeMarkersAll();return this;});TP.xctrls.yahoomap.Inst.defineMethod('removeAllControls',function(){var a;a=this.get('map');a.removePanControl();a.removeZoomControl();return this;});TP.xctrls.yahoomap.Inst.defineMethod('removeMarker',function(a){this.get('map').removeOverlay(a.get('nativeMarker'));this.get('markers').remove(a,TP.IDENTITY);this.signal('TP_xctrls_MapMarkerRemoved',null,a);return this;});TP.xctrls.yahoomap.Inst.defineMethod('setBounds',function(h){var b,c,f,i,g,a,d,e;c=this.$convertLatLongToYahooLatLong(h.get('northEastLatLong'));b=this.$convertLatLongToYahooLatLong(h.get('southWestLatLong'));if(b.lon>c.lon){b.lon-=360;}f=this.get('tpIFrame');i=this.get('tpIFrame').constructObject('YGeoPoint',(b.lat+c.lat)/2,(c.lon+b.lon)/2);g=this.get('map').getContainerSize();for(a=1;a<=17;a++){d=f.get('convertLatLonXY_Yahoo')(b,a);e=f.get('convertLatLonXY_Yahoo')(c,a);if(d.x>e.x){d.x-=1<<26-a;}if(Math.abs(e.x-d.x)<=g.width&&Math.abs(e.y-d.y)<=g.height){this.get('map').drawZoomAndCenter(i,a);break;}}return this;});TP.xctrls.yahoomap.Inst.defineMethod('setCenter',function(b){var c,d,a,e;c=this.getCenter();if(TP.isString(b)){d=b.split(',');a=TP.llc(d.at(0),d.at(1));}else{a=b;}if(c.get('lat')===a.get('lat')&&c.get('long')===a.get('long')){return this;}e=this.$convertLatLongToYahooLatLong(a);this.get('map').panToLatLon(e);this.signal('TP_xctrls_MapPanned',null,a);return this;});TP.xctrls.yahoomap.Inst.defineMethod('setCenterAndZoom',function(a,c){var b;b=18-c;this.get('map').drawZoomAndCenter(this.$convertLatLongToYahooLatLong(a),b);this.signal('TP_xctrls_MapPanned',null,a);return this;});TP.xctrls.yahoomap.Inst.defineMethod('setIsDraggable',function(a){if(TP.isTrue(a)){this.get('map').enableDragMap();}else{this.get('map').disableDragMap();}return this;});TP.xctrls.yahoomap.Inst.defineMethod('setMapType',function(d){var c,a,b;c=this.getType();a=this.get('map');b=this.get('tpIFrame');switch(d){case c.at('ROAD'):a.setMapType(b.get('YAHOO_MAP_REG'));break;case c.at('SATELLITE'):a.setMapType(b.get('YAHOO_MAP_SAT'));break;case c.at('HYBRID'):a.setMapType(b.get('YAHOO_MAP_HYB'));break;default:a.setMapType(b.get('YAHOO_MAP_REG'));break;}return this;});TP.xctrls.yahoomap.Inst.defineMethod('setZoom',function(a){this.get('map').setZoomLevel(18-a);this.signal('TP_xctrls_MapZoomed');return this;});TP.xctrls.yahoomap.Inst.defineMethod('showAllMarkers',function(){var a;a=this.get('tpIFrame');this.get('markers').perform(function(c){var b;b=this.$convertMarkerToYahooMarker(c);c.set('nativeMarker',b);a.get('YEvent').Capture(b,a.get('EventsList').MouseClick,function(){this.signal('TP_xctrls_MapMarkerClicked',null,c);}.bind(this));this.get('map').addOverlay(b);}.bind(this));return this;});TP.xctrls.yahoomap.Inst.defineMethod('sizeTo',function(a,b){return TP.todo();});TP.xctrls.yahoomap.Inst.defineMethod('startIFrameLoad',function(){var a;a=this.get('tpIFrame');a.getNativeNode().computeMapSrc=this.$computeYahooMapScriptSrc;return this.callNextMethod();});TP.xctrls.yahoomap.Inst.defineMethod('swapMarker',function(a){return TP.todo();});
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.toolbar.css_uri', '~TP.xctrls.toolbar/xctrls_toolbar.css');
TP.boot.$srcPath = '';
TP.sys.setcfg('TP.xctrls.toolbar.xhtml_uri', '~TP.xctrls.toolbar/xctrls_toolbar.xhtml');
TP.boot.$srcPath = '~lib_src/svg/svg_.js';
TP.core.XMLNamespace.defineSubtype('svg:XMLNS');
TP.boot.$srcPath = '~lib_src/svg/svg_Element.js';
TP.core.ElementNode.defineSubtype('svg:Element');TP.svg.Element.Type.defineMethod('cmdRunContent',function(a){var b;if(!TP.isElement(b=a.at('cmdNode'))){return;}a.atPut('cmdAsIs',true);a.atPut('cmdBox',false);a.complete(b);return;});TP.svg.Element.Type.defineMethod('tagUnmarshal',function(c){var a,b;if(TP.notValid(a=c.at('node'))){return;}if(TP.isEmpty(b=this.get('uriAttrs'))){return;}TP.elementResolveXMLBase(a,b,'url(',')');return;});TP.svg.Element.Type.defineMethod('tagAttachDOM',function(d){var a,b,c;this.callNextMethod();if(!TP.isElement(a=d.at('node'))){return;}if(TP.isEmpty(b=this.get('uriAttrs'))){return;}c=TP.nodeGetDocument(a).URL;b.perform(function(d){var b;if(TP.isEmpty(b=TP.elementGetAttribute(a,d,true))){return;}if(TP.isURI(b)){return;}if(b.startsWith('url(')){b=b.slice(4,-1);TP.elementSetAttribute(a,d,TP.join('url(',c,b,')'),true);}});return;});
TP.boot.$srcPath = '~lib_src/svg/svg_CommonNodes.js';
TP.core.UIElementNode.defineSubtype('svg:Shape');TP.svg.Shape.addTraitsFrom(TP.svg.Element);TP.svg.Shape.set('uriAttrs',TP.ac('clip-path','cursor','filter','mask','fill','stroke'));
TP.boot.$srcPath = '~lib_src/svg/svg_AnimationModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:animate');TP.svg.animate.addTraitsFrom(TP.svg.Element);TP.svg.animate.set('uriAttrs',TP.ac('xlink:href'));TP.core.UIElementNode.defineSubtype('svg:set');TP.svg.set.addTraitsFrom(TP.svg.Element);TP.svg.set.set('uriAttrs',TP.ac('xlink:href'));TP.core.UIElementNode.defineSubtype('svg:animateMotion');TP.svg.animateMotion.addTraitsFrom(TP.svg.Element);TP.svg.animateMotion.set('uriAttrs',TP.ac('xlink:href'));TP.core.UIElementNode.defineSubtype('svg:animateTransform');TP.svg.animateTransform.addTraitsFrom(TP.svg.Element);TP.svg.animateTransform.set('uriAttrs',TP.ac('xlink:href'));TP.core.UIElementNode.defineSubtype('svg:animateColor');TP.svg.animateColor.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:mpath');TP.svg.mpath.addTraitsFrom(TP.svg.Element);
TP.boot.$srcPath = '~lib_src/svg/svg_ClipModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:clipPath');TP.svg.clipPath.addTraitsFrom(TP.svg.Element);TP.svg.clipPath.set('uriAttrs',TP.ac('clip-path','cursor','filter','mask'));
TP.boot.$srcPath = '~lib_src/svg/svg_ColorProfileModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:color_profile');TP.svg.color_profile.addTraitsFrom(TP.svg.Element);TP.svg.color_profile.set('uriAttrs',TP.ac('xlink:href'));TP.svg.color_profile.set('localName','color-profile');
TP.boot.$srcPath = '~lib_src/svg/svg_ConditionalProcessingModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:switch');TP.svg['switch'].addTraitsFrom(TP.svg.Element);TP.svg['switch'].set('uriAttrs',TP.ac('clip-path','cursor','filter','mask'));
TP.boot.$srcPath = '~lib_src/svg/svg_CursorModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:cursor');TP.svg.cursor.addTraitsFrom(TP.svg.Element);TP.svg.cursor.set('uriAttrs',TP.ac('xlink:href'));
TP.boot.$srcPath = '~lib_src/svg/svg_FilterModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:filter');TP.svg.filter.addTraitsFrom(TP.svg.Element);TP.svg.filter.set('uriAttrs',TP.ac('xlink:href'));TP.core.UIElementNode.defineSubtype('svg:feBlend');TP.svg.feBlend.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feColorMatrix');TP.svg.feColorMatrix.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feComponentTransfer');TP.svg.feComponentTransfer.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feComposite');TP.svg.feComposite.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feConvolveMatrix');TP.svg.feConvolveMatrix.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feDiffuseLighting');TP.svg.feDiffuseLighting.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feDisplacementMap');TP.svg.feDisplacementMap.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feFlood');TP.svg.feFlood.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feGaussianBlur');TP.svg.feGaussianBlur.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feImage');TP.svg.feImage.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feMerge');TP.svg.feMerge.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feMergeNode');TP.svg.feMergeNode.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feMorphology');TP.svg.feMorphology.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feOffset');TP.svg.feOffset.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feSpecularLighting');TP.svg.feSpecularLighting.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feTile');TP.svg.feTile.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feTurbulence');TP.svg.feTurbulence.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feDistantLight');TP.svg.feDistantLight.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:fePointLight');TP.svg.fePointLight.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feSpotLight');TP.svg.feSpotLight.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feFuncR');TP.svg.feFuncR.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feFuncG');TP.svg.feFuncG.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feFuncB');TP.svg.feFuncB.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:feFuncA');TP.svg.feFuncA.addTraitsFrom(TP.svg.Element);
TP.boot.$srcPath = '~lib_src/svg/svg_FontModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:font');TP.svg.font.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:font_face');TP.svg.font_face.addTraitsFrom(TP.svg.Element);TP.svg.font_face.set('localName','font-face');TP.core.UIElementNode.defineSubtype('svg:glyph');TP.svg.glyph.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:missing_glyph');TP.svg.missing_glyph.addTraitsFrom(TP.svg.Element);TP.svg.missing_glyph.set('localName','missing-glyph');TP.core.UIElementNode.defineSubtype('svg:hkern');TP.svg.hkern.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:vkern');TP.svg.vkern.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:font_face_src');TP.svg.font_face_src.addTraitsFrom(TP.svg.Element);TP.svg.font_face_src.set('localName','font-face-src');TP.core.UIElementNode.defineSubtype('svg:font_face_uri');TP.svg.font_face_uri.addTraitsFrom(TP.svg.Element);TP.svg.font_face_uri.set('localName','font-face-uri');TP.core.UIElementNode.defineSubtype('svg:font_face_format');TP.svg.font_face_format.addTraitsFrom(TP.svg.Element);TP.svg.font_face_format.set('localName','font-face-format');TP.core.UIElementNode.defineSubtype('svg:font_face_name');TP.svg.font_face_name.addTraitsFrom(TP.svg.Element);TP.svg.font_face_name.set('localName','font-face-name');TP.core.UIElementNode.defineSubtype('svg:definition_src');TP.svg.definition_src.addTraitsFrom(TP.svg.Element);TP.svg.definition_src.set('localName','definition-src');
TP.boot.$srcPath = '~lib_src/svg/svg_ForeignObjectModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:foreignObject');TP.svg.foreignObject.addTraitsFrom(TP.svg.Element);
TP.boot.$srcPath = '~lib_src/svg/svg_GradientModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:linearGradient');TP.svg.linearGradient.addTraitsFrom(TP.svg.Element);TP.svg.linearGradient.set('uriAttrs',TP.ac('xlink:href'));TP.core.UIElementNode.defineSubtype('svg:radialGradient');TP.svg.radialGradient.addTraitsFrom(TP.svg.Element);TP.svg.radialGradient.set('uriAttrs',TP.ac('xlink:href'));TP.core.UIElementNode.defineSubtype('svg:stop');TP.svg.stop.addTraitsFrom(TP.svg.Element);
TP.boot.$srcPath = '~lib_src/svg/svg_HyperlinkingModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:a');TP.svg.a.addTraitsFrom(TP.svg.Element);TP.svg.a.set('uriAttrs',TP.ac('clip-path','cursor','filter','mask','xlink:href'));
TP.boot.$srcPath = '~lib_src/svg/svg_ImageModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:image');TP.svg.image.addTraitsFrom(TP.svg.Element);TP.svg.image.set('uriAttrs',TP.ac('clip-path','cursor','filter','mask','xlink:href'));
TP.boot.$srcPath = '~lib_src/svg/svg_MarkerModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:marker');TP.svg.marker.addTraitsFrom(TP.svg.Element);TP.svg.marker.set('uriAttrs',TP.ac('clip-path','cursor','filter','mask'));
TP.boot.$srcPath = '~lib_src/svg/svg_MaskModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:mask');TP.svg.mask.addTraitsFrom(TP.svg.Element);TP.svg.mask.set('uriAttrs',TP.ac('clip-path','cursor','filter','mask'));
TP.boot.$srcPath = '~lib_src/svg/svg_PatternModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:pattern');TP.svg.pattern.addTraitsFrom(TP.svg.Element);TP.svg.pattern.set('uriAttrs',TP.ac('clip-path','cursor','filter','mask','xlink:href'));
TP.boot.$srcPath = '~lib_src/svg/svg_ScriptModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:script');TP.svg.script.addTraitsFrom(TP.svg.Element);TP.svg.script.set('uriAttrs',TP.ac('xlink:href'));
TP.boot.$srcPath = '~lib_src/svg/svg_ShapeModuleNodes.js';
TP.svg.Shape.defineSubtype('path');TP.svg.Shape.set('uriAttrs',TP.ac('clip-path','cursor','filter','marker','marker-start','marker-mid','marker-end','mask','fill','stroke'));TP.svg.Shape.defineSubtype('rect');TP.svg.Shape.defineSubtype('circle');TP.svg.Shape.defineSubtype('line');TP.svg.line.set('uriAttrs',TP.ac('clip-path','cursor','filter','marker','marker-start','marker-mid','marker-end','mask','fill','stroke'));TP.svg.Shape.defineSubtype('ellipse');TP.svg.Shape.defineSubtype('polyline');TP.svg.polyline.set('uriAttrs',TP.ac('clip-path','cursor','filter','marker','marker-start','marker-mid','marker-end','mask','fill','stroke'));TP.svg.Shape.defineSubtype('polygon');TP.svg.polygon.set('uriAttrs',TP.ac('clip-path','cursor','filter','marker','marker-start','marker-mid','marker-end','mask','fill','stroke'));
TP.boot.$srcPath = '~lib_src/svg/svg_StructureModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:svg');TP.svg.svg.addTraitsFrom(TP.svg.Element);TP.svg.svg.set('uriAttrs',TP.ac('clip-path','cursor','filter','mask'));TP.core.UIElementNode.defineSubtype('svg:g');TP.svg.g.addTraitsFrom(TP.svg.Element);TP.svg.g.set('uriAttrs',TP.ac('clip-path','cursor','filter','mask'));TP.core.UIElementNode.defineSubtype('svg:defs');TP.svg.defs.addTraitsFrom(TP.svg.Element);TP.svg.defs.set('uriAttrs',TP.ac('clip-path','cursor','filter','mask'));TP.core.UIElementNode.defineSubtype('svg:desc');TP.svg.desc.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:title');TP.svg.title.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:metadata');TP.svg.metadata.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:symbol');TP.svg.symbol.addTraitsFrom(TP.svg.Element);TP.svg.symbol.set('uriAttrs',TP.ac('clip-path','cursor','filter','mask'));TP.core.UIElementNode.defineSubtype('svg:use');TP.svg.use.addTraitsFrom(TP.svg.Element);TP.svg.use.set('uriAttrs',TP.ac('clip-path','cursor','filter','mask'));
TP.boot.$srcPath = '~lib_src/svg/svg_StyleModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:style');TP.svg.style.addTraitsFrom(TP.svg.Element);
TP.boot.$srcPath = '~lib_src/svg/svg_TextModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:text');TP.svg.text.addTraitsFrom(TP.svg.Element);TP.svg.text.set('uriAttrs',TP.ac('clip-path','cursor','filter','mask','fill','stroke'));TP.core.UIElementNode.defineSubtype('svg:tspan');TP.svg.tspan.addTraitsFrom(TP.svg.Element);TP.svg.tspan.set('uriAttrs',TP.ac('fill','stroke'));TP.core.UIElementNode.defineSubtype('svg:tref');TP.svg.tref.addTraitsFrom(TP.svg.Element);TP.svg.tref.set('uriAttrs',TP.ac('fill','stroke','xlink:href'));TP.core.UIElementNode.defineSubtype('svg:textpath');TP.svg.textpath.addTraitsFrom(TP.svg.Element);TP.svg.textpath.set('uriAttrs',TP.ac('fill','stroke','xlink:href'));TP.core.UIElementNode.defineSubtype('svg:altGlyph');TP.svg.altGlyph.addTraitsFrom(TP.svg.Element);TP.svg.altGlyph.set('uriAttrs',TP.ac('fill','stroke','xlink:href'));TP.core.UIElementNode.defineSubtype('svg:altGlyphDef');TP.svg.altGlyphDef.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:altGlyphItem');TP.svg.altGlyphItem.addTraitsFrom(TP.svg.Element);TP.core.UIElementNode.defineSubtype('svg:glyphRef');TP.svg.glyphRef.addTraitsFrom(TP.svg.Element);
TP.boot.$srcPath = '~lib_src/svg/svg_ViewModuleNodes.js';
TP.core.UIElementNode.defineSubtype('svg:view');TP.svg.view.addTraitsFrom(TP.svg.Element);
TP.boot.$srcPath = '~lib_src/xmpp/base/TPJID.js';
TP.lang.Object.defineSubtype('xmpp:JID');TP.definePrimitive('jid',function(a){return TP.xmpp.JID.construct(a);});TP.xmpp.JID.Type.defineAttribute('disallowedJIDCharsRegEx',TP.rc('[ "&\'/:<>@]+'));TP.xmpp.JID.Type.defineAttribute('instances',TP.hc());TP.xmpp.JID.Type.defineMethod('construct',function(a){var d,b,f,e,c;if(TP.isKindOf(a,'TP.xmpp.JID')){return a;}if(!TP.isString(a)){return this.raise('TP.sig.InvalidJID',arguments,a);}d=a.lastIndexOf('@');if(a.indexOf('@')===0||d===a.getSize()-1){return this.raise('TP.sig.InvalidJID',arguments,a);}b=a.slice(0,d);f=a.slice(d);if(this.get('disallowedJIDCharsRegEx').test(b)){b=this.escapeJID(b);}e=b+f;if(TP.isValid(c=this.get('instances').at(e))){return c;}c=this.callNextMethod();this.get('instances').atPut(e,c);return c;});TP.xmpp.JID.Type.defineMethod('escapeJID',function(b){var a;a=b.trim();a=a.replace(/@/g,'\\40').replace(/ /g,'\\20').replace(/\'/g,'\\27').replace(/\"/g,'\\22').replace(/:/g,'\\3a').replace(/\&/g,'\\26').replace(/\\/g,'\\5c').replace(/\//g,'\\2f').replace(/</g,'\\3c').replace(/>/g,'\\3e');return a;});TP.xmpp.JID.Type.defineMethod('unescapeJID',function(a){return a.replace(/\\40/g,'@').replace(/\\20/g,' ').replace(/\\27/g,'\'').replace(/\\22/g,'"').replace(/\\3a/g,':').replace(/\\26/g,'&').replace(/\\5c/g,'\\').replace(/\\2f/g,'/').replace(/\\3c/g,'<').replace(/\\3e/g,'>');});TP.xmpp.JID.Inst.defineAttribute('jid');TP.xmpp.JID.Inst.defineAttribute('presence');TP.xmpp.JID.Inst.defineAttribute('roster');TP.xmpp.JID.Inst.defineAttribute('idleTime');TP.xmpp.JID.Inst.defineAttribute('ignoreRemoteObservers');TP.xmpp.JID.Inst.defineMethod('init',function(a){this.callNextMethod();this.$set('jid',a);this.set('ignoreRemoteObservers',false);this.observe(this,'TP.sig.XMPPPresenceInput');return this;});TP.xmpp.JID.Inst.defineMethod('addObserver',function(g,a,f,h){var b,d,c,e;if(TP.notValid(f)){this.raise('TP.sig.InvalidHandler',arguments);return false;}if(TP.isArray(a)){b=a;}else if(TP.isString(a)){b=a.split(' ');}else if(TP.isType(a)){b=TP.ac(a);}else{this.raise('TP.sig.InvalidParameter',arguments,'Improper signal definition.');return false;}d=b.getSize();for(c=0;c<d;c++){if(TP.isSubtypeOf(b.at(c).asType(),'TP.sig.XMPPSignal')){return true;}}e=b.first();this.observe(TP.uri('xmpp:'+this.asString()+'?;node='+e.getSignalName()),'TP.sig.XMPPPubsubNodeChanged');return true;});TP.xmpp.JID.Inst.defineMethod('asJID',function(){return this;});TP.xmpp.JID.Inst.defineMethod('asString',function(a){return this.get('jid');});TP.xmpp.JID.Inst.defineMethod('getBareJID',function(){var b,a;a=this.get('jid');b=a.indexOf('/');if(b!==TP.NOT_FOUND){return a.slice(0,b);}return a;});TP.xmpp.JID.Inst.defineMethod('getDomain',function(){var b,a;a=this.get('jid');a=a.slice(a.indexOf('@')+1);b=a.indexOf('/');if(b!==TP.NOT_FOUND){return a.slice(0,b);}return a;});TP.xmpp.JID.Inst.defineMethod('getNode',function(){var a;a=this.get('jid');if(a.indexOf('@')===TP.NOT_FOUND){return a;}return a.slice(0,a.indexOf('@'));});TP.xmpp.JID.Inst.defineMethod('getPresence',function(){return this.$get('presence');});TP.xmpp.JID.Inst.defineMethod('getResourcePath',function(){var b,a;a=this.get('jid');a=a.slice(a.indexOf('@')+1);b=a.indexOf('/');if(b!==TP.NOT_FOUND){return a.slice(b+1);}return null;});TP.xmpp.JID.Inst.defineMethod('getRoster',function(){return this.$get('roster');});TP.xmpp.JID.Inst.defineMethod('handleXMPPPresenceInput',function(a){var b,c;if(TP.notValid(a)||TP.notValid(b=a.getPayload())){TP.ifWarn()?TP.warn('Invalid signal data for TP.sig.XMPPPresence event.',TP.IO_LOG,arguments):0;return;}if(TP.notValid(c=b.at('node'))){TP.ifWarn()?TP.warn('Missing stanza data for TP.sig.XMPPPresence event.',TP.IO_LOG,arguments):0;return;}this.set('presence',c);return;});TP.xmpp.JID.Inst.defineMethod('handleXMPPPubsubNodeChanged',function(b){var c,d,a,e,f;if(!TP.isURI(c=TP.uc(b.getOrigin()))){return this.raise('TP.sig.InvalidURI',arguments);}if(TP.notValid(d=c.get('queryDict'))){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.isEmpty(f=d.at('node'))){return this.raise('TP.sig.InvalidSignal',arguments);}if(TP.isArray(a=b.getPayload())){a=a.first();a=TP.wrap(a);}else{a=null;}this.set('ignoreRemoteObservers',true);if(TP.isKindOf(a,TP.xmpp.SignalPayload)){e=a.asTP_sig_Signal();e.fire(this);}else{this.signal(f,arguments);}this.set('ignoreRemoteObservers',false);return;});TP.xmpp.JID.Inst.defineMethod('isPresent',function(){var b,c,a;if(TP.notValid(b=this.get('presence'))){return false;}c=b.get('type');if(c==='unavailable'){return false;}else{a=b.get('show');if(TP.notValid(a)){return true;}return a==='chat'||a==='normal';}});TP.xmpp.JID.Inst.defineMethod('removeObserver',function(g,a,f,h){var b,d,c,e;if(TP.notValid(f)){this.raise('TP.sig.InvalidHandler',arguments);return false;}if(TP.isArray(a)){b=a;}else if(TP.isString(a)){b=a.split(' ');}else if(TP.isType(a)){b=TP.ac(a);}else{this.raise('TP.sig.InvalidParameter',arguments,'Improper signal definition.');return false;}d=b.getSize();for(c=0;c<d;c++){if(TP.isSubtypeOf(b.at(c).asType(),'TP.sig.XMPPSignal')){return true;}}e=b.first();this.ignore(TP.uri('xmpp:'+this.asString()+'?;node='+e.getSignalName()),'TP.sig.XMPPPubsubNodeChanged');return true;});TP.xmpp.JID.Inst.defineMethod('setPresence',function(a){if(!TP.isKindOf(a,'TP.xmpp.Presence')){return this.raise('TP.sig.InvalidXMPPPacket',arguments,a);}return this.$set('presence',a);});TP.xmpp.JID.Inst.defineMethod('setRoster',function(a){if(!TP.isKindOf(a,'TP.xmpp.IqRoster')){return this.raise('TP.sig.InvalidParameter',arguments,a);}return this.$set('roster',a);});TP.xmpp.JID.Inst.defineMethod('signalObservers',function(h,a,o,g,n,m,l,p){var b,j,e,d,k,c,i,f;if(TP.isTrue(this.get('ignoreRemoteObservers'))){return true;}if(TP.notValid(g)){this.raise('TP.sig.InvalidPayload',arguments);return false;}if(TP.isArray(a)){b=a;}else if(TP.isString(a)){b=a.split(' ');}else if(TP.isType(a)){b=TP.ac(a);}else{this.raise('TP.sig.InvalidParameter',arguments,'Improper signal definition.');return false;}j=b.getSize();for(e=0;e<j;e++){if(TP.isSubtypeOf(b.at(e).asType(),'TP.sig.XMPPSignal')){return true;}}d=b.first();k=TP.uri('xmpp:'+this.asString()+'?;node='+d.getSignalName());if(TP.isString(c=d)){if(TP.isType(i=TP.sys.getTypeByName(d))){c=i.construct(g);if(TP.isValid(h)){c.setOrigin(h);}}}if(!TP.isString(c)){f=TP.xmpp.SignalPayload.fromTP_sig_Signal(c);}else{f=TP.xmlnode(g);}k.signal('TP.sig.XMPPPubsubNodeChanged',arguments,f);return false;});String.Inst.defineMethod('asJID',function(){return TP.xmpp.JID.construct(this);});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPP.js';
TP.core.XMLNamespace.defineSubtype('xmpp:XMLNS');TP.xmpp.XMLNS.Type.defineConstant('DIGEST','DIGEST-MD5');TP.xmpp.XMLNS.Type.defineConstant('PLAINTEXT','PLAIN');TP.xmpp.XMLNS.Type.defineConstant('CLIENT','jabber:client');TP.xmpp.XMLNS.Type.defineConstant('SERVER','jabber:server');TP.xmpp.XMLNS.Type.defineConstant('DIALBACK','jabber:server:dialback');TP.xmpp.XMLNS.Type.defineConstant('VCARD','vcard-temp');TP.xmpp.XMLNS.Type.defineConstant('XHTML','html');TP.xmpp.XMLNS.Type.defineConstant('IQ_AGENT','jabber:iq:agent');TP.xmpp.XMLNS.Type.defineConstant('IQ_AGENTS','jabber:iq:agents');TP.xmpp.XMLNS.Type.defineConstant('IQ_AUTH','jabber:iq:auth');TP.xmpp.XMLNS.Type.defineConstant('IQ_AUTOUPDATE','jabber:iq:autoupdate');TP.xmpp.XMLNS.Type.defineConstant('IQ_BROWSE','jabber:iq:browse');TP.xmpp.XMLNS.Type.defineConstant('IQ_CONFERENCE','jabber:iq:conference');TP.xmpp.XMLNS.Type.defineConstant('IQ_GATEWAY','jabber:iq:gateway');TP.xmpp.XMLNS.Type.defineConstant('IQ_LAST','jabber:iq:last');TP.xmpp.XMLNS.Type.defineConstant('IQ_OOB','jabber:iq:oob');TP.xmpp.XMLNS.Type.defineConstant('IQ_PASS','jabber:iq:pass');TP.xmpp.XMLNS.Type.defineConstant('IQ_PRIVATE','jabber:iq:private');TP.xmpp.XMLNS.Type.defineConstant('IQ_REGISTER','jabber:iq:register');TP.xmpp.XMLNS.Type.defineConstant('IQ_ROSTER','jabber:iq:roster');TP.xmpp.XMLNS.Type.defineConstant('IQ_RPC','jabber:iq:rpc');TP.xmpp.XMLNS.Type.defineConstant('IQ_SEARCH','jabber:iq:search');TP.xmpp.XMLNS.Type.defineConstant('IQ_TIME','jabber:iq:time');TP.xmpp.XMLNS.Type.defineConstant('IQ_VERSION','jabber:iq:version');TP.xmpp.XMLNS.Type.defineConstant('X_AUTOUPDATE','jabber:x:autoupdate');TP.xmpp.XMLNS.Type.defineConstant('X_CONFERENCE','jabber:x:conference');TP.xmpp.XMLNS.Type.defineConstant('X_DATA','jabber:x:data');TP.xmpp.XMLNS.Type.defineConstant('X_DELAY','jabber:x:delay');TP.xmpp.XMLNS.Type.defineConstant('X_ENCRYPTED','jabber:x:encrypted');TP.xmpp.XMLNS.Type.defineConstant('X_ENVELOPE','jabber:x:envelope');TP.xmpp.XMLNS.Type.defineConstant('X_EVENT','jabber:x:event');TP.xmpp.XMLNS.Type.defineConstant('X_EXPIRE','jabber:x:expire');TP.xmpp.XMLNS.Type.defineConstant('X_OOB','jabber:x:oob');TP.xmpp.XMLNS.Type.defineConstant('X_ROSTER','jabber:x:roster');TP.xmpp.XMLNS.Type.defineConstant('X_SIGNED','jabber:x:signed');TP.xmpp.XMLNS.Type.defineConstant('X_SXPM','jabber:x:sxpm');TP.xmpp.XMLNS.Type.defineConstant('XMPP_BOSH','urn:xmpp:xbosh');TP.xmpp.XMLNS.Type.defineConstant('STREAM','http://etherx.jabber.org/streams');TP.xmpp.XMLNS.Type.defineConstant('SASL','urn:ietf:params:xml:ns:xmpp-sasl');TP.xmpp.XMLNS.Type.defineConstant('BIND','urn:ietf:params:xml:ns:xmpp-bind');TP.xmpp.XMLNS.Type.defineConstant('SESSION','urn:ietf:params:xml:ns:xmpp-session');TP.xmpp.XMLNS.Type.defineConstant('STREAMS','urn:ietf:params:xml:ns:xmpp-streams');TP.xmpp.XMLNS.Type.defineConstant('STANZAS','urn:ietf:params:xml:ns:xmpp-stanzas');TP.xmpp.XMLNS.Type.defineConstant('IQ_REGERROR','jabber:iq:register:error');TP.xmpp.XMLNS.Type.defineConstant('PARAMS','urn:ietf:params:xml:ns:xmpp-stanzas');TP.xmpp.XMLNS.Type.defineConstant('CAPS','http://jabber.org/protocol/caps');TP.xmpp.XMLNS.Type.defineConstant('PUBSUB','http://jabber.org/protocol/pubsub');TP.xmpp.XMLNS.Type.defineConstant('PUBSUB_ERROR','http://jabber.org/protocol/pubsub#errors');TP.xmpp.XMLNS.Type.defineConstant('PUBSUB_EVENT','http://jabber.org/protocol/pubsub#event');TP.xmpp.XMLNS.Type.defineConstant('PUBSUB_OWNER','http://jabber.org/protocol/pubsub#owner');TP.xmpp.XMLNS.Type.defineConstant('PUBSUB_SUBSCRIBE_AUTHORIZATION','http://jabber.org/protocol/pubsub#subscribe_authorization');TP.xmpp.XMLNS.Type.defineConstant('PUBSUB_SUBSCRIBE_OPTIONS','http://jabber.org/protocol/pubsub#subscribe_options');TP.xmpp.XMLNS.Type.defineConstant('PUBSUB_NODE_CONFIG','http://jabber.org/protocol/pubsub#node_config');TP.xmpp.XMLNS.Type.defineConstant('PUBSUB_META_DATA','http://jabber.org/protocol/pubsub#meta-data');TP.xmpp.XMLNS.Type.defineConstant('PUBSUB_PUBLISH_OPTIONS','http://jabber.org/protocol/pubsub#publish-options');TP.xmpp.XMLNS.Type.defineConstant('HTTP_BIND','http://jabber.org/protocol/httpbind');TP.xmpp.XMLNS.Type.defineConstant('TIBET_SIGNAL',TP.w3.Xmlns.SIGNALS);TP.xmpp.XMLNS.Type.defineConstant('ONLINE','online');TP.xmpp.XMLNS.Type.defineConstant('AWAY','away');TP.xmpp.XMLNS.Type.defineConstant('CHAT','chat');TP.xmpp.XMLNS.Type.defineConstant('DO_NOT_DISTURB','dnd');TP.xmpp.XMLNS.Type.defineConstant('EXTENDED_AWAY','xa');TP.xmpp.XMLNS.Type.defineConstant('BINDING','binding');TP.xmpp.XMLNS.Type.defineAttribute('$nodetypes',TP.hc());TP.xmpp.XMLNS.Type.defineAttribute('$stanzatypes',TP.hc());TP.xmpp.XMLNS.Type.defineMethod('initialize',function(){var a,b;a=TP.hc('uri','','mimetype','','prefix','','rootElement','','defaultNodeType','TP.xmpp.Node');b=TP.w3.Xmlns.get('info');b.atPut(TP.xmpp.XMLNS.CLIENT,a.copy().atPut('uri',TP.xmpp.XMLNS.CLIENT));b.atPut(TP.xmpp.XMLNS.SERVER,a.copy().atPut('uri',TP.xmpp.XMLNS.SERVER));b.atPut(TP.xmpp.XMLNS.DIALBACK,a.copy().atPut('uri',TP.xmpp.XMLNS.DIALBACK));b.atPut(TP.xmpp.XMLNS.IQ_AGENT,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_AGENT));b.atPut(TP.xmpp.XMLNS.IQ_AGENTS,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_AGENTS));b.atPut(TP.xmpp.XMLNS.IQ_AUTH,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_AUTH));b.atPut(TP.xmpp.XMLNS.IQ_AUTOUPDATE,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_AUTOUPDATE));b.atPut(TP.xmpp.XMLNS.IQ_BROWSE,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_BROWSE));b.atPut(TP.xmpp.XMLNS.IQ_CONFERENCE,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_CONFERENCE));b.atPut(TP.xmpp.XMLNS.IQ_GATEWAY,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_GATEWAY));b.atPut(TP.xmpp.XMLNS.IQ_LAST,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_LAST));b.atPut(TP.xmpp.XMLNS.IQ_OOB,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_OOB));b.atPut(TP.xmpp.XMLNS.IQ_PASS,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_PASS));b.atPut(TP.xmpp.XMLNS.IQ_PRIVATE,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_PRIVATE));b.atPut(TP.xmpp.XMLNS.IQ_REGISTER,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_REGISTER));b.atPut(TP.xmpp.XMLNS.IQ_ROSTER,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_ROSTER));b.atPut(TP.xmpp.XMLNS.IQ_RPC,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_RPC));b.atPut(TP.xmpp.XMLNS.IQ_SEARCH,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_SEARCH));b.atPut(TP.xmpp.XMLNS.IQ_TIME,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_TIME));b.atPut(TP.xmpp.XMLNS.IQ_VERSION,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_VERSION));b.atPut(TP.xmpp.XMLNS.X_AUTOUPDATE,a.copy().atPut('uri',TP.xmpp.XMLNS.X_AUTOUPDATE));b.atPut(TP.xmpp.XMLNS.X_CONFERENCE,a.copy().atPut('uri',TP.xmpp.XMLNS.X_CONFERENCE));b.atPut(TP.xmpp.XMLNS.X_DATA,a.copy().atPut('uri',TP.xmpp.XMLNS.X_DATA));b.atPut(TP.xmpp.XMLNS.X_DELAY,a.copy().atPut('uri',TP.xmpp.XMLNS.X_DELAY));b.atPut(TP.xmpp.XMLNS.X_ENCRYPTED,a.copy().atPut('uri',TP.xmpp.XMLNS.X_ENCRYPTED));b.atPut(TP.xmpp.XMLNS.X_ENVELOPE,a.copy().atPut('uri',TP.xmpp.XMLNS.X_ENVELOPE));b.atPut(TP.xmpp.XMLNS.X_EVENT,a.copy().atPut('uri',TP.xmpp.XMLNS.X_EVENT));b.atPut(TP.xmpp.XMLNS.X_EXPIRE,a.copy().atPut('uri',TP.xmpp.XMLNS.X_EXPIRE));b.atPut(TP.xmpp.XMLNS.X_OOB,a.copy().atPut('uri',TP.xmpp.XMLNS.X_OOB));b.atPut(TP.xmpp.XMLNS.X_ROSTER,a.copy().atPut('uri',TP.xmpp.XMLNS.X_ROSTER));b.atPut(TP.xmpp.XMLNS.X_SIGNED,a.copy().atPut('uri',TP.xmpp.XMLNS.X_SIGNED));b.atPut(TP.xmpp.XMLNS.X_SXPM,a.copy().atPut('uri',TP.xmpp.XMLNS.X_SXPM));b.atPut(TP.xmpp.XMLNS.XMPP_BOSH,a.copy().atPut('uri',TP.xmpp.XMLNS.XMPP_BOSH));b.atPut(TP.xmpp.XMLNS.STREAM,a.copy().atPut('uri',TP.xmpp.XMLNS.STREAM));b.atPut(TP.xmpp.XMLNS.SASL,a.copy().atPut('uri',TP.xmpp.XMLNS.SASL));b.atPut(TP.xmpp.XMLNS.BIND,a.copy().atPut('uri',TP.xmpp.XMLNS.BIND));b.atPut(TP.xmpp.XMLNS.SESSION,a.copy().atPut('uri',TP.xmpp.XMLNS.SESSION));b.atPut(TP.xmpp.XMLNS.STREAMS,a.copy().atPut('uri',TP.xmpp.XMLNS.STREAMS));b.atPut(TP.xmpp.XMLNS.STANZAS,a.copy().atPut('uri',TP.xmpp.XMLNS.STANZAS));b.atPut(TP.xmpp.XMLNS.IQ_REGERROR,a.copy().atPut('uri',TP.xmpp.XMLNS.IQ_REGERROR));b.atPut(TP.xmpp.XMLNS.PARAMS,a.copy().atPut('uri',TP.xmpp.XMLNS.PARAMS));b.atPut(TP.xmpp.XMLNS.CAPS,a.copy().atPut('uri',TP.xmpp.XMLNS.CAPS));b.atPut(TP.xmpp.XMLNS.PUBSUB,a.copy().atPut('uri',TP.xmpp.XMLNS.PUBSUB));b.atPut(TP.xmpp.XMLNS.PUBSUB_ERROR,a.copy().atPut('uri',TP.xmpp.XMLNS.PUBSUB_ERROR));b.atPut(TP.xmpp.XMLNS.PUBSUB_EVENT,a.copy().atPut('uri',TP.xmpp.XMLNS.PUBSUB_EVENT));b.atPut(TP.xmpp.XMLNS.PUBSUB_OWNER,a.copy().atPut('uri',TP.xmpp.XMLNS.PUBSUB_OWNER));b.atPut(TP.xmpp.XMLNS.PUBSUB_SUBSCRIBE_AUTHORIZATION,a.copy().atPut('uri',TP.xmpp.XMLNS.PUBSUB_SUBSCRIBE_AUTHORIZATION));b.atPut(TP.xmpp.XMLNS.PUBSUB_SUBSCRIBE_OPTIONS,a.copy().atPut('uri',TP.xmpp.XMLNS.PUBSUB_SUBSCRIBE_OPTIONS));b.atPut(TP.xmpp.XMLNS.PUBSUB_NODE_CONFIG,a.copy().atPut('uri',TP.xmpp.XMLNS.PUBSUB_NODE_CONFIG));b.atPut(TP.xmpp.XMLNS.PUBSUB_META_DATA,a.copy().atPut('uri',TP.xmpp.XMLNS.PUBSUB_META_DATA));b.atPut(TP.xmpp.XMLNS.PUBSUB_PUBLISH_OPTIONS,a.copy().atPut('uri',TP.xmpp.XMLNS.PUBSUB_PUBLISH_OPTIONS));b.atPut(TP.xmpp.XMLNS.TIBET_SIGNAL,a.copy().atPut('uri',TP.xmpp.XMLNS.TIBET_SIGNAL));return;});TP.xmpp.XMLNS.Type.defineMethod('defineStanzaType',function(a,b){this.get('$stanzatypes').atPut(a,b);return;});TP.xmpp.XMLNS.Type.defineMethod('defineNodeType',function(e,b,f){var c,d,a;if(!TP.isType(b)){return this.raise('TP.sig.InvalidType',arguments,b);}c=TP.ifInvalid(f,TP.xmpp.XMLNS.CLIENT);d=e;a=this.get('$nodetypes').at(c);if(TP.notValid(a)){a=TP.hc();this.get('$nodetypes').atPut(c,a);}a.atPut(d,b);return;});TP.xmpp.XMLNS.Type.defineMethod('getErrorString',function(a){if(TP.notValid(a)){return null;}return this.get('errors').at(a.asNumber());});TP.xmpp.XMLNS.Type.defineMethod('getStanzaType',function(a){return this.get('$stanzatypes').at(a);});TP.xmpp.XMLNS.Type.defineMethod('getNodeType',function(d,e){var c,a,b;c=TP.ifInvalid(e,TP.xmpp.XMLNS.CLIENT);a=this.get('$nodetypes').at(c);if(TP.isValid(a)){b=a.at(d);if(TP.isType(b)){return b;}}return null;});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPURL.js';
TP.core.URL.defineSubtype('xmpp:URL');TP.xmpp.URL.Type.defineConstant('SCHEME','xmpp');TP.xmpp.URL.Type.defineConstant('XMPP_REGEX',TP.rc('xmpp:(?://)?([^/]+/)?([^/?]+)(([^;]+);?(\\S*))?'));TP.xmpp.URL.Type.defineAttribute('supportedModes',TP.core.SyncAsync.ASYNCHRONOUS);TP.xmpp.URL.Type.defineAttribute('mode',TP.core.SyncAsync.ASYNCHRONOUS);TP.xmpp.URL.registerForScheme('xmpp');TP.xmpp.URL.Type.defineMethod('$getDefaultHandler',function(a,b){return TP.xmpp.URLHandler;});TP.xmpp.URL.Inst.defineAttribute('authjid');TP.xmpp.URL.Inst.defineAttribute('path');TP.xmpp.URL.Inst.defineAttribute('queryType');TP.xmpp.URL.Inst.defineAttribute('queryDict');TP.xmpp.URL.Inst.defineAttribute('ignoreRemoteObservers');TP.xmpp.URL.Inst.defineMethod('init',function(g){var a,b,c,d,e,f;this.callNextMethod();a=this.getType().XMPP_REGEX.exec(g);if(TP.notValid(a)){return;}if(TP.notEmpty(b=a.at(1))){b=b.chop('/');this.set('authjid',TP.xmpp.JID.construct(b));}this.set('path',TP.xmpp.JID.construct(a.at(2)));if(TP.notEmpty(c=a.at(4))){this.set('queryType',c.slice(1));}if(TP.isValid(d=a.at(5))){e=TP.lang.Hash.fromString(d);this.set('queryDict',e,false);}this.set('ignoreRemoteObservers',false);f=function(a){this.processTP_sig_XMPPPubsubEventInput(a);}.bind(this);f.observe(this,'TP.sig.XMPPPubsubEventInput');return this;});TP.xmpp.URL.Inst.defineMethod('addObserver',function(l,b,k,m){var d,i,f,e,c,h,g,j,a;if(TP.notValid(k)){this.raise('TP.sig.InvalidHandler',arguments);return false;}if(TP.isArray(b)){d=b;}else if(TP.isString(b)){d=b.split(' ');}else if(TP.isType(b)){d=TP.ac(b);}else{this.raise('TP.sig.InvalidParameter',arguments,'Improper signal definition.');return false;}i=d.getSize();for(f=0;f<i;f++){if(d.at(f)!=='TP.sig.XMPPPubsubNodeChanged'&&!TP.isSubtypeOf(d.at(f).asType(),'TP.sig.XMPPPubsubNodeChanged')){return true;}}if(TP.notValid(e=this.get('path'))){this.raise('TP.sig.InvalidParameter',arguments,'No path to pubsub service defined.');return false;}if(TP.notValid(c=this.get('queryDict').at('node'))){this.raise('TP.sig.InvalidParameter',arguments,'No pubsub nodeID defined.');return false;}h=TP.core.User.getEffectiveUser().get('remoteSubscriptions');if(TP.notValid(h.at(e.asString()))){TP.ifWarn()?TP.warn('Remote subscription data not available',TP.LOG,arguments):0;return false;}g=h.at(e.asString());if(g.contains(c)){return true;}j=TP.hc('action','pubsub','pubsub_action','subscribe','pubsubServiceJID',e,'nodeID',c);a=TP.sig.XMPPRequest.construct(j);a.defineMethod('handleRequestSucceeded',function(a){g.add(c);g.unique();});a.defineMethod('handleRequestFailed',function(h){var d,f,g,b;d=h.getResult().getErrorElement();f=d.get('errorCondition').getLocalName();if(f==='item-not-found'){g=TP.hc('action','pubsub','pubsub_action','create','pubsubServiceJID',e,'nodeID',c);b=TP.sig.XMPPRequest.construct(g,this.get('resourceID'));b.defineMethod('handleRequestSucceeded',function(b){a.defineMethod('handleRequestFailed',function(a){return this.raise('TP.sig.InvalidXMPPPubsubNode',arguments,'Cannot create node: '+c);}.bind(this));a.fire();});b.fire();}}.bind(this));a.fire();return true;});TP.xmpp.URL.Inst.defineMethod('processTP_sig_XMPPPubsubEventInput',function(a){var b,c,d;if(TP.notValid(a)||TP.notValid(b=a.getPayload())){TP.ifWarn()?TP.warn('Invalid signal data for TP.sig.XMPPPubsubEventInput event.',TP.IO_LOG,arguments):0;return;}if(TP.notValid(c=b.at('node'))){TP.ifWarn()?TP.warn('Missing stanza data for TP.sig.XMPPPubsubEventInput event.',TP.IO_LOG,arguments):0;return;}if(TP.notEmpty(d=c.evaluateXPath('.//$def:item/*',TP.NODESET))){this.set('ignoreRemoteObservers',true);this.signal('TP.sig.XMPPPubsubNodeChanged',arguments,d);this.set('ignoreRemoteObservers',false);}return;});TP.xmpp.URL.Inst.defineMethod('removeObserver',function(l,a,k,m){var b,i,c,e,d,g,h,j,f;if(TP.notValid(k)){this.raise('TP.sig.InvalidHandler',arguments);return false;}if(TP.isArray(a)){b=a;}else if(TP.isString(a)){b=a.split(' ');}else if(TP.isType(a)){b=TP.ac(a);}else{this.raise('TP.sig.InvalidParameter',arguments,'Improper signal definition.');return false;}i=b.getSize();for(c=0;c<i;c++){if(b.at(c)!=='TP.sig.XMPPPubsubNodeChanged'&&!TP.isSubtypeOf(b.at(c).asType(),'TP.sig.XMPPPubsubNodeChanged')){return true;}}if(TP.notValid(e=this.get('path'))){this.raise('TP.sig.InvalidParameter',arguments,'No path to pubsub service defined.');return false;}if(TP.notValid(d=this.get('queryDict').at('node'))){this.raise('TP.sig.InvalidParameter',arguments,'No pubsub nodeID defined.');return false;}g=TP.core.User.getEffectiveUser().get('remoteSubscriptions');if(TP.notValid(g.at(e.asString()))){TP.ifWarn()?TP.warn('Remote subscription data not available',TP.LOG,arguments):0;return false;}h=g.at(e.asString());if(!h.contains(d)){return true;}j=TP.hc('action','pubsub','pubsub_action','unsubscribe','pubsubServiceJID',e,'nodeID',d);f=TP.sig.XMPPRequest.construct(j);f.defineMethod('handleRequestSucceeded',function(a){h.remove(d);});f.defineMethod('handleRequestFailed',function(c){var a,b;a=c.getResult().getErrorElement();b=TP.elementGetLocalName(a.get('errorCondition'));if(b==='item-not-found'){return this.raise('TP.sig.InvalidXMPPPubsubNode',arguments,'Node doesn\'t exist: '+d);}}.bind(this));f.fire();return true;});TP.xmpp.URL.Inst.defineMethod('signalObservers',function(k,a,o,i,n,m,l,p){var b,j,c,g,f,d,h,e;if(TP.isTrue(this.get('ignoreRemoteObservers'))){return true;}if(TP.notValid(i)){this.raise('TP.sig.InvalidPayload',arguments);return false;}if(TP.isArray(a)){b=a;}else if(TP.isString(a)){b=a.split(' ');}else if(TP.isType(a)){b=TP.ac(a);}else{this.raise('TP.sig.InvalidParameter',arguments,'Improper signal definition.');return false;}j=b.getSize();for(c=0;c<j;c++){if(b.at(c)!=='TP.sig.XMPPPubsubNodeChanged'&&!TP.isSubtypeOf(b.at(c).asType(),'TP.sig.XMPPPubsubNodeChanged')){return true;}}if(TP.notValid(g=this.get('path'))){this.raise('TP.sig.InvalidParameter',arguments,'No path to pubsub service defined.');return false;}if(TP.notValid(f=this.get('queryDict').at('node'))){this.raise('TP.sig.InvalidParameter',arguments,'No pubsub nodeID defined.');return false;}d=TP.elem(i);if(!TP.isElement(d)){this.raise('TP.sig.InvalidParameter',arguments,'Pubsub payload is not XML Element.');return false;}h=TP.hc('action','pubsub','pubsub_action','publish','pubsubServiceJID',g,'nodeID',f,'payload',d);e=TP.sig.XMPPRequest.construct(h);e.fire();return false;});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPURLHandler.js';
TP.core.URIHandler.defineSubtype('xmpp:URLHandler');TP.xmpp.URLHandler.Type.defineMethod('load',function(d,j){var e,h,g,a,b,c,k,i,f;TP.debug('break.uri_load');e=TP.request(j);h=e.constructResponse();if(TP.isEmpty(g=d.get('queryType'))){e.fail();return h;}a=TP.ifInvalid(e.at('uriparams'),TP.hc());b=TP.ifInvalid(d.get('queryDict'),TP.hc());c=TP.hc('action',g);if(TP.notEmpty(k=d.get('authjid'))){c.atPut('connectionJID',k);}switch(g){case'command':c.add('toJID',d.get('path'),'cmd_action',a.atIfInvalid('action',b.at('action')),'node',unescape(a.atIfInvalid('node',b.at('node'))));break;case'disco':break;case'invite':break;case'join':break;case'message':c.add('toJID',d.get('path'),'subject',unescape(a.atIfInvalid('subject',b.at('subject'))),'body',unescape(a.atIfInvalid('body',b.at('body'))),'thread',a.atIfInvalid('thread',b.at('thread')),'from',a.atIfInvalid('from',b.at('from')),'id',a.atIfInvalid('id',b.at('id')),'type','chat');break;case'pubsub':i=a.atIfInvalid('action',b.at('action'));c.atPut('pubsub_action',i);c.atPut('pubsubServiceJID',d.get('path'));c.atPut('nodeID',a.atIfInvalid('node',b.at('node')));switch(i){case'subscribe':break;case'unsubscribe':break;case'publish':c.atPut('payload',a.atIfInvalid('payload',b.at('payload')));break;case'retract':c.atPut('itemID',a.atIfInvalid('itemID',b.at('itemID')));break;case'delete':break;default:j.fail(TP.FAILURE,'Unrecognized pubsub action');return this;}break;case'recvfile':break;case'register':break;case'remove':c.add('toJID',d.get('path'),'name',a.atIfInvalid('name',b.at('name')));break;case'roster':c.add('toJID',d.get('path'),'name',a.atIfInvalid('name',b.at('name')),'group',a.atIfInvalid('group',b.at('group')));break;case'sendfile':break;case'subscribe':c.atPut('toJID',d.get('path'));break;case'unregister':break;case'unsubscribe':c.atPut('toJID',d.get('path'));break;case'presence':c.add('show',a.atIfInvalid('show',b.at('show')),'status',unescape(a.atIfInvalid('status',b.at('status'))));break;}f=TP.sig.XMPPRequest.construct(c);e.andJoinChild(f);f.fire();e.updateRequestMode(f);return h;});TP.xmpp.URLHandler.Type.defineMethod('nuke',function(d,c){var a,b;this.raise('TP.sig.UnsupportedOperation',arguments);a=TP.request(c);b=a.constructResponse(false);a.fail();return b;});TP.xmpp.URLHandler.Type.defineMethod('save',function(c,f){var d,g,h,b,e,a;TP.debug('break.uri_save');d=TP.request(f);g=d.constructResponse();if(TP.isEmpty(h=c.get('queryType'))){d.fail();return g;}if(TP.notValid(b=d.at('uriparams'))){b=TP.hc();d.atPut('uriparams',b);}e=TP.ifInvalid(c.get('queryDict'),TP.hc());switch(h){case'command':if(TP.isEmpty(a=c.getResourceNode(TP.hc('refresh',false,'async',false)))){a=b.atIfInvalid('node',e.at('node'));}b.atPut('node',a);break;case'message':if(TP.isEmpty(a=c.getResourceText(TP.hc('refresh',false,'async',false)))){a=b.atIfInvalid('body',e.at('body'));}b.atPut('body',a);break;case'presence':if(TP.isEmpty(a=c.getResourceText(TP.hc('refresh',false,'async',false)))){a=b.atIfInvalid('status',e.at('status'));}b.atPut('status',a);break;case'publish':if(TP.isEmpty(a=c.getResource(TP.hc('refresh',false,'async',false)))){a=b.atIfInvalid('payload',e.at('payload'));}b.atPut('payload',a);break;}return this.load(c,f);});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPConnection.js';
TP.lang.Object.defineSubtype('xmpp:Connection');TP.xmpp.Connection.Type.defineAttribute('defaultResource','TIBET');TP.xmpp.Connection.Type.defineMethod('open',function(b,c){var a;if(TP.isEmpty(b)){return this.raise('TP.sig.InvalidParameter',arguments);}a=this.construct(b,c);if(a.open()){return a;}return null;});TP.xmpp.Connection.Inst.defineAttribute('transport');TP.xmpp.Connection.Inst.defineAttribute('serverName');TP.xmpp.Connection.Inst.defineAttribute('outStream');TP.xmpp.Connection.Inst.defineAttribute('inStream');TP.xmpp.Connection.Inst.defineAttribute('wantsBinding',null);TP.xmpp.Connection.Inst.defineAttribute('wantsSession',null);TP.xmpp.Connection.Inst.defineAttribute('SASLMechanisms');TP.xmpp.Connection.Inst.defineAttribute('jid');TP.xmpp.Connection.Inst.defineAttribute('msgID');TP.xmpp.Connection.Inst.defineAttribute('$open',false);TP.xmpp.Connection.Inst.defineAttribute('authenticated',false);TP.xmpp.Connection.Inst.defineMethod('init',function(b,a){var c,d,e;if(TP.isEmpty(b)){return this.raise('TP.sig.InvalidParameter',arguments);}this.callNextMethod();this.set('serverName',b);a.atPut('serverName',b);c=TP.xmpp.InputStream.construct(null,this);this.set('inStream',c);a.atPut('inStream',c);d=TP.xmpp.OutputStream.construct(null,this);this.set('outStream',d);a.atPut('outStream',d);e=TP.ifEmpty(a.at('connectionType'),TP.xmpp.XMLNS.BINDING);if(e.toLowerCase()===TP.xmpp.XMLNS.BINDING){this.set('transport',TP.xmpp.BOSHTransport.construct(a));}return this;});TP.xmpp.Connection.Inst.defineMethod('$auth',function(a,b,e){var c,d;if(TP.notValid(a)||TP.isEmpty(b)){this.raise('TP.sig.InvalidParameter',arguments);return false;}if(TP.isEmpty(this.get('SASLMechanisms'))){this.raise('TP.sig.XMPPAuthException',arguments,'No valid authentication mechanisms found');return false;}c=TP.ifInvalid(e,TP.xmpp.XMLNS.DIGEST);if(!this.get('SASLMechanisms').contains(c)){this.raise('TP.sig.UnsupportedXMPPAuthMethod',arguments,'Desired authentication mechanism not supported');}switch(c){case TP.xmpp.XMLNS.DIGEST:d=this.$authDigest(a,b);break;case TP.xmpp.XMLNS.PLAINTEXT:d=this.$authPlainText(a,b);break;}return d;});TP.xmpp.Connection.Inst.defineMethod('$authDigest',function(w,u){var b,y,j,l,a,n,i,k,c,e,g,f,v,m,h,x,s,t,d,o,p,q,r;if(TP.notValid(w)||TP.isEmpty(u)){this.raise('TP.sig.InvalidParameter',arguments);return false;}b=w.asJID();y=this.getInputStream();j=this.getOutputStream();l=TP.xmpp.SASLAuth.construct();l.setAttribute('mechanism','DIGEST-MD5');j.write(l);a=this.get('transport').receive();if(TP.notValid(a)){return false;}if(a.getLocalName()!=='challenge'||TP.nodeGetNSURI(a.getNativeNode())!==TP.xmpp.XMLNS.SASL){this.raise('TP.sig.UnsupportedXMPPAuthMethod',arguments,'SASL DIGEST-MD5 not supported');return false;}n=a.getTextContent();if(TP.isEmpty(n)){this.raise('TP.sig.XMPPAuthException',arguments,'SASL DIGEST-MD5 challenge data missing');return false;}i=TP.atob(n);k=i.indexOf('nonce=')+7;c=i.substring(k,i.indexOf('"',k));if(TP.isEmpty(c)){this.raise('TP.sig.XMPPAuthException',arguments,'SASL DIGEST-MD5 challenge server nonce not found');return false;}e=TP.generateRandomValue(14);g='xmpp/'+b.get('domain');f='00000001';v=TP.join(b.get('node'),':',b.get('domain'),':',u);m=TP.join(TP.hash(v,TP.HASH_MD5,TP.HASH_LATIN1),':',c,':',e);h='AUTHENTICATE:'+g;x=TP.hash(TP.join(TP.hash(m,TP.HASH_MD5,TP.HASH_HEX),':',c,':',f,':',e,':','auth:',TP.hash(h,TP.HASH_MD5,TP.HASH_HEX)),TP.HASH_MD5,TP.HASH_HEX);s=TP.join('username="',b.get('node'),'",','realm="',b.get('domain'),'",','nonce="',c,'",','cnonce="',e,'",','nc="',f,'",','qop=auth,digest-uri="',g,'",','response="',x,'",','charset=',TP.UTF8);t=TP.extern.forge.util.encode64(TP.extern.forge.util.encodeUtf8(s));d=TP.xmpp.SASLResponse.construct();d.setTextContent(t);j.write(d);a=this.get('transport').receive();if(TP.notValid(a)){return false;}while(a.getLocalName()==='challenge'){o=a.getTextContent();if(TP.isEmpty(o)){this.raise('TP.sig.XMPPAuthException',arguments,'SASL DIGEST-MD5 response text missing');return false;}p=TP.atob(o);q=p.substring(p.indexOf('rspauth=')+8);h=':'+g;r=TP.hash(TP.join(TP.hash(m,TP.HASH_MD5,TP.HASH_HEX),':',c,':',f,':',e,':','auth:',TP.hash(h,TP.HASH_MD5,TP.HASH_HEX)),TP.HASH_MD5,TP.HASH_HEX);if(r!==q){this.raise('TP.sig.XMPPAuthException',arguments,'SASL DIGEST-MD5 response test did not match '+'initial response text');return false;}d=TP.xmpp.SASLResponse.construct();j.write(d);a=this.get('transport').receive();if(TP.notValid(a)){return false;}}if(a.getLocalName()!=='success'||TP.nodeGetNSURI(a.getNativeNode())!==TP.xmpp.XMLNS.SASL){this.raise('TP.sig.XMPPAuthException',arguments,'SASL DIGEST-MD5 did not successfully authenticate');return false;}return true;});TP.xmpp.Connection.Inst.defineMethod('$authPlainText',function(a,b){TP.override();return false;});TP.xmpp.Connection.Inst.defineMethod('authenticate',function(c,d){var a,e,b;if(TP.notValid(c)||TP.isEmpty(d)){this.raise('TP.sig.InvalidParameter',arguments);return false;}a=c.asJID();if(TP.isEmpty(a.get('resourcePath'))){a=TP.xmpp.JID.construct(TP.join(a.asString(),'/',this.getType().get('defaultResource')));}this.set('jid',a);e=this.$auth(a,d);if(!e){this.close();return false;}this.get('transport').connectionDidAuthenticate();b=this.get('transport').receive();if(TP.isValid(b)&&TP.isElement(b=b.getNativeNode())){this.obtainStreamFeatures(b);}if(TP.isTrue(this.get('wantsBinding'))){if(!this.bindResource(a)){return false;}}if(TP.isTrue(this.get('wantsSession'))){if(!this.establishSession(a)){return false;}}this.isAuthenticated(true);this.observe(this.get('transport'),'TP.sig.XMPPTransportReady');this.observe(this.get('transport'),'TP.sig.XMPPTransportException');this.get('transport').startReceiving();this.signal('TP.sig.XMPPConnectionReady');return true;});TP.xmpp.Connection.Inst.defineMethod('bindResource',function(a){var c,f,d,e,b;if(TP.notValid(a)){this.raise('TP.sig.InvalidParameter',arguments);return false;}c=TP.xmpp.BindResource.construct();c.addResource(a.get('resourcePath'));f=this.constructStanza('set',null,c);this.send(f);d=this.get('transport').receive();if(TP.notValid(d)){return false;}e=d.getElementsByTagName('jid').first();if(TP.notValid(e)){this.raise('TP.sig.XMPPResourceAllocationException',arguments,TP.join('Server could not allocate resource: ',a.get('resourcePath'),' for JID: ',a.asString()));return false;}b=e.getTextContent();if(a.asString()!==b){a.set('jid',b);TP.ifWarn()?TP.warn(TP.join('Server could not allocate resource for JID: ',a.asString(),'. JID reset to: ',b),TP.IO_LOG,arguments):0;}return true;});TP.xmpp.Connection.Inst.defineMethod('close',function(a){if(!this.isOpen()){return true;}if(TP.notTrue(a)){this.getOutputStream().close();}this.get('transport').stopReceiving();this.get('transport').disconnect();this.ignore(this.get('transport'),'TP.sig.XMPPTransportReady');this.ignore(this.get('transport'),'TP.sig.XMPPTransportException');this.isOpen(false);return!this.isOpen();});TP.xmpp.Connection.Inst.defineMethod('constructStanza',function(f,d,e){var b,c,a;b=TP.ifInvalid(f,'normal');if(!TP.isType(c=TP.xmpp.XMLNS.getStanzaType(b))){return this.raise('TP.sig.InvalidXMPPStanzaType',arguments,b);}if(TP.notValid(a=c.construct())){return this.raise('TP.sig.InvalidInstantiation',arguments,c);}a.set('stanzaType',b);a.set('connection',this);if(TP.isValid(d)){a.set('to',d.asString());}if(TP.isValid(e)){a.addPayload(e);}return a;});TP.xmpp.Connection.Inst.defineMethod('establishSession',function(a){var d,b,c,e;if(TP.notValid(a)){this.raise('TP.sig.InvalidParameter',arguments);return false;}d=TP.xmpp.Session.construct();b=this.constructStanza('set',null,d);b.set('from',a.asString());this.send(b);c=this.get('transport').receive();if(TP.notValid(c)){return false;}e=c.getElementsByTagName('error').first();if(TP.isValid(e)){this.raise('TP.sig.XMPPSessionEstablishmentException',arguments,TP.join('Server could not establish a session for JID: ',a.asString()));return false;}return true;});TP.xmpp.Connection.Inst.defineMethod('getInputStream',function(){return this.get('inStream');});TP.xmpp.Connection.Inst.defineMethod('getLastMessageID',function(){return this.$get('msgID');});TP.xmpp.Connection.Inst.defineMethod('getMessageCount',function(){return this.$get('msgCount');});TP.xmpp.Connection.Inst.defineMethod('getOutputStream',function(){return this.get('outStream');});TP.xmpp.Connection.Inst.defineMethod('handleXMPPDataAvailable',function(f){var c,a,d,b,e;c=this.getInputStream();if(f.getSignalOrigin()!==c.getID()){return;}try{while(TP.isValid(a=c.read())){if(TP.isKindOf(a,TP.xmpp.Node)){if(a.isError()){if(TP.isKindOf(a,TP.xmpp.StreamError)){this.get('transport').stopReceiving();this.get('transport').disconnect();if(this.isOpen()){this.close(true);}}}d=a.getSignalName();if(TP.isKindOf(a,TP.xmpp.Stanza)){if(TP.isEmpty(b=a.getSignalOrigin())){b=this.getID();}}else{b=this.getID();}if(b===TP.NONE){continue;}e=TP.hc('node',a);if(TP.isArray(b)){b.perform(function(a){TP.queue(a,d,null,e,TP.INHERITANCE_FIRING);});continue;}TP.queue(b,d,null,e,TP.INHERITANCE_FIRING);}}TP.sys.fireNextSignal();}catch(a){this.raise('TP.sig.XMPPQueueingException',arguments,TP.ec(a));}return;});TP.xmpp.Connection.Inst.defineMethod('handleXMPPRosterInput',function(b){var c,a,d;if(TP.notValid(b)||TP.notValid(c=b.getPayload())){TP.ifWarn()?TP.warn('Invalid signal data for event.',TP.IO_LOG,arguments):0;return;}if(TP.notValid(a=c.at('node'))){TP.ifWarn()?TP.warn('Missing stanza data for event.',TP.IO_LOG,arguments):0;return;}if(TP.notValid(d=a.getPayload('query',TP.xmpp.XMLNS.IQ_ROSTER).at(0))){return;}if(a.get('tagType')==='result'){this.get('jid').set('roster',d);}if(a.get('tagType')==='set'){return;}return;});TP.xmpp.Connection.Inst.defineMethod('handleXMPPTransportReady',function(a){this.signal('TP.sig.XMPPConnectionReady');});TP.xmpp.Connection.Inst.defineMethod('handleXMPPTransportException',function(a){this.close(true);this.signal('TP.sig.XMPPConnectionException');});TP.xmpp.Connection.Inst.defineMethod('isAuthenticated',function(a){if(TP.isBoolean(a)){this.$set('authenticated',a,false);}return this.$get('authenticated');});TP.xmpp.Connection.Inst.defineMethod('isBusy',function(){return this.get('transport').isBusy();});TP.xmpp.Connection.Inst.defineMethod('isOpen',function(a){if(TP.isBoolean(a)){this.$set('$open',a,false);}return TP.isTrue(this.$get('$open'));});TP.xmpp.Connection.Inst.defineMethod('obtainSASLMechanisms',function(c){var a,b;if(TP.notEmpty(a=TP.nodeGetElementsByTagName(c,'mechanisms'))){a=a.first();if(TP.nodeGetNSURI(a)===TP.xmpp.XMLNS.SASL){b=TP.nodeGetElementsByTagName(a,'mechanism');this.set('SASLMechanisms',b.collect(function(a){return TP.nodeGetTextContent(a);}));}}else{this.set('SASLMechanisms',null);}return;});TP.xmpp.Connection.Inst.defineMethod('obtainStreamFeatures',function(a){var b;if(TP.isValid(this.get('wantsBinding'))&&TP.isValid(this.get('wantsSession'))){return;}if(TP.elementGetLocalName(a)!=='features'||TP.nodeGetNSURI(a)!==TP.xmpp.XMLNS.STREAM){this.raise('TP.sig.XMPFeatureNegotiationException',arguments,'Server did not return supported features list');return;}b=TP.nodeGetElementsByTagName(a,'bind').first();if(TP.isValid(b)){this.set('wantsBinding',true);}else{this.set('wantsBinding',false);}b=TP.nodeGetElementsByTagName(a,'session').first();if(TP.isValid(b)){this.set('wantsSession',true);}else{this.set('wantsSession',false);}return;});TP.xmpp.Connection.Inst.defineMethod('open',function(){var a,b;if(this.isOpen()){this.raise('TP.sig.InvalidOperation',arguments);return true;}this.observe(null,'TP.sig.XMPPDataAvailable');this.observe(null,TP.sig.XMPPRosterInput.getSignalName());a=this.get('transport').connect();if(TP.isValid(b=this.getInputStream().read())){this.obtainSASLMechanisms(b.getNativeNode());}this.isOpen(a);return a;});TP.xmpp.Connection.Inst.defineMethod('send',function(a){var b;if(!this.isOpen()||!this.isAuthenticated()){return this.raise('TP.sig.XMPPConnectionNotReady',arguments);}if(!TP.isKindOf(a,TP.xmpp.Stanza)){return this.raise('TP.sig.InvalidXMPPMessage',arguments);}if(TP.notValid(b=a.get('msgID'))||TP.isEmpty(b)){b=this.get('transport').$getNextMessageID();this.set('msgID',b);a.set('msgID',b);}if(a.expectsResponse()){a.observe(a.get('msgID'),'TP.sig.XMPPInput');}this.getOutputStream().write(a);return a.get('msgID');});TP.xmpp.Connection.Inst.defineMethod('sendRaw',function(a){if(!this.isOpen()||!this.isAuthenticated()){return this.raise('TP.sig.XMPPConnectionNotReady',arguments);}return this.get('transport').transmit(a);});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPTransport.js';
TP.lang.Object.defineSubtype('xmpp:Transport');TP.xmpp.Transport.Type.defineAttribute('logSends',false);TP.xmpp.Transport.Type.defineAttribute('logRecvs',false);TP.xmpp.Transport.Inst.defineAttribute('serverName');TP.xmpp.Transport.Inst.defineAttribute('inStream');TP.xmpp.Transport.Inst.defineAttribute('outStream');TP.xmpp.Transport.Inst.defineAttribute('connectionEstablished');TP.xmpp.Transport.Inst.defineAttribute('logRecvs');TP.xmpp.Transport.Inst.defineAttribute('logSends');TP.xmpp.Transport.Type.defineMethod('shouldLogRecvs',function(a){if(TP.isBoolean(a)){this.$set('logRecvs',a);}return this.$get('logRecvs');});TP.xmpp.Transport.Type.defineMethod('shouldLogSends',function(a){if(TP.isBoolean(a)){this.$set('logSends',a);}return this.$get('logSends');});TP.xmpp.Transport.Inst.defineMethod('init',function(a){if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}this.callNextMethod();this.set('serverName',a.at('serverName'));this.set('inStream',a.at('inStream'));this.set('outStream',a.at('outStream'));this.set('connectionEstablished',false);this.shouldLogRecvs(this.getType().shouldLogRecvs());this.shouldLogSends(this.getType().shouldLogSends());return this;});TP.xmpp.Transport.Inst.defineMethod('connect',function(){return TP.override();});TP.xmpp.Transport.Inst.defineMethod('connectionDidAuthenticate',function(){return this;});TP.xmpp.Transport.Inst.defineMethod('disconnect',function(){return this;});TP.xmpp.Transport.Inst.defineMethod('$getNextMessageID',function(){return TP.override();});TP.xmpp.Transport.Inst.defineMethod('isBusy',function(){return TP.override();});TP.xmpp.Transport.Inst.defineMethod('receive',function(){return TP.override();});TP.xmpp.Transport.Inst.defineMethod('transmit',function(a){return TP.override();});TP.xmpp.Transport.Inst.defineMethod('startReceiving',function(){this.set('connectionEstablished',true);return this;});TP.xmpp.Transport.Inst.defineMethod('stopReceiving',function(){return TP.override();});TP.xmpp.Transport.Inst.defineMethod('shouldLogRecvs',function(a){if(TP.isBoolean(a)){this.$set('logRecvs',a);}return this.$get('logRecvs');});TP.xmpp.Transport.Inst.defineMethod('shouldLogSends',function(a){if(TP.isBoolean(a)){this.$set('logSends',a);}return this.$get('logSends');});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPBOSHTransport.js';
TP.xmpp.Transport.defineSubtype('BOSHTransport');TP.xmpp.BOSHTransport.Type.defineConstant('MAXIMUM_HOLD',1);TP.xmpp.BOSHTransport.Type.defineConstant('MAXIMUM_WAIT',60);TP.xmpp.BOSHTransport.Type.defineConstant('MAXIMUM_PACKETS',1000000000);TP.xmpp.BOSHTransport.Type.defineConstant('MSG_KEY_COUNT',20);TP.xmpp.BOSHTransport.Inst.defineAttribute('$version',1.6);TP.xmpp.BOSHTransport.Inst.defineAttribute('httpServerURI');TP.xmpp.BOSHTransport.Inst.defineAttribute('msgCount',0);TP.xmpp.BOSHTransport.Inst.defineAttribute('receiveChannel');TP.xmpp.BOSHTransport.Inst.defineAttribute('sendChannel');TP.xmpp.BOSHTransport.Inst.defineAttribute('sessionID');TP.xmpp.BOSHTransport.Inst.defineAttribute('lastRID');TP.xmpp.BOSHTransport.Inst.defineAttribute('msgKeys');TP.xmpp.BOSHTransport.Inst.defineAttribute('wait');TP.xmpp.BOSHTransport.Inst.defineAttribute('shortestPolling');TP.xmpp.BOSHTransport.Inst.defineAttribute('inactivity');TP.xmpp.BOSHTransport.Inst.defineAttribute('authID');TP.xmpp.BOSHTransport.Inst.defineMethod('init',function(a){if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}this.callNextMethod();this.set('httpServerURI',a.at('httpServerURI'));return this;});TP.xmpp.BOSHTransport.Inst.defineMethod('$computeMessageKeys',function(){var c,d,b,a;c=Number.random().toString();d=this.getType().MSG_KEY_COUNT;a=TP.ac();a.push(TP.hash(c,TP.HASH_SHA1,TP.HASH_HEX));for(b=1;b<d;b++){a.push(TP.hash(a.last(),TP.HASH_SHA1,TP.HASH_HEX));}this.set('msgKeys',a);return;});TP.xmpp.BOSHTransport.Inst.defineMethod('connect',function(){var b,e,c,a,d,f;b=this.get('inStream');e=this.get('outStream');this.$computeMessageKeys();c=this.sendInitialRequest();a=TP.nodeGetFirstChildElement(c);if(TP.elementGetLocalName(a)!=='body'||TP.nodeGetNSURI(a)!==TP.xmpp.XMLNS.HTTP_BIND){return this.raise('TP.sig.XMPPTransportException',arguments,'No valid "body" element found.');}if(TP.elementGetAttribute(a,'type')==='terminate'){return this.raise('TP.sig.XMPPTransportException',arguments,'Server terminated transport.');}d=TP.elementGetAttribute(a,'sid');this.set('sessionID',d);if(TP.elementHasAttribute(a,'authid')){this.set('authID',TP.elementGetAttribute(a,'authid'));}this.set('wait',TP.elementGetAttribute(a,'wait'));this.set('shortestPolling',TP.elementGetAttribute(a,'polling'));this.set('inactivity',TP.elementGetAttribute(a,'inactivity'));b.setAttribute('id',d);b.isOpen(true);e.isOpen(true);f=TP.str(c);b.write(this.$extractFromBody(f),null);return true;});TP.xmpp.BOSHTransport.Inst.defineMethod('connectionDidAuthenticate',function(){var a,b;if(!this.callNextMethod()){return false;}a=this.get('inStream');b=this.get('outStream');b.empty();a.empty();this.transmit('',TP.hc('to',this.get('serverName'),'xml:lang',TP.sys.getTargetLanguage(),'xmpp:xmlns',TP.xmpp.XMLNS.XMPP_BOSH,'xmpp:restart','true'));return this;});TP.xmpp.BOSHTransport.Inst.defineMethod('$extractFromBody',function(a){if(a.startsWith('<body')&&a.endsWith('</body>')){return a.slice(a.indexOf('>')+1,a.lastIndexOf('<'));}else{return'';}return a;});TP.xmpp.BOSHTransport.Inst.defineMethod('$getNextMessageID',function(){var a;a=this.$get('msgCount')+1;this.$set('msgCount',a,false);return TP.join('tibet_',this.get('lastRID').asString(),'_',a);});TP.xmpp.BOSHTransport.Inst.defineMethod('getNextRID',function(){var a;if(!TP.isNumber(a=this.get('lastRID'))){a=(Number.random()*1000000).floor();if(a+TP.xmpp.BOSHTransport.MAXIMUM_PACKETS>TP.MAX_DOUBLE){a=(Number.random()*1000000).floor();if(a+TP.xmpp.BOSHTransport.MAXIMUM_PACKETS>TP.MAX_DOUBLE){this.raise('TP.sig.XMPPBOSHTransportRIDError',arguments);a=0;}}}a+=1;this.set('lastRID',a);return a;});TP.xmpp.BOSHTransport.Inst.defineMethod('isBusy',function(){return TP.isValid(this.get('sendChannel'));});TP.xmpp.BOSHTransport.Inst.defineMethod('receive',function(){var c,a,b;c=this.get('inStream');a=c.read();if(TP.notValid(a)){this.raise('TP.sig.InvalidXMPPResponse',arguments);return null;}if(a.isError()){if(TP.isKindOf(a,TP.xmpp.StanzaError)){b=a.getPayload();}else{b=a;}this.raise(b.get('errorException'),arguments,b.get('errorDescription'));}return a;});TP.xmpp.BOSHTransport.Inst.defineMethod('$processResults',function(j,k){var a,h,c,b,d,f,g,e,i;a=k.at('xhr');h=this.get('inStream');c=false;b='';if(TP.isXHR(a)&&TP.isString(a.responseText)&&a.responseText!==''){d=a.responseText;f=this.$extractFromBody(d);this.writeRecvMessageToLog(TP.hc('async',true,'body',f,'xhr',a));h.write(f,a);if(/<body(.+)type=['"]terminate['"]/.test(d)){c=true;if(TP.notEmpty(g=d.match(/condition=['"](.+)['"]/).at(1))){b=TP.sc('XMPP BOSH connection terminated.'+' Condition: ')+g;}else{b=TP.sc('XMPP BOSH connection terminated');}}}try{if((e=a.status)!==200){TP.signal(j,e);c=true;if(TP.isEmpty(b)){b='HTTP Error: '+e;}}if(c){return this.raise('TP.sig.XMPPTransportException',arguments,b);}}catch(b){return this.raise('TP.sig.XMPPTransportException',arguments,TP.ec(b,a.responseText));}if(TP.isValid(i=this.get('sendChannel'))){this.set('receiveChannel',i);this.set('sendChannel',null);}else{this.startReceiving();}this.signal('TP.sig.XMPPTransportReady');return this;});TP.xmpp.BOSHTransport.Inst.defineMethod('sendInitialRequest',function(){var b,c,d,a,e,f;b=this.get('httpServerURI');if(this.get('$version')===1.6){c=TP.join('<body xmlns="',TP.xmpp.XMLNS.HTTP_BIND,'"',' xml:lang="',TP.sys.getTargetLanguage(),'"',' ver="1.6"',' xmpp:xmlns="',TP.xmpp.XMLNS.XMPP_BOSH,'" xmpp:version="1.0"',' to="',this.get('serverName'),'"',' route="xmpp:',b.get('host'),':',b.get('port'),'"',' wait="',TP.xmpp.BOSHTransport.MAXIMUM_WAIT,'"',' hold="',TP.xmpp.BOSHTransport.MAXIMUM_HOLD,'"',' rid="',this.getNextRID(),'"',' newkey="',this.get('msgKeys').pop(),'"',' secure="false"','/>');}else{c=TP.join('<body xmlns="',TP.xmpp.XMLNS.HTTP_BIND,'"',' xml:lang="',TP.sys.getTargetLanguage(),'"',' ver="1.5"',' to="',this.get('serverName'),'"',' route="xmpp:',b.get('host'),':',b.get('port'),'"',' wait="',TP.xmpp.BOSHTransport.MAXIMUM_WAIT,'"',' hold="',TP.xmpp.BOSHTransport.MAXIMUM_HOLD,'"',' rid="',this.getNextRID(),'"',' newkey="',this.get('msgKeys').pop(),'"',' secure="false"','/>');}d=b.asString();try{this.writeSendMessageToLog(TP.hc('async',false,'body',c));a=TP.httpPost(d,TP.request('uri',d,'headers',TP.hc('Content-Type',TP.XML_TEXT_ENCODED+'; '+'charset='+TP.UTF8),'body',c));if(!TP.httpDidSucceed(a)){return this.raise('TP.sig.XMPPTransportException',arguments);}}catch(b){return this.raise('TP.sig.XMPPTransportException',arguments,TP.ec(b,a.responseText));}if(TP.notValid(a.responseText)||TP.isEmpty(a.responseText)){return this.raise('TP.sig.XMPPTransportException',arguments,'No opening stream response from server.');}try{e=a.responseText;this.writeRecvMessageToLog(TP.hc('async',false,'body',e,'xhr',a));f=TP.documentFromString(e);if(TP.notValid(f)){throw new Error();}}catch(b){return this.raise('TP.sig.DOMParseException',arguments,TP.ec(b,a.responseText));}return f;});TP.xmpp.BOSHTransport.Inst.defineMethod('transmit',function(h,m){var b,e,a,f,c,i,d,j,k,g,l;b=this.get('httpServerURI').asString();if(h===this.get('outStream').getClosingTag()){this.writeSendMessageToLog(TP.hc('async',false,'body',''));e=this.$wrapWithBody('',TP.hc('type','terminate'));try{a=TP.httpPost(b,TP.request('uri',b,'headers',TP.hc('Content-Type',TP.XML_TEXT_ENCODED+'; '+'charset='+TP.UTF8),'body',e));if(TP.isXHR(a)&&TP.isString(a.responseText)&&a.responseText!==''){f=a.responseText;this.writeRecvMessageToLog(TP.hc('async',false,'body',f,'xhr',a));}if((c=a.status)!==200){TP.signal(b,c);return this.raise('TP.sig.XMPPTransportException',arguments,'HTTP Error: '+c);}}catch(b){return this.raise('TP.sig.XMPPTransportException',arguments,TP.ec(b,a.responseText));}return;}e=this.$wrapWithBody(h,m);if(TP.isFalse(this.get('connectionEstablished'))){this.writeSendMessageToLog(TP.hc('async',false,'body',h));i=false;d='';try{a=TP.httpPost(b,TP.request('uri',b,'headers',TP.hc('Content-Type',TP.XML_TEXT_ENCODED+'; '+'charset='+TP.UTF8),'body',e));if(TP.isXHR(a)&&TP.isString(a.responseText)&&a.responseText!==''){j=a.responseText;f=this.$extractFromBody(j);this.writeRecvMessageToLog(TP.hc('async',false,'body',f,'xhr',a));this.get('inStream').write(f,a);if(/<body(.+)type=['"]terminate['"]/.test(j)){i=true;if(TP.notEmpty(l=j.match(/condition=['"](.+)['"]/).at(1))){d=TP.sc('XMPP BOSH connection terminated.'+' Condition: ')+l;}else{d=TP.sc('XMPP BOSH connection terminated');}}}if((c=a.status)!==200){TP.signal(b,c);i=true;if(TP.isEmpty(d)){d='HTTP Error: '+c;}}if(i){return this.raise('TP.sig.XMPPTransportException',arguments,d);}}catch(b){return this.raise('TP.sig.XMPPTransportException',arguments,TP.ec(b,a.responseText));}}else{if(TP.isValid(k=this.get('sendChannel'))){this.set('receiveChannel',k);this.set('sendChannel',null);}try{g=TP.request('uri',b,'headers',TP.hc('Content-Type',TP.XML_TEXT_ENCODED+'; '+'charset='+TP.UTF8),'body',e,'timeout',TP.MAX_TIMEOUT,'async',true);g.defineMethod('handleIOSucceeded',function(){this.$processResults(b,g);}.bind(this));this.writeSendMessageToLog(TP.hc('async',true,'body',h));a=TP.httpPost(b,g);this.set('sendChannel',a);}catch(b){return this.raise('TP.sig.XMPPTransportException',arguments,TP.ec(b,a.responseText));}}return;});TP.xmpp.BOSHTransport.Inst.defineMethod('startReceiving',function(){var a,b,c;this.callNextMethod();a=this.get('httpServerURI').asString();try{b=TP.request('uri',a,'headers',TP.hc('Content-Type',TP.XML_TEXT_ENCODED+'; '+'charset='+TP.UTF8),'body',this.$wrapWithBody(''),'timeout',TP.MAX_TIMEOUT,'async',true);b.defineMethod('handleIOSucceeded',function(){this.$processResults(a,b);}.bind(this));this.writeSendMessageToLog(TP.hc('async',true,'body',''));c=TP.httpPost(a,b);this.set('receiveChannel',c);}catch(a){return this.raise('TP.sig.XMPPTransportException',arguments,TP.ec(a,c.responseText));}return this;});TP.xmpp.BOSHTransport.Inst.defineMethod('stopReceiving',function(){var a;if(TP.isValid(a=this.get('sendChannel'))){TP.httpAbort(a);}if(TP.isValid(a=this.get('receiveChannel'))){TP.httpAbort(a);}this.set('sendChannel',null);this.set('receiveChannel',null);return this;});TP.xmpp.BOSHTransport.Inst.defineMethod('$wrapWithBody',function(d,c){var b,a;b=this.get('msgKeys').pop();if(TP.isEmpty(this.get('msgKeys'))){this.$computeMessageKeys();a=TP.ac('<body xmlns="',TP.xmpp.XMLNS.HTTP_BIND,'"',' rid="',this.getNextRID(),'"',' sid="',this.get('sessionID'),'"',' key="',b,'"',' newkey="',this.get('msgKeys').pop(),'"');}else{a=TP.ac('<body xmlns="',TP.xmpp.XMLNS.HTTP_BIND,'"',' rid="',this.getNextRID(),'"',' sid="',this.get('sessionID'),'"',' key="',b,'"');}if(TP.notEmpty(c)){c.perform(function(b){a.push(' ',b.first(),'="',b.last(),'"');});}a.push('>',d,'</body>');return a.join('');});TP.xmpp.BOSHTransport.Inst.defineMethod('writeRecvMessageToLog',function(a){var b;b=TP.sys.shouldLogIO();TP.sys.shouldLogIO(this.shouldLogRecvs());if(!b&&TP.sys.shouldLogIO()){TP.ifInfo()?TP.sys.logIO(TP.hc('uri',this.get('httpServerURI'),'direction',TP.RECV,'verb',TP.HTTP_POST,'async',a.at('async'),'body',a.at('body'),'xhr',a.at('xhr'),'message','XMPP channel input'),TP.TRACE,arguments):0;}TP.sys.shouldLogIO(b);return this;});TP.xmpp.BOSHTransport.Inst.defineMethod('writeSendMessageToLog',function(a){var b;b=TP.sys.shouldLogIO();TP.sys.shouldLogIO(this.shouldLogSends());if(!b&&TP.sys.shouldLogIO()){TP.ifInfo()?TP.sys.logIO(TP.hc('uri',this.get('httpServerURI'),'direction',TP.SEND,'verb',TP.HTTP_POST,'async',a.at('async'),'body',a.at('body'),'xhr',a.at('xhr'),'message','XMPP channel output'),TP.TRACE,arguments):0;}TP.sys.shouldLogIO(b);return this;});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPNode.js';
TP.core.ElementNode.defineSubtype('xmpp:Node');TP.xmpp.Node.isAbstract(true);TP.xmpp.Node.Type.defineAttribute('namespace',TP.xmpp.XMLNS.CLIENT);TP.xmpp.Node.Type.defineAttribute('tagname',null);TP.xmpp.Node.Type.defineMethod('constructNativeNode',function(){var b,c,a,d,e,f;b=this.get('tagname');c=this.get('namespace');if(TP.isEmpty(a=this.get('template'))){if(!TP.isType(d=TP.xmpp.XMLNS.getNodeType(b,c))){return null;}a=d.get('template');}if(TP.isEmpty(a)){e=TP.ifInvalid(c,TP.xmpp.XMLNS.CLIENT);a=TP.join('<',b,' xmlns="',e,'"/>');d.set('template',a);}f=TP.elementFromString(a);return f;});TP.xmpp.Node.Type.defineMethod('getConcreteType',function(b){var d,a,e,c;if(!TP.isNode(b)){return this.raise('TP.sig.InvalidNode',arguments,'No node provided.');}if(TP.notEmpty(d=TP.elementGetAttribute(b,'type'))){a=TP.xmpp.XMLNS.getStanzaType(d);}if(!TP.isType(a)){e=TP.elementGetLocalName(b);c=TP.nodeGetNSURI(b);if(TP.isEmpty(c)){c=TP.xmpp.XMLNS.CLIENT;}a=TP.xmpp.XMLNS.getNodeType(e,c);if(!TP.isType(a)){return TP.core.XMLElementNode;}if(a.isAbstract()){return a.getConcreteType(b);}}return a;});TP.xmpp.Node.Type.defineMethod('register',function(){var a,b;a=this.get('tagname');b=this.get('namespace');if(TP.isString(a)&&TP.isString(b)){TP.xmpp.XMLNS.defineNodeType(a,this,b);}return;});TP.xmpp.Node.Inst.defineMethod('getAttribute',function(b){var a;if(TP.isNode(a=this.getNativeNode())){return TP.elementGetAttribute(a,b);}return'';});TP.xmpp.Node.Inst.defineMethod('getErrorElement',function(){var a;a=this.getElementsByTagName('error').first();if(TP.isValid(a)){return a;}return null;});TP.xmpp.Node.Inst.defineMethod('getNamespaceURI',function(){var a;if(TP.notValid(a=TP.nodeGetNSURI(this.getNativeNode()))){return this.getType().get('namespace');}return a;});TP.xmpp.Node.Inst.defineMethod('getNamedDescendant',function(c,f){var d,b,a,e;e=TP.ifInvalid(f,false);b=this.getElementsByTagName(c);if(TP.isEmpty(b)&&e){a=TP.node('<'+c+' xmlns="'+this.get('namespace')+'"/>');if(TP.isElement(a)){if(TP.isElement(d=this.getNativeNode())){a=TP.nodeAppendChild(d,a);}else{return this.raise('TP.sig.XMPPNodeCorruption',arguments,a);}}}else{a=TP.unwrap(b.first());}return a;});TP.xmpp.Node.Inst.defineMethod('getSignalName',function(d){var a,b,c;b=this.getTagName();c=this.get('tagType');a='TP.sig.XMPP';if(TP.isString(b)){a+=b.asStartUpper();if(TP.isString(c)){c.asStartUpper();}}else{a+='Custom';}a+='Input';if(!TP.isType(TP.sys.getTypeByName(a))){TP.sig.XMPPInput.defineSubtype(a);}return a;});TP.xmpp.Node.Inst.defineMethod('getTagName',function(){var a;if(TP.isNode(a=this.getNativeNode())){return a.nodeName;}return;});TP.xmpp.Node.Inst.defineMethod('getTagType',function(){var a;if(TP.isNode(a=this.getNativeNode())){return TP.elementGetAttribute(a,'type');}return;});TP.xmpp.Node.Inst.defineMethod('isError',function(){var a;if(this.getTagName()==='error'){return true;}a=this.getElementsByTagName('error').first();if(TP.isValid(a)){return true;}return false;});TP.xmpp.Node.Inst.defineMethod('isSignal',function(){return false;});TP.xmpp.Node.Inst.defineMethod('setAttribute',function(b,c){var a;if(TP.isNode(a=this.getNativeNode())){return TP.elementSetAttribute(a,b,c,true);}return;});TP.xmpp.Node.Inst.defineMethod('setTagType',function(b){var a;if(TP.isNode(a=this.getNativeNode())){return TP.elementSetAttribute(a,'type',b);}return;});TP.xmpp.Node.Inst.defineMethod('handleArrival',function(a){return;});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPPacket.js';
TP.xmpp.Node.defineSubtype('Packet');TP.xmpp.Packet.isAbstract(true);TP.xmpp.Packet.Inst.defineAttribute('conn');TP.xmpp.Packet.Inst.defineMethod('getConnection',function(){return this.get('conn');});TP.xmpp.Packet.Inst.defineMethod('setConnection',function(a){return this.set('conn',a);});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPPayload.js';
TP.xmpp.Node.defineSubtype('Payload');TP.xmpp.Payload.Type.defineAttribute('childTags');TP.xmpp.Payload.Type.defineAttribute('namespace',null);TP.xmpp.Payload.Type.defineAttribute('tagname',null);TP.xmpp.Payload.Inst.defineMethod('get',function(a){var b,c;b='get'+a.asStartUpper();if(TP.canInvoke(this,b)){return this[b]();}if(TP.isArray(c=this.getType().$get('childTags'))){if(c.containsString(a)){return this.getChildTextContent(a);}}return this.callNextMethod();});TP.xmpp.Payload.Inst.defineMethod('set',function(a,c){var b,d,e;b='set'+a.asStartUpper();if(TP.canInvoke(this,b)){return this[b](c);}if(TP.isArray(d=this.getType().get('childTags'))){if(d.containsString(a)){e=this.getNamedDescendant(a,true);TP.nodeSetTextContent(e,c);return this;}}return this.callNextMethod();});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPStanza.js';
TP.xmpp.Packet.defineSubtype('Stanza');TP.xmpp.Stanza.isAbstract(true);TP.xmpp.Stanza.Type.defineAttribute('stanzaTypes');TP.xmpp.Stanza.Type.defineMethod('register',function(){var a,b;this.callNextMethod();if(TP.isArray(b=this.get('stanzaTypes'))){for(a=0;a<b.getSize();a++){TP.xmpp.XMLNS.defineStanzaType(b.at(a),this);}}return;});TP.xmpp.Stanza.Inst.defineAttribute('$expectsResponse',false);TP.xmpp.Stanza.Inst.defineAttribute('lastResponse');TP.xmpp.Stanza.Inst.defineMethod('init',function(c,a,b){this.callNextMethod(c);if(TP.notValid(this.getNativeNode())){return;}if(TP.isString(a)){this.set('stanzaType',a);}else{this.set('stanzaType',this.get('defaultType'));}if(TP.isValid(b)){this.set('to',b.asString());}return this;});TP.xmpp.Stanza.Inst.defineMethod('addPayload',function(a){if(!TP.isKindOf(a,TP.xmpp.Payload)){return this.raise('TP.sig.InvalidXMPPPayload',arguments,a);}TP.nodeAppendChild(this.getNativeNode(),TP.nodeCloneNode(a.getNativeNode(),true));return this;});TP.xmpp.Stanza.Inst.defineMethod('constructResponse',function(){return TP.override();});TP.xmpp.Stanza.Inst.defineMethod('expectsResponse',function(a){if(TP.isBoolean(a)){this.$set('$expectsResponse',a,false);}return this.$get('$expectsResponse');});TP.xmpp.Stanza.Inst.defineMethod('getDefaultType',function(){return'';});TP.xmpp.Stanza.Inst.defineMethod('getFrom',function(){return this.getAttribute('from');});TP.xmpp.Stanza.Inst.defineMethod('getMsgID',function(){return this.getAttribute('id');});TP.xmpp.Stanza.Inst.defineMethod('getPayload',function(d,b){var c,a,e;c=this.getNativeNode();if(TP.isString(d)){a=TP.nodeGetElementsByTagName(c,d,b);}else{a=TP.nodeGetChildElements(c);if(TP.isString(b)){a=a.select(function(a){return TP.nodeGetNSURI(a)===b;});}}if(TP.isEmpty(a)){return null;}if(TP.elementGetLocalName(a.first())==='error'){e=TP.xmpp.StanzaError.construct(a.first());return TP.ac(e);}a=a.collect(function(a){return TP.xmpp.Node.fromNode(a);});return a;});TP.xmpp.Stanza.Inst.defineMethod('getSignalOrigin',function(a){return TP.ifEmpty(this.get('msgID'),this.getID());});TP.xmpp.Stanza.Inst.defineMethod('getResponse',function(){return this.$get('lastResponse');});TP.xmpp.Stanza.Inst.defineMethod('getTagType',function(){var a;a=this.callNextMethod();if(TP.notValid(a)){this.set('tagType',this.get('defaultType'));}return this.getAttribute('type');});TP.xmpp.Stanza.Inst.defineMethod('getTo',function(){return this.getAttribute('to');});TP.xmpp.Stanza.Inst.defineMethod('handleXMPPInput',function(a){var b,c;if(TP.notValid(a)||TP.notValid(b=a.getPayload())){TP.ifWarn()?TP.warn('Invalid signal data for event.',TP.IO_LOG,arguments):0;return;}if(TP.notValid(c=b.at('node'))){TP.ifWarn()?TP.warn('Missing stanza data for event.',TP.IO_LOG,arguments):0;return;}this.ignore(a.getOrigin(),'TP.sig.XMPPInput');this.set('lastResponse',c);return;});TP.xmpp.Stanza.Inst.defineMethod('send',function(a){var b;if(TP.isValid(a)){return a.send(this);}if(TP.notValid(b=this.get('connection'))){return this.raise('TP.sig.InvalidXMPPConnection',arguments);}return b.send(this);});TP.xmpp.Stanza.Inst.defineMethod('setFrom',function(a){this.setAttribute('from',a);return this;});TP.xmpp.Stanza.Inst.defineMethod('setStanzaType',function(c){var a,b;a=TP.ifInvalid(c,this.get('defaultType'));b=this.getType().get('stanzaTypes');if(TP.notValid(b)||!b.containsString(a)){return this.raise('TP.sig.InvalidXMPPStanzaType',arguments,a);}TP.elementSetAttribute(this.getNativeNode(),'type',a);return this;});TP.xmpp.Stanza.Inst.defineMethod('setMsgID',function(a){this.setAttribute('id',a);return this;});TP.xmpp.Stanza.Inst.defineMethod('setTo',function(a){this.setAttribute('to',a);return this;});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPStream.js';
TP.xmpp.Packet.defineSubtype('Stream');TP.xmpp.Stream.Type.defineAttribute('namespace',TP.xmpp.XMLNS.STREAM);TP.xmpp.Stream.Type.defineAttribute('tagname','stream');TP.xmpp.Stream.Type.defineAttribute('template',TP.join('<stream:stream xmlns="',TP.xmpp.XMLNS.CLIENT,'"',' xmlns:stream="',TP.xmpp.XMLNS.STREAM,'"',' version="1.0">','<!-- TIBET(tm) Active Client Messaging -->','</stream:stream>'));TP.xmpp.Stream.register();TP.xmpp.Stream.Type.defineMethod('getClosingTag',function(){var a;a=TP.nodeAsString(this.get('template'));return a.slice(a.lastIndexOf('<'));});TP.xmpp.Stream.Type.defineMethod('getOpeningTag',function(){var a;a=TP.nodeAsString(this.get('template'));return a.slice(0,a.indexOf('>')+1);});TP.xmpp.Stream.Inst.defineAttribute('open',false);TP.xmpp.Stream.Inst.defineMethod('init',function(c,b){var a;this.callNextMethod(c);if(TP.notValid(a=this.getNativeNode())){return;}TP.elementSetAttributeInNS(a,'xml:lang',TP.sys.getTargetLanguage(),TP.w3.Xmlns.XML);TP.elementAddNamespace(a,'xml',TP.w3.Xmlns.XML);if(TP.notValid(b)){return this.raise('TP.sig.InvalidXMPPConnection',arguments);}this.set('connection',b);return this;});TP.xmpp.Stream.Inst.defineMethod('getClosingTag',function(){var a;a=this.asString(false);return a.slice(a.lastIndexOf('<'));});TP.xmpp.Stream.Inst.defineMethod('getLastPacket',function(){return this.getNativeNode().lastChild;});TP.xmpp.Stream.Inst.defineMethod('getOpeningTag',function(){var a;a=this.asString(false);return a.slice(0,a.indexOf('>')+1);});TP.xmpp.Stream.Inst.defineMethod('getStream',function(){return this.getNativeNode();});TP.xmpp.Stream.Inst.defineMethod('getVersion',function(){return TP.todo();});TP.xmpp.Stream.Inst.defineMethod('isOpen',function(a){if(TP.isBoolean(a)){this.$set('open',a,false);}return TP.isTrue(this.$get('open'));});TP.xmpp.Stream.Inst.defineMethod('setVersion',function(a){return TP.todo();});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPQuery.js';
TP.xmpp.Payload.defineSubtype('Query');TP.xmpp.Query.set('namespace',TP.xmpp.XMLNS.CLIENT);TP.xmpp.Query.set('tagname','query');TP.xmpp.Query.register();TP.xmpp.Query.Inst.defineMethod('init',function(e,f){var b,a,c,d,g;if(TP.isEmpty(f)){b=e;}else{a=TP.nodeAsString(e);TP.regex.XMLNS_STRIP.lastIndex=0;a=a.strip(TP.regex.XMLNS_STRIP);c=/^<(\w+)/g;c.lastIndex=0;c.exec(a);d=c.lastIndex;g=TP.join(a.slice(0,d),' xmlns="',f,'"',a.slice(d));b=TP.elementFromString(g);if(TP.notValid(b)){return;}}return this.callNextMethod(b);});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPVCard.js';
TP.xmpp.Payload.defineSubtype('VCard');TP.xmpp.VCard.set('namespace',TP.xmpp.XMLNS.VCARD);TP.xmpp.VCard.set('tagname','vcard');TP.xmpp.VCard.set('template',TP.join('<vcard xmlns="',TP.xmpp.XMLNS.VCARD,'" version="3.0"></vcard>'));TP.xmpp.VCard.register();
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPMessage.js';
TP.xmpp.Stanza.defineSubtype('Message');TP.xmpp.Message.set('tagname','message');TP.xmpp.Message.set('stanzaTypes',TP.ac('normal','chat','groupchat','headline','error'));TP.xmpp.Message.register();TP.xmpp.Message.Inst.defineMethod('handleRequest',function(){var b,c,a;a=TP.xmpp.Message.construct(null,this.get('tagType'),this.get('from'));a.set('from',this.get('to'));if(TP.isValid(c=this.get('msgID'))&&c!==''){a.set('msgID',c);}if(TP.isValid(b=this.get('thread'))&&b!==''){a.set('thread',b);}return a;});TP.xmpp.Message.Inst.defineMethod('getBody',function(){return this.getChildTextContent('body');});TP.xmpp.Message.Inst.defineMethod('getDefaultType',function(){return'normal';});TP.xmpp.Message.Inst.defineMethod('getHtml',function(){var a,b;a=this.getElementsByTagName('html');if(TP.isArray(a)&&TP.isValid(a.at(0))){b=a.at(0).asString();if(TP.isString(b)){return b.slice(6,-7);}}return;});TP.xmpp.Message.Inst.defineMethod('getSignalName',function(b){var a;a=this.get('payload');if(TP.isValid(a)){if(a.getSize()===1){return a.at(0).getSignalName(this);}else if(a.getSize()===2){if(a.at(0).getTagName().toLowerCase()==='headers'){return a.at(1).getSignalName(this);}else if(a.at(1).getTagName().toLowerCase()==='headers'){return a.at(0).getSignalName(this);}}}return this.callNextMethod();});TP.xmpp.Message.Inst.defineMethod('getSignalOrigin',function(b){var a;a=this.get('payload');if(TP.isValid(a)){if(a.getSize()===1){return a.at(0).getSignalOrigin(this);}else if(a.getSize()===2){if(a.at(0).getTagName().toLowerCase()==='headers'){return a.at(1).getSignalOrigin(this);}else if(a.at(1).getTagName().toLowerCase()==='headers'){return a.at(0).getSignalOrigin(this);}}}return this.callNextMethod();});TP.xmpp.Message.Inst.defineMethod('getSubject',function(){return this.getChildTextContent('subject');});TP.xmpp.Message.Inst.defineMethod('getThread',function(){return this.getChildTextContent('thread');});TP.xmpp.Message.Inst.defineMethod('setBody',function(b){var a;a=this.getNamedDescendant('body',true);TP.nodeSetTextContent(a,b);return this;});TP.xmpp.Message.Inst.defineMethod('setHtml',function(b){var a,c,d;if(b.startsWith('<ht'+'ml>')){a=b.slice(6,-7);}else{a=b;}d=this.getNamedDescendant('html',true);c=TP.elementFromString(a);if(!TP.isElement(c)){return this.raise('TP.sig.InvalidXMPPMarkup',arguments,a);}TP.nodeAppendChild(d,c);return this;});TP.xmpp.Message.Inst.defineMethod('setSubject',function(b){var a;a=this.getNamedDescendant('subject',true);TP.nodeSetTextContent(a,b);return this;});TP.xmpp.Message.Inst.defineMethod('setThread',function(b){var a;a=this.getNamedDescendant('thread',true);TP.nodeSetTextContent(a,b);return this;});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPPresence.js';
TP.xmpp.Stanza.defineSubtype('Presence');TP.xmpp.Presence.set('tagname','presence');TP.xmpp.Presence.set('stanzaTypes',TP.ac('available','unavailable','subscribe','subscribed','unsubscribe','unsubscribed','probe','error'));TP.xmpp.Presence.register();TP.xmpp.Presence.Inst.defineMethod('constructResponse',function(){var b,a;if(this.getAttribute('type')==='subscribe'){a=TP.xmpp.Presence.construct(null,'subscribed').set('to',this.get('from'));}else if(this.getAttribute('type')==='unsubscribe'){a=TP.xmpp.Presence.construct(null,'unsubscribed').set('to',this.get('from'));}else{return;}a.set('from',this.get('to'));if(TP.isString(b=this.get('msgID'))&&b!==''){a.set('msgID',b);}return a;});TP.xmpp.Presence.Inst.defineMethod('getDefaultType',function(){return'available';});TP.xmpp.Presence.Inst.defineMethod('getPriority',function(){return this.getChildTextContent('priority');});TP.xmpp.Presence.Inst.defineMethod('getShow',function(){return this.getChildTextContent('show');});TP.xmpp.Presence.Inst.defineMethod('getSignalOrigin',function(a){return TP.jid(this.get('from'));});TP.xmpp.Presence.Inst.defineMethod('getStatus',function(){return this.getChildTextContent('status');});TP.xmpp.Presence.Inst.defineMethod('setStanzaType',function(a){if(a==='available'){return this;}return this.callNextMethod();});TP.xmpp.Presence.Inst.defineMethod('setPriority',function(b){var a;a=this.getNamedDescendant('priority',true);TP.nodeSetTextContent(a,b);return this;});TP.xmpp.Presence.Inst.defineMethod('setShow',function(b){var a;a=this.getNamedDescendant('show',true);TP.nodeSetTextContent(a,b);return this;});TP.xmpp.Presence.Inst.defineMethod('setStatus',function(b){var a;a=this.getNamedDescendant('status',true);TP.nodeSetTextContent(a,b);return this;});TP.xmpp.Presence.Inst.defineMethod('handleArrival',function(d){var a,c,b;a=this.getAttribute('type');if(a==='subscribe'){b=TP.sig.UserInputRequest.construct(TP.hc('query',this.get('from')+' would like to subscribe to your presence. Allow?','default','yes','async',true));b.defineMethod('handleUserInput',function(d){var c,a,e;b.ignore(null,'TP.sig.UserInput');if(TP.isValid(e=d.getRequest().get('responder'))){d.getRequestID().signal('TP.sig.RequestCompleted');}c=d.getResult();if(TP.isValid(c)&&c.getSize()>0){if(c.toLowerCase().startsWith('y')){a=this.constructResponse();a.set('from',this.get('connection').get('jid').asString());this.get('connection').send(a);}else{a=this.constructResponse();TP.elementSetAttribute(a,'type','unsubscribed');a.set('from',this.get('connection').get('jid').asString());this.get('connection').send(a);}}}.bind(this));b.fire(TP.byOID('yak'));}else if(a==='unsubscribe'){c=this.constructResponse();this.get('connection').send(c);}else if(a==='subscribed'){TP.sig.UserOutputRequest.construct(TP.hc('output','You\'ve been successfully subscribed to: '+this.get('from'))).fire(TP.byOID('yak'));}else if(a==='unsubscribed'){TP.sig.UserOutputRequest.construct(TP.hc('output','You\'ve been successfully unsubscribed '+'(or your subscription request has been denied) from : '+this.get('from'))).fire(TP.byOID('yak'));}return;});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPInputStream.js';
TP.xmpp.Stream.defineSubtype('InputStream');TP.xmpp.InputStream.Inst.defineAttribute('index',0);TP.xmpp.InputStream.Inst.defineMethod('atStart',function(){return this.get('index')===0;});TP.xmpp.InputStream.Inst.defineMethod('atEnd',function(){var a;a=TP.nodeGetChildElements(this.get('stream'));return a.getSize()===0||this.get('index')>=a.getSize();});TP.xmpp.InputStream.Inst.defineMethod('close',function(){this.isOpen(false);return!this.isOpen();});TP.xmpp.InputStream.Inst.defineMethod('empty',function(){this.$set('index',0,false);return this.callNextMethod();});TP.xmpp.InputStream.Inst.defineMethod('getIndex',function(){return this.$get('index');});TP.xmpp.InputStream.Inst.defineMethod('read',function(b){var c,a,d;if(!this.isOpen()){this.raise('TP.sig.XMPPConnectionNotOpen',arguments);return;}if(this.atEnd()&&TP.notValid(b)){return;}if(TP.notValid(b)){a=this.get('index');this.$set('index',a+1,false);}else{a=b;}if(TP.notValid(d=TP.nodeGetChildElementAt(this.get('stream'),a))){return this.raise('TP.sig.XMPPReadException',arguments);}try{c=TP.xmpp.Node.fromNode(d);c.set('connection',this.getConnection());}catch(a){TP.ifError()?TP.error(TP.ec(a,TP.join('Error creating TP.xmpp.Node from "',TP.nodeAsString(d,false),'".')),TP.IO_LOG,arguments):0;}return c;});TP.xmpp.InputStream.Inst.defineMethod('rewind',function(){TP.todo();return this;});TP.xmpp.InputStream.Inst.defineMethod('seek',function(a){TP.todo();return this;});TP.xmpp.InputStream.Inst.defineMethod('write',function(b,g){var d,f,a,c,e;if(TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.isString(b)&&TP.isEmpty(b)){return this;}e=this.getStream();if(TP.isString(b)){a=b;if(a.startsWith('<?xml')){a=a.slice(a.indexOf('>')+1);}if(/<\/stream:stream>/.test(a)){a=a.slice(0,a.indexOf('</stream:stream>'));this.get('connection').close(true);}if(!a.startsWith('<stream:stream')){a='<tmproot>'+a+'</tmproot>';}try{c=TP.elementFromString(a);if(TP.isElement(c)){f=TP.nodeGetChildElements(c);for(d=0;d<f.getSize();d++){TP.nodeAppendChild(e,f.at(d));}}}catch(a){return this.raise('TP.sig.DOMParseException',arguments,TP.ec(a,b));}}else if(TP.isNode(b)){if(TP.isMethod(b.getNativeNode)){c=b.getNativeNode();if(TP.notValid(c)){c=b;}}else{c=b;}if(TP.isNode(c)){TP.nodeAppendChild(e,TP.nodeCloneNode(c,true));}}else{return this.raise('TP.sig.InvalidParameter',arguments);}TP.nodeNormalize(e);if(this.get('connection').isAuthenticated()){this.signal('TP.sig.XMPPDataAvailable');}return;});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPOutputStream.js';
TP.xmpp.Stream.defineSubtype('OutputStream');TP.xmpp.OutputStream.Inst.defineMethod('close',function(){var a;if(TP.isValid(this.write(this.get('closingTag')))){this.isOpen(false);if(TP.notValid(a=this.getConnection())){return this.raise('TP.sig.InvalidXMPPConnection',arguments);}a.close(true);}return!this.isOpen();});TP.xmpp.OutputStream.Inst.defineMethod('read',function(){return this.raise('TP.sig.InvalidOperation',arguments);});TP.xmpp.OutputStream.Inst.defineMethod('write',function(a){var b,c,d;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.isString(a)&&TP.isEmpty(a)){return this;}if(TP.isString(a)){if(!a.startsWith('</stream:stream')){try{b=TP.elementFromString(a);}catch(b){return this.raise('TP.sig.DOMParseException',arguments,TP.ec(b,a));}}c=a;}else if(TP.isKindOf(a,TP.xmpp.Packet)){b=a.getNativeNode();c=a.asString(false);}else{return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.isValid(b)){TP.nodeAppendChild(this.getNativeNode(),TP.nodeCloneNode(b,true));}if(TP.notValid(d=this.getConnection())){return this.raise('TP.sig.InvalidXMPPConnection',arguments);}d.sendRaw(c);return this;});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPError.js';
TP.xmpp.Payload.defineSubtype('Error');TP.xmpp.Error.Inst.defineMethod('getErrorCondition',function(){return TP.override();});TP.xmpp.Error.Inst.defineMethod('getErrorDescription',function(){var a,b;a=this.get('errorCondition');if(TP.notValid(a)){return'';}b=TP.elementGetLocalName(a);return b.replace(/-/g,' ').asTitleCase();});TP.xmpp.Error.Inst.defineMethod('getErrorElement',function(){return this;});TP.xmpp.Error.Inst.defineMethod('getErrorException',function(){return'TP.sig.XMPPException';});TP.xmpp.Error.Inst.defineMethod('getErrorText',function(){var a,b;a='';if(TP.isValid(b=this.getElementsByTagName('text').first())){a=b.getTextContent();a=a.localize(b.getContentLanguage());}return a;});TP.xmpp.Error.Inst.defineMethod('getSignalName',function(d){var a,b,c;a=this.get('errorCondition');if(TP.isValid(a)){b='XMPP'+a.getLocalName().asTitleCase().strip('-')+'ErrorInput';c='TP.sig.'+b;if(TP.notValid(TP.sys.require(c))){TP.sys.require('TP.sig.XMPPErrorInput').defineSubtype(b,'sig');}return c;}return this.callNextMethod();});TP.xmpp.Error.Inst.defineMethod('isError',function(){return true;});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPStreamError.js';
TP.xmpp.Error.defineSubtype('StreamError');TP.xmpp.StreamError.set('namespace',TP.xmpp.XMLNS.STREAM);TP.xmpp.StreamError.set('tagname','error');TP.xmpp.StreamError.set('template',TP.join('<stream:error ','xmlns:stream="http://etherx.jabber.org/streams">','</stream:error>'));TP.xmpp.StreamError.register();TP.xmpp.StreamError.Inst.defineMethod('getErrorCondition',function(){var a;a=this.getElementsByTagName('*',TP.xmpp.XMLNS.STREAMS);return a.detect(function(a){if(a.getLocalName().toLowerCase()!=='text'){return true;}return false;});});TP.xmpp.StreamError.Inst.defineMethod('getErrorException',function(){return'TP.sig.InvalidXMPPStream';});
TP.boot.$srcPath = '~lib_src/xmpp/base/XMPPStanzaError.js';
TP.xmpp.Error.defineSubtype('StanzaError');TP.xmpp.StanzaError.set('namespace',TP.xmpp.XMLNS.CLIENT);TP.xmpp.StanzaError.set('tagname','error');TP.xmpp.StanzaError.register();TP.xmpp.StanzaError.Inst.defineMethod('getErrorCondition',function(){var a;a=this.getElementsByTagName('*',TP.xmpp.XMLNS.STANZAS);return a.detect(function(a){if(a.getLocalName().toLowerCase()!=='text'){return true;}return false;});});TP.xmpp.StanzaError.Inst.defineMethod('getErrorException',function(){return'TP.sig.InvalidXMPPStanza';});
TP.boot.$srcPath = '~lib_src/xmpp/stream/XMPPStreamFeatures.js';
TP.xmpp.Packet.defineSubtype('StreamFeatures');TP.xmpp.StreamFeatures.set('namespace',TP.xmpp.XMLNS.STREAM);TP.xmpp.StreamFeatures.set('tagname','features');TP.xmpp.StreamFeatures.set('template',TP.join('<features xmlns="',TP.xmpp.XMLNS.STREAM,'"></features>'));TP.xmpp.StreamFeatures.register();
TP.boot.$srcPath = '~lib_src/xmpp/sasl/XMPPSASLAuth.js';
TP.xmpp.Packet.defineSubtype('SASLAuth');TP.xmpp.SASLAuth.set('namespace',TP.xmpp.XMLNS.SASL);TP.xmpp.SASLAuth.set('tagname','auth');TP.xmpp.SASLAuth.register();
TP.boot.$srcPath = '~lib_src/xmpp/sasl/XMPPSASLChallenge.js';
TP.xmpp.Packet.defineSubtype('SASLChallenge');TP.xmpp.SASLChallenge.set('namespace',TP.xmpp.XMLNS.SASL);TP.xmpp.SASLChallenge.set('tagname','challenge');TP.xmpp.SASLChallenge.register();
TP.boot.$srcPath = '~lib_src/xmpp/sasl/XMPPSASLFailure.js';
TP.xmpp.Error.defineSubtype('SASLFailure');TP.xmpp.SASLFailure.set('namespace',TP.xmpp.XMLNS.SASL);TP.xmpp.SASLFailure.set('tagname','failure');TP.xmpp.SASLFailure.register();TP.xmpp.SASLFailure.Inst.defineMethod('getErrorCondition',function(){var a;a=this.getElementsByTagName('*',TP.xmpp.XMLNS.SASL);return a.first();});TP.xmpp.SASLFailure.Inst.defineMethod('getErrorText',function(){return'';});
TP.boot.$srcPath = '~lib_src/xmpp/sasl/XMPPSASLResponse.js';
TP.xmpp.Packet.defineSubtype('SASLResponse');TP.xmpp.SASLResponse.set('namespace',TP.xmpp.XMLNS.SASL);TP.xmpp.SASLResponse.set('tagname','response');TP.xmpp.SASLResponse.register();
TP.boot.$srcPath = '~lib_src/xmpp/sasl/XMPPSASLSuccess.js';
TP.xmpp.Packet.defineSubtype('SASLSuccess');TP.xmpp.SASLSuccess.set('namespace',TP.xmpp.XMLNS.SASL);TP.xmpp.SASLSuccess.set('tagname','success');TP.xmpp.SASLSuccess.register();
TP.boot.$srcPath = '~lib_src/xmpp/bind/XMPPBindResource.js';
TP.xmpp.Payload.defineSubtype('BindResource');TP.xmpp.BindResource.set('namespace',TP.xmpp.XMLNS.BIND);TP.xmpp.BindResource.set('tagname','bind');TP.xmpp.BindResource.register();TP.xmpp.BindResource.Inst.defineMethod('addResource',function(b){var a;if(TP.isEmpty(b)){return this.raise('TP.sig.InvalidResourceName',arguments);}a=TP.documentCreateElement(this.getNativeDocument(),'resource',TP.xmpp.XMLNS.BIND);TP.nodeAppendChild(a,this.getNativeDocument().createTextNode(b));TP.nodeAppendChild(this.getNativeNode(),a);return this;});
TP.boot.$srcPath = '~lib_src/xmpp/session/XMPPSession.js';
TP.xmpp.Payload.defineSubtype('Session');TP.xmpp.Session.set('namespace',TP.xmpp.XMLNS.SESSION);TP.xmpp.Session.set('tagname','session');TP.xmpp.Session.register();
TP.boot.$srcPath = '~lib_src/xmpp/signals/XMPPSignal.js';
TP.sig.Signal.defineSubtype('XMPPSignal');TP.sig.XMPPSignal.defineSubtype('XMPPDataAvailable');TP.sig.XMPPSignal.defineSubtype('XMPPTransportReady');TP.sig.XMPPSignal.defineSubtype('XMPPConnectionReady');
TP.boot.$srcPath = '~lib_src/xmpp/signals/XMPPInputSignals.js';
TP.sig.XMPPSignal.defineSubtype('XMPPInput');TP.sig.XMPPInput.defineSubtype('XMPPCustomInput');TP.sig.XMPPInput.defineSubtype('XMPPErrorInput');
TP.boot.$srcPath = '~lib_src/xmpp/signals/XMPPIqInputSignals.js';
TP.sig.XMPPInput.defineSubtype('XMPPIqInput');TP.sig.XMPPIqInput.defineSubtype('XMPPRosterInput');TP.sig.XMPPIqInput.defineSubtype('XMPPIqGetInput');TP.sig.XMPPIqInput.defineSubtype('XMPPIqSetInput');TP.sig.XMPPIqInput.defineSubtype('XMPPIqResultInput');TP.sig.XMPPIqInput.defineSubtype('XMPPIqErrorInput');TP.sig.XMPPIqInput.defineSubtype('XMPPSignalPayloadInput');
TP.boot.$srcPath = '~lib_src/xmpp/signals/XMPPMessageInputSignals.js';
TP.sig.XMPPInput.defineSubtype('XMPPMessageInput');TP.sig.XMPPMessageInput.defineSubtype('XMPPMessageNormalInput');TP.sig.XMPPMessageInput.defineSubtype('XMPPMessageChatInput');TP.sig.XMPPMessageInput.defineSubtype('XMPPMessageGroupchatInput');TP.sig.XMPPMessageInput.defineSubtype('XMPPMessageHeadlineInput');TP.sig.XMPPMessageInput.defineSubtype('XMPPMessageErrorInput');
TP.boot.$srcPath = '~lib_src/xmpp/signals/XMPPPresenceInputSignals.js';
TP.sig.XMPPInput.defineSubtype('XMPPPresenceInput');TP.sig.XMPPPresenceInput.defineSubtype('XMPPPresenceAvailableInput');TP.sig.XMPPPresenceInput.defineSubtype('XMPPPresenceUnavailableInput');TP.sig.XMPPPresenceInput.defineSubtype('XMPPPresenceProbeInput');TP.sig.XMPPPresenceInput.defineSubtype('XMPPPresenceSubscribeInput');TP.sig.XMPPPresenceInput.defineSubtype('XMPPPresenceSubscribedInput');TP.sig.XMPPPresenceInput.defineSubtype('XMPPPresenceUnsubscribeInput');TP.sig.XMPPPresenceInput.defineSubtype('XMPPPresenceUnsubscribedInput');
TP.boot.$srcPath = '~lib_src/xmpp/signals/XMPPPubsubInputSignals.js';
TP.sig.XMPPInput.defineSubtype('XMPPPubsubInput');TP.sig.XMPPPubsubInput.defineSubtype('XMPPPubsubEventInput');TP.sig.XMPPSignal.defineSubtype('XMPPPubsubNodeChanged');
TP.boot.$srcPath = '~lib_src/xmpp/signals/XMPPExceptionSignals.js';
TP.sig.ERROR.defineSubtype('XMPPException');TP.sig.XMPPException.defineSubtype('XMPPInputException');TP.sig.XMPPException.defineSubtype('XMPPReadException');TP.sig.XMPPException.defineSubtype('XMPPWriteException');TP.sig.XMPPException.defineSubtype('XMPPNodeCorruption');TP.sig.XMPPException.defineSubtype('XMPPSerializationException');TP.sig.XMPPException.defineSubtype('XMPPTransportException');TP.sig.XMPPException.defineSubtype('InvalidJID');TP.sig.XMPPException.defineSubtype('InvalidXMPPConnection');TP.sig.XMPPException.defineSubtype('InvalidXMPPStanzaType');TP.sig.XMPPException.defineSubtype('InvalidXMPPPacket');TP.sig.XMPPException.defineSubtype('InvalidXMPPPayload');TP.sig.XMPPException.defineSubtype('InvalidXMPPPubsubNode');TP.sig.XMPPException.defineSubtype('InvalidXMPPResponse');TP.sig.XMPPException.defineSubtype('InvalidXMPPResponseXML');TP.sig.XMPPException.defineSubtype('InvalidXMPPStanza');TP.sig.XMPPException.defineSubtype('InvalidXMPPStream');
TP.boot.$srcPath = '~lib_src/xmpp/signals/XMPPAuthExceptionSignals.js';
TP.sig.XMPPException.defineSubtype('XMPPAuthException');TP.sig.XMPPAuthException.defineSubtype('UnsupportedXMPPAuthMethod');
TP.boot.$srcPath = '~lib_src/xmpp/signals/XMPPConnectionExceptionSignals.js';
TP.sig.XMPPException.defineSubtype('XMPPConnectionException');TP.sig.XMPPConnectionException.defineSubtype('XMPPQueueingException');TP.sig.XMPPConnectionException.defineSubtype('XMPPConnectionNotOpen');TP.sig.XMPPConnectionException.defineSubtype('XMPPConnectionNotReady');
TP.boot.$srcPath = '~lib_src/xmpp/service/XMPPResponse.js';
TP.sig.URIResponse.defineSubtype('XMPPResponse');TP.sig.XMPPResponse.Inst.defineMethod('getFaultCode',function(){var a,b;if(TP.isValid(a=this.getResult())&&a.isError()){b=a.getErrorElement();return b.getErrorCondition().getLocalName();}return;});TP.sig.XMPPResponse.Inst.defineMethod('getFaultText',function(){var a,b;if(TP.isValid(a=this.getResult())&&a.isError()){b=a.getErrorElement();return b.getErrorText();}return;});
TP.boot.$srcPath = '~lib_src/xmpp/service/XMPPRequest.js';
TP.sig.URIRequest.defineSubtype('XMPPRequest');TP.sig.XMPPRequest.Type.defineAttribute('responseType','TP.sig.XMPPResponse');
TP.boot.$srcPath = '~lib_src/xmpp/service/XMPPService.js';
TP.core.URIService.defineSubtype('XMPPService');TP.core.XMPPService.Type.defineAttribute('triggerSignals','TP.sig.XMPPRequest');TP.core.XMPPService.Type.defineAttribute('supportedModes',TP.core.SyncAsync.ASYNCHRONOUS);TP.core.XMPPService.Type.defineAttribute('mode',TP.core.SyncAsync.ASYNCHRONOUS);TP.vcard_temp.vCard.Inst.defineAttribute('conntype',{'value':TP.xpc('./$def:X-XMPP-CONN-TYPE',true).set('extractWith','value')});TP.core.XMPPService.register();TP.core.XMPPService.Inst.defineAttribute('lastStanza');TP.core.XMPPService.Inst.defineAttribute('serverName');TP.core.XMPPService.Inst.defineAttribute('connectionType');TP.core.XMPPService.Inst.defineAttribute('connection');TP.core.XMPPService.Inst.defineAttribute('autosend',true);TP.core.XMPPService.Inst.defineAttribute('requestQueue');TP.core.XMPPService.Inst.defineAttribute('pubsubName','pubsub');TP.core.XMPPService.Inst.defineAttribute('pubsubJID');TP.core.XMPPService.Inst.defineMethod('init',function(b,a){this.callNextMethod();this.configureAuthData(a);this.set('requestQueue',TP.ac());return this;});TP.core.XMPPService.Inst.defineMethod('clearAuthData',function(){this.callNextMethod();this.set('serverName',null);this.set('connectionType',null);this.set('pubsubJID',null);return this;});TP.core.XMPPService.Inst.defineMethod('configureAuthData',function(b){var a,c,d;this.callNextMethod();if(TP.isValid(b)){a=b;}else{a=TP.hc();}this.populateMissingVCardData(TP.hc('serverName',TP.ac('shortname','Enter server name: '),'connectionType',TP.ac('conntype','Enter connection type ("BINDING" or another type): ')),a);if(TP.notValid(c=a.at('serverName'))){b.fail(TP.FAILURE,TP.sc('Missing required server name parameter in request'));return;}this.set('serverName',c);if(TP.notValid(d=a.at('connectionType'))){b.fail(TP.FAILURE,TP.sc('Missing required connection type parameter in request'));return;}this.set('connectionType',d);this.set('pubsubJID',TP.jid(this.get('pubsubName')+'.'+this.get('serverName')));return this;});TP.core.XMPPService.Inst.defineMethod('authenticateConnection',function(e,f){var a,d,b,c;a=TP.hc('connectionJID',e,'connectionPassword',f);if(TP.notValid(d=TP.core.User.getEffectiveUser())){return this.raise('TP.sig.XMPPAuthException',arguments,'No effective user.');}d.populateMissingParams(TP.hc('connectionJID',TP.ac('jid','Enter Jabber ID: '),'connectionPassword',TP.ac('password','Enter your password: ')),a);b=false;if(TP.isValid(c=this.get('connection'))){this.observe(c,'TP.sig.XMPPPubsubInput');b=c.authenticate(a.at('connectionJID'),a.at('connectionPassword'));if(b){this.observe(this.get('connection'),'TP.sig.XMPPConnectionReady');this.observe(this.get('connection'),'TP.sig.XMPPConnectionException');}else{this.ignore(c,'TP.sig.XMPPPubsubInput');}}return b;});TP.core.XMPPService.Inst.defineMethod('getConnectedJID',function(){var a;if(TP.isValid(a=this.$get('connection'))){return a.get('jid');}return null;});TP.core.XMPPService.Inst.defineMethod('getConnection',function(){var a;if(TP.isValid(a=this.$get('connection'))){if(a.isOpen()&&a.get('serverName')===this.get('serverName')){return a;}else if(a.isOpen()){a.close();this.set('connection',null);return null;}}return a;});TP.core.XMPPService.Inst.defineMethod('hasAuthConnection',function(){var a;if(TP.isValid(a=this.$get('connection'))){return a.isAuthenticated();}return false;});TP.core.XMPPService.Inst.defineMethod('hasOpenConnection',function(){var a;if(TP.isValid(a=this.$get('connection'))){if(a.isOpen()){if(a.get('serverName')===this.get('serverName')){return true;}a.close();this.set('connection',null);}}return false;});TP.core.XMPPService.Inst.defineMethod('openConnection',function(){var a;if(this.hasOpenConnection()){return true;}if(TP.notEmpty(this.get('serviceURI'))&&TP.notEmpty(this.get('serverName'))){if(TP.isValid(a=TP.xmpp.Connection.open(this.get('serverName'),TP.hc('httpServerURI',TP.uc(this.get('serviceURI')),'connectionType',TP.ifInvalid(this.get('connectionType'),TP.xmpp.XMLNS.BINDING))))){this.set('connection',a);return true;}}return false;});TP.core.XMPPService.Inst.defineMethod('setupCurrentUser',function(){var c,a,d,b,e,f;c=TP.core.User.getEffectiveUser();a=this.get('pubsubJID');if(TP.notValid(c.get('remoteSubscriptions').at(a.asString()))){d=TP.hc('action','pubsub','pubsub_action','subscriptions','pubsubServiceJID',a.asString());b=TP.sig.XMPPRequest.construct(d,this.get('resourceID'));this.observe(b,'TP.sig.XMPPPubsubInput');b.fire();}e=TP.hc('action','presence','show','online');f=TP.sig.XMPPRequest.construct(e,this.get('resourceID'));f.fire();return this;});TP.core.XMPPService.Inst.defineMethod('shutdownConnection',function(){var a,b,c;if(TP.isValid(a=this.$get('connection'))){if(a.isOpen()){a.close();}this.ignore(a,'TP.sig.XMPPPubsubInput');this.ignore(a,'TP.sig.XMPPConnectionReady');this.ignore(a,'TP.sig.XMPPConnectionException');b=TP.core.User.getEffectiveUser();if(TP.isValid(c=b.get('remoteSubscriptions'))){c.removeKey(this.get('pubsubJID').asString());}this.set('connection',null);}return this;});TP.core.XMPPService.Inst.defineMethod('initiateRegistration',function(){var a,b,c;if(!this.hasOpenConnection()){return this.raise('TP.sig.XMPPConnectionNotOpen',arguments);}a=this.get('connection');b=a.constructStanza('get').addQuery(TP.xmpp.XMLNS.IQ_REGISTER);this.set('lastStanza',b);b.send();c=a.receive();return c;});TP.core.XMPPService.Inst.defineMethod('getRegistrationFieldsFrom',function(a){var b,c,d;if(TP.notValid(a)||!TP.isKindOf(a,TP.xmpp.IqResult)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!this.hasOpenConnection()){return this.raise('TP.sig.XMPPConnectionNotOpen',arguments);}b=TP.hc();if(TP.isValid(c=a.getPayload().at(0))&&TP.notEmpty(d=c.getChildElements())){d.perform(function(a){b.atPut(a.getLocalName(),a.getTextContent());});}return b;});TP.core.XMPPService.Inst.defineMethod('finalizeRegistration',function(d){var a,b,c,e;if(TP.notValid(d)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!this.hasOpenConnection()){return this.raise('TP.sig.XMPPConnectionNotOpen',arguments);}b=this.get('connection');a=TP.xmpp.IqRegister.construct();d.perform(function(b){a.set(b.first(),b.last());});c=b.constructStanza('set').addPayload(a);this.set('lastStanza',c);c.send();e=b.receive();return e;});TP.core.XMPPService.Inst.defineMethod('addToRoster',function(b,a,c,d){if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!this.hasAuthConnection()){return this.raise('TP.sig.XMPPConnectionNotAuthenticated',arguments);}return TP.todo();});TP.core.XMPPService.Inst.defineMethod('fetchRoster',function(c){var b,a;if(!this.hasAuthConnection()){return this.raise('TP.sig.XMPPConnectionNotAuthenticated',arguments);}b=this.get('connection');a=b.constructStanza('get').addQuery(TP.xmpp.XMLNS.IQ_ROSTER);a.set('msgID',c);this.set('lastStanza',a);if(TP.isTrue(this.get('autosend'))){a.send();}return a;});TP.core.XMPPService.Inst.defineMethod('removeFromRoster',function(b,a,c){if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!this.hasAuthConnection()){return this.raise('TP.sig.XMPPConnectionNotAuthenticated',arguments);}return TP.todo();});TP.core.XMPPService.Inst.defineMethod('sendCommand',function(c,a,d,b){if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!TP.isElement(b)){return this.raise('TP.sig.InvalidElement',arguments);}if(!this.hasAuthConnection()){return this.raise('TP.sig.XMPPConnectionNotAuthenticated',arguments);}return TP.todo();});TP.core.XMPPService.Inst.defineMethod('sendMessage',function(g,b,h,c,d,e){var f,a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!this.hasAuthConnection()){return this.raise('TP.sig.XMPPConnectionNotAuthenticated',arguments);}f=this.get('connection');a=f.constructStanza('chat');a.set('msgID',g);a.set('to',b.asString());a.set('from',this.get('connectedJID').asString());a.set('body',h);if(TP.notEmpty(c)){a.set('subject',c);}if(TP.notEmpty(d)){a.set('thread',d);}if(TP.notEmpty(e)){a.set('tagType',e);}this.set('lastStanza',a);if(TP.isTrue(this.get('autosend'))){a.send();}return a;});TP.core.XMPPService.Inst.defineMethod('setPresence',function(e,b,c){var d,a;if(TP.isEmpty(b)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!this.hasAuthConnection()){return this.raise('TP.sig.XMPPConnectionNotAuthenticated',arguments);}d=this.get('connection');a=d.constructStanza('available');a.set('msgID',e);a.set('show',b);a.set('from',this.get('connectedJID').asString());a.set('priority','5');if(TP.notEmpty(c)){a.set('status',c);}this.set('lastStanza',a);if(TP.isTrue(this.get('autosend'))){a.send();}return a;});TP.core.XMPPService.Inst.defineMethod('subscribeTo',function(d,b){var c,a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidJID',arguments);}if(!this.hasAuthConnection()){return this.raise('TP.sig.XMPPConnectionNotAuthenticated',arguments);}c=this.get('connection');a=c.constructStanza('subscribe');a.set('msgID',d);a.set('from',this.get('connectedJID').asString());a.set('to',b.asString());this.set('lastStanza',a);if(TP.isTrue(this.get('autosend'))){a.send();}return a;});TP.core.XMPPService.Inst.defineMethod('unsubscribeFrom',function(d,b){var c,a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidJID',arguments);}if(!this.hasAuthConnection()){return this.raise('TP.sig.XMPPConnectionNotAuthenticated',arguments);}c=this.get('connection');a=c.constructStanza('unsubscribe');a.set('msgID',d);a.set('from',this.get('connectedJID').asString());a.set('to',b.asString());this.set('lastStanza',a);if(TP.isTrue(this.get('autosend'))){a.send();}return a;});TP.core.XMPPService.Inst.defineMethod('constructPubsubNode',function(j,m,i,l,k){var g,e,f,h,a,d,c,b;if(TP.isEmpty(i)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!this.hasAuthConnection()){return this.raise('TP.sig.XMPPConnectionNotAuthenticated',arguments);}g=TP.ifEmpty(m,this.get('pubsubJID'));e=TP.ifInvalid(l,TP.xmpp.Pubsub.OPEN);f=TP.ifInvalid(k,TP.xmpp.Pubsub.OPEN);h=this.get('connection');a=h.constructStanza('set');a.set('msgID',j);a.set('from',this.get('connectedJID').asString());a.set('to',g.asString());d=TP.xmpp.PubsubCreate.construct();d.set('nodeID',i);if(e!==TP.xmpp.Pubsub.OPEN||f!==TP.xmpp.Pubsub.PUBLISHERS){c=TP.xmpp.XData.construct();c.set('formType',TP.xmpp.XData.SUBMIT);b=TP.xmpp.XDataField.construct().set('name','FORM_TYPE').set('type',TP.xmpp.XDataField.HIDDEN).addValue(TP.xmpp.XMLNS.PUBSUB_NODE_CONFIG);c.addFormItem(b);b=TP.xmpp.XDataField.construct().set('name','pubsub#access_model').addValue(e);c.addFormItem(b);b=TP.xmpp.XDataField.construct().set('name','pubsub#publish_model').addValue(f);c.addFormItem(b);d.set('configure',c);}a.addPayload(d);this.set('lastStanza',a);if(TP.isTrue(this.get('autosend'))){a.send();}return a;});TP.core.XMPPService.Inst.defineMethod('deletePubsubNode',function(f,g,c){var d,e,a,b;if(TP.isEmpty(c)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!this.hasAuthConnection()){return this.raise('TP.sig.XMPPConnectionNotAuthenticated',arguments);}d=TP.ifEmpty(g,this.get('pubsubJID'));e=this.get('connection');a=e.constructStanza('set');a.set('msgID',f);a.set('from',this.get('connectedJID').asString());a.set('to',d.asString());b=TP.xmpp.PubsubDelete.construct();b.set('nodeID',c);a.addPayload(b);this.set('lastStanza',a);if(TP.isTrue(this.get('autosend'))){a.send();}return a;});TP.core.XMPPService.Inst.defineMethod('publishToPubsubNode',function(k,m,h,i,l){var g,j,a,c,e,f,b,d;if(TP.isEmpty(h)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!TP.isNode(i)){return this.raise('TP.sig.InvalidNode',arguments);}if(!this.hasAuthConnection()){return this.raise('TP.sig.XMPPConnectionNotAuthenticated',arguments);}g=TP.ifEmpty(m,this.get('pubsubJID'));f=TP.ifInvalid(l,TP.xmpp.Pubsub.OPEN);j=this.get('connection');a=j.constructStanza('set');a.set('msgID',k);a.set('from',this.get('connectedJID').asString());a.set('to',g.asString());c=TP.xmpp.PubsubPublish.construct();c.set('nodeID',h);if(f!==TP.xmpp.Pubsub.OPEN){b=TP.xmpp.XData.construct();b.set('formType',TP.xmpp.XData.SUBMIT);d=TP.xmpp.XDataField.construct().set('name','FORM_TYPE').set('type',TP.xmpp.XDataField.HIDDEN).addValue(TP.xmpp.XMLNS.PUBSUB_PUBLISH_OPTIONS);b.addFormItem(d);d=TP.xmpp.XDataField.construct().set('name','pubsub#access_model').addValue(f);b.addFormItem(d);c.set('configure',b);}if(TP.isXMLDocument(e=i)){e=e.documentElement;}c.addItem(e);a.addPayload(c);this.set('lastStanza',a);if(TP.isTrue(this.get('autosend'))){a.send();}return a;});TP.core.XMPPService.Inst.defineMethod('retractFromPubsubNode',function(g,h,c,d){var e,f,a,b;if(TP.isEmpty(c)||TP.isEmpty(d)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!this.hasAuthConnection()){return this.raise('TP.sig.XMPPConnectionNotAuthenticated',arguments);}e=TP.ifEmpty(h,this.get('pubsubJID'));f=this.get('connection');a=f.constructStanza('set');a.set('msgID',g);a.set('from',this.get('connectedJID').asString());a.set('to',e.asString());b=TP.xmpp.PubsubRetract.construct();b.set('nodeID',c);b.addItem(d);a.addPayload(b);this.set('lastStanza',a);if(TP.isTrue(this.get('autosend'))){a.send();}return a;});TP.core.XMPPService.Inst.defineMethod('retrievePubsubSubscriptions',function(e,f){var b,c,a,d;if(!this.hasAuthConnection()){return this.raise('TP.sig.XMPPConnectionNotAuthenticated',arguments);}b=TP.ifEmpty(f,this.get('pubsubJID'));c=this.get('connection');a=c.constructStanza('get');a.set('msgID',e);a.set('from',this.get('connectedJID').asString());a.set('to',b.asString());d=TP.xmpp.PubsubSubscriptions.construct();a.addPayload(d);this.set('lastStanza',a);if(TP.isTrue(this.get('autosend'))){a.send();}return a;});TP.core.XMPPService.Inst.defineMethod('setPubsubName',function(a){if(TP.isEmpty(a)){return this.raise('TP.sig.InvalidParameter',arguments);}this.$set('pubsubName',a);this.set('pubsubJID',TP.jid(a+'.'+this.get('serverName')));return this;});TP.core.XMPPService.Inst.defineMethod('subscribeToPubsubNode',function(f,g,c){var d,e,a,b;if(TP.isEmpty(c)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!this.hasAuthConnection()){return this.raise('TP.sig.XMPPConnectionNotAuthenticated',arguments);}d=TP.ifEmpty(g,this.get('pubsubJID'));e=this.get('connection');a=e.constructStanza('set');a.set('msgID',f);a.set('from',this.get('connectedJID').asString());a.set('to',d.asString());b=TP.xmpp.PubsubSubscribe.construct();b.set('nodeID',c);b.set('subscriberJID',this.get('connectedJID'));a.addPayload(b);this.set('lastStanza',a);if(TP.isTrue(this.get('autosend'))){a.send();}return a;});TP.core.XMPPService.Inst.defineMethod('unsubscribeFromPubsubNode',function(f,g,c){var d,e,a,b;if(TP.isEmpty(c)){return this.raise('TP.sig.InvalidParameter',arguments);}if(!this.hasAuthConnection()){return this.raise('TP.sig.XMPPConnectionNotAuthenticated',arguments);}d=TP.ifEmpty(g,this.get('pubsubJID'));e=this.get('connection');a=e.constructStanza('set');a.set('msgID',f);a.set('from',this.get('connectedJID').asString());a.set('to',d.asString());b=TP.xmpp.PubsubUnsubscribe.construct();b.set('nodeID',c);b.set('subscriberJID',this.get('connectedJID'));a.addPayload(b);this.set('lastStanza',a);if(TP.isTrue(this.get('autosend'))){a.send();}return a;});TP.core.XMPPService.Inst.defineMethod('openAndAuthConnectionFrom',function(a){if(this.openConnection()){if(this.authenticateConnection(a.at('connectionJID'),a.at('connectionPassword'))){return true;}a.fail(TP.FAILURE,'Can\'t authenticate connection');return false;}a.fail(TP.FAILURE,'Can\'t open connection');return false;});TP.core.XMPPService.Inst.defineMethod('handleXMPPConnectionException',function(a){this.ignore(this.get('connection'),'TP.sig.XMPPConnectionReady');this.ignore(this.get('connection'),'TP.sig.XMPPConnectionException');this.set('connection',null);return this;});TP.core.XMPPService.Inst.defineMethod('handleXMPPConnectionReady',function(c){var a,b;if(TP.notEmpty(a=this.get('requestQueue'))){if(TP.isValid(b=a.shift())){this.processTP_sig_XMPPRequest(b);}}return this;});TP.core.XMPPService.Inst.defineMethod('handleXMPPPubsubInput',function(b){var c,d,e,a;if(b.getOrigin()!==this.getID()){this.ignore(b.getOrigin(),b.getSignalName());}c=TP.core.User.getEffectiveUser();d=c.get('remoteSubscriptions');if(TP.isValid(e=b.getPayload().at('node'))){if(TP.notEmpty(a=e.evaluateXPath('//$def:subscription/@node',TP.NODESET))){a.convert(function(a){return a.value.strip(/^\//);});}else{a=TP.ac();}}else{a=TP.ac();}d.atPut(this.get('pubsubJID').asString(),a);return this;});TP.core.XMPPService.Inst.defineMethod('handleXMPPRequest',function(b){var a;a=TP.request(b);a.stopPropagation();a.atPut('async',this.rewriteRequestMode(a));if(!this.hasAuthConnection()){this.get('requestQueue').push(a);if(this.openAndAuthConnectionFrom(a)){this.setupCurrentUser();}else{this.set('requestQueue',null);}}else if(this.get('connection').isBusy()){this.get('requestQueue').push(a);}else{this.processTP_sig_XMPPRequest(a);}return this;});TP.core.XMPPService.Inst.defineMethod('processTP_sig_XMPPRequest',function(a){var f,d,b,e,c;f=this.get('autosend');this.set('autosend',false);d=false;b=a.getRequestID();switch(a.at('action')){case'command':d=true;c=this.sendCommand(b,a.at('toJID'),a.at('cmd_action'),TP.elem(a.at('node')));break;case'connect':break;case'message':c=this.sendMessage(b,a.at('toJID'),a.at('body'),a.at('subject'),a.at('thread'),a.at('type'));break;case'pubsub':d=true;switch(a.at('pubsub_action')){case'create':c=this.constructPubsubNode(b,a.at('pubsubServiceJID'),a.at('nodeID'),a.at('subAccessModel'),a.at('pubAccessModel'));break;case'subscribe':c=this.subscribeToPubsubNode(b,a.at('pubsubServiceJID'),a.at('nodeID'));break;case'unsubscribe':c=this.unsubscribeFromPubsubNode(b,a.at('pubsubServiceJID'),a.at('nodeID'));break;case'subscriptions':c=this.retrievePubsubSubscriptions(b,a.at('pubsubServiceJID'));break;case'publish':c=this.publishToPubsubNode(b,a.at('pubsubServiceJID'),a.at('nodeID'),a.at('payload'),a.at('subAccessModel'));break;case'retract':c=this.retractFromPubsubNode(b,a.at('pubsubServiceJID'),a.at('nodeID'),a.at('itemID'));break;case'delete':c=this.deletePubsubNode(b,a.at('pubsubServiceJID'),a.at('nodeID'));break;default:a.fail(TP.FAILURE,'Unrecognized pubsub action');return this;}break;case'remove':d=true;c=this.removeFromRoster(b,a.at('toJID'),a.at('name'));break;case'roster':d=true;c=this.addToRoster(b,a.at('toJID'),a.at('name'),a.at('group'));break;case'subscribe':c=this.subscribeTo(b,a.at('toJID'));break;case'unsubscribe':c=this.unsubscribeFrom(b,a.at('toJID'));break;case'presence':c=this.setPresence(b,a.at('show'),a.at('status'));break;default:a.fail(TP.FAILURE,'Unrecognized action');return this;}if(d){e=function(d){var c;this.ignore(b,'TP.sig.XMPPInput',e);if(TP.isValid(c=d.getPayload().at('node'))){a.set('result',c);if(!a.didComplete()){if(c.isError()){a.fail();}else{a.complete();}}}else{if(!a.didComplete()){a.complete();}}}.bind(this);this.observe(b,'TP.sig.XMPPInput',e);}else{if(!a.didComplete()){a.complete();}}if(TP.isValid(c)){c.send();}this.set('autosend',f);return this;});
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIq.js';
TP.xmpp.Stanza.defineSubtype('Iq');TP.xmpp.Iq.Type.defineAttribute('stanzaTypes',TP.ac('get','set','result','error'));TP.xmpp.Iq.Type.defineAttribute('tagname','iq');TP.xmpp.Iq.Type.defineAttribute('template','<iq></iq>');TP.xmpp.Iq.register();TP.xmpp.Iq.Inst.defineMethod('addQuery',function(b){var a;a=TP.xmpp.Query.construct(null,b);this.addPayload(a);return this;});TP.xmpp.Iq.Inst.defineMethod('constructResponse',function(){var a,b;if(this.get('tagType')==='get'||this.get('tagType')==='set'){a=this.getType().construct(null,'result',this.get('from'));}else{return;}if(TP.isValid(b=this.getPayload('query'))&&b.getSize()>0){a.addQuery(this.getNamespaceURI());}return a;});TP.xmpp.Iq.Inst.defineMethod('getDefaultType',function(){return'get';});TP.xmpp.Iq.Inst.defineMethod('getSignalName',function(b){var a;a=this.get('payload');if(TP.isValid(a)&&a.getSize()===1){return a.at(0).getSignalName(this);}return this.callNextMethod();});
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqPayload.js';
TP.xmpp.Payload.defineSubtype('IqPayload');TP.xmpp.IqPayload.Type.defineAttribute('tagname','query');
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqRosterItem.js';
TP.xmpp.Node.defineSubtype('IqRosterItem');TP.xmpp.IqRosterItem.set('namespace',TP.xmpp.XMLNS.IQ_ROSTER);TP.xmpp.IqRosterItem.set('tagname','item');TP.xmpp.IqRosterItem.set('template','<item jid="" subscription=""></item>');TP.xmpp.IqRosterItem.register();TP.xmpp.IqRosterItem.Inst.defineMethod('getGroupNames',function(){var a;a=this.getElementsByTagName('group');return a.collect(function(a){return a.getTextContent();});});TP.xmpp.IqRosterItem.Inst.defineMethod('getJid',function(){return TP.xmpp.JID.construct(this.getAttribute('jid'));});TP.xmpp.IqRosterItem.Inst.defineMethod('getNickname',function(){return this.getAttribute('name');});TP.xmpp.IqRosterItem.Inst.defineMethod('getSubscription',function(){return this.getAttribute('subscription');});TP.xmpp.IqRosterItem.Inst.defineMethod('isPending',function(){var a;a=this.getAttribute('ask');return TP.isValid(a)&&a!=='';});
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqGet.js';
TP.xmpp.Iq.defineSubtype('IqGet');TP.xmpp.XMLNS.defineStanzaType('get',TP.xmpp.IqGet);TP.xmpp.IqGet.set('template','<iq type="get"></iq>');TP.xmpp.IqGet.Inst.defineMethod('expectsResponse',function(){return true;});
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqResult.js';
TP.xmpp.Iq.defineSubtype('IqResult');TP.xmpp.XMLNS.defineStanzaType('result',TP.xmpp.IqResult);TP.xmpp.IqResult.set('template','<iq type="result"></iq>');
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqSet.js';
TP.xmpp.Iq.defineSubtype('IqSet');TP.xmpp.XMLNS.defineStanzaType('set',TP.xmpp.IqSet);TP.xmpp.IqSet.set('template','<iq type="set"></iq>');TP.xmpp.IqSet.Inst.defineMethod('expectsResponse',function(){return true;});TP.xmpp.IqSet.Inst.defineMethod('getSignalName',function(a){if(this.isSignal()){return'TP.sig.XMPPSignalInput';}return this.callNextMethod();});TP.xmpp.IqSet.Inst.defineMethod('isSignal',function(){var a;if(TP.notValid(a=this.getPayload('query',TP.xmpp.XMLNS.TIBET_SIGNAL))){return false;}if(TP.isValid(a.at(0))){return true;}return false;});
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqAgent.js';
TP.xmpp.IqPayload.defineSubtype('IqAgent');TP.xmpp.IqAgent.set('namespace',TP.xmpp.XMLNS.IQ_AGENT);TP.xmpp.IqAgent.set('childTags',TP.ac('name','description','transport','url','service','register','search'));TP.xmpp.IqAgent.register();TP.xmpp.IqAgent.Inst.defineMethod('getJID',function(){return this.getAttribute('jid');});
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqAgents.js';
TP.xmpp.IqPayload.defineSubtype('IqAgents');TP.xmpp.IqAgents.set('namespace',TP.xmpp.XMLNS.IQ_AGENTS);TP.xmpp.IqAgents.set('childTags',TP.ac('agent'));TP.xmpp.IqAgents.register();TP.xmpp.IqAgents.Inst.defineMethod('getAgents',function(){return this.getElementsByTagName('agent');});
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqAuth.js';
TP.xmpp.IqPayload.defineSubtype('IqAuth');TP.xmpp.IqAuth.set('namespace',TP.xmpp.XMLNS.IQ_AUTH);TP.xmpp.IqAuth.set('childTags',TP.ac('digest','password','resource','username','hash','token','sequence'));TP.xmpp.IqAuth.register();
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqAutoupdate.js';
TP.xmpp.IqPayload.defineSubtype('IqAutoupdate');TP.xmpp.IqAutoupdate.set('namespace',TP.xmpp.XMLNS.IQ_AUTOUPDATE);TP.xmpp.IqAutoupdate.set('childTags',TP.ac('release'));TP.xmpp.IqAutoupdate.register();TP.xmpp.IqAutoupdate.Inst.defineMethod('getReleaseDescription',function(){var a;if(TP.notValid(a=this.getElementsByTagName('release').first())){return null;}return a.getChildTextContent('desc');});TP.xmpp.IqAutoupdate.Inst.defineMethod('getReleasePriority',function(){var a;if(TP.notValid(a=this.getElementsByTagName('release').first())){return null;}return a.getAttribute('priority');});TP.xmpp.IqAutoupdate.Inst.defineMethod('getReleaseURL',function(){var a;if(TP.notValid(a=this.getElementsByTagName('release').first())){return null;}return TP.uc(a.getChildTextContent('url'));});TP.xmpp.IqAutoupdate.Inst.defineMethod('getReleaseVersion',function(){var a;if(TP.notValid(a=this.getElementsByTagName('release').first())){return null;}return a.getChildTextContent('version');});
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqBrowse.js';
TP.xmpp.IqPayload.defineSubtype('IqBrowse');TP.xmpp.IqBrowse.Type.defineAttribute('categories');TP.xmpp.IqBrowse.set('namespace',TP.xmpp.XMLNS.IQ_BROWSE);TP.xmpp.IqBrowse.set('categories',TP.ac('application','conference','headline','item','keyword','render','service','user'));TP.xmpp.IqBrowse.register();
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqConference.js';
TP.xmpp.IqPayload.defineSubtype('IqConference');TP.xmpp.IqConference.set('namespace',TP.xmpp.XMLNS.IQ_CONFERENCE);TP.xmpp.IqConference.set('childTags',TP.ac('nick','secret','name','privacy','id'));TP.xmpp.IqConference.register();TP.xmpp.IqConference.Inst.defineMethod('getConferenceID',function(){return this.getChildTextContent('id');});TP.xmpp.IqConference.Inst.defineMethod('shouldHideJID',function(a){var b;if(TP.isBoolean(a)){if(a){this.getNamedDescendant('privacy',true);}else{if(TP.isValid(b=this.getNamedDescendant('privacy'))){TP.nodeDetach(b);}}}return TP.isValid(this.getNamedDescendant('privacy'));});
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqGateway.js';
TP.xmpp.IqPayload.defineSubtype('IqGateway');TP.xmpp.IqGateway.set('namespace',TP.xmpp.XMLNS.IQ_GATEWAY);TP.xmpp.IqGateway.set('childTags',TP.ac('desc','prompt','jid'));TP.xmpp.IqGateway.register();
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqLast.js';
TP.xmpp.IqPayload.defineSubtype('IqLast');TP.xmpp.IqLast.set('namespace',TP.xmpp.XMLNS.IQ_LAST);TP.xmpp.IqLast.register();
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqOOB.js';
TP.xmpp.IqPayload.defineSubtype('IqOOB');TP.xmpp.IqOOB.set('namespace',TP.xmpp.XMLNS.IQ_OOB);TP.xmpp.IqOOB.set('childTags',TP.ac('desc','url'));TP.xmpp.IqOOB.register();
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqPass.js';
TP.xmpp.IqPayload.defineSubtype('IqPass');TP.xmpp.IqPass.set('namespace',TP.xmpp.XMLNS.IQ_PASS);TP.xmpp.IqPass.set('childTags',TP.ac('expire','server','client','proxy'));TP.xmpp.IqPass.register();
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqPrivate.js';
TP.xmpp.IqPayload.defineSubtype('IqPrivate');TP.xmpp.IqPrivate.set('namespace',TP.xmpp.XMLNS.IQ_PRIVATE);TP.xmpp.IqPrivate.register();TP.xmpp.IqPrivate.Inst.defineMethod('getData',function(){var a;a=this.getNativeNode();return a.firstChild;});TP.xmpp.IqPrivate.Inst.defineMethod('setData',function(a){var b,c;if(!TP.isNode(a)){return this.raise('TP.sig.InvalidNode',arguments);}c=a;b=this.getNativeNode();TP.nodeAppendChild(b,c);return this;});
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqRPC.js';
TP.xmpp.IqPayload.defineSubtype('IqRPC');TP.xmpp.IqRPC.set('namespace',TP.xmpp.XMLNS.IQ_RPC);TP.xmpp.IqRPC.set('childTags',TP.ac('methodCall','methodResponse'));TP.xmpp.IqRPC.register();
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqRegister.js';
TP.xmpp.IqPayload.defineSubtype('IqRegister');TP.xmpp.IqRegister.set('namespace',TP.xmpp.XMLNS.IQ_REGISTER);TP.xmpp.IqRegister.set('childTags',TP.ac('instructions','username','password','hash','token','sequence','name','first','last','email','address','city','state','zip','phone','url','date','misc','text','remove'));TP.xmpp.IqRegister.register();TP.xmpp.IqRegister.Inst.defineMethod('handleArrival',function(a){return this.callNextMethod();});
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqRoster.js';
TP.xmpp.IqPayload.defineSubtype('IqRoster');TP.xmpp.IqRoster.set('namespace',TP.xmpp.XMLNS.IQ_ROSTER);TP.xmpp.IqRoster.set('childTags',TP.ac('item'));TP.xmpp.IqRoster.register();TP.xmpp.IqRoster.Inst.defineMethod('getGroupItems',function(b){var a;if(TP.notValid(b)){return this.raise('TP.sig.InvalidParameter',arguments);}a=this.getElementsByTagName('item');a=a.select(function(d){var a,c;c=d.getElementsByTagName('group');for(a=0;a<c.getSize();a++){if(c.at(a).getTextContent()===b){return true;}}return false;});});TP.xmpp.IqRoster.Inst.defineMethod('getGroupNames',function(){var a;a=this.getElementsByTagName('group');a.unique();return a.collect(function(a){return a.getTextContent();});});TP.xmpp.IqRoster.Inst.defineMethod('getItems',function(){return this.getElementsByTagName('item');});TP.xmpp.IqRoster.Inst.defineMethod('getSignalName',function(a){return'TP.sig.XMPPRosterInput';});
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqSearch.js';
TP.xmpp.IqPayload.defineSubtype('IqSearch');TP.xmpp.IqSearch.set('namespace',TP.xmpp.XMLNS.IQ_SEARCH);TP.xmpp.IqSearch.set('childTags',TP.ac('instructions','key','item','name','first','last','email','address','city','state','zip','phone','url','date','misc','text'));TP.xmpp.IqSearch.register();
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqTime.js';
TP.xmpp.IqPayload.defineSubtype('IqTime');TP.xmpp.IqTime.set('namespace',TP.xmpp.XMLNS.IQ_TIME);TP.xmpp.IqTime.set('childTags',TP.ac('utc','tz','display'));TP.xmpp.IqTime.register();
TP.boot.$srcPath = '~lib_src/xmpp/iq/XMPPIqVersion.js';
TP.xmpp.IqPayload.defineSubtype('IqVersion');TP.xmpp.IqVersion.set('namespace',TP.xmpp.XMLNS.IQ_VERSION);TP.xmpp.IqVersion.set('childTags',TP.ac('name','version','os'));TP.xmpp.IqVersion.register();
TP.boot.$srcPath = '~lib_src/xmpp/x/XMPPXHTML.js';
TP.xmpp.Payload.defineSubtype('XHTML');TP.xmpp.XHTML.set('namespace',TP.xmpp.XMLNS.XHTML);TP.xmpp.XHTML.set('tagname','html');TP.xmpp.XHTML.register();
TP.boot.$srcPath = '~lib_src/xmpp/x/XMPPXPayload.js';
TP.xmpp.Payload.defineSubtype('XPayload');TP.xmpp.XPayload.Type.defineAttribute('tagname','x');
TP.boot.$srcPath = '~lib_src/xmpp/x/XMPPXAutoupdate.js';
TP.xmpp.XPayload.defineSubtype('XAutoupdate');TP.xmpp.XAutoupdate.set('namespace',TP.xmpp.XMLNS.X_AUTOUPDATE);TP.xmpp.XAutoupdate.register();
TP.boot.$srcPath = '~lib_src/xmpp/x/XMPPXConference.js';
TP.xmpp.XPayload.defineSubtype('XConference');TP.xmpp.XConference.set('namespace',TP.xmpp.XMLNS.X_CONFERENCE);TP.xmpp.XConference.register();
TP.boot.$srcPath = '~lib_src/xmpp/x/XMPPXData.js';
TP.xmpp.XPayload.defineSubtype('XData');TP.xmpp.XData.Type.defineConstant('FORM','form');TP.xmpp.XData.Type.defineConstant('SUBMIT','submit');TP.xmpp.XData.Type.defineConstant('CANCEL','cancel');TP.xmpp.XData.Type.defineConstant('RESULT','result');TP.xmpp.XData.set('namespace',TP.xmpp.XMLNS.SASL);TP.xmpp.XData.set('childTags',TP.ac('title','instructions','field'));TP.xmpp.XData.register();TP.xmpp.XData.Inst.defineMethod('addFormItem',function(a){if(!TP.isKindOf(a,TP.xmpp.XDataField)){return this.raise('TP.sig.InvalidXMPPXDataField',arguments,a);}TP.nodeAppendChild(this.getNativeNode(),TP.nodeCloneNode(a.getNativeNode(),true));return this;});TP.xmpp.XData.Inst.defineMethod('setFormType',function(a){this.setAttribute('type',a);return this;});
TP.boot.$srcPath = '~lib_src/xmpp/x/XMPPXDataField.js';
TP.xmpp.XPayload.defineSubtype('XDataField');TP.xmpp.XDataField.Type.defineConstant('BOOLEAN','boolean');TP.xmpp.XDataField.Type.defineConstant('FIXED','fixed');TP.xmpp.XDataField.Type.defineConstant('HIDDEN','hidden');TP.xmpp.XDataField.Type.defineConstant('JID-MULTI','jid-multi');TP.xmpp.XDataField.Type.defineConstant('JID-SINGLE','jid-single');TP.xmpp.XDataField.Type.defineConstant('LIST-MULTI','list-multi');TP.xmpp.XDataField.Type.defineConstant('LIST-SINGLE','list-single');TP.xmpp.XDataField.Type.defineConstant('TEXT-MULTI','text-multi');TP.xmpp.XDataField.Type.defineConstant('TEXT-PRIVATE','text-private');TP.xmpp.XDataField.Type.defineConstant('TEXT-SINGLE','text-single');TP.xmpp.XDataField.set('namespace',TP.xmpp.XMLNS.X_DATA);TP.xmpp.XDataField.set('tagname','field');TP.xmpp.XDataField.set('childTags',TP.ac('desc','required'));TP.xmpp.XDataField.register();TP.xmpp.XDataField.Inst.defineMethod('addValue',function(b){var a;a=TP.elementFromString(TP.join('<value xmlns="',TP.xmpp.XMLNS.X_DATA,'">',b,'</value>'));TP.nodeAppendChild(this.getNativeNode(),a);return this;});TP.xmpp.XDataField.Inst.defineMethod('addOption',function(b){var a;a=TP.elementFromString(TP.join('<option xmlns="',TP.xmpp.XMLNS.X_DATA,'">','<value>',b,'</value>','</option>'));TP.nodeAppendChild(this.getNativeNode(),a);return this;});TP.xmpp.XDataField.Inst.defineMethod('setLabel',function(a){this.setAttribute('label',a);return this;});TP.xmpp.XDataField.Inst.defineMethod('setName',function(a){this.setAttribute('var',a);return this;});TP.xmpp.XDataField.Inst.defineMethod('setRequired',function(b){var a;if(b){if(TP.notValid(a=TP.unwrap(this.getElementsByTagName('required').first()))){a=TP.documentCreateElement(this.getNativeDocument(),'required',TP.xmpp.XMLNS.X_DATA);TP.nodeAppendChild(this.getNativeNode(),a);}}else{if(TP.isElement(a=TP.unwrap(this.getElementsByTagName('required').first()))){TP.nodeDetach(a);}}return this;});TP.xmpp.XDataField.Inst.defineMethod('setType',function(a){this.setAttribute('type',a);return this;});
TP.boot.$srcPath = '~lib_src/xmpp/x/XMPPXDelay.js';
TP.xmpp.XPayload.defineSubtype('XDelay');TP.xmpp.XDelay.set('namespace',TP.xmpp.XMLNS.X_DELAY);TP.xmpp.XDelay.register();
TP.boot.$srcPath = '~lib_src/xmpp/x/XMPPXEncrypted.js';
TP.xmpp.XPayload.defineSubtype('XEncrypted');TP.xmpp.XEncrypted.set('namespace',TP.xmpp.XMLNS.X_ENCRYPTED);TP.xmpp.XEncrypted.register();
TP.boot.$srcPath = '~lib_src/xmpp/x/XMPPXEnvelope.js';
TP.xmpp.XPayload.defineSubtype('XEnvelope');TP.xmpp.XEnvelope.set('namespace',TP.xmpp.XMLNS.X_ENVELOPE);TP.xmpp.XEnvelope.set('childTags',TP.ac('forwardedby','from','to','cc','replyto'));TP.xmpp.XEnvelope.register();
TP.boot.$srcPath = '~lib_src/xmpp/x/XMPPXEvent.js';
TP.xmpp.XPayload.defineSubtype('XEvent');TP.xmpp.XEvent.set('namespace',TP.xmpp.XMLNS.X_EVENT);TP.xmpp.XEvent.set('childTags',TP.ac('id','offline','delivered','displayed','composing'));TP.xmpp.XEvent.register();TP.xmpp.XEvent.Inst.defineMethod('getEventMsgID',function(){return this.getChildTextContent('id');});
TP.boot.$srcPath = '~lib_src/xmpp/x/XMPPXExpire.js';
TP.xmpp.XPayload.defineSubtype('XExpire');TP.xmpp.XExpire.set('namespace',TP.xmpp.XMLNS.X_EXPIRE);TP.xmpp.XExpire.register();
TP.boot.$srcPath = '~lib_src/xmpp/x/XMPPXOOB.js';
TP.xmpp.XPayload.defineSubtype('XOOB');TP.xmpp.XOOB.set('namespace',TP.xmpp.XMLNS.X_OOB);TP.xmpp.XOOB.set('childTags',TP.ac('url','desc'));TP.xmpp.XOOB.register();
TP.boot.$srcPath = '~lib_src/xmpp/x/XMPPXRoster.js';
TP.xmpp.XPayload.defineSubtype('XRoster');TP.xmpp.XRoster.set('namespace',TP.xmpp.XMLNS.X_ROSTER);TP.xmpp.XRoster.set('childTags',TP.ac('item'));TP.xmpp.XRoster.register();
TP.boot.$srcPath = '~lib_src/xmpp/x/XMPPXSXPM.js';
TP.xmpp.XPayload.defineSubtype('XSXPM');TP.xmpp.XSXPM.set('namespace',TP.xmpp.XMLNS.X_SXPM);TP.xmpp.XSXPM.set('childTags',TP.ac('board','map','data','cursor'));TP.xmpp.XSXPM.register();
TP.boot.$srcPath = '~lib_src/xmpp/x/XMPPXSigned.js';
TP.xmpp.XPayload.defineSubtype('XSigned');TP.xmpp.XSigned.set('namespace',TP.xmpp.XMLNS.X_SIGNED);TP.xmpp.XSigned.register();
TP.boot.$srcPath = '~lib_src/xmpp/pubsub/XMPPPubsub.js';
TP.xmpp.Payload.defineSubtype('Pubsub');TP.xmpp.Pubsub.isAbstract(true);TP.xmpp.Pubsub.Type.defineConstant('OPEN','open');TP.xmpp.Pubsub.Type.defineConstant('PRESENCE','presence');TP.xmpp.Pubsub.Type.defineConstant('ROSTER','roster');TP.xmpp.Pubsub.Type.defineConstant('AUTHORIZE','authorize');TP.xmpp.Pubsub.Type.defineConstant('WHITELIST','whitelist');TP.xmpp.Pubsub.Type.defineConstant('PUBLISHERS','publishers');TP.xmpp.Pubsub.Type.defineConstant('SUBSCRIBERS','subscribers');TP.xmpp.Pubsub.Type.defineAttribute('pubsubTypeRegistry',TP.hc());TP.xmpp.Pubsub.Type.defineAttribute('namespace',TP.xmpp.XMLNS.PUBSUB);TP.xmpp.Pubsub.register();TP.xmpp.Pubsub.Type.defineMethod('getConcreteType',function(b){var a;if(!TP.isNode(b)){return this.raise('TP.sig.InvalidNode',arguments,'No node provided.');}a=this.get('pubsubTypeRegistry').detect(function(a){if(TP.isValid(TP.nodeEvaluateXPath(b,a.first(),TP.FIRST_NODE))){return true;}return false;});if(TP.isPair(a)){return a.last();}return TP.core.XMLElementNode;});TP.xmpp.Pubsub.Type.defineMethod('registerPubsubType',function(a,b,c){this.get('pubsubTypeRegistry').atPut(b,c);TP.xmpp.XMLNS.defineNodeType('pubsub',TP.xmpp.Pubsub,a);return this;});
TP.boot.$srcPath = '~lib_src/xmpp/pubsub/XMPPPubsubPubsub.js';
TP.xmpp.Pubsub.defineSubtype('PubsubPubsub');TP.xmpp.PubsubPubsub.set('namespace',TP.xmpp.XMLNS.PUBSUB);TP.xmpp.PubsubPubsub.set('tagname','pubsub');TP.xmpp.PubsubPubsub.set('childTags',TP.ac('create','configure','subscribe','options','affiliations','items','publish','retract','subscription','subscriptions','unsubscribe'));TP.xmpp.PubsubPubsub.register();
TP.boot.$srcPath = '~lib_src/xmpp/pubsub/XMPPPubsubCreate.js';
TP.xmpp.Pubsub.defineSubtype('PubsubCreate');TP.xmpp.PubsubCreate.set('template',TP.join('<pubsub xmlns="',TP.xmpp.XMLNS.PUBSUB,'">','<create node=""/>','<configure/>','</pubsub>'));TP.xmpp.Pubsub.registerPubsubType(TP.xmpp.XMLNS.PUBSUB,'./$def:create',TP.xmpp.PubsubCreate);TP.xmpp.PubsubCreate.Inst.defineMethod('setConfigure',function(a){var b;if(!TP.isKindOf(a,TP.xmpp.XData)){return this.raise('TP.sig.InvalidXMPPXData',arguments,a);}b=this.getNamedDescendant('configure',true);TP.nodeAppendChild(b,TP.nodeCloneNode(a.getNativeNode(),true));return this;});TP.xmpp.PubsubCreate.Inst.defineMethod('setNodeID',function(b){var a;a=this.getNamedDescendant('create',true);TP.elementSetAttribute(a,'node',b);return this;});
TP.boot.$srcPath = '~lib_src/xmpp/pubsub/XMPPPubsubDelete.js';
TP.xmpp.Pubsub.defineSubtype('PubsubDelete');TP.xmpp.PubsubDelete.set('template',TP.join('<pubsub xmlns="',TP.xmpp.XMLNS.PUBSUB_OWNER,'">','<delete node=""/>','</pubsub>'));TP.xmpp.Pubsub.registerPubsubType(TP.xmpp.XMLNS.PUBSUB_OWNER,'./$def:delete',TP.xmpp.PubsubDelete);TP.xmpp.PubsubDelete.Inst.defineMethod('setNodeID',function(b){var a;a=this.getNamedDescendant('delete',true);TP.elementSetAttribute(a,'node',b);return this;});
TP.boot.$srcPath = '~lib_src/xmpp/pubsub/XMPPPubsubPublish.js';
TP.xmpp.Pubsub.defineSubtype('PubsubPublish');TP.xmpp.PubsubPublish.set('template',TP.join('<pubsub xmlns="',TP.xmpp.XMLNS.PUBSUB,'">','<publish node=""/>','</pubsub>'));TP.xmpp.PubsubPublish.set('childTags',TP.ac('item'));TP.xmpp.Pubsub.registerPubsubType(TP.xmpp.XMLNS.PUBSUB,'./$def:publish',TP.xmpp.PubsubPublish);TP.xmpp.PubsubPublish.Inst.defineMethod('addItem',function(d,b){var a,c;a=TP.node('<item xmlns="'+TP.xmpp.XMLNS.PUBSUB+'"/>');if(TP.notEmpty(b)){TP.elementSetAttribute(a,'id',b);}TP.nodeAppendChild(a,TP.nodeCloneNode(d,true));c=this.getNamedDescendant('publish',true);TP.nodeAppendChild(c,a);return this;});TP.xmpp.PubsubPublish.Inst.defineMethod('setConfigure',function(a){var b;if(!TP.isKindOf(a,TP.xmpp.XData)){return this.raise('TP.sig.InvalidXMPPXData',arguments,a);}b=this.getNamedDescendant('configure',true);TP.nodeAppendChild(b,TP.nodeCloneNode(a.getNativeNode(),true));return this;});TP.xmpp.PubsubPublish.Inst.defineMethod('setNodeID',function(b){var a;a=this.getNamedDescendant('publish',true);TP.elementSetAttribute(a,'node',b);return this;});
TP.boot.$srcPath = '~lib_src/xmpp/pubsub/XMPPPubsubRetract.js';
TP.xmpp.Pubsub.defineSubtype('PubsubRetract');TP.xmpp.PubsubRetract.set('template',TP.join('<pubsub xmlns="',TP.xmpp.XMLNS.PUBSUB,'">','<retract node=""/>','</pubsub>'));TP.xmpp.PubsubRetract.set('childTags',TP.ac('item'));TP.xmpp.Pubsub.registerPubsubType(TP.xmpp.XMLNS.PUBSUB,'./$def:retract',TP.xmpp.PubsubRetract);TP.xmpp.PubsubRetract.Inst.defineMethod('addItem',function(b){var a,c;if(TP.isEmpty(b)){this.raise('TP.sig.InvalidParameter',arguments);}a=TP.node('<item xmlns="'+TP.xmpp.XMLNS.PUBSUB+'"/>');TP.elementSetAttribute(a,'id',b);c=this.getNamedDescendant('retract',true);TP.nodeAppendChild(c,a);return this;});TP.xmpp.PubsubRetract.Inst.defineMethod('setNodeID',function(b){var a;a=this.getNamedDescendant('retract',true);TP.elementSetAttribute(a,'node',b);return this;});
TP.boot.$srcPath = '~lib_src/xmpp/pubsub/XMPPPubsubSubscribe.js';
TP.xmpp.Pubsub.defineSubtype('PubsubSubscribe');TP.xmpp.PubsubSubscribe.set('template',TP.join('<pubsub xmlns="',TP.xmpp.XMLNS.PUBSUB,'">','<subscribe node=""/>','</pubsub>'));TP.xmpp.Pubsub.registerPubsubType(TP.xmpp.XMLNS.PUBSUB,'./$def:subscribe',TP.xmpp.PubsubSubscribe);TP.xmpp.PubsubSubscribe.Inst.defineMethod('setNodeID',function(b){var a;a=this.getNamedDescendant('subscribe',true);TP.elementSetAttribute(a,'node',b);return this;});TP.xmpp.PubsubSubscribe.Inst.defineMethod('setSubscriberJID',function(b){var a;a=this.getNamedDescendant('subscribe',true);TP.elementSetAttribute(a,'jid',b.get('bareJID'));return this;});
TP.boot.$srcPath = '~lib_src/xmpp/pubsub/XMPPPubsubUnsubscribe.js';
TP.xmpp.Pubsub.defineSubtype('PubsubUnsubscribe');TP.xmpp.PubsubUnsubscribe.set('template',TP.join('<pubsub xmlns="',TP.xmpp.XMLNS.PUBSUB,'">','<unsubscribe node=""/>','</pubsub>'));TP.xmpp.Pubsub.registerPubsubType(TP.xmpp.XMLNS.PUBSUB,'./$def:unsubscribe',TP.xmpp.PubsubUnsubscribe);TP.xmpp.PubsubUnsubscribe.Inst.defineMethod('setNodeID',function(b){var a;a=this.getNamedDescendant('unsubscribe',true);TP.elementSetAttribute(a,'node',b);return this;});TP.xmpp.PubsubUnsubscribe.Inst.defineMethod('setSubscriberJID',function(b){var a;a=this.getNamedDescendant('unsubscribe',true);TP.elementSetAttribute(a,'jid',b.get('bareJID'));return this;});
TP.boot.$srcPath = '~lib_src/xmpp/pubsub/XMPPPubsubEvent.js';
TP.xmpp.Pubsub.defineSubtype('PubsubEvent');TP.xmpp.PubsubEvent.set('namespace',TP.xmpp.XMLNS.PUBSUB_EVENT);TP.xmpp.PubsubEvent.set('tagname','event');TP.xmpp.PubsubEvent.set('childTags',TP.ac('collection','configuration','delete','items','purge','subscription'));TP.xmpp.PubsubEvent.register();TP.xmpp.PubsubEvent.Inst.defineMethod('getSignalName',function(a){return'TP.sig.XMPPPubsubEventInput';});TP.xmpp.PubsubEvent.Inst.defineMethod('getSignalOrigin',function(e){var b,c,a,d;if(TP.isEmpty(b=this.getElementsByTagName('items'))){return TP.NONE;}c=e.getAttribute('from');a=b.first().getAttribute('node');a=a.strip(/^\//);d=TP.join('xmpp:',c,'?;node=',a);return TP.uc(d);});
TP.boot.$srcPath = '~lib_src/xmpp/pubsub/XMPPPubsubSubscription.js';
TP.xmpp.Pubsub.defineSubtype('PubsubSubscription');TP.xmpp.PubsubSubscription.set('tagname','subscription');TP.xmpp.Pubsub.registerPubsubType(TP.xmpp.XMLNS.PUBSUB,'./$def:subscription',TP.xmpp.PubsubSubscription);TP.xmpp.PubsubSubscription.Inst.defineMethod('getJID',function(){return this.getAttribute('jid');});TP.xmpp.PubsubSubscription.Inst.defineMethod('getNode',function(){return this.getAttribute('node');});
TP.boot.$srcPath = '~lib_src/xmpp/pubsub/XMPPPubsubSubscriptions.js';
TP.xmpp.Pubsub.defineSubtype('PubsubSubscriptions');TP.xmpp.PubsubSubscriptions.set('template',TP.join('<pubsub xmlns="',TP.xmpp.XMLNS.PUBSUB,'">','<subscriptions/>','</pubsub>'));TP.xmpp.PubsubSubscriptions.set('childTags',TP.ac('subscription'));TP.xmpp.Pubsub.registerPubsubType(TP.xmpp.XMLNS.PUBSUB,'./$def:subscriptions',TP.xmpp.PubsubSubscriptions);
TP.boot.$srcPath = '~lib_src/xmpp/pubsub/XMPPSignalPayload.js';
TP.xmpp.Payload.defineSubtype('SignalPayload');TP.xmpp.SignalPayload.Type.defineConstant('EXCLUSIONS',TP.ac('TP.sig.Signal','INFO','TRACE','SYSTEM'));TP.xmpp.SignalPayload.set('namespace',TP.xmpp.XMLNS.TIBET_SIGNAL);TP.xmpp.SignalPayload.set('tagname','tibet_signal');TP.xmpp.SignalPayload.set('template',TP.join('<tibet_signal xmlns="',TP.xmpp.XMLNS.TIBET_SIGNAL,'"',' type="" origin=""></tibet_signal>'));TP.xmpp.SignalPayload.register();TP.xmpp.SignalPayload.Type.defineMethod('fromTP_sig_Signal',function(a){var b,c,d;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}b=this.construct();b.setAttribute('type',a.getSignalName());if(TP.isValid(a.getOrigin())){b.setAttribute('origin',a.getOrigin().getID());}if(TP.isValid(c=a.getPayload())){try{d=c.as('TP.core.XMLRPCNode');if(TP.isNode(d)){TP.nodeAppendChild(b.getNativeNode(),d);}}catch(b){a.raise('TP.sig.XMPPSerializationException',arguments,c);}}return b;});TP.xmpp.SignalPayload.Inst.defineMethod('asTP_sig_Signal',function(){var c,d,a,e,b;c=this.getAttribute('type');if(!TP.isType(d=TP.sys.getTypeByName(c))){return this.raise('TP.sig.SignalTypeNotFound',arguments);}a=this.getAttribute('origin');try{e=TP.core.XMLRPCNode.objectFromNode(this.getNativeNode().firstChild);}catch(a){return this.raise('TP.sig.ReconstitutionFailure',arguments,TP.ec(a,this.asString()));}b=d.construct(e);if(TP.isValid(a)){b.setOrigin(a);}return b;});
TP.boot.$srcPath = '~lib_src/xs/xs_.js';
TP.core.XMLNamespace.defineSubtype('xs:XMLNS');TP.xs.XMLNS.Type.defineMethod('validate',function(h,e){var c,f,b,i,a,g,d,k,j;TP.debug('break.validate');if(TP.notValid(e)){return this.raise('TP.sig.InvalidParameter',arguments,'Invalid target node for schema validation.');}if(TP.isNode(e)){c=e;}else if(TP.isMethod(e.getNativeNode)){c=e.getNativeNode();}TP.ifTrace(TP.$DEBUG)?TP.trace(TP.boot.$annotate(c,'xs: validating: '+h),TP.LOG,arguments):0;if(TP.notEmpty(b=TP.elementGetAttribute(c,'xsi:type',true))){TP.ifTrace(TP.$DEBUG)?TP.trace('found xsi:type '+b,TP.LOG,arguments):0;if(TP.isType(f=TP.sys.require(b))){return f.validate(h,e);}TP.ifTrace(TP.$DEBUG)?TP.trace('xsi:type '+b+' not available',TP.LOG,arguments):0;}else if(c.namespaceURI===TP.w3.Xmlns.XFORMS&&TP.notEmpty(b=TP.elementGetAttribute(c,'type'))){TP.ifTrace(TP.$DEBUG)?TP.trace('found xforms:type '+b,TP.LOG,arguments):0;if(TP.isType(f=TP.sys.require(b))){return f.validate(h,e);}TP.ifTrace(TP.$DEBUG)?TP.trace('xforms:type '+b+' not available',TP.LOG,arguments):0;}if(TP.isEmpty(c.namespaceURI)){TP.ifTrace(TP.$DEBUG&&TP.$VERBOSE)?TP.trace('no namespace uri',TP.LOG,arguments):0;if(TP.isAttributeNode(j=TP.nodeEvaluateXPath(c,'./ancestor-or-self::*/@*[name() = "xsi:noNamespaceSchemaLocation"]',TP.FIRST_NODE))){d=j.value;}}else{TP.ifTrace(TP.$DEBUG)?TP.trace('namespace uri '+c.namespaceURI,TP.LOG,arguments):0;if(TP.isAttributeNode(j=TP.nodeEvaluateXPath(c,'./ancestor-or-self::*/@*[name() = "xsi:schemaLocation"]',TP.FIRST_NODE))){a=j.value;if(TP.isString(a.match(c.namespaceURI))){a=a.slice(a.indexOf(c.namespaceURI));a=a.split(' ');d=a.at(1);}}}if(TP.isEmpty(d)){return true;}TP.ifTrace(TP.$DEBUG)?TP.trace('uri '+d,TP.LOG,arguments):0;if(TP.notValid(k=TP.uc(d))){TP.ifWarn()?TP.warn('Unable to resolve XML Schema URI: '+d,TP.LOG,arguments):0;return true;}if(TP.notValid(i=k.getNativeNode(TP.hc('async',false)))){TP.ifWarn()?TP.warn('Unable to load XML Schema from URI: '+d,TP.LOG,arguments):0;return true;}TP.ifTrace(TP.$DEBUG)?TP.trace(TP.boot.$annotate(i,'Schema: '),TP.LOG,arguments):0;if(TP.isEmpty(b)){TP.ifTrace(TP.$DEBUG)?TP.trace('empty typename',TP.LOG,arguments):0;b=c.nodeName;g='//*[name() = "xs:element" and @name="'+b+'"]';TP.ifTrace(TP.$DEBUG)?TP.trace('using element path: '+g,TP.LOG,arguments):0;a=TP.nodeEvaluateXPath(i,g,TP.NODESET);TP.ifTrace(TP.$DEBUG)?TP.trace('element path found '+a.length+' nodes',TP.LOG,arguments):0;switch(a.length){case 0:TP.ifWarn()?TP.warn('Unable to find XML Schema element: '+b+' in XML Schema: '+d,TP.LOG,arguments):0;return true;case 1:TP.ifTrace(TP.$DEBUG)?TP.trace('found: '+TP.nodeAsString(a.at(0)),TP.LOG,arguments):0;b=TP.elementGetAttribute(a.at(0),'type');if(TP.isType(f=TP.sys.require(b))){return f.validate(h,e);}break;default:TP.ifWarn()?TP.warn('Unsupported multi-element schema definition'+' found for: '+b,TP.LOG,arguments):0;return true;}}TP.ifTrace(TP.$DEBUG)?TP.trace('Looking up schema definition',TP.LOG,arguments):0;g='//*[name() = "xs:simpleType" and @name = "'+b+'"]';TP.ifTrace(TP.$DEBUG)?TP.trace('using simpleType path: '+g,TP.LOG,arguments):0;a=TP.nodeEvaluateXPath(i,g,TP.NODESET);TP.ifTrace(TP.$DEBUG)?TP.trace('using simpleType path found '+a.length+' nodes',TP.LOG,arguments):0;if(TP.isEmpty(a)){g='//*[name() = "xs:complexType" and @name = "'+b+'"]';TP.ifTrace(TP.$DEBUG)?TP.trace('using complexType path: '+g,TP.LOG,arguments):0;a=TP.nodeEvaluateXPath(i,'//*[name() = "xs:complexType" and @name = "'+b+'"]',TP.NODESET);TP.ifTrace(TP.$DEBUG)?TP.trace('using complex path found '+a.length+' nodes',TP.LOG,arguments):0;}if(TP.isEmpty(a)){TP.ifWarn()?TP.warn('Unable to resolve XML Schema type: '+b+' in XML Schema: '+d,TP.LOG,arguments):0;return true;}if(TP.notValid(f=TP.sys.require(a.at(0).nodeName))){TP.ifWarn()?TP.warn('Unable to load/require XML Schema type: '+b+' in XML Schema: '+d,TP.LOG,arguments):0;return true;}return f.validate(h,e,a.at(0));});
TP.boot.$srcPath = '~lib_src/xs/xs_schema.js';
TP.core.ElementNode.defineSubtype('xs:schema');TP.xs.schema.Type.defineMethod('tagCompile',function(d){var a,b,c;if(!TP.isElement(a=d.at('node'))){return TP.CONTINUE;}b=TP.tpnode(a);c=TP.elementGetAttribute(a,'tibet:redefine',true)==='true'?true:false;b.defineTypes(c);return TP.CONTINUE;});TP.xs.schema.Inst.defineMethod('defineTypes',function(c){var b,a;if(TP.notValid(b=this.getNativeNode())){return this.raise('TP.sig.InvalidNode',arguments);}if(TP.notEmpty(a=TP.nodeGetElementsByTagName(b,'simpleType'))){TP.xs.simpleType.defineTypesFromElements(a,c);}if(TP.notEmpty(a=TP.nodeGetElementsByTagName(b,'complexType'))){TP.xs.complexType.defineTypesFromElements(a,c);}return this;});
TP.boot.$srcPath = '~lib_src/xs/TPXMLSchemaType.js';
TP.lang.Object.defineSubtype('xs:XMLSchemaType');TP.xs.XMLSchemaType.Type.defineMethod('fromString',function(a,b){return this.fromObject(a,b);});
TP.boot.$srcPath = '~lib_src/xs/TPXMLSchemaCompositeType.js';
TP.xs.XMLSchemaType.defineSubtype('XMLSchemaCompositeType');TP.xs.XMLSchemaCompositeType.Type.defineAttribute('schemaNode');
TP.boot.$srcPath = '~lib_src/xs/xs_simpleType.js';
TP.xs.XMLSchemaCompositeType.defineSubtype('simpleType');TP.xs.simpleType.Type.defineMethod('defineTypesFromElements',function(a,b){a.perform(function(d){var a,c;if(TP.notEmpty(a=TP.elementGetAttribute(d,'name'))){if(TP.isTrue(b)||TP.notValid(c=TP.sys.require(a))){c=TP.xs.simpleType.defineSubtype(a);c.Type.set('schemaNode',d);}}});return this;});TP.xs.simpleType.Type.defineMethod('validate',function(c){var b,a;if(TP.notValid(b=this.get('schemaNode'))){return this.raise('TP.sig.InvalidNode',arguments,'No schema definition node provided');}a=TP.nodeEvaluateXPath(b,'./xs:restriction',TP.NODESET);if(TP.notEmpty(a)){return this.validateRestriction(c,a.at(0));}a=TP.nodeEvaluateXPath(b,'./xs:union',TP.NODESET);if(TP.notEmpty(a)){return this.validateUnion(c,a.at(0));}a=TP.nodeEvaluateXPath(b,'./xs:list',TP.NODESET);if(TP.notEmpty(a)){return this.validateList(c,a.at(0));}return false;});TP.xs.simpleType.Type.defineMethod('validateList',function(a,c){var d,b,i,g,e,f,h;if(TP.notValid(a)){return this.raise('TP.sig.InvalidParameter',arguments,'TP.xs.list validation requires non-null input');}if(!TP.isString(a)){if(TP.canInvoke(a,'asString')){d=a.asString();}else if(TP.isNode(a)){d=TP.nodeAsString(a);}if(TP.canInvoke(a,'toString')){d=a.toString();}else{return this.raise('TP.sig.InvalidParameter',arguments,'TP.xs.list validation requires string input');}}else{d=a;}b=TP.elementGetAttribute(c,'itemType');if(TP.isEmpty(b)){if(TP.notValid(i=TP.nodeGetElementsByTagName(c,'simpleType').first())){TP.ifWarn()?TP.warn(TP.boot.$annotate(c,'Unable to locate base specification'),TP.LOG,arguments):0;return true;}TP.regex.INVALID_ID_CHARS.lastIndex=0;g=TP.genID('type_').strip(TP.regex.INVALID_ID_CHARS);e=TP.xs.simpleType.defineSubtype(g);e.Type.set('schemaNode',i);TP.elementSetAttribute(c,'itemType',g);}else{b=/\.|:/.test(b)?b:'TP.xs.'+b;e=TP.sys.require(b);if(TP.notValid(e)){TP.ifWarn()?TP.warn(TP.boot.$annotate(c,'Unable to require() base type: '+b),TP.LOG,arguments):0;return true;}}h=d.split(/\s+/);for(f=0;f<h.getSize();f++){if(!e.validate(h.at(f))){return false;}}return true;});TP.xs.simpleType.Type.defineMethod('validateRestriction',function(g,c){var d,b,e,a,f;d=TP.str(g);b=TP.elementGetAttribute(c,'base');if(TP.isEmpty(b)){TP.ifWarn()?TP.warn(TP.boot.$annotate(c,'Unable to locate base specification'),TP.LOG,arguments):0;return true;}b=/\.|:/.test(b)?b:'TP.xs.'+b;e=TP.sys.require(b);if(TP.notValid(e)){TP.ifWarn()?TP.warn(TP.boot.$annotate(c,'Unable to require() base type: '+b),TP.LOG,arguments):0;return true;}if(!e.validate(d)){return false;}a=TP.nodeGetElementsByTagName(c,'whiteSpace');if(TP.notEmpty(a)){d='TP.xs.whiteSpace'.asType().fromObject(d,a.at(0));}a=TP.nodeGetElementsByTagName(c,'enumeration');if(TP.notEmpty(a)){return TP.isValid(a.detect(function(a){return e.validateFacetEnumeration(d,a);}));}a=TP.nodeGetElementsByTagName(c,'pattern');if(TP.notEmpty(a)){return TP.isValid(a.detect(function(a){return e.validateFacetPattern(d,a);}));}a=TP.nodeEvaluateXPath(c,'./*',TP.NODESET);for(f=0;f<a.getSize();f++){if(!e.validateFacet(d,a.at(f))){return false;}}return true;});TP.xs.simpleType.Type.defineMethod('validateUnion',function(i,d){var j,e,a,b,c,h,f,g;if(TP.notValid(i)){return this.raise('TP.sig.InvalidParameter',arguments,'TP.xs.union validation requires non-null input');}j=TP.str(i);e=TP.ac();a=TP.elementGetAttribute(d,'memberTypes');if(TP.notEmpty(a)){a=a.split(/\s+/);}else{a=TP.ac();}for(b=0;b<a.getSize();b++){c=a.at(b);c=/\.|:/.test(c)?c:'TP.xs.'+c;h=TP.sys.require(c);if(TP.notValid(h)){TP.ifWarn()?TP.warn(TP.boot.$annotate(d,'Unable to require() base type: '+c),TP.LOG,arguments):0;return true;}e.push(h);}f=TP.nodeGetElementsByTagName(d,'simpleType');if(TP.isEmpty(a)&&TP.isEmpty(f)){TP.ifWarn()?TP.warn(TP.boot.$annotate(d,'Unable to locate base specification'),TP.LOG,arguments):0;return true;}if(TP.notEmpty(f)){f.perform(function(d){var b,c;TP.regex.INVALID_ID_CHARS.lastIndex=0;b=TP.genID('type_').strip(TP.regex.INVALID_ID_CHARS);a.push(b);c=TP.xs.simpleType.defineSubtype(b);e.push(c);c.Type.set('schemaNode',d);});TP.elementSetAttribute(d,'memberTypes',a.join(' '));TP.nodeEmptyContent(d);}g=false;for(b=0;b<e.getSize();b++){if(e.at(b).validate(j)){g=true;}}return g;});
TP.boot.$srcPath = '~lib_src/xs/xs_complexType.js';
TP.xs.XMLSchemaCompositeType.defineSubtype('complexType');TP.xs.complexType.Type.defineMethod('defineTypesFromElements',function(a,b){a.perform(function(d){var a,c;if(TP.notEmpty(a=TP.elementGetAttribute(d,'name'))){if(TP.isTrue(b)||TP.notValid(c=TP.sys.require(a))){c='TP.xs.complexType'.defineSubtype(a);c.Type.set('schemaNode',d);}}});return this;});TP.xs.complexType.Type.defineMethod('validate',function(c){var a,b;if(TP.notValid(a=this.get('schemaNode'))){return this.raise('TP.sig.InvalidNode',arguments,'No schema definition node provided');}if(TP.notValid(b=this.validateCompositors(c,a))){return false;}return b;});TP.xs.complexType.Type.defineMethod('validateChoice',function(e,c){var f,d,a,b;d=TP.nodeEvaluateXPath(c,'./xs:element',TP.NODESET);if(TP.notEmpty(d)){f=this.validateElements(e,c);a=f===1;}if(TP.notValid(b=this.validateCompositors(e,c))){return a;}else if(TP.isEmpty(d)){return b;}if(a&&!b||b&&!a){return true;}return false;});TP.xs.complexType.Type.defineMethod('validateCompositors',function(d,c){var a,b;a=TP.nodeEvaluateXPath(c,'./*[local-name() = "sequence" or local-name() = "choice"]',TP.NODESET);if(TP.isEmpty(a)){return null;}b=true;a=TP.nodeEvaluateXPath(c,'./xs:sequence',TP.NODESET);if(TP.notEmpty(a)){b=this.validateSequence(d,a.at(0));}if(b){a=TP.nodeEvaluateXPath(c,'./xs:choice',TP.NODESET);if(TP.notEmpty(a)){b=this.validateChoice(d,a.at(0));}}return b;});TP.xs.complexType.Type.defineMethod('validateElements',function(g,l){var i,e,b,d,h,c,j,a,f,k;if(TP.notValid(g)){return true;}i=TP.wrap(g);e=TP.name(l)==='xs:sequence';b=TP.nodeEvaluateXPath(l,'./xs:element',TP.NODESET);d=0;if(TP.notEmpty(b)){h=b.getSize();for(c=0;c<h;c++){if(TP.isEmpty(j=TP.elementGetAttribute(b.at(c),'name'))){if(e){return false;}else{continue;}}if(TP.isEmpty(a=TP.elementGetAttribute(b.at(c),'type'))){if(e){return false;}else{continue;}}a=/\.|:/.test(a)?a:'TP.xs.'+a;f=TP.sys.require(a);if(TP.notValid(f)){TP.ifWarn()?TP.warn(TP.boot.$annotate(b.at(c),'Unable to require() base type: '+a),TP.LOG,arguments):0;return true;}if(TP.isValid(k=i.get(j))){if(f.validate(k)){d++;}}}}return d;});TP.xs.complexType.Type.defineMethod('validateSequence',function(e,b){var f,a,c,d;a=TP.nodeEvaluateXPath(b,'./xs:element',TP.NODESET);if(TP.notEmpty(a)){f=this.validateElements(e,b);c=f===a.getSize();}if(TP.notValid(d=this.validateCompositors(e,b))){return c;}else if(TP.isEmpty(a)){return d;}return c&&d;});
TP.boot.$srcPath = '~lib_src/xs/xs_whiteSpace.js';
TP.xs.XMLSchemaCompositeType.defineSubtype('whiteSpace');TP.xs.whiteSpace.Type.defineMethod('fromObject',function(c,d){var b,a;a=c;b=TP.elementGetAttribute(d,'value');switch(b){case'collapse':a='TP.xs.token'.asType().fromObject(a);break;case'preserve':break;case'replace':a='TP.xs.normalizedString'.asType().fromObject(a);break;default:this.raise('TP.sig.UnsupportedFeature',arguments,'Invalid format specification for facet');break;}return a.asString();});
TP.boot.$srcPath = '~lib_src/xs/xs_StringExtensions.js';
String.Inst.defineMethod('validate',function(b){var a;if(TP.isType(a=this.asType())){return a.validate(b);}return false;});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_anyType.js';
TP.xs.XMLSchemaType.defineSubtype('anyType');TP.xs.anyType.Type.defineMethod('fromObject',function(a){return a;});TP.xs.anyType.Type.defineMethod('validate',function(a){return TP.isValid(a);});TP.xs.anyType.Type.defineMethod('validateFacet',function(d,a){var c,b;c=a.nodeName.split(':').last();b='validateFacet'+c.asStartUpper();if(TP.isMethod(this[b])){return this[b](d,a);}TP.ifWarn()?TP.warn(TP.boot.$annotate(a,'Unable to find facet resolution method'),TP.LOG,arguments):0;return true;});TP.xs.anyType.Type.defineMethod('validateFacetEnumeration',function(b,c){var a;a=this.fromObject(TP.elementGetAttribute(c,'value'));return b.equalTo(a);});TP.xs.anyType.Type.defineMethod('validateFacetFractionDigits',function(a,b){this.raise('TP.sig.UnsupportedFeature',arguments,'Unsupported facet for this schema type');return false;});TP.xs.anyType.Type.defineMethod('validateFacetLength',function(a,b){this.raise('TP.sig.UnsupportedFeature',arguments,'Unsupported facet for this schema type');return false;});TP.xs.anyType.Type.defineMethod('validateFacetMaxExclusive',function(a,b){this.raise('TP.sig.UnsupportedFeature',arguments,'Unsupported facet for this schema type');return false;});TP.xs.anyType.Type.defineMethod('validateFacetMaxInclusive',function(a,b){this.raise('TP.sig.UnsupportedFeature',arguments,'Unsupported facet for this schema type');return false;});TP.xs.anyType.Type.defineMethod('validateFacetMaxLength',function(a,b){this.raise('TP.sig.UnsupportedFeature',arguments,'Unsupported facet for this schema type');return false;});TP.xs.anyType.Type.defineMethod('validateFacetMinExclusive',function(a,b){this.raise('TP.sig.UnsupportedFeature',arguments,'Unsupported facet for this schema type');return false;});TP.xs.anyType.Type.defineMethod('validateFacetMinInclusive',function(a,b){this.raise('TP.sig.UnsupportedFeature',arguments,'Unsupported facet for this schema type');return false;});TP.xs.anyType.Type.defineMethod('validateFacetMinLength',function(a,b){this.raise('TP.sig.UnsupportedFeature',arguments,'Unsupported facet for this schema type');return false;});TP.xs.anyType.Type.defineMethod('validateFacetPattern',function(c,d){var a,b;a=TP.elementGetAttribute(d,'value');b=c.asString();return a.test(b);});TP.xs.anyType.Type.defineMethod('validateFacetTotalDigits',function(a,b){this.raise('TP.sig.UnsupportedFeature',arguments,'Unsupported facet for this schema type');return false;});TP.xs.anyType.Type.defineMethod('validateFacetWhiteSpace',function(a,b){return true;});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_anySimpleType.js';
TP.xs.anyType.defineSubtype('anySimpleType');
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_string.js';
TP.xs.anySimpleType.defineSubtype('string');TP.xs.string.Type.defineMethod('fromObject',function(a){if(TP.isNull(a)){return'null';}if(TP.notDefined(a)){return'undefined';}if(TP.canInvoke(a,'asString')){return a.asString();}else if(TP.canInvoke(a,'toString')){return a.toString();}else if(TP.isNode(a)){return TP.nodeAsString(a);}return;});TP.xs.string.Type.defineMethod('validate',function(a){return TP.isString(a);});TP.xs.string.Type.defineMethod('validateFacetLength',function(c,d){var a,b;b=TP.elementGetAttribute(d,'value').asNumber();a=this.fromObject(c);if(TP.notValid(a)){return false;}return a.getSize()===b;});TP.xs.string.Type.defineMethod('validateFacetMaxLength',function(c,d){var a,b;b=TP.elementGetAttribute(d,'value').asNumber();a=this.fromObject(c);if(TP.notValid(a)){return false;}return a.getSize()<=b;});TP.xs.string.Type.defineMethod('validateFacetMinLength',function(c,d){var a,b;b=TP.elementGetAttribute(d,'value').asNumber();a=this.fromObject(c);if(TP.notValid(a)){return false;}return a.getSize()>=b;});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_normalizedString.js';
TP.xs.string.defineSubtype('normalizedString');TP.xs.normalizedString.Type.defineMethod('fromObject',function(b){var a;a=this.callNextMethod();if(!TP.isString(a)){return;}return a.replaceWhitespace();});TP.xs.normalizedString.Type.defineMethod('validate',function(a){if(!TP.isString(a)){return false;}return a.equalTo(a.toString().replaceWhitespace());});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_token.js';
TP.xs.normalizedString.defineSubtype('token');TP.xs.token.Type.defineMethod('fromObject',function(b){var a;a=this.callNextMethod();if(!TP.isString(a)){return;}return a.collapseWhitespace();});TP.xs.token.Type.defineMethod('validate',function(a){if(!TP.isString(a)){return false;}return a.equalTo(a.toString().tokenizeWhitespace());});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_language.js';
TP.xs.token.defineSubtype('language');TP.xs.language.Type.defineMethod('fromObject',function(b){var a;a='TP.xs.token'.asType().from(b);if(TP.notValid(a)){return;}a=a.stripWhitespace();if(!this.validate(a)){return;}return a;});TP.xs.language.Type.defineMethod('validate',function(a){if(!TP.isString(a)){return false;}return/^[a-zA-Z]{1,8}(-[a-zA-Z0-9]{1,8})*$/.test(a);});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_NMTOKEN.js';
TP.xs.token.defineSubtype('NMTOKEN');TP.xs.NMTOKEN.Type.defineConstant('NMTOKEN_REGEX',TP.rc('^('+TP.core.Unicode.NameChar+')+$'));TP.xs.NMTOKEN.Type.defineMethod('fromObject',function(b){var a;a=this.callNextMethod();if(!TP.isString(a)){return;}return a.strip(/[,"]/g);});TP.xs.NMTOKEN.Type.defineMethod('validate',function(a){if(!TP.isString(a)){return false;}return this.get('NMTOKEN_REGEX').test(a);});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_NMTOKENS.js';
TP.xs.NMTOKEN.defineSubtype('NMTOKENS');TP.xs.NMTOKENS.Type.defineAttribute('itemType','TP.xs.NMTOKEN');TP.xs.NMTOKENS.Type.defineMethod('fromObject',function(c){var b,a;b='TP.xs.token'.asType().from(c);if(!TP.isString(b)){return;}a=b.split(' ');a.convert(function(a){return a.as('TP.xs.NMTOKEN');});a=a.select(function(a){return TP.isValid(a);});return a.join(' ');});TP.xs.NMTOKENS.Type.defineMethod('validate',function(b){var c,a;if(!TP.isString(b)){return false;}if(b.isa(this.get('itemType'))){return true;}c=b.split(' ');for(a=0;a<c.getSize();a++){if(!c[a].isa(this.get('itemType'))){return false;}}return true;});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_Name.js';
TP.xs.token.defineSubtype('Name');TP.xs.Name.Type.defineConstant('NAME_REGEX',TP.rc('^('+TP.core.Unicode.Letter+'|_|:)('+TP.core.Unicode.NameChar+')*$'));TP.xs.Name.Type.defineMethod('fromObject',function(b){var a;a='TP.xs.NMTOKEN'.asType().from(b);if(!TP.isString(a)){return;}a=a.strip(/^\./);a=a.strip(TP.rc('^['+TP.core.Unicode.Extender+'|'+TP.core.Unicode.CombiningChar+'|'+TP.core.Unicode.Digit+']'));if(!this.validate(a)){return;}return a;});TP.xs.Name.Type.defineMethod('validate',function(a){if(!TP.isString(a)){return false;}return this.get('NAME_REGEX').test(a);});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_NCName.js';
TP.xs.Name.defineSubtype('NCName');TP.xs.NCName.Type.defineMethod('fromObject',function(b){var a;a=this.callNextMethod();if(!TP.isString(a)){return;}return a.strip(/:/g);});TP.xs.NCName.Type.defineMethod('validate',function(a){if(!'TP.xs.Name'.asType().validate(a)){return false;}return!TP.regex.HAS_COLON.test(a);});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_ID.js';
TP.xs.NCName.defineSubtype('ID');
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_IDREF.js';
TP.xs.NCName.defineSubtype('IDREF');
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_IDREFS.js';
TP.xs.IDREF.defineSubtype('IDREFS');TP.xs.IDREFS.Type.defineAttribute('itemType','TP.xs.IDREF');TP.xs.IDREFS.Type.defineMethod('fromObject',function(c){var b,a;b='TP.xs.token'.asType().from(c);if(!TP.isString(b)){return;}a=b.split(' ');a.convert(function(a){return a.as('TP.xs.IDREF');});a=a.select(function(a){return TP.isValid(a);});return a.join(' ');});TP.xs.IDREFS.Type.defineMethod('validate','TP.xs.NMTOKENS'.asType().validate.copy());
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_ENTITY.js';
TP.xs.NCName.defineSubtype('ENTITY');
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_ENTITIES.js';
TP.xs.ENTITY.defineSubtype('ENTITIES');TP.xs.ENTITIES.Type.defineAttribute('itemType','TP.xs.ENTITY');TP.xs.ENTITIES.Type.defineMethod('fromObject',function(c){var b,a;b='TP.xs.token'.asType().from(c);if(!TP.isString(b)){return;}a=b.split(' ');a.convert(function(a){return a.as('TP.xs.ENTITY');});a=a.select(function(a){return TP.isValid(a);});return a.join(' ');});TP.xs.ENTITIES.Type.defineMethod('validate','TP.xs.NMTOKENS'.asType().validate.copy());
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_duration.js';
TP.xs.anySimpleType.defineSubtype('duration');TP.xs.duration.Type.defineConstant('COMPARISON_DATE_ONE',TP.dc('1696-09-00T00:00:00Z'));TP.xs.duration.Type.defineConstant('COMPARISON_DATE_TWO',TP.dc('1697-02-01T00:00:00Z'));TP.xs.duration.Type.defineConstant('COMPARISON_DATE_THREE',TP.dc('1903-03-01T00:00:00Z'));TP.xs.duration.Type.defineConstant('COMPARISON_DATE_FOUR',TP.dc('1903-07-01T00:00:00Z'));TP.xs.duration.Type.defineMethod('fromObject',function(a){var b;if(!TP.isValid(a)){return this.raise('TP.sig.InvalidParameter',arguments);}if(TP.isMethod(a.asString)){b=a.asString();}else if(TP.isMethod(a.toString)){b=a.toString();}else if(TP.isNode(a)){b=TP.nodeAsString(a);}if(!this.validate(b)){return;}return b;});TP.xs.duration.Type.defineMethod('validate',function(c){var b,a;if(!TP.isString(c)){return false;}b=c;if(!/^[-]*P[0-9T]+/.test(b)){return false;}a=b.match(Date.DURATION_REGEX);if(TP.notValid(a)){return false;}if(TP.notEmpty(a.at(Date.DURATION_T_INDEX))){return TP.notEmpty(a.at(Date.DURATION_HOUR_INDEX))||TP.notEmpty(a.at(Date.DURATION_MINUTE_INDEX))||TP.notEmpty(a.at(Date.DURATION_SECOND_INDEX));}else{return TP.isEmpty(a.at(Date.DURATION_HOUR_INDEX))&&TP.isEmpty(a.at(Date.DURATION_MINUTE_INDEX))&&TP.isEmpty(a.at(Date.DURATION_SECOND_INDEX));}return false;});TP.xs.duration.Type.defineMethod('validateFacetEnumeration',function(c,d){var a,b;a=Date.normalizeDuration(TP.elementGetAttribute(d,'value'));b=Date.normalizeDuration(c);return a===b;});TP.xs.duration.Type.defineMethod('validateFacetMaxExclusive',function(b,c){var a;a=this.fromObject(TP.elementGetAttribute(c,'value'));if(this.COMPARISON_DATE_ONE.addDuration(a).getTime()>this.COMPARISON_DATE_ONE.addDuration(b).getTime()&&this.COMPARISON_DATE_TWO.addDuration(a).getTime()>this.COMPARISON_DATE_TWO.addDuration(b).getTime()&&this.COMPARISON_DATE_THREE.addDuration(a).getTime()>this.COMPARISON_DATE_THREE.addDuration(b).getTime()&&this.COMPARISON_DATE_FOUR.addDuration(a).getTime()>this.COMPARISON_DATE_FOUR.addDuration(b).getTime()){return true;}return false;});TP.xs.duration.Type.defineMethod('validateFacetMaxInclusive',function(b,c){var a;a=this.fromObject(TP.elementGetAttribute(c,'value'));if(this.COMPARISON_DATE_ONE.addDuration(a).getTime()>=this.COMPARISON_DATE_ONE.addDuration(b).getTime()&&this.COMPARISON_DATE_TWO.addDuration(a).getTime()>=this.COMPARISON_DATE_TWO.addDuration(b).getTime()&&this.COMPARISON_DATE_THREE.addDuration(a).getTime()>=this.COMPARISON_DATE_THREE.addDuration(b).getTime()&&this.COMPARISON_DATE_FOUR.addDuration(a).getTime()>=this.COMPARISON_DATE_FOUR.addDuration(b).getTime()){return true;}return false;});TP.xs.duration.Type.defineMethod('validateFacetMinExclusive',function(b,c){var a;a=this.fromObject(TP.elementGetAttribute(c,'value'));if(this.COMPARISON_DATE_ONE.addDuration(a).getTime()<this.COMPARISON_DATE_ONE.addDuration(b).getTime()&&this.COMPARISON_DATE_TWO.addDuration(a).getTime()<this.COMPARISON_DATE_TWO.addDuration(b).getTime()&&this.COMPARISON_DATE_THREE.addDuration(a).getTime()<this.COMPARISON_DATE_THREE.addDuration(b).getTime()&&this.COMPARISON_DATE_FOUR.addDuration(a).getTime()<this.COMPARISON_DATE_FOUR.addDuration(b).getTime()){return true;}return false;});TP.xs.duration.Type.defineMethod('validateFacetMinInclusive',function(b,c){var a;a=this.fromObject(TP.elementGetAttribute(c,'value'));if(this.COMPARISON_DATE_ONE.addDuration(a).getTime()<=this.COMPARISON_DATE_ONE.addDuration(b).getTime()&&this.COMPARISON_DATE_TWO.addDuration(a).getTime()<=this.COMPARISON_DATE_TWO.addDuration(b).getTime()&&this.COMPARISON_DATE_THREE.addDuration(a).getTime()<=this.COMPARISON_DATE_THREE.addDuration(b).getTime()&&this.COMPARISON_DATE_FOUR.addDuration(a).getTime()<=this.COMPARISON_DATE_FOUR.addDuration(b).getTime()){return true;}return false;});TP.xs.duration.Type.defineMethod('getMonthsInDuration',function(b){var a;if(TP.notValid(a=this.from(b))){return this.raise('TP.sig.InvalidDuration',arguments);}return Date.getMonthsInDuration(a);});TP.xs.duration.Type.defineMethod('getSecondsInDuration',function(b){var a;if(TP.notValid(a=this.from(b))){return this.raise('TP.sig.InvalidDuration',arguments);}return Date.getSecondsInDuration(a);});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_dateTime.js';
TP.xs.anySimpleType.defineSubtype('dateTime');TP.xs.dateTime.Type.defineConstant('DATETIME_REGEX',/^([-])*([^T]+)T([^T]+)$/);TP.xs.dateTime.Type.defineConstant('MINUS_INDEX',1);TP.xs.dateTime.Type.defineConstant('DATE_INDEX',2);TP.xs.dateTime.Type.defineConstant('TIME_INDEX',3);TP.xs.dateTime.Type.defineMethod('fromDate',function(a){return a.as('TP.iso.ISO8601');});TP.xs.dateTime.Type.defineMethod('validate',function(b){var c,a,d,e;if(!TP.isString(b)){return false;}c=b;a=c.match(this.get('DATETIME_REGEX'));if(TP.notValid(a)){return false;}d=a.at(this.get('DATE_INDEX'));if(!'TP.xs.date'.asType().validate(d)){return false;}e=a.at(this.get('TIME_INDEX'));return'TP.xs.time'.asType().validate(e);});TP.xs.dateTime.Type.defineMethod('validateFacetEnumeration',function(c,d){var a,b;a=TP.dc(TP.elemenGetAttribute(d,'value'));b=TP.dc(c);return b.equalTo(a);});TP.xs.dateTime.Type.defineMethod('validateFacetMaxExclusive',function(c,d){var a,b;b=TP.dc(TP.elementGetAttribute(d,'value'));a=TP.dc(c);return a.getTime()<b.getTime();});TP.xs.dateTime.Type.defineMethod('validateFacetMaxInclusive',function(c,d){var a,b;b=TP.dc(TP.elementGetAttribute(d,'value'));a=TP.dc(c);return a.getTime()<=b.getTime();});TP.xs.dateTime.Type.defineMethod('validateFacetMinExclusive',function(c,d){var a,b;b=TP.dc(TP.elementGetAttribute(d,'value'));a=TP.dc(c);return a.getTime()>b.getTime();});TP.xs.dateTime.Type.defineMethod('validateFacetMinInclusive',function(c,d){var a,b;b=TP.dc(TP.elementGetAttribute(d,'value'));a=TP.dc(c);return a.getTime()>=b.getTime();});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_time.js';
TP.xs.anySimpleType.defineSubtype('time');TP.xs.time.Type.defineConstant('TIME_REGEX',/^([-])*([0-9]{2}):([0-9]{2}):([0-9]{2}[\.]*[0-9]*)(([Z\+\-]*)([0-9]{2})*[:]*([0-9]{2})*)$/);TP.xs.time.Type.defineConstant('MINUS_INDEX',1);TP.xs.time.Type.defineConstant('HOUR_INDEX',2);TP.xs.time.Type.defineConstant('MINUTE_INDEX',3);TP.xs.time.Type.defineConstant('SECOND_INDEX',4);TP.xs.time.Type.defineConstant('ZONE_INDEX',5);TP.xs.time.Type.defineMethod('validate',function(e){var f,a,c,d,b,g;if(!TP.isString(e)){return false;}f=e;a=f.match(this.get('TIME_REGEX'));if(TP.notValid(a)){return false;}c=parseInt(a.at(this.get('HOUR_INDEX')),10);d=parseInt(a.at(this.get('MINUTE_INDEX')),10);b=a.at(this.get('SECOND_INDEX'));if(c>24){return false;}else if(c===24){if(d!==0||b!=='00'){return false;}}if(d>59){return false;}if(/\./.test(b)&&/0$/.test(b)){return false;}if(parseInt(b.split('.').at(0),10)>59){return false;}if(TP.notEmpty(g=a.at(this.get('ZONE_INDEX')))){return TP.core.TimeZone.validate(g);}return true;});TP.xs.time.Type.defineMethod('validateFacetMaxExclusive',function(k,l){var a,e,f,c,j,b,h,g,d,i;a=k.match(this.get('TIME_REGEX'));b=TP.elementGetAttribute(l,'value').match(this.get('TIME_REGEX'));j=a.at(this.get('ZONE_INDEX'));i=b.at(this.get('ZONE_INDEX'));if(j!==i){return this.raise('TP.sig.UnsupportedFeature',arguments,'Timezone comparisons not currently supported.');}e=parseInt(a.at(this.get('HOUR_INDEX')),10);h=parseInt(b.at(this.get('HOUR_INDEX')),10);if(e>h){return false;}if(e<h){return true;}f=parseInt(a.at(this.get('MINUTE_INDEX')),10);g=parseInt(b.at(this.get('MINUTE_INDEX')),10);if(f>g){return false;}if(f<g){return true;}c=a.at(this.get('SECOND_INDEX'));d=b.at(this.get('SECOND_INDEX'));if(c>=d){return false;}if(c<d){return true;}});TP.xs.time.Type.defineMethod('validateFacetMaxInclusive',function(k,l){var a,e,f,c,j,b,h,g,d,i;a=k.match(this.get('TIME_REGEX'));b=TP.elementGetAttribute(l,'value').match(this.get('TIME_REGEX'));j=a.at(this.get('ZONE_INDEX'));i=b.at(this.get('ZONE_INDEX'));if(j!==i){return this.raise('TP.sig.UnsupportedFeature',arguments,'Timezone comparisons not currently supported.');}e=parseInt(a.at(this.get('HOUR_INDEX')),10);h=parseInt(b.at(this.get('HOUR_INDEX')),10);if(e>h){return false;}if(e<h){return true;}f=parseInt(a.at(this.get('MINUTE_INDEX')),10);g=parseInt(b.at(this.get('MINUTE_INDEX')),10);if(f>g){return false;}if(f<g){return true;}c=a.at(this.get('SECOND_INDEX'));d=b.at(this.get('SECOND_INDEX'));if(c>d){return false;}if(c<=d){return true;}});TP.xs.time.Type.defineMethod('validateFacetMinExclusive',function(k,l){var a,e,f,c,j,b,h,g,d,i;a=k.match(this.get('TIME_REGEX'));b=TP.elementGetAttribute(l,'value').match(this.get('TIME_REGEX'));j=a.at(this.get('ZONE_INDEX'));i=b.at(this.get('ZONE_INDEX'));if(j!==i){return this.raise('TP.sig.UnsupportedFeature',arguments,'Timezone comparisons not currently supported.');}e=parseInt(a.at(this.get('HOUR_INDEX')),10);h=parseInt(b.at(this.get('HOUR_INDEX')),10);if(e<h){return false;}if(e>h){return true;}f=parseInt(a.at(this.get('MINUTE_INDEX')),10);g=parseInt(b.at(this.get('MINUTE_INDEX')),10);if(f<g){return false;}if(f>g){return true;}c=a.at(this.get('SECOND_INDEX'));d=b.at(this.get('SECOND_INDEX'));if(c<=d){return false;}if(c>d){return true;}});TP.xs.time.Type.defineMethod('validateFacetMinInclusive',function(k,l){var a,e,f,c,j,b,h,g,d,i;a=k.match(this.get('TIME_REGEX'));b=TP.elementGetAttribute(l,'value').match(this.get('TIME_REGEX'));j=a.at(this.get('ZONE_INDEX'));i=b.at(this.get('ZONE_INDEX'));if(j!==i){return this.raise('TP.sig.UnsupportedFeature',arguments,'Timezone comparisons not currently supported.');}e=parseInt(a.at(this.get('HOUR_INDEX')),10);h=parseInt(b.at(this.get('HOUR_INDEX')),10);if(e<h){return false;}if(e>h){return true;}f=parseInt(a.at(this.get('MINUTE_INDEX')),10);g=parseInt(b.at(this.get('MINUTE_INDEX')),10);if(f<g){return false;}if(f>g){return true;}c=a.at(this.get('SECOND_INDEX'));d=b.at(this.get('SECOND_INDEX'));if(c<d){return false;}if(c>=d){return true;}});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_date.js';
TP.xs.anySimpleType.defineSubtype('date');TP.xs.date.Type.defineConstant('DATE_REGEX',/^([-])*([0-9]{4,})-([0-9]{2})-([0-9]{2})(([Z\+\-]*)([0-9]{2})*[:]*([0-9]{2})*)$/);TP.xs.date.Type.defineConstant('MINUS_INDEX',1);TP.xs.date.Type.defineConstant('YEAR_INDEX',2);TP.xs.date.Type.defineConstant('MONTH_INDEX',3);TP.xs.date.Type.defineConstant('DAY_INDEX',4);TP.xs.date.Type.defineConstant('ZONE_INDEX',5);TP.xs.date.Type.defineMethod('validate',function(d){var e,a,b,c,f,g;if(!TP.isString(d)){return false;}e=d;a=e.match(this.get('DATE_REGEX'));if(TP.notValid(a)){return false;}b=a.at(this.get('YEAR_INDEX'));if(b.getSize()>4&&b.startsWith('0')){return false;}b=parseInt(b,10);c=parseInt(a.at(this.get('MONTH_INDEX')),10);f=parseInt(a.at(this.get('DAY_INDEX')),10);if(!c.isBetweenInclusive(1,12)){return false;}if(!f.isBetweenInclusive(1,Date.daysInMonth(c,b))){return false;}if(TP.notEmpty(g=a.at(this.get('ZONE_INDEX')))){return TP.core.TimeZone.validate(g);}return true;});TP.xs.date.Type.defineMethod('validateFacetMaxExclusive',function(k,l){var a,e,f,c,j,b,h,g,d,i;a=k.match(this.get('DATE_REGEX'));b=TP.elementGetAttribute(l,'value').match(this.get('DATE_REGEX'));j=a.at(this.get('ZONE_INDEX'));i=b.at(this.get('ZONE_INDEX'));if(j!==i){return this.raise('TP.sig.UnsupportedFeature',arguments,'Timezone comparisons not currently supported.');}e=parseInt(a.at(this.get('YEAR_INDEX')),10);h=parseInt(b.at(this.get('YEAR_INDEX')),10);if(e>h){return false;}if(e<h){return true;}f=parseInt(a.at(this.get('MONTH_INDEX')),10);g=parseInt(b.at(this.get('MONTH_INDEX')),10);if(f>g){return false;}if(f<g){return true;}c=parseInt(a.at(this.get('DAY_INDEX')),10);d=parseInt(b.at(this.get('DAY_INDEX')),10);if(c>=d){return false;}if(c<d){return true;}});TP.xs.date.Type.defineMethod('validateFacetMaxInclusive',function(k,l){var a,e,f,c,j,b,h,g,d,i;a=k.match(this.get('DATE_REGEX'));b=TP.elementGetAttribute(l,'value').match(this.get('DATE_REGEX'));j=a.at(this.get('ZONE_INDEX'));i=b.at(this.get('ZONE_INDEX'));if(j!==i){return this.raise('TP.sig.UnsupportedFeature',arguments,'Timezone comparisons not currently supported.');}e=parseInt(a.at(this.get('YEAR_INDEX')),10);h=parseInt(b.at(this.get('YEAR_INDEX')),10);if(e>h){return false;}if(e<h){return true;}f=parseInt(a.at(this.get('MONTH_INDEX')),10);g=parseInt(b.at(this.get('MONTH_INDEX')),10);if(f>g){return false;}if(f<g){return true;}c=parseInt(a.at(this.get('DAY_INDEX')),10);d=parseInt(b.at(this.get('DAY_INDEX')),10);if(c>d){return false;}if(c<=d){return true;}});TP.xs.date.Type.defineMethod('validateFacetMinExclusive',function(k,l){var a,e,f,c,j,b,h,g,d,i;a=k.match(this.get('DATE_REGEX'));b=TP.elementGetAttribute(l,'value').match(this.get('DATE_REGEX'));j=a.at(this.get('ZONE_INDEX'));i=b.at(this.get('ZONE_INDEX'));if(j!==i){return this.raise('TP.sig.UnsupportedFeature',arguments,'Timezone comparisons not currently supported.');}e=parseInt(a.at(this.get('YEAR_INDEX')),10);h=parseInt(b.at(this.get('YEAR_INDEX')),10);if(e<h){return false;}if(e>h){return true;}f=parseInt(a.at(this.get('MONTH_INDEX')),10);g=parseInt(b.at(this.get('MONTH_INDEX')),10);if(f<g){return false;}if(f>g){return true;}c=parseInt(a.at(this.get('DAY_INDEX')),10);d=parseInt(b.at(this.get('DAY_INDEX')),10);if(c<=d){return false;}if(c>d){return true;}});TP.xs.date.Type.defineMethod('validateFacetMinInclusive',function(k,l){var a,e,f,c,j,b,h,g,d,i;a=k.match(this.get('DATE_REGEX'));b=TP.elementGetAttribute(l,'value').match(this.get('DATE_REGEX'));j=a.at(this.get('ZONE_INDEX'));i=b.at(this.get('ZONE_INDEX'));if(j!==i){return this.raise('TP.sig.UnsupportedFeature',arguments,'Timezone comparisons not currently supported.');}e=parseInt(a.at(this.get('YEAR_INDEX')),10);h=parseInt(b.at(this.get('YEAR_INDEX')),10);if(e<h){return false;}if(e>h){return true;}f=parseInt(a.at(this.get('MONTH_INDEX')),10);g=parseInt(b.at(this.get('MONTH_INDEX')),10);if(f<g){return false;}if(f>g){return true;}c=parseInt(a.at(this.get('DAY_INDEX')),10);d=parseInt(b.at(this.get('DAY_INDEX')),10);if(c<d){return false;}if(c>=d){return true;}});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_gYearMonth.js';
TP.xs.anySimpleType.defineSubtype('gYearMonth');TP.xs.gYearMonth.Type.defineConstant('YEARMONTH_REGEX',/^([-])*([0-9]{4,})-([0-9]{2})(([Z\+\-]*)([0-9]{2})*[:]*([0-9]{2})*)$/);TP.xs.gYearMonth.Type.defineConstant('MINUS_INDEX',1);TP.xs.gYearMonth.Type.defineConstant('YEAR_INDEX',2);TP.xs.gYearMonth.Type.defineConstant('MONTH_INDEX',3);TP.xs.gYearMonth.Type.defineConstant('ZONE_INDEX',4);TP.xs.gYearMonth.Type.defineMethod('validate',function(c){var d,a,e,b,f;if(!TP.isString(c)){return false;}d=c;a=d.match(this.get('YEARMONTH_REGEX'));if(TP.notValid(a)){return false;}b=a.at(this.get('YEAR_INDEX'));if(b.getSize()>4&&b.startsWith('0')){return false;}b=parseInt(b,10);f=parseInt(a.at(this.get('MONTH_INDEX')),10);if(!f.isBetweenInclusive(1,12)){return false;}if(TP.notEmpty(e=a.at(this.get('ZONE_INDEX')))){return TP.core.TimeZone.validate(e);}return true;});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_gYear.js';
TP.xs.anySimpleType.defineSubtype('gYear');TP.xs.gYear.Type.defineConstant('YEAR_REGEX',/^([-])*([0-9]{4,})(([Z\+\-]*)([0-9]{2})*[:]*([0-9]{2})*)$/);TP.xs.gYear.Type.defineConstant('MINUS_INDEX',1);TP.xs.gYear.Type.defineConstant('YEAR_INDEX',2);TP.xs.gYear.Type.defineConstant('ZONE_INDEX',3);TP.xs.gYear.Type.defineMethod('validate',function(c){var d,b,e,a;if(!TP.isString(c)){return false;}d=c;b=d.match(this.get('YEAR_REGEX'));if(TP.notValid(b)){return false;}a=b.at(this.get('YEAR_INDEX'));if(a.getSize()>4&&a.startsWith('0')){return false;}a=parseInt(a,10);if(TP.notEmpty(e=b.at(this.get('ZONE_INDEX')))){return TP.core.TimeZone.validate(e);}return true;});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_gMonth.js';
TP.xs.anySimpleType.defineSubtype('gMonth');TP.xs.gMonth.Type.defineConstant('MONTH_REGEX',/^--([0-9]{2})(([Z\+\-]*)([0-9]{2})*[:]*([0-9]{2})*)$/);TP.xs.gMonth.Type.defineConstant('MONTH_INDEX',1);TP.xs.gMonth.Type.defineConstant('ZONE_INDEX',2);TP.xs.gMonth.Type.defineMethod('validate',function(b){var c,a,d,e;if(!TP.isString(b)){return false;}c=b;a=c.match(this.get('MONTH_REGEX'));if(TP.notValid(a)){return false;}e=parseInt(a.at(this.get('MONTH_INDEX')),10);if(!e.isBetweenInclusive(1,12)){return false;}if(TP.notEmpty(d=a.at(this.get('ZONE_INDEX')))){return TP.core.TimeZone.validate(d);}return true;});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_gDay.js';
TP.xs.anySimpleType.defineSubtype('gDay');TP.xs.gDay.Type.defineConstant('DAY_REGEX',/^---([0-9]{2})(([Z\+\-]*)([0-9]{2})*[:]*([0-9]{2})*)$/);TP.xs.gDay.Type.defineConstant('DAY_INDEX',1);TP.xs.gDay.Type.defineConstant('ZONE_INDEX',2);TP.xs.gDay.Type.defineMethod('validate',function(b){var c,a,d,e;if(!TP.isString(b)){return false;}c=b;a=c.match(this.get('DAY_REGEX'));if(TP.notValid(a)){return false;}e=parseInt(a.at(this.get('DAY_INDEX')),10);if(!e.isBetweenInclusive(1,31)){return false;}if(TP.notEmpty(d=a.at(this.get('ZONE_INDEX')))){return TP.core.TimeZone.validate(d);}return true;});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_gMonthDay.js';
TP.xs.anySimpleType.defineSubtype('gMonthDay');TP.xs.gMonthDay.Type.defineConstant('MONTHDAY_REGEX',/^--([0-9]{2})-([0-9]{2})(([Z\+\-]*)([0-9]{2})*[:]*([0-9]{2})*)$/);TP.xs.gMonthDay.Type.defineConstant('MONTH_INDEX',1);TP.xs.gMonthDay.Type.defineConstant('DAY_INDEX',2);TP.xs.gMonthDay.Type.defineConstant('ZONE_INDEX',3);TP.xs.gMonthDay.Type.defineMethod('validate',function(c){var d,a,e,b,f;if(!TP.isString(c)){return false;}d=c;a=d.match(this.get('MONTHDAY_REGEX'));if(TP.notValid(a)){return false;}b=parseInt(a.at(this.get('MONTH_INDEX')),10);f=parseInt(a.at(this.get('DAY_INDEX')),10);if(!b.isBetweenInclusive(1,12)){return false;}if(!f.isBetweenInclusive(1,Date.daysInMonth(b,2000))){return false;}if(TP.notEmpty(e=a.at(this.get('ZONE_INDEX')))){return TP.core.TimeZone.validate(e);}return true;});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_boolean.js';
TP.xs.anySimpleType.defineSubtype('boolean');TP.xs.boolean.Type.defineMethod('validate',function(b){var a;a=TP.tostr(b);return TP.isTrue(a)||a==='true'||TP.isFalse(a)||a==='false'||a===0||a==='0'||a===1||a==='1';});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_base64Binary.js';
TP.xs.anySimpleType.defineSubtype('base64Binary');TP.xs.base64Binary.Type.defineConstant('BASE64_REGEX',/^[0-9a-zA-Z\+\/\u0009\u000A\u000D\u0020]+[\=]*$/);TP.xs.base64Binary.Type.defineMethod('fromObject',function(a){var b;if(TP.notValid(a)){return;}if(TP.canInvoke(a,'asString')){b=a.asString();}else if(TP.canInvoke(a,'toString')){b=a.toString();}else if(TP.isNode(a)){b=TP.nodeAsString(a);}else{return;}return TP.btoa(b);});TP.xs.base64Binary.Type.defineMethod('validate',function(a){if(!TP.isString(a)){return false;}return this.get('BASE64_REGEX').test(a)&&a.getSize().isEven();});TP.xs.base64Binary.Type.defineMethod('validateFacetLength','TP.xs.string'.asType().validateFacetLength);TP.xs.base64Binary.Type.defineMethod('validateFacetMaxLength','TP.xs.string'.asType().validateFacetMaxLength);TP.xs.base64Binary.Type.defineMethod('validateFacetMinLength','TP.xs.string'.asType().validateFacetMinLength);
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_hexBinary.js';
TP.xs.anySimpleType.defineSubtype('hexBinary');TP.xs.hexBinary.Type.defineConstant('HEXBINARY_REGEX',/^[0-9a-fA-F]{2,}$/);TP.xs.hexBinary.Type.defineMethod('validate',function(a){if(!TP.isString(a)){return false;}return this.get('HEXBINARY_REGEX').test(a)&&a.getSize().isEven();});TP.xs.hexBinary.Type.defineMethod('validateFacetLength','TP.xs.string'.asType().validateFacetLength);TP.xs.hexBinary.Type.defineMethod('validateFacetMaxLength','TP.xs.string'.asType().validateFacetMaxLength);TP.xs.hexBinary.Type.defineMethod('validateFacetMinLength','TP.xs.string'.asType().validateFacetMinLength);
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_anyURI.js';
TP.xs.anySimpleType.defineSubtype('anyURI');TP.xs.anyURI.Type.defineMethod('fromObject',function(b){var a;if(TP.notValid(b)){return;}if(TP.isMethod(b.getLocation)){a=b.getLocation();if(this.validate(a)){return a;}}a='TP.xs.string'.from(b);if(!TP.isString(a)){return;}if(!this.validate(a)){return;}return a;});TP.xs.anyURI.Type.defineMethod('validate',function(a){if(!TP.isString(a)){return false;}if(!/[^:]{1,}:[^:]{1,}/.test(a)){return false;}return TP.isURI(TP.uc(a));});TP.xs.anyURI.Type.defineMethod('validateFacetLength','TP.xs.string'.asType().validateFacetLength);TP.xs.anyURI.Type.defineMethod('validateFacetMaxLength','TP.xs.string'.asType().validateFacetMaxLength);TP.xs.anyURI.Type.defineMethod('validateFacetMinLength','TP.xs.string'.asType().validateFacetMinLength);
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_QName.js';
TP.xs.anySimpleType.defineSubtype('QName');TP.xs.QName.Type.defineMethod('fromObject',function(a){var b,c;if(TP.notValid(a)){return;}if(!TP.isPair(a)){if(TP.isString(a)){b=a.split(' ');}if(TP.canInvoke(a,'getPairs')){c=function(a){if(!c.atStart()){return TP.BREAK;}return true;};b=a.getPairs(c).first();}}if(this.validate(b)){return b;}return;});TP.xs.QName.Type.defineMethod('validate',function(b){var a,c,d;if(!TP.isString(b)&&!TP.isPair(b)){return false;}if(TP.isString(b)){a=b.stripWhitespace();if(a.first()!=='{'||a.last()!=='}'){return false;}a=a.slice(1,-1);c=a.split(',');if(c.getSize()!==2){return false;}if(c.at(0).unquoted().isa('TP.xs.anyURI')&&c.at(1).unquoted().isa('TP.xs.NCName')){return true;}else{return false;}}else{d=b;}return'TP.xs.anyURI'.asType().validate(d.first())&&'TP.xs.NCName'.asType().validate().pair.last();});TP.xs.QName.Type.defineMethod('validateFacetLength','TP.xs.string'.asType().validateFacetLength);TP.xs.QName.Type.defineMethod('validateFacetMaxLength','TP.xs.string'.asType().validateFacetMaxLength);TP.xs.QName.Type.defineMethod('validateFacetMinLength','TP.xs.string'.asType().validateFacetMinLength);
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_NOTATION.js';
TP.xs.anySimpleType.defineSubtype('NOTATION');TP.xs.NOTATION.Type.defineMethod('fromObject',function(a){return;});TP.xs.NOTATION.Type.defineMethod('validate',function(a){return false;});TP.xs.NOTATION.Type.defineMethod('validateFacetLength','TP.xs.string'.asType().validateFacetLength);TP.xs.NOTATION.Type.defineMethod('validateFacetMaxLength','TP.xs.string'.asType().validateFacetMaxLength);TP.xs.NOTATION.Type.defineMethod('validateFacetMinLength','TP.xs.string'.asType().validateFacetMinLength);
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_decimal.js';
TP.xs.anySimpleType.defineSubtype('decimal');TP.xs.decimal.Type.defineConstant('DECIMAL_REGEX',/^[-+]{0,1}[0-9]*[\.]*[0-9]*$/);TP.xs.decimal.Type.defineMethod('fromObject',function(a){var b,c;if(TP.notValid(a)){return;}if(TP.isMethod(a.as)){b=a.as(Number);}else{b=Number.from(a);}if(TP.notValid(b)){return;}c=b.asString();if(!/\./.test(c)){c+='.0';}return c;});TP.xs.decimal.Type.defineMethod('validate',function(a){var b;if(!TP.isString(a)&&!TP.isNumber(a)){return false;}b=a.asString();if(!/[0-9]/.test(b)){return false;}return this.get('DECIMAL_REGEX').test(b);});TP.xs.decimal.Type.defineMethod('validateFacetEnumeration',function(b,c){var a;a=this.fromObject(TP.elementGetAttribute(c,'value'));return TP.ac(a,b).equalAs(Number);});TP.xs.decimal.Type.defineMethod('validateFacetFractionDigits',function(d,e){var a,b,c;c=TP.elementGetAttribute(e,'value').asNumber();if(!TP.isNaN(a=parseFloat(d))){b=a.fraction().asString().split('.').last();return b.getSize()<=c;}return false;});TP.xs.decimal.Type.defineMethod('validateFacetMaxExclusive',function(c,d){var a,b;try{b=TP.nc(TP.elementGetAttribute(d,'value'));a=TP.nc(c);}catch(a){return false;}return a<b;});TP.xs.decimal.Type.defineMethod('validateFacetMaxInclusive',function(c,d){var a,b;try{b=TP.nc(TP.elementGetAttribute(d,'value'));a=TP.nc(c);}catch(a){return false;}return a<=b;});TP.xs.decimal.Type.defineMethod('validateFacetMinExclusive',function(c,d){var a,b;try{b=TP.nc(TP.elementGetAttribute(d,'value'));a=TP.nc(c);}catch(a){return false;}return a>b;});TP.xs.decimal.Type.defineMethod('validateFacetMinInclusive',function(c,d){var a,b;try{b=TP.nc(TP.elementGetAttribute(d,'value'));a=TP.nc(c);}catch(a){return false;}return a>=b;});TP.xs.decimal.Type.defineMethod('validateFacetTotalDigits',function(d,e){var a,b,c;c=TP.elementGetAttribute(e,'value').asNumber();if(!TP.isNaN(a=parseFloat(d))){b=a.asString();return b.getSize()<=c;}return false;});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_integer.js';
TP.xs.decimal.defineSubtype('integer');TP.xs.integer.Type.defineConstant('INTEGER_REGEX',/^[-+]{0,1}[0-9]{1,}$/);TP.xs.integer.Type.defineMethod('validate',function(a){var b;if(!TP.isString(a)&&!TP.isNumber(a)){return false;}b=a.asString();return this.get('INTEGER_REGEX').test(b);});TP.xs.integer.Type.defineMethod('validateFacetFractionDigits',function(a,b){this.raise('TP.sig.UnsupportedFeature',arguments,'Unsupported facet for this schema type');return false;});TP.xs.integer.Type.defineMethod('validateFacetTotalDigits',function(d,e){var a,b,c;c=TP.elementGetAttribute(e,'value').asNumber();if(!TP.isNaN(a=parseFloat(d))){b=a.asString();return b.getSize()<=c;}return false;});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_nonPositiveInteger.js';
TP.xs.integer.defineSubtype('nonPositiveInteger');TP.xs.nonPositiveInteger.Type.defineMethod('validate',function(a){var b;if(!'TP.xs.integer'.asType().validate(a)){return false;}try{if(!TP.isNumber(b=parseInt(a,10))){return false;}}catch(a){return false;}return b<=0;});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_negativeInteger.js';
TP.xs.nonPositiveInteger.defineSubtype('negativeInteger');TP.xs.negativeInteger.Type.defineMethod('validate',function(a){var b;if(!'TP.xs.integer'.asType().validate(a)){return false;}try{if(!TP.isNumber(b=parseInt(a,10))){return false;}}catch(a){return false;}return b<0;});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_nonNegativeInteger.js';
TP.xs.integer.defineSubtype('nonNegativeInteger');TP.xs.nonNegativeInteger.Type.defineMethod('validate',function(a){var b;if(!'TP.xs.integer'.asType().validate(a)){return false;}try{if(!TP.isNumber(b=parseInt(a,10))){return false;}}catch(a){return false;}return b>=0;});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_positiveInteger.js';
TP.xs.nonNegativeInteger.defineSubtype('positiveInteger');TP.xs.positiveInteger.Type.defineMethod('validate',function(a){var b;if(!'TP.xs.integer'.asType().validate(a)){return false;}try{if(!TP.isNumber(b=parseInt(a,10))){return false;}}catch(a){return false;}return b>0;});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_unsignedLong.js';
TP.xs.nonNegativeInteger.defineSubtype('unsignedLong');TP.xs.unsignedLong.Type.defineMethod('validate',function(a){var b;if(!'TP.xs.integer'.asType().validate(a)){return false;}try{if(!TP.isNumber(b=parseInt(a,10))){return false;}}catch(a){return false;}return b.isBetweenInclusive(0,18446744073709552000);});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_unsignedInt.js';
TP.xs.nonNegativeInteger.defineSubtype('unsignedInt');TP.xs.unsignedInt.Type.defineMethod('validate',function(a){var b;if(!'TP.xs.integer'.asType().validate(a)){return false;}try{if(!TP.isNumber(b=parseInt(a,10))){return false;}}catch(a){return false;}return b.isBetweenInclusive(0,4294967295);});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_unsignedShort.js';
TP.xs.nonNegativeInteger.defineSubtype('unsignedShort');TP.xs.unsignedShort.Type.defineMethod('validate',function(a){var b;if(!'TP.xs.integer'.asType().validate(a)){return false;}try{if(!TP.isNumber(b=parseInt(a,10))){return false;}}catch(a){return false;}return b.isBetweenInclusive(0,65535);});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_unsignedByte.js';
TP.xs.nonNegativeInteger.defineSubtype('unsignedByte');TP.xs.unsignedByte.Type.defineMethod('validate',function(a){var b;if(!'TP.xs.integer'.asType().validate(a)){return false;}try{if(!TP.isNumber(b=parseInt(a,10))){return false;}}catch(a){return false;}return b.isBetweenInclusive(0,255);});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_long.js';
TP.xs.integer.defineSubtype('long');TP.xs.long.Type.defineMethod('validate',function(b){var c,a;if(!'TP.xs.integer'.asType().validate(b)){return false;}try{if(!TP.isNumber(c=parseInt(b,10))){return false;}}catch(a){return false;}a=b.toString();if(a.startsWith('-')){return a.slice(1)<='9223372036854775808';}return a<='9223372036854775807';});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_int.js';
TP.xs.long.defineSubtype('int');TP.xs.int.Type.defineMethod('validate',function(a){var b;if(!'TP.xs.integer'.asType().validate(a)){return false;}try{if(!TP.isNumber(b=parseInt(a,10))){return false;}}catch(a){return false;}return b.isBetweenInclusive(-2147483648,2147483647);});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_short.js';
TP.xs.int.defineSubtype('short');TP.xs.short.Type.defineMethod('validate',function(a){var b;if(!'TP.xs.integer'.asType().validate(a)){return false;}try{if(!TP.isNumber(b=parseInt(a,10))){return false;}}catch(a){return false;}return b.isBetweenInclusive(-32768,32767);});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_byte.js';
TP.xs.short.defineSubtype('byte');TP.xs.byte.Type.defineMethod('validate',function(a){var b;if(!'TP.xs.integer'.asType().validate(a)){return false;}try{if(!TP.isNumber(b=parseInt(a,10))){return false;}}catch(a){return false;}return b.isBetweenInclusive(-128,127);});
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_float.js';
TP.xs.anySimpleType.defineSubtype('float');TP.xs.float.Type.defineMethod('validate',function(b){var d,a,c;if(!TP.isString(b)&&!TP.isNumber(b)){return false;}a=b.asString();if(a==='INF'||a==='-INF'||a==='NaN'){return true;}if(/\s/.test(a)){return false;}c=a.toUpperCase().split('E');if(c.getSize()>1){if(!c.at(1).isa('TP.xs.integer')){return false;}}try{if(!TP.isNumber(d=parseFloat(b))){return false;}}catch(a){return false;}return d.isBetweenInclusive(10..pow(38.53)*-1,10..pow(38.53));});TP.xs.float.Type.defineMethod('validateFacetEnumeration','TP.xs.decimal'.asType().validateFacetEnumeration);TP.xs.float.Type.defineMethod('validateFacetMaxExclusive','TP.xs.decimal'.asType().validateFacetMaxExclusive);TP.xs.float.Type.defineMethod('validateFacetMaxInclusive','TP.xs.decimal'.asType().validateFacetMaxInclusive);TP.xs.float.Type.defineMethod('validateFacetMinExclusive','TP.xs.decimal'.asType().validateFacetMinExclusive);TP.xs.float.Type.defineMethod('validateFacetMinInclusive','TP.xs.decimal'.asType().validateFacetMinInclusive);
TP.boot.$srcPath = '~lib_src/xs/builtins/xs_double.js';
TP.xs.anySimpleType.defineSubtype('double');TP.xs.double.Type.defineMethod('validate',function(b){var d,a,c;if(!TP.isString(b)&&!TP.isNumber(b)){return false;}a=b.asString();if(a==='INF'||a==='-INF'||a==='NaN'){return true;}if(/\s/.test(a)){return false;}c=a.toUpperCase().split('E');if(c.getSize()>1){if(!c.at(1).isa('TP.xs.integer')){return false;}}try{if(!TP.isNumber(d=parseFloat(b))){return false;}}catch(a){return false;}return d.isBetweenInclusive(10..pow(308.25)*-1,10..pow(308.25));});TP.xs.double.Type.defineMethod('validateFacetEnumeration','TP.xs.decimal'.asType().validateFacetEnumeration);TP.xs.double.Type.defineMethod('validateFacetMaxExclusive','TP.xs.decimal'.asType().validateFacetMaxExclusive);TP.xs.double.Type.defineMethod('validateFacetMaxInclusive','TP.xs.decimal'.asType().validateFacetMaxInclusive);TP.xs.double.Type.defineMethod('validateFacetMinExclusive','TP.xs.decimal'.asType().validateFacetMinExclusive);TP.xs.double.Type.defineMethod('validateFacetMinInclusive','TP.xs.decimal'.asType().validateFacetMinInclusive);
TP.boot.$srcPath = '~lib_src/xs/extensions/xforms_email.js';
TP.xs.string.defineSubtype('xforms:email');TP.xforms.email.Type.defineMethod('fromObject',function(b){var a;a='TP.xs.string'.asType().from(b);if(TP.notValid(a)){return;}a=a.stripWhitespace();if(!this.validate(a)){return;}return a;});TP.xforms.email.Type.defineMethod('validate',function(a){if(!TP.isString(a)){return false;}return/[A-Za-z0-9!#-'\*\+\-\/=\?\^_`\{-~]+(\.[A-Za-z0-9!#-'\*\+\-\/=\?\^_`\{-~ ]+)*@[A-Za-z0-9!#-'\*\+\-\/=\?\^_`\{-~]+(\.[A-Za-z0-9!#-'\*\+\-\/=\?\^_`\{-~]+)*/.test(a);});
TP.boot.$srcPath = '~lib_src/xs/extensions/xforms_card-number.js';
TP.xs.string.defineSubtype('xforms:card_number');TP.xforms.card_number.Type.defineMethod('fromObject',function(b){var a;a='TP.xs.string'.asType().from(b);if(TP.notValid(a)){return;}a=a.stripWhitespace();if(!this.validate(a)){return;}return a;});TP.xforms.card_number.Type.defineMethod('validate',function(a){if(!TP.isString(a)){return false;}if(a.getSize()<12||a.getSize()>19){return false;}return/[0-9]+/.test(a);});
